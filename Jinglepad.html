<html>
    <head>
        <meta charset="utf-8">
        <!--jsmediatags--><script src="data:text/plain;base64,KGZ1bmN0aW9uKHkpeyJvYmplY3QiPT09dHlwZW9mIGV4cG9ydHMmJiJ1bmRlZmluZWQiIT09dHlwZW9mIG1vZHVsZT9tb2R1bGUuZXhwb3J0cz15KCk6ImZ1bmN0aW9uIj09PXR5cGVvZiBkZWZpbmUmJmRlZmluZS5hbWQ/ZGVmaW5lKFtdLHkpOigidW5kZWZpbmVkIiE9PXR5cGVvZiB3aW5kb3c/d2luZG93OiJ1bmRlZmluZWQiIT09dHlwZW9mIGdsb2JhbD9nbG9iYWw6InVuZGVmaW5lZCIhPT10eXBlb2Ygc2VsZj9zZWxmOnRoaXMpLmpzbWVkaWF0YWdzPXkoKX0pKGZ1bmN0aW9uKCl7cmV0dXJuIGZ1bmN0aW9uIGYocCxxLG0pe2Z1bmN0aW9uIGwoYyxhKXtpZighcVtjXSl7aWYoIXBbY10pe3ZhciBiPSJmdW5jdGlvbiI9PXR5cGVvZiByZXF1aXJlJiZyZXF1aXJlO2lmKCFhJiZiKXJldHVybiBiKGMsITApO2lmKGUpcmV0dXJuIGUoYywhMCk7YT1FcnJvcigiQ2Fubm90IGZpbmQgbW9kdWxlICciK2MrIiciKTt0aHJvdyBhLmNvZGU9Ik1PRFVMRV9OT1RfRk9VTkQiLGE7fWE9cVtjXT0Ke2V4cG9ydHM6e319O3BbY11bMF0uY2FsbChhLmV4cG9ydHMsZnVuY3Rpb24oYSl7dmFyIGI9cFtjXVsxXVthXTtyZXR1cm4gbChiP2I6YSl9LGEsYS5leHBvcnRzLGYscCxxLG0pfXJldHVybiBxW2NdLmV4cG9ydHN9Zm9yKHZhciBlPSJmdW5jdGlvbiI9PXR5cGVvZiByZXF1aXJlJiZyZXF1aXJlLGQ9MDtkPG0ubGVuZ3RoO2QrKylsKG1bZF0pO3JldHVybiBsfSh7MTpbZnVuY3Rpb24oZixwLHEpe30se31dLDI6W2Z1bmN0aW9uKGYscCxxKXtwLmV4cG9ydHM9WE1MSHR0cFJlcXVlc3R9LHt9XSwzOltmdW5jdGlvbihmLHAscSl7ZnVuY3Rpb24gbShlLGQpe2lmKCJmdW5jdGlvbiIhPT10eXBlb2YgZCYmbnVsbCE9PWQpdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAiK3R5cGVvZiBkKTtlLnByb3RvdHlwZT1PYmplY3QuY3JlYXRlKGQmJmQucHJvdG90eXBlLHtjb25zdHJ1Y3Rvcjp7dmFsdWU6ZSwKZW51bWVyYWJsZTohMSx3cml0YWJsZTohMCxjb25maWd1cmFibGU6ITB9fSk7ZCYmKE9iamVjdC5zZXRQcm90b3R5cGVPZj9PYmplY3Quc2V0UHJvdG90eXBlT2YoZSxkKTplLl9fcHJvdG9fXz1kKX12YXIgbD1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoZCxjKXtmb3IodmFyIGE9MDthPGMubGVuZ3RoO2ErKyl7dmFyIGI9Y1thXTtiLmVudW1lcmFibGU9Yi5lbnVtZXJhYmxlfHwhMTtiLmNvbmZpZ3VyYWJsZT0hMDsidmFsdWUiaW4gYiYmKGIud3JpdGFibGU9ITApO09iamVjdC5kZWZpbmVQcm9wZXJ0eShkLGIua2V5LGIpfX1yZXR1cm4gZnVuY3Rpb24oZCxjLGEpe2MmJmUoZC5wcm90b3R5cGUsYyk7YSYmZShkLGEpO3JldHVybiBkfX0oKTtmPWZ1bmN0aW9uKGUpe2Z1bmN0aW9uIGQoYyl7aWYoISh0aGlzIGluc3RhbmNlb2YgZCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7dmFyIGE9KGQuX19wcm90b19ffHxPYmplY3QuZ2V0UHJvdG90eXBlT2YoZCkpLmNhbGwodGhpcyk7CmlmKCF0aGlzKXRocm93IG5ldyBSZWZlcmVuY2VFcnJvcigidGhpcyBoYXNuJ3QgYmVlbiBpbml0aWFsaXNlZCAtIHN1cGVyKCkgaGFzbid0IGJlZW4gY2FsbGVkIik7YT0hYXx8Im9iamVjdCIhPT10eXBlb2YgYSYmImZ1bmN0aW9uIiE9PXR5cGVvZiBhP3RoaXM6YTthLl9hcnJheT1jO2EuX3NpemU9Yy5sZW5ndGg7YS5faXNJbml0aWFsaXplZD0hMDtyZXR1cm4gYX1tKGQsZSk7bChkLFt7a2V5OiJpbml0Iix2YWx1ZTpmdW5jdGlvbihjKXtzZXRUaW1lb3V0KGMub25TdWNjZXNzLDApfX0se2tleToibG9hZFJhbmdlIix2YWx1ZTpmdW5jdGlvbihjLGEpe3NldFRpbWVvdXQoYS5vblN1Y2Nlc3MsMCl9fSx7a2V5OiJnZXRCeXRlQXQiLHZhbHVlOmZ1bmN0aW9uKGMpe2lmKGM+PXRoaXMuX2FycmF5Lmxlbmd0aCl0aHJvdyBFcnJvcigiT2Zmc2V0ICIrYysiIGhhc24ndCBiZWVuIGxvYWRlZCB5ZXQuIik7cmV0dXJuIHRoaXMuX2FycmF5W2NdfX1dLFt7a2V5OiJjYW5SZWFkRmlsZSIsdmFsdWU6ZnVuY3Rpb24oYyl7cmV0dXJuIEFycmF5LmlzQXJyYXkoYyl8fAoiZnVuY3Rpb24iPT09dHlwZW9mIEJ1ZmZlciYmQnVmZmVyLmlzQnVmZmVyKGMpfX1dKTtyZXR1cm4gZH0oZigiLi9NZWRpYUZpbGVSZWFkZXIiKSk7cC5leHBvcnRzPWZ9LHsiLi9NZWRpYUZpbGVSZWFkZXIiOjExfV0sNDpbZnVuY3Rpb24oZixwLHEpe2Z1bmN0aW9uIG0oZCxjKXtpZigiZnVuY3Rpb24iIT09dHlwZW9mIGMmJm51bGwhPT1jKXRocm93IG5ldyBUeXBlRXJyb3IoIlN1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgIit0eXBlb2YgYyk7ZC5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShjJiZjLnByb3RvdHlwZSx7Y29uc3RydWN0b3I6e3ZhbHVlOmQsZW51bWVyYWJsZTohMSx3cml0YWJsZTohMCxjb25maWd1cmFibGU6ITB9fSk7YyYmKE9iamVjdC5zZXRQcm90b3R5cGVPZj9PYmplY3Quc2V0UHJvdG90eXBlT2YoZCxjKTpkLl9fcHJvdG9fXz1jKX12YXIgbD1mdW5jdGlvbigpe2Z1bmN0aW9uIGQoYyxhKXtmb3IodmFyIGI9CjA7YjxhLmxlbmd0aDtiKyspe3ZhciBkPWFbYl07ZC5lbnVtZXJhYmxlPWQuZW51bWVyYWJsZXx8ITE7ZC5jb25maWd1cmFibGU9ITA7InZhbHVlImluIGQmJihkLndyaXRhYmxlPSEwKTtPYmplY3QuZGVmaW5lUHJvcGVydHkoYyxkLmtleSxkKX19cmV0dXJuIGZ1bmN0aW9uKGMsYSxiKXthJiZkKGMucHJvdG90eXBlLGEpO2ImJmQoYyxiKTtyZXR1cm4gY319KCksZT1mKCIuL0NodW5rZWRGaWxlRGF0YSIpO2Y9ZnVuY3Rpb24oZCl7ZnVuY3Rpb24gYyhhKXtpZighKHRoaXMgaW5zdGFuY2VvZiBjKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTt2YXIgYj0oYy5fX3Byb3RvX198fE9iamVjdC5nZXRQcm90b3R5cGVPZihjKSkuY2FsbCh0aGlzKTtpZighdGhpcyl0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoInRoaXMgaGFzbid0IGJlZW4gaW5pdGlhbGlzZWQgLSBzdXBlcigpIGhhc24ndCBiZWVuIGNhbGxlZCIpO2I9IWJ8fCJvYmplY3QiIT09CnR5cGVvZiBiJiYiZnVuY3Rpb24iIT09dHlwZW9mIGI/dGhpczpiO2IuX2Jsb2I9YTtiLl9maWxlRGF0YT1uZXcgZTtyZXR1cm4gYn1tKGMsZCk7bChjLFt7a2V5OiJfaW5pdCIsdmFsdWU6ZnVuY3Rpb24oYSl7dGhpcy5fc2l6ZT10aGlzLl9ibG9iLnNpemU7c2V0VGltZW91dChhLm9uU3VjY2VzcywxKX19LHtrZXk6ImxvYWRSYW5nZSIsdmFsdWU6ZnVuY3Rpb24oYSxiKXt2YXIgZD10aGlzLGg9KHRoaXMuX2Jsb2Iuc2xpY2V8fHRoaXMuX2Jsb2IubW96U2xpY2V8fHRoaXMuX2Jsb2Iud2Via2l0U2xpY2UpLmNhbGwodGhpcy5fYmxvYixhWzBdLGFbMV0rMSksYz1uZXcgRmlsZVJlYWRlcjtjLm9ubG9hZGVuZD1mdW5jdGlvbihoKXtoPW5ldyBVaW50OEFycmF5KGMucmVzdWx0KTtkLl9maWxlRGF0YS5hZGREYXRhKGFbMF0saCk7Yi5vblN1Y2Nlc3MoKX07Yy5vbmVycm9yPWMub25hYm9ydD1mdW5jdGlvbihhKXtpZihiLm9uRXJyb3IpYi5vbkVycm9yKHt0eXBlOiJibG9iIixpbmZvOmMuZXJyb3J9KX07CmMucmVhZEFzQXJyYXlCdWZmZXIoaCl9fSx7a2V5OiJnZXRCeXRlQXQiLHZhbHVlOmZ1bmN0aW9uKGEpe3JldHVybiB0aGlzLl9maWxlRGF0YS5nZXRCeXRlQXQoYSl9fV0sW3trZXk6ImNhblJlYWRGaWxlIix2YWx1ZTpmdW5jdGlvbihhKXtyZXR1cm4idW5kZWZpbmVkIiE9PXR5cGVvZiBCbG9iJiZhIGluc3RhbmNlb2YgQmxvYnx8InVuZGVmaW5lZCIhPT10eXBlb2YgRmlsZSYmYSBpbnN0YW5jZW9mIEZpbGV9fV0pO3JldHVybiBjfShmKCIuL01lZGlhRmlsZVJlYWRlciIpKTtwLmV4cG9ydHM9Zn0seyIuL0NodW5rZWRGaWxlRGF0YSI6NSwiLi9NZWRpYUZpbGVSZWFkZXIiOjExfV0sNTpbZnVuY3Rpb24oZixwLHEpe3ZhciBtPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZihlLGQpe2Zvcih2YXIgYz0wO2M8ZC5sZW5ndGg7YysrKXt2YXIgYT1kW2NdO2EuZW51bWVyYWJsZT1hLmVudW1lcmFibGV8fCExO2EuY29uZmlndXJhYmxlPSEwOyJ2YWx1ZSJpbiBhJiYoYS53cml0YWJsZT0hMCk7T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsCmEua2V5LGEpfX1yZXR1cm4gZnVuY3Rpb24oZSxkLGMpe2QmJmYoZS5wcm90b3R5cGUsZCk7YyYmZihlLGMpO3JldHVybiBlfX0oKTtmPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZigpe2lmKCEodGhpcyBpbnN0YW5jZW9mIGYpKXRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpO3RoaXMuX2ZpbGVEYXRhPVtdfW0oZixudWxsLFt7a2V5OiJOT1RfRk9VTkQiLGdldDpmdW5jdGlvbigpe3JldHVybi0xfX1dKTttKGYsW3trZXk6ImFkZERhdGEiLHZhbHVlOmZ1bmN0aW9uKGUsZCl7dmFyIGM9ZStkLmxlbmd0aC0xLGE9dGhpcy5fZ2V0Q2h1bmtSYW5nZShlLGMpO2lmKC0xPT09YS5zdGFydEl4KXRoaXMuX2ZpbGVEYXRhLnNwbGljZShhLmluc2VydEl4fHwwLDAse29mZnNldDplLGRhdGE6ZH0pO2Vsc2V7dmFyIGI9dGhpcy5fZmlsZURhdGFbYS5zdGFydEl4XSxnPXRoaXMuX2ZpbGVEYXRhW2EuZW5kSXhdO2M9YzxnLm9mZnNldCtnLmRhdGEubGVuZ3RoLQoxO3ZhciBoPXtvZmZzZXQ6TWF0aC5taW4oZSxiLm9mZnNldCksZGF0YTpkfTtlPmIub2Zmc2V0JiYoZT10aGlzLl9zbGljZURhdGEoYi5kYXRhLDAsZS1iLm9mZnNldCksaC5kYXRhPXRoaXMuX2NvbmNhdERhdGEoZSxkKSk7YyYmKGU9dGhpcy5fc2xpY2VEYXRhKGguZGF0YSwwLGcub2Zmc2V0LWgub2Zmc2V0KSxoLmRhdGE9dGhpcy5fY29uY2F0RGF0YShlLGcuZGF0YSkpO3RoaXMuX2ZpbGVEYXRhLnNwbGljZShhLnN0YXJ0SXgsYS5lbmRJeC1hLnN0YXJ0SXgrMSxoKX19fSx7a2V5OiJfY29uY2F0RGF0YSIsdmFsdWU6ZnVuY3Rpb24oZSxkKXtpZigidW5kZWZpbmVkIiE9PXR5cGVvZiBBcnJheUJ1ZmZlciYmQXJyYXlCdWZmZXIuaXNWaWV3JiZBcnJheUJ1ZmZlci5pc1ZpZXcoZSkpe3ZhciBjPW5ldyBlLmNvbnN0cnVjdG9yKGUubGVuZ3RoK2QubGVuZ3RoKTtjLnNldChlLDApO2Muc2V0KGQsZS5sZW5ndGgpO3JldHVybiBjfXJldHVybiBlLmNvbmNhdChkKX19LHtrZXk6Il9zbGljZURhdGEiLAp2YWx1ZTpmdW5jdGlvbihlLGQsYyl7cmV0dXJuIGUuc2xpY2U/ZS5zbGljZShkLGMpOmUuc3ViYXJyYXkoZCxjKX19LHtrZXk6Il9nZXRDaHVua1JhbmdlIix2YWx1ZTpmdW5jdGlvbihlLGQpe2Zvcih2YXIgYyxhLGI9LTEsZz0tMSxoPTAsaz0wO2s8dGhpcy5fZmlsZURhdGEubGVuZ3RoO2srKyxoPWspe2E9dGhpcy5fZmlsZURhdGFba10ub2Zmc2V0O2M9YSt0aGlzLl9maWxlRGF0YVtrXS5kYXRhLmxlbmd0aDtpZihkPGEtMSlicmVhaztpZihlPD1jKzEmJmQ+PWEtMSl7Yj1rO2JyZWFrfX1pZigtMT09PWIpcmV0dXJue3N0YXJ0SXg6LTEsZW5kSXg6LTEsaW5zZXJ0SXg6aH07Zm9yKGs9YjtrPHRoaXMuX2ZpbGVEYXRhLmxlbmd0aCYmIShhPXRoaXMuX2ZpbGVEYXRhW2tdLm9mZnNldCxjPWErdGhpcy5fZmlsZURhdGFba10uZGF0YS5sZW5ndGgsZD49YS0xJiYoZz1rKSxkPD1jKzEpO2srKyk7LTE9PT1nJiYoZz1iKTtyZXR1cm57c3RhcnRJeDpiLGVuZEl4Omd9fX0se2tleToiaGFzRGF0YVJhbmdlIiwKdmFsdWU6ZnVuY3Rpb24oZSxkKXtmb3IodmFyIGM9MDtjPHRoaXMuX2ZpbGVEYXRhLmxlbmd0aDtjKyspe3ZhciBhPXRoaXMuX2ZpbGVEYXRhW2NdO2lmKGQ8YS5vZmZzZXQpYnJlYWs7aWYoZT49YS5vZmZzZXQmJmQ8YS5vZmZzZXQrYS5kYXRhLmxlbmd0aClyZXR1cm4hMH1yZXR1cm4hMX19LHtrZXk6ImdldEJ5dGVBdCIsdmFsdWU6ZnVuY3Rpb24oZSl7Zm9yKHZhciBkLGM9MDtjPHRoaXMuX2ZpbGVEYXRhLmxlbmd0aDtjKyspe3ZhciBhPXRoaXMuX2ZpbGVEYXRhW2NdLm9mZnNldCxiPWErdGhpcy5fZmlsZURhdGFbY10uZGF0YS5sZW5ndGgtMTtpZihlPj1hJiZlPD1iKXtkPXRoaXMuX2ZpbGVEYXRhW2NdO2JyZWFrfX1pZihkKXJldHVybiBkLmRhdGFbZS1kLm9mZnNldF07dGhyb3cgRXJyb3IoIk9mZnNldCAiK2UrIiBoYXNuJ3QgYmVlbiBsb2FkZWQgeWV0LiIpO319XSk7cmV0dXJuIGZ9KCk7cC5leHBvcnRzPWZ9LHt9XSw2OltmdW5jdGlvbihmLHAscSl7ZnVuY3Rpb24gbShhLApiKXtpZigiZnVuY3Rpb24iIT09dHlwZW9mIGImJm51bGwhPT1iKXRocm93IG5ldyBUeXBlRXJyb3IoIlN1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgIit0eXBlb2YgYik7YS5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShiJiZiLnByb3RvdHlwZSx7Y29uc3RydWN0b3I6e3ZhbHVlOmEsZW51bWVyYWJsZTohMSx3cml0YWJsZTohMCxjb25maWd1cmFibGU6ITB9fSk7YiYmKE9iamVjdC5zZXRQcm90b3R5cGVPZj9PYmplY3Quc2V0UHJvdG90eXBlT2YoYSxiKTphLl9fcHJvdG9fXz1iKX12YXIgbD1mdW5jdGlvbigpe2Z1bmN0aW9uIGEoYSxjKXtmb3IodmFyIGI9MDtiPGMubGVuZ3RoO2IrKyl7dmFyIGQ9Y1tiXTtkLmVudW1lcmFibGU9ZC5lbnVtZXJhYmxlfHwhMTtkLmNvbmZpZ3VyYWJsZT0hMDsidmFsdWUiaW4gZCYmKGQud3JpdGFibGU9ITApO09iamVjdC5kZWZpbmVQcm9wZXJ0eShhLGQua2V5LGQpfX1yZXR1cm4gZnVuY3Rpb24oYiwKZCxoKXtkJiZhKGIucHJvdG90eXBlLGQpO2gmJmEoYixoKTtyZXR1cm4gYn19KCksZT1bNCwxMzJdLGQ9WzYsMTM0XSxjPSJPdGhlcjszMngzMiBwaXhlbHMgJ2ZpbGUgaWNvbicgKFBORyBvbmx5KTtPdGhlciBmaWxlIGljb247Q292ZXIgKGZyb250KTtDb3ZlciAoYmFjayk7TGVhZmxldCBwYWdlO01lZGlhIChlLmcuIGxhYmVsIHNpZGUgb2YgQ0QpO0xlYWQgYXJ0aXN0L2xlYWQgcGVyZm9ybWVyL3NvbG9pc3Q7QXJ0aXN0L3BlcmZvcm1lcjtDb25kdWN0b3I7QmFuZC9PcmNoZXN0cmE7Q29tcG9zZXI7THlyaWNpc3QvdGV4dCB3cml0ZXI7UmVjb3JkaW5nIExvY2F0aW9uO0R1cmluZyByZWNvcmRpbmc7RHVyaW5nIHBlcmZvcm1hbmNlO01vdmllL3ZpZGVvIHNjcmVlbiBjYXB0dXJlO0EgYnJpZ2h0IGNvbG91cmVkIGZpc2g7SWxsdXN0cmF0aW9uO0JhbmQvYXJ0aXN0IGxvZ290eXBlO1B1Ymxpc2hlci9TdHVkaW8gbG9nb3R5cGUiLnNwbGl0KCI7Iik7Zj1mdW5jdGlvbihhKXtmdW5jdGlvbiBiKCl7aWYoISh0aGlzIGluc3RhbmNlb2YKYikpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7dmFyIGE9KGIuX19wcm90b19ffHxPYmplY3QuZ2V0UHJvdG90eXBlT2YoYikpLmFwcGx5KHRoaXMsYXJndW1lbnRzKTtpZighdGhpcyl0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoInRoaXMgaGFzbid0IGJlZW4gaW5pdGlhbGlzZWQgLSBzdXBlcigpIGhhc24ndCBiZWVuIGNhbGxlZCIpO3JldHVybiFhfHwib2JqZWN0IiE9PXR5cGVvZiBhJiYiZnVuY3Rpb24iIT09dHlwZW9mIGE/dGhpczphfW0oYixhKTtsKGIsW3trZXk6Il9sb2FkRGF0YSIsdmFsdWU6ZnVuY3Rpb24oYSxiKXt2YXIgaD10aGlzO2EubG9hZFJhbmdlKFs0LDddLHtvblN1Y2Nlc3M6ZnVuY3Rpb24oKXtoLl9sb2FkQmxvY2soYSw0LGIpfX0pfX0se2tleToiX2xvYWRCbG9jayIsdmFsdWU6ZnVuY3Rpb24oYSxiLGMpe3ZhciBoPXRoaXMsZz1hLmdldEJ5dGVBdChiKSxrPWEuZ2V0SW50ZWdlcjI0QXQoYisxLCEwKTsKaWYoLTEhPT1lLmluZGV4T2YoZykpe3ZhciBuPWIrNDthLmxvYWRSYW5nZShbbixuK2tdLHtvblN1Y2Nlc3M6ZnVuY3Rpb24oKXtoLl9jb21tZW50T2Zmc2V0PW47aC5fbmV4dEJsb2NrKGEsYixnLGssYyl9fSl9ZWxzZS0xIT09ZC5pbmRleE9mKGcpPyhuPWIrNCxhLmxvYWRSYW5nZShbbixuK2tdLHtvblN1Y2Nlc3M6ZnVuY3Rpb24oKXtoLl9waWN0dXJlT2Zmc2V0PW47aC5fbmV4dEJsb2NrKGEsYixnLGssYyl9fSkpOmguX25leHRCbG9jayhhLGIsZyxrLGMpfX0se2tleToiX25leHRCbG9jayIsdmFsdWU6ZnVuY3Rpb24oYSxiLGQsYyxlKXt2YXIgaD10aGlzO2lmKDEyNzxkKWlmKGguX2NvbW1lbnRPZmZzZXQpZS5vblN1Y2Nlc3MoKTtlbHNlIGUub25FcnJvcih7dHlwZToibG9hZERhdGEiLGluZm86IkNvbW1lbnQgYmxvY2sgY291bGQgbm90IGJlIGZvdW5kLiJ9KTtlbHNlIGEubG9hZFJhbmdlKFtiKzQrYyxiKzQrNCtjXSx7b25TdWNjZXNzOmZ1bmN0aW9uKCl7aC5fbG9hZEJsb2NrKGEsCmIrNCtjLGUpfX0pfX0se2tleToiX3BhcnNlRGF0YSIsdmFsdWU6ZnVuY3Rpb24oYSxiKXt2YXIgaD1hLmdldExvbmdBdCh0aGlzLl9jb21tZW50T2Zmc2V0LCExKSsodGhpcy5fY29tbWVudE9mZnNldCs0KTtiPWEuZ2V0TG9uZ0F0KGgsITEpO2grPTQ7Zm9yKHZhciBkLGcsZSxuLHgsZix0PTA7dDxiO3QrKyl7dmFyIHc9YS5nZXRMb25nQXQoaCwhMSksbD1hLmdldFN0cmluZ1dpdGhDaGFyc2V0QXQoaCs0LHcsInV0Zi04IikudG9TdHJpbmcoKSxtPWwuaW5kZXhPZigiPSIpO2w9W2wuc2xpY2UoMCxtKSxsLnNsaWNlKG0rMSldO3N3aXRjaChsWzBdKXtjYXNlICJUSVRMRSI6ZD1sWzFdO2JyZWFrO2Nhc2UgIkFSVElTVCI6Zz1sWzFdO2JyZWFrO2Nhc2UgIkFMQlVNIjplPWxbMV07YnJlYWs7Y2FzZSAiVFJBQ0tOVU1CRVIiOm49bFsxXTticmVhaztjYXNlICJHRU5SRSI6eD1sWzFdfWgrPTQrd310aGlzLl9waWN0dXJlT2Zmc2V0JiYoZj1hLmdldExvbmdBdCh0aGlzLl9waWN0dXJlT2Zmc2V0LAohMCksYj10aGlzLl9waWN0dXJlT2Zmc2V0KzQsaD1hLmdldExvbmdBdChiLCEwKSx0PWIrNCxiPWEuZ2V0U3RyaW5nQXQodCxoKSxoPXQraCx0PWEuZ2V0TG9uZ0F0KGgsITApLHc9aCs0LGg9YS5nZXRTdHJpbmdXaXRoQ2hhcnNldEF0KHcsdCwidXRmLTgiKS50b1N0cmluZygpLHQ9dyt0KzE2LHc9YS5nZXRMb25nQXQodCwhMCksYT1hLmdldEJ5dGVzQXQodCs0LHcsITApLGY9e2Zvcm1hdDpiLHR5cGU6Y1tmXSxkZXNjcmlwdGlvbjpoLGRhdGE6YX0pO3JldHVybnt0eXBlOiJGTEFDIix2ZXJzaW9uOiIxIix0YWdzOnt0aXRsZTpkLGFydGlzdDpnLGFsYnVtOmUsdHJhY2s6bixnZW5yZTp4LHBpY3R1cmU6Zn19fX1dLFt7a2V5OiJnZXRUYWdJZGVudGlmaWVyQnl0ZVJhbmdlIix2YWx1ZTpmdW5jdGlvbigpe3JldHVybntvZmZzZXQ6MCxsZW5ndGg6NH19fSx7a2V5OiJjYW5SZWFkVGFnRm9ybWF0Iix2YWx1ZTpmdW5jdGlvbihhKXtyZXR1cm4iZkxhQyI9PT1TdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywKYS5zbGljZSgwLDQpKX19XSk7cmV0dXJuIGJ9KGYoIi4vTWVkaWFUYWdSZWFkZXIiKSk7cC5leHBvcnRzPWZ9LHsiLi9NZWRpYVRhZ1JlYWRlciI6MTJ9XSw3OltmdW5jdGlvbihmLHAscSl7ZnVuY3Rpb24gbShkLGMpe2lmKCJmdW5jdGlvbiIhPT10eXBlb2YgYyYmbnVsbCE9PWMpdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAiK3R5cGVvZiBjKTtkLnByb3RvdHlwZT1PYmplY3QuY3JlYXRlKGMmJmMucHJvdG90eXBlLHtjb25zdHJ1Y3Rvcjp7dmFsdWU6ZCxlbnVtZXJhYmxlOiExLHdyaXRhYmxlOiEwLGNvbmZpZ3VyYWJsZTohMH19KTtjJiYoT2JqZWN0LnNldFByb3RvdHlwZU9mP09iamVjdC5zZXRQcm90b3R5cGVPZihkLGMpOmQuX19wcm90b19fPWMpfXZhciBsPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZChkLGEpe2Zvcih2YXIgYj0wO2I8YS5sZW5ndGg7YisrKXt2YXIgYz1hW2JdO2MuZW51bWVyYWJsZT0KYy5lbnVtZXJhYmxlfHwhMTtjLmNvbmZpZ3VyYWJsZT0hMDsidmFsdWUiaW4gYyYmKGMud3JpdGFibGU9ITApO09iamVjdC5kZWZpbmVQcm9wZXJ0eShkLGMua2V5LGMpfX1yZXR1cm4gZnVuY3Rpb24oYyxhLGIpe2EmJmQoYy5wcm90b3R5cGUsYSk7YiYmZChjLGIpO3JldHVybiBjfX0oKTtxPWYoIi4vTWVkaWFUYWdSZWFkZXIiKTtmKCIuL01lZGlhRmlsZVJlYWRlciIpO2Y9ZnVuY3Rpb24oZCl7ZnVuY3Rpb24gYygpe2lmKCEodGhpcyBpbnN0YW5jZW9mIGMpKXRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpO3ZhciBhPShjLl9fcHJvdG9fX3x8T2JqZWN0LmdldFByb3RvdHlwZU9mKGMpKS5hcHBseSh0aGlzLGFyZ3VtZW50cyk7aWYoIXRoaXMpdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJ0aGlzIGhhc24ndCBiZWVuIGluaXRpYWxpc2VkIC0gc3VwZXIoKSBoYXNuJ3QgYmVlbiBjYWxsZWQiKTtyZXR1cm4hYXx8Im9iamVjdCIhPT0KdHlwZW9mIGEmJiJmdW5jdGlvbiIhPT10eXBlb2YgYT90aGlzOmF9bShjLGQpO2woYyxbe2tleToiX2xvYWREYXRhIix2YWx1ZTpmdW5jdGlvbihhLGIpe3ZhciBkPWEuZ2V0U2l6ZSgpO2EubG9hZFJhbmdlKFtkLTEyOCxkLTFdLGIpfX0se2tleToiX3BhcnNlRGF0YSIsdmFsdWU6ZnVuY3Rpb24oYSxiKXt2YXIgZD1hLmdldFNpemUoKS0xMjgsaD1hLmdldFN0cmluZ1dpdGhDaGFyc2V0QXQoZCszLDMwKS50b1N0cmluZygpLGM9YS5nZXRTdHJpbmdXaXRoQ2hhcnNldEF0KGQrMzMsMzApLnRvU3RyaW5nKCkscj1hLmdldFN0cmluZ1dpdGhDaGFyc2V0QXQoZCs2MywzMCkudG9TdHJpbmcoKSx1PWEuZ2V0U3RyaW5nV2l0aENoYXJzZXRBdChkKzkzLDQpLnRvU3RyaW5nKCk7dmFyIGY9YS5nZXRCeXRlQXQoZCs5NysyOCk7Yj1hLmdldEJ5dGVBdChkKzk3KzI5KTtpZigwPT1mJiYwIT1iKXt2YXIgbj0iMS4xIjtmPWEuZ2V0U3RyaW5nV2l0aENoYXJzZXRBdChkKzk3LDI4KS50b1N0cmluZygpfWVsc2Ugbj0KIjEuMCIsZj1hLmdldFN0cmluZ1dpdGhDaGFyc2V0QXQoZCs5NywzMCkudG9TdHJpbmcoKSxiPTA7YT1hLmdldEJ5dGVBdChkKzk3KzMwKTthPXt0eXBlOiJJRDMiLHZlcnNpb246bix0YWdzOnt0aXRsZTpoLGFydGlzdDpjLGFsYnVtOnIseWVhcjp1LGNvbW1lbnQ6ZixnZW5yZToyNTU+YT9lW2FdOiIifX07YiYmKGEudGFncy50cmFjaz1iKTtyZXR1cm4gYX19XSxbe2tleToiZ2V0VGFnSWRlbnRpZmllckJ5dGVSYW5nZSIsdmFsdWU6ZnVuY3Rpb24oKXtyZXR1cm57b2Zmc2V0Oi0xMjgsbGVuZ3RoOjEyOH19fSx7a2V5OiJjYW5SZWFkVGFnRm9ybWF0Iix2YWx1ZTpmdW5jdGlvbihhKXtyZXR1cm4iVEFHIj09PVN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLGEuc2xpY2UoMCwzKSl9fV0pO3JldHVybiBjfShxKTt2YXIgZT0iQmx1ZXM7Q2xhc3NpYyBSb2NrO0NvdW50cnk7RGFuY2U7RGlzY287RnVuaztHcnVuZ2U7SGlwLUhvcDtKYXp6O01ldGFsO05ldyBBZ2U7T2xkaWVzO090aGVyO1BvcDtSJkI7UmFwO1JlZ2dhZTtSb2NrO1RlY2hubztJbmR1c3RyaWFsO0FsdGVybmF0aXZlO1NrYTtEZWF0aCBNZXRhbDtQcmFua3M7U291bmR0cmFjaztFdXJvLVRlY2hubztBbWJpZW50O1RyaXAtSG9wO1ZvY2FsO0phenorRnVuaztGdXNpb247VHJhbmNlO0NsYXNzaWNhbDtJbnN0cnVtZW50YWw7QWNpZDtIb3VzZTtHYW1lO1NvdW5kIENsaXA7R29zcGVsO05vaXNlO0FsdGVyblJvY2s7QmFzcztTb3VsO1B1bms7U3BhY2U7TWVkaXRhdGl2ZTtJbnN0cnVtZW50YWwgUG9wO0luc3RydW1lbnRhbCBSb2NrO0V0aG5pYztHb3RoaWM7RGFya3dhdmU7VGVjaG5vLUluZHVzdHJpYWw7RWxlY3Ryb25pYztQb3AtRm9saztFdXJvZGFuY2U7RHJlYW07U291dGhlcm4gUm9jaztDb21lZHk7Q3VsdDtHYW5nc3RhO1RvcCA0MDtDaHJpc3RpYW4gUmFwO1BvcC9GdW5rO0p1bmdsZTtOYXRpdmUgQW1lcmljYW47Q2FiYXJldDtOZXcgV2F2ZTtQc3ljaGFkZWxpYztSYXZlO1Nob3d0dW5lcztUcmFpbGVyO0xvLUZpO1RyaWJhbDtBY2lkIFB1bms7QWNpZCBKYXp6O1BvbGthO1JldHJvO011c2ljYWw7Um9jayAmIFJvbGw7SGFyZCBSb2NrO0ZvbGs7Rm9say1Sb2NrO05hdGlvbmFsIEZvbGs7U3dpbmc7RmFzdCBGdXNpb247QmVib2I7TGF0aW47UmV2aXZhbDtDZWx0aWM7Qmx1ZWdyYXNzO0F2YW50Z2FyZGU7R290aGljIFJvY2s7UHJvZ3Jlc3NpdmUgUm9jaztQc3ljaGVkZWxpYyBSb2NrO1N5bXBob25pYyBSb2NrO1Nsb3cgUm9jaztCaWcgQmFuZDtDaG9ydXM7RWFzeSBMaXN0ZW5pbmc7QWNvdXN0aWM7SHVtb3VyO1NwZWVjaDtDaGFuc29uO09wZXJhO0NoYW1iZXIgTXVzaWM7U29uYXRhO1N5bXBob255O0Jvb3R5IEJhc3M7UHJpbXVzO1Bvcm4gR3Jvb3ZlO1NhdGlyZTtTbG93IEphbTtDbHViO1RhbmdvO1NhbWJhO0ZvbGtsb3JlO0JhbGxhZDtQb3dlciBCYWxsYWQ7Umh5dGhtaWMgU291bDtGcmVlc3R5bGU7RHVldDtQdW5rIFJvY2s7RHJ1bSBTb2xvO0FjYXBlbGxhO0V1cm8tSG91c2U7RGFuY2UgSGFsbCIuc3BsaXQoIjsiKTsKcC5leHBvcnRzPWZ9LHsiLi9NZWRpYUZpbGVSZWFkZXIiOjExLCIuL01lZGlhVGFnUmVhZGVyIjoxMn1dLDg6W2Z1bmN0aW9uKGYscCxxKXtmdW5jdGlvbiBtKGEpe3N3aXRjaChhKXtjYXNlIDA6YT0iaXNvLTg4NTktMSI7YnJlYWs7Y2FzZSAxOmE9InV0Zi0xNiI7YnJlYWs7Y2FzZSAyOmE9InV0Zi0xNmJlIjticmVhaztjYXNlIDM6YT0idXRmLTgiO2JyZWFrO2RlZmF1bHQ6YT0iaXNvLTg4NTktMSJ9cmV0dXJuIGF9ZnVuY3Rpb24gbChhLGIsZCxjKXtjPWQuZ2V0U3RyaW5nV2l0aENoYXJzZXRBdChhKzEsYi0xLGMpO2E9ZC5nZXRTdHJpbmdXaXRoQ2hhcnNldEF0KGErMStjLmJ5dGVzUmVhZENvdW50LGItMS1jLmJ5dGVzUmVhZENvdW50KTtyZXR1cm57dXNlcl9kZXNjcmlwdGlvbjpjLnRvU3RyaW5nKCksZGF0YTphLnRvU3RyaW5nKCl9fXZhciBlPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gYShhLGIpe2Zvcih2YXIgZD0wO2Q8Yi5sZW5ndGg7ZCsrKXt2YXIgYz1iW2RdO2MuZW51bWVyYWJsZT0KYy5lbnVtZXJhYmxlfHwhMTtjLmNvbmZpZ3VyYWJsZT0hMDsidmFsdWUiaW4gYyYmKGMud3JpdGFibGU9ITApO09iamVjdC5kZWZpbmVQcm9wZXJ0eShhLGMua2V5LGMpfX1yZXR1cm4gZnVuY3Rpb24oYixkLGMpe2QmJmEoYi5wcm90b3R5cGUsZCk7YyYmYShiLGMpO3JldHVybiBifX0oKTtmKCIuL01lZGlhRmlsZVJlYWRlciIpO3ZhciBkPWYoIi4vU3RyaW5nVXRpbHMiKSxjPWYoIi4vQXJyYXlGaWxlUmVhZGVyIiksYT17QlVGOiJSZWNvbW1lbmRlZCBidWZmZXIgc2l6ZSIsQ05UOiJQbGF5IGNvdW50ZXIiLENPTToiQ29tbWVudHMiLENSQToiQXVkaW8gZW5jcnlwdGlvbiIsQ1JNOiJFbmNyeXB0ZWQgbWV0YSBmcmFtZSIsRVRDOiJFdmVudCB0aW1pbmcgY29kZXMiLEVRVToiRXF1YWxpemF0aW9uIixHRU86IkdlbmVyYWwgZW5jYXBzdWxhdGVkIG9iamVjdCIsSVBMOiJJbnZvbHZlZCBwZW9wbGUgbGlzdCIsTE5LOiJMaW5rZWQgaW5mb3JtYXRpb24iLE1DSToiTXVzaWMgQ0QgSWRlbnRpZmllciIsCk1MTDoiTVBFRyBsb2NhdGlvbiBsb29rdXAgdGFibGUiLFBJQzoiQXR0YWNoZWQgcGljdHVyZSIsUE9QOiJQb3B1bGFyaW1ldGVyIixSRVY6IlJldmVyYiIsUlZBOiJSZWxhdGl2ZSB2b2x1bWUgYWRqdXN0bWVudCIsU0xUOiJTeW5jaHJvbml6ZWQgbHlyaWMvdGV4dCIsU1RDOiJTeW5jZWQgdGVtcG8gY29kZXMiLFRBTDoiQWxidW0vTW92aWUvU2hvdyB0aXRsZSIsVEJQOiJCUE0gKEJlYXRzIFBlciBNaW51dGUpIixUQ006IkNvbXBvc2VyIixUQ086IkNvbnRlbnQgdHlwZSIsVENSOiJDb3B5cmlnaHQgbWVzc2FnZSIsVERBOiJEYXRlIixURFk6IlBsYXlsaXN0IGRlbGF5IixURU46IkVuY29kZWQgYnkiLFRGVDoiRmlsZSB0eXBlIixUSU06IlRpbWUiLFRLRToiSW5pdGlhbCBrZXkiLFRMQToiTGFuZ3VhZ2UocykiLFRMRToiTGVuZ3RoIixUTVQ6Ik1lZGlhIHR5cGUiLFRPQToiT3JpZ2luYWwgYXJ0aXN0KHMpL3BlcmZvcm1lcihzKSIsVE9GOiJPcmlnaW5hbCBmaWxlbmFtZSIsVE9MOiJPcmlnaW5hbCBMeXJpY2lzdChzKS90ZXh0IHdyaXRlcihzKSIsClRPUjoiT3JpZ2luYWwgcmVsZWFzZSB5ZWFyIixUT1Q6Ik9yaWdpbmFsIGFsYnVtL01vdmllL1Nob3cgdGl0bGUiLFRQMToiTGVhZCBhcnRpc3QocykvTGVhZCBwZXJmb3JtZXIocykvU29sb2lzdChzKS9QZXJmb3JtaW5nIGdyb3VwIixUUDI6IkJhbmQvT3JjaGVzdHJhL0FjY29tcGFuaW1lbnQiLFRQMzoiQ29uZHVjdG9yL1BlcmZvcm1lciByZWZpbmVtZW50IixUUDQ6IkludGVycHJldGVkLCByZW1peGVkLCBvciBvdGhlcndpc2UgbW9kaWZpZWQgYnkiLFRQQToiUGFydCBvZiBhIHNldCIsVFBCOiJQdWJsaXNoZXIiLFRSQzoiSVNSQyAoSW50ZXJuYXRpb25hbCBTdGFuZGFyZCBSZWNvcmRpbmcgQ29kZSkiLFRSRDoiUmVjb3JkaW5nIGRhdGVzIixUUks6IlRyYWNrIG51bWJlci9Qb3NpdGlvbiBpbiBzZXQiLFRTSToiU2l6ZSIsVFNTOiJTb2Z0d2FyZS9oYXJkd2FyZSBhbmQgc2V0dGluZ3MgdXNlZCBmb3IgZW5jb2RpbmciLFRUMToiQ29udGVudCBncm91cCBkZXNjcmlwdGlvbiIsVFQyOiJUaXRsZS9Tb25nbmFtZS9Db250ZW50IGRlc2NyaXB0aW9uIiwKVFQzOiJTdWJ0aXRsZS9EZXNjcmlwdGlvbiByZWZpbmVtZW50IixUWFQ6Ikx5cmljaXN0L3RleHQgd3JpdGVyIixUWFg6IlVzZXIgZGVmaW5lZCB0ZXh0IGluZm9ybWF0aW9uIGZyYW1lIixUWUU6IlllYXIiLFVGSToiVW5pcXVlIGZpbGUgaWRlbnRpZmllciIsVUxUOiJVbnN5Y2hyb25pemVkIGx5cmljL3RleHQgdHJhbnNjcmlwdGlvbiIsV0FGOiJPZmZpY2lhbCBhdWRpbyBmaWxlIHdlYnBhZ2UiLFdBUjoiT2ZmaWNpYWwgYXJ0aXN0L3BlcmZvcm1lciB3ZWJwYWdlIixXQVM6Ik9mZmljaWFsIGF1ZGlvIHNvdXJjZSB3ZWJwYWdlIixXQ006IkNvbW1lcmNpYWwgaW5mb3JtYXRpb24iLFdDUDoiQ29weXJpZ2h0L0xlZ2FsIGluZm9ybWF0aW9uIixXUEI6IlB1Ymxpc2hlcnMgb2ZmaWNpYWwgd2VicGFnZSIsV1hYOiJVc2VyIGRlZmluZWQgVVJMIGxpbmsgZnJhbWUiLEFFTkM6IkF1ZGlvIGVuY3J5cHRpb24iLEFQSUM6IkF0dGFjaGVkIHBpY3R1cmUiLEFTUEk6IkF1ZGlvIHNlZWsgcG9pbnQgaW5kZXgiLApDSEFQOiJDaGFwdGVyIixDVE9DOiJUYWJsZSBvZiBjb250ZW50cyIsQ09NTToiQ29tbWVudHMiLENPTVI6IkNvbW1lcmNpYWwgZnJhbWUiLEVOQ1I6IkVuY3J5cHRpb24gbWV0aG9kIHJlZ2lzdHJhdGlvbiIsRVFVMjoiRXF1YWxpc2F0aW9uICgyKSIsRVFVQToiRXF1YWxpemF0aW9uIixFVENPOiJFdmVudCB0aW1pbmcgY29kZXMiLEdFT0I6IkdlbmVyYWwgZW5jYXBzdWxhdGVkIG9iamVjdCIsR1JJRDoiR3JvdXAgaWRlbnRpZmljYXRpb24gcmVnaXN0cmF0aW9uIixJUExTOiJJbnZvbHZlZCBwZW9wbGUgbGlzdCIsTElOSzoiTGlua2VkIGluZm9ybWF0aW9uIixNQ0RJOiJNdXNpYyBDRCBpZGVudGlmaWVyIixNTExUOiJNUEVHIGxvY2F0aW9uIGxvb2t1cCB0YWJsZSIsT1dORToiT3duZXJzaGlwIGZyYW1lIixQUklWOiJQcml2YXRlIGZyYW1lIixQQ05UOiJQbGF5IGNvdW50ZXIiLFBPUE06IlBvcHVsYXJpbWV0ZXIiLFBPU1M6IlBvc2l0aW9uIHN5bmNocm9uaXNhdGlvbiBmcmFtZSIsClJCVUY6IlJlY29tbWVuZGVkIGJ1ZmZlciBzaXplIixSVkEyOiJSZWxhdGl2ZSB2b2x1bWUgYWRqdXN0bWVudCAoMikiLFJWQUQ6IlJlbGF0aXZlIHZvbHVtZSBhZGp1c3RtZW50IixSVlJCOiJSZXZlcmIiLFNFRUs6IlNlZWsgZnJhbWUiLFNZTFQ6IlN5bmNocm9uaXplZCBseXJpYy90ZXh0IixTWVRDOiJTeW5jaHJvbml6ZWQgdGVtcG8gY29kZXMiLFRBTEI6IkFsYnVtL01vdmllL1Nob3cgdGl0bGUiLFRCUE06IkJQTSAoYmVhdHMgcGVyIG1pbnV0ZSkiLFRDT006IkNvbXBvc2VyIixUQ09OOiJDb250ZW50IHR5cGUiLFRDT1A6IkNvcHlyaWdodCBtZXNzYWdlIixUREFUOiJEYXRlIixURExZOiJQbGF5bGlzdCBkZWxheSIsVERSQzoiUmVjb3JkaW5nIHRpbWUiLFREUkw6IlJlbGVhc2UgdGltZSIsVERURzoiVGFnZ2luZyB0aW1lIixURU5DOiJFbmNvZGVkIGJ5IixURVhUOiJMeXJpY2lzdC9UZXh0IHdyaXRlciIsVEZMVDoiRmlsZSB0eXBlIixUSU1FOiJUaW1lIixUSVBMOiJJbnZvbHZlZCBwZW9wbGUgbGlzdCIsClRJVDE6IkNvbnRlbnQgZ3JvdXAgZGVzY3JpcHRpb24iLFRJVDI6IlRpdGxlL3NvbmduYW1lL2NvbnRlbnQgZGVzY3JpcHRpb24iLFRJVDM6IlN1YnRpdGxlL0Rlc2NyaXB0aW9uIHJlZmluZW1lbnQiLFRLRVk6IkluaXRpYWwga2V5IixUTEFOOiJMYW5ndWFnZShzKSIsVExFTjoiTGVuZ3RoIixUTUNMOiJNdXNpY2lhbiBjcmVkaXRzIGxpc3QiLFRNRUQ6Ik1lZGlhIHR5cGUiLFRNT086Ik1vb2QiLFRPQUw6Ik9yaWdpbmFsIGFsYnVtL21vdmllL3Nob3cgdGl0bGUiLFRPRk46Ik9yaWdpbmFsIGZpbGVuYW1lIixUT0xZOiJPcmlnaW5hbCBseXJpY2lzdChzKS90ZXh0IHdyaXRlcihzKSIsVE9QRToiT3JpZ2luYWwgYXJ0aXN0KHMpL3BlcmZvcm1lcihzKSIsVE9SWToiT3JpZ2luYWwgcmVsZWFzZSB5ZWFyIixUT1dOOiJGaWxlIG93bmVyL2xpY2Vuc2VlIixUUEUxOiJMZWFkIHBlcmZvcm1lcihzKS9Tb2xvaXN0KHMpIixUUEUyOiJCYW5kL29yY2hlc3RyYS9hY2NvbXBhbmltZW50IixUUEUzOiJDb25kdWN0b3IvcGVyZm9ybWVyIHJlZmluZW1lbnQiLApUUEU0OiJJbnRlcnByZXRlZCwgcmVtaXhlZCwgb3Igb3RoZXJ3aXNlIG1vZGlmaWVkIGJ5IixUUE9TOiJQYXJ0IG9mIGEgc2V0IixUUFJPOiJQcm9kdWNlZCBub3RpY2UiLFRQVUI6IlB1Ymxpc2hlciIsVFJDSzoiVHJhY2sgbnVtYmVyL1Bvc2l0aW9uIGluIHNldCIsVFJEQToiUmVjb3JkaW5nIGRhdGVzIixUUlNOOiJJbnRlcm5ldCByYWRpbyBzdGF0aW9uIG5hbWUiLFRSU086IkludGVybmV0IHJhZGlvIHN0YXRpb24gb3duZXIiLFRTT0E6IkFsYnVtIHNvcnQgb3JkZXIiLFRTT1A6IlBlcmZvcm1lciBzb3J0IG9yZGVyIixUU09UOiJUaXRsZSBzb3J0IG9yZGVyIixUU0laOiJTaXplIixUU1JDOiJJU1JDIChpbnRlcm5hdGlvbmFsIHN0YW5kYXJkIHJlY29yZGluZyBjb2RlKSIsVFNTRToiU29mdHdhcmUvSGFyZHdhcmUgYW5kIHNldHRpbmdzIHVzZWQgZm9yIGVuY29kaW5nIixUU1NUOiJTZXQgc3VidGl0bGUiLFRZRVI6IlllYXIiLFRYWFg6IlVzZXIgZGVmaW5lZCB0ZXh0IGluZm9ybWF0aW9uIGZyYW1lIiwKVUZJRDoiVW5pcXVlIGZpbGUgaWRlbnRpZmllciIsVVNFUjoiVGVybXMgb2YgdXNlIixVU0xUOiJVbnN5Y2hyb25pemVkIGx5cmljL3RleHQgdHJhbnNjcmlwdGlvbiIsV0NPTToiQ29tbWVyY2lhbCBpbmZvcm1hdGlvbiIsV0NPUDoiQ29weXJpZ2h0L0xlZ2FsIGluZm9ybWF0aW9uIixXT0FGOiJPZmZpY2lhbCBhdWRpbyBmaWxlIHdlYnBhZ2UiLFdPQVI6Ik9mZmljaWFsIGFydGlzdC9wZXJmb3JtZXIgd2VicGFnZSIsV09BUzoiT2ZmaWNpYWwgYXVkaW8gc291cmNlIHdlYnBhZ2UiLFdPUlM6Ik9mZmljaWFsIGludGVybmV0IHJhZGlvIHN0YXRpb24gaG9tZXBhZ2UiLFdQQVk6IlBheW1lbnQiLFdQVUI6IlB1Ymxpc2hlcnMgb2ZmaWNpYWwgd2VicGFnZSIsV1hYWDoiVXNlciBkZWZpbmVkIFVSTCBsaW5rIGZyYW1lIn07Zj1mdW5jdGlvbigpe2Z1bmN0aW9uIGQoKXtpZighKHRoaXMgaW5zdGFuY2VvZiBkKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsKfWUoZCxudWxsLFt7a2V5OiJnZXRGcmFtZVJlYWRlckZ1bmN0aW9uIix2YWx1ZTpmdW5jdGlvbihhKXtyZXR1cm4gYSBpbiBiP2JbYV06IlQiPT09YVswXT9iWyJUKiJdOiJXIj09PWFbMF0/YlsiVyoiXTpudWxsfX0se2tleToicmVhZEZyYW1lcyIsdmFsdWU6ZnVuY3Rpb24oYSxiLGMsaCxnKXtmb3IodmFyIGs9e30sZT10aGlzLl9nZXRGcmFtZUhlYWRlclNpemUoaCk7YTxiLWU7KXt2YXIgcj10aGlzLl9yZWFkRnJhbWVIZWFkZXIoYyxhLGgpLG49ci5pZDtpZighbilicmVhazt2YXIgZj1yLmZsYWdzLHU9ci5zaXplLHY9YStyLmhlYWRlclNpemUsbD1jO2ErPXIuaGVhZGVyU2l6ZStyLnNpemU7aWYoIWd8fC0xIT09Zy5pbmRleE9mKG4pKXtpZigiTVAzZSI9PT1ufHwiXHgwME1QMyI9PT1ufHwiXHgwMFx4MDBNUCI9PT1ufHwiIE1QMyI9PT1uKWJyZWFrO2YmJmYuZm9ybWF0LnVuc3luY2hyb25pc2F0aW9uJiYobD10aGlzLmdldFVuc3luY0ZpbGVSZWFkZXIobCx2LHUpLHY9MCx1PQpsLmdldFNpemUoKSk7ZiYmZi5mb3JtYXQuZGF0YV9sZW5ndGhfaW5kaWNhdG9yJiYodis9NCx1LT00KTtmPShyPWQuZ2V0RnJhbWVSZWFkZXJGdW5jdGlvbihuKSk/ci5hcHBseSh0aGlzLFt2LHUsbCxmLGhdKTpudWxsO3Y9dGhpcy5fZ2V0RnJhbWVEZXNjcmlwdGlvbihuKTt1PXtpZDpuLHNpemU6dSxkZXNjcmlwdGlvbjp2LGRhdGE6Zn07biBpbiBrPyhrW25dLmlkJiYoa1tuXT1ba1tuXV0pLGtbbl0ucHVzaCh1KSk6a1tuXT11fX1yZXR1cm4ga319LHtrZXk6Il9nZXRGcmFtZUhlYWRlclNpemUiLHZhbHVlOmZ1bmN0aW9uKGEpe2E9YS5tYWpvcjtyZXR1cm4gMj09YT82OjM9PWF8fDQ9PWE/MTA6MH19LHtrZXk6Il9yZWFkRnJhbWVIZWFkZXIiLHZhbHVlOmZ1bmN0aW9uKGEsYixkKXt2YXIgYz1kLm1ham9yLGg9bnVsbDtkPXRoaXMuX2dldEZyYW1lSGVhZGVyU2l6ZShkKTtzd2l0Y2goYyl7Y2FzZSAyOnZhciBnPWEuZ2V0U3RyaW5nQXQoYiwzKTt2YXIgaz1hLmdldEludGVnZXIyNEF0KGIrCjMsITApO2JyZWFrO2Nhc2UgMzpnPWEuZ2V0U3RyaW5nQXQoYiw0KTtrPWEuZ2V0TG9uZ0F0KGIrNCwhMCk7YnJlYWs7Y2FzZSA0Omc9YS5nZXRTdHJpbmdBdChiLDQpLGs9YS5nZXRTeW5jaHNhZmVJbnRlZ2VyMzJBdChiKzQpfWlmKGc9PVN0cmluZy5mcm9tQ2hhckNvZGUoMCwwLDApfHxnPT1TdHJpbmcuZnJvbUNoYXJDb2RlKDAsMCwwLDApKWc9IiI7ZyYmMjxjJiYoaD10aGlzLl9yZWFkRnJhbWVGbGFncyhhLGIrOCkpO3JldHVybntpZDpnfHwiIixzaXplOmt8fDAsaGVhZGVyU2l6ZTpkfHwwLGZsYWdzOmh9fX0se2tleToiX3JlYWRGcmFtZUZsYWdzIix2YWx1ZTpmdW5jdGlvbihhLGIpe3JldHVybnttZXNzYWdlOnt0YWdfYWx0ZXJfcHJlc2VydmF0aW9uOmEuaXNCaXRTZXRBdChiLDYpLGZpbGVfYWx0ZXJfcHJlc2VydmF0aW9uOmEuaXNCaXRTZXRBdChiLDUpLHJlYWRfb25seTphLmlzQml0U2V0QXQoYiw0KX0sZm9ybWF0Ontncm91cGluZ19pZGVudGl0eTphLmlzQml0U2V0QXQoYisKMSw3KSxjb21wcmVzc2lvbjphLmlzQml0U2V0QXQoYisxLDMpLGVuY3J5cHRpb246YS5pc0JpdFNldEF0KGIrMSwyKSx1bnN5bmNocm9uaXNhdGlvbjphLmlzQml0U2V0QXQoYisxLDEpLGRhdGFfbGVuZ3RoX2luZGljYXRvcjphLmlzQml0U2V0QXQoYisxLDApfX19fSx7a2V5OiJfZ2V0RnJhbWVEZXNjcmlwdGlvbiIsdmFsdWU6ZnVuY3Rpb24oYil7cmV0dXJuIGIgaW4gYT9hW2JdOiJVbmtub3duIn19LHtrZXk6ImdldFVuc3luY0ZpbGVSZWFkZXIiLHZhbHVlOmZ1bmN0aW9uKGEsYixkKXthPWEuZ2V0Qnl0ZXNBdChiLGQpO2ZvcihiPTA7YjxhLmxlbmd0aC0xO2IrKykyNTU9PT1hW2JdJiYwPT09YVtiKzFdJiZhLnNwbGljZShiKzEsMSk7cmV0dXJuIG5ldyBjKGEpfX1dKTtyZXR1cm4gZH0oKTt2YXIgYj17QVBJQzpmdW5jdGlvbihhLGIsZCxjLGUpe2M9YTt2YXIgaD1tKGQuZ2V0Qnl0ZUF0KGEpKTtzd2l0Y2goZSYmZS5tYWpvcil7Y2FzZSAyOmU9ZC5nZXRTdHJpbmdBdChhKzEsCjMpO2ErPTQ7YnJlYWs7Y2FzZSAzOmNhc2UgNDplPWQuZ2V0U3RyaW5nV2l0aENoYXJzZXRBdChhKzEsYi0xKTthKz0xK2UuYnl0ZXNSZWFkQ291bnQ7YnJlYWs7ZGVmYXVsdDp0aHJvdyBFcnJvcigiQ291bGRuJ3QgcmVhZCBJRDN2MiBtYWpvciB2ZXJzaW9uLiIpO312YXIgaz1kLmdldEJ5dGVBdChhKTtrPWdba107aD1kLmdldFN0cmluZ1dpdGhDaGFyc2V0QXQoYSsxLGItKGEtYyktMSxoKTthKz0xK2guYnl0ZXNSZWFkQ291bnQ7cmV0dXJue2Zvcm1hdDplLnRvU3RyaW5nKCksdHlwZTprLGRlc2NyaXB0aW9uOmgudG9TdHJpbmcoKSxkYXRhOmQuZ2V0Qnl0ZXNBdChhLGMrYi1hKX19LENIQVA6ZnVuY3Rpb24oYSxiLGMsZyxlKXtnPWE7dmFyIGg9e30saz1kLnJlYWROdWxsVGVybWluYXRlZFN0cmluZyhjLmdldEJ5dGVzQXQoYSxiKSk7aC5pZD1rLnRvU3RyaW5nKCk7YSs9ay5ieXRlc1JlYWRDb3VudDtoLnN0YXJ0VGltZT1jLmdldExvbmdBdChhLCEwKTthKz00O2guZW5kVGltZT0KYy5nZXRMb25nQXQoYSwhMCk7YSs9NDtoLnN0YXJ0T2Zmc2V0PWMuZ2V0TG9uZ0F0KGEsITApO2ErPTQ7aC5lbmRPZmZzZXQ9Yy5nZXRMb25nQXQoYSwhMCk7YSs9NDtoLnN1YkZyYW1lcz10aGlzLnJlYWRGcmFtZXMoYSxhKyhiLShhLWcpKSxjLGUpO3JldHVybiBofSxDVE9DOmZ1bmN0aW9uKGEsYixjLGcsZSl7Zz1hO3ZhciBoPXtjaGlsZEVsZW1lbnRJZHM6W10saWQ6dm9pZCAwLHRvcExldmVsOnZvaWQgMCxvcmRlcmVkOnZvaWQgMCxlbnRyeUNvdW50OnZvaWQgMCxzdWJGcmFtZXM6dm9pZCAwfSxrPWQucmVhZE51bGxUZXJtaW5hdGVkU3RyaW5nKGMuZ2V0Qnl0ZXNBdChhLGIpKTtoLmlkPWsudG9TdHJpbmcoKTthKz1rLmJ5dGVzUmVhZENvdW50O2gudG9wTGV2ZWw9Yy5pc0JpdFNldEF0KGEsMSk7aC5vcmRlcmVkPWMuaXNCaXRTZXRBdChhLDApO2ErKztoLmVudHJ5Q291bnQ9Yy5nZXRCeXRlQXQoYSk7YSsrO2ZvcihrPTA7azxoLmVudHJ5Q291bnQ7aysrKXt2YXIgZj1kLnJlYWROdWxsVGVybWluYXRlZFN0cmluZyhjLmdldEJ5dGVzQXQoYSwKYi0oYS1nKSkpO2guY2hpbGRFbGVtZW50SWRzLnB1c2goZi50b1N0cmluZygpKTthKz1mLmJ5dGVzUmVhZENvdW50fWguc3ViRnJhbWVzPXRoaXMucmVhZEZyYW1lcyhhLGErKGItKGEtZykpLGMsZSk7cmV0dXJuIGh9LENPTU06ZnVuY3Rpb24oYSxiLGMsZCxnKXt2YXIgaD1hLGU9bShjLmdldEJ5dGVBdChhKSk7ZD1jLmdldFN0cmluZ0F0KGErMSwzKTtnPWMuZ2V0U3RyaW5nV2l0aENoYXJzZXRBdChhKzQsYi00LGUpO2ErPTQrZy5ieXRlc1JlYWRDb3VudDthPWMuZ2V0U3RyaW5nV2l0aENoYXJzZXRBdChhLGgrYi1hLGUpO3JldHVybntsYW5ndWFnZTpkLHNob3J0X2Rlc2NyaXB0aW9uOmcudG9TdHJpbmcoKSx0ZXh0OmEudG9TdHJpbmcoKX19fTtiLkNPTT1iLkNPTU07Yi5QSUM9ZnVuY3Rpb24oYSxjLGQsZyxlKXtyZXR1cm4gYi5BUElDKGEsYyxkLGcsZSl9O2IuUENOVD1mdW5jdGlvbihhLGIsYyxkLGcpe3JldHVybiBjLmdldExvbmdBdChhLCExKX07Yi5DTlQ9Yi5QQ05UO2JbIlQqIl09CmZ1bmN0aW9uKGEsYixjLGQsZyl7ZD1tKGMuZ2V0Qnl0ZUF0KGEpKTtyZXR1cm4gYy5nZXRTdHJpbmdXaXRoQ2hhcnNldEF0KGErMSxiLTEsZCkudG9TdHJpbmcoKX07Yi5UWFhYPWZ1bmN0aW9uKGEsYixjLGQsZyl7ZD1tKGMuZ2V0Qnl0ZUF0KGEpKTtyZXR1cm4gbChhLGIsYyxkKX07Yi5XWFhYPWZ1bmN0aW9uKGEsYixjLGQsZyl7aWYoMD09PWIpcmV0dXJuIG51bGw7ZD1tKGMuZ2V0Qnl0ZUF0KGEpKTtyZXR1cm4gbChhLGIsYyxkKX07YlsiVyoiXT1mdW5jdGlvbihhLGIsYyxkLGcpe3JldHVybiAwPT09Yj9udWxsOmMuZ2V0U3RyaW5nV2l0aENoYXJzZXRBdChhLGIsImlzby04ODU5LTEiKS50b1N0cmluZygpfTtiLlRDT049ZnVuY3Rpb24oYSxjLGQsZyl7cmV0dXJuIGJbIlQqIl0uYXBwbHkodGhpcyxhcmd1bWVudHMpLnJlcGxhY2UoL15cKFxkK1wpLywiIil9O2IuVENPPWIuVENPTjtiLlVTTFQ9ZnVuY3Rpb24oYSxiLGMsZCxnKXt2YXIgaD1hLGU9bShjLmdldEJ5dGVBdChhKSk7CmQ9Yy5nZXRTdHJpbmdBdChhKzEsMyk7Zz1jLmdldFN0cmluZ1dpdGhDaGFyc2V0QXQoYSs0LGItNCxlKTthKz00K2cuYnl0ZXNSZWFkQ291bnQ7YT1jLmdldFN0cmluZ1dpdGhDaGFyc2V0QXQoYSxoK2ItYSxlKTtyZXR1cm57bGFuZ3VhZ2U6ZCxkZXNjcmlwdG9yOmcudG9TdHJpbmcoKSxseXJpY3M6YS50b1N0cmluZygpfX07Yi5VTFQ9Yi5VU0xUO2IuVUZJRD1mdW5jdGlvbihhLGIsYyxnLGUpe2c9ZC5yZWFkTnVsbFRlcm1pbmF0ZWRTdHJpbmcoYy5nZXRCeXRlc0F0KGEsYikpO2ErPWcuYnl0ZXNSZWFkQ291bnQ7YT1jLmdldEJ5dGVzQXQoYSxiLWcuYnl0ZXNSZWFkQ291bnQpO3JldHVybntvd25lcklkZW50aWZpZXI6Zy50b1N0cmluZygpLGlkZW50aWZpZXI6YX19O3ZhciBnPSJPdGhlcjszMngzMiBwaXhlbHMgJ2ZpbGUgaWNvbicgKFBORyBvbmx5KTtPdGhlciBmaWxlIGljb247Q292ZXIgKGZyb250KTtDb3ZlciAoYmFjayk7TGVhZmxldCBwYWdlO01lZGlhIChlLmcuIGxhYmVsIHNpZGUgb2YgQ0QpO0xlYWQgYXJ0aXN0L2xlYWQgcGVyZm9ybWVyL3NvbG9pc3Q7QXJ0aXN0L3BlcmZvcm1lcjtDb25kdWN0b3I7QmFuZC9PcmNoZXN0cmE7Q29tcG9zZXI7THlyaWNpc3QvdGV4dCB3cml0ZXI7UmVjb3JkaW5nIExvY2F0aW9uO0R1cmluZyByZWNvcmRpbmc7RHVyaW5nIHBlcmZvcm1hbmNlO01vdmllL3ZpZGVvIHNjcmVlbiBjYXB0dXJlO0EgYnJpZ2h0IGNvbG91cmVkIGZpc2g7SWxsdXN0cmF0aW9uO0JhbmQvYXJ0aXN0IGxvZ290eXBlO1B1Ymxpc2hlci9TdHVkaW8gbG9nb3R5cGUiLnNwbGl0KCI7Iik7CnAuZXhwb3J0cz1mfSx7Ii4vQXJyYXlGaWxlUmVhZGVyIjozLCIuL01lZGlhRmlsZVJlYWRlciI6MTEsIi4vU3RyaW5nVXRpbHMiOjEzfV0sOTpbZnVuY3Rpb24oZixwLHEpe2Z1bmN0aW9uIG0oYyxhKXtpZigiZnVuY3Rpb24iIT09dHlwZW9mIGEmJm51bGwhPT1hKXRocm93IG5ldyBUeXBlRXJyb3IoIlN1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgIit0eXBlb2YgYSk7Yy5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShhJiZhLnByb3RvdHlwZSx7Y29uc3RydWN0b3I6e3ZhbHVlOmMsZW51bWVyYWJsZTohMSx3cml0YWJsZTohMCxjb25maWd1cmFibGU6ITB9fSk7YSYmKE9iamVjdC5zZXRQcm90b3R5cGVPZj9PYmplY3Quc2V0UHJvdG90eXBlT2YoYyxhKTpjLl9fcHJvdG9fXz1hKX12YXIgbD1mdW5jdGlvbigpe2Z1bmN0aW9uIGMoYSxiKXtmb3IodmFyIGM9MDtjPGIubGVuZ3RoO2MrKyl7dmFyIGQ9YltjXTtkLmVudW1lcmFibGU9ZC5lbnVtZXJhYmxlfHwKITE7ZC5jb25maWd1cmFibGU9ITA7InZhbHVlImluIGQmJihkLndyaXRhYmxlPSEwKTtPYmplY3QuZGVmaW5lUHJvcGVydHkoYSxkLmtleSxkKX19cmV0dXJuIGZ1bmN0aW9uKGEsYixkKXtiJiZjKGEucHJvdG90eXBlLGIpO2QmJmMoYSxkKTtyZXR1cm4gYX19KCk7cT1mKCIuL01lZGlhVGFnUmVhZGVyIik7ZigiLi9NZWRpYUZpbGVSZWFkZXIiKTt2YXIgZT1mKCIuL0lEM3YyRnJhbWVSZWFkZXIiKTtmPWZ1bmN0aW9uKGMpe2Z1bmN0aW9uIGEoKXtpZighKHRoaXMgaW5zdGFuY2VvZiBhKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTt2YXIgYj0oYS5fX3Byb3RvX198fE9iamVjdC5nZXRQcm90b3R5cGVPZihhKSkuYXBwbHkodGhpcyxhcmd1bWVudHMpO2lmKCF0aGlzKXRocm93IG5ldyBSZWZlcmVuY2VFcnJvcigidGhpcyBoYXNuJ3QgYmVlbiBpbml0aWFsaXNlZCAtIHN1cGVyKCkgaGFzbid0IGJlZW4gY2FsbGVkIik7cmV0dXJuIWJ8fAoib2JqZWN0IiE9PXR5cGVvZiBiJiYiZnVuY3Rpb24iIT09dHlwZW9mIGI/dGhpczpifW0oYSxjKTtsKGEsW3trZXk6Il9sb2FkRGF0YSIsdmFsdWU6ZnVuY3Rpb24oYSxjKXthLmxvYWRSYW5nZShbNiw5XSx7b25TdWNjZXNzOmZ1bmN0aW9uKCl7YS5sb2FkUmFuZ2UoWzAsMTArYS5nZXRTeW5jaHNhZmVJbnRlZ2VyMzJBdCg2KS0xXSxjKX0sb25FcnJvcjpjLm9uRXJyb3J9KX19LHtrZXk6Il9wYXJzZURhdGEiLHZhbHVlOmZ1bmN0aW9uKGEsYyl7dmFyIGIsZz0wLGY9YS5nZXRCeXRlQXQoZyszKTtpZig0PGYpcmV0dXJue3R5cGU6IklEMyIsdmVyc2lvbjoiPjIuNCIsdGFnczp7fX07dmFyIGw9YS5nZXRCeXRlQXQoZys0KSxtPWEuaXNCaXRTZXRBdChnKzUsNyksbj1hLmlzQml0U2V0QXQoZys1LDYpLHg9YS5pc0JpdFNldEF0KGcrNSw1KSxwPWEuZ2V0U3luY2hzYWZlSW50ZWdlcjMyQXQoZys2KTtnKz0xMDtpZihuKWlmKDQ9PT1mKXt2YXIgdD1hLmdldFN5bmNoc2FmZUludGVnZXIzMkF0KGcpOwpnKz10fWVsc2UgdD1hLmdldExvbmdBdChnLCEwKSxnKz10KzQ7dD17dHlwZToiSUQzIix2ZXJzaW9uOiIyLiIrZisiLiIrbCxtYWpvcjpmLHJldmlzaW9uOmwsZmxhZ3M6e3Vuc3luY2hyb25pc2F0aW9uOm0sZXh0ZW5kZWRfaGVhZGVyOm4sZXhwZXJpbWVudGFsX2luZGljYXRvcjp4LGZvb3Rlcl9wcmVzZW50OiExfSxzaXplOnAsdGFnczp7fX07YyYmKGI9dGhpcy5fZXhwYW5kU2hvcnRjdXRUYWdzKGMpKTtjPXArMTA7dC5mbGFncy51bnN5bmNocm9uaXNhdGlvbiYmKGE9ZS5nZXRVbnN5bmNGaWxlUmVhZGVyKGEsZyxwKSxnPTAsYz1hLmdldFNpemUoKSk7YT1lLnJlYWRGcmFtZXMoZyxjLGEsdCxiKTtmb3IodmFyIHEgaW4gZClkLmhhc093blByb3BlcnR5KHEpJiYoYj10aGlzLl9nZXRGcmFtZURhdGEoYSxkW3FdKSkmJih0LnRhZ3NbcV09Yik7Zm9yKHZhciB6IGluIGEpYS5oYXNPd25Qcm9wZXJ0eSh6KSYmKHQudGFnc1t6XT1hW3pdKTtyZXR1cm4gdH19LHtrZXk6Il9nZXRGcmFtZURhdGEiLAp2YWx1ZTpmdW5jdGlvbihhLGMpe2Zvcih2YXIgYj0wLGQ7ZD1jW2JdO2IrKylpZihkIGluIGEpcmV0dXJuIGE9YVtkXWluc3RhbmNlb2YgQXJyYXk/YVtkXVswXTphW2RdLGEuZGF0YX19LHtrZXk6ImdldFNob3J0Y3V0cyIsdmFsdWU6ZnVuY3Rpb24oKXtyZXR1cm4gZH19XSxbe2tleToiZ2V0VGFnSWRlbnRpZmllckJ5dGVSYW5nZSIsdmFsdWU6ZnVuY3Rpb24oKXtyZXR1cm57b2Zmc2V0OjAsbGVuZ3RoOjEwfX19LHtrZXk6ImNhblJlYWRUYWdGb3JtYXQiLHZhbHVlOmZ1bmN0aW9uKGEpe3JldHVybiJJRDMiPT09U3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsYS5zbGljZSgwLDMpKX19XSk7cmV0dXJuIGF9KHEpO3ZhciBkPXt0aXRsZTpbIlRJVDIiLCJUVDIiXSxhcnRpc3Q6WyJUUEUxIiwiVFAxIl0sYWxidW06WyJUQUxCIiwiVEFMIl0seWVhcjpbIlRZRVIiLCJUWUUiXSxjb21tZW50OlsiQ09NTSIsIkNPTSJdLHRyYWNrOlsiVFJDSyIsIlRSSyJdLGdlbnJlOlsiVENPTiIsCiJUQ08iXSxwaWN0dXJlOlsiQVBJQyIsIlBJQyJdLGx5cmljczpbIlVTTFQiLCJVTFQiXX07cC5leHBvcnRzPWZ9LHsiLi9JRDN2MkZyYW1lUmVhZGVyIjo4LCIuL01lZGlhRmlsZVJlYWRlciI6MTEsIi4vTWVkaWFUYWdSZWFkZXIiOjEyfV0sMTA6W2Z1bmN0aW9uKGYscCxxKXtmdW5jdGlvbiBtKGEsYil7aWYoImZ1bmN0aW9uIiE9PXR5cGVvZiBiJiZudWxsIT09Yil0aHJvdyBuZXcgVHlwZUVycm9yKCJTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICIrdHlwZW9mIGIpO2EucHJvdG90eXBlPU9iamVjdC5jcmVhdGUoYiYmYi5wcm90b3R5cGUse2NvbnN0cnVjdG9yOnt2YWx1ZTphLGVudW1lcmFibGU6ITEsd3JpdGFibGU6ITAsY29uZmlndXJhYmxlOiEwfX0pO2ImJihPYmplY3Quc2V0UHJvdG90eXBlT2Y/T2JqZWN0LnNldFByb3RvdHlwZU9mKGEsYik6YS5fX3Byb3RvX189Yil9dmFyIGw9ZnVuY3Rpb24oKXtmdW5jdGlvbiBhKGEsCmMpe2Zvcih2YXIgYj0wO2I8Yy5sZW5ndGg7YisrKXt2YXIgZD1jW2JdO2QuZW51bWVyYWJsZT1kLmVudW1lcmFibGV8fCExO2QuY29uZmlndXJhYmxlPSEwOyJ2YWx1ZSJpbiBkJiYoZC53cml0YWJsZT0hMCk7T2JqZWN0LmRlZmluZVByb3BlcnR5KGEsZC5rZXksZCl9fXJldHVybiBmdW5jdGlvbihiLGMsZCl7YyYmYShiLnByb3RvdHlwZSxjKTtkJiZhKGIsZCk7cmV0dXJuIGJ9fSgpO3E9ZigiLi9NZWRpYVRhZ1JlYWRlciIpO2YoIi4vTWVkaWFGaWxlUmVhZGVyIik7Zj1mdW5jdGlvbihhKXtmdW5jdGlvbiBiKCl7aWYoISh0aGlzIGluc3RhbmNlb2YgYikpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7dmFyIGE9KGIuX19wcm90b19ffHxPYmplY3QuZ2V0UHJvdG90eXBlT2YoYikpLmFwcGx5KHRoaXMsYXJndW1lbnRzKTtpZighdGhpcyl0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoInRoaXMgaGFzbid0IGJlZW4gaW5pdGlhbGlzZWQgLSBzdXBlcigpIGhhc24ndCBiZWVuIGNhbGxlZCIpOwpyZXR1cm4hYXx8Im9iamVjdCIhPT10eXBlb2YgYSYmImZ1bmN0aW9uIiE9PXR5cGVvZiBhP3RoaXM6YX1tKGIsYSk7bChiLFt7a2V5OiJfbG9hZERhdGEiLHZhbHVlOmZ1bmN0aW9uKGEsYil7dmFyIGM9dGhpczthLmxvYWRSYW5nZShbMCwxNl0se29uU3VjY2VzczpmdW5jdGlvbigpe2MuX2xvYWRBdG9tKGEsMCwiIixiKX0sb25FcnJvcjpiLm9uRXJyb3J9KX19LHtrZXk6Il9sb2FkQXRvbSIsdmFsdWU6ZnVuY3Rpb24oYSxiLGMsZCl7aWYoYj49YS5nZXRTaXplKCkpZC5vblN1Y2Nlc3MoKTtlbHNle3ZhciBnPXRoaXMsZT1hLmdldExvbmdBdChiLCEwKTtpZigwPT1lfHxpc05hTihlKSlkLm9uU3VjY2VzcygpO2Vsc2V7dmFyIGg9YS5nZXRTdHJpbmdBdChiKzQsNCk7aWYodGhpcy5faXNDb250YWluZXJBdG9tKGgpKXsibWV0YSI9PWgmJihiKz00KTt2YXIgZj0oYz9jKyIuIjoiIikraDsibW9vdi51ZHRhLm1ldGEuaWxzdCI9PT1mP2EubG9hZFJhbmdlKFtiLGIrZV0sZCk6YS5sb2FkUmFuZ2UoW2IrCjgsYis4KzhdLHtvblN1Y2Nlc3M6ZnVuY3Rpb24oKXtnLl9sb2FkQXRvbShhLGIrOCxmLGQpfSxvbkVycm9yOmQub25FcnJvcn0pfWVsc2UgYS5sb2FkUmFuZ2UoW2IrZSxiK2UrOF0se29uU3VjY2VzczpmdW5jdGlvbigpe2cuX2xvYWRBdG9tKGEsYitlLGMsZCl9LG9uRXJyb3I6ZC5vbkVycm9yfSl9fX19LHtrZXk6Il9pc0NvbnRhaW5lckF0b20iLHZhbHVlOmZ1bmN0aW9uKGEpe3JldHVybiAwPD1bIm1vb3YiLCJ1ZHRhIiwibWV0YSIsImlsc3QiXS5pbmRleE9mKGEpfX0se2tleToiX2NhblJlYWRBdG9tIix2YWx1ZTpmdW5jdGlvbihhKXtyZXR1cm4iLS0tLSIhPT1hfX0se2tleToiX3BhcnNlRGF0YSIsdmFsdWU6ZnVuY3Rpb24oYSxiKXt2YXIgZD17fTtiPXRoaXMuX2V4cGFuZFNob3J0Y3V0VGFncyhiKTt0aGlzLl9yZWFkQXRvbShkLGEsMCxhLmdldFNpemUoKSxiKTtmb3IodmFyIGUgaW4gYyljLmhhc093blByb3BlcnR5KGUpJiYoYj1kW2NbZV1dKSYmKGRbZV09InRyYWNrIj09PQplP2IuZGF0YS50cmFjazpiLmRhdGEpO3JldHVybnt0eXBlOiJNUDQiLGZ0eXA6YS5nZXRTdHJpbmdBdCg4LDQpLHZlcnNpb246YS5nZXRMb25nQXQoMTIsITApLHRhZ3M6ZH19fSx7a2V5OiJfcmVhZEF0b20iLHZhbHVlOmZ1bmN0aW9uKGEsYixkLGMsZSxmLG4pe249dm9pZCAwPT09bj8iIjpuKyIgICI7Zm9yKHZhciBnPWQ7ZzxkK2M7KXt2YXIgaD1iLmdldExvbmdBdChnLCEwKTtpZigwPT1oKWJyZWFrO3ZhciBrPWIuZ2V0U3RyaW5nQXQoZys0LDQpO2lmKHRoaXMuX2lzQ29udGFpbmVyQXRvbShrKSl7Im1ldGEiPT1rJiYoZys9NCk7dGhpcy5fcmVhZEF0b20oYSxiLGcrOCxoLTgsZSwoZj9mKyIuIjoiIikrayxuKTticmVha30oIWV8fDA8PWUuaW5kZXhPZihrKSkmJiJtb292LnVkdGEubWV0YS5pbHN0Ij09PWYmJnRoaXMuX2NhblJlYWRBdG9tKGspJiYoYVtrXT10aGlzLl9yZWFkTWV0YWRhdGFBdG9tKGIsZykpO2crPWh9fX0se2tleToiX3JlYWRNZXRhZGF0YUF0b20iLHZhbHVlOmZ1bmN0aW9uKGEsCmIpe3ZhciBjPWEuZ2V0TG9uZ0F0KGIsITApLGc9YS5nZXRTdHJpbmdBdChiKzQsNCksaD1hLmdldEludGVnZXIyNEF0KGIrMTYrMSwhMCk7aD1lW2hdO2lmKCJ0cmtuIj09Zyl2YXIgZj17dHJhY2s6YS5nZXRCeXRlQXQoYisxNisxMSksdG90YWw6YS5nZXRCeXRlQXQoYisxNisxMyl9O2Vsc2UgaWYoImRpc2siPT1nKWY9e2Rpc2s6YS5nZXRCeXRlQXQoYisxNisxMSksdG90YWw6YS5nZXRCeXRlQXQoYisxNisxMyl9O2Vsc2V7Yis9MjQ7dmFyIG49Yy0yNDsiY292ciI9PT1nJiYidWludDgiPT09aCYmKGg9ImpwZWciKTtzd2l0Y2goaCl7Y2FzZSAidGV4dCI6Zj1hLmdldFN0cmluZ1dpdGhDaGFyc2V0QXQoYixuLCJ1dGYtOCIpLnRvU3RyaW5nKCk7YnJlYWs7Y2FzZSAidWludDgiOmY9YS5nZXRTaG9ydEF0KGIsITEpO2JyZWFrO2Nhc2UgImludCI6Y2FzZSAidWludCI6Zj0oImludCI9PWg/MT09bj9hLmdldFNCeXRlQXQ6Mj09bj9hLmdldFNTaG9ydEF0OjQ9PW4/YS5nZXRTTG9uZ0F0OgphLmdldExvbmdBdDoxPT1uP2EuZ2V0Qnl0ZUF0OjI9PW4/YS5nZXRTaG9ydEF0OmEuZ2V0TG9uZ0F0KS5jYWxsKGEsYisoOD09bj80OjApLCEwKTticmVhaztjYXNlICJqcGVnIjpjYXNlICJwbmciOmY9e2Zvcm1hdDoiaW1hZ2UvIitoLGRhdGE6YS5nZXRCeXRlc0F0KGIsbil9fX1yZXR1cm57aWQ6ZyxzaXplOmMsZGVzY3JpcHRpb246ZFtnXXx8IlVua25vd24iLGRhdGE6Zn19fSx7a2V5OiJnZXRTaG9ydGN1dHMiLHZhbHVlOmZ1bmN0aW9uKCl7cmV0dXJuIGN9fV0sW3trZXk6ImdldFRhZ0lkZW50aWZpZXJCeXRlUmFuZ2UiLHZhbHVlOmZ1bmN0aW9uKCl7cmV0dXJue29mZnNldDowLGxlbmd0aDoxNn19fSx7a2V5OiJjYW5SZWFkVGFnRm9ybWF0Iix2YWx1ZTpmdW5jdGlvbihhKXtyZXR1cm4iZnR5cCI9PT1TdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZyxhLnNsaWNlKDQsOCkpfX1dKTtyZXR1cm4gYn0ocSk7dmFyIGU9ezA6InVpbnQ4IiwxOiJ0ZXh0IiwxMzoianBlZyIsCjE0OiJwbmciLDIxOiJpbnQiLDIyOiJ1aW50In0sZD17Ilx1MDBhOWFsYiI6IkFsYnVtIiwiXHUwMGE5QVJUIjoiQXJ0aXN0IixhQVJUOiJBbGJ1bSBBcnRpc3QiLCJcdTAwYTlkYXkiOiJSZWxlYXNlIERhdGUiLCJcdTAwYTluYW0iOiJUaXRsZSIsIlx1MDBhOWdlbiI6IkdlbnJlIixnbnJlOiJHZW5yZSIsdHJrbjoiVHJhY2sgTnVtYmVyIiwiXHUwMGE5d3J0IjoiQ29tcG9zZXIiLCJcdTAwYTl0b28iOiJFbmNvZGluZyBUb29sIiwiXHUwMGE5ZW5jIjoiRW5jb2RlZCBCeSIsY3BydDoiQ29weXJpZ2h0Iixjb3ZyOiJDb3ZlciBBcnQiLCJcdTAwYTlncnAiOiJHcm91cGluZyIsa2V5dzoiS2V5d29yZHMiLCJcdTAwYTlseXIiOiJMeXJpY3MiLCJcdTAwYTljbXQiOiJDb21tZW50Iix0bXBvOiJUZW1wbyIsY3BpbDoiQ29tcGlsYXRpb24iLGRpc2s6IkRpc2MgTnVtYmVyIix0dnNoOiJUViBTaG93IE5hbWUiLHR2ZW46IlRWIEVwaXNvZGUgSUQiLHR2c246IlRWIFNlYXNvbiIsdHZlczoiVFYgRXBpc29kZSIsCnR2bm46IlRWIE5ldHdvcmsiLGRlc2M6IkRlc2NyaXB0aW9uIixsZGVzOiJMb25nIERlc2NyaXB0aW9uIixzb25tOiJTb3J0IE5hbWUiLHNvYXI6IlNvcnQgQXJ0aXN0Iixzb2FhOiJTb3J0IEFsYnVtIixzb2NvOiJTb3J0IENvbXBvc2VyIixzb3NuOiJTb3J0IFNob3ciLHB1cmQ6IlB1cmNoYXNlIERhdGUiLHBjc3Q6IlBvZGNhc3QiLHB1cmw6IlBvZGNhc3QgVVJMIixjYXRnOiJDYXRlZ29yeSIsaGR2ZDoiSEQgVmlkZW8iLHN0aWs6Ik1lZGlhIFR5cGUiLHJ0bmc6IkNvbnRlbnQgUmF0aW5nIixwZ2FwOiJHYXBsZXNzIFBsYXliYWNrIixhcElEOiJQdXJjaGFzZSBBY2NvdW50IixzZklEOiJDb3VudHJ5IENvZGUiLGF0SUQ6IkFydGlzdCBJRCIsY25JRDoiQ2F0YWxvZyBJRCIscGxJRDoiQ29sbGVjdGlvbiBJRCIsZ2VJRDoiR2VucmUgSUQiLCJ4aWQgIjoiVmVuZG9yIEluZm9ybWF0aW9uIixmbHZyOiJDb2RlYyBGbGF2b3IifSxjPXt0aXRsZToiXHUwMGE5bmFtIixhcnRpc3Q6Ilx1MDBhOUFSVCIsCmFsYnVtOiJcdTAwYTlhbGIiLHllYXI6Ilx1MDBhOWRheSIsY29tbWVudDoiXHUwMGE5Y210Iix0cmFjazoidHJrbiIsZ2VucmU6Ilx1MDBhOWdlbiIscGljdHVyZToiY292ciIsbHlyaWNzOiJcdTAwYTlseXIifTtwLmV4cG9ydHM9Zn0seyIuL01lZGlhRmlsZVJlYWRlciI6MTEsIi4vTWVkaWFUYWdSZWFkZXIiOjEyfV0sMTE6W2Z1bmN0aW9uKGYscCxxKXt2YXIgbT1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoZCxjKXtmb3IodmFyIGE9MDthPGMubGVuZ3RoO2ErKyl7dmFyIGI9Y1thXTtiLmVudW1lcmFibGU9Yi5lbnVtZXJhYmxlfHwhMTtiLmNvbmZpZ3VyYWJsZT0hMDsidmFsdWUiaW4gYiYmKGIud3JpdGFibGU9ITApO09iamVjdC5kZWZpbmVQcm9wZXJ0eShkLGIua2V5LGIpfX1yZXR1cm4gZnVuY3Rpb24oZCxjLGEpe2MmJmUoZC5wcm90b3R5cGUsYyk7YSYmZShkLGEpO3JldHVybiBkfX0oKSxsPWYoIi4vU3RyaW5nVXRpbHMiKTtmPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZShkKXtpZighKHRoaXMgaW5zdGFuY2VvZgplKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTt0aGlzLl9pc0luaXRpYWxpemVkPSExO3RoaXMuX3NpemU9MH1tKGUsW3trZXk6ImluaXQiLHZhbHVlOmZ1bmN0aW9uKGQpe3ZhciBjPXRoaXM7aWYodGhpcy5faXNJbml0aWFsaXplZClzZXRUaW1lb3V0KGQub25TdWNjZXNzLDEpO2Vsc2UgcmV0dXJuIHRoaXMuX2luaXQoe29uU3VjY2VzczpmdW5jdGlvbigpe2MuX2lzSW5pdGlhbGl6ZWQ9ITA7ZC5vblN1Y2Nlc3MoKX0sb25FcnJvcjpkLm9uRXJyb3J9KX19LHtrZXk6Il9pbml0Iix2YWx1ZTpmdW5jdGlvbihkKXt0aHJvdyBFcnJvcigiTXVzdCBpbXBsZW1lbnQgaW5pdCBmdW5jdGlvbiIpO319LHtrZXk6ImxvYWRSYW5nZSIsdmFsdWU6ZnVuY3Rpb24oZCxjKXt0aHJvdyBFcnJvcigiTXVzdCBpbXBsZW1lbnQgbG9hZFJhbmdlIGZ1bmN0aW9uIik7fX0se2tleToiZ2V0U2l6ZSIsdmFsdWU6ZnVuY3Rpb24oKXtpZighdGhpcy5faXNJbml0aWFsaXplZCl0aHJvdyBFcnJvcigiaW5pdCgpIG11c3QgYmUgY2FsbGVkIGZpcnN0LiIpOwpyZXR1cm4gdGhpcy5fc2l6ZX19LHtrZXk6ImdldEJ5dGVBdCIsdmFsdWU6ZnVuY3Rpb24oZCl7dGhyb3cgRXJyb3IoIk11c3QgaW1wbGVtZW50IGdldEJ5dGVBdCBmdW5jdGlvbiIpO319LHtrZXk6ImdldEJ5dGVzQXQiLHZhbHVlOmZ1bmN0aW9uKGQsYyl7Zm9yKHZhciBhPUFycmF5KGMpLGI9MDtiPGM7YisrKWFbYl09dGhpcy5nZXRCeXRlQXQoZCtiKTtyZXR1cm4gYX19LHtrZXk6ImlzQml0U2V0QXQiLHZhbHVlOmZ1bmN0aW9uKGQsYyl7cmV0dXJuIDAhPSh0aGlzLmdldEJ5dGVBdChkKSYxPDxjKX19LHtrZXk6ImdldFNCeXRlQXQiLHZhbHVlOmZ1bmN0aW9uKGQpe2Q9dGhpcy5nZXRCeXRlQXQoZCk7cmV0dXJuIDEyNzxkP2QtMjU2OmR9fSx7a2V5OiJnZXRTaG9ydEF0Iix2YWx1ZTpmdW5jdGlvbihkLGMpe2Q9Yz8odGhpcy5nZXRCeXRlQXQoZCk8PDgpK3RoaXMuZ2V0Qnl0ZUF0KGQrMSk6KHRoaXMuZ2V0Qnl0ZUF0KGQrMSk8PDgpK3RoaXMuZ2V0Qnl0ZUF0KGQpOzA+ZCYmKGQrPQo2NTUzNik7cmV0dXJuIGR9fSx7a2V5OiJnZXRTU2hvcnRBdCIsdmFsdWU6ZnVuY3Rpb24oZCxjKXtkPXRoaXMuZ2V0U2hvcnRBdChkLGMpO3JldHVybiAzMjc2NzxkP2QtNjU1MzY6ZH19LHtrZXk6ImdldExvbmdBdCIsdmFsdWU6ZnVuY3Rpb24oZCxjKXt2YXIgYT10aGlzLmdldEJ5dGVBdChkKSxiPXRoaXMuZ2V0Qnl0ZUF0KGQrMSksZT10aGlzLmdldEJ5dGVBdChkKzIpO2Q9dGhpcy5nZXRCeXRlQXQoZCszKTtjPWM/KCgoYTw8OCkrYjw8OCkrZTw8OCkrZDooKChkPDw4KStlPDw4KStiPDw4KSthOzA+YyYmKGMrPTQyOTQ5NjcyOTYpO3JldHVybiBjfX0se2tleToiZ2V0U0xvbmdBdCIsdmFsdWU6ZnVuY3Rpb24oZCxjKXtkPXRoaXMuZ2V0TG9uZ0F0KGQsYyk7cmV0dXJuIDIxNDc0ODM2NDc8ZD9kLTQyOTQ5NjcyOTY6ZH19LHtrZXk6ImdldEludGVnZXIyNEF0Iix2YWx1ZTpmdW5jdGlvbihkLGMpe3ZhciBhPXRoaXMuZ2V0Qnl0ZUF0KGQpLGI9dGhpcy5nZXRCeXRlQXQoZCsxKTsKZD10aGlzLmdldEJ5dGVBdChkKzIpO2M9Yz8oKGE8PDgpK2I8PDgpK2Q6KChkPDw4KStiPDw4KSthOzA+YyYmKGMrPTE2Nzc3MjE2KTtyZXR1cm4gY319LHtrZXk6ImdldFN0cmluZ0F0Iix2YWx1ZTpmdW5jdGlvbihkLGMpe2Zvcih2YXIgYT1bXSxiPWQsZT0wO2I8ZCtjO2IrKyxlKyspYVtlXT1TdHJpbmcuZnJvbUNoYXJDb2RlKHRoaXMuZ2V0Qnl0ZUF0KGIpKTtyZXR1cm4gYS5qb2luKCIiKX19LHtrZXk6ImdldFN0cmluZ1dpdGhDaGFyc2V0QXQiLHZhbHVlOmZ1bmN0aW9uKGQsYyxhKXtkPXRoaXMuZ2V0Qnl0ZXNBdChkLGMpO3N3aXRjaCgoYXx8IiIpLnRvTG93ZXJDYXNlKCkpe2Nhc2UgInV0Zi0xNiI6Y2FzZSAidXRmLTE2bGUiOmNhc2UgInV0Zi0xNmJlIjphPWwucmVhZFVURjE2U3RyaW5nKGQsInV0Zi0xNmJlIj09PWEpO2JyZWFrO2Nhc2UgInV0Zi04IjphPWwucmVhZFVURjhTdHJpbmcoZCk7YnJlYWs7ZGVmYXVsdDphPWwucmVhZE51bGxUZXJtaW5hdGVkU3RyaW5nKGQpfXJldHVybiBhfX0sCntrZXk6ImdldENoYXJBdCIsdmFsdWU6ZnVuY3Rpb24oZCl7cmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUodGhpcy5nZXRCeXRlQXQoZCkpfX0se2tleToiZ2V0U3luY2hzYWZlSW50ZWdlcjMyQXQiLHZhbHVlOmZ1bmN0aW9uKGQpe3ZhciBjPXRoaXMuZ2V0Qnl0ZUF0KGQpLGE9dGhpcy5nZXRCeXRlQXQoZCsxKSxiPXRoaXMuZ2V0Qnl0ZUF0KGQrMik7cmV0dXJuIHRoaXMuZ2V0Qnl0ZUF0KGQrMykmMTI3fChiJjEyNyk8PDd8KGEmMTI3KTw8MTR8KGMmMTI3KTw8MjF9fV0sW3trZXk6ImNhblJlYWRGaWxlIix2YWx1ZTpmdW5jdGlvbihkKXt0aHJvdyBFcnJvcigiTXVzdCBpbXBsZW1lbnQgY2FuUmVhZEZpbGUgZnVuY3Rpb24iKTt9fV0pO3JldHVybiBlfSgpO3AuZXhwb3J0cz1mfSx7Ii4vU3RyaW5nVXRpbHMiOjEzfV0sMTI6W2Z1bmN0aW9uKGYscCxxKXt2YXIgbT1mdW5jdGlvbigpe2Z1bmN0aW9uIGYoZSxkKXtmb3IodmFyIGM9MDtjPGQubGVuZ3RoO2MrKyl7dmFyIGE9ZFtjXTsKYS5lbnVtZXJhYmxlPWEuZW51bWVyYWJsZXx8ITE7YS5jb25maWd1cmFibGU9ITA7InZhbHVlImluIGEmJihhLndyaXRhYmxlPSEwKTtPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxhLmtleSxhKX19cmV0dXJuIGZ1bmN0aW9uKGUsZCxjKXtkJiZmKGUucHJvdG90eXBlLGQpO2MmJmYoZSxjKTtyZXR1cm4gZX19KCk7ZigiLi9NZWRpYUZpbGVSZWFkZXIiKTtmPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZihlKXtpZighKHRoaXMgaW5zdGFuY2VvZiBmKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTt0aGlzLl9tZWRpYUZpbGVSZWFkZXI9ZTt0aGlzLl90YWdzPW51bGx9bShmLFt7a2V5OiJzZXRUYWdzVG9SZWFkIix2YWx1ZTpmdW5jdGlvbihlKXt0aGlzLl90YWdzPWU7cmV0dXJuIHRoaXN9fSx7a2V5OiJyZWFkIix2YWx1ZTpmdW5jdGlvbihlKXt2YXIgZD10aGlzO3RoaXMuX21lZGlhRmlsZVJlYWRlci5pbml0KHtvblN1Y2Nlc3M6ZnVuY3Rpb24oKXtkLl9sb2FkRGF0YShkLl9tZWRpYUZpbGVSZWFkZXIsCntvblN1Y2Nlc3M6ZnVuY3Rpb24oKXt0cnl7dmFyIGM9ZC5fcGFyc2VEYXRhKGQuX21lZGlhRmlsZVJlYWRlcixkLl90YWdzKX1jYXRjaChhKXtpZihlLm9uRXJyb3Ipe2Uub25FcnJvcih7dHlwZToicGFyc2VEYXRhIixpbmZvOmEubWVzc2FnZX0pO3JldHVybn19ZS5vblN1Y2Nlc3MoYyl9LG9uRXJyb3I6ZS5vbkVycm9yfSl9LG9uRXJyb3I6ZS5vbkVycm9yfSl9fSx7a2V5OiJnZXRTaG9ydGN1dHMiLHZhbHVlOmZ1bmN0aW9uKCl7cmV0dXJue319fSx7a2V5OiJfbG9hZERhdGEiLHZhbHVlOmZ1bmN0aW9uKGUsZCl7dGhyb3cgRXJyb3IoIk11c3QgaW1wbGVtZW50IF9sb2FkRGF0YSBmdW5jdGlvbiIpO319LHtrZXk6Il9wYXJzZURhdGEiLHZhbHVlOmZ1bmN0aW9uKGUsZCl7dGhyb3cgRXJyb3IoIk11c3QgaW1wbGVtZW50IF9wYXJzZURhdGEgZnVuY3Rpb24iKTt9fSx7a2V5OiJfZXhwYW5kU2hvcnRjdXRUYWdzIix2YWx1ZTpmdW5jdGlvbihlKXtpZighZSlyZXR1cm4gbnVsbDtmb3IodmFyIGQ9CltdLGM9dGhpcy5nZXRTaG9ydGN1dHMoKSxhPTAsYjtiPWVbYV07YSsrKWQ9ZC5jb25jYXQoY1tiXXx8W2JdKTtyZXR1cm4gZH19XSxbe2tleToiZ2V0VGFnSWRlbnRpZmllckJ5dGVSYW5nZSIsdmFsdWU6ZnVuY3Rpb24oKXt0aHJvdyBFcnJvcigiTXVzdCBpbXBsZW1lbnQiKTt9fSx7a2V5OiJjYW5SZWFkVGFnRm9ybWF0Iix2YWx1ZTpmdW5jdGlvbihlKXt0aHJvdyBFcnJvcigiTXVzdCBpbXBsZW1lbnQiKTt9fV0pO3JldHVybiBmfSgpO3AuZXhwb3J0cz1mfSx7Ii4vTWVkaWFGaWxlUmVhZGVyIjoxMX1dLDEzOltmdW5jdGlvbihmLHAscSl7dmFyIG09ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKGQsYyl7Zm9yKHZhciBhPTA7YTxjLmxlbmd0aDthKyspe3ZhciBiPWNbYV07Yi5lbnVtZXJhYmxlPWIuZW51bWVyYWJsZXx8ITE7Yi5jb25maWd1cmFibGU9ITA7InZhbHVlImluIGImJihiLndyaXRhYmxlPSEwKTtPYmplY3QuZGVmaW5lUHJvcGVydHkoZCxiLmtleSxiKX19cmV0dXJuIGZ1bmN0aW9uKGQsCmMsYSl7YyYmZShkLnByb3RvdHlwZSxjKTthJiZlKGQsYSk7cmV0dXJuIGR9fSgpLGw9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKGQsYyl7aWYoISh0aGlzIGluc3RhbmNlb2YgZSkpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7dGhpcy5fdmFsdWU9ZDt0aGlzLmJ5dGVzUmVhZENvdW50PWM7dGhpcy5sZW5ndGg9ZC5sZW5ndGh9bShlLFt7a2V5OiJ0b1N0cmluZyIsdmFsdWU6ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5fdmFsdWV9fV0pO3JldHVybiBlfSgpO3AuZXhwb3J0cz17cmVhZFVURjE2U3RyaW5nOmZ1bmN0aW9uKGUsZCxjKXt2YXIgYT0wLGI9MSxnPTA7Yz1NYXRoLm1pbihjfHxlLmxlbmd0aCxlLmxlbmd0aCk7MjU0PT1lWzBdJiYyNTU9PWVbMV0/KGQ9ITAsYT0yKToyNTU9PWVbMF0mJjI1ND09ZVsxXSYmKGQ9ITEsYT0yKTtkJiYoYj0wLGc9MSk7ZD1bXTtmb3IodmFyIGg9MDthPGM7aCsrKXt2YXIgZj1lW2ErYl0sbT0oZjw8CjgpK2VbYStnXTthKz0yO2lmKDA9PW0pYnJlYWs7ZWxzZSAyMTY+Znx8MjI0PD1mP2RbaF09U3RyaW5nLmZyb21DaGFyQ29kZShtKTooZj0oZVthK2JdPDw4KStlW2ErZ10sYSs9MixkW2hdPVN0cmluZy5mcm9tQ2hhckNvZGUobSxmKSl9cmV0dXJuIG5ldyBsKGQuam9pbigiIiksYSl9LHJlYWRVVEY4U3RyaW5nOmZ1bmN0aW9uKGUsZCl7dmFyIGM9MDtkPU1hdGgubWluKGR8fGUubGVuZ3RoLGUubGVuZ3RoKTsyMzk9PWVbMF0mJjE4Nz09ZVsxXSYmMTkxPT1lWzJdJiYoYz0zKTtmb3IodmFyIGE9W10sYj0wO2M8ZDtiKyspe3ZhciBnPWVbYysrXTtpZigwPT1nKWJyZWFrO2Vsc2UgaWYoMTI4PmcpYVtiXT1TdHJpbmcuZnJvbUNoYXJDb2RlKGcpO2Vsc2UgaWYoMTk0PD1nJiYyMjQ+Zyl7dmFyIGg9ZVtjKytdO2FbYl09U3RyaW5nLmZyb21DaGFyQ29kZSgoKGcmMzEpPDw2KSsoaCY2MykpfWVsc2UgaWYoMjI0PD1nJiYyNDA+Zyl7aD1lW2MrK107dmFyIGY9ZVtjKytdO2FbYl09U3RyaW5nLmZyb21DaGFyQ29kZSgoKGcmCjI1NSk8PDEyKSsoKGgmNjMpPDw2KSsoZiY2MykpfWVsc2UgaWYoMjQwPD1nJiYyNDU+Zyl7aD1lW2MrK107Zj1lW2MrK107dmFyIG09ZVtjKytdO2Y9KChnJjcpPDwxOCkrKChoJjYzKTw8MTIpKygoZiY2Myk8PDYpKyhtJjYzKS02NTUzNjthW2JdPVN0cmluZy5mcm9tQ2hhckNvZGUoKGY+PjEwKSs1NTI5NiwoZiYxMDIzKSs1NjMyMCl9fXJldHVybiBuZXcgbChhLmpvaW4oIiIpLGMpfSxyZWFkTnVsbFRlcm1pbmF0ZWRTdHJpbmc6ZnVuY3Rpb24oZSxkKXt2YXIgYz1bXTtkPWR8fGUubGVuZ3RoO2Zvcih2YXIgYT0wO2E8ZDspe3ZhciBiPWVbYSsrXTtpZigwPT1iKWJyZWFrO2NbYS0xXT1TdHJpbmcuZnJvbUNoYXJDb2RlKGIpfXJldHVybiBuZXcgbChjLmpvaW4oIiIpLGEpfX19LHt9XSwxNDpbZnVuY3Rpb24oZixwLHEpe2Z1bmN0aW9uIG0oZCxjKXtpZigiZnVuY3Rpb24iIT09dHlwZW9mIGMmJm51bGwhPT1jKXRocm93IG5ldyBUeXBlRXJyb3IoIlN1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgIisKdHlwZW9mIGMpO2QucHJvdG90eXBlPU9iamVjdC5jcmVhdGUoYyYmYy5wcm90b3R5cGUse2NvbnN0cnVjdG9yOnt2YWx1ZTpkLGVudW1lcmFibGU6ITEsd3JpdGFibGU6ITAsY29uZmlndXJhYmxlOiEwfX0pO2MmJihPYmplY3Quc2V0UHJvdG90eXBlT2Y/T2JqZWN0LnNldFByb3RvdHlwZU9mKGQsYyk6ZC5fX3Byb3RvX189Yyl9dmFyIGw9ZnVuY3Rpb24oKXtmdW5jdGlvbiBkKGQsYSl7Zm9yKHZhciBiPTA7YjxhLmxlbmd0aDtiKyspe3ZhciBjPWFbYl07Yy5lbnVtZXJhYmxlPWMuZW51bWVyYWJsZXx8ITE7Yy5jb25maWd1cmFibGU9ITA7InZhbHVlImluIGMmJihjLndyaXRhYmxlPSEwKTtPYmplY3QuZGVmaW5lUHJvcGVydHkoZCxjLmtleSxjKX19cmV0dXJuIGZ1bmN0aW9uKGMsYSxiKXthJiZkKGMucHJvdG90eXBlLGEpO2ImJmQoYyxiKTtyZXR1cm4gY319KCksZT1mKCIuL0NodW5rZWRGaWxlRGF0YSIpO3E9ZnVuY3Rpb24oZCl7ZnVuY3Rpb24gYyhhKXtpZighKHRoaXMgaW5zdGFuY2VvZgpjKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTt2YXIgYj0oYy5fX3Byb3RvX198fE9iamVjdC5nZXRQcm90b3R5cGVPZihjKSkuY2FsbCh0aGlzKTtpZighdGhpcyl0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoInRoaXMgaGFzbid0IGJlZW4gaW5pdGlhbGlzZWQgLSBzdXBlcigpIGhhc24ndCBiZWVuIGNhbGxlZCIpO2I9IWJ8fCJvYmplY3QiIT09dHlwZW9mIGImJiJmdW5jdGlvbiIhPT10eXBlb2YgYj90aGlzOmI7Yi5fdXJsPWE7Yi5fZmlsZURhdGE9bmV3IGU7cmV0dXJuIGJ9bShjLGQpO2woYyxbe2tleToiX2luaXQiLHZhbHVlOmZ1bmN0aW9uKGEpe2MuX2NvbmZpZy5hdm9pZEhlYWRSZXF1ZXN0cz90aGlzLl9mZXRjaFNpemVXaXRoR2V0UmVxdWVzdChhKTp0aGlzLl9mZXRjaFNpemVXaXRoSGVhZFJlcXVlc3QoYSl9fSx7a2V5OiJfZmV0Y2hTaXplV2l0aEhlYWRSZXF1ZXN0Iix2YWx1ZTpmdW5jdGlvbihhKXt2YXIgYj0KdGhpczt0aGlzLl9tYWtlWEhSUmVxdWVzdCgiSEVBRCIsbnVsbCx7b25TdWNjZXNzOmZ1bmN0aW9uKGMpeyhjPWIuX3BhcnNlQ29udGVudExlbmd0aChjKSk/KGIuX3NpemU9YyxhLm9uU3VjY2VzcygpKTpiLl9mZXRjaFNpemVXaXRoR2V0UmVxdWVzdChhKX0sb25FcnJvcjphLm9uRXJyb3J9KX19LHtrZXk6Il9mZXRjaFNpemVXaXRoR2V0UmVxdWVzdCIsdmFsdWU6ZnVuY3Rpb24oYSl7dmFyIGI9dGhpcyxjPXRoaXMuX3JvdW5kUmFuZ2VUb0NodW5rTXVsdGlwbGUoWzAsMF0pO3RoaXMuX21ha2VYSFJSZXF1ZXN0KCJHRVQiLGMse29uU3VjY2VzczpmdW5jdGlvbihjKXt2YXIgZD1iLl9wYXJzZUNvbnRlbnRSYW5nZShjKTtjPWIuX2dldFhoclJlc3BvbnNlQ29udGVudChjKTtpZihkKXtpZihudWxsPT1kLmluc3RhbmNlTGVuZ3RoKXtiLl9mZXRjaEVudGlyZUZpbGUoYSk7cmV0dXJufWIuX3NpemU9ZC5pbnN0YW5jZUxlbmd0aH1lbHNlIGIuX3NpemU9Yy5sZW5ndGg7Yi5fZmlsZURhdGEuYWRkRGF0YSgwLApjKTthLm9uU3VjY2VzcygpfSxvbkVycm9yOmEub25FcnJvcn0pfX0se2tleToiX2ZldGNoRW50aXJlRmlsZSIsdmFsdWU6ZnVuY3Rpb24oYSl7dmFyIGI9dGhpczt0aGlzLl9tYWtlWEhSUmVxdWVzdCgiR0VUIixudWxsLHtvblN1Y2Nlc3M6ZnVuY3Rpb24oYyl7Yz1iLl9nZXRYaHJSZXNwb25zZUNvbnRlbnQoYyk7Yi5fc2l6ZT1jLmxlbmd0aDtiLl9maWxlRGF0YS5hZGREYXRhKDAsYyk7YS5vblN1Y2Nlc3MoKX0sb25FcnJvcjphLm9uRXJyb3J9KX19LHtrZXk6Il9nZXRYaHJSZXNwb25zZUNvbnRlbnQiLHZhbHVlOmZ1bmN0aW9uKGEpe3JldHVybiBhLnJlc3BvbnNlQm9keXx8YS5yZXNwb25zZVRleHR8fCIifX0se2tleToiX3BhcnNlQ29udGVudExlbmd0aCIsdmFsdWU6ZnVuY3Rpb24oYSl7YT10aGlzLl9nZXRSZXNwb25zZUhlYWRlcihhLCJDb250ZW50LUxlbmd0aCIpO3JldHVybiBudWxsPT1hP2E6cGFyc2VJbnQoYSwxMCl9fSx7a2V5OiJfcGFyc2VDb250ZW50UmFuZ2UiLHZhbHVlOmZ1bmN0aW9uKGEpe2lmKGE9CnRoaXMuX2dldFJlc3BvbnNlSGVhZGVyKGEsIkNvbnRlbnQtUmFuZ2UiKSl7dmFyIGI9YS5tYXRjaCgvYnl0ZXMgKFxkKyktKFxkKylcLyg/OihcZCspfFwqKS9pKTtpZighYil0aHJvdyBFcnJvcigiRklYTUU6IFVua25vd24gQ29udGVudC1SYW5nZSBzeW50YXg6ICIrYSk7cmV0dXJue2ZpcnN0Qnl0ZVBvc2l0aW9uOnBhcnNlSW50KGJbMV0sMTApLGxhc3RCeXRlUG9zaXRpb246cGFyc2VJbnQoYlsyXSwxMCksaW5zdGFuY2VMZW5ndGg6YlszXT9wYXJzZUludChiWzNdLDEwKTpudWxsfX1yZXR1cm4gbnVsbH19LHtrZXk6ImxvYWRSYW5nZSIsdmFsdWU6ZnVuY3Rpb24oYSxiKXt2YXIgYz10aGlzO2MuX2ZpbGVEYXRhLmhhc0RhdGFSYW5nZShhWzBdLE1hdGgubWluKGMuX3NpemUsYVsxXSkpP3NldFRpbWVvdXQoYi5vblN1Y2Nlc3MsMSk6KGE9dGhpcy5fcm91bmRSYW5nZVRvQ2h1bmtNdWx0aXBsZShhKSxhWzFdPU1hdGgubWluKGMuX3NpemUsYVsxXSksdGhpcy5fbWFrZVhIUlJlcXVlc3QoIkdFVCIsCmEse29uU3VjY2VzczpmdW5jdGlvbihkKXtkPWMuX2dldFhoclJlc3BvbnNlQ29udGVudChkKTtjLl9maWxlRGF0YS5hZGREYXRhKGFbMF0sZCk7Yi5vblN1Y2Nlc3MoKX0sb25FcnJvcjpiLm9uRXJyb3J9KSl9fSx7a2V5OiJfcm91bmRSYW5nZVRvQ2h1bmtNdWx0aXBsZSIsdmFsdWU6ZnVuY3Rpb24oYSl7cmV0dXJuW2FbMF0sYVswXSsxMDI0Kk1hdGguY2VpbCgoYVsxXS1hWzBdKzEpLzEwMjQpLTFdfX0se2tleToiX21ha2VYSFJSZXF1ZXN0Iix2YWx1ZTpmdW5jdGlvbihhLGIsZCl7dmFyIGU9dGhpcy5fY3JlYXRlWEhST2JqZWN0KCk7ZS5vcGVuKGEsdGhpcy5fdXJsKTt2YXIgZj1mdW5jdGlvbigpe2lmKDIwMD09PWUuc3RhdHVzfHwyMDY9PT1lLnN0YXR1cylkLm9uU3VjY2VzcyhlKTtlbHNlIGlmKGQub25FcnJvcilkLm9uRXJyb3Ioe3R5cGU6InhociIsaW5mbzoiVW5leHBlY3RlZCBIVFRQIHN0YXR1cyAiK2Uuc3RhdHVzKyIuIix4aHI6ZX0pO2U9bnVsbH07InVuZGVmaW5lZCIhPT0KdHlwZW9mIGUub25sb2FkPyhlLm9ubG9hZD1mLGUub25lcnJvcj1mdW5jdGlvbigpe2lmKGQub25FcnJvcilkLm9uRXJyb3Ioe3R5cGU6InhociIsaW5mbzoiR2VuZXJpYyBYSFIgZXJyb3IsIGNoZWNrIHhociBvYmplY3QuIix4aHI6ZX0pfSk6ZS5vbnJlYWR5c3RhdGVjaGFuZ2U9ZnVuY3Rpb24oKXs0PT09ZS5yZWFkeVN0YXRlJiZmKCl9O2MuX2NvbmZpZy50aW1lb3V0SW5TZWMmJihlLnRpbWVvdXQ9MUUzKmMuX2NvbmZpZy50aW1lb3V0SW5TZWMsZS5vbnRpbWVvdXQ9ZnVuY3Rpb24oKXtpZihkLm9uRXJyb3IpZC5vbkVycm9yKHt0eXBlOiJ4aHIiLGluZm86IlRpbWVvdXQgYWZ0ZXIgIitlLnRpbWVvdXQvMUUzKyJzLiBVc2UganNtZWRpYXRhZ3MuQ29uZmlnLnNldFhoclRpbWVvdXQgdG8gb3ZlcnJpZGUuIix4aHI6ZX0pfSk7ZS5vdmVycmlkZU1pbWVUeXBlKCJ0ZXh0L3BsYWluOyBjaGFyc2V0PXgtdXNlci1kZWZpbmVkIik7YiYmdGhpcy5fc2V0UmVxdWVzdEhlYWRlcihlLCJSYW5nZSIsCiJieXRlcz0iK2JbMF0rIi0iK2JbMV0pO3RoaXMuX3NldFJlcXVlc3RIZWFkZXIoZSwiSWYtTW9kaWZpZWQtU2luY2UiLCJTYXQsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVCIpO2Uuc2VuZChudWxsKX19LHtrZXk6Il9zZXRSZXF1ZXN0SGVhZGVyIix2YWx1ZTpmdW5jdGlvbihhLGIsZCl7MD5jLl9jb25maWcuZGlzYWxsb3dlZFhockhlYWRlcnMuaW5kZXhPZihiLnRvTG93ZXJDYXNlKCkpJiZhLnNldFJlcXVlc3RIZWFkZXIoYixkKX19LHtrZXk6Il9oYXNSZXNwb25zZUhlYWRlciIsdmFsdWU6ZnVuY3Rpb24oYSxiKXthPWEuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7aWYoIWEpcmV0dXJuITE7YT1hLnNwbGl0KCJcclxuIik7Zm9yKHZhciBjPVtdLGQ9MDtkPGEubGVuZ3RoO2QrKyljW2RdPWFbZF0uc3BsaXQoIjoiKVswXS50b0xvd2VyQ2FzZSgpO3JldHVybiAwPD1jLmluZGV4T2YoYi50b0xvd2VyQ2FzZSgpKX19LHtrZXk6Il9nZXRSZXNwb25zZUhlYWRlciIsdmFsdWU6ZnVuY3Rpb24oYSwKYil7cmV0dXJuIHRoaXMuX2hhc1Jlc3BvbnNlSGVhZGVyKGEsYik/YS5nZXRSZXNwb25zZUhlYWRlcihiKTpudWxsfX0se2tleToiZ2V0Qnl0ZUF0Iix2YWx1ZTpmdW5jdGlvbihhKXtyZXR1cm4gdGhpcy5fZmlsZURhdGEuZ2V0Qnl0ZUF0KGEpLmNoYXJDb2RlQXQoMCkmMjU1fX0se2tleToiX2lzV2ViV29ya2VyIix2YWx1ZTpmdW5jdGlvbigpe3JldHVybiJ1bmRlZmluZWQiIT09dHlwZW9mIFdvcmtlckdsb2JhbFNjb3BlJiZzZWxmIGluc3RhbmNlb2YgV29ya2VyR2xvYmFsU2NvcGV9fSx7a2V5OiJfY3JlYXRlWEhST2JqZWN0Iix2YWx1ZTpmdW5jdGlvbigpe2lmKCJ1bmRlZmluZWQiPT09dHlwZW9mIHdpbmRvdyYmIXRoaXMuX2lzV2ViV29ya2VyKCkpcmV0dXJuIG5ldyAoZigieGhyMiIpLlhNTEh0dHBSZXF1ZXN0KTtpZigidW5kZWZpbmVkIiE9PXR5cGVvZiBYTUxIdHRwUmVxdWVzdClyZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0O3Rocm93IEVycm9yKCJYTUxIdHRwUmVxdWVzdCBpcyBub3Qgc3VwcG9ydGVkIik7Cn19XSxbe2tleToiY2FuUmVhZEZpbGUiLHZhbHVlOmZ1bmN0aW9uKGEpe3JldHVybiJzdHJpbmciPT09dHlwZW9mIGEmJi9eW2Etel0rOlwvXC8vaS50ZXN0KGEpfX0se2tleToic2V0Q29uZmlnIix2YWx1ZTpmdW5jdGlvbihhKXtmb3IodmFyIGIgaW4gYSlhLmhhc093blByb3BlcnR5KGIpJiYodGhpcy5fY29uZmlnW2JdPWFbYl0pO2E9dGhpcy5fY29uZmlnLmRpc2FsbG93ZWRYaHJIZWFkZXJzO2ZvcihiPTA7YjxhLmxlbmd0aDtiKyspYVtiXT1hW2JdLnRvTG93ZXJDYXNlKCl9fV0pO3JldHVybiBjfShmKCIuL01lZGlhRmlsZVJlYWRlciIpKTtxLl9jb25maWc9e2F2b2lkSGVhZFJlcXVlc3RzOiExLGRpc2FsbG93ZWRYaHJIZWFkZXJzOltdLHRpbWVvdXRJblNlYzozMH07cC5leHBvcnRzPXF9LHsiLi9DaHVua2VkRmlsZURhdGEiOjUsIi4vTWVkaWFGaWxlUmVhZGVyIjoxMSx4aHIyOjJ9XSwxNTpbZnVuY3Rpb24oZixwLHEpe2Z1bmN0aW9uIG0oYSxiKXtpZighKGEgaW5zdGFuY2VvZgpiKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTt9ZnVuY3Rpb24gbChhLGIpe3ZhciBjPTA+YS5vZmZzZXQmJigtYS5vZmZzZXQ+Ynx8MDxhLm9mZnNldCthLmxlbmd0aCk7cmV0dXJuISgwPD1hLm9mZnNldCYmYS5vZmZzZXQrYS5sZW5ndGg+PWJ8fGMpfXZhciBlPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gYShhLGIpe2Zvcih2YXIgYz0wO2M8Yi5sZW5ndGg7YysrKXt2YXIgZD1iW2NdO2QuZW51bWVyYWJsZT1kLmVudW1lcmFibGV8fCExO2QuY29uZmlndXJhYmxlPSEwOyJ2YWx1ZSJpbiBkJiYoZC53cml0YWJsZT0hMCk7T2JqZWN0LmRlZmluZVByb3BlcnR5KGEsZC5rZXksZCl9fXJldHVybiBmdW5jdGlvbihiLGMsZCl7YyYmYShiLnByb3RvdHlwZSxjKTtkJiZhKGIsZCk7cmV0dXJuIGJ9fSgpO2YoIi4vTWVkaWFGaWxlUmVhZGVyIik7cT1mKCIuL05vZGVGaWxlUmVhZGVyIik7dmFyIGQ9ZigiLi9YaHJGaWxlUmVhZGVyIiksYz0KZigiLi9CbG9iRmlsZVJlYWRlciIpLGE9ZigiLi9BcnJheUZpbGVSZWFkZXIiKTtmKCIuL01lZGlhVGFnUmVhZGVyIik7dmFyIGI9ZigiLi9JRDN2MVRhZ1JlYWRlciIpLGc9ZigiLi9JRDN2MlRhZ1JlYWRlciIpLGg9ZigiLi9NUDRUYWdSZWFkZXIiKTtmPWYoIi4vRkxBQ1RhZ1JlYWRlciIpO3ZhciBrPVtdLHI9W10sdT1mdW5jdGlvbigpe2Z1bmN0aW9uIGEoYil7bSh0aGlzLGEpO3RoaXMuX2ZpbGU9Yn1lKGEsW3trZXk6InNldFRhZ3NUb1JlYWQiLHZhbHVlOmZ1bmN0aW9uKGEpe3RoaXMuX3RhZ3NUb1JlYWQ9YTtyZXR1cm4gdGhpc319LHtrZXk6InNldEZpbGVSZWFkZXIiLHZhbHVlOmZ1bmN0aW9uKGEpe3RoaXMuX2ZpbGVSZWFkZXI9YTtyZXR1cm4gdGhpc319LHtrZXk6InNldFRhZ1JlYWRlciIsdmFsdWU6ZnVuY3Rpb24oYSl7dGhpcy5fdGFnUmVhZGVyPWE7cmV0dXJuIHRoaXN9fSx7a2V5OiJyZWFkIix2YWx1ZTpmdW5jdGlvbihhKXt2YXIgYj1uZXcgKHRoaXMuX2dldEZpbGVSZWFkZXIoKSkodGhpcy5fZmlsZSksCmM9dGhpcztiLmluaXQoe29uU3VjY2VzczpmdW5jdGlvbigpe2MuX2dldFRhZ1JlYWRlcihiLHtvblN1Y2Nlc3M6ZnVuY3Rpb24oZCl7KG5ldyBkKGIpKS5zZXRUYWdzVG9SZWFkKGMuX3RhZ3NUb1JlYWQpLnJlYWQoYSl9LG9uRXJyb3I6YS5vbkVycm9yfSl9LG9uRXJyb3I6YS5vbkVycm9yfSl9fSx7a2V5OiJfZ2V0RmlsZVJlYWRlciIsdmFsdWU6ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5fZmlsZVJlYWRlcj90aGlzLl9maWxlUmVhZGVyOnRoaXMuX2ZpbmRGaWxlUmVhZGVyKCl9fSx7a2V5OiJfZmluZEZpbGVSZWFkZXIiLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBhPTA7YTxrLmxlbmd0aDthKyspaWYoa1thXS5jYW5SZWFkRmlsZSh0aGlzLl9maWxlKSlyZXR1cm4ga1thXTt0aHJvdyBFcnJvcigiTm8gc3VpdGFibGUgZmlsZSByZWFkZXIgZm91bmQgZm9yICIrdGhpcy5fZmlsZSk7fX0se2tleToiX2dldFRhZ1JlYWRlciIsdmFsdWU6ZnVuY3Rpb24oYSxiKXtpZih0aGlzLl90YWdSZWFkZXIpe3ZhciBjPQp0aGlzLl90YWdSZWFkZXI7c2V0VGltZW91dChmdW5jdGlvbigpe2Iub25TdWNjZXNzKGMpfSwxKX1lbHNlIHRoaXMuX2ZpbmRUYWdSZWFkZXIoYSxiKX19LHtrZXk6Il9maW5kVGFnUmVhZGVyIix2YWx1ZTpmdW5jdGlvbihhLGIpe2Zvcih2YXIgYz1bXSxkPVtdLGU9YS5nZXRTaXplKCksZj0wO2Y8ci5sZW5ndGg7ZisrKXt2YXIgZz1yW2ZdLmdldFRhZ0lkZW50aWZpZXJCeXRlUmFuZ2UoKTtsKGcsZSkmJigwPD1nLm9mZnNldCYmZy5vZmZzZXQ8ZS8yfHwwPmcub2Zmc2V0JiZnLm9mZnNldDwtZS8yP2MucHVzaChyW2ZdKTpkLnB1c2gocltmXSkpfXZhciBoPSExO2Y9e29uU3VjY2VzczpmdW5jdGlvbigpe2lmKGgpe2Zvcih2YXIgYz0wO2M8ci5sZW5ndGg7YysrKXt2YXIgZD1yW2NdLmdldFRhZ0lkZW50aWZpZXJCeXRlUmFuZ2UoKTtpZihsKGQsZSkpe3RyeXt2YXIgZj1hLmdldEJ5dGVzQXQoMDw9ZC5vZmZzZXQ/ZC5vZmZzZXQ6ZC5vZmZzZXQrZSxkLmxlbmd0aCl9Y2F0Y2goQSl7aWYoYi5vbkVycm9yKWIub25FcnJvcih7dHlwZToiZmlsZVJlYWRlciIsCmluZm86QS5tZXNzYWdlfSk7cmV0dXJufWlmKHJbY10uY2FuUmVhZFRhZ0Zvcm1hdChmKSl7Yi5vblN1Y2Nlc3MocltjXSk7cmV0dXJufX19aWYoYi5vbkVycm9yKWIub25FcnJvcih7dHlwZToidGFnRm9ybWF0IixpbmZvOiJObyBzdWl0YWJsZSB0YWcgcmVhZGVyIGZvdW5kIn0pfWVsc2UgaD0hMH0sb25FcnJvcjpiLm9uRXJyb3J9O3RoaXMuX2xvYWRUYWdJZGVudGlmaWVyUmFuZ2VzKGEsYyxmKTt0aGlzLl9sb2FkVGFnSWRlbnRpZmllclJhbmdlcyhhLGQsZil9fSx7a2V5OiJfbG9hZFRhZ0lkZW50aWZpZXJSYW5nZXMiLHZhbHVlOmZ1bmN0aW9uKGEsYixjKXtpZigwPT09Yi5sZW5ndGgpc2V0VGltZW91dChjLm9uU3VjY2VzcywxKTtlbHNle2Zvcih2YXIgZD1bTnVtYmVyLk1BWF9WQUxVRSwwXSxlPWEuZ2V0U2l6ZSgpLGY9MDtmPGIubGVuZ3RoO2YrKyl7dmFyIGc9YltmXS5nZXRUYWdJZGVudGlmaWVyQnl0ZVJhbmdlKCksaD0wPD1nLm9mZnNldD9nLm9mZnNldDpnLm9mZnNldCsKZTtnPWgrZy5sZW5ndGgtMTtkWzBdPU1hdGgubWluKGgsZFswXSk7ZFsxXT1NYXRoLm1heChnLGRbMV0pfWEubG9hZFJhbmdlKGQsYyl9fX1dKTtyZXR1cm4gYX0oKSx2PWZ1bmN0aW9uKCl7ZnVuY3Rpb24gYSgpe20odGhpcyxhKX1lKGEsbnVsbCxbe2tleToiYWRkRmlsZVJlYWRlciIsdmFsdWU6ZnVuY3Rpb24oYil7ay5wdXNoKGIpO3JldHVybiBhfX0se2tleToiYWRkVGFnUmVhZGVyIix2YWx1ZTpmdW5jdGlvbihiKXtyLnB1c2goYik7cmV0dXJuIGF9fSx7a2V5OiJyZW1vdmVUYWdSZWFkZXIiLHZhbHVlOmZ1bmN0aW9uKGIpe2I9ci5pbmRleE9mKGIpOzA8PWImJnIuc3BsaWNlKGIsMSk7cmV0dXJuIGF9fSx7a2V5OiJFWFBFUklNRU5UQUxfYXZvaWRIZWFkUmVxdWVzdHMiLHZhbHVlOmZ1bmN0aW9uKCl7ZC5zZXRDb25maWcoe2F2b2lkSGVhZFJlcXVlc3RzOiEwfSl9fSx7a2V5OiJzZXREaXNhbGxvd2VkWGhySGVhZGVycyIsdmFsdWU6ZnVuY3Rpb24oYSl7ZC5zZXRDb25maWcoe2Rpc2FsbG93ZWRYaHJIZWFkZXJzOmF9KX19LAp7a2V5OiJzZXRYaHJUaW1lb3V0SW5TZWMiLHZhbHVlOmZ1bmN0aW9uKGEpe2Quc2V0Q29uZmlnKHt0aW1lb3V0SW5TZWM6YX0pfX1dKTtyZXR1cm4gYX0oKTt2LmFkZEZpbGVSZWFkZXIoZCkuYWRkRmlsZVJlYWRlcihjKS5hZGRGaWxlUmVhZGVyKGEpLmFkZFRhZ1JlYWRlcihnKS5hZGRUYWdSZWFkZXIoYikuYWRkVGFnUmVhZGVyKGgpLmFkZFRhZ1JlYWRlcihmKTsidW5kZWZpbmVkIj09PXR5cGVvZiBwcm9jZXNzfHxwcm9jZXNzLmJyb3dzZXJ8fHYuYWRkRmlsZVJlYWRlcihxKTtwLmV4cG9ydHM9e3JlYWQ6ZnVuY3Rpb24oYSxiKXsobmV3IHUoYSkpLnJlYWQoYil9LFJlYWRlcjp1LENvbmZpZzp2fX0seyIuL0FycmF5RmlsZVJlYWRlciI6MywiLi9CbG9iRmlsZVJlYWRlciI6NCwiLi9GTEFDVGFnUmVhZGVyIjo2LCIuL0lEM3YxVGFnUmVhZGVyIjo3LCIuL0lEM3YyVGFnUmVhZGVyIjo5LCIuL01QNFRhZ1JlYWRlciI6MTAsIi4vTWVkaWFGaWxlUmVhZGVyIjoxMSwiLi9NZWRpYVRhZ1JlYWRlciI6MTIsCiIuL05vZGVGaWxlUmVhZGVyIjoxLCIuL1hockZpbGVSZWFkZXIiOjE0fV19LHt9LFsxNV0pKDE1KX0pOwo="></script>
        <!--vuejs--><!--<script src="data:text/plain;base64,LyohCiAqIFZ1ZS5qcyB2Mi41LjIxCiAqIChjKSAyMDE0LTIwMTggRXZhbiBZb3UKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLgogKi8KIWZ1bmN0aW9uKGUsdCl7Im9iamVjdCI9PXR5cGVvZiBleHBvcnRzJiYidW5kZWZpbmVkIiE9dHlwZW9mIG1vZHVsZT9tb2R1bGUuZXhwb3J0cz10KCk6ImZ1bmN0aW9uIj09dHlwZW9mIGRlZmluZSYmZGVmaW5lLmFtZD9kZWZpbmUodCk6ZS5WdWU9dCgpfSh0aGlzLGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO3ZhciBlPU9iamVjdC5mcmVlemUoe30pO2Z1bmN0aW9uIHQoZSl7cmV0dXJuIG51bGw9PWV9ZnVuY3Rpb24gbihlKXtyZXR1cm4gbnVsbCE9ZX1mdW5jdGlvbiByKGUpe3JldHVybiEwPT09ZX1mdW5jdGlvbiBpKGUpe3JldHVybiJzdHJpbmciPT10eXBlb2YgZXx8Im51bWJlciI9PXR5cGVvZiBlfHwic3ltYm9sIj09dHlwZW9mIGV8fCJib29sZWFuIj09dHlwZW9mIGV9ZnVuY3Rpb24gbyhlKXtyZXR1cm4gbnVsbCE9PWUmJiJvYmplY3QiPT10eXBlb2YgZX12YXIgYT1PYmplY3QucHJvdG90eXBlLnRvU3RyaW5nO2Z1bmN0aW9uIHMoZSl7cmV0dXJuIltvYmplY3QgT2JqZWN0XSI9PT1hLmNhbGwoZSl9ZnVuY3Rpb24gYyhlKXt2YXIgdD1wYXJzZUZsb2F0KFN0cmluZyhlKSk7cmV0dXJuIHQ+PTAmJk1hdGguZmxvb3IodCk9PT10JiZpc0Zpbml0ZShlKX1mdW5jdGlvbiB1KGUpe3JldHVybiBudWxsPT1lPyIiOiJvYmplY3QiPT10eXBlb2YgZT9KU09OLnN0cmluZ2lmeShlLG51bGwsMik6U3RyaW5nKGUpfWZ1bmN0aW9uIGwoZSl7dmFyIHQ9cGFyc2VGbG9hdChlKTtyZXR1cm4gaXNOYU4odCk/ZTp0fWZ1bmN0aW9uIGYoZSx0KXtmb3IodmFyIG49T2JqZWN0LmNyZWF0ZShudWxsKSxyPWUuc3BsaXQoIiwiKSxpPTA7aTxyLmxlbmd0aDtpKyspbltyW2ldXT0hMDtyZXR1cm4gdD9mdW5jdGlvbihlKXtyZXR1cm4gbltlLnRvTG93ZXJDYXNlKCldfTpmdW5jdGlvbihlKXtyZXR1cm4gbltlXX19dmFyIHA9Zigic2xvdCxjb21wb25lbnQiLCEwKSxkPWYoImtleSxyZWYsc2xvdCxzbG90LXNjb3BlLGlzIik7ZnVuY3Rpb24gdihlLHQpe2lmKGUubGVuZ3RoKXt2YXIgbj1lLmluZGV4T2YodCk7aWYobj4tMSlyZXR1cm4gZS5zcGxpY2UobiwxKX19dmFyIGg9T2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTtmdW5jdGlvbiBtKGUsdCl7cmV0dXJuIGguY2FsbChlLHQpfWZ1bmN0aW9uIHkoZSl7dmFyIHQ9T2JqZWN0LmNyZWF0ZShudWxsKTtyZXR1cm4gZnVuY3Rpb24obil7cmV0dXJuIHRbbl18fCh0W25dPWUobikpfX12YXIgZz0vLShcdykvZyxfPXkoZnVuY3Rpb24oZSl7cmV0dXJuIGUucmVwbGFjZShnLGZ1bmN0aW9uKGUsdCl7cmV0dXJuIHQ/dC50b1VwcGVyQ2FzZSgpOiIifSl9KSxiPXkoZnVuY3Rpb24oZSl7cmV0dXJuIGUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkrZS5zbGljZSgxKX0pLCQ9L1xCKFtBLVpdKS9nLHc9eShmdW5jdGlvbihlKXtyZXR1cm4gZS5yZXBsYWNlKCQsIi0kMSIpLnRvTG93ZXJDYXNlKCl9KTt2YXIgQz1GdW5jdGlvbi5wcm90b3R5cGUuYmluZD9mdW5jdGlvbihlLHQpe3JldHVybiBlLmJpbmQodCl9OmZ1bmN0aW9uKGUsdCl7ZnVuY3Rpb24gbihuKXt2YXIgcj1hcmd1bWVudHMubGVuZ3RoO3JldHVybiByP3I+MT9lLmFwcGx5KHQsYXJndW1lbnRzKTplLmNhbGwodCxuKTplLmNhbGwodCl9cmV0dXJuIG4uX2xlbmd0aD1lLmxlbmd0aCxufTtmdW5jdGlvbiB4KGUsdCl7dD10fHwwO2Zvcih2YXIgbj1lLmxlbmd0aC10LHI9bmV3IEFycmF5KG4pO24tLTspcltuXT1lW24rdF07cmV0dXJuIHJ9ZnVuY3Rpb24gayhlLHQpe2Zvcih2YXIgbiBpbiB0KWVbbl09dFtuXTtyZXR1cm4gZX1mdW5jdGlvbiBBKGUpe2Zvcih2YXIgdD17fSxuPTA7bjxlLmxlbmd0aDtuKyspZVtuXSYmayh0LGVbbl0pO3JldHVybiB0fWZ1bmN0aW9uIE8oZSx0LG4pe312YXIgUz1mdW5jdGlvbihlLHQsbil7cmV0dXJuITF9LFQ9ZnVuY3Rpb24oZSl7cmV0dXJuIGV9O2Z1bmN0aW9uIE4oZSx0KXtpZihlPT09dClyZXR1cm4hMDt2YXIgbj1vKGUpLHI9byh0KTtpZighbnx8IXIpcmV0dXJuIW4mJiFyJiZTdHJpbmcoZSk9PT1TdHJpbmcodCk7dHJ5e3ZhciBpPUFycmF5LmlzQXJyYXkoZSksYT1BcnJheS5pc0FycmF5KHQpO2lmKGkmJmEpcmV0dXJuIGUubGVuZ3RoPT09dC5sZW5ndGgmJmUuZXZlcnkoZnVuY3Rpb24oZSxuKXtyZXR1cm4gTihlLHRbbl0pfSk7aWYoZSBpbnN0YW5jZW9mIERhdGUmJnQgaW5zdGFuY2VvZiBEYXRlKXJldHVybiBlLmdldFRpbWUoKT09PXQuZ2V0VGltZSgpO2lmKGl8fGEpcmV0dXJuITE7dmFyIHM9T2JqZWN0LmtleXMoZSksYz1PYmplY3Qua2V5cyh0KTtyZXR1cm4gcy5sZW5ndGg9PT1jLmxlbmd0aCYmcy5ldmVyeShmdW5jdGlvbihuKXtyZXR1cm4gTihlW25dLHRbbl0pfSl9Y2F0Y2goZSl7cmV0dXJuITF9fWZ1bmN0aW9uIGooZSx0KXtmb3IodmFyIG49MDtuPGUubGVuZ3RoO24rKylpZihOKGVbbl0sdCkpcmV0dXJuIG47cmV0dXJuLTF9ZnVuY3Rpb24gRShlKXt2YXIgdD0hMTtyZXR1cm4gZnVuY3Rpb24oKXt0fHwodD0hMCxlLmFwcGx5KHRoaXMsYXJndW1lbnRzKSl9fXZhciBJPSJkYXRhLXNlcnZlci1yZW5kZXJlZCIsTD1bImNvbXBvbmVudCIsImRpcmVjdGl2ZSIsImZpbHRlciJdLE09WyJiZWZvcmVDcmVhdGUiLCJjcmVhdGVkIiwiYmVmb3JlTW91bnQiLCJtb3VudGVkIiwiYmVmb3JlVXBkYXRlIiwidXBkYXRlZCIsImJlZm9yZURlc3Ryb3kiLCJkZXN0cm95ZWQiLCJhY3RpdmF0ZWQiLCJkZWFjdGl2YXRlZCIsImVycm9yQ2FwdHVyZWQiXSxEPXtvcHRpb25NZXJnZVN0cmF0ZWdpZXM6T2JqZWN0LmNyZWF0ZShudWxsKSxzaWxlbnQ6ITEscHJvZHVjdGlvblRpcDohMSxkZXZ0b29sczohMSxwZXJmb3JtYW5jZTohMSxlcnJvckhhbmRsZXI6bnVsbCx3YXJuSGFuZGxlcjpudWxsLGlnbm9yZWRFbGVtZW50czpbXSxrZXlDb2RlczpPYmplY3QuY3JlYXRlKG51bGwpLGlzUmVzZXJ2ZWRUYWc6Uyxpc1Jlc2VydmVkQXR0cjpTLGlzVW5rbm93bkVsZW1lbnQ6UyxnZXRUYWdOYW1lc3BhY2U6TyxwYXJzZVBsYXRmb3JtVGFnTmFtZTpULG11c3RVc2VQcm9wOlMsYXN5bmM6ITAsX2xpZmVjeWNsZUhvb2tzOk19O2Z1bmN0aW9uIFAoZSx0LG4scil7T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsdCx7dmFsdWU6bixlbnVtZXJhYmxlOiEhcix3cml0YWJsZTohMCxjb25maWd1cmFibGU6ITB9KX12YXIgRj0vW15cdy4kXS87dmFyIFIsSD0iX19wcm90b19fImlue30sQj0idW5kZWZpbmVkIiE9dHlwZW9mIHdpbmRvdyxVPSJ1bmRlZmluZWQiIT10eXBlb2YgV1hFbnZpcm9ubWVudCYmISFXWEVudmlyb25tZW50LnBsYXRmb3JtLFY9VSYmV1hFbnZpcm9ubWVudC5wbGF0Zm9ybS50b0xvd2VyQ2FzZSgpLHo9QiYmd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSxLPXomJi9tc2llfHRyaWRlbnQvLnRlc3QoeiksSj16JiZ6LmluZGV4T2YoIm1zaWUgOS4wIik+MCxxPXomJnouaW5kZXhPZigiZWRnZS8iKT4wLFc9KHomJnouaW5kZXhPZigiYW5kcm9pZCIpLHomJi9pcGhvbmV8aXBhZHxpcG9kfGlvcy8udGVzdCh6KXx8ImlvcyI9PT1WKSxHPSh6JiYvY2hyb21lXC9cZCsvLnRlc3Qoeikse30ud2F0Y2gpLFo9ITE7aWYoQil0cnl7dmFyIFg9e307T2JqZWN0LmRlZmluZVByb3BlcnR5KFgsInBhc3NpdmUiLHtnZXQ6ZnVuY3Rpb24oKXtaPSEwfX0pLHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0LXBhc3NpdmUiLG51bGwsWCl9Y2F0Y2goZSl7fXZhciBZPWZ1bmN0aW9uKCl7cmV0dXJuIHZvaWQgMD09PVImJihSPSFCJiYhVSYmInVuZGVmaW5lZCIhPXR5cGVvZiBnbG9iYWwmJihnbG9iYWwucHJvY2VzcyYmInNlcnZlciI9PT1nbG9iYWwucHJvY2Vzcy5lbnYuVlVFX0VOVikpLFJ9LFE9QiYmd2luZG93Ll9fVlVFX0RFVlRPT0xTX0dMT0JBTF9IT09LX187ZnVuY3Rpb24gZWUoZSl7cmV0dXJuImZ1bmN0aW9uIj09dHlwZW9mIGUmJi9uYXRpdmUgY29kZS8udGVzdChlLnRvU3RyaW5nKCkpfXZhciB0ZSxuZT0idW5kZWZpbmVkIiE9dHlwZW9mIFN5bWJvbCYmZWUoU3ltYm9sKSYmInVuZGVmaW5lZCIhPXR5cGVvZiBSZWZsZWN0JiZlZShSZWZsZWN0Lm93bktleXMpO3RlPSJ1bmRlZmluZWQiIT10eXBlb2YgU2V0JiZlZShTZXQpP1NldDpmdW5jdGlvbigpe2Z1bmN0aW9uIGUoKXt0aGlzLnNldD1PYmplY3QuY3JlYXRlKG51bGwpfXJldHVybiBlLnByb3RvdHlwZS5oYXM9ZnVuY3Rpb24oZSl7cmV0dXJuITA9PT10aGlzLnNldFtlXX0sZS5wcm90b3R5cGUuYWRkPWZ1bmN0aW9uKGUpe3RoaXMuc2V0W2VdPSEwfSxlLnByb3RvdHlwZS5jbGVhcj1mdW5jdGlvbigpe3RoaXMuc2V0PU9iamVjdC5jcmVhdGUobnVsbCl9LGV9KCk7dmFyIHJlPU8saWU9MCxvZT1mdW5jdGlvbigpe3RoaXMuaWQ9aWUrKyx0aGlzLnN1YnM9W119O29lLnByb3RvdHlwZS5hZGRTdWI9ZnVuY3Rpb24oZSl7dGhpcy5zdWJzLnB1c2goZSl9LG9lLnByb3RvdHlwZS5yZW1vdmVTdWI9ZnVuY3Rpb24oZSl7dih0aGlzLnN1YnMsZSl9LG9lLnByb3RvdHlwZS5kZXBlbmQ9ZnVuY3Rpb24oKXtvZS50YXJnZXQmJm9lLnRhcmdldC5hZGREZXAodGhpcyl9LG9lLnByb3RvdHlwZS5ub3RpZnk9ZnVuY3Rpb24oKXtmb3IodmFyIGU9dGhpcy5zdWJzLnNsaWNlKCksdD0wLG49ZS5sZW5ndGg7dDxuO3QrKyllW3RdLnVwZGF0ZSgpfSxvZS50YXJnZXQ9bnVsbDt2YXIgYWU9W107ZnVuY3Rpb24gc2UoZSl7YWUucHVzaChlKSxvZS50YXJnZXQ9ZX1mdW5jdGlvbiBjZSgpe2FlLnBvcCgpLG9lLnRhcmdldD1hZVthZS5sZW5ndGgtMV19dmFyIHVlPWZ1bmN0aW9uKGUsdCxuLHIsaSxvLGEscyl7dGhpcy50YWc9ZSx0aGlzLmRhdGE9dCx0aGlzLmNoaWxkcmVuPW4sdGhpcy50ZXh0PXIsdGhpcy5lbG09aSx0aGlzLm5zPXZvaWQgMCx0aGlzLmNvbnRleHQ9byx0aGlzLmZuQ29udGV4dD12b2lkIDAsdGhpcy5mbk9wdGlvbnM9dm9pZCAwLHRoaXMuZm5TY29wZUlkPXZvaWQgMCx0aGlzLmtleT10JiZ0LmtleSx0aGlzLmNvbXBvbmVudE9wdGlvbnM9YSx0aGlzLmNvbXBvbmVudEluc3RhbmNlPXZvaWQgMCx0aGlzLnBhcmVudD12b2lkIDAsdGhpcy5yYXc9ITEsdGhpcy5pc1N0YXRpYz0hMSx0aGlzLmlzUm9vdEluc2VydD0hMCx0aGlzLmlzQ29tbWVudD0hMSx0aGlzLmlzQ2xvbmVkPSExLHRoaXMuaXNPbmNlPSExLHRoaXMuYXN5bmNGYWN0b3J5PXMsdGhpcy5hc3luY01ldGE9dm9pZCAwLHRoaXMuaXNBc3luY1BsYWNlaG9sZGVyPSExfSxsZT17Y2hpbGQ6e2NvbmZpZ3VyYWJsZTohMH19O2xlLmNoaWxkLmdldD1mdW5jdGlvbigpe3JldHVybiB0aGlzLmNvbXBvbmVudEluc3RhbmNlfSxPYmplY3QuZGVmaW5lUHJvcGVydGllcyh1ZS5wcm90b3R5cGUsbGUpO3ZhciBmZT1mdW5jdGlvbihlKXt2b2lkIDA9PT1lJiYoZT0iIik7dmFyIHQ9bmV3IHVlO3JldHVybiB0LnRleHQ9ZSx0LmlzQ29tbWVudD0hMCx0fTtmdW5jdGlvbiBwZShlKXtyZXR1cm4gbmV3IHVlKHZvaWQgMCx2b2lkIDAsdm9pZCAwLFN0cmluZyhlKSl9ZnVuY3Rpb24gZGUoZSl7dmFyIHQ9bmV3IHVlKGUudGFnLGUuZGF0YSxlLmNoaWxkcmVuJiZlLmNoaWxkcmVuLnNsaWNlKCksZS50ZXh0LGUuZWxtLGUuY29udGV4dCxlLmNvbXBvbmVudE9wdGlvbnMsZS5hc3luY0ZhY3RvcnkpO3JldHVybiB0Lm5zPWUubnMsdC5pc1N0YXRpYz1lLmlzU3RhdGljLHQua2V5PWUua2V5LHQuaXNDb21tZW50PWUuaXNDb21tZW50LHQuZm5Db250ZXh0PWUuZm5Db250ZXh0LHQuZm5PcHRpb25zPWUuZm5PcHRpb25zLHQuZm5TY29wZUlkPWUuZm5TY29wZUlkLHQuYXN5bmNNZXRhPWUuYXN5bmNNZXRhLHQuaXNDbG9uZWQ9ITAsdH12YXIgdmU9QXJyYXkucHJvdG90eXBlLGhlPU9iamVjdC5jcmVhdGUodmUpO1sicHVzaCIsInBvcCIsInNoaWZ0IiwidW5zaGlmdCIsInNwbGljZSIsInNvcnQiLCJyZXZlcnNlIl0uZm9yRWFjaChmdW5jdGlvbihlKXt2YXIgdD12ZVtlXTtQKGhlLGUsZnVuY3Rpb24oKXtmb3IodmFyIG49W10scj1hcmd1bWVudHMubGVuZ3RoO3ItLTspbltyXT1hcmd1bWVudHNbcl07dmFyIGksbz10LmFwcGx5KHRoaXMsbiksYT10aGlzLl9fb2JfXztzd2l0Y2goZSl7Y2FzZSJwdXNoIjpjYXNlInVuc2hpZnQiOmk9bjticmVhaztjYXNlInNwbGljZSI6aT1uLnNsaWNlKDIpfXJldHVybiBpJiZhLm9ic2VydmVBcnJheShpKSxhLmRlcC5ub3RpZnkoKSxvfSl9KTt2YXIgbWU9T2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoaGUpLHllPSEwO2Z1bmN0aW9uIGdlKGUpe3llPWV9dmFyIF9lPWZ1bmN0aW9uKGUpe3ZhciB0O3RoaXMudmFsdWU9ZSx0aGlzLmRlcD1uZXcgb2UsdGhpcy52bUNvdW50PTAsUChlLCJfX29iX18iLHRoaXMpLEFycmF5LmlzQXJyYXkoZSk/KEg/KHQ9aGUsZS5fX3Byb3RvX189dCk6ZnVuY3Rpb24oZSx0LG4pe2Zvcih2YXIgcj0wLGk9bi5sZW5ndGg7cjxpO3IrKyl7dmFyIG89bltyXTtQKGUsbyx0W29dKX19KGUsaGUsbWUpLHRoaXMub2JzZXJ2ZUFycmF5KGUpKTp0aGlzLndhbGsoZSl9O2Z1bmN0aW9uIGJlKGUsdCl7dmFyIG47aWYobyhlKSYmIShlIGluc3RhbmNlb2YgdWUpKXJldHVybiBtKGUsIl9fb2JfXyIpJiZlLl9fb2JfXyBpbnN0YW5jZW9mIF9lP249ZS5fX29iX186eWUmJiFZKCkmJihBcnJheS5pc0FycmF5KGUpfHxzKGUpKSYmT2JqZWN0LmlzRXh0ZW5zaWJsZShlKSYmIWUuX2lzVnVlJiYobj1uZXcgX2UoZSkpLHQmJm4mJm4udm1Db3VudCsrLG59ZnVuY3Rpb24gJGUoZSx0LG4scixpKXt2YXIgbz1uZXcgb2UsYT1PYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsdCk7aWYoIWF8fCExIT09YS5jb25maWd1cmFibGUpe3ZhciBzPWEmJmEuZ2V0LGM9YSYmYS5zZXQ7cyYmIWN8fDIhPT1hcmd1bWVudHMubGVuZ3RofHwobj1lW3RdKTt2YXIgdT0haSYmYmUobik7T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsdCx7ZW51bWVyYWJsZTohMCxjb25maWd1cmFibGU6ITAsZ2V0OmZ1bmN0aW9uKCl7dmFyIHQ9cz9zLmNhbGwoZSk6bjtyZXR1cm4gb2UudGFyZ2V0JiYoby5kZXBlbmQoKSx1JiYodS5kZXAuZGVwZW5kKCksQXJyYXkuaXNBcnJheSh0KSYmZnVuY3Rpb24gZSh0KXtmb3IodmFyIG49dm9pZCAwLHI9MCxpPXQubGVuZ3RoO3I8aTtyKyspKG49dFtyXSkmJm4uX19vYl9fJiZuLl9fb2JfXy5kZXAuZGVwZW5kKCksQXJyYXkuaXNBcnJheShuKSYmZShuKX0odCkpKSx0fSxzZXQ6ZnVuY3Rpb24odCl7dmFyIHI9cz9zLmNhbGwoZSk6bjt0PT09cnx8dCE9dCYmciE9cnx8cyYmIWN8fChjP2MuY2FsbChlLHQpOm49dCx1PSFpJiZiZSh0KSxvLm5vdGlmeSgpKX19KX19ZnVuY3Rpb24gd2UoZSx0LG4pe2lmKEFycmF5LmlzQXJyYXkoZSkmJmModCkpcmV0dXJuIGUubGVuZ3RoPU1hdGgubWF4KGUubGVuZ3RoLHQpLGUuc3BsaWNlKHQsMSxuKSxuO2lmKHQgaW4gZSYmISh0IGluIE9iamVjdC5wcm90b3R5cGUpKXJldHVybiBlW3RdPW4sbjt2YXIgcj1lLl9fb2JfXztyZXR1cm4gZS5faXNWdWV8fHImJnIudm1Db3VudD9uOnI/KCRlKHIudmFsdWUsdCxuKSxyLmRlcC5ub3RpZnkoKSxuKTooZVt0XT1uLG4pfWZ1bmN0aW9uIENlKGUsdCl7aWYoQXJyYXkuaXNBcnJheShlKSYmYyh0KSllLnNwbGljZSh0LDEpO2Vsc2V7dmFyIG49ZS5fX29iX187ZS5faXNWdWV8fG4mJm4udm1Db3VudHx8bShlLHQpJiYoZGVsZXRlIGVbdF0sbiYmbi5kZXAubm90aWZ5KCkpfX1fZS5wcm90b3R5cGUud2Fsaz1mdW5jdGlvbihlKXtmb3IodmFyIHQ9T2JqZWN0LmtleXMoZSksbj0wO248dC5sZW5ndGg7bisrKSRlKGUsdFtuXSl9LF9lLnByb3RvdHlwZS5vYnNlcnZlQXJyYXk9ZnVuY3Rpb24oZSl7Zm9yKHZhciB0PTAsbj1lLmxlbmd0aDt0PG47dCsrKWJlKGVbdF0pfTt2YXIgeGU9RC5vcHRpb25NZXJnZVN0cmF0ZWdpZXM7ZnVuY3Rpb24ga2UoZSx0KXtpZighdClyZXR1cm4gZTtmb3IodmFyIG4scixpLG89T2JqZWN0LmtleXModCksYT0wO2E8by5sZW5ndGg7YSsrKXI9ZVtuPW9bYV1dLGk9dFtuXSxtKGUsbik/ciE9PWkmJnMocikmJnMoaSkmJmtlKHIsaSk6d2UoZSxuLGkpO3JldHVybiBlfWZ1bmN0aW9uIEFlKGUsdCxuKXtyZXR1cm4gbj9mdW5jdGlvbigpe3ZhciByPSJmdW5jdGlvbiI9PXR5cGVvZiB0P3QuY2FsbChuLG4pOnQsaT0iZnVuY3Rpb24iPT10eXBlb2YgZT9lLmNhbGwobixuKTplO3JldHVybiByP2tlKHIsaSk6aX06dD9lP2Z1bmN0aW9uKCl7cmV0dXJuIGtlKCJmdW5jdGlvbiI9PXR5cGVvZiB0P3QuY2FsbCh0aGlzLHRoaXMpOnQsImZ1bmN0aW9uIj09dHlwZW9mIGU/ZS5jYWxsKHRoaXMsdGhpcyk6ZSl9OnQ6ZX1mdW5jdGlvbiBPZShlLHQpe3JldHVybiB0P2U/ZS5jb25jYXQodCk6QXJyYXkuaXNBcnJheSh0KT90Olt0XTplfWZ1bmN0aW9uIFNlKGUsdCxuLHIpe3ZhciBpPU9iamVjdC5jcmVhdGUoZXx8bnVsbCk7cmV0dXJuIHQ/ayhpLHQpOml9eGUuZGF0YT1mdW5jdGlvbihlLHQsbil7cmV0dXJuIG4/QWUoZSx0LG4pOnQmJiJmdW5jdGlvbiIhPXR5cGVvZiB0P2U6QWUoZSx0KX0sTS5mb3JFYWNoKGZ1bmN0aW9uKGUpe3hlW2VdPU9lfSksTC5mb3JFYWNoKGZ1bmN0aW9uKGUpe3hlW2UrInMiXT1TZX0pLHhlLndhdGNoPWZ1bmN0aW9uKGUsdCxuLHIpe2lmKGU9PT1HJiYoZT12b2lkIDApLHQ9PT1HJiYodD12b2lkIDApLCF0KXJldHVybiBPYmplY3QuY3JlYXRlKGV8fG51bGwpO2lmKCFlKXJldHVybiB0O3ZhciBpPXt9O2Zvcih2YXIgbyBpbiBrKGksZSksdCl7dmFyIGE9aVtvXSxzPXRbb107YSYmIUFycmF5LmlzQXJyYXkoYSkmJihhPVthXSksaVtvXT1hP2EuY29uY2F0KHMpOkFycmF5LmlzQXJyYXkocyk/czpbc119cmV0dXJuIGl9LHhlLnByb3BzPXhlLm1ldGhvZHM9eGUuaW5qZWN0PXhlLmNvbXB1dGVkPWZ1bmN0aW9uKGUsdCxuLHIpe2lmKCFlKXJldHVybiB0O3ZhciBpPU9iamVjdC5jcmVhdGUobnVsbCk7cmV0dXJuIGsoaSxlKSx0JiZrKGksdCksaX0seGUucHJvdmlkZT1BZTt2YXIgVGU9ZnVuY3Rpb24oZSx0KXtyZXR1cm4gdm9pZCAwPT09dD9lOnR9O2Z1bmN0aW9uIE5lKGUsdCxuKXtpZigiZnVuY3Rpb24iPT10eXBlb2YgdCYmKHQ9dC5vcHRpb25zKSxmdW5jdGlvbihlLHQpe3ZhciBuPWUucHJvcHM7aWYobil7dmFyIHIsaSxvPXt9O2lmKEFycmF5LmlzQXJyYXkobikpZm9yKHI9bi5sZW5ndGg7ci0tOykic3RyaW5nIj09dHlwZW9mKGk9bltyXSkmJihvW18oaSldPXt0eXBlOm51bGx9KTtlbHNlIGlmKHMobikpZm9yKHZhciBhIGluIG4paT1uW2FdLG9bXyhhKV09cyhpKT9pOnt0eXBlOml9O2UucHJvcHM9b319KHQpLGZ1bmN0aW9uKGUsdCl7dmFyIG49ZS5pbmplY3Q7aWYobil7dmFyIHI9ZS5pbmplY3Q9e307aWYoQXJyYXkuaXNBcnJheShuKSlmb3IodmFyIGk9MDtpPG4ubGVuZ3RoO2krKylyW25baV1dPXtmcm9tOm5baV19O2Vsc2UgaWYocyhuKSlmb3IodmFyIG8gaW4gbil7dmFyIGE9bltvXTtyW29dPXMoYSk/ayh7ZnJvbTpvfSxhKTp7ZnJvbTphfX19fSh0KSxmdW5jdGlvbihlKXt2YXIgdD1lLmRpcmVjdGl2ZXM7aWYodClmb3IodmFyIG4gaW4gdCl7dmFyIHI9dFtuXTsiZnVuY3Rpb24iPT10eXBlb2YgciYmKHRbbl09e2JpbmQ6cix1cGRhdGU6cn0pfX0odCksIXQuX2Jhc2UmJih0LmV4dGVuZHMmJihlPU5lKGUsdC5leHRlbmRzLG4pKSx0Lm1peGlucykpZm9yKHZhciByPTAsaT10Lm1peGlucy5sZW5ndGg7cjxpO3IrKyllPU5lKGUsdC5taXhpbnNbcl0sbik7dmFyIG8sYT17fTtmb3IobyBpbiBlKWMobyk7Zm9yKG8gaW4gdCltKGUsbyl8fGMobyk7ZnVuY3Rpb24gYyhyKXt2YXIgaT14ZVtyXXx8VGU7YVtyXT1pKGVbcl0sdFtyXSxuLHIpfXJldHVybiBhfWZ1bmN0aW9uIGplKGUsdCxuLHIpe2lmKCJzdHJpbmciPT10eXBlb2Ygbil7dmFyIGk9ZVt0XTtpZihtKGksbikpcmV0dXJuIGlbbl07dmFyIG89XyhuKTtpZihtKGksbykpcmV0dXJuIGlbb107dmFyIGE9YihvKTtyZXR1cm4gbShpLGEpP2lbYV06aVtuXXx8aVtvXXx8aVthXX19ZnVuY3Rpb24gRWUoZSx0LG4scil7dmFyIGk9dFtlXSxvPSFtKG4sZSksYT1uW2VdLHM9TWUoQm9vbGVhbixpLnR5cGUpO2lmKHM+LTEpaWYobyYmIW0oaSwiZGVmYXVsdCIpKWE9ITE7ZWxzZSBpZigiIj09PWF8fGE9PT13KGUpKXt2YXIgYz1NZShTdHJpbmcsaS50eXBlKTsoYzwwfHxzPGMpJiYoYT0hMCl9aWYodm9pZCAwPT09YSl7YT1mdW5jdGlvbihlLHQsbil7aWYoIW0odCwiZGVmYXVsdCIpKXJldHVybjt2YXIgcj10LmRlZmF1bHQ7aWYoZSYmZS4kb3B0aW9ucy5wcm9wc0RhdGEmJnZvaWQgMD09PWUuJG9wdGlvbnMucHJvcHNEYXRhW25dJiZ2b2lkIDAhPT1lLl9wcm9wc1tuXSlyZXR1cm4gZS5fcHJvcHNbbl07cmV0dXJuImZ1bmN0aW9uIj09dHlwZW9mIHImJiJGdW5jdGlvbiIhPT1JZSh0LnR5cGUpP3IuY2FsbChlKTpyfShyLGksZSk7dmFyIHU9eWU7Z2UoITApLGJlKGEpLGdlKHUpfXJldHVybiBhfWZ1bmN0aW9uIEllKGUpe3ZhciB0PWUmJmUudG9TdHJpbmcoKS5tYXRjaCgvXlxzKmZ1bmN0aW9uIChcdyspLyk7cmV0dXJuIHQ/dFsxXToiIn1mdW5jdGlvbiBMZShlLHQpe3JldHVybiBJZShlKT09PUllKHQpfWZ1bmN0aW9uIE1lKGUsdCl7aWYoIUFycmF5LmlzQXJyYXkodCkpcmV0dXJuIExlKHQsZSk/MDotMTtmb3IodmFyIG49MCxyPXQubGVuZ3RoO248cjtuKyspaWYoTGUodFtuXSxlKSlyZXR1cm4gbjtyZXR1cm4tMX1mdW5jdGlvbiBEZShlLHQsbil7aWYodClmb3IodmFyIHI9dDtyPXIuJHBhcmVudDspe3ZhciBpPXIuJG9wdGlvbnMuZXJyb3JDYXB0dXJlZDtpZihpKWZvcih2YXIgbz0wO288aS5sZW5ndGg7bysrKXRyeXtpZighMT09PWlbb10uY2FsbChyLGUsdCxuKSlyZXR1cm59Y2F0Y2goZSl7UGUoZSxyLCJlcnJvckNhcHR1cmVkIGhvb2siKX19UGUoZSx0LG4pfWZ1bmN0aW9uIFBlKGUsdCxuKXtpZihELmVycm9ySGFuZGxlcil0cnl7cmV0dXJuIEQuZXJyb3JIYW5kbGVyLmNhbGwobnVsbCxlLHQsbil9Y2F0Y2goZSl7RmUoZSxudWxsLCJjb25maWcuZXJyb3JIYW5kbGVyIil9RmUoZSx0LG4pfWZ1bmN0aW9uIEZlKGUsdCxuKXtpZighQiYmIVV8fCJ1bmRlZmluZWQiPT10eXBlb2YgY29uc29sZSl0aHJvdyBlO2NvbnNvbGUuZXJyb3IoZSl9dmFyIFJlLEhlLEJlPVtdLFVlPSExO2Z1bmN0aW9uIFZlKCl7VWU9ITE7dmFyIGU9QmUuc2xpY2UoMCk7QmUubGVuZ3RoPTA7Zm9yKHZhciB0PTA7dDxlLmxlbmd0aDt0KyspZVt0XSgpfXZhciB6ZT0hMTtpZigidW5kZWZpbmVkIiE9dHlwZW9mIHNldEltbWVkaWF0ZSYmZWUoc2V0SW1tZWRpYXRlKSlIZT1mdW5jdGlvbigpe3NldEltbWVkaWF0ZShWZSl9O2Vsc2UgaWYoInVuZGVmaW5lZCI9PXR5cGVvZiBNZXNzYWdlQ2hhbm5lbHx8IWVlKE1lc3NhZ2VDaGFubmVsKSYmIltvYmplY3QgTWVzc2FnZUNoYW5uZWxDb25zdHJ1Y3Rvcl0iIT09TWVzc2FnZUNoYW5uZWwudG9TdHJpbmcoKSlIZT1mdW5jdGlvbigpe3NldFRpbWVvdXQoVmUsMCl9O2Vsc2V7dmFyIEtlPW5ldyBNZXNzYWdlQ2hhbm5lbCxKZT1LZS5wb3J0MjtLZS5wb3J0MS5vbm1lc3NhZ2U9VmUsSGU9ZnVuY3Rpb24oKXtKZS5wb3N0TWVzc2FnZSgxKX19aWYoInVuZGVmaW5lZCIhPXR5cGVvZiBQcm9taXNlJiZlZShQcm9taXNlKSl7dmFyIHFlPVByb21pc2UucmVzb2x2ZSgpO1JlPWZ1bmN0aW9uKCl7cWUudGhlbihWZSksVyYmc2V0VGltZW91dChPKX19ZWxzZSBSZT1IZTtmdW5jdGlvbiBXZShlLHQpe3ZhciBuO2lmKEJlLnB1c2goZnVuY3Rpb24oKXtpZihlKXRyeXtlLmNhbGwodCl9Y2F0Y2goZSl7RGUoZSx0LCJuZXh0VGljayIpfWVsc2UgbiYmbih0KX0pLFVlfHwoVWU9ITAsemU/SGUoKTpSZSgpKSwhZSYmInVuZGVmaW5lZCIhPXR5cGVvZiBQcm9taXNlKXJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihlKXtuPWV9KX12YXIgR2U9bmV3IHRlO2Z1bmN0aW9uIFplKGUpeyFmdW5jdGlvbiBlKHQsbil7dmFyIHIsaTt2YXIgYT1BcnJheS5pc0FycmF5KHQpO2lmKCFhJiYhbyh0KXx8T2JqZWN0LmlzRnJvemVuKHQpfHx0IGluc3RhbmNlb2YgdWUpcmV0dXJuO2lmKHQuX19vYl9fKXt2YXIgcz10Ll9fb2JfXy5kZXAuaWQ7aWYobi5oYXMocykpcmV0dXJuO24uYWRkKHMpfWlmKGEpZm9yKHI9dC5sZW5ndGg7ci0tOyllKHRbcl0sbik7ZWxzZSBmb3IoaT1PYmplY3Qua2V5cyh0KSxyPWkubGVuZ3RoO3ItLTspZSh0W2lbcl1dLG4pfShlLEdlKSxHZS5jbGVhcigpfXZhciBYZSxZZT15KGZ1bmN0aW9uKGUpe3ZhciB0PSImIj09PWUuY2hhckF0KDApLG49In4iPT09KGU9dD9lLnNsaWNlKDEpOmUpLmNoYXJBdCgwKSxyPSIhIj09PShlPW4/ZS5zbGljZSgxKTplKS5jaGFyQXQoMCk7cmV0dXJue25hbWU6ZT1yP2Uuc2xpY2UoMSk6ZSxvbmNlOm4sY2FwdHVyZTpyLHBhc3NpdmU6dH19KTtmdW5jdGlvbiBRZShlKXtmdW5jdGlvbiB0KCl7dmFyIGU9YXJndW1lbnRzLG49dC5mbnM7aWYoIUFycmF5LmlzQXJyYXkobikpcmV0dXJuIG4uYXBwbHkobnVsbCxhcmd1bWVudHMpO2Zvcih2YXIgcj1uLnNsaWNlKCksaT0wO2k8ci5sZW5ndGg7aSsrKXJbaV0uYXBwbHkobnVsbCxlKX1yZXR1cm4gdC5mbnM9ZSx0fWZ1bmN0aW9uIGV0KGUsbixpLG8sYSxzKXt2YXIgYyx1LGwsZjtmb3IoYyBpbiBlKXU9ZVtjXSxsPW5bY10sZj1ZZShjKSx0KHUpfHwodChsKT8odCh1LmZucykmJih1PWVbY109UWUodSkpLHIoZi5vbmNlKSYmKHU9ZVtjXT1hKGYubmFtZSx1LGYuY2FwdHVyZSkpLGkoZi5uYW1lLHUsZi5jYXB0dXJlLGYucGFzc2l2ZSxmLnBhcmFtcykpOnUhPT1sJiYobC5mbnM9dSxlW2NdPWwpKTtmb3IoYyBpbiBuKXQoZVtjXSkmJm8oKGY9WWUoYykpLm5hbWUsbltjXSxmLmNhcHR1cmUpfWZ1bmN0aW9uIHR0KGUsaSxvKXt2YXIgYTtlIGluc3RhbmNlb2YgdWUmJihlPWUuZGF0YS5ob29rfHwoZS5kYXRhLmhvb2s9e30pKTt2YXIgcz1lW2ldO2Z1bmN0aW9uIGMoKXtvLmFwcGx5KHRoaXMsYXJndW1lbnRzKSx2KGEuZm5zLGMpfXQocyk/YT1RZShbY10pOm4ocy5mbnMpJiZyKHMubWVyZ2VkKT8oYT1zKS5mbnMucHVzaChjKTphPVFlKFtzLGNdKSxhLm1lcmdlZD0hMCxlW2ldPWF9ZnVuY3Rpb24gbnQoZSx0LHIsaSxvKXtpZihuKHQpKXtpZihtKHQscikpcmV0dXJuIGVbcl09dFtyXSxvfHxkZWxldGUgdFtyXSwhMDtpZihtKHQsaSkpcmV0dXJuIGVbcl09dFtpXSxvfHxkZWxldGUgdFtpXSwhMH1yZXR1cm4hMX1mdW5jdGlvbiBydChlKXtyZXR1cm4gaShlKT9bcGUoZSldOkFycmF5LmlzQXJyYXkoZSk/ZnVuY3Rpb24gZShvLGEpe3ZhciBzPVtdO3ZhciBjLHUsbCxmO2ZvcihjPTA7YzxvLmxlbmd0aDtjKyspdCh1PW9bY10pfHwiYm9vbGVhbiI9PXR5cGVvZiB1fHwobD1zLmxlbmd0aC0xLGY9c1tsXSxBcnJheS5pc0FycmF5KHUpP3UubGVuZ3RoPjAmJihpdCgodT1lKHUsKGF8fCIiKSsiXyIrYykpWzBdKSYmaXQoZikmJihzW2xdPXBlKGYudGV4dCt1WzBdLnRleHQpLHUuc2hpZnQoKSkscy5wdXNoLmFwcGx5KHMsdSkpOmkodSk/aXQoZik/c1tsXT1wZShmLnRleHQrdSk6IiIhPT11JiZzLnB1c2gocGUodSkpOml0KHUpJiZpdChmKT9zW2xdPXBlKGYudGV4dCt1LnRleHQpOihyKG8uX2lzVkxpc3QpJiZuKHUudGFnKSYmdCh1LmtleSkmJm4oYSkmJih1LmtleT0iX192bGlzdCIrYSsiXyIrYysiX18iKSxzLnB1c2godSkpKTtyZXR1cm4gc30oZSk6dm9pZCAwfWZ1bmN0aW9uIGl0KGUpe3JldHVybiBuKGUpJiZuKGUudGV4dCkmJiExPT09ZS5pc0NvbW1lbnR9ZnVuY3Rpb24gb3QoZSx0KXtyZXR1cm4oZS5fX2VzTW9kdWxlfHxuZSYmIk1vZHVsZSI9PT1lW1N5bWJvbC50b1N0cmluZ1RhZ10pJiYoZT1lLmRlZmF1bHQpLG8oZSk/dC5leHRlbmQoZSk6ZX1mdW5jdGlvbiBhdChlKXtyZXR1cm4gZS5pc0NvbW1lbnQmJmUuYXN5bmNGYWN0b3J5fWZ1bmN0aW9uIHN0KGUpe2lmKEFycmF5LmlzQXJyYXkoZSkpZm9yKHZhciB0PTA7dDxlLmxlbmd0aDt0Kyspe3ZhciByPWVbdF07aWYobihyKSYmKG4oci5jb21wb25lbnRPcHRpb25zKXx8YXQocikpKXJldHVybiByfX1mdW5jdGlvbiBjdChlLHQpe1hlLiRvbihlLHQpfWZ1bmN0aW9uIHV0KGUsdCl7WGUuJG9mZihlLHQpfWZ1bmN0aW9uIGx0KGUsdCl7dmFyIG49WGU7cmV0dXJuIGZ1bmN0aW9uIHIoKXtudWxsIT09dC5hcHBseShudWxsLGFyZ3VtZW50cykmJm4uJG9mZihlLHIpfX1mdW5jdGlvbiBmdChlLHQsbil7WGU9ZSxldCh0LG58fHt9LGN0LHV0LGx0KSxYZT12b2lkIDB9ZnVuY3Rpb24gcHQoZSx0KXt2YXIgbj17fTtpZighZSlyZXR1cm4gbjtmb3IodmFyIHI9MCxpPWUubGVuZ3RoO3I8aTtyKyspe3ZhciBvPWVbcl0sYT1vLmRhdGE7aWYoYSYmYS5hdHRycyYmYS5hdHRycy5zbG90JiZkZWxldGUgYS5hdHRycy5zbG90LG8uY29udGV4dCE9PXQmJm8uZm5Db250ZXh0IT09dHx8IWF8fG51bGw9PWEuc2xvdCkobi5kZWZhdWx0fHwobi5kZWZhdWx0PVtdKSkucHVzaChvKTtlbHNle3ZhciBzPWEuc2xvdCxjPW5bc118fChuW3NdPVtdKTsidGVtcGxhdGUiPT09by50YWc/Yy5wdXNoLmFwcGx5KGMsby5jaGlsZHJlbnx8W10pOmMucHVzaChvKX19Zm9yKHZhciB1IGluIG4pblt1XS5ldmVyeShkdCkmJmRlbGV0ZSBuW3VdO3JldHVybiBufWZ1bmN0aW9uIGR0KGUpe3JldHVybiBlLmlzQ29tbWVudCYmIWUuYXN5bmNGYWN0b3J5fHwiICI9PT1lLnRleHR9ZnVuY3Rpb24gdnQoZSx0KXt0PXR8fHt9O2Zvcih2YXIgbj0wO248ZS5sZW5ndGg7bisrKUFycmF5LmlzQXJyYXkoZVtuXSk/dnQoZVtuXSx0KTp0W2Vbbl0ua2V5XT1lW25dLmZuO3JldHVybiB0fXZhciBodD1udWxsO2Z1bmN0aW9uIG10KGUpe3ZhciB0PWh0O3JldHVybiBodD1lLGZ1bmN0aW9uKCl7aHQ9dH19ZnVuY3Rpb24geXQoZSl7Zm9yKDtlJiYoZT1lLiRwYXJlbnQpOylpZihlLl9pbmFjdGl2ZSlyZXR1cm4hMDtyZXR1cm4hMX1mdW5jdGlvbiBndChlLHQpe2lmKHQpe2lmKGUuX2RpcmVjdEluYWN0aXZlPSExLHl0KGUpKXJldHVybn1lbHNlIGlmKGUuX2RpcmVjdEluYWN0aXZlKXJldHVybjtpZihlLl9pbmFjdGl2ZXx8bnVsbD09PWUuX2luYWN0aXZlKXtlLl9pbmFjdGl2ZT0hMTtmb3IodmFyIG49MDtuPGUuJGNoaWxkcmVuLmxlbmd0aDtuKyspZ3QoZS4kY2hpbGRyZW5bbl0pO190KGUsImFjdGl2YXRlZCIpfX1mdW5jdGlvbiBfdChlLHQpe3NlKCk7dmFyIG49ZS4kb3B0aW9uc1t0XTtpZihuKWZvcih2YXIgcj0wLGk9bi5sZW5ndGg7cjxpO3IrKyl0cnl7bltyXS5jYWxsKGUpfWNhdGNoKG4pe0RlKG4sZSx0KyIgaG9vayIpfWUuX2hhc0hvb2tFdmVudCYmZS4kZW1pdCgiaG9vazoiK3QpLGNlKCl9dmFyIGJ0PVtdLCR0PVtdLHd0PXt9LEN0PSExLHh0PSExLGt0PTA7ZnVuY3Rpb24gQXQoKXt2YXIgZSx0O2Zvcih4dD0hMCxidC5zb3J0KGZ1bmN0aW9uKGUsdCl7cmV0dXJuIGUuaWQtdC5pZH0pLGt0PTA7a3Q8YnQubGVuZ3RoO2t0KyspKGU9YnRba3RdKS5iZWZvcmUmJmUuYmVmb3JlKCksdD1lLmlkLHd0W3RdPW51bGwsZS5ydW4oKTt2YXIgbj0kdC5zbGljZSgpLHI9YnQuc2xpY2UoKTtrdD1idC5sZW5ndGg9JHQubGVuZ3RoPTAsd3Q9e30sQ3Q9eHQ9ITEsZnVuY3Rpb24oZSl7Zm9yKHZhciB0PTA7dDxlLmxlbmd0aDt0KyspZVt0XS5faW5hY3RpdmU9ITAsZ3QoZVt0XSwhMCl9KG4pLGZ1bmN0aW9uKGUpe3ZhciB0PWUubGVuZ3RoO2Zvcig7dC0tOyl7dmFyIG49ZVt0XSxyPW4udm07ci5fd2F0Y2hlcj09PW4mJnIuX2lzTW91bnRlZCYmIXIuX2lzRGVzdHJveWVkJiZfdChyLCJ1cGRhdGVkIil9fShyKSxRJiZELmRldnRvb2xzJiZRLmVtaXQoImZsdXNoIil9dmFyIE90PTAsU3Q9ZnVuY3Rpb24oZSx0LG4scixpKXt0aGlzLnZtPWUsaSYmKGUuX3dhdGNoZXI9dGhpcyksZS5fd2F0Y2hlcnMucHVzaCh0aGlzKSxyPyh0aGlzLmRlZXA9ISFyLmRlZXAsdGhpcy51c2VyPSEhci51c2VyLHRoaXMubGF6eT0hIXIubGF6eSx0aGlzLnN5bmM9ISFyLnN5bmMsdGhpcy5iZWZvcmU9ci5iZWZvcmUpOnRoaXMuZGVlcD10aGlzLnVzZXI9dGhpcy5sYXp5PXRoaXMuc3luYz0hMSx0aGlzLmNiPW4sdGhpcy5pZD0rK090LHRoaXMuYWN0aXZlPSEwLHRoaXMuZGlydHk9dGhpcy5sYXp5LHRoaXMuZGVwcz1bXSx0aGlzLm5ld0RlcHM9W10sdGhpcy5kZXBJZHM9bmV3IHRlLHRoaXMubmV3RGVwSWRzPW5ldyB0ZSx0aGlzLmV4cHJlc3Npb249IiIsImZ1bmN0aW9uIj09dHlwZW9mIHQ/dGhpcy5nZXR0ZXI9dDoodGhpcy5nZXR0ZXI9ZnVuY3Rpb24oZSl7aWYoIUYudGVzdChlKSl7dmFyIHQ9ZS5zcGxpdCgiLiIpO3JldHVybiBmdW5jdGlvbihlKXtmb3IodmFyIG49MDtuPHQubGVuZ3RoO24rKyl7aWYoIWUpcmV0dXJuO2U9ZVt0W25dXX1yZXR1cm4gZX19fSh0KSx0aGlzLmdldHRlcnx8KHRoaXMuZ2V0dGVyPU8pKSx0aGlzLnZhbHVlPXRoaXMubGF6eT92b2lkIDA6dGhpcy5nZXQoKX07U3QucHJvdG90eXBlLmdldD1mdW5jdGlvbigpe3ZhciBlO3NlKHRoaXMpO3ZhciB0PXRoaXMudm07dHJ5e2U9dGhpcy5nZXR0ZXIuY2FsbCh0LHQpfWNhdGNoKGUpe2lmKCF0aGlzLnVzZXIpdGhyb3cgZTtEZShlLHQsJ2dldHRlciBmb3Igd2F0Y2hlciAiJyt0aGlzLmV4cHJlc3Npb24rJyInKX1maW5hbGx5e3RoaXMuZGVlcCYmWmUoZSksY2UoKSx0aGlzLmNsZWFudXBEZXBzKCl9cmV0dXJuIGV9LFN0LnByb3RvdHlwZS5hZGREZXA9ZnVuY3Rpb24oZSl7dmFyIHQ9ZS5pZDt0aGlzLm5ld0RlcElkcy5oYXModCl8fCh0aGlzLm5ld0RlcElkcy5hZGQodCksdGhpcy5uZXdEZXBzLnB1c2goZSksdGhpcy5kZXBJZHMuaGFzKHQpfHxlLmFkZFN1Yih0aGlzKSl9LFN0LnByb3RvdHlwZS5jbGVhbnVwRGVwcz1mdW5jdGlvbigpe2Zvcih2YXIgZT10aGlzLmRlcHMubGVuZ3RoO2UtLTspe3ZhciB0PXRoaXMuZGVwc1tlXTt0aGlzLm5ld0RlcElkcy5oYXModC5pZCl8fHQucmVtb3ZlU3ViKHRoaXMpfXZhciBuPXRoaXMuZGVwSWRzO3RoaXMuZGVwSWRzPXRoaXMubmV3RGVwSWRzLHRoaXMubmV3RGVwSWRzPW4sdGhpcy5uZXdEZXBJZHMuY2xlYXIoKSxuPXRoaXMuZGVwcyx0aGlzLmRlcHM9dGhpcy5uZXdEZXBzLHRoaXMubmV3RGVwcz1uLHRoaXMubmV3RGVwcy5sZW5ndGg9MH0sU3QucHJvdG90eXBlLnVwZGF0ZT1mdW5jdGlvbigpe3RoaXMubGF6eT90aGlzLmRpcnR5PSEwOnRoaXMuc3luYz90aGlzLnJ1bigpOmZ1bmN0aW9uKGUpe3ZhciB0PWUuaWQ7aWYobnVsbD09d3RbdF0pe2lmKHd0W3RdPSEwLHh0KXtmb3IodmFyIG49YnQubGVuZ3RoLTE7bj5rdCYmYnRbbl0uaWQ+ZS5pZDspbi0tO2J0LnNwbGljZShuKzEsMCxlKX1lbHNlIGJ0LnB1c2goZSk7Q3R8fChDdD0hMCxXZShBdCkpfX0odGhpcyl9LFN0LnByb3RvdHlwZS5ydW49ZnVuY3Rpb24oKXtpZih0aGlzLmFjdGl2ZSl7dmFyIGU9dGhpcy5nZXQoKTtpZihlIT09dGhpcy52YWx1ZXx8byhlKXx8dGhpcy5kZWVwKXt2YXIgdD10aGlzLnZhbHVlO2lmKHRoaXMudmFsdWU9ZSx0aGlzLnVzZXIpdHJ5e3RoaXMuY2IuY2FsbCh0aGlzLnZtLGUsdCl9Y2F0Y2goZSl7RGUoZSx0aGlzLnZtLCdjYWxsYmFjayBmb3Igd2F0Y2hlciAiJyt0aGlzLmV4cHJlc3Npb24rJyInKX1lbHNlIHRoaXMuY2IuY2FsbCh0aGlzLnZtLGUsdCl9fX0sU3QucHJvdG90eXBlLmV2YWx1YXRlPWZ1bmN0aW9uKCl7dGhpcy52YWx1ZT10aGlzLmdldCgpLHRoaXMuZGlydHk9ITF9LFN0LnByb3RvdHlwZS5kZXBlbmQ9ZnVuY3Rpb24oKXtmb3IodmFyIGU9dGhpcy5kZXBzLmxlbmd0aDtlLS07KXRoaXMuZGVwc1tlXS5kZXBlbmQoKX0sU3QucHJvdG90eXBlLnRlYXJkb3duPWZ1bmN0aW9uKCl7aWYodGhpcy5hY3RpdmUpe3RoaXMudm0uX2lzQmVpbmdEZXN0cm95ZWR8fHYodGhpcy52bS5fd2F0Y2hlcnMsdGhpcyk7Zm9yKHZhciBlPXRoaXMuZGVwcy5sZW5ndGg7ZS0tOyl0aGlzLmRlcHNbZV0ucmVtb3ZlU3ViKHRoaXMpO3RoaXMuYWN0aXZlPSExfX07dmFyIFR0PXtlbnVtZXJhYmxlOiEwLGNvbmZpZ3VyYWJsZTohMCxnZXQ6TyxzZXQ6T307ZnVuY3Rpb24gTnQoZSx0LG4pe1R0LmdldD1mdW5jdGlvbigpe3JldHVybiB0aGlzW3RdW25dfSxUdC5zZXQ9ZnVuY3Rpb24oZSl7dGhpc1t0XVtuXT1lfSxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxuLFR0KX1mdW5jdGlvbiBqdChlKXtlLl93YXRjaGVycz1bXTt2YXIgdD1lLiRvcHRpb25zO3QucHJvcHMmJmZ1bmN0aW9uKGUsdCl7dmFyIG49ZS4kb3B0aW9ucy5wcm9wc0RhdGF8fHt9LHI9ZS5fcHJvcHM9e30saT1lLiRvcHRpb25zLl9wcm9wS2V5cz1bXTtlLiRwYXJlbnQmJmdlKCExKTt2YXIgbz1mdW5jdGlvbihvKXtpLnB1c2gobyk7dmFyIGE9RWUobyx0LG4sZSk7JGUocixvLGEpLG8gaW4gZXx8TnQoZSwiX3Byb3BzIixvKX07Zm9yKHZhciBhIGluIHQpbyhhKTtnZSghMCl9KGUsdC5wcm9wcyksdC5tZXRob2RzJiZmdW5jdGlvbihlLHQpe2UuJG9wdGlvbnMucHJvcHM7Zm9yKHZhciBuIGluIHQpZVtuXT0iZnVuY3Rpb24iIT10eXBlb2YgdFtuXT9POkModFtuXSxlKX0oZSx0Lm1ldGhvZHMpLHQuZGF0YT9mdW5jdGlvbihlKXt2YXIgdD1lLiRvcHRpb25zLmRhdGE7cyh0PWUuX2RhdGE9ImZ1bmN0aW9uIj09dHlwZW9mIHQ/ZnVuY3Rpb24oZSx0KXtzZSgpO3RyeXtyZXR1cm4gZS5jYWxsKHQsdCl9Y2F0Y2goZSl7cmV0dXJuIERlKGUsdCwiZGF0YSgpIikse319ZmluYWxseXtjZSgpfX0odCxlKTp0fHx7fSl8fCh0PXt9KTt2YXIgbj1PYmplY3Qua2V5cyh0KSxyPWUuJG9wdGlvbnMucHJvcHMsaT0oZS4kb3B0aW9ucy5tZXRob2RzLG4ubGVuZ3RoKTtmb3IoO2ktLTspe3ZhciBvPW5baV07ciYmbShyLG8pfHwodm9pZCAwLDM2IT09KGE9KG8rIiIpLmNoYXJDb2RlQXQoMCkpJiY5NSE9PWEmJk50KGUsIl9kYXRhIixvKSl9dmFyIGE7YmUodCwhMCl9KGUpOmJlKGUuX2RhdGE9e30sITApLHQuY29tcHV0ZWQmJmZ1bmN0aW9uKGUsdCl7dmFyIG49ZS5fY29tcHV0ZWRXYXRjaGVycz1PYmplY3QuY3JlYXRlKG51bGwpLHI9WSgpO2Zvcih2YXIgaSBpbiB0KXt2YXIgbz10W2ldLGE9ImZ1bmN0aW9uIj09dHlwZW9mIG8/bzpvLmdldDtyfHwobltpXT1uZXcgU3QoZSxhfHxPLE8sRXQpKSxpIGluIGV8fEl0KGUsaSxvKX19KGUsdC5jb21wdXRlZCksdC53YXRjaCYmdC53YXRjaCE9PUcmJmZ1bmN0aW9uKGUsdCl7Zm9yKHZhciBuIGluIHQpe3ZhciByPXRbbl07aWYoQXJyYXkuaXNBcnJheShyKSlmb3IodmFyIGk9MDtpPHIubGVuZ3RoO2krKylEdChlLG4scltpXSk7ZWxzZSBEdChlLG4scil9fShlLHQud2F0Y2gpfXZhciBFdD17bGF6eTohMH07ZnVuY3Rpb24gSXQoZSx0LG4pe3ZhciByPSFZKCk7ImZ1bmN0aW9uIj09dHlwZW9mIG4/KFR0LmdldD1yP0x0KHQpOk10KG4pLFR0LnNldD1PKTooVHQuZ2V0PW4uZ2V0P3ImJiExIT09bi5jYWNoZT9MdCh0KTpNdChuLmdldCk6TyxUdC5zZXQ9bi5zZXR8fE8pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLHQsVHQpfWZ1bmN0aW9uIEx0KGUpe3JldHVybiBmdW5jdGlvbigpe3ZhciB0PXRoaXMuX2NvbXB1dGVkV2F0Y2hlcnMmJnRoaXMuX2NvbXB1dGVkV2F0Y2hlcnNbZV07aWYodClyZXR1cm4gdC5kaXJ0eSYmdC5ldmFsdWF0ZSgpLG9lLnRhcmdldCYmdC5kZXBlbmQoKSx0LnZhbHVlfX1mdW5jdGlvbiBNdChlKXtyZXR1cm4gZnVuY3Rpb24oKXtyZXR1cm4gZS5jYWxsKHRoaXMsdGhpcyl9fWZ1bmN0aW9uIER0KGUsdCxuLHIpe3JldHVybiBzKG4pJiYocj1uLG49bi5oYW5kbGVyKSwic3RyaW5nIj09dHlwZW9mIG4mJihuPWVbbl0pLGUuJHdhdGNoKHQsbixyKX1mdW5jdGlvbiBQdChlLHQpe2lmKGUpe2Zvcih2YXIgbj1PYmplY3QuY3JlYXRlKG51bGwpLHI9bmU/UmVmbGVjdC5vd25LZXlzKGUpLmZpbHRlcihmdW5jdGlvbih0KXtyZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLHQpLmVudW1lcmFibGV9KTpPYmplY3Qua2V5cyhlKSxpPTA7aTxyLmxlbmd0aDtpKyspe2Zvcih2YXIgbz1yW2ldLGE9ZVtvXS5mcm9tLHM9dDtzOyl7aWYocy5fcHJvdmlkZWQmJm0ocy5fcHJvdmlkZWQsYSkpe25bb109cy5fcHJvdmlkZWRbYV07YnJlYWt9cz1zLiRwYXJlbnR9aWYoIXMmJiJkZWZhdWx0ImluIGVbb10pe3ZhciBjPWVbb10uZGVmYXVsdDtuW29dPSJmdW5jdGlvbiI9PXR5cGVvZiBjP2MuY2FsbCh0KTpjfX1yZXR1cm4gbn19ZnVuY3Rpb24gRnQoZSx0KXt2YXIgcixpLGEscyxjO2lmKEFycmF5LmlzQXJyYXkoZSl8fCJzdHJpbmciPT10eXBlb2YgZSlmb3Iocj1uZXcgQXJyYXkoZS5sZW5ndGgpLGk9MCxhPWUubGVuZ3RoO2k8YTtpKyspcltpXT10KGVbaV0saSk7ZWxzZSBpZigibnVtYmVyIj09dHlwZW9mIGUpZm9yKHI9bmV3IEFycmF5KGUpLGk9MDtpPGU7aSsrKXJbaV09dChpKzEsaSk7ZWxzZSBpZihvKGUpKWZvcihzPU9iamVjdC5rZXlzKGUpLHI9bmV3IEFycmF5KHMubGVuZ3RoKSxpPTAsYT1zLmxlbmd0aDtpPGE7aSsrKWM9c1tpXSxyW2ldPXQoZVtjXSxjLGkpO3JldHVybiBuKHIpfHwocj1bXSksci5faXNWTGlzdD0hMCxyfWZ1bmN0aW9uIFJ0KGUsdCxuLHIpe3ZhciBpLG89dGhpcy4kc2NvcGVkU2xvdHNbZV07bz8obj1ufHx7fSxyJiYobj1rKGsoe30sciksbikpLGk9byhuKXx8dCk6aT10aGlzLiRzbG90c1tlXXx8dDt2YXIgYT1uJiZuLnNsb3Q7cmV0dXJuIGE/dGhpcy4kY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiLHtzbG90OmF9LGkpOml9ZnVuY3Rpb24gSHQoZSl7cmV0dXJuIGplKHRoaXMuJG9wdGlvbnMsImZpbHRlcnMiLGUpfHxUfWZ1bmN0aW9uIEJ0KGUsdCl7cmV0dXJuIEFycmF5LmlzQXJyYXkoZSk/LTE9PT1lLmluZGV4T2YodCk6ZSE9PXR9ZnVuY3Rpb24gVXQoZSx0LG4scixpKXt2YXIgbz1ELmtleUNvZGVzW3RdfHxuO3JldHVybiBpJiZyJiYhRC5rZXlDb2Rlc1t0XT9CdChpLHIpOm8/QnQobyxlKTpyP3cocikhPT10OnZvaWQgMH1mdW5jdGlvbiBWdChlLHQsbixyLGkpe2lmKG4paWYobyhuKSl7dmFyIGE7QXJyYXkuaXNBcnJheShuKSYmKG49QShuKSk7dmFyIHM9ZnVuY3Rpb24obyl7aWYoImNsYXNzIj09PW98fCJzdHlsZSI9PT1vfHxkKG8pKWE9ZTtlbHNle3ZhciBzPWUuYXR0cnMmJmUuYXR0cnMudHlwZTthPXJ8fEQubXVzdFVzZVByb3AodCxzLG8pP2UuZG9tUHJvcHN8fChlLmRvbVByb3BzPXt9KTplLmF0dHJzfHwoZS5hdHRycz17fSl9dmFyIGM9XyhvKTtvIGluIGF8fGMgaW4gYXx8KGFbb109bltvXSxpJiYoKGUub258fChlLm9uPXt9KSlbInVwZGF0ZToiK2NdPWZ1bmN0aW9uKGUpe25bb109ZX0pKX07Zm9yKHZhciBjIGluIG4pcyhjKX1lbHNlO3JldHVybiBlfWZ1bmN0aW9uIHp0KGUsdCl7dmFyIG49dGhpcy5fc3RhdGljVHJlZXN8fCh0aGlzLl9zdGF0aWNUcmVlcz1bXSkscj1uW2VdO3JldHVybiByJiYhdD9yOihKdChyPW5bZV09dGhpcy4kb3B0aW9ucy5zdGF0aWNSZW5kZXJGbnNbZV0uY2FsbCh0aGlzLl9yZW5kZXJQcm94eSxudWxsLHRoaXMpLCJfX3N0YXRpY19fIitlLCExKSxyKX1mdW5jdGlvbiBLdChlLHQsbil7cmV0dXJuIEp0KGUsIl9fb25jZV9fIit0KyhuPyJfIituOiIiKSwhMCksZX1mdW5jdGlvbiBKdChlLHQsbil7aWYoQXJyYXkuaXNBcnJheShlKSlmb3IodmFyIHI9MDtyPGUubGVuZ3RoO3IrKyllW3JdJiYic3RyaW5nIiE9dHlwZW9mIGVbcl0mJnF0KGVbcl0sdCsiXyIrcixuKTtlbHNlIHF0KGUsdCxuKX1mdW5jdGlvbiBxdChlLHQsbil7ZS5pc1N0YXRpYz0hMCxlLmtleT10LGUuaXNPbmNlPW59ZnVuY3Rpb24gV3QoZSx0KXtpZih0KWlmKHModCkpe3ZhciBuPWUub249ZS5vbj9rKHt9LGUub24pOnt9O2Zvcih2YXIgciBpbiB0KXt2YXIgaT1uW3JdLG89dFtyXTtuW3JdPWk/W10uY29uY2F0KGksbyk6b319ZWxzZTtyZXR1cm4gZX1mdW5jdGlvbiBHdChlKXtlLl9vPUt0LGUuX249bCxlLl9zPXUsZS5fbD1GdCxlLl90PVJ0LGUuX3E9TixlLl9pPWosZS5fbT16dCxlLl9mPUh0LGUuX2s9VXQsZS5fYj1WdCxlLl92PXBlLGUuX2U9ZmUsZS5fdT12dCxlLl9nPVd0fWZ1bmN0aW9uIFp0KHQsbixpLG8sYSl7dmFyIHMsYz1hLm9wdGlvbnM7bShvLCJfdWlkIik/KHM9T2JqZWN0LmNyZWF0ZShvKSkuX29yaWdpbmFsPW86KHM9byxvPW8uX29yaWdpbmFsKTt2YXIgdT1yKGMuX2NvbXBpbGVkKSxsPSF1O3RoaXMuZGF0YT10LHRoaXMucHJvcHM9bix0aGlzLmNoaWxkcmVuPWksdGhpcy5wYXJlbnQ9byx0aGlzLmxpc3RlbmVycz10Lm9ufHxlLHRoaXMuaW5qZWN0aW9ucz1QdChjLmluamVjdCxvKSx0aGlzLnNsb3RzPWZ1bmN0aW9uKCl7cmV0dXJuIHB0KGksbyl9LHUmJih0aGlzLiRvcHRpb25zPWMsdGhpcy4kc2xvdHM9dGhpcy5zbG90cygpLHRoaXMuJHNjb3BlZFNsb3RzPXQuc2NvcGVkU2xvdHN8fGUpLGMuX3Njb3BlSWQ/dGhpcy5fYz1mdW5jdGlvbihlLHQsbixyKXt2YXIgaT1hbihzLGUsdCxuLHIsbCk7cmV0dXJuIGkmJiFBcnJheS5pc0FycmF5KGkpJiYoaS5mblNjb3BlSWQ9Yy5fc2NvcGVJZCxpLmZuQ29udGV4dD1vKSxpfTp0aGlzLl9jPWZ1bmN0aW9uKGUsdCxuLHIpe3JldHVybiBhbihzLGUsdCxuLHIsbCl9fWZ1bmN0aW9uIFh0KGUsdCxuLHIsaSl7dmFyIG89ZGUoZSk7cmV0dXJuIG8uZm5Db250ZXh0PW4sby5mbk9wdGlvbnM9cix0LnNsb3QmJigoby5kYXRhfHwoby5kYXRhPXt9KSkuc2xvdD10LnNsb3QpLG99ZnVuY3Rpb24gWXQoZSx0KXtmb3IodmFyIG4gaW4gdCllW18obildPXRbbl19R3QoWnQucHJvdG90eXBlKTt2YXIgUXQ9e2luaXQ6ZnVuY3Rpb24oZSx0KXtpZihlLmNvbXBvbmVudEluc3RhbmNlJiYhZS5jb21wb25lbnRJbnN0YW5jZS5faXNEZXN0cm95ZWQmJmUuZGF0YS5rZWVwQWxpdmUpe3ZhciByPWU7UXQucHJlcGF0Y2gocixyKX1lbHNleyhlLmNvbXBvbmVudEluc3RhbmNlPWZ1bmN0aW9uKGUsdCl7dmFyIHI9e19pc0NvbXBvbmVudDohMCxfcGFyZW50Vm5vZGU6ZSxwYXJlbnQ6dH0saT1lLmRhdGEuaW5saW5lVGVtcGxhdGU7bihpKSYmKHIucmVuZGVyPWkucmVuZGVyLHIuc3RhdGljUmVuZGVyRm5zPWkuc3RhdGljUmVuZGVyRm5zKTtyZXR1cm4gbmV3IGUuY29tcG9uZW50T3B0aW9ucy5DdG9yKHIpfShlLGh0KSkuJG1vdW50KHQ/ZS5lbG06dm9pZCAwLHQpfX0scHJlcGF0Y2g6ZnVuY3Rpb24odCxuKXt2YXIgcj1uLmNvbXBvbmVudE9wdGlvbnM7IWZ1bmN0aW9uKHQsbixyLGksbyl7dmFyIGE9ISEob3x8dC4kb3B0aW9ucy5fcmVuZGVyQ2hpbGRyZW58fGkuZGF0YS5zY29wZWRTbG90c3x8dC4kc2NvcGVkU2xvdHMhPT1lKTtpZih0LiRvcHRpb25zLl9wYXJlbnRWbm9kZT1pLHQuJHZub2RlPWksdC5fdm5vZGUmJih0Ll92bm9kZS5wYXJlbnQ9aSksdC4kb3B0aW9ucy5fcmVuZGVyQ2hpbGRyZW49byx0LiRhdHRycz1pLmRhdGEuYXR0cnN8fGUsdC4kbGlzdGVuZXJzPXJ8fGUsbiYmdC4kb3B0aW9ucy5wcm9wcyl7Z2UoITEpO2Zvcih2YXIgcz10Ll9wcm9wcyxjPXQuJG9wdGlvbnMuX3Byb3BLZXlzfHxbXSx1PTA7dTxjLmxlbmd0aDt1Kyspe3ZhciBsPWNbdV0sZj10LiRvcHRpb25zLnByb3BzO3NbbF09RWUobCxmLG4sdCl9Z2UoITApLHQuJG9wdGlvbnMucHJvcHNEYXRhPW59cj1yfHxlO3ZhciBwPXQuJG9wdGlvbnMuX3BhcmVudExpc3RlbmVyczt0LiRvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnM9cixmdCh0LHIscCksYSYmKHQuJHNsb3RzPXB0KG8saS5jb250ZXh0KSx0LiRmb3JjZVVwZGF0ZSgpKX0obi5jb21wb25lbnRJbnN0YW5jZT10LmNvbXBvbmVudEluc3RhbmNlLHIucHJvcHNEYXRhLHIubGlzdGVuZXJzLG4sci5jaGlsZHJlbil9LGluc2VydDpmdW5jdGlvbihlKXt2YXIgdCxuPWUuY29udGV4dCxyPWUuY29tcG9uZW50SW5zdGFuY2U7ci5faXNNb3VudGVkfHwoci5faXNNb3VudGVkPSEwLF90KHIsIm1vdW50ZWQiKSksZS5kYXRhLmtlZXBBbGl2ZSYmKG4uX2lzTW91bnRlZD8oKHQ9cikuX2luYWN0aXZlPSExLCR0LnB1c2godCkpOmd0KHIsITApKX0sZGVzdHJveTpmdW5jdGlvbihlKXt2YXIgdD1lLmNvbXBvbmVudEluc3RhbmNlO3QuX2lzRGVzdHJveWVkfHwoZS5kYXRhLmtlZXBBbGl2ZT9mdW5jdGlvbiBlKHQsbil7aWYoIShuJiYodC5fZGlyZWN0SW5hY3RpdmU9ITAseXQodCkpfHx0Ll9pbmFjdGl2ZSkpe3QuX2luYWN0aXZlPSEwO2Zvcih2YXIgcj0wO3I8dC4kY2hpbGRyZW4ubGVuZ3RoO3IrKyllKHQuJGNoaWxkcmVuW3JdKTtfdCh0LCJkZWFjdGl2YXRlZCIpfX0odCwhMCk6dC4kZGVzdHJveSgpKX19LGVuPU9iamVjdC5rZXlzKFF0KTtmdW5jdGlvbiB0bihpLGEscyxjLHUpe2lmKCF0KGkpKXt2YXIgbD1zLiRvcHRpb25zLl9iYXNlO2lmKG8oaSkmJihpPWwuZXh0ZW5kKGkpKSwiZnVuY3Rpb24iPT10eXBlb2YgaSl7dmFyIGY7aWYodChpLmNpZCkmJnZvaWQgMD09PShpPWZ1bmN0aW9uKGUsaSxhKXtpZihyKGUuZXJyb3IpJiZuKGUuZXJyb3JDb21wKSlyZXR1cm4gZS5lcnJvckNvbXA7aWYobihlLnJlc29sdmVkKSlyZXR1cm4gZS5yZXNvbHZlZDtpZihyKGUubG9hZGluZykmJm4oZS5sb2FkaW5nQ29tcCkpcmV0dXJuIGUubG9hZGluZ0NvbXA7aWYoIW4oZS5jb250ZXh0cykpe3ZhciBzPWUuY29udGV4dHM9W2FdLGM9ITAsdT1mdW5jdGlvbihlKXtmb3IodmFyIHQ9MCxuPXMubGVuZ3RoO3Q8bjt0Kyspc1t0XS4kZm9yY2VVcGRhdGUoKTtlJiYocy5sZW5ndGg9MCl9LGw9RShmdW5jdGlvbih0KXtlLnJlc29sdmVkPW90KHQsaSksY3x8dSghMCl9KSxmPUUoZnVuY3Rpb24odCl7bihlLmVycm9yQ29tcCkmJihlLmVycm9yPSEwLHUoITApKX0pLHA9ZShsLGYpO3JldHVybiBvKHApJiYoImZ1bmN0aW9uIj09dHlwZW9mIHAudGhlbj90KGUucmVzb2x2ZWQpJiZwLnRoZW4obCxmKTpuKHAuY29tcG9uZW50KSYmImZ1bmN0aW9uIj09dHlwZW9mIHAuY29tcG9uZW50LnRoZW4mJihwLmNvbXBvbmVudC50aGVuKGwsZiksbihwLmVycm9yKSYmKGUuZXJyb3JDb21wPW90KHAuZXJyb3IsaSkpLG4ocC5sb2FkaW5nKSYmKGUubG9hZGluZ0NvbXA9b3QocC5sb2FkaW5nLGkpLDA9PT1wLmRlbGF5P2UubG9hZGluZz0hMDpzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7dChlLnJlc29sdmVkKSYmdChlLmVycm9yKSYmKGUubG9hZGluZz0hMCx1KCExKSl9LHAuZGVsYXl8fDIwMCkpLG4ocC50aW1lb3V0KSYmc2V0VGltZW91dChmdW5jdGlvbigpe3QoZS5yZXNvbHZlZCkmJmYobnVsbCl9LHAudGltZW91dCkpKSxjPSExLGUubG9hZGluZz9lLmxvYWRpbmdDb21wOmUucmVzb2x2ZWR9ZS5jb250ZXh0cy5wdXNoKGEpfShmPWksbCxzKSkpcmV0dXJuIGZ1bmN0aW9uKGUsdCxuLHIsaSl7dmFyIG89ZmUoKTtyZXR1cm4gby5hc3luY0ZhY3Rvcnk9ZSxvLmFzeW5jTWV0YT17ZGF0YTp0LGNvbnRleHQ6bixjaGlsZHJlbjpyLHRhZzppfSxvfShmLGEscyxjLHUpO2E9YXx8e30sY24oaSksbihhLm1vZGVsKSYmZnVuY3Rpb24oZSx0KXt2YXIgcj1lLm1vZGVsJiZlLm1vZGVsLnByb3B8fCJ2YWx1ZSIsaT1lLm1vZGVsJiZlLm1vZGVsLmV2ZW50fHwiaW5wdXQiOyh0LnByb3BzfHwodC5wcm9wcz17fSkpW3JdPXQubW9kZWwudmFsdWU7dmFyIG89dC5vbnx8KHQub249e30pLGE9b1tpXSxzPXQubW9kZWwuY2FsbGJhY2s7bihhKT8oQXJyYXkuaXNBcnJheShhKT8tMT09PWEuaW5kZXhPZihzKTphIT09cykmJihvW2ldPVtzXS5jb25jYXQoYSkpOm9baV09c30oaS5vcHRpb25zLGEpO3ZhciBwPWZ1bmN0aW9uKGUscixpKXt2YXIgbz1yLm9wdGlvbnMucHJvcHM7aWYoIXQobykpe3ZhciBhPXt9LHM9ZS5hdHRycyxjPWUucHJvcHM7aWYobihzKXx8bihjKSlmb3IodmFyIHUgaW4gbyl7dmFyIGw9dyh1KTtudChhLGMsdSxsLCEwKXx8bnQoYSxzLHUsbCwhMSl9cmV0dXJuIGF9fShhLGkpO2lmKHIoaS5vcHRpb25zLmZ1bmN0aW9uYWwpKXJldHVybiBmdW5jdGlvbih0LHIsaSxvLGEpe3ZhciBzPXQub3B0aW9ucyxjPXt9LHU9cy5wcm9wcztpZihuKHUpKWZvcih2YXIgbCBpbiB1KWNbbF09RWUobCx1LHJ8fGUpO2Vsc2UgbihpLmF0dHJzKSYmWXQoYyxpLmF0dHJzKSxuKGkucHJvcHMpJiZZdChjLGkucHJvcHMpO3ZhciBmPW5ldyBadChpLGMsYSxvLHQpLHA9cy5yZW5kZXIuY2FsbChudWxsLGYuX2MsZik7aWYocCBpbnN0YW5jZW9mIHVlKXJldHVybiBYdChwLGksZi5wYXJlbnQscyk7aWYoQXJyYXkuaXNBcnJheShwKSl7Zm9yKHZhciBkPXJ0KHApfHxbXSx2PW5ldyBBcnJheShkLmxlbmd0aCksaD0wO2g8ZC5sZW5ndGg7aCsrKXZbaF09WHQoZFtoXSxpLGYucGFyZW50LHMpO3JldHVybiB2fX0oaSxwLGEscyxjKTt2YXIgZD1hLm9uO2lmKGEub249YS5uYXRpdmVPbixyKGkub3B0aW9ucy5hYnN0cmFjdCkpe3ZhciB2PWEuc2xvdDthPXt9LHYmJihhLnNsb3Q9dil9IWZ1bmN0aW9uKGUpe2Zvcih2YXIgdD1lLmhvb2t8fChlLmhvb2s9e30pLG49MDtuPGVuLmxlbmd0aDtuKyspe3ZhciByPWVuW25dLGk9dFtyXSxvPVF0W3JdO2k9PT1vfHxpJiZpLl9tZXJnZWR8fCh0W3JdPWk/bm4obyxpKTpvKX19KGEpO3ZhciBoPWkub3B0aW9ucy5uYW1lfHx1O3JldHVybiBuZXcgdWUoInZ1ZS1jb21wb25lbnQtIitpLmNpZCsoaD8iLSIraDoiIiksYSx2b2lkIDAsdm9pZCAwLHZvaWQgMCxzLHtDdG9yOmkscHJvcHNEYXRhOnAsbGlzdGVuZXJzOmQsdGFnOnUsY2hpbGRyZW46Y30sZil9fX1mdW5jdGlvbiBubihlLHQpe3ZhciBuPWZ1bmN0aW9uKG4scil7ZShuLHIpLHQobixyKX07cmV0dXJuIG4uX21lcmdlZD0hMCxufXZhciBybj0xLG9uPTI7ZnVuY3Rpb24gYW4oZSxhLHMsYyx1LGwpe3JldHVybihBcnJheS5pc0FycmF5KHMpfHxpKHMpKSYmKHU9YyxjPXMscz12b2lkIDApLHIobCkmJih1PW9uKSxmdW5jdGlvbihlLGksYSxzLGMpe2lmKG4oYSkmJm4oYS5fX29iX18pKXJldHVybiBmZSgpO24oYSkmJm4oYS5pcykmJihpPWEuaXMpO2lmKCFpKXJldHVybiBmZSgpO0FycmF5LmlzQXJyYXkocykmJiJmdW5jdGlvbiI9PXR5cGVvZiBzWzBdJiYoKGE9YXx8e30pLnNjb3BlZFNsb3RzPXtkZWZhdWx0OnNbMF19LHMubGVuZ3RoPTApO2M9PT1vbj9zPXJ0KHMpOmM9PT1ybiYmKHM9ZnVuY3Rpb24oZSl7Zm9yKHZhciB0PTA7dDxlLmxlbmd0aDt0KyspaWYoQXJyYXkuaXNBcnJheShlW3RdKSlyZXR1cm4gQXJyYXkucHJvdG90eXBlLmNvbmNhdC5hcHBseShbXSxlKTtyZXR1cm4gZX0ocykpO3ZhciB1LGw7aWYoInN0cmluZyI9PXR5cGVvZiBpKXt2YXIgZjtsPWUuJHZub2RlJiZlLiR2bm9kZS5uc3x8RC5nZXRUYWdOYW1lc3BhY2UoaSksdT1ELmlzUmVzZXJ2ZWRUYWcoaSk/bmV3IHVlKEQucGFyc2VQbGF0Zm9ybVRhZ05hbWUoaSksYSxzLHZvaWQgMCx2b2lkIDAsZSk6YSYmYS5wcmV8fCFuKGY9amUoZS4kb3B0aW9ucywiY29tcG9uZW50cyIsaSkpP25ldyB1ZShpLGEscyx2b2lkIDAsdm9pZCAwLGUpOnRuKGYsYSxlLHMsaSl9ZWxzZSB1PXRuKGksYSxlLHMpO3JldHVybiBBcnJheS5pc0FycmF5KHUpP3U6bih1KT8obihsKSYmZnVuY3Rpb24gZShpLG8sYSl7aS5ucz1vOyJmb3JlaWduT2JqZWN0Ij09PWkudGFnJiYobz12b2lkIDAsYT0hMCk7aWYobihpLmNoaWxkcmVuKSlmb3IodmFyIHM9MCxjPWkuY2hpbGRyZW4ubGVuZ3RoO3M8YztzKyspe3ZhciB1PWkuY2hpbGRyZW5bc107bih1LnRhZykmJih0KHUubnMpfHxyKGEpJiYic3ZnIiE9PXUudGFnKSYmZSh1LG8sYSl9fSh1LGwpLG4oYSkmJmZ1bmN0aW9uKGUpe28oZS5zdHlsZSkmJlplKGUuc3R5bGUpO28oZS5jbGFzcykmJlplKGUuY2xhc3MpfShhKSx1KTpmZSgpfShlLGEscyxjLHUpfXZhciBzbj0wO2Z1bmN0aW9uIGNuKGUpe3ZhciB0PWUub3B0aW9ucztpZihlLnN1cGVyKXt2YXIgbj1jbihlLnN1cGVyKTtpZihuIT09ZS5zdXBlck9wdGlvbnMpe2Uuc3VwZXJPcHRpb25zPW47dmFyIHI9ZnVuY3Rpb24oZSl7dmFyIHQsbj1lLm9wdGlvbnMscj1lLmV4dGVuZE9wdGlvbnMsaT1lLnNlYWxlZE9wdGlvbnM7Zm9yKHZhciBvIGluIG4pbltvXSE9PWlbb10mJih0fHwodD17fSksdFtvXT11bihuW29dLHJbb10saVtvXSkpO3JldHVybiB0fShlKTtyJiZrKGUuZXh0ZW5kT3B0aW9ucyxyKSwodD1lLm9wdGlvbnM9TmUobixlLmV4dGVuZE9wdGlvbnMpKS5uYW1lJiYodC5jb21wb25lbnRzW3QubmFtZV09ZSl9fXJldHVybiB0fWZ1bmN0aW9uIHVuKGUsdCxuKXtpZihBcnJheS5pc0FycmF5KGUpKXt2YXIgcj1bXTtuPUFycmF5LmlzQXJyYXkobik/bjpbbl0sdD1BcnJheS5pc0FycmF5KHQpP3Q6W3RdO2Zvcih2YXIgaT0wO2k8ZS5sZW5ndGg7aSsrKSh0LmluZGV4T2YoZVtpXSk+PTB8fG4uaW5kZXhPZihlW2ldKTwwKSYmci5wdXNoKGVbaV0pO3JldHVybiByfXJldHVybiBlfWZ1bmN0aW9uIGxuKGUpe3RoaXMuX2luaXQoZSl9ZnVuY3Rpb24gZm4oZSl7ZS5jaWQ9MDt2YXIgdD0xO2UuZXh0ZW5kPWZ1bmN0aW9uKGUpe2U9ZXx8e307dmFyIG49dGhpcyxyPW4uY2lkLGk9ZS5fQ3Rvcnx8KGUuX0N0b3I9e30pO2lmKGlbcl0pcmV0dXJuIGlbcl07dmFyIG89ZS5uYW1lfHxuLm9wdGlvbnMubmFtZSxhPWZ1bmN0aW9uKGUpe3RoaXMuX2luaXQoZSl9O3JldHVybihhLnByb3RvdHlwZT1PYmplY3QuY3JlYXRlKG4ucHJvdG90eXBlKSkuY29uc3RydWN0b3I9YSxhLmNpZD10KyssYS5vcHRpb25zPU5lKG4ub3B0aW9ucyxlKSxhLnN1cGVyPW4sYS5vcHRpb25zLnByb3BzJiZmdW5jdGlvbihlKXt2YXIgdD1lLm9wdGlvbnMucHJvcHM7Zm9yKHZhciBuIGluIHQpTnQoZS5wcm90b3R5cGUsIl9wcm9wcyIsbil9KGEpLGEub3B0aW9ucy5jb21wdXRlZCYmZnVuY3Rpb24oZSl7dmFyIHQ9ZS5vcHRpb25zLmNvbXB1dGVkO2Zvcih2YXIgbiBpbiB0KUl0KGUucHJvdG90eXBlLG4sdFtuXSl9KGEpLGEuZXh0ZW5kPW4uZXh0ZW5kLGEubWl4aW49bi5taXhpbixhLnVzZT1uLnVzZSxMLmZvckVhY2goZnVuY3Rpb24oZSl7YVtlXT1uW2VdfSksbyYmKGEub3B0aW9ucy5jb21wb25lbnRzW29dPWEpLGEuc3VwZXJPcHRpb25zPW4ub3B0aW9ucyxhLmV4dGVuZE9wdGlvbnM9ZSxhLnNlYWxlZE9wdGlvbnM9ayh7fSxhLm9wdGlvbnMpLGlbcl09YSxhfX1mdW5jdGlvbiBwbihlKXtyZXR1cm4gZSYmKGUuQ3Rvci5vcHRpb25zLm5hbWV8fGUudGFnKX1mdW5jdGlvbiBkbihlLHQpe3JldHVybiBBcnJheS5pc0FycmF5KGUpP2UuaW5kZXhPZih0KT4tMToic3RyaW5nIj09dHlwZW9mIGU/ZS5zcGxpdCgiLCIpLmluZGV4T2YodCk+LTE6KG49ZSwiW29iamVjdCBSZWdFeHBdIj09PWEuY2FsbChuKSYmZS50ZXN0KHQpKTt2YXIgbn1mdW5jdGlvbiB2bihlLHQpe3ZhciBuPWUuY2FjaGUscj1lLmtleXMsaT1lLl92bm9kZTtmb3IodmFyIG8gaW4gbil7dmFyIGE9bltvXTtpZihhKXt2YXIgcz1wbihhLmNvbXBvbmVudE9wdGlvbnMpO3MmJiF0KHMpJiZobihuLG8scixpKX19fWZ1bmN0aW9uIGhuKGUsdCxuLHIpe3ZhciBpPWVbdF07IWl8fHImJmkudGFnPT09ci50YWd8fGkuY29tcG9uZW50SW5zdGFuY2UuJGRlc3Ryb3koKSxlW3RdPW51bGwsdihuLHQpfSFmdW5jdGlvbih0KXt0LnByb3RvdHlwZS5faW5pdD1mdW5jdGlvbih0KXt2YXIgbj10aGlzO24uX3VpZD1zbisrLG4uX2lzVnVlPSEwLHQmJnQuX2lzQ29tcG9uZW50P2Z1bmN0aW9uKGUsdCl7dmFyIG49ZS4kb3B0aW9ucz1PYmplY3QuY3JlYXRlKGUuY29uc3RydWN0b3Iub3B0aW9ucykscj10Ll9wYXJlbnRWbm9kZTtuLnBhcmVudD10LnBhcmVudCxuLl9wYXJlbnRWbm9kZT1yO3ZhciBpPXIuY29tcG9uZW50T3B0aW9ucztuLnByb3BzRGF0YT1pLnByb3BzRGF0YSxuLl9wYXJlbnRMaXN0ZW5lcnM9aS5saXN0ZW5lcnMsbi5fcmVuZGVyQ2hpbGRyZW49aS5jaGlsZHJlbixuLl9jb21wb25lbnRUYWc9aS50YWcsdC5yZW5kZXImJihuLnJlbmRlcj10LnJlbmRlcixuLnN0YXRpY1JlbmRlckZucz10LnN0YXRpY1JlbmRlckZucyl9KG4sdCk6bi4kb3B0aW9ucz1OZShjbihuLmNvbnN0cnVjdG9yKSx0fHx7fSxuKSxuLl9yZW5kZXJQcm94eT1uLG4uX3NlbGY9bixmdW5jdGlvbihlKXt2YXIgdD1lLiRvcHRpb25zLG49dC5wYXJlbnQ7aWYobiYmIXQuYWJzdHJhY3Qpe2Zvcig7bi4kb3B0aW9ucy5hYnN0cmFjdCYmbi4kcGFyZW50OyluPW4uJHBhcmVudDtuLiRjaGlsZHJlbi5wdXNoKGUpfWUuJHBhcmVudD1uLGUuJHJvb3Q9bj9uLiRyb290OmUsZS4kY2hpbGRyZW49W10sZS4kcmVmcz17fSxlLl93YXRjaGVyPW51bGwsZS5faW5hY3RpdmU9bnVsbCxlLl9kaXJlY3RJbmFjdGl2ZT0hMSxlLl9pc01vdW50ZWQ9ITEsZS5faXNEZXN0cm95ZWQ9ITEsZS5faXNCZWluZ0Rlc3Ryb3llZD0hMX0obiksZnVuY3Rpb24oZSl7ZS5fZXZlbnRzPU9iamVjdC5jcmVhdGUobnVsbCksZS5faGFzSG9va0V2ZW50PSExO3ZhciB0PWUuJG9wdGlvbnMuX3BhcmVudExpc3RlbmVyczt0JiZmdChlLHQpfShuKSxmdW5jdGlvbih0KXt0Ll92bm9kZT1udWxsLHQuX3N0YXRpY1RyZWVzPW51bGw7dmFyIG49dC4kb3B0aW9ucyxyPXQuJHZub2RlPW4uX3BhcmVudFZub2RlLGk9ciYmci5jb250ZXh0O3QuJHNsb3RzPXB0KG4uX3JlbmRlckNoaWxkcmVuLGkpLHQuJHNjb3BlZFNsb3RzPWUsdC5fYz1mdW5jdGlvbihlLG4scixpKXtyZXR1cm4gYW4odCxlLG4scixpLCExKX0sdC4kY3JlYXRlRWxlbWVudD1mdW5jdGlvbihlLG4scixpKXtyZXR1cm4gYW4odCxlLG4scixpLCEwKX07dmFyIG89ciYmci5kYXRhOyRlKHQsIiRhdHRycyIsbyYmby5hdHRyc3x8ZSxudWxsLCEwKSwkZSh0LCIkbGlzdGVuZXJzIixuLl9wYXJlbnRMaXN0ZW5lcnN8fGUsbnVsbCwhMCl9KG4pLF90KG4sImJlZm9yZUNyZWF0ZSIpLGZ1bmN0aW9uKGUpe3ZhciB0PVB0KGUuJG9wdGlvbnMuaW5qZWN0LGUpO3QmJihnZSghMSksT2JqZWN0LmtleXModCkuZm9yRWFjaChmdW5jdGlvbihuKXskZShlLG4sdFtuXSl9KSxnZSghMCkpfShuKSxqdChuKSxmdW5jdGlvbihlKXt2YXIgdD1lLiRvcHRpb25zLnByb3ZpZGU7dCYmKGUuX3Byb3ZpZGVkPSJmdW5jdGlvbiI9PXR5cGVvZiB0P3QuY2FsbChlKTp0KX0obiksX3QobiwiY3JlYXRlZCIpLG4uJG9wdGlvbnMuZWwmJm4uJG1vdW50KG4uJG9wdGlvbnMuZWwpfX0obG4pLGZ1bmN0aW9uKGUpe3ZhciB0PXtnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5fZGF0YX19LG49e2dldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLl9wcm9wc319O09iamVjdC5kZWZpbmVQcm9wZXJ0eShlLnByb3RvdHlwZSwiJGRhdGEiLHQpLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLnByb3RvdHlwZSwiJHByb3BzIixuKSxlLnByb3RvdHlwZS4kc2V0PXdlLGUucHJvdG90eXBlLiRkZWxldGU9Q2UsZS5wcm90b3R5cGUuJHdhdGNoPWZ1bmN0aW9uKGUsdCxuKXtpZihzKHQpKXJldHVybiBEdCh0aGlzLGUsdCxuKTsobj1ufHx7fSkudXNlcj0hMDt2YXIgcj1uZXcgU3QodGhpcyxlLHQsbik7aWYobi5pbW1lZGlhdGUpdHJ5e3QuY2FsbCh0aGlzLHIudmFsdWUpfWNhdGNoKGUpe0RlKGUsdGhpcywnY2FsbGJhY2sgZm9yIGltbWVkaWF0ZSB3YXRjaGVyICInK3IuZXhwcmVzc2lvbisnIicpfXJldHVybiBmdW5jdGlvbigpe3IudGVhcmRvd24oKX19fShsbiksZnVuY3Rpb24oZSl7dmFyIHQ9L15ob29rOi87ZS5wcm90b3R5cGUuJG9uPWZ1bmN0aW9uKGUsbil7dmFyIHI9dGhpcztpZihBcnJheS5pc0FycmF5KGUpKWZvcih2YXIgaT0wLG89ZS5sZW5ndGg7aTxvO2krKylyLiRvbihlW2ldLG4pO2Vsc2Uoci5fZXZlbnRzW2VdfHwoci5fZXZlbnRzW2VdPVtdKSkucHVzaChuKSx0LnRlc3QoZSkmJihyLl9oYXNIb29rRXZlbnQ9ITApO3JldHVybiByfSxlLnByb3RvdHlwZS4kb25jZT1mdW5jdGlvbihlLHQpe3ZhciBuPXRoaXM7ZnVuY3Rpb24gcigpe24uJG9mZihlLHIpLHQuYXBwbHkobixhcmd1bWVudHMpfXJldHVybiByLmZuPXQsbi4kb24oZSxyKSxufSxlLnByb3RvdHlwZS4kb2ZmPWZ1bmN0aW9uKGUsdCl7dmFyIG49dGhpcztpZighYXJndW1lbnRzLmxlbmd0aClyZXR1cm4gbi5fZXZlbnRzPU9iamVjdC5jcmVhdGUobnVsbCksbjtpZihBcnJheS5pc0FycmF5KGUpKXtmb3IodmFyIHI9MCxpPWUubGVuZ3RoO3I8aTtyKyspbi4kb2ZmKGVbcl0sdCk7cmV0dXJuIG59dmFyIG89bi5fZXZlbnRzW2VdO2lmKCFvKXJldHVybiBuO2lmKCF0KXJldHVybiBuLl9ldmVudHNbZV09bnVsbCxuO2lmKHQpZm9yKHZhciBhLHM9by5sZW5ndGg7cy0tOylpZigoYT1vW3NdKT09PXR8fGEuZm49PT10KXtvLnNwbGljZShzLDEpO2JyZWFrfXJldHVybiBufSxlLnByb3RvdHlwZS4kZW1pdD1mdW5jdGlvbihlKXt2YXIgdD10aGlzLl9ldmVudHNbZV07aWYodCl7dD10Lmxlbmd0aD4xP3godCk6dDtmb3IodmFyIG49eChhcmd1bWVudHMsMSkscj0wLGk9dC5sZW5ndGg7cjxpO3IrKyl0cnl7dFtyXS5hcHBseSh0aGlzLG4pfWNhdGNoKHQpe0RlKHQsdGhpcywnZXZlbnQgaGFuZGxlciBmb3IgIicrZSsnIicpfX1yZXR1cm4gdGhpc319KGxuKSxmdW5jdGlvbihlKXtlLnByb3RvdHlwZS5fdXBkYXRlPWZ1bmN0aW9uKGUsdCl7dmFyIG49dGhpcyxyPW4uJGVsLGk9bi5fdm5vZGUsbz1tdChuKTtuLl92bm9kZT1lLG4uJGVsPWk/bi5fX3BhdGNoX18oaSxlKTpuLl9fcGF0Y2hfXyhuLiRlbCxlLHQsITEpLG8oKSxyJiYoci5fX3Z1ZV9fPW51bGwpLG4uJGVsJiYobi4kZWwuX192dWVfXz1uKSxuLiR2bm9kZSYmbi4kcGFyZW50JiZuLiR2bm9kZT09PW4uJHBhcmVudC5fdm5vZGUmJihuLiRwYXJlbnQuJGVsPW4uJGVsKX0sZS5wcm90b3R5cGUuJGZvcmNlVXBkYXRlPWZ1bmN0aW9uKCl7dGhpcy5fd2F0Y2hlciYmdGhpcy5fd2F0Y2hlci51cGRhdGUoKX0sZS5wcm90b3R5cGUuJGRlc3Ryb3k9ZnVuY3Rpb24oKXt2YXIgZT10aGlzO2lmKCFlLl9pc0JlaW5nRGVzdHJveWVkKXtfdChlLCJiZWZvcmVEZXN0cm95IiksZS5faXNCZWluZ0Rlc3Ryb3llZD0hMDt2YXIgdD1lLiRwYXJlbnQ7IXR8fHQuX2lzQmVpbmdEZXN0cm95ZWR8fGUuJG9wdGlvbnMuYWJzdHJhY3R8fHYodC4kY2hpbGRyZW4sZSksZS5fd2F0Y2hlciYmZS5fd2F0Y2hlci50ZWFyZG93bigpO2Zvcih2YXIgbj1lLl93YXRjaGVycy5sZW5ndGg7bi0tOyllLl93YXRjaGVyc1tuXS50ZWFyZG93bigpO2UuX2RhdGEuX19vYl9fJiZlLl9kYXRhLl9fb2JfXy52bUNvdW50LS0sZS5faXNEZXN0cm95ZWQ9ITAsZS5fX3BhdGNoX18oZS5fdm5vZGUsbnVsbCksX3QoZSwiZGVzdHJveWVkIiksZS4kb2ZmKCksZS4kZWwmJihlLiRlbC5fX3Z1ZV9fPW51bGwpLGUuJHZub2RlJiYoZS4kdm5vZGUucGFyZW50PW51bGwpfX19KGxuKSxmdW5jdGlvbih0KXtHdCh0LnByb3RvdHlwZSksdC5wcm90b3R5cGUuJG5leHRUaWNrPWZ1bmN0aW9uKGUpe3JldHVybiBXZShlLHRoaXMpfSx0LnByb3RvdHlwZS5fcmVuZGVyPWZ1bmN0aW9uKCl7dmFyIHQsbj10aGlzLHI9bi4kb3B0aW9ucyxpPXIucmVuZGVyLG89ci5fcGFyZW50Vm5vZGU7byYmKG4uJHNjb3BlZFNsb3RzPW8uZGF0YS5zY29wZWRTbG90c3x8ZSksbi4kdm5vZGU9bzt0cnl7dD1pLmNhbGwobi5fcmVuZGVyUHJveHksbi4kY3JlYXRlRWxlbWVudCl9Y2F0Y2goZSl7RGUoZSxuLCJyZW5kZXIiKSx0PW4uX3Zub2RlfXJldHVybiB0IGluc3RhbmNlb2YgdWV8fCh0PWZlKCkpLHQucGFyZW50PW8sdH19KGxuKTt2YXIgbW49W1N0cmluZyxSZWdFeHAsQXJyYXldLHluPXtLZWVwQWxpdmU6e25hbWU6ImtlZXAtYWxpdmUiLGFic3RyYWN0OiEwLHByb3BzOntpbmNsdWRlOm1uLGV4Y2x1ZGU6bW4sbWF4OltTdHJpbmcsTnVtYmVyXX0sY3JlYXRlZDpmdW5jdGlvbigpe3RoaXMuY2FjaGU9T2JqZWN0LmNyZWF0ZShudWxsKSx0aGlzLmtleXM9W119LGRlc3Ryb3llZDpmdW5jdGlvbigpe2Zvcih2YXIgZSBpbiB0aGlzLmNhY2hlKWhuKHRoaXMuY2FjaGUsZSx0aGlzLmtleXMpfSxtb3VudGVkOmZ1bmN0aW9uKCl7dmFyIGU9dGhpczt0aGlzLiR3YXRjaCgiaW5jbHVkZSIsZnVuY3Rpb24odCl7dm4oZSxmdW5jdGlvbihlKXtyZXR1cm4gZG4odCxlKX0pfSksdGhpcy4kd2F0Y2goImV4Y2x1ZGUiLGZ1bmN0aW9uKHQpe3ZuKGUsZnVuY3Rpb24oZSl7cmV0dXJuIWRuKHQsZSl9KX0pfSxyZW5kZXI6ZnVuY3Rpb24oKXt2YXIgZT10aGlzLiRzbG90cy5kZWZhdWx0LHQ9c3QoZSksbj10JiZ0LmNvbXBvbmVudE9wdGlvbnM7aWYobil7dmFyIHI9cG4obiksaT10aGlzLmluY2x1ZGUsbz10aGlzLmV4Y2x1ZGU7aWYoaSYmKCFyfHwhZG4oaSxyKSl8fG8mJnImJmRuKG8scikpcmV0dXJuIHQ7dmFyIGE9dGhpcy5jYWNoZSxzPXRoaXMua2V5cyxjPW51bGw9PXQua2V5P24uQ3Rvci5jaWQrKG4udGFnPyI6OiIrbi50YWc6IiIpOnQua2V5O2FbY10/KHQuY29tcG9uZW50SW5zdGFuY2U9YVtjXS5jb21wb25lbnRJbnN0YW5jZSx2KHMsYykscy5wdXNoKGMpKTooYVtjXT10LHMucHVzaChjKSx0aGlzLm1heCYmcy5sZW5ndGg+cGFyc2VJbnQodGhpcy5tYXgpJiZobihhLHNbMF0scyx0aGlzLl92bm9kZSkpLHQuZGF0YS5rZWVwQWxpdmU9ITB9cmV0dXJuIHR8fGUmJmVbMF19fX07IWZ1bmN0aW9uKGUpe3ZhciB0PXtnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gRH19O09iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCJjb25maWciLHQpLGUudXRpbD17d2FybjpyZSxleHRlbmQ6ayxtZXJnZU9wdGlvbnM6TmUsZGVmaW5lUmVhY3RpdmU6JGV9LGUuc2V0PXdlLGUuZGVsZXRlPUNlLGUubmV4dFRpY2s9V2UsZS5vcHRpb25zPU9iamVjdC5jcmVhdGUobnVsbCksTC5mb3JFYWNoKGZ1bmN0aW9uKHQpe2Uub3B0aW9uc1t0KyJzIl09T2JqZWN0LmNyZWF0ZShudWxsKX0pLGUub3B0aW9ucy5fYmFzZT1lLGsoZS5vcHRpb25zLmNvbXBvbmVudHMseW4pLGZ1bmN0aW9uKGUpe2UudXNlPWZ1bmN0aW9uKGUpe3ZhciB0PXRoaXMuX2luc3RhbGxlZFBsdWdpbnN8fCh0aGlzLl9pbnN0YWxsZWRQbHVnaW5zPVtdKTtpZih0LmluZGV4T2YoZSk+LTEpcmV0dXJuIHRoaXM7dmFyIG49eChhcmd1bWVudHMsMSk7cmV0dXJuIG4udW5zaGlmdCh0aGlzKSwiZnVuY3Rpb24iPT10eXBlb2YgZS5pbnN0YWxsP2UuaW5zdGFsbC5hcHBseShlLG4pOiJmdW5jdGlvbiI9PXR5cGVvZiBlJiZlLmFwcGx5KG51bGwsbiksdC5wdXNoKGUpLHRoaXN9fShlKSxmdW5jdGlvbihlKXtlLm1peGluPWZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLm9wdGlvbnM9TmUodGhpcy5vcHRpb25zLGUpLHRoaXN9fShlKSxmbihlKSxmdW5jdGlvbihlKXtMLmZvckVhY2goZnVuY3Rpb24odCl7ZVt0XT1mdW5jdGlvbihlLG4pe3JldHVybiBuPygiY29tcG9uZW50Ij09PXQmJnMobikmJihuLm5hbWU9bi5uYW1lfHxlLG49dGhpcy5vcHRpb25zLl9iYXNlLmV4dGVuZChuKSksImRpcmVjdGl2ZSI9PT10JiYiZnVuY3Rpb24iPT10eXBlb2YgbiYmKG49e2JpbmQ6bix1cGRhdGU6bn0pLHRoaXMub3B0aW9uc1t0KyJzIl1bZV09bixuKTp0aGlzLm9wdGlvbnNbdCsicyJdW2VdfX0pfShlKX0obG4pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShsbi5wcm90b3R5cGUsIiRpc1NlcnZlciIse2dldDpZfSksT2JqZWN0LmRlZmluZVByb3BlcnR5KGxuLnByb3RvdHlwZSwiJHNzckNvbnRleHQiLHtnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy4kdm5vZGUmJnRoaXMuJHZub2RlLnNzckNvbnRleHR9fSksT2JqZWN0LmRlZmluZVByb3BlcnR5KGxuLCJGdW5jdGlvbmFsUmVuZGVyQ29udGV4dCIse3ZhbHVlOlp0fSksbG4udmVyc2lvbj0iMi41LjIxIjt2YXIgZ249Zigic3R5bGUsY2xhc3MiKSxfbj1mKCJpbnB1dCx0ZXh0YXJlYSxvcHRpb24sc2VsZWN0LHByb2dyZXNzIiksYm49ZnVuY3Rpb24oZSx0LG4pe3JldHVybiJ2YWx1ZSI9PT1uJiZfbihlKSYmImJ1dHRvbiIhPT10fHwic2VsZWN0ZWQiPT09biYmIm9wdGlvbiI9PT1lfHwiY2hlY2tlZCI9PT1uJiYiaW5wdXQiPT09ZXx8Im11dGVkIj09PW4mJiJ2aWRlbyI9PT1lfSwkbj1mKCJjb250ZW50ZWRpdGFibGUsZHJhZ2dhYmxlLHNwZWxsY2hlY2siKSx3bj1mKCJhbGxvd2Z1bGxzY3JlZW4sYXN5bmMsYXV0b2ZvY3VzLGF1dG9wbGF5LGNoZWNrZWQsY29tcGFjdCxjb250cm9scyxkZWNsYXJlLGRlZmF1bHQsZGVmYXVsdGNoZWNrZWQsZGVmYXVsdG11dGVkLGRlZmF1bHRzZWxlY3RlZCxkZWZlcixkaXNhYmxlZCxlbmFibGVkLGZvcm1ub3ZhbGlkYXRlLGhpZGRlbixpbmRldGVybWluYXRlLGluZXJ0LGlzbWFwLGl0ZW1zY29wZSxsb29wLG11bHRpcGxlLG11dGVkLG5vaHJlZixub3Jlc2l6ZSxub3NoYWRlLG5vdmFsaWRhdGUsbm93cmFwLG9wZW4scGF1c2VvbmV4aXQscmVhZG9ubHkscmVxdWlyZWQscmV2ZXJzZWQsc2NvcGVkLHNlYW1sZXNzLHNlbGVjdGVkLHNvcnRhYmxlLHRyYW5zbGF0ZSx0cnVlc3BlZWQsdHlwZW11c3RtYXRjaCx2aXNpYmxlIiksQ249Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLHhuPWZ1bmN0aW9uKGUpe3JldHVybiI6Ij09PWUuY2hhckF0KDUpJiYieGxpbmsiPT09ZS5zbGljZSgwLDUpfSxrbj1mdW5jdGlvbihlKXtyZXR1cm4geG4oZSk/ZS5zbGljZSg2LGUubGVuZ3RoKToiIn0sQW49ZnVuY3Rpb24oZSl7cmV0dXJuIG51bGw9PWV8fCExPT09ZX07ZnVuY3Rpb24gT24oZSl7Zm9yKHZhciB0PWUuZGF0YSxyPWUsaT1lO24oaS5jb21wb25lbnRJbnN0YW5jZSk7KShpPWkuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlKSYmaS5kYXRhJiYodD1TbihpLmRhdGEsdCkpO2Zvcig7bihyPXIucGFyZW50KTspciYmci5kYXRhJiYodD1Tbih0LHIuZGF0YSkpO3JldHVybiBmdW5jdGlvbihlLHQpe2lmKG4oZSl8fG4odCkpcmV0dXJuIFRuKGUsTm4odCkpO3JldHVybiIifSh0LnN0YXRpY0NsYXNzLHQuY2xhc3MpfWZ1bmN0aW9uIFNuKGUsdCl7cmV0dXJue3N0YXRpY0NsYXNzOlRuKGUuc3RhdGljQ2xhc3MsdC5zdGF0aWNDbGFzcyksY2xhc3M6bihlLmNsYXNzKT9bZS5jbGFzcyx0LmNsYXNzXTp0LmNsYXNzfX1mdW5jdGlvbiBUbihlLHQpe3JldHVybiBlP3Q/ZSsiICIrdDplOnR8fCIifWZ1bmN0aW9uIE5uKGUpe3JldHVybiBBcnJheS5pc0FycmF5KGUpP2Z1bmN0aW9uKGUpe2Zvcih2YXIgdCxyPSIiLGk9MCxvPWUubGVuZ3RoO2k8bztpKyspbih0PU5uKGVbaV0pKSYmIiIhPT10JiYociYmKHIrPSIgIikscis9dCk7cmV0dXJuIHJ9KGUpOm8oZSk/ZnVuY3Rpb24oZSl7dmFyIHQ9IiI7Zm9yKHZhciBuIGluIGUpZVtuXSYmKHQmJih0Kz0iICIpLHQrPW4pO3JldHVybiB0fShlKToic3RyaW5nIj09dHlwZW9mIGU/ZToiIn12YXIgam49e3N2ZzoiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciLG1hdGg6Imh0dHA6Ly93d3cudzMub3JnLzE5OTgvTWF0aC9NYXRoTUwifSxFbj1mKCJodG1sLGJvZHksYmFzZSxoZWFkLGxpbmssbWV0YSxzdHlsZSx0aXRsZSxhZGRyZXNzLGFydGljbGUsYXNpZGUsZm9vdGVyLGhlYWRlcixoMSxoMixoMyxoNCxoNSxoNixoZ3JvdXAsbmF2LHNlY3Rpb24sZGl2LGRkLGRsLGR0LGZpZ2NhcHRpb24sZmlndXJlLHBpY3R1cmUsaHIsaW1nLGxpLG1haW4sb2wscCxwcmUsdWwsYSxiLGFiYnIsYmRpLGJkbyxicixjaXRlLGNvZGUsZGF0YSxkZm4sZW0saSxrYmQsbWFyayxxLHJwLHJ0LHJ0YyxydWJ5LHMsc2FtcCxzbWFsbCxzcGFuLHN0cm9uZyxzdWIsc3VwLHRpbWUsdSx2YXIsd2JyLGFyZWEsYXVkaW8sbWFwLHRyYWNrLHZpZGVvLGVtYmVkLG9iamVjdCxwYXJhbSxzb3VyY2UsY2FudmFzLHNjcmlwdCxub3NjcmlwdCxkZWwsaW5zLGNhcHRpb24sY29sLGNvbGdyb3VwLHRhYmxlLHRoZWFkLHRib2R5LHRkLHRoLHRyLGJ1dHRvbixkYXRhbGlzdCxmaWVsZHNldCxmb3JtLGlucHV0LGxhYmVsLGxlZ2VuZCxtZXRlcixvcHRncm91cCxvcHRpb24sb3V0cHV0LHByb2dyZXNzLHNlbGVjdCx0ZXh0YXJlYSxkZXRhaWxzLGRpYWxvZyxtZW51LG1lbnVpdGVtLHN1bW1hcnksY29udGVudCxlbGVtZW50LHNoYWRvdyx0ZW1wbGF0ZSxibG9ja3F1b3RlLGlmcmFtZSx0Zm9vdCIpLEluPWYoInN2ZyxhbmltYXRlLGNpcmNsZSxjbGlwcGF0aCxjdXJzb3IsZGVmcyxkZXNjLGVsbGlwc2UsZmlsdGVyLGZvbnQtZmFjZSxmb3JlaWduT2JqZWN0LGcsZ2x5cGgsaW1hZ2UsbGluZSxtYXJrZXIsbWFzayxtaXNzaW5nLWdseXBoLHBhdGgscGF0dGVybixwb2x5Z29uLHBvbHlsaW5lLHJlY3Qsc3dpdGNoLHN5bWJvbCx0ZXh0LHRleHRwYXRoLHRzcGFuLHVzZSx2aWV3IiwhMCksTG49ZnVuY3Rpb24oZSl7cmV0dXJuIEVuKGUpfHxJbihlKX07ZnVuY3Rpb24gTW4oZSl7cmV0dXJuIEluKGUpPyJzdmciOiJtYXRoIj09PWU/Im1hdGgiOnZvaWQgMH12YXIgRG49T2JqZWN0LmNyZWF0ZShudWxsKTt2YXIgUG49ZigidGV4dCxudW1iZXIscGFzc3dvcmQsc2VhcmNoLGVtYWlsLHRlbCx1cmwiKTtmdW5jdGlvbiBGbihlKXtpZigic3RyaW5nIj09dHlwZW9mIGUpe3ZhciB0PWRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoZSk7cmV0dXJuIHR8fGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpfXJldHVybiBlfXZhciBSbj1PYmplY3QuZnJlZXplKHtjcmVhdGVFbGVtZW50OmZ1bmN0aW9uKGUsdCl7dmFyIG49ZG9jdW1lbnQuY3JlYXRlRWxlbWVudChlKTtyZXR1cm4ic2VsZWN0IiE9PWU/bjoodC5kYXRhJiZ0LmRhdGEuYXR0cnMmJnZvaWQgMCE9PXQuZGF0YS5hdHRycy5tdWx0aXBsZSYmbi5zZXRBdHRyaWJ1dGUoIm11bHRpcGxlIiwibXVsdGlwbGUiKSxuKX0sY3JlYXRlRWxlbWVudE5TOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhqbltlXSx0KX0sY3JlYXRlVGV4dE5vZGU6ZnVuY3Rpb24oZSl7cmV0dXJuIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGUpfSxjcmVhdGVDb21tZW50OmZ1bmN0aW9uKGUpe3JldHVybiBkb2N1bWVudC5jcmVhdGVDb21tZW50KGUpfSxpbnNlcnRCZWZvcmU6ZnVuY3Rpb24oZSx0LG4pe2UuaW5zZXJ0QmVmb3JlKHQsbil9LHJlbW92ZUNoaWxkOmZ1bmN0aW9uKGUsdCl7ZS5yZW1vdmVDaGlsZCh0KX0sYXBwZW5kQ2hpbGQ6ZnVuY3Rpb24oZSx0KXtlLmFwcGVuZENoaWxkKHQpfSxwYXJlbnROb2RlOmZ1bmN0aW9uKGUpe3JldHVybiBlLnBhcmVudE5vZGV9LG5leHRTaWJsaW5nOmZ1bmN0aW9uKGUpe3JldHVybiBlLm5leHRTaWJsaW5nfSx0YWdOYW1lOmZ1bmN0aW9uKGUpe3JldHVybiBlLnRhZ05hbWV9LHNldFRleHRDb250ZW50OmZ1bmN0aW9uKGUsdCl7ZS50ZXh0Q29udGVudD10fSxzZXRTdHlsZVNjb3BlOmZ1bmN0aW9uKGUsdCl7ZS5zZXRBdHRyaWJ1dGUodCwiIil9fSksSG49e2NyZWF0ZTpmdW5jdGlvbihlLHQpe0JuKHQpfSx1cGRhdGU6ZnVuY3Rpb24oZSx0KXtlLmRhdGEucmVmIT09dC5kYXRhLnJlZiYmKEJuKGUsITApLEJuKHQpKX0sZGVzdHJveTpmdW5jdGlvbihlKXtCbihlLCEwKX19O2Z1bmN0aW9uIEJuKGUsdCl7dmFyIHI9ZS5kYXRhLnJlZjtpZihuKHIpKXt2YXIgaT1lLmNvbnRleHQsbz1lLmNvbXBvbmVudEluc3RhbmNlfHxlLmVsbSxhPWkuJHJlZnM7dD9BcnJheS5pc0FycmF5KGFbcl0pP3YoYVtyXSxvKTphW3JdPT09byYmKGFbcl09dm9pZCAwKTplLmRhdGEucmVmSW5Gb3I/QXJyYXkuaXNBcnJheShhW3JdKT9hW3JdLmluZGV4T2Yobyk8MCYmYVtyXS5wdXNoKG8pOmFbcl09W29dOmFbcl09b319dmFyIFVuPW5ldyB1ZSgiIix7fSxbXSksVm49WyJjcmVhdGUiLCJhY3RpdmF0ZSIsInVwZGF0ZSIsInJlbW92ZSIsImRlc3Ryb3kiXTtmdW5jdGlvbiB6bihlLGkpe3JldHVybiBlLmtleT09PWkua2V5JiYoZS50YWc9PT1pLnRhZyYmZS5pc0NvbW1lbnQ9PT1pLmlzQ29tbWVudCYmbihlLmRhdGEpPT09bihpLmRhdGEpJiZmdW5jdGlvbihlLHQpe2lmKCJpbnB1dCIhPT1lLnRhZylyZXR1cm4hMDt2YXIgcixpPW4ocj1lLmRhdGEpJiZuKHI9ci5hdHRycykmJnIudHlwZSxvPW4ocj10LmRhdGEpJiZuKHI9ci5hdHRycykmJnIudHlwZTtyZXR1cm4gaT09PW98fFBuKGkpJiZQbihvKX0oZSxpKXx8cihlLmlzQXN5bmNQbGFjZWhvbGRlcikmJmUuYXN5bmNGYWN0b3J5PT09aS5hc3luY0ZhY3RvcnkmJnQoaS5hc3luY0ZhY3RvcnkuZXJyb3IpKX1mdW5jdGlvbiBLbihlLHQscil7dmFyIGksbyxhPXt9O2ZvcihpPXQ7aTw9cjsrK2kpbihvPWVbaV0ua2V5KSYmKGFbb109aSk7cmV0dXJuIGF9dmFyIEpuPXtjcmVhdGU6cW4sdXBkYXRlOnFuLGRlc3Ryb3k6ZnVuY3Rpb24oZSl7cW4oZSxVbil9fTtmdW5jdGlvbiBxbihlLHQpeyhlLmRhdGEuZGlyZWN0aXZlc3x8dC5kYXRhLmRpcmVjdGl2ZXMpJiZmdW5jdGlvbihlLHQpe3ZhciBuLHIsaSxvPWU9PT1VbixhPXQ9PT1VbixzPUduKGUuZGF0YS5kaXJlY3RpdmVzLGUuY29udGV4dCksYz1Hbih0LmRhdGEuZGlyZWN0aXZlcyx0LmNvbnRleHQpLHU9W10sbD1bXTtmb3IobiBpbiBjKXI9c1tuXSxpPWNbbl0scj8oaS5vbGRWYWx1ZT1yLnZhbHVlLFhuKGksInVwZGF0ZSIsdCxlKSxpLmRlZiYmaS5kZWYuY29tcG9uZW50VXBkYXRlZCYmbC5wdXNoKGkpKTooWG4oaSwiYmluZCIsdCxlKSxpLmRlZiYmaS5kZWYuaW5zZXJ0ZWQmJnUucHVzaChpKSk7aWYodS5sZW5ndGgpe3ZhciBmPWZ1bmN0aW9uKCl7Zm9yKHZhciBuPTA7bjx1Lmxlbmd0aDtuKyspWG4odVtuXSwiaW5zZXJ0ZWQiLHQsZSl9O28/dHQodCwiaW5zZXJ0IixmKTpmKCl9bC5sZW5ndGgmJnR0KHQsInBvc3RwYXRjaCIsZnVuY3Rpb24oKXtmb3IodmFyIG49MDtuPGwubGVuZ3RoO24rKylYbihsW25dLCJjb21wb25lbnRVcGRhdGVkIix0LGUpfSk7aWYoIW8pZm9yKG4gaW4gcyljW25dfHxYbihzW25dLCJ1bmJpbmQiLGUsZSxhKX0oZSx0KX12YXIgV249T2JqZWN0LmNyZWF0ZShudWxsKTtmdW5jdGlvbiBHbihlLHQpe3ZhciBuLHIsaT1PYmplY3QuY3JlYXRlKG51bGwpO2lmKCFlKXJldHVybiBpO2ZvcihuPTA7bjxlLmxlbmd0aDtuKyspKHI9ZVtuXSkubW9kaWZpZXJzfHwoci5tb2RpZmllcnM9V24pLGlbWm4ocildPXIsci5kZWY9amUodC4kb3B0aW9ucywiZGlyZWN0aXZlcyIsci5uYW1lKTtyZXR1cm4gaX1mdW5jdGlvbiBabihlKXtyZXR1cm4gZS5yYXdOYW1lfHxlLm5hbWUrIi4iK09iamVjdC5rZXlzKGUubW9kaWZpZXJzfHx7fSkuam9pbigiLiIpfWZ1bmN0aW9uIFhuKGUsdCxuLHIsaSl7dmFyIG89ZS5kZWYmJmUuZGVmW3RdO2lmKG8pdHJ5e28obi5lbG0sZSxuLHIsaSl9Y2F0Y2gocil7RGUocixuLmNvbnRleHQsImRpcmVjdGl2ZSAiK2UubmFtZSsiICIrdCsiIGhvb2siKX19dmFyIFluPVtIbixKbl07ZnVuY3Rpb24gUW4oZSxyKXt2YXIgaT1yLmNvbXBvbmVudE9wdGlvbnM7aWYoIShuKGkpJiYhMT09PWkuQ3Rvci5vcHRpb25zLmluaGVyaXRBdHRyc3x8dChlLmRhdGEuYXR0cnMpJiZ0KHIuZGF0YS5hdHRycykpKXt2YXIgbyxhLHM9ci5lbG0sYz1lLmRhdGEuYXR0cnN8fHt9LHU9ci5kYXRhLmF0dHJzfHx7fTtmb3IobyBpbiBuKHUuX19vYl9fKSYmKHU9ci5kYXRhLmF0dHJzPWsoe30sdSkpLHUpYT11W29dLGNbb10hPT1hJiZlcihzLG8sYSk7Zm9yKG8gaW4oS3x8cSkmJnUudmFsdWUhPT1jLnZhbHVlJiZlcihzLCJ2YWx1ZSIsdS52YWx1ZSksYyl0KHVbb10pJiYoeG4obyk/cy5yZW1vdmVBdHRyaWJ1dGVOUyhDbixrbihvKSk6JG4obyl8fHMucmVtb3ZlQXR0cmlidXRlKG8pKX19ZnVuY3Rpb24gZXIoZSx0LG4pe2UudGFnTmFtZS5pbmRleE9mKCItIik+LTE/dHIoZSx0LG4pOnduKHQpP0FuKG4pP2UucmVtb3ZlQXR0cmlidXRlKHQpOihuPSJhbGxvd2Z1bGxzY3JlZW4iPT09dCYmIkVNQkVEIj09PWUudGFnTmFtZT8idHJ1ZSI6dCxlLnNldEF0dHJpYnV0ZSh0LG4pKTokbih0KT9lLnNldEF0dHJpYnV0ZSh0LEFuKG4pfHwiZmFsc2UiPT09bj8iZmFsc2UiOiJ0cnVlIik6eG4odCk/QW4obik/ZS5yZW1vdmVBdHRyaWJ1dGVOUyhDbixrbih0KSk6ZS5zZXRBdHRyaWJ1dGVOUyhDbix0LG4pOnRyKGUsdCxuKX1mdW5jdGlvbiB0cihlLHQsbil7aWYoQW4obikpZS5yZW1vdmVBdHRyaWJ1dGUodCk7ZWxzZXtpZihLJiYhSiYmKCJURVhUQVJFQSI9PT1lLnRhZ05hbWV8fCJJTlBVVCI9PT1lLnRhZ05hbWUpJiYicGxhY2Vob2xkZXIiPT09dCYmIWUuX19pZXBoKXt2YXIgcj1mdW5jdGlvbih0KXt0LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpLGUucmVtb3ZlRXZlbnRMaXN0ZW5lcigiaW5wdXQiLHIpfTtlLmFkZEV2ZW50TGlzdGVuZXIoImlucHV0IixyKSxlLl9faWVwaD0hMH1lLnNldEF0dHJpYnV0ZSh0LG4pfX12YXIgbnI9e2NyZWF0ZTpRbix1cGRhdGU6UW59O2Z1bmN0aW9uIHJyKGUscil7dmFyIGk9ci5lbG0sbz1yLmRhdGEsYT1lLmRhdGE7aWYoISh0KG8uc3RhdGljQ2xhc3MpJiZ0KG8uY2xhc3MpJiYodChhKXx8dChhLnN0YXRpY0NsYXNzKSYmdChhLmNsYXNzKSkpKXt2YXIgcz1PbihyKSxjPWkuX3RyYW5zaXRpb25DbGFzc2VzO24oYykmJihzPVRuKHMsTm4oYykpKSxzIT09aS5fcHJldkNsYXNzJiYoaS5zZXRBdHRyaWJ1dGUoImNsYXNzIixzKSxpLl9wcmV2Q2xhc3M9cyl9fXZhciBpcixvcixhcixzcixjcix1cixscj17Y3JlYXRlOnJyLHVwZGF0ZTpycn0sZnI9L1tcdykuK1wtXyRcXV0vO2Z1bmN0aW9uIHByKGUpe3ZhciB0LG4scixpLG8sYT0hMSxzPSExLGM9ITEsdT0hMSxsPTAsZj0wLHA9MCxkPTA7Zm9yKHI9MDtyPGUubGVuZ3RoO3IrKylpZihuPXQsdD1lLmNoYXJDb2RlQXQociksYSkzOT09PXQmJjkyIT09biYmKGE9ITEpO2Vsc2UgaWYocykzND09PXQmJjkyIT09biYmKHM9ITEpO2Vsc2UgaWYoYyk5Nj09PXQmJjkyIT09biYmKGM9ITEpO2Vsc2UgaWYodSk0Nz09PXQmJjkyIT09biYmKHU9ITEpO2Vsc2UgaWYoMTI0IT09dHx8MTI0PT09ZS5jaGFyQ29kZUF0KHIrMSl8fDEyND09PWUuY2hhckNvZGVBdChyLTEpfHxsfHxmfHxwKXtzd2l0Y2godCl7Y2FzZSAzNDpzPSEwO2JyZWFrO2Nhc2UgMzk6YT0hMDticmVhaztjYXNlIDk2OmM9ITA7YnJlYWs7Y2FzZSA0MDpwKys7YnJlYWs7Y2FzZSA0MTpwLS07YnJlYWs7Y2FzZSA5MTpmKys7YnJlYWs7Y2FzZSA5MzpmLS07YnJlYWs7Y2FzZSAxMjM6bCsrO2JyZWFrO2Nhc2UgMTI1OmwtLX1pZig0Nz09PXQpe2Zvcih2YXIgdj1yLTEsaD12b2lkIDA7dj49MCYmIiAiPT09KGg9ZS5jaGFyQXQodikpO3YtLSk7aCYmZnIudGVzdChoKXx8KHU9ITApfX1lbHNlIHZvaWQgMD09PWk/KGQ9cisxLGk9ZS5zbGljZSgwLHIpLnRyaW0oKSk6bSgpO2Z1bmN0aW9uIG0oKXsob3x8KG89W10pKS5wdXNoKGUuc2xpY2UoZCxyKS50cmltKCkpLGQ9cisxfWlmKHZvaWQgMD09PWk/aT1lLnNsaWNlKDAscikudHJpbSgpOjAhPT1kJiZtKCksbylmb3Iocj0wO3I8by5sZW5ndGg7cisrKWk9ZHIoaSxvW3JdKTtyZXR1cm4gaX1mdW5jdGlvbiBkcihlLHQpe3ZhciBuPXQuaW5kZXhPZigiKCIpO2lmKG48MClyZXR1cm4nX2YoIicrdCsnIikoJytlKyIpIjt2YXIgcj10LnNsaWNlKDAsbiksaT10LnNsaWNlKG4rMSk7cmV0dXJuJ19mKCInK3IrJyIpKCcrZSsoIikiIT09aT8iLCIraTppKX1mdW5jdGlvbiB2cihlKXtjb25zb2xlLmVycm9yKCJbVnVlIGNvbXBpbGVyXTogIitlKX1mdW5jdGlvbiBocihlLHQpe3JldHVybiBlP2UubWFwKGZ1bmN0aW9uKGUpe3JldHVybiBlW3RdfSkuZmlsdGVyKGZ1bmN0aW9uKGUpe3JldHVybiBlfSk6W119ZnVuY3Rpb24gbXIoZSx0LG4peyhlLnByb3BzfHwoZS5wcm9wcz1bXSkpLnB1c2goe25hbWU6dCx2YWx1ZTpufSksZS5wbGFpbj0hMX1mdW5jdGlvbiB5cihlLHQsbil7KGUuYXR0cnN8fChlLmF0dHJzPVtdKSkucHVzaCh7bmFtZTp0LHZhbHVlOm59KSxlLnBsYWluPSExfWZ1bmN0aW9uIGdyKGUsdCxuKXtlLmF0dHJzTWFwW3RdPW4sZS5hdHRyc0xpc3QucHVzaCh7bmFtZTp0LHZhbHVlOm59KX1mdW5jdGlvbiBfcihlLHQsbixyLGksbyl7KGUuZGlyZWN0aXZlc3x8KGUuZGlyZWN0aXZlcz1bXSkpLnB1c2goe25hbWU6dCxyYXdOYW1lOm4sdmFsdWU6cixhcmc6aSxtb2RpZmllcnM6b30pLGUucGxhaW49ITF9ZnVuY3Rpb24gYnIodCxuLHIsaSxvLGEpe3ZhciBzO2k9aXx8ZSwiY2xpY2siPT09biYmKGkucmlnaHQ/KG49ImNvbnRleHRtZW51IixkZWxldGUgaS5yaWdodCk6aS5taWRkbGUmJihuPSJtb3VzZXVwIikpLGkuY2FwdHVyZSYmKGRlbGV0ZSBpLmNhcHR1cmUsbj0iISIrbiksaS5vbmNlJiYoZGVsZXRlIGkub25jZSxuPSJ+IituKSxpLnBhc3NpdmUmJihkZWxldGUgaS5wYXNzaXZlLG49IiYiK24pLGkubmF0aXZlPyhkZWxldGUgaS5uYXRpdmUscz10Lm5hdGl2ZUV2ZW50c3x8KHQubmF0aXZlRXZlbnRzPXt9KSk6cz10LmV2ZW50c3x8KHQuZXZlbnRzPXt9KTt2YXIgYz17dmFsdWU6ci50cmltKCl9O2khPT1lJiYoYy5tb2RpZmllcnM9aSk7dmFyIHU9c1tuXTtBcnJheS5pc0FycmF5KHUpP28/dS51bnNoaWZ0KGMpOnUucHVzaChjKTpzW25dPXU/bz9bYyx1XTpbdSxjXTpjLHQucGxhaW49ITF9ZnVuY3Rpb24gJHIoZSx0LG4pe3ZhciByPXdyKGUsIjoiK3QpfHx3cihlLCJ2LWJpbmQ6Iit0KTtpZihudWxsIT1yKXJldHVybiBwcihyKTtpZighMSE9PW4pe3ZhciBpPXdyKGUsdCk7aWYobnVsbCE9aSlyZXR1cm4gSlNPTi5zdHJpbmdpZnkoaSl9fWZ1bmN0aW9uIHdyKGUsdCxuKXt2YXIgcjtpZihudWxsIT0ocj1lLmF0dHJzTWFwW3RdKSlmb3IodmFyIGk9ZS5hdHRyc0xpc3Qsbz0wLGE9aS5sZW5ndGg7bzxhO28rKylpZihpW29dLm5hbWU9PT10KXtpLnNwbGljZShvLDEpO2JyZWFrfXJldHVybiBuJiZkZWxldGUgZS5hdHRyc01hcFt0XSxyfWZ1bmN0aW9uIENyKGUsdCxuKXt2YXIgcj1ufHx7fSxpPXIubnVtYmVyLG89IiQkdiI7ci50cmltJiYobz0iKHR5cGVvZiAkJHYgPT09ICdzdHJpbmcnPyAkJHYudHJpbSgpOiAkJHYpIiksaSYmKG89Il9uKCIrbysiKSIpO3ZhciBhPXhyKHQsbyk7ZS5tb2RlbD17dmFsdWU6IigiK3QrIikiLGV4cHJlc3Npb246SlNPTi5zdHJpbmdpZnkodCksY2FsbGJhY2s6ImZ1bmN0aW9uICgkJHYpIHsiK2ErIn0ifX1mdW5jdGlvbiB4cihlLHQpe3ZhciBuPWZ1bmN0aW9uKGUpe2lmKGU9ZS50cmltKCksaXI9ZS5sZW5ndGgsZS5pbmRleE9mKCJbIik8MHx8ZS5sYXN0SW5kZXhPZigiXSIpPGlyLTEpcmV0dXJuKHNyPWUubGFzdEluZGV4T2YoIi4iKSk+LTE/e2V4cDplLnNsaWNlKDAsc3IpLGtleTonIicrZS5zbGljZShzcisxKSsnIid9OntleHA6ZSxrZXk6bnVsbH07b3I9ZSxzcj1jcj11cj0wO2Zvcig7IUFyKCk7KU9yKGFyPWtyKCkpP1RyKGFyKTo5MT09PWFyJiZTcihhcik7cmV0dXJue2V4cDplLnNsaWNlKDAsY3IpLGtleTplLnNsaWNlKGNyKzEsdXIpfX0oZSk7cmV0dXJuIG51bGw9PT1uLmtleT9lKyI9Iit0OiIkc2V0KCIrbi5leHArIiwgIituLmtleSsiLCAiK3QrIikifWZ1bmN0aW9uIGtyKCl7cmV0dXJuIG9yLmNoYXJDb2RlQXQoKytzcil9ZnVuY3Rpb24gQXIoKXtyZXR1cm4gc3I+PWlyfWZ1bmN0aW9uIE9yKGUpe3JldHVybiAzND09PWV8fDM5PT09ZX1mdW5jdGlvbiBTcihlKXt2YXIgdD0xO2Zvcihjcj1zcjshQXIoKTspaWYoT3IoZT1rcigpKSlUcihlKTtlbHNlIGlmKDkxPT09ZSYmdCsrLDkzPT09ZSYmdC0tLDA9PT10KXt1cj1zcjticmVha319ZnVuY3Rpb24gVHIoZSl7Zm9yKHZhciB0PWU7IUFyKCkmJihlPWtyKCkpIT09dDspO312YXIgTnIsanI9Il9fciIsRXI9Il9fYyI7ZnVuY3Rpb24gSXIoZSx0LG4pe3ZhciByPU5yO3JldHVybiBmdW5jdGlvbiBpKCl7bnVsbCE9PXQuYXBwbHkobnVsbCxhcmd1bWVudHMpJiZNcihlLGksbixyKX19ZnVuY3Rpb24gTHIoZSx0LG4scil7dmFyIGk7dD0oaT10KS5fd2l0aFRhc2t8fChpLl93aXRoVGFzaz1mdW5jdGlvbigpe3plPSEwO3RyeXtyZXR1cm4gaS5hcHBseShudWxsLGFyZ3VtZW50cyl9ZmluYWxseXt6ZT0hMX19KSxOci5hZGRFdmVudExpc3RlbmVyKGUsdCxaP3tjYXB0dXJlOm4scGFzc2l2ZTpyfTpuKX1mdW5jdGlvbiBNcihlLHQsbixyKXsocnx8TnIpLnJlbW92ZUV2ZW50TGlzdGVuZXIoZSx0Ll93aXRoVGFza3x8dCxuKX1mdW5jdGlvbiBEcihlLHIpe2lmKCF0KGUuZGF0YS5vbil8fCF0KHIuZGF0YS5vbikpe3ZhciBpPXIuZGF0YS5vbnx8e30sbz1lLmRhdGEub258fHt9O05yPXIuZWxtLGZ1bmN0aW9uKGUpe2lmKG4oZVtqcl0pKXt2YXIgdD1LPyJjaGFuZ2UiOiJpbnB1dCI7ZVt0XT1bXS5jb25jYXQoZVtqcl0sZVt0XXx8W10pLGRlbGV0ZSBlW2pyXX1uKGVbRXJdKSYmKGUuY2hhbmdlPVtdLmNvbmNhdChlW0VyXSxlLmNoYW5nZXx8W10pLGRlbGV0ZSBlW0VyXSl9KGkpLGV0KGksbyxMcixNcixJcixyLmNvbnRleHQpLE5yPXZvaWQgMH19dmFyIFByPXtjcmVhdGU6RHIsdXBkYXRlOkRyfTtmdW5jdGlvbiBGcihlLHIpe2lmKCF0KGUuZGF0YS5kb21Qcm9wcyl8fCF0KHIuZGF0YS5kb21Qcm9wcykpe3ZhciBpLG8sYT1yLmVsbSxzPWUuZGF0YS5kb21Qcm9wc3x8e30sYz1yLmRhdGEuZG9tUHJvcHN8fHt9O2ZvcihpIGluIG4oYy5fX29iX18pJiYoYz1yLmRhdGEuZG9tUHJvcHM9ayh7fSxjKSkscyl0KGNbaV0pJiYoYVtpXT0iIik7Zm9yKGkgaW4gYyl7aWYobz1jW2ldLCJ0ZXh0Q29udGVudCI9PT1pfHwiaW5uZXJIVE1MIj09PWkpe2lmKHIuY2hpbGRyZW4mJihyLmNoaWxkcmVuLmxlbmd0aD0wKSxvPT09c1tpXSljb250aW51ZTsxPT09YS5jaGlsZE5vZGVzLmxlbmd0aCYmYS5yZW1vdmVDaGlsZChhLmNoaWxkTm9kZXNbMF0pfWlmKCJ2YWx1ZSI9PT1pKXthLl92YWx1ZT1vO3ZhciB1PXQobyk/IiI6U3RyaW5nKG8pO1JyKGEsdSkmJihhLnZhbHVlPXUpfWVsc2UgYVtpXT1vfX19ZnVuY3Rpb24gUnIoZSx0KXtyZXR1cm4hZS5jb21wb3NpbmcmJigiT1BUSU9OIj09PWUudGFnTmFtZXx8ZnVuY3Rpb24oZSx0KXt2YXIgbj0hMDt0cnl7bj1kb2N1bWVudC5hY3RpdmVFbGVtZW50IT09ZX1jYXRjaChlKXt9cmV0dXJuIG4mJmUudmFsdWUhPT10fShlLHQpfHxmdW5jdGlvbihlLHQpe3ZhciByPWUudmFsdWUsaT1lLl92TW9kaWZpZXJzO2lmKG4oaSkpe2lmKGkubGF6eSlyZXR1cm4hMTtpZihpLm51bWJlcilyZXR1cm4gbChyKSE9PWwodCk7aWYoaS50cmltKXJldHVybiByLnRyaW0oKSE9PXQudHJpbSgpfXJldHVybiByIT09dH0oZSx0KSl9dmFyIEhyPXtjcmVhdGU6RnIsdXBkYXRlOkZyfSxCcj15KGZ1bmN0aW9uKGUpe3ZhciB0PXt9LG49LzooLispLztyZXR1cm4gZS5zcGxpdCgvOyg/IVteKF0qXCkpL2cpLmZvckVhY2goZnVuY3Rpb24oZSl7aWYoZSl7dmFyIHI9ZS5zcGxpdChuKTtyLmxlbmd0aD4xJiYodFtyWzBdLnRyaW0oKV09clsxXS50cmltKCkpfX0pLHR9KTtmdW5jdGlvbiBVcihlKXt2YXIgdD1WcihlLnN0eWxlKTtyZXR1cm4gZS5zdGF0aWNTdHlsZT9rKGUuc3RhdGljU3R5bGUsdCk6dH1mdW5jdGlvbiBWcihlKXtyZXR1cm4gQXJyYXkuaXNBcnJheShlKT9BKGUpOiJzdHJpbmciPT10eXBlb2YgZT9CcihlKTplfXZhciB6cixLcj0vXi0tLyxKcj0vXHMqIWltcG9ydGFudCQvLHFyPWZ1bmN0aW9uKGUsdCxuKXtpZihLci50ZXN0KHQpKWUuc3R5bGUuc2V0UHJvcGVydHkodCxuKTtlbHNlIGlmKEpyLnRlc3QobikpZS5zdHlsZS5zZXRQcm9wZXJ0eSh0LG4ucmVwbGFjZShKciwiIiksImltcG9ydGFudCIpO2Vsc2V7dmFyIHI9R3IodCk7aWYoQXJyYXkuaXNBcnJheShuKSlmb3IodmFyIGk9MCxvPW4ubGVuZ3RoO2k8bztpKyspZS5zdHlsZVtyXT1uW2ldO2Vsc2UgZS5zdHlsZVtyXT1ufX0sV3I9WyJXZWJraXQiLCJNb3oiLCJtcyJdLEdyPXkoZnVuY3Rpb24oZSl7aWYoenI9enJ8fGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLnN0eWxlLCJmaWx0ZXIiIT09KGU9XyhlKSkmJmUgaW4genIpcmV0dXJuIGU7Zm9yKHZhciB0PWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkrZS5zbGljZSgxKSxuPTA7bjxXci5sZW5ndGg7bisrKXt2YXIgcj1XcltuXSt0O2lmKHIgaW4genIpcmV0dXJuIHJ9fSk7ZnVuY3Rpb24gWnIoZSxyKXt2YXIgaT1yLmRhdGEsbz1lLmRhdGE7aWYoISh0KGkuc3RhdGljU3R5bGUpJiZ0KGkuc3R5bGUpJiZ0KG8uc3RhdGljU3R5bGUpJiZ0KG8uc3R5bGUpKSl7dmFyIGEscyxjPXIuZWxtLHU9by5zdGF0aWNTdHlsZSxsPW8ubm9ybWFsaXplZFN0eWxlfHxvLnN0eWxlfHx7fSxmPXV8fGwscD1WcihyLmRhdGEuc3R5bGUpfHx7fTtyLmRhdGEubm9ybWFsaXplZFN0eWxlPW4ocC5fX29iX18pP2soe30scCk6cDt2YXIgZD1mdW5jdGlvbihlLHQpe3ZhciBuLHI9e307aWYodClmb3IodmFyIGk9ZTtpLmNvbXBvbmVudEluc3RhbmNlOykoaT1pLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZSkmJmkuZGF0YSYmKG49VXIoaS5kYXRhKSkmJmsocixuKTsobj1VcihlLmRhdGEpKSYmayhyLG4pO2Zvcih2YXIgbz1lO289by5wYXJlbnQ7KW8uZGF0YSYmKG49VXIoby5kYXRhKSkmJmsocixuKTtyZXR1cm4gcn0ociwhMCk7Zm9yKHMgaW4gZil0KGRbc10pJiZxcihjLHMsIiIpO2ZvcihzIGluIGQpKGE9ZFtzXSkhPT1mW3NdJiZxcihjLHMsbnVsbD09YT8iIjphKX19dmFyIFhyPXtjcmVhdGU6WnIsdXBkYXRlOlpyfSxZcj0vXHMrLztmdW5jdGlvbiBRcihlLHQpe2lmKHQmJih0PXQudHJpbSgpKSlpZihlLmNsYXNzTGlzdCl0LmluZGV4T2YoIiAiKT4tMT90LnNwbGl0KFlyKS5mb3JFYWNoKGZ1bmN0aW9uKHQpe3JldHVybiBlLmNsYXNzTGlzdC5hZGQodCl9KTplLmNsYXNzTGlzdC5hZGQodCk7ZWxzZXt2YXIgbj0iICIrKGUuZ2V0QXR0cmlidXRlKCJjbGFzcyIpfHwiIikrIiAiO24uaW5kZXhPZigiICIrdCsiICIpPDAmJmUuc2V0QXR0cmlidXRlKCJjbGFzcyIsKG4rdCkudHJpbSgpKX19ZnVuY3Rpb24gZWkoZSx0KXtpZih0JiYodD10LnRyaW0oKSkpaWYoZS5jbGFzc0xpc3QpdC5pbmRleE9mKCIgIik+LTE/dC5zcGxpdChZcikuZm9yRWFjaChmdW5jdGlvbih0KXtyZXR1cm4gZS5jbGFzc0xpc3QucmVtb3ZlKHQpfSk6ZS5jbGFzc0xpc3QucmVtb3ZlKHQpLGUuY2xhc3NMaXN0Lmxlbmd0aHx8ZS5yZW1vdmVBdHRyaWJ1dGUoImNsYXNzIik7ZWxzZXtmb3IodmFyIG49IiAiKyhlLmdldEF0dHJpYnV0ZSgiY2xhc3MiKXx8IiIpKyIgIixyPSIgIit0KyIgIjtuLmluZGV4T2Yocik+PTA7KW49bi5yZXBsYWNlKHIsIiAiKTsobj1uLnRyaW0oKSk/ZS5zZXRBdHRyaWJ1dGUoImNsYXNzIixuKTplLnJlbW92ZUF0dHJpYnV0ZSgiY2xhc3MiKX19ZnVuY3Rpb24gdGkoZSl7aWYoZSl7aWYoIm9iamVjdCI9PXR5cGVvZiBlKXt2YXIgdD17fTtyZXR1cm4hMSE9PWUuY3NzJiZrKHQsbmkoZS5uYW1lfHwidiIpKSxrKHQsZSksdH1yZXR1cm4ic3RyaW5nIj09dHlwZW9mIGU/bmkoZSk6dm9pZCAwfX12YXIgbmk9eShmdW5jdGlvbihlKXtyZXR1cm57ZW50ZXJDbGFzczplKyItZW50ZXIiLGVudGVyVG9DbGFzczplKyItZW50ZXItdG8iLGVudGVyQWN0aXZlQ2xhc3M6ZSsiLWVudGVyLWFjdGl2ZSIsbGVhdmVDbGFzczplKyItbGVhdmUiLGxlYXZlVG9DbGFzczplKyItbGVhdmUtdG8iLGxlYXZlQWN0aXZlQ2xhc3M6ZSsiLWxlYXZlLWFjdGl2ZSJ9fSkscmk9QiYmIUosaWk9InRyYW5zaXRpb24iLG9pPSJhbmltYXRpb24iLGFpPSJ0cmFuc2l0aW9uIixzaT0idHJhbnNpdGlvbmVuZCIsY2k9ImFuaW1hdGlvbiIsdWk9ImFuaW1hdGlvbmVuZCI7cmkmJih2b2lkIDA9PT13aW5kb3cub250cmFuc2l0aW9uZW5kJiZ2b2lkIDAhPT13aW5kb3cub253ZWJraXR0cmFuc2l0aW9uZW5kJiYoYWk9IldlYmtpdFRyYW5zaXRpb24iLHNpPSJ3ZWJraXRUcmFuc2l0aW9uRW5kIiksdm9pZCAwPT09d2luZG93Lm9uYW5pbWF0aW9uZW5kJiZ2b2lkIDAhPT13aW5kb3cub253ZWJraXRhbmltYXRpb25lbmQmJihjaT0iV2Via2l0QW5pbWF0aW9uIix1aT0id2Via2l0QW5pbWF0aW9uRW5kIikpO3ZhciBsaT1CP3dpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWU/d2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZS5iaW5kKHdpbmRvdyk6c2V0VGltZW91dDpmdW5jdGlvbihlKXtyZXR1cm4gZSgpfTtmdW5jdGlvbiBmaShlKXtsaShmdW5jdGlvbigpe2xpKGUpfSl9ZnVuY3Rpb24gcGkoZSx0KXt2YXIgbj1lLl90cmFuc2l0aW9uQ2xhc3Nlc3x8KGUuX3RyYW5zaXRpb25DbGFzc2VzPVtdKTtuLmluZGV4T2YodCk8MCYmKG4ucHVzaCh0KSxRcihlLHQpKX1mdW5jdGlvbiBkaShlLHQpe2UuX3RyYW5zaXRpb25DbGFzc2VzJiZ2KGUuX3RyYW5zaXRpb25DbGFzc2VzLHQpLGVpKGUsdCl9ZnVuY3Rpb24gdmkoZSx0LG4pe3ZhciByPW1pKGUsdCksaT1yLnR5cGUsbz1yLnRpbWVvdXQsYT1yLnByb3BDb3VudDtpZighaSlyZXR1cm4gbigpO3ZhciBzPWk9PT1paT9zaTp1aSxjPTAsdT1mdW5jdGlvbigpe2UucmVtb3ZlRXZlbnRMaXN0ZW5lcihzLGwpLG4oKX0sbD1mdW5jdGlvbih0KXt0LnRhcmdldD09PWUmJisrYz49YSYmdSgpfTtzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7YzxhJiZ1KCl9LG8rMSksZS5hZGRFdmVudExpc3RlbmVyKHMsbCl9dmFyIGhpPS9cYih0cmFuc2Zvcm18YWxsKSgsfCQpLztmdW5jdGlvbiBtaShlLHQpe3ZhciBuLHI9d2luZG93LmdldENvbXB1dGVkU3R5bGUoZSksaT0oclthaSsiRGVsYXkiXXx8IiIpLnNwbGl0KCIsICIpLG89KHJbYWkrIkR1cmF0aW9uIl18fCIiKS5zcGxpdCgiLCAiKSxhPXlpKGksbykscz0ocltjaSsiRGVsYXkiXXx8IiIpLnNwbGl0KCIsICIpLGM9KHJbY2krIkR1cmF0aW9uIl18fCIiKS5zcGxpdCgiLCAiKSx1PXlpKHMsYyksbD0wLGY9MDtyZXR1cm4gdD09PWlpP2E+MCYmKG49aWksbD1hLGY9by5sZW5ndGgpOnQ9PT1vaT91PjAmJihuPW9pLGw9dSxmPWMubGVuZ3RoKTpmPShuPShsPU1hdGgubWF4KGEsdSkpPjA/YT51P2lpOm9pOm51bGwpP249PT1paT9vLmxlbmd0aDpjLmxlbmd0aDowLHt0eXBlOm4sdGltZW91dDpsLHByb3BDb3VudDpmLGhhc1RyYW5zZm9ybTpuPT09aWkmJmhpLnRlc3QoclthaSsiUHJvcGVydHkiXSl9fWZ1bmN0aW9uIHlpKGUsdCl7Zm9yKDtlLmxlbmd0aDx0Lmxlbmd0aDspZT1lLmNvbmNhdChlKTtyZXR1cm4gTWF0aC5tYXguYXBwbHkobnVsbCx0Lm1hcChmdW5jdGlvbih0LG4pe3JldHVybiBnaSh0KStnaShlW25dKX0pKX1mdW5jdGlvbiBnaShlKXtyZXR1cm4gMWUzKk51bWJlcihlLnNsaWNlKDAsLTEpLnJlcGxhY2UoIiwiLCIuIikpfWZ1bmN0aW9uIF9pKGUscil7dmFyIGk9ZS5lbG07bihpLl9sZWF2ZUNiKSYmKGkuX2xlYXZlQ2IuY2FuY2VsbGVkPSEwLGkuX2xlYXZlQ2IoKSk7dmFyIGE9dGkoZS5kYXRhLnRyYW5zaXRpb24pO2lmKCF0KGEpJiYhbihpLl9lbnRlckNiKSYmMT09PWkubm9kZVR5cGUpe2Zvcih2YXIgcz1hLmNzcyxjPWEudHlwZSx1PWEuZW50ZXJDbGFzcyxmPWEuZW50ZXJUb0NsYXNzLHA9YS5lbnRlckFjdGl2ZUNsYXNzLGQ9YS5hcHBlYXJDbGFzcyx2PWEuYXBwZWFyVG9DbGFzcyxoPWEuYXBwZWFyQWN0aXZlQ2xhc3MsbT1hLmJlZm9yZUVudGVyLHk9YS5lbnRlcixnPWEuYWZ0ZXJFbnRlcixfPWEuZW50ZXJDYW5jZWxsZWQsYj1hLmJlZm9yZUFwcGVhciwkPWEuYXBwZWFyLHc9YS5hZnRlckFwcGVhcixDPWEuYXBwZWFyQ2FuY2VsbGVkLHg9YS5kdXJhdGlvbixrPWh0LEE9aHQuJHZub2RlO0EmJkEucGFyZW50OylrPShBPUEucGFyZW50KS5jb250ZXh0O3ZhciBPPSFrLl9pc01vdW50ZWR8fCFlLmlzUm9vdEluc2VydDtpZighT3x8JHx8IiI9PT0kKXt2YXIgUz1PJiZkP2Q6dSxUPU8mJmg/aDpwLE49TyYmdj92OmYsaj1PJiZifHxtLEk9TyYmImZ1bmN0aW9uIj09dHlwZW9mICQ/JDp5LEw9TyYmd3x8ZyxNPU8mJkN8fF8sRD1sKG8oeCk/eC5lbnRlcjp4KSxQPSExIT09cyYmIUosRj13aShJKSxSPWkuX2VudGVyQ2I9RShmdW5jdGlvbigpe1AmJihkaShpLE4pLGRpKGksVCkpLFIuY2FuY2VsbGVkPyhQJiZkaShpLFMpLE0mJk0oaSkpOkwmJkwoaSksaS5fZW50ZXJDYj1udWxsfSk7ZS5kYXRhLnNob3d8fHR0KGUsImluc2VydCIsZnVuY3Rpb24oKXt2YXIgdD1pLnBhcmVudE5vZGUsbj10JiZ0Ll9wZW5kaW5nJiZ0Ll9wZW5kaW5nW2Uua2V5XTtuJiZuLnRhZz09PWUudGFnJiZuLmVsbS5fbGVhdmVDYiYmbi5lbG0uX2xlYXZlQ2IoKSxJJiZJKGksUil9KSxqJiZqKGkpLFAmJihwaShpLFMpLHBpKGksVCksZmkoZnVuY3Rpb24oKXtkaShpLFMpLFIuY2FuY2VsbGVkfHwocGkoaSxOKSxGfHwoJGkoRCk/c2V0VGltZW91dChSLEQpOnZpKGksYyxSKSkpfSkpLGUuZGF0YS5zaG93JiYociYmcigpLEkmJkkoaSxSKSksUHx8Rnx8UigpfX19ZnVuY3Rpb24gYmkoZSxyKXt2YXIgaT1lLmVsbTtuKGkuX2VudGVyQ2IpJiYoaS5fZW50ZXJDYi5jYW5jZWxsZWQ9ITAsaS5fZW50ZXJDYigpKTt2YXIgYT10aShlLmRhdGEudHJhbnNpdGlvbik7aWYodChhKXx8MSE9PWkubm9kZVR5cGUpcmV0dXJuIHIoKTtpZighbihpLl9sZWF2ZUNiKSl7dmFyIHM9YS5jc3MsYz1hLnR5cGUsdT1hLmxlYXZlQ2xhc3MsZj1hLmxlYXZlVG9DbGFzcyxwPWEubGVhdmVBY3RpdmVDbGFzcyxkPWEuYmVmb3JlTGVhdmUsdj1hLmxlYXZlLGg9YS5hZnRlckxlYXZlLG09YS5sZWF2ZUNhbmNlbGxlZCx5PWEuZGVsYXlMZWF2ZSxnPWEuZHVyYXRpb24sXz0hMSE9PXMmJiFKLGI9d2kodiksJD1sKG8oZyk/Zy5sZWF2ZTpnKSx3PWkuX2xlYXZlQ2I9RShmdW5jdGlvbigpe2kucGFyZW50Tm9kZSYmaS5wYXJlbnROb2RlLl9wZW5kaW5nJiYoaS5wYXJlbnROb2RlLl9wZW5kaW5nW2Uua2V5XT1udWxsKSxfJiYoZGkoaSxmKSxkaShpLHApKSx3LmNhbmNlbGxlZD8oXyYmZGkoaSx1KSxtJiZtKGkpKToocigpLGgmJmgoaSkpLGkuX2xlYXZlQ2I9bnVsbH0pO3k/eShDKTpDKCl9ZnVuY3Rpb24gQygpe3cuY2FuY2VsbGVkfHwoIWUuZGF0YS5zaG93JiZpLnBhcmVudE5vZGUmJigoaS5wYXJlbnROb2RlLl9wZW5kaW5nfHwoaS5wYXJlbnROb2RlLl9wZW5kaW5nPXt9KSlbZS5rZXldPWUpLGQmJmQoaSksXyYmKHBpKGksdSkscGkoaSxwKSxmaShmdW5jdGlvbigpe2RpKGksdSksdy5jYW5jZWxsZWR8fChwaShpLGYpLGJ8fCgkaSgkKT9zZXRUaW1lb3V0KHcsJCk6dmkoaSxjLHcpKSl9KSksdiYmdihpLHcpLF98fGJ8fHcoKSl9fWZ1bmN0aW9uICRpKGUpe3JldHVybiJudW1iZXIiPT10eXBlb2YgZSYmIWlzTmFOKGUpfWZ1bmN0aW9uIHdpKGUpe2lmKHQoZSkpcmV0dXJuITE7dmFyIHI9ZS5mbnM7cmV0dXJuIG4ocik/d2koQXJyYXkuaXNBcnJheShyKT9yWzBdOnIpOihlLl9sZW5ndGh8fGUubGVuZ3RoKT4xfWZ1bmN0aW9uIENpKGUsdCl7ITAhPT10LmRhdGEuc2hvdyYmX2kodCl9dmFyIHhpPWZ1bmN0aW9uKGUpe3ZhciBvLGEscz17fSxjPWUubW9kdWxlcyx1PWUubm9kZU9wcztmb3Iobz0wO288Vm4ubGVuZ3RoOysrbylmb3Ioc1tWbltvXV09W10sYT0wO2E8Yy5sZW5ndGg7KythKW4oY1thXVtWbltvXV0pJiZzW1ZuW29dXS5wdXNoKGNbYV1bVm5bb11dKTtmdW5jdGlvbiBsKGUpe3ZhciB0PXUucGFyZW50Tm9kZShlKTtuKHQpJiZ1LnJlbW92ZUNoaWxkKHQsZSl9ZnVuY3Rpb24gcChlLHQsaSxvLGEsYyxsKXtpZihuKGUuZWxtKSYmbihjKSYmKGU9Y1tsXT1kZShlKSksZS5pc1Jvb3RJbnNlcnQ9IWEsIWZ1bmN0aW9uKGUsdCxpLG8pe3ZhciBhPWUuZGF0YTtpZihuKGEpKXt2YXIgYz1uKGUuY29tcG9uZW50SW5zdGFuY2UpJiZhLmtlZXBBbGl2ZTtpZihuKGE9YS5ob29rKSYmbihhPWEuaW5pdCkmJmEoZSwhMSksbihlLmNvbXBvbmVudEluc3RhbmNlKSlyZXR1cm4gZChlLHQpLHYoaSxlLmVsbSxvKSxyKGMpJiZmdW5jdGlvbihlLHQscixpKXtmb3IodmFyIG8sYT1lO2EuY29tcG9uZW50SW5zdGFuY2U7KWlmKGE9YS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGUsbihvPWEuZGF0YSkmJm4obz1vLnRyYW5zaXRpb24pKXtmb3Iobz0wO288cy5hY3RpdmF0ZS5sZW5ndGg7KytvKXMuYWN0aXZhdGVbb10oVW4sYSk7dC5wdXNoKGEpO2JyZWFrfXYocixlLmVsbSxpKX0oZSx0LGksbyksITB9fShlLHQsaSxvKSl7dmFyIGY9ZS5kYXRhLHA9ZS5jaGlsZHJlbixtPWUudGFnO24obSk/KGUuZWxtPWUubnM/dS5jcmVhdGVFbGVtZW50TlMoZS5ucyxtKTp1LmNyZWF0ZUVsZW1lbnQobSxlKSxnKGUpLGgoZSxwLHQpLG4oZikmJnkoZSx0KSx2KGksZS5lbG0sbykpOnIoZS5pc0NvbW1lbnQpPyhlLmVsbT11LmNyZWF0ZUNvbW1lbnQoZS50ZXh0KSx2KGksZS5lbG0sbykpOihlLmVsbT11LmNyZWF0ZVRleHROb2RlKGUudGV4dCksdihpLGUuZWxtLG8pKX19ZnVuY3Rpb24gZChlLHQpe24oZS5kYXRhLnBlbmRpbmdJbnNlcnQpJiYodC5wdXNoLmFwcGx5KHQsZS5kYXRhLnBlbmRpbmdJbnNlcnQpLGUuZGF0YS5wZW5kaW5nSW5zZXJ0PW51bGwpLGUuZWxtPWUuY29tcG9uZW50SW5zdGFuY2UuJGVsLG0oZSk/KHkoZSx0KSxnKGUpKTooQm4oZSksdC5wdXNoKGUpKX1mdW5jdGlvbiB2KGUsdCxyKXtuKGUpJiYobihyKT91LnBhcmVudE5vZGUocik9PT1lJiZ1Lmluc2VydEJlZm9yZShlLHQscik6dS5hcHBlbmRDaGlsZChlLHQpKX1mdW5jdGlvbiBoKGUsdCxuKXtpZihBcnJheS5pc0FycmF5KHQpKWZvcih2YXIgcj0wO3I8dC5sZW5ndGg7KytyKXAodFtyXSxuLGUuZWxtLG51bGwsITAsdCxyKTtlbHNlIGkoZS50ZXh0KSYmdS5hcHBlbmRDaGlsZChlLmVsbSx1LmNyZWF0ZVRleHROb2RlKFN0cmluZyhlLnRleHQpKSl9ZnVuY3Rpb24gbShlKXtmb3IoO2UuY29tcG9uZW50SW5zdGFuY2U7KWU9ZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7cmV0dXJuIG4oZS50YWcpfWZ1bmN0aW9uIHkoZSx0KXtmb3IodmFyIHI9MDtyPHMuY3JlYXRlLmxlbmd0aDsrK3Ipcy5jcmVhdGVbcl0oVW4sZSk7bihvPWUuZGF0YS5ob29rKSYmKG4oby5jcmVhdGUpJiZvLmNyZWF0ZShVbixlKSxuKG8uaW5zZXJ0KSYmdC5wdXNoKGUpKX1mdW5jdGlvbiBnKGUpe3ZhciB0O2lmKG4odD1lLmZuU2NvcGVJZCkpdS5zZXRTdHlsZVNjb3BlKGUuZWxtLHQpO2Vsc2UgZm9yKHZhciByPWU7cjspbih0PXIuY29udGV4dCkmJm4odD10LiRvcHRpb25zLl9zY29wZUlkKSYmdS5zZXRTdHlsZVNjb3BlKGUuZWxtLHQpLHI9ci5wYXJlbnQ7bih0PWh0KSYmdCE9PWUuY29udGV4dCYmdCE9PWUuZm5Db250ZXh0JiZuKHQ9dC4kb3B0aW9ucy5fc2NvcGVJZCkmJnUuc2V0U3R5bGVTY29wZShlLmVsbSx0KX1mdW5jdGlvbiBfKGUsdCxuLHIsaSxvKXtmb3IoO3I8PWk7KytyKXAobltyXSxvLGUsdCwhMSxuLHIpfWZ1bmN0aW9uIGIoZSl7dmFyIHQscixpPWUuZGF0YTtpZihuKGkpKWZvcihuKHQ9aS5ob29rKSYmbih0PXQuZGVzdHJveSkmJnQoZSksdD0wO3Q8cy5kZXN0cm95Lmxlbmd0aDsrK3Qpcy5kZXN0cm95W3RdKGUpO2lmKG4odD1lLmNoaWxkcmVuKSlmb3Iocj0wO3I8ZS5jaGlsZHJlbi5sZW5ndGg7KytyKWIoZS5jaGlsZHJlbltyXSl9ZnVuY3Rpb24gJChlLHQscixpKXtmb3IoO3I8PWk7KytyKXt2YXIgbz10W3JdO24obykmJihuKG8udGFnKT8odyhvKSxiKG8pKTpsKG8uZWxtKSl9fWZ1bmN0aW9uIHcoZSx0KXtpZihuKHQpfHxuKGUuZGF0YSkpe3ZhciByLGk9cy5yZW1vdmUubGVuZ3RoKzE7Zm9yKG4odCk/dC5saXN0ZW5lcnMrPWk6dD1mdW5jdGlvbihlLHQpe2Z1bmN0aW9uIG4oKXswPT0tLW4ubGlzdGVuZXJzJiZsKGUpfXJldHVybiBuLmxpc3RlbmVycz10LG59KGUuZWxtLGkpLG4ocj1lLmNvbXBvbmVudEluc3RhbmNlKSYmbihyPXIuX3Zub2RlKSYmbihyLmRhdGEpJiZ3KHIsdCkscj0wO3I8cy5yZW1vdmUubGVuZ3RoOysrcilzLnJlbW92ZVtyXShlLHQpO24ocj1lLmRhdGEuaG9vaykmJm4ocj1yLnJlbW92ZSk/cihlLHQpOnQoKX1lbHNlIGwoZS5lbG0pfWZ1bmN0aW9uIEMoZSx0LHIsaSl7Zm9yKHZhciBvPXI7bzxpO28rKyl7dmFyIGE9dFtvXTtpZihuKGEpJiZ6bihlLGEpKXJldHVybiBvfX1mdW5jdGlvbiB4KGUsaSxvLGEsYyxsKXtpZihlIT09aSl7bihpLmVsbSkmJm4oYSkmJihpPWFbY109ZGUoaSkpO3ZhciBmPWkuZWxtPWUuZWxtO2lmKHIoZS5pc0FzeW5jUGxhY2Vob2xkZXIpKW4oaS5hc3luY0ZhY3RvcnkucmVzb2x2ZWQpP08oZS5lbG0saSxvKTppLmlzQXN5bmNQbGFjZWhvbGRlcj0hMDtlbHNlIGlmKHIoaS5pc1N0YXRpYykmJnIoZS5pc1N0YXRpYykmJmkua2V5PT09ZS5rZXkmJihyKGkuaXNDbG9uZWQpfHxyKGkuaXNPbmNlKSkpaS5jb21wb25lbnRJbnN0YW5jZT1lLmNvbXBvbmVudEluc3RhbmNlO2Vsc2V7dmFyIGQsdj1pLmRhdGE7bih2KSYmbihkPXYuaG9vaykmJm4oZD1kLnByZXBhdGNoKSYmZChlLGkpO3ZhciBoPWUuY2hpbGRyZW4seT1pLmNoaWxkcmVuO2lmKG4odikmJm0oaSkpe2ZvcihkPTA7ZDxzLnVwZGF0ZS5sZW5ndGg7KytkKXMudXBkYXRlW2RdKGUsaSk7bihkPXYuaG9vaykmJm4oZD1kLnVwZGF0ZSkmJmQoZSxpKX10KGkudGV4dCk/bihoKSYmbih5KT9oIT09eSYmZnVuY3Rpb24oZSxyLGksbyxhKXtmb3IodmFyIHMsYyxsLGY9MCxkPTAsdj1yLmxlbmd0aC0xLGg9clswXSxtPXJbdl0seT1pLmxlbmd0aC0xLGc9aVswXSxiPWlbeV0sdz0hYTtmPD12JiZkPD15Oyl0KGgpP2g9clsrK2ZdOnQobSk/bT1yWy0tdl06em4oaCxnKT8oeChoLGcsbyxpLGQpLGg9clsrK2ZdLGc9aVsrK2RdKTp6bihtLGIpPyh4KG0sYixvLGkseSksbT1yWy0tdl0sYj1pWy0teV0pOnpuKGgsYik/KHgoaCxiLG8saSx5KSx3JiZ1Lmluc2VydEJlZm9yZShlLGguZWxtLHUubmV4dFNpYmxpbmcobS5lbG0pKSxoPXJbKytmXSxiPWlbLS15XSk6em4obSxnKT8oeChtLGcsbyxpLGQpLHcmJnUuaW5zZXJ0QmVmb3JlKGUsbS5lbG0saC5lbG0pLG09clstLXZdLGc9aVsrK2RdKToodChzKSYmKHM9S24ocixmLHYpKSx0KGM9bihnLmtleSk/c1tnLmtleV06QyhnLHIsZix2KSk/cChnLG8sZSxoLmVsbSwhMSxpLGQpOnpuKGw9cltjXSxnKT8oeChsLGcsbyxpLGQpLHJbY109dm9pZCAwLHcmJnUuaW5zZXJ0QmVmb3JlKGUsbC5lbG0saC5lbG0pKTpwKGcsbyxlLGguZWxtLCExLGksZCksZz1pWysrZF0pO2Y+dj9fKGUsdChpW3krMV0pP251bGw6aVt5KzFdLmVsbSxpLGQseSxvKTpkPnkmJiQoMCxyLGYsdil9KGYsaCx5LG8sbCk6bih5KT8obihlLnRleHQpJiZ1LnNldFRleHRDb250ZW50KGYsIiIpLF8oZixudWxsLHksMCx5Lmxlbmd0aC0xLG8pKTpuKGgpPyQoMCxoLDAsaC5sZW5ndGgtMSk6bihlLnRleHQpJiZ1LnNldFRleHRDb250ZW50KGYsIiIpOmUudGV4dCE9PWkudGV4dCYmdS5zZXRUZXh0Q29udGVudChmLGkudGV4dCksbih2KSYmbihkPXYuaG9vaykmJm4oZD1kLnBvc3RwYXRjaCkmJmQoZSxpKX19fWZ1bmN0aW9uIGsoZSx0LGkpe2lmKHIoaSkmJm4oZS5wYXJlbnQpKWUucGFyZW50LmRhdGEucGVuZGluZ0luc2VydD10O2Vsc2UgZm9yKHZhciBvPTA7bzx0Lmxlbmd0aDsrK28pdFtvXS5kYXRhLmhvb2suaW5zZXJ0KHRbb10pfXZhciBBPWYoImF0dHJzLGNsYXNzLHN0YXRpY0NsYXNzLHN0YXRpY1N0eWxlLGtleSIpO2Z1bmN0aW9uIE8oZSx0LGksbyl7dmFyIGEscz10LnRhZyxjPXQuZGF0YSx1PXQuY2hpbGRyZW47aWYobz1vfHxjJiZjLnByZSx0LmVsbT1lLHIodC5pc0NvbW1lbnQpJiZuKHQuYXN5bmNGYWN0b3J5KSlyZXR1cm4gdC5pc0FzeW5jUGxhY2Vob2xkZXI9ITAsITA7aWYobihjKSYmKG4oYT1jLmhvb2spJiZuKGE9YS5pbml0KSYmYSh0LCEwKSxuKGE9dC5jb21wb25lbnRJbnN0YW5jZSkpKXJldHVybiBkKHQsaSksITA7aWYobihzKSl7aWYobih1KSlpZihlLmhhc0NoaWxkTm9kZXMoKSlpZihuKGE9YykmJm4oYT1hLmRvbVByb3BzKSYmbihhPWEuaW5uZXJIVE1MKSl7aWYoYSE9PWUuaW5uZXJIVE1MKXJldHVybiExfWVsc2V7Zm9yKHZhciBsPSEwLGY9ZS5maXJzdENoaWxkLHA9MDtwPHUubGVuZ3RoO3ArKyl7aWYoIWZ8fCFPKGYsdVtwXSxpLG8pKXtsPSExO2JyZWFrfWY9Zi5uZXh0U2libGluZ31pZighbHx8ZilyZXR1cm4hMX1lbHNlIGgodCx1LGkpO2lmKG4oYykpe3ZhciB2PSExO2Zvcih2YXIgbSBpbiBjKWlmKCFBKG0pKXt2PSEwLHkodCxpKTticmVha30hdiYmYy5jbGFzcyYmWmUoYy5jbGFzcyl9fWVsc2UgZS5kYXRhIT09dC50ZXh0JiYoZS5kYXRhPXQudGV4dCk7cmV0dXJuITB9cmV0dXJuIGZ1bmN0aW9uKGUsaSxvLGEpe2lmKCF0KGkpKXt2YXIgYyxsPSExLGY9W107aWYodChlKSlsPSEwLHAoaSxmKTtlbHNle3ZhciBkPW4oZS5ub2RlVHlwZSk7aWYoIWQmJnpuKGUsaSkpeChlLGksZixudWxsLG51bGwsYSk7ZWxzZXtpZihkKXtpZigxPT09ZS5ub2RlVHlwZSYmZS5oYXNBdHRyaWJ1dGUoSSkmJihlLnJlbW92ZUF0dHJpYnV0ZShJKSxvPSEwKSxyKG8pJiZPKGUsaSxmKSlyZXR1cm4gayhpLGYsITApLGU7Yz1lLGU9bmV3IHVlKHUudGFnTmFtZShjKS50b0xvd2VyQ2FzZSgpLHt9LFtdLHZvaWQgMCxjKX12YXIgdj1lLmVsbSxoPXUucGFyZW50Tm9kZSh2KTtpZihwKGksZix2Ll9sZWF2ZUNiP251bGw6aCx1Lm5leHRTaWJsaW5nKHYpKSxuKGkucGFyZW50KSlmb3IodmFyIHk9aS5wYXJlbnQsZz1tKGkpO3k7KXtmb3IodmFyIF89MDtfPHMuZGVzdHJveS5sZW5ndGg7KytfKXMuZGVzdHJveVtfXSh5KTtpZih5LmVsbT1pLmVsbSxnKXtmb3IodmFyIHc9MDt3PHMuY3JlYXRlLmxlbmd0aDsrK3cpcy5jcmVhdGVbd10oVW4seSk7dmFyIEM9eS5kYXRhLmhvb2suaW5zZXJ0O2lmKEMubWVyZ2VkKWZvcih2YXIgQT0xO0E8Qy5mbnMubGVuZ3RoO0ErKylDLmZuc1tBXSgpfWVsc2UgQm4oeSk7eT15LnBhcmVudH1uKGgpPyQoMCxbZV0sMCwwKTpuKGUudGFnKSYmYihlKX19cmV0dXJuIGsoaSxmLGwpLGkuZWxtfW4oZSkmJmIoZSl9fSh7bm9kZU9wczpSbixtb2R1bGVzOltucixscixQcixIcixYcixCP3tjcmVhdGU6Q2ksYWN0aXZhdGU6Q2kscmVtb3ZlOmZ1bmN0aW9uKGUsdCl7ITAhPT1lLmRhdGEuc2hvdz9iaShlLHQpOnQoKX19Ont9XS5jb25jYXQoWW4pfSk7SiYmZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigic2VsZWN0aW9uY2hhbmdlIixmdW5jdGlvbigpe3ZhciBlPWRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7ZSYmZS52bW9kZWwmJkVpKGUsImlucHV0Iil9KTt2YXIga2k9e2luc2VydGVkOmZ1bmN0aW9uKGUsdCxuLHIpeyJzZWxlY3QiPT09bi50YWc/KHIuZWxtJiYhci5lbG0uX3ZPcHRpb25zP3R0KG4sInBvc3RwYXRjaCIsZnVuY3Rpb24oKXtraS5jb21wb25lbnRVcGRhdGVkKGUsdCxuKX0pOkFpKGUsdCxuLmNvbnRleHQpLGUuX3ZPcHRpb25zPVtdLm1hcC5jYWxsKGUub3B0aW9ucyxUaSkpOigidGV4dGFyZWEiPT09bi50YWd8fFBuKGUudHlwZSkpJiYoZS5fdk1vZGlmaWVycz10Lm1vZGlmaWVycyx0Lm1vZGlmaWVycy5sYXp5fHwoZS5hZGRFdmVudExpc3RlbmVyKCJjb21wb3NpdGlvbnN0YXJ0IixOaSksZS5hZGRFdmVudExpc3RlbmVyKCJjb21wb3NpdGlvbmVuZCIsamkpLGUuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIixqaSksSiYmKGUudm1vZGVsPSEwKSkpfSxjb21wb25lbnRVcGRhdGVkOmZ1bmN0aW9uKGUsdCxuKXtpZigic2VsZWN0Ij09PW4udGFnKXtBaShlLHQsbi5jb250ZXh0KTt2YXIgcj1lLl92T3B0aW9ucyxpPWUuX3ZPcHRpb25zPVtdLm1hcC5jYWxsKGUub3B0aW9ucyxUaSk7aWYoaS5zb21lKGZ1bmN0aW9uKGUsdCl7cmV0dXJuIU4oZSxyW3RdKX0pKShlLm11bHRpcGxlP3QudmFsdWUuc29tZShmdW5jdGlvbihlKXtyZXR1cm4gU2koZSxpKX0pOnQudmFsdWUhPT10Lm9sZFZhbHVlJiZTaSh0LnZhbHVlLGkpKSYmRWkoZSwiY2hhbmdlIil9fX07ZnVuY3Rpb24gQWkoZSx0LG4pe09pKGUsdCxuKSwoS3x8cSkmJnNldFRpbWVvdXQoZnVuY3Rpb24oKXtPaShlLHQsbil9LDApfWZ1bmN0aW9uIE9pKGUsdCxuKXt2YXIgcj10LnZhbHVlLGk9ZS5tdWx0aXBsZTtpZighaXx8QXJyYXkuaXNBcnJheShyKSl7Zm9yKHZhciBvLGEscz0wLGM9ZS5vcHRpb25zLmxlbmd0aDtzPGM7cysrKWlmKGE9ZS5vcHRpb25zW3NdLGkpbz1qKHIsVGkoYSkpPi0xLGEuc2VsZWN0ZWQhPT1vJiYoYS5zZWxlY3RlZD1vKTtlbHNlIGlmKE4oVGkoYSkscikpcmV0dXJuIHZvaWQoZS5zZWxlY3RlZEluZGV4IT09cyYmKGUuc2VsZWN0ZWRJbmRleD1zKSk7aXx8KGUuc2VsZWN0ZWRJbmRleD0tMSl9fWZ1bmN0aW9uIFNpKGUsdCl7cmV0dXJuIHQuZXZlcnkoZnVuY3Rpb24odCl7cmV0dXJuIU4odCxlKX0pfWZ1bmN0aW9uIFRpKGUpe3JldHVybiJfdmFsdWUiaW4gZT9lLl92YWx1ZTplLnZhbHVlfWZ1bmN0aW9uIE5pKGUpe2UudGFyZ2V0LmNvbXBvc2luZz0hMH1mdW5jdGlvbiBqaShlKXtlLnRhcmdldC5jb21wb3NpbmcmJihlLnRhcmdldC5jb21wb3Npbmc9ITEsRWkoZS50YXJnZXQsImlucHV0IikpfWZ1bmN0aW9uIEVpKGUsdCl7dmFyIG49ZG9jdW1lbnQuY3JlYXRlRXZlbnQoIkhUTUxFdmVudHMiKTtuLmluaXRFdmVudCh0LCEwLCEwKSxlLmRpc3BhdGNoRXZlbnQobil9ZnVuY3Rpb24gSWkoZSl7cmV0dXJuIWUuY29tcG9uZW50SW5zdGFuY2V8fGUuZGF0YSYmZS5kYXRhLnRyYW5zaXRpb24/ZTpJaShlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZSl9dmFyIExpPXttb2RlbDpraSxzaG93OntiaW5kOmZ1bmN0aW9uKGUsdCxuKXt2YXIgcj10LnZhbHVlLGk9KG49SWkobikpLmRhdGEmJm4uZGF0YS50cmFuc2l0aW9uLG89ZS5fX3ZPcmlnaW5hbERpc3BsYXk9Im5vbmUiPT09ZS5zdHlsZS5kaXNwbGF5PyIiOmUuc3R5bGUuZGlzcGxheTtyJiZpPyhuLmRhdGEuc2hvdz0hMCxfaShuLGZ1bmN0aW9uKCl7ZS5zdHlsZS5kaXNwbGF5PW99KSk6ZS5zdHlsZS5kaXNwbGF5PXI/bzoibm9uZSJ9LHVwZGF0ZTpmdW5jdGlvbihlLHQsbil7dmFyIHI9dC52YWx1ZTshciE9IXQub2xkVmFsdWUmJigobj1JaShuKSkuZGF0YSYmbi5kYXRhLnRyYW5zaXRpb24/KG4uZGF0YS5zaG93PSEwLHI/X2kobixmdW5jdGlvbigpe2Uuc3R5bGUuZGlzcGxheT1lLl9fdk9yaWdpbmFsRGlzcGxheX0pOmJpKG4sZnVuY3Rpb24oKXtlLnN0eWxlLmRpc3BsYXk9Im5vbmUifSkpOmUuc3R5bGUuZGlzcGxheT1yP2UuX192T3JpZ2luYWxEaXNwbGF5OiJub25lIil9LHVuYmluZDpmdW5jdGlvbihlLHQsbixyLGkpe2l8fChlLnN0eWxlLmRpc3BsYXk9ZS5fX3ZPcmlnaW5hbERpc3BsYXkpfX19LE1pPXtuYW1lOlN0cmluZyxhcHBlYXI6Qm9vbGVhbixjc3M6Qm9vbGVhbixtb2RlOlN0cmluZyx0eXBlOlN0cmluZyxlbnRlckNsYXNzOlN0cmluZyxsZWF2ZUNsYXNzOlN0cmluZyxlbnRlclRvQ2xhc3M6U3RyaW5nLGxlYXZlVG9DbGFzczpTdHJpbmcsZW50ZXJBY3RpdmVDbGFzczpTdHJpbmcsbGVhdmVBY3RpdmVDbGFzczpTdHJpbmcsYXBwZWFyQ2xhc3M6U3RyaW5nLGFwcGVhckFjdGl2ZUNsYXNzOlN0cmluZyxhcHBlYXJUb0NsYXNzOlN0cmluZyxkdXJhdGlvbjpbTnVtYmVyLFN0cmluZyxPYmplY3RdfTtmdW5jdGlvbiBEaShlKXt2YXIgdD1lJiZlLmNvbXBvbmVudE9wdGlvbnM7cmV0dXJuIHQmJnQuQ3Rvci5vcHRpb25zLmFic3RyYWN0P0RpKHN0KHQuY2hpbGRyZW4pKTplfWZ1bmN0aW9uIFBpKGUpe3ZhciB0PXt9LG49ZS4kb3B0aW9ucztmb3IodmFyIHIgaW4gbi5wcm9wc0RhdGEpdFtyXT1lW3JdO3ZhciBpPW4uX3BhcmVudExpc3RlbmVycztmb3IodmFyIG8gaW4gaSl0W18obyldPWlbb107cmV0dXJuIHR9ZnVuY3Rpb24gRmkoZSx0KXtpZigvXGQta2VlcC1hbGl2ZSQvLnRlc3QodC50YWcpKXJldHVybiBlKCJrZWVwLWFsaXZlIix7cHJvcHM6dC5jb21wb25lbnRPcHRpb25zLnByb3BzRGF0YX0pfXZhciBSaT1mdW5jdGlvbihlKXtyZXR1cm4gZS50YWd8fGF0KGUpfSxIaT1mdW5jdGlvbihlKXtyZXR1cm4ic2hvdyI9PT1lLm5hbWV9LEJpPXtuYW1lOiJ0cmFuc2l0aW9uIixwcm9wczpNaSxhYnN0cmFjdDohMCxyZW5kZXI6ZnVuY3Rpb24oZSl7dmFyIHQ9dGhpcyxuPXRoaXMuJHNsb3RzLmRlZmF1bHQ7aWYobiYmKG49bi5maWx0ZXIoUmkpKS5sZW5ndGgpe3ZhciByPXRoaXMubW9kZSxvPW5bMF07aWYoZnVuY3Rpb24oZSl7Zm9yKDtlPWUucGFyZW50OylpZihlLmRhdGEudHJhbnNpdGlvbilyZXR1cm4hMH0odGhpcy4kdm5vZGUpKXJldHVybiBvO3ZhciBhPURpKG8pO2lmKCFhKXJldHVybiBvO2lmKHRoaXMuX2xlYXZpbmcpcmV0dXJuIEZpKGUsbyk7dmFyIHM9Il9fdHJhbnNpdGlvbi0iK3RoaXMuX3VpZCsiLSI7YS5rZXk9bnVsbD09YS5rZXk/YS5pc0NvbW1lbnQ/cysiY29tbWVudCI6cythLnRhZzppKGEua2V5KT8wPT09U3RyaW5nKGEua2V5KS5pbmRleE9mKHMpP2Eua2V5OnMrYS5rZXk6YS5rZXk7dmFyIGM9KGEuZGF0YXx8KGEuZGF0YT17fSkpLnRyYW5zaXRpb249UGkodGhpcyksdT10aGlzLl92bm9kZSxsPURpKHUpO2lmKGEuZGF0YS5kaXJlY3RpdmVzJiZhLmRhdGEuZGlyZWN0aXZlcy5zb21lKEhpKSYmKGEuZGF0YS5zaG93PSEwKSxsJiZsLmRhdGEmJiFmdW5jdGlvbihlLHQpe3JldHVybiB0LmtleT09PWUua2V5JiZ0LnRhZz09PWUudGFnfShhLGwpJiYhYXQobCkmJighbC5jb21wb25lbnRJbnN0YW5jZXx8IWwuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlLmlzQ29tbWVudCkpe3ZhciBmPWwuZGF0YS50cmFuc2l0aW9uPWsoe30sYyk7aWYoIm91dC1pbiI9PT1yKXJldHVybiB0aGlzLl9sZWF2aW5nPSEwLHR0KGYsImFmdGVyTGVhdmUiLGZ1bmN0aW9uKCl7dC5fbGVhdmluZz0hMSx0LiRmb3JjZVVwZGF0ZSgpfSksRmkoZSxvKTtpZigiaW4tb3V0Ij09PXIpe2lmKGF0KGEpKXJldHVybiB1O3ZhciBwLGQ9ZnVuY3Rpb24oKXtwKCl9O3R0KGMsImFmdGVyRW50ZXIiLGQpLHR0KGMsImVudGVyQ2FuY2VsbGVkIixkKSx0dChmLCJkZWxheUxlYXZlIixmdW5jdGlvbihlKXtwPWV9KX19cmV0dXJuIG99fX0sVWk9ayh7dGFnOlN0cmluZyxtb3ZlQ2xhc3M6U3RyaW5nfSxNaSk7ZnVuY3Rpb24gVmkoZSl7ZS5lbG0uX21vdmVDYiYmZS5lbG0uX21vdmVDYigpLGUuZWxtLl9lbnRlckNiJiZlLmVsbS5fZW50ZXJDYigpfWZ1bmN0aW9uIHppKGUpe2UuZGF0YS5uZXdQb3M9ZS5lbG0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCl9ZnVuY3Rpb24gS2koZSl7dmFyIHQ9ZS5kYXRhLnBvcyxuPWUuZGF0YS5uZXdQb3Mscj10LmxlZnQtbi5sZWZ0LGk9dC50b3Atbi50b3A7aWYocnx8aSl7ZS5kYXRhLm1vdmVkPSEwO3ZhciBvPWUuZWxtLnN0eWxlO28udHJhbnNmb3JtPW8uV2Via2l0VHJhbnNmb3JtPSJ0cmFuc2xhdGUoIityKyJweCwiK2krInB4KSIsby50cmFuc2l0aW9uRHVyYXRpb249IjBzIn19ZGVsZXRlIFVpLm1vZGU7dmFyIEppPXtUcmFuc2l0aW9uOkJpLFRyYW5zaXRpb25Hcm91cDp7cHJvcHM6VWksYmVmb3JlTW91bnQ6ZnVuY3Rpb24oKXt2YXIgZT10aGlzLHQ9dGhpcy5fdXBkYXRlO3RoaXMuX3VwZGF0ZT1mdW5jdGlvbihuLHIpe3ZhciBpPW10KGUpO2UuX19wYXRjaF9fKGUuX3Zub2RlLGUua2VwdCwhMSwhMCksZS5fdm5vZGU9ZS5rZXB0LGkoKSx0LmNhbGwoZSxuLHIpfX0scmVuZGVyOmZ1bmN0aW9uKGUpe2Zvcih2YXIgdD10aGlzLnRhZ3x8dGhpcy4kdm5vZGUuZGF0YS50YWd8fCJzcGFuIixuPU9iamVjdC5jcmVhdGUobnVsbCkscj10aGlzLnByZXZDaGlsZHJlbj10aGlzLmNoaWxkcmVuLGk9dGhpcy4kc2xvdHMuZGVmYXVsdHx8W10sbz10aGlzLmNoaWxkcmVuPVtdLGE9UGkodGhpcykscz0wO3M8aS5sZW5ndGg7cysrKXt2YXIgYz1pW3NdO2MudGFnJiZudWxsIT1jLmtleSYmMCE9PVN0cmluZyhjLmtleSkuaW5kZXhPZigiX192bGlzdCIpJiYoby5wdXNoKGMpLG5bYy5rZXldPWMsKGMuZGF0YXx8KGMuZGF0YT17fSkpLnRyYW5zaXRpb249YSl9aWYocil7Zm9yKHZhciB1PVtdLGw9W10sZj0wO2Y8ci5sZW5ndGg7ZisrKXt2YXIgcD1yW2ZdO3AuZGF0YS50cmFuc2l0aW9uPWEscC5kYXRhLnBvcz1wLmVsbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSxuW3Aua2V5XT91LnB1c2gocCk6bC5wdXNoKHApfXRoaXMua2VwdD1lKHQsbnVsbCx1KSx0aGlzLnJlbW92ZWQ9bH1yZXR1cm4gZSh0LG51bGwsbyl9LHVwZGF0ZWQ6ZnVuY3Rpb24oKXt2YXIgZT10aGlzLnByZXZDaGlsZHJlbix0PXRoaXMubW92ZUNsYXNzfHwodGhpcy5uYW1lfHwidiIpKyItbW92ZSI7ZS5sZW5ndGgmJnRoaXMuaGFzTW92ZShlWzBdLmVsbSx0KSYmKGUuZm9yRWFjaChWaSksZS5mb3JFYWNoKHppKSxlLmZvckVhY2goS2kpLHRoaXMuX3JlZmxvdz1kb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodCxlLmZvckVhY2goZnVuY3Rpb24oZSl7aWYoZS5kYXRhLm1vdmVkKXt2YXIgbj1lLmVsbSxyPW4uc3R5bGU7cGkobix0KSxyLnRyYW5zZm9ybT1yLldlYmtpdFRyYW5zZm9ybT1yLnRyYW5zaXRpb25EdXJhdGlvbj0iIixuLmFkZEV2ZW50TGlzdGVuZXIoc2ksbi5fbW92ZUNiPWZ1bmN0aW9uIGUocil7ciYmci50YXJnZXQhPT1ufHxyJiYhL3RyYW5zZm9ybSQvLnRlc3Qoci5wcm9wZXJ0eU5hbWUpfHwobi5yZW1vdmVFdmVudExpc3RlbmVyKHNpLGUpLG4uX21vdmVDYj1udWxsLGRpKG4sdCkpfSl9fSkpfSxtZXRob2RzOntoYXNNb3ZlOmZ1bmN0aW9uKGUsdCl7aWYoIXJpKXJldHVybiExO2lmKHRoaXMuX2hhc01vdmUpcmV0dXJuIHRoaXMuX2hhc01vdmU7dmFyIG49ZS5jbG9uZU5vZGUoKTtlLl90cmFuc2l0aW9uQ2xhc3NlcyYmZS5fdHJhbnNpdGlvbkNsYXNzZXMuZm9yRWFjaChmdW5jdGlvbihlKXtlaShuLGUpfSksUXIobix0KSxuLnN0eWxlLmRpc3BsYXk9Im5vbmUiLHRoaXMuJGVsLmFwcGVuZENoaWxkKG4pO3ZhciByPW1pKG4pO3JldHVybiB0aGlzLiRlbC5yZW1vdmVDaGlsZChuKSx0aGlzLl9oYXNNb3ZlPXIuaGFzVHJhbnNmb3JtfX19fTtsbi5jb25maWcubXVzdFVzZVByb3A9Ym4sbG4uY29uZmlnLmlzUmVzZXJ2ZWRUYWc9TG4sbG4uY29uZmlnLmlzUmVzZXJ2ZWRBdHRyPWduLGxuLmNvbmZpZy5nZXRUYWdOYW1lc3BhY2U9TW4sbG4uY29uZmlnLmlzVW5rbm93bkVsZW1lbnQ9ZnVuY3Rpb24oZSl7aWYoIUIpcmV0dXJuITA7aWYoTG4oZSkpcmV0dXJuITE7aWYoZT1lLnRvTG93ZXJDYXNlKCksbnVsbCE9RG5bZV0pcmV0dXJuIERuW2VdO3ZhciB0PWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoZSk7cmV0dXJuIGUuaW5kZXhPZigiLSIpPi0xP0RuW2VdPXQuY29uc3RydWN0b3I9PT13aW5kb3cuSFRNTFVua25vd25FbGVtZW50fHx0LmNvbnN0cnVjdG9yPT09d2luZG93LkhUTUxFbGVtZW50OkRuW2VdPS9IVE1MVW5rbm93bkVsZW1lbnQvLnRlc3QodC50b1N0cmluZygpKX0sayhsbi5vcHRpb25zLmRpcmVjdGl2ZXMsTGkpLGsobG4ub3B0aW9ucy5jb21wb25lbnRzLEppKSxsbi5wcm90b3R5cGUuX19wYXRjaF9fPUI/eGk6Tyxsbi5wcm90b3R5cGUuJG1vdW50PWZ1bmN0aW9uKGUsdCl7cmV0dXJuIGZ1bmN0aW9uKGUsdCxuKXt2YXIgcjtyZXR1cm4gZS4kZWw9dCxlLiRvcHRpb25zLnJlbmRlcnx8KGUuJG9wdGlvbnMucmVuZGVyPWZlKSxfdChlLCJiZWZvcmVNb3VudCIpLHI9ZnVuY3Rpb24oKXtlLl91cGRhdGUoZS5fcmVuZGVyKCksbil9LG5ldyBTdChlLHIsTyx7YmVmb3JlOmZ1bmN0aW9uKCl7ZS5faXNNb3VudGVkJiYhZS5faXNEZXN0cm95ZWQmJl90KGUsImJlZm9yZVVwZGF0ZSIpfX0sITApLG49ITEsbnVsbD09ZS4kdm5vZGUmJihlLl9pc01vdW50ZWQ9ITAsX3QoZSwibW91bnRlZCIpKSxlfSh0aGlzLGU9ZSYmQj9GbihlKTp2b2lkIDAsdCl9LEImJnNldFRpbWVvdXQoZnVuY3Rpb24oKXtELmRldnRvb2xzJiZRJiZRLmVtaXQoImluaXQiLGxuKX0sMCk7dmFyIHFpPS9ce1x7KCg/Oi58XHI/XG4pKz8pXH1cfS9nLFdpPS9bLS4qKz9eJHt9KCl8W1xdXC9cXF0vZyxHaT15KGZ1bmN0aW9uKGUpe3ZhciB0PWVbMF0ucmVwbGFjZShXaSwiXFwkJiIpLG49ZVsxXS5yZXBsYWNlKFdpLCJcXCQmIik7cmV0dXJuIG5ldyBSZWdFeHAodCsiKCg/Oi58XFxuKSs/KSIrbiwiZyIpfSk7dmFyIFppPXtzdGF0aWNLZXlzOlsic3RhdGljQ2xhc3MiXSx0cmFuc2Zvcm1Ob2RlOmZ1bmN0aW9uKGUsdCl7dC53YXJuO3ZhciBuPXdyKGUsImNsYXNzIik7biYmKGUuc3RhdGljQ2xhc3M9SlNPTi5zdHJpbmdpZnkobikpO3ZhciByPSRyKGUsImNsYXNzIiwhMSk7ciYmKGUuY2xhc3NCaW5kaW5nPXIpfSxnZW5EYXRhOmZ1bmN0aW9uKGUpe3ZhciB0PSIiO3JldHVybiBlLnN0YXRpY0NsYXNzJiYodCs9InN0YXRpY0NsYXNzOiIrZS5zdGF0aWNDbGFzcysiLCIpLGUuY2xhc3NCaW5kaW5nJiYodCs9ImNsYXNzOiIrZS5jbGFzc0JpbmRpbmcrIiwiKSx0fX07dmFyIFhpLFlpPXtzdGF0aWNLZXlzOlsic3RhdGljU3R5bGUiXSx0cmFuc2Zvcm1Ob2RlOmZ1bmN0aW9uKGUsdCl7dC53YXJuO3ZhciBuPXdyKGUsInN0eWxlIik7biYmKGUuc3RhdGljU3R5bGU9SlNPTi5zdHJpbmdpZnkoQnIobikpKTt2YXIgcj0kcihlLCJzdHlsZSIsITEpO3ImJihlLnN0eWxlQmluZGluZz1yKX0sZ2VuRGF0YTpmdW5jdGlvbihlKXt2YXIgdD0iIjtyZXR1cm4gZS5zdGF0aWNTdHlsZSYmKHQrPSJzdGF0aWNTdHlsZToiK2Uuc3RhdGljU3R5bGUrIiwiKSxlLnN0eWxlQmluZGluZyYmKHQrPSJzdHlsZTooIitlLnN0eWxlQmluZGluZysiKSwiKSx0fX0sUWk9ZnVuY3Rpb24oZSl7cmV0dXJuKFhpPVhpfHxkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSkuaW5uZXJIVE1MPWUsWGkudGV4dENvbnRlbnR9LGVvPWYoImFyZWEsYmFzZSxicixjb2wsZW1iZWQsZnJhbWUsaHIsaW1nLGlucHV0LGlzaW5kZXgsa2V5Z2VuLGxpbmssbWV0YSxwYXJhbSxzb3VyY2UsdHJhY2ssd2JyIiksdG89ZigiY29sZ3JvdXAsZGQsZHQsbGksb3B0aW9ucyxwLHRkLHRmb290LHRoLHRoZWFkLHRyLHNvdXJjZSIpLG5vPWYoImFkZHJlc3MsYXJ0aWNsZSxhc2lkZSxiYXNlLGJsb2NrcXVvdGUsYm9keSxjYXB0aW9uLGNvbCxjb2xncm91cCxkZCxkZXRhaWxzLGRpYWxvZyxkaXYsZGwsZHQsZmllbGRzZXQsZmlnY2FwdGlvbixmaWd1cmUsZm9vdGVyLGZvcm0saDEsaDIsaDMsaDQsaDUsaDYsaGVhZCxoZWFkZXIsaGdyb3VwLGhyLGh0bWwsbGVnZW5kLGxpLG1lbnVpdGVtLG1ldGEsb3B0Z3JvdXAsb3B0aW9uLHBhcmFtLHJwLHJ0LHNvdXJjZSxzdHlsZSxzdW1tYXJ5LHRib2R5LHRkLHRmb290LHRoLHRoZWFkLHRpdGxlLHRyLHRyYWNrIikscm89L15ccyooW15ccyInPD5cLz1dKykoPzpccyooPSlccyooPzoiKFteIl0qKSIrfCcoW14nXSopJyt8KFteXHMiJz08PmBdKykpKT8vLGlvPSJbYS16QS1aX11bXFx3XFwtXFwuXSoiLG9vPSIoKD86IitpbysiXFw6KT8iK2lvKyIpIixhbz1uZXcgUmVnRXhwKCJePCIrb28pLHNvPS9eXHMqKFwvPyk+Lyxjbz1uZXcgUmVnRXhwKCJePFxcLyIrb28rIltePl0qPiIpLHVvPS9ePCFET0NUWVBFIFtePl0rPi9pLGxvPS9ePCFcLS0vLGZvPS9ePCFcWy8scG89Zigic2NyaXB0LHN0eWxlLHRleHRhcmVhIiwhMCksdm89e30saG89eyImbHQ7IjoiPCIsIiZndDsiOiI+IiwiJnF1b3Q7IjonIicsIiZhbXA7IjoiJiIsIiYjMTA7IjoiXG4iLCImIzk7IjoiXHQifSxtbz0vJig/Omx0fGd0fHF1b3R8YW1wKTsvZyx5bz0vJig/Omx0fGd0fHF1b3R8YW1wfCMxMHwjOSk7L2csZ289ZigicHJlLHRleHRhcmVhIiwhMCksX289ZnVuY3Rpb24oZSx0KXtyZXR1cm4gZSYmZ28oZSkmJiJcbiI9PT10WzBdfTtmdW5jdGlvbiBibyhlLHQpe3ZhciBuPXQ/eW86bW87cmV0dXJuIGUucmVwbGFjZShuLGZ1bmN0aW9uKGUpe3JldHVybiBob1tlXX0pfXZhciAkbyx3byxDbyx4byxrbyxBbyxPbyxTbyxUbz0vXkB8XnYtb246LyxObz0vXnYtfF5AfF46Lyxqbz0vKFtcc1xTXSo/KVxzKyg/OmlufG9mKVxzKyhbXHNcU10qKS8sRW89LywoW14sXH1cXV0qKSg/OiwoW14sXH1cXV0qKSk/JC8sSW89L15cKHxcKSQvZyxMbz0vOiguKikkLyxNbz0vXjp8XnYtYmluZDovLERvPS9cLlteLl0rL2csUG89eShRaSk7ZnVuY3Rpb24gRm8oZSx0LG4pe3JldHVybnt0eXBlOjEsdGFnOmUsYXR0cnNMaXN0OnQsYXR0cnNNYXA6ZnVuY3Rpb24oZSl7Zm9yKHZhciB0PXt9LG49MCxyPWUubGVuZ3RoO248cjtuKyspdFtlW25dLm5hbWVdPWVbbl0udmFsdWU7cmV0dXJuIHR9KHQpLHBhcmVudDpuLGNoaWxkcmVuOltdfX1mdW5jdGlvbiBSbyhlLHQpeyRvPXQud2Fybnx8dnIsQW89dC5pc1ByZVRhZ3x8UyxPbz10Lm11c3RVc2VQcm9wfHxTLFNvPXQuZ2V0VGFnTmFtZXNwYWNlfHxTLENvPWhyKHQubW9kdWxlcywidHJhbnNmb3JtTm9kZSIpLHhvPWhyKHQubW9kdWxlcywicHJlVHJhbnNmb3JtTm9kZSIpLGtvPWhyKHQubW9kdWxlcywicG9zdFRyYW5zZm9ybU5vZGUiKSx3bz10LmRlbGltaXRlcnM7dmFyIG4scixpPVtdLG89ITEhPT10LnByZXNlcnZlV2hpdGVzcGFjZSxhPSExLHM9ITE7ZnVuY3Rpb24gYyhlKXtlLnByZSYmKGE9ITEpLEFvKGUudGFnKSYmKHM9ITEpO2Zvcih2YXIgbj0wO248a28ubGVuZ3RoO24rKylrb1tuXShlLHQpfXJldHVybiBmdW5jdGlvbihlLHQpe2Zvcih2YXIgbixyLGk9W10sbz10LmV4cGVjdEhUTUwsYT10LmlzVW5hcnlUYWd8fFMscz10LmNhbkJlTGVmdE9wZW5UYWd8fFMsYz0wO2U7KXtpZihuPWUsciYmcG8ocikpe3ZhciB1PTAsbD1yLnRvTG93ZXJDYXNlKCksZj12b1tsXXx8KHZvW2xdPW5ldyBSZWdFeHAoIihbXFxzXFxTXSo/KSg8LyIrbCsiW14+XSo+KSIsImkiKSkscD1lLnJlcGxhY2UoZixmdW5jdGlvbihlLG4scil7cmV0dXJuIHU9ci5sZW5ndGgscG8obCl8fCJub3NjcmlwdCI9PT1sfHwobj1uLnJlcGxhY2UoLzwhXC0tKFtcc1xTXSo/KS0tPi9nLCIkMSIpLnJlcGxhY2UoLzwhXFtDREFUQVxbKFtcc1xTXSo/KV1dPi9nLCIkMSIpKSxfbyhsLG4pJiYobj1uLnNsaWNlKDEpKSx0LmNoYXJzJiZ0LmNoYXJzKG4pLCIifSk7Yys9ZS5sZW5ndGgtcC5sZW5ndGgsZT1wLEEobCxjLXUsYyl9ZWxzZXt2YXIgZD1lLmluZGV4T2YoIjwiKTtpZigwPT09ZCl7aWYobG8udGVzdChlKSl7dmFyIHY9ZS5pbmRleE9mKCItLVx4M2UiKTtpZih2Pj0wKXt0LnNob3VsZEtlZXBDb21tZW50JiZ0LmNvbW1lbnQoZS5zdWJzdHJpbmcoNCx2KSksQyh2KzMpO2NvbnRpbnVlfX1pZihmby50ZXN0KGUpKXt2YXIgaD1lLmluZGV4T2YoIl0+Iik7aWYoaD49MCl7QyhoKzIpO2NvbnRpbnVlfX12YXIgbT1lLm1hdGNoKHVvKTtpZihtKXtDKG1bMF0ubGVuZ3RoKTtjb250aW51ZX12YXIgeT1lLm1hdGNoKGNvKTtpZih5KXt2YXIgZz1jO0MoeVswXS5sZW5ndGgpLEEoeVsxXSxnLGMpO2NvbnRpbnVlfXZhciBfPXgoKTtpZihfKXtrKF8pLF9vKF8udGFnTmFtZSxlKSYmQygxKTtjb250aW51ZX19dmFyIGI9dm9pZCAwLCQ9dm9pZCAwLHc9dm9pZCAwO2lmKGQ+PTApe2ZvcigkPWUuc2xpY2UoZCk7IShjby50ZXN0KCQpfHxhby50ZXN0KCQpfHxsby50ZXN0KCQpfHxmby50ZXN0KCQpfHwodz0kLmluZGV4T2YoIjwiLDEpKTwwKTspZCs9dywkPWUuc2xpY2UoZCk7Yj1lLnN1YnN0cmluZygwLGQpLEMoZCl9ZDwwJiYoYj1lLGU9IiIpLHQuY2hhcnMmJmImJnQuY2hhcnMoYil9aWYoZT09PW4pe3QuY2hhcnMmJnQuY2hhcnMoZSk7YnJlYWt9fWZ1bmN0aW9uIEModCl7Yys9dCxlPWUuc3Vic3RyaW5nKHQpfWZ1bmN0aW9uIHgoKXt2YXIgdD1lLm1hdGNoKGFvKTtpZih0KXt2YXIgbixyLGk9e3RhZ05hbWU6dFsxXSxhdHRyczpbXSxzdGFydDpjfTtmb3IoQyh0WzBdLmxlbmd0aCk7IShuPWUubWF0Y2goc28pKSYmKHI9ZS5tYXRjaChybykpOylDKHJbMF0ubGVuZ3RoKSxpLmF0dHJzLnB1c2gocik7aWYobilyZXR1cm4gaS51bmFyeVNsYXNoPW5bMV0sQyhuWzBdLmxlbmd0aCksaS5lbmQ9YyxpfX1mdW5jdGlvbiBrKGUpe3ZhciBuPWUudGFnTmFtZSxjPWUudW5hcnlTbGFzaDtvJiYoInAiPT09ciYmbm8obikmJkEocikscyhuKSYmcj09PW4mJkEobikpO2Zvcih2YXIgdT1hKG4pfHwhIWMsbD1lLmF0dHJzLmxlbmd0aCxmPW5ldyBBcnJheShsKSxwPTA7cDxsO3ArKyl7dmFyIGQ9ZS5hdHRyc1twXSx2PWRbM118fGRbNF18fGRbNV18fCIiLGg9ImEiPT09biYmImhyZWYiPT09ZFsxXT90LnNob3VsZERlY29kZU5ld2xpbmVzRm9ySHJlZjp0LnNob3VsZERlY29kZU5ld2xpbmVzO2ZbcF09e25hbWU6ZFsxXSx2YWx1ZTpibyh2LGgpfX11fHwoaS5wdXNoKHt0YWc6bixsb3dlckNhc2VkVGFnOm4udG9Mb3dlckNhc2UoKSxhdHRyczpmfSkscj1uKSx0LnN0YXJ0JiZ0LnN0YXJ0KG4sZix1LGUuc3RhcnQsZS5lbmQpfWZ1bmN0aW9uIEEoZSxuLG8pe3ZhciBhLHM7aWYobnVsbD09biYmKG49YyksbnVsbD09byYmKG89YyksZSlmb3Iocz1lLnRvTG93ZXJDYXNlKCksYT1pLmxlbmd0aC0xO2E+PTAmJmlbYV0ubG93ZXJDYXNlZFRhZyE9PXM7YS0tKTtlbHNlIGE9MDtpZihhPj0wKXtmb3IodmFyIHU9aS5sZW5ndGgtMTt1Pj1hO3UtLSl0LmVuZCYmdC5lbmQoaVt1XS50YWcsbixvKTtpLmxlbmd0aD1hLHI9YSYmaVthLTFdLnRhZ31lbHNlImJyIj09PXM/dC5zdGFydCYmdC5zdGFydChlLFtdLCEwLG4sbyk6InAiPT09cyYmKHQuc3RhcnQmJnQuc3RhcnQoZSxbXSwhMSxuLG8pLHQuZW5kJiZ0LmVuZChlLG4sbykpfUEoKX0oZSx7d2FybjokbyxleHBlY3RIVE1MOnQuZXhwZWN0SFRNTCxpc1VuYXJ5VGFnOnQuaXNVbmFyeVRhZyxjYW5CZUxlZnRPcGVuVGFnOnQuY2FuQmVMZWZ0T3BlblRhZyxzaG91bGREZWNvZGVOZXdsaW5lczp0LnNob3VsZERlY29kZU5ld2xpbmVzLHNob3VsZERlY29kZU5ld2xpbmVzRm9ySHJlZjp0LnNob3VsZERlY29kZU5ld2xpbmVzRm9ySHJlZixzaG91bGRLZWVwQ29tbWVudDp0LmNvbW1lbnRzLHN0YXJ0OmZ1bmN0aW9uKGUsbyx1KXt2YXIgbD1yJiZyLm5zfHxTbyhlKTtLJiYic3ZnIj09PWwmJihvPWZ1bmN0aW9uKGUpe2Zvcih2YXIgdD1bXSxuPTA7bjxlLmxlbmd0aDtuKyspe3ZhciByPWVbbl07em8udGVzdChyLm5hbWUpfHwoci5uYW1lPXIubmFtZS5yZXBsYWNlKEtvLCIiKSx0LnB1c2gocikpfXJldHVybiB0fShvKSk7dmFyIGYscD1GbyhlLG8scik7bCYmKHAubnM9bCksInN0eWxlIiE9PShmPXApLnRhZyYmKCJzY3JpcHQiIT09Zi50YWd8fGYuYXR0cnNNYXAudHlwZSYmInRleHQvamF2YXNjcmlwdCIhPT1mLmF0dHJzTWFwLnR5cGUpfHxZKCl8fChwLmZvcmJpZGRlbj0hMCk7Zm9yKHZhciBkPTA7ZDx4by5sZW5ndGg7ZCsrKXA9eG9bZF0ocCx0KXx8cDtpZihhfHwoIWZ1bmN0aW9uKGUpe251bGwhPXdyKGUsInYtcHJlIikmJihlLnByZT0hMCl9KHApLHAucHJlJiYoYT0hMCkpLEFvKHAudGFnKSYmKHM9ITApLGE/ZnVuY3Rpb24oZSl7dmFyIHQ9ZS5hdHRyc0xpc3QubGVuZ3RoO2lmKHQpZm9yKHZhciBuPWUuYXR0cnM9bmV3IEFycmF5KHQpLHI9MDtyPHQ7cisrKW5bcl09e25hbWU6ZS5hdHRyc0xpc3Rbcl0ubmFtZSx2YWx1ZTpKU09OLnN0cmluZ2lmeShlLmF0dHJzTGlzdFtyXS52YWx1ZSl9O2Vsc2UgZS5wcmV8fChlLnBsYWluPSEwKX0ocCk6cC5wcm9jZXNzZWR8fChCbyhwKSxmdW5jdGlvbihlKXt2YXIgdD13cihlLCJ2LWlmIik7aWYodCllLmlmPXQsVW8oZSx7ZXhwOnQsYmxvY2s6ZX0pO2Vsc2V7bnVsbCE9d3IoZSwidi1lbHNlIikmJihlLmVsc2U9ITApO3ZhciBuPXdyKGUsInYtZWxzZS1pZiIpO24mJihlLmVsc2VpZj1uKX19KHApLGZ1bmN0aW9uKGUpe251bGwhPXdyKGUsInYtb25jZSIpJiYoZS5vbmNlPSEwKX0ocCksSG8ocCx0KSksbj9pLmxlbmd0aHx8bi5pZiYmKHAuZWxzZWlmfHxwLmVsc2UpJiZVbyhuLHtleHA6cC5lbHNlaWYsYmxvY2s6cH0pOm49cCxyJiYhcC5mb3JiaWRkZW4paWYocC5lbHNlaWZ8fHAuZWxzZSkhZnVuY3Rpb24oZSx0KXt2YXIgbj1mdW5jdGlvbihlKXt2YXIgdD1lLmxlbmd0aDtmb3IoO3QtLTspe2lmKDE9PT1lW3RdLnR5cGUpcmV0dXJuIGVbdF07ZS5wb3AoKX19KHQuY2hpbGRyZW4pO24mJm4uaWYmJlVvKG4se2V4cDplLmVsc2VpZixibG9jazplfSl9KHAscik7ZWxzZSBpZihwLnNsb3RTY29wZSl7ci5wbGFpbj0hMTt2YXIgdj1wLnNsb3RUYXJnZXR8fCciZGVmYXVsdCInOyhyLnNjb3BlZFNsb3RzfHwoci5zY29wZWRTbG90cz17fSkpW3ZdPXB9ZWxzZSByLmNoaWxkcmVuLnB1c2gocCkscC5wYXJlbnQ9cjt1P2MocCk6KHI9cCxpLnB1c2gocCkpfSxlbmQ6ZnVuY3Rpb24oKXt2YXIgZT1pW2kubGVuZ3RoLTFdLHQ9ZS5jaGlsZHJlbltlLmNoaWxkcmVuLmxlbmd0aC0xXTt0JiYzPT09dC50eXBlJiYiICI9PT10LnRleHQmJiFzJiZlLmNoaWxkcmVuLnBvcCgpLGkubGVuZ3RoLT0xLHI9aVtpLmxlbmd0aC0xXSxjKGUpfSxjaGFyczpmdW5jdGlvbihlKXtpZihyJiYoIUt8fCJ0ZXh0YXJlYSIhPT1yLnRhZ3x8ci5hdHRyc01hcC5wbGFjZWhvbGRlciE9PWUpKXt2YXIgdCxuLGk9ci5jaGlsZHJlbjtpZihlPXN8fGUudHJpbSgpPyJzY3JpcHQiPT09KHQ9cikudGFnfHwic3R5bGUiPT09dC50YWc/ZTpQbyhlKTpvJiZpLmxlbmd0aD8iICI6IiIpIWEmJiIgIiE9PWUmJihuPWZ1bmN0aW9uKGUsdCl7dmFyIG49dD9HaSh0KTpxaTtpZihuLnRlc3QoZSkpe2Zvcih2YXIgcixpLG8sYT1bXSxzPVtdLGM9bi5sYXN0SW5kZXg9MDtyPW4uZXhlYyhlKTspeyhpPXIuaW5kZXgpPmMmJihzLnB1c2gobz1lLnNsaWNlKGMsaSkpLGEucHVzaChKU09OLnN0cmluZ2lmeShvKSkpO3ZhciB1PXByKHJbMV0udHJpbSgpKTthLnB1c2goIl9zKCIrdSsiKSIpLHMucHVzaCh7IkBiaW5kaW5nIjp1fSksYz1pK3JbMF0ubGVuZ3RofXJldHVybiBjPGUubGVuZ3RoJiYocy5wdXNoKG89ZS5zbGljZShjKSksYS5wdXNoKEpTT04uc3RyaW5naWZ5KG8pKSkse2V4cHJlc3Npb246YS5qb2luKCIrIiksdG9rZW5zOnN9fX0oZSx3bykpP2kucHVzaCh7dHlwZToyLGV4cHJlc3Npb246bi5leHByZXNzaW9uLHRva2VuczpuLnRva2Vucyx0ZXh0OmV9KToiICI9PT1lJiZpLmxlbmd0aCYmIiAiPT09aVtpLmxlbmd0aC0xXS50ZXh0fHxpLnB1c2goe3R5cGU6Myx0ZXh0OmV9KX19LGNvbW1lbnQ6ZnVuY3Rpb24oZSl7ci5jaGlsZHJlbi5wdXNoKHt0eXBlOjMsdGV4dDplLGlzQ29tbWVudDohMH0pfX0pLG59ZnVuY3Rpb24gSG8oZSx0KXt2YXIgbixyOyhyPSRyKG49ZSwia2V5IikpJiYobi5rZXk9ciksZS5wbGFpbj0hZS5rZXkmJiFlLmF0dHJzTGlzdC5sZW5ndGgsZnVuY3Rpb24oZSl7dmFyIHQ9JHIoZSwicmVmIik7dCYmKGUucmVmPXQsZS5yZWZJbkZvcj1mdW5jdGlvbihlKXt2YXIgdD1lO2Zvcig7dDspe2lmKHZvaWQgMCE9PXQuZm9yKXJldHVybiEwO3Q9dC5wYXJlbnR9cmV0dXJuITF9KGUpKX0oZSksZnVuY3Rpb24oZSl7aWYoInNsb3QiPT09ZS50YWcpZS5zbG90TmFtZT0kcihlLCJuYW1lIik7ZWxzZXt2YXIgdDsidGVtcGxhdGUiPT09ZS50YWc/KHQ9d3IoZSwic2NvcGUiKSxlLnNsb3RTY29wZT10fHx3cihlLCJzbG90LXNjb3BlIikpOih0PXdyKGUsInNsb3Qtc2NvcGUiKSkmJihlLnNsb3RTY29wZT10KTt2YXIgbj0kcihlLCJzbG90Iik7biYmKGUuc2xvdFRhcmdldD0nIiInPT09bj8nImRlZmF1bHQiJzpuLCJ0ZW1wbGF0ZSI9PT1lLnRhZ3x8ZS5zbG90U2NvcGV8fHlyKGUsInNsb3QiLG4pKX19KGUpLGZ1bmN0aW9uKGUpe3ZhciB0Oyh0PSRyKGUsImlzIikpJiYoZS5jb21wb25lbnQ9dCk7bnVsbCE9d3IoZSwiaW5saW5lLXRlbXBsYXRlIikmJihlLmlubGluZVRlbXBsYXRlPSEwKX0oZSk7Zm9yKHZhciBpPTA7aTxDby5sZW5ndGg7aSsrKWU9Q29baV0oZSx0KXx8ZTshZnVuY3Rpb24oZSl7dmFyIHQsbixyLGksbyxhLHMsYz1lLmF0dHJzTGlzdDtmb3IodD0wLG49Yy5sZW5ndGg7dDxuO3QrKylpZihyPWk9Y1t0XS5uYW1lLG89Y1t0XS52YWx1ZSxOby50ZXN0KHIpKWlmKGUuaGFzQmluZGluZ3M9ITAsKGE9Vm8ocikpJiYocj1yLnJlcGxhY2UoRG8sIiIpKSxNby50ZXN0KHIpKXI9ci5yZXBsYWNlKE1vLCIiKSxvPXByKG8pLHM9ITEsYSYmKGEucHJvcCYmKHM9ITAsImlubmVySHRtbCI9PT0ocj1fKHIpKSYmKHI9ImlubmVySFRNTCIpKSxhLmNhbWVsJiYocj1fKHIpKSxhLnN5bmMmJmJyKGUsInVwZGF0ZToiK18ocikseHIobywiJGV2ZW50IikpKSxzfHwhZS5jb21wb25lbnQmJk9vKGUudGFnLGUuYXR0cnNNYXAudHlwZSxyKT9tcihlLHIsbyk6eXIoZSxyLG8pO2Vsc2UgaWYoVG8udGVzdChyKSlyPXIucmVwbGFjZShUbywiIiksYnIoZSxyLG8sYSwhMSk7ZWxzZXt2YXIgdT0ocj1yLnJlcGxhY2UoTm8sIiIpKS5tYXRjaChMbyksbD11JiZ1WzFdO2wmJihyPXIuc2xpY2UoMCwtKGwubGVuZ3RoKzEpKSksX3IoZSxyLGksbyxsLGEpfWVsc2UgeXIoZSxyLEpTT04uc3RyaW5naWZ5KG8pKSwhZS5jb21wb25lbnQmJiJtdXRlZCI9PT1yJiZPbyhlLnRhZyxlLmF0dHJzTWFwLnR5cGUscikmJm1yKGUsciwidHJ1ZSIpfShlKX1mdW5jdGlvbiBCbyhlKXt2YXIgdDtpZih0PXdyKGUsInYtZm9yIikpe3ZhciBuPWZ1bmN0aW9uKGUpe3ZhciB0PWUubWF0Y2goam8pO2lmKCF0KXJldHVybjt2YXIgbj17fTtuLmZvcj10WzJdLnRyaW0oKTt2YXIgcj10WzFdLnRyaW0oKS5yZXBsYWNlKElvLCIiKSxpPXIubWF0Y2goRW8pO2k/KG4uYWxpYXM9ci5yZXBsYWNlKEVvLCIiKS50cmltKCksbi5pdGVyYXRvcjE9aVsxXS50cmltKCksaVsyXSYmKG4uaXRlcmF0b3IyPWlbMl0udHJpbSgpKSk6bi5hbGlhcz1yO3JldHVybiBufSh0KTtuJiZrKGUsbil9fWZ1bmN0aW9uIFVvKGUsdCl7ZS5pZkNvbmRpdGlvbnN8fChlLmlmQ29uZGl0aW9ucz1bXSksZS5pZkNvbmRpdGlvbnMucHVzaCh0KX1mdW5jdGlvbiBWbyhlKXt2YXIgdD1lLm1hdGNoKERvKTtpZih0KXt2YXIgbj17fTtyZXR1cm4gdC5mb3JFYWNoKGZ1bmN0aW9uKGUpe25bZS5zbGljZSgxKV09ITB9KSxufX12YXIgem89L154bWxuczpOU1xkKy8sS289L15OU1xkKzovO2Z1bmN0aW9uIEpvKGUpe3JldHVybiBGbyhlLnRhZyxlLmF0dHJzTGlzdC5zbGljZSgpLGUucGFyZW50KX12YXIgcW89W1ppLFlpLHtwcmVUcmFuc2Zvcm1Ob2RlOmZ1bmN0aW9uKGUsdCl7aWYoImlucHV0Ij09PWUudGFnKXt2YXIgbixyPWUuYXR0cnNNYXA7aWYoIXJbInYtbW9kZWwiXSlyZXR1cm47aWYoKHJbIjp0eXBlIl18fHJbInYtYmluZDp0eXBlIl0pJiYobj0kcihlLCJ0eXBlIikpLHIudHlwZXx8bnx8IXJbInYtYmluZCJdfHwobj0iKCIrclsidi1iaW5kIl0rIikudHlwZSIpLG4pe3ZhciBpPXdyKGUsInYtaWYiLCEwKSxvPWk/IiYmKCIraSsiKSI6IiIsYT1udWxsIT13cihlLCJ2LWVsc2UiLCEwKSxzPXdyKGUsInYtZWxzZS1pZiIsITApLGM9Sm8oZSk7Qm8oYyksZ3IoYywidHlwZSIsImNoZWNrYm94IiksSG8oYyx0KSxjLnByb2Nlc3NlZD0hMCxjLmlmPSIoIituKyIpPT09J2NoZWNrYm94JyIrbyxVbyhjLHtleHA6Yy5pZixibG9jazpjfSk7dmFyIHU9Sm8oZSk7d3IodSwidi1mb3IiLCEwKSxncih1LCJ0eXBlIiwicmFkaW8iKSxIbyh1LHQpLFVvKGMse2V4cDoiKCIrbisiKT09PSdyYWRpbyciK28sYmxvY2s6dX0pO3ZhciBsPUpvKGUpO3JldHVybiB3cihsLCJ2LWZvciIsITApLGdyKGwsIjp0eXBlIixuKSxIbyhsLHQpLFVvKGMse2V4cDppLGJsb2NrOmx9KSxhP2MuZWxzZT0hMDpzJiYoYy5lbHNlaWY9cyksY319fX1dO3ZhciBXbyxHbyxabz17ZXhwZWN0SFRNTDohMCxtb2R1bGVzOnFvLGRpcmVjdGl2ZXM6e21vZGVsOmZ1bmN0aW9uKGUsdCxuKXt2YXIgcj10LnZhbHVlLGk9dC5tb2RpZmllcnMsbz1lLnRhZyxhPWUuYXR0cnNNYXAudHlwZTtpZihlLmNvbXBvbmVudClyZXR1cm4gQ3IoZSxyLGkpLCExO2lmKCJzZWxlY3QiPT09bykhZnVuY3Rpb24oZSx0LG4pe3ZhciByPSd2YXIgJCRzZWxlY3RlZFZhbCA9IEFycmF5LnByb3RvdHlwZS5maWx0ZXIuY2FsbCgkZXZlbnQudGFyZ2V0Lm9wdGlvbnMsZnVuY3Rpb24obyl7cmV0dXJuIG8uc2VsZWN0ZWR9KS5tYXAoZnVuY3Rpb24obyl7dmFyIHZhbCA9ICJfdmFsdWUiIGluIG8gPyBvLl92YWx1ZSA6IG8udmFsdWU7cmV0dXJuICcrKG4mJm4ubnVtYmVyPyJfbih2YWwpIjoidmFsIikrIn0pOyI7cj1yKyIgIit4cih0LCIkZXZlbnQudGFyZ2V0Lm11bHRpcGxlID8gJCRzZWxlY3RlZFZhbCA6ICQkc2VsZWN0ZWRWYWxbMF0iKSxicihlLCJjaGFuZ2UiLHIsbnVsbCwhMCl9KGUscixpKTtlbHNlIGlmKCJpbnB1dCI9PT1vJiYiY2hlY2tib3giPT09YSkhZnVuY3Rpb24oZSx0LG4pe3ZhciByPW4mJm4ubnVtYmVyLGk9JHIoZSwidmFsdWUiKXx8Im51bGwiLG89JHIoZSwidHJ1ZS12YWx1ZSIpfHwidHJ1ZSIsYT0kcihlLCJmYWxzZS12YWx1ZSIpfHwiZmFsc2UiO21yKGUsImNoZWNrZWQiLCJBcnJheS5pc0FycmF5KCIrdCsiKT9faSgiK3QrIiwiK2krIik+LTEiKygidHJ1ZSI9PT1vPyI6KCIrdCsiKSI6IjpfcSgiK3QrIiwiK28rIikiKSksYnIoZSwiY2hhbmdlIiwidmFyICQkYT0iK3QrIiwkJGVsPSRldmVudC50YXJnZXQsJCRjPSQkZWwuY2hlY2tlZD8oIitvKyIpOigiK2ErIik7aWYoQXJyYXkuaXNBcnJheSgkJGEpKXt2YXIgJCR2PSIrKHI/Il9uKCIraSsiKSI6aSkrIiwkJGk9X2koJCRhLCQkdik7aWYoJCRlbC5jaGVja2VkKXskJGk8MCYmKCIreHIodCwiJCRhLmNvbmNhdChbJCR2XSkiKSsiKX1lbHNleyQkaT4tMSYmKCIreHIodCwiJCRhLnNsaWNlKDAsJCRpKS5jb25jYXQoJCRhLnNsaWNlKCQkaSsxKSkiKSsiKX19ZWxzZXsiK3hyKHQsIiQkYyIpKyJ9IixudWxsLCEwKX0oZSxyLGkpO2Vsc2UgaWYoImlucHV0Ij09PW8mJiJyYWRpbyI9PT1hKSFmdW5jdGlvbihlLHQsbil7dmFyIHI9biYmbi5udW1iZXIsaT0kcihlLCJ2YWx1ZSIpfHwibnVsbCI7bXIoZSwiY2hlY2tlZCIsIl9xKCIrdCsiLCIrKGk9cj8iX24oIitpKyIpIjppKSsiKSIpLGJyKGUsImNoYW5nZSIseHIodCxpKSxudWxsLCEwKX0oZSxyLGkpO2Vsc2UgaWYoImlucHV0Ij09PW98fCJ0ZXh0YXJlYSI9PT1vKSFmdW5jdGlvbihlLHQsbil7dmFyIHI9ZS5hdHRyc01hcC50eXBlLGk9bnx8e30sbz1pLmxhenksYT1pLm51bWJlcixzPWkudHJpbSxjPSFvJiYicmFuZ2UiIT09cix1PW8/ImNoYW5nZSI6InJhbmdlIj09PXI/anI6ImlucHV0IixsPSIkZXZlbnQudGFyZ2V0LnZhbHVlIjtzJiYobD0iJGV2ZW50LnRhcmdldC52YWx1ZS50cmltKCkiKSxhJiYobD0iX24oIitsKyIpIik7dmFyIGY9eHIodCxsKTtjJiYoZj0iaWYoJGV2ZW50LnRhcmdldC5jb21wb3NpbmcpcmV0dXJuOyIrZiksbXIoZSwidmFsdWUiLCIoIit0KyIpIiksYnIoZSx1LGYsbnVsbCwhMCksKHN8fGEpJiZicihlLCJibHVyIiwiJGZvcmNlVXBkYXRlKCkiKX0oZSxyLGkpO2Vsc2UgaWYoIUQuaXNSZXNlcnZlZFRhZyhvKSlyZXR1cm4gQ3IoZSxyLGkpLCExO3JldHVybiEwfSx0ZXh0OmZ1bmN0aW9uKGUsdCl7dC52YWx1ZSYmbXIoZSwidGV4dENvbnRlbnQiLCJfcygiK3QudmFsdWUrIikiKX0saHRtbDpmdW5jdGlvbihlLHQpe3QudmFsdWUmJm1yKGUsImlubmVySFRNTCIsIl9zKCIrdC52YWx1ZSsiKSIpfX0saXNQcmVUYWc6ZnVuY3Rpb24oZSl7cmV0dXJuInByZSI9PT1lfSxpc1VuYXJ5VGFnOmVvLG11c3RVc2VQcm9wOmJuLGNhbkJlTGVmdE9wZW5UYWc6dG8saXNSZXNlcnZlZFRhZzpMbixnZXRUYWdOYW1lc3BhY2U6TW4sc3RhdGljS2V5czpmdW5jdGlvbihlKXtyZXR1cm4gZS5yZWR1Y2UoZnVuY3Rpb24oZSx0KXtyZXR1cm4gZS5jb25jYXQodC5zdGF0aWNLZXlzfHxbXSl9LFtdKS5qb2luKCIsIil9KHFvKX0sWG89eShmdW5jdGlvbihlKXtyZXR1cm4gZigidHlwZSx0YWcsYXR0cnNMaXN0LGF0dHJzTWFwLHBsYWluLHBhcmVudCxjaGlsZHJlbixhdHRycyIrKGU/IiwiK2U6IiIpKX0pO2Z1bmN0aW9uIFlvKGUsdCl7ZSYmKFdvPVhvKHQuc3RhdGljS2V5c3x8IiIpLEdvPXQuaXNSZXNlcnZlZFRhZ3x8UyxmdW5jdGlvbiBlKHQpe3Quc3RhdGljPWZ1bmN0aW9uKGUpe2lmKDI9PT1lLnR5cGUpcmV0dXJuITE7aWYoMz09PWUudHlwZSlyZXR1cm4hMDtyZXR1cm4hKCFlLnByZSYmKGUuaGFzQmluZGluZ3N8fGUuaWZ8fGUuZm9yfHxwKGUudGFnKXx8IUdvKGUudGFnKXx8ZnVuY3Rpb24oZSl7Zm9yKDtlLnBhcmVudDspe2lmKCJ0ZW1wbGF0ZSIhPT0oZT1lLnBhcmVudCkudGFnKXJldHVybiExO2lmKGUuZm9yKXJldHVybiEwfXJldHVybiExfShlKXx8IU9iamVjdC5rZXlzKGUpLmV2ZXJ5KFdvKSkpfSh0KTtpZigxPT09dC50eXBlKXtpZighR28odC50YWcpJiYic2xvdCIhPT10LnRhZyYmbnVsbD09dC5hdHRyc01hcFsiaW5saW5lLXRlbXBsYXRlIl0pcmV0dXJuO2Zvcih2YXIgbj0wLHI9dC5jaGlsZHJlbi5sZW5ndGg7bjxyO24rKyl7dmFyIGk9dC5jaGlsZHJlbltuXTtlKGkpLGkuc3RhdGljfHwodC5zdGF0aWM9ITEpfWlmKHQuaWZDb25kaXRpb25zKWZvcih2YXIgbz0xLGE9dC5pZkNvbmRpdGlvbnMubGVuZ3RoO288YTtvKyspe3ZhciBzPXQuaWZDb25kaXRpb25zW29dLmJsb2NrO2Uocykscy5zdGF0aWN8fCh0LnN0YXRpYz0hMSl9fX0oZSksZnVuY3Rpb24gZSh0LG4pe2lmKDE9PT10LnR5cGUpe2lmKCh0LnN0YXRpY3x8dC5vbmNlKSYmKHQuc3RhdGljSW5Gb3I9biksdC5zdGF0aWMmJnQuY2hpbGRyZW4ubGVuZ3RoJiYoMSE9PXQuY2hpbGRyZW4ubGVuZ3RofHwzIT09dC5jaGlsZHJlblswXS50eXBlKSlyZXR1cm4gdm9pZCh0LnN0YXRpY1Jvb3Q9ITApO2lmKHQuc3RhdGljUm9vdD0hMSx0LmNoaWxkcmVuKWZvcih2YXIgcj0wLGk9dC5jaGlsZHJlbi5sZW5ndGg7cjxpO3IrKyllKHQuY2hpbGRyZW5bcl0sbnx8ISF0LmZvcik7aWYodC5pZkNvbmRpdGlvbnMpZm9yKHZhciBvPTEsYT10LmlmQ29uZGl0aW9ucy5sZW5ndGg7bzxhO28rKyllKHQuaWZDb25kaXRpb25zW29dLmJsb2NrLG4pfX0oZSwhMSkpfXZhciBRbz0vXihbXHckX10rfFwoW14pXSo/XCkpXHMqPT58XmZ1bmN0aW9uXHMqXCgvLGVhPS9eW0EtWmEtel8kXVtcdyRdKig/OlwuW0EtWmEtel8kXVtcdyRdKnxcWydbXiddKj8nXXxcWyJbXiJdKj8iXXxcW1xkK118XFtbQS1aYS16XyRdW1x3JF0qXSkqJC8sdGE9e2VzYzoyNyx0YWI6OSxlbnRlcjoxMyxzcGFjZTozMix1cDozOCxsZWZ0OjM3LHJpZ2h0OjM5LGRvd246NDAsZGVsZXRlOls4LDQ2XX0sbmE9e2VzYzpbIkVzYyIsIkVzY2FwZSJdLHRhYjoiVGFiIixlbnRlcjoiRW50ZXIiLHNwYWNlOlsiICIsIlNwYWNlYmFyIl0sdXA6WyJVcCIsIkFycm93VXAiXSxsZWZ0OlsiTGVmdCIsIkFycm93TGVmdCJdLHJpZ2h0OlsiUmlnaHQiLCJBcnJvd1JpZ2h0Il0sZG93bjpbIkRvd24iLCJBcnJvd0Rvd24iXSxkZWxldGU6WyJCYWNrc3BhY2UiLCJEZWxldGUiLCJEZWwiXX0scmE9ZnVuY3Rpb24oZSl7cmV0dXJuImlmKCIrZSsiKXJldHVybiBudWxsOyJ9LGlhPXtzdG9wOiIkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7IixwcmV2ZW50OiIkZXZlbnQucHJldmVudERlZmF1bHQoKTsiLHNlbGY6cmEoIiRldmVudC50YXJnZXQgIT09ICRldmVudC5jdXJyZW50VGFyZ2V0IiksY3RybDpyYSgiISRldmVudC5jdHJsS2V5Iiksc2hpZnQ6cmEoIiEkZXZlbnQuc2hpZnRLZXkiKSxhbHQ6cmEoIiEkZXZlbnQuYWx0S2V5IiksbWV0YTpyYSgiISRldmVudC5tZXRhS2V5IiksbGVmdDpyYSgiJ2J1dHRvbicgaW4gJGV2ZW50ICYmICRldmVudC5idXR0b24gIT09IDAiKSxtaWRkbGU6cmEoIididXR0b24nIGluICRldmVudCAmJiAkZXZlbnQuYnV0dG9uICE9PSAxIikscmlnaHQ6cmEoIididXR0b24nIGluICRldmVudCAmJiAkZXZlbnQuYnV0dG9uICE9PSAyIil9O2Z1bmN0aW9uIG9hKGUsdCl7dmFyIG49dD8ibmF0aXZlT246eyI6Im9uOnsiO2Zvcih2YXIgciBpbiBlKW4rPSciJytyKyciOicrYWEocixlW3JdKSsiLCI7cmV0dXJuIG4uc2xpY2UoMCwtMSkrIn0ifWZ1bmN0aW9uIGFhKGUsdCl7aWYoIXQpcmV0dXJuImZ1bmN0aW9uKCl7fSI7aWYoQXJyYXkuaXNBcnJheSh0KSlyZXR1cm4iWyIrdC5tYXAoZnVuY3Rpb24odCl7cmV0dXJuIGFhKGUsdCl9KS5qb2luKCIsIikrIl0iO3ZhciBuPWVhLnRlc3QodC52YWx1ZSkscj1Rby50ZXN0KHQudmFsdWUpO2lmKHQubW9kaWZpZXJzKXt2YXIgaT0iIixvPSIiLGE9W107Zm9yKHZhciBzIGluIHQubW9kaWZpZXJzKWlmKGlhW3NdKW8rPWlhW3NdLHRhW3NdJiZhLnB1c2gocyk7ZWxzZSBpZigiZXhhY3QiPT09cyl7dmFyIGM9dC5tb2RpZmllcnM7bys9cmEoWyJjdHJsIiwic2hpZnQiLCJhbHQiLCJtZXRhIl0uZmlsdGVyKGZ1bmN0aW9uKGUpe3JldHVybiFjW2VdfSkubWFwKGZ1bmN0aW9uKGUpe3JldHVybiIkZXZlbnQuIitlKyJLZXkifSkuam9pbigifHwiKSl9ZWxzZSBhLnB1c2gocyk7cmV0dXJuIGEubGVuZ3RoJiYoaSs9ZnVuY3Rpb24oZSl7cmV0dXJuImlmKCEoJ2J1dHRvbicgaW4gJGV2ZW50KSYmIitlLm1hcChzYSkuam9pbigiJiYiKSsiKXJldHVybiBudWxsOyJ9KGEpKSxvJiYoaSs9byksImZ1bmN0aW9uKCRldmVudCl7IitpKyhuPyJyZXR1cm4gIit0LnZhbHVlKyIoJGV2ZW50KSI6cj8icmV0dXJuICgiK3QudmFsdWUrIikoJGV2ZW50KSI6dC52YWx1ZSkrIn0ifXJldHVybiBufHxyP3QudmFsdWU6ImZ1bmN0aW9uKCRldmVudCl7Iit0LnZhbHVlKyJ9In1mdW5jdGlvbiBzYShlKXt2YXIgdD1wYXJzZUludChlLDEwKTtpZih0KXJldHVybiIkZXZlbnQua2V5Q29kZSE9PSIrdDt2YXIgbj10YVtlXSxyPW5hW2VdO3JldHVybiJfaygkZXZlbnQua2V5Q29kZSwiK0pTT04uc3RyaW5naWZ5KGUpKyIsIitKU09OLnN0cmluZ2lmeShuKSsiLCRldmVudC5rZXksIitKU09OLnN0cmluZ2lmeShyKSsiKSJ9dmFyIGNhPXtvbjpmdW5jdGlvbihlLHQpe2Uud3JhcExpc3RlbmVycz1mdW5jdGlvbihlKXtyZXR1cm4iX2coIitlKyIsIit0LnZhbHVlKyIpIn19LGJpbmQ6ZnVuY3Rpb24oZSx0KXtlLndyYXBEYXRhPWZ1bmN0aW9uKG4pe3JldHVybiJfYigiK24rIiwnIitlLnRhZysiJywiK3QudmFsdWUrIiwiKyh0Lm1vZGlmaWVycyYmdC5tb2RpZmllcnMucHJvcD8idHJ1ZSI6ImZhbHNlIikrKHQubW9kaWZpZXJzJiZ0Lm1vZGlmaWVycy5zeW5jPyIsdHJ1ZSI6IiIpKyIpIn19LGNsb2FrOk99LHVhPWZ1bmN0aW9uKGUpe3RoaXMub3B0aW9ucz1lLHRoaXMud2Fybj1lLndhcm58fHZyLHRoaXMudHJhbnNmb3Jtcz1ocihlLm1vZHVsZXMsInRyYW5zZm9ybUNvZGUiKSx0aGlzLmRhdGFHZW5GbnM9aHIoZS5tb2R1bGVzLCJnZW5EYXRhIiksdGhpcy5kaXJlY3RpdmVzPWsoayh7fSxjYSksZS5kaXJlY3RpdmVzKTt2YXIgdD1lLmlzUmVzZXJ2ZWRUYWd8fFM7dGhpcy5tYXliZUNvbXBvbmVudD1mdW5jdGlvbihlKXtyZXR1cm4hKHQoZS50YWcpJiYhZS5jb21wb25lbnQpfSx0aGlzLm9uY2VJZD0wLHRoaXMuc3RhdGljUmVuZGVyRm5zPVtdLHRoaXMucHJlPSExfTtmdW5jdGlvbiBsYShlLHQpe3ZhciBuPW5ldyB1YSh0KTtyZXR1cm57cmVuZGVyOiJ3aXRoKHRoaXMpe3JldHVybiAiKyhlP2ZhKGUsbik6J19jKCJkaXYiKScpKyJ9IixzdGF0aWNSZW5kZXJGbnM6bi5zdGF0aWNSZW5kZXJGbnN9fWZ1bmN0aW9uIGZhKGUsdCl7aWYoZS5wYXJlbnQmJihlLnByZT1lLnByZXx8ZS5wYXJlbnQucHJlKSxlLnN0YXRpY1Jvb3QmJiFlLnN0YXRpY1Byb2Nlc3NlZClyZXR1cm4gcGEoZSx0KTtpZihlLm9uY2UmJiFlLm9uY2VQcm9jZXNzZWQpcmV0dXJuIGRhKGUsdCk7aWYoZS5mb3ImJiFlLmZvclByb2Nlc3NlZClyZXR1cm4gZnVuY3Rpb24oZSx0LG4scil7dmFyIGk9ZS5mb3Isbz1lLmFsaWFzLGE9ZS5pdGVyYXRvcjE/IiwiK2UuaXRlcmF0b3IxOiIiLHM9ZS5pdGVyYXRvcjI/IiwiK2UuaXRlcmF0b3IyOiIiO3JldHVybiBlLmZvclByb2Nlc3NlZD0hMCwocnx8Il9sIikrIigoIitpKyIpLGZ1bmN0aW9uKCIrbythK3MrIil7cmV0dXJuICIrKG58fGZhKShlLHQpKyJ9KSJ9KGUsdCk7aWYoZS5pZiYmIWUuaWZQcm9jZXNzZWQpcmV0dXJuIHZhKGUsdCk7aWYoInRlbXBsYXRlIiE9PWUudGFnfHxlLnNsb3RUYXJnZXR8fHQucHJlKXtpZigic2xvdCI9PT1lLnRhZylyZXR1cm4gZnVuY3Rpb24oZSx0KXt2YXIgbj1lLnNsb3ROYW1lfHwnImRlZmF1bHQiJyxyPXlhKGUsdCksaT0iX3QoIituKyhyPyIsIityOiIiKSxvPWUuYXR0cnMmJiJ7IitlLmF0dHJzLm1hcChmdW5jdGlvbihlKXtyZXR1cm4gXyhlLm5hbWUpKyI6IitlLnZhbHVlfSkuam9pbigiLCIpKyJ9IixhPWUuYXR0cnNNYXBbInYtYmluZCJdOyFvJiYhYXx8cnx8KGkrPSIsbnVsbCIpO28mJihpKz0iLCIrbyk7YSYmKGkrPShvPyIiOiIsbnVsbCIpKyIsIithKTtyZXR1cm4gaSsiKSJ9KGUsdCk7dmFyIG47aWYoZS5jb21wb25lbnQpbj1mdW5jdGlvbihlLHQsbil7dmFyIHI9dC5pbmxpbmVUZW1wbGF0ZT9udWxsOnlhKHQsbiwhMCk7cmV0dXJuIl9jKCIrZSsiLCIraGEodCxuKSsocj8iLCIrcjoiIikrIikifShlLmNvbXBvbmVudCxlLHQpO2Vsc2V7dmFyIHI7KCFlLnBsYWlufHxlLnByZSYmdC5tYXliZUNvbXBvbmVudChlKSkmJihyPWhhKGUsdCkpO3ZhciBpPWUuaW5saW5lVGVtcGxhdGU/bnVsbDp5YShlLHQsITApO249Il9jKCciK2UudGFnKyInIisocj8iLCIrcjoiIikrKGk/IiwiK2k6IiIpKyIpIn1mb3IodmFyIG89MDtvPHQudHJhbnNmb3Jtcy5sZW5ndGg7bysrKW49dC50cmFuc2Zvcm1zW29dKGUsbik7cmV0dXJuIG59cmV0dXJuIHlhKGUsdCl8fCJ2b2lkIDAifWZ1bmN0aW9uIHBhKGUsdCl7ZS5zdGF0aWNQcm9jZXNzZWQ9ITA7dmFyIG49dC5wcmU7cmV0dXJuIGUucHJlJiYodC5wcmU9ZS5wcmUpLHQuc3RhdGljUmVuZGVyRm5zLnB1c2goIndpdGgodGhpcyl7cmV0dXJuICIrZmEoZSx0KSsifSIpLHQucHJlPW4sIl9tKCIrKHQuc3RhdGljUmVuZGVyRm5zLmxlbmd0aC0xKSsoZS5zdGF0aWNJbkZvcj8iLHRydWUiOiIiKSsiKSJ9ZnVuY3Rpb24gZGEoZSx0KXtpZihlLm9uY2VQcm9jZXNzZWQ9ITAsZS5pZiYmIWUuaWZQcm9jZXNzZWQpcmV0dXJuIHZhKGUsdCk7aWYoZS5zdGF0aWNJbkZvcil7Zm9yKHZhciBuPSIiLHI9ZS5wYXJlbnQ7cjspe2lmKHIuZm9yKXtuPXIua2V5O2JyZWFrfXI9ci5wYXJlbnR9cmV0dXJuIG4/Il9vKCIrZmEoZSx0KSsiLCIrdC5vbmNlSWQrKysiLCIrbisiKSI6ZmEoZSx0KX1yZXR1cm4gcGEoZSx0KX1mdW5jdGlvbiB2YShlLHQsbixyKXtyZXR1cm4gZS5pZlByb2Nlc3NlZD0hMCxmdW5jdGlvbiBlKHQsbixyLGkpe2lmKCF0Lmxlbmd0aClyZXR1cm4gaXx8Il9lKCkiO3ZhciBvPXQuc2hpZnQoKTtyZXR1cm4gby5leHA/IigiK28uZXhwKyIpPyIrYShvLmJsb2NrKSsiOiIrZSh0LG4scixpKToiIithKG8uYmxvY2spO2Z1bmN0aW9uIGEoZSl7cmV0dXJuIHI/cihlLG4pOmUub25jZT9kYShlLG4pOmZhKGUsbil9fShlLmlmQ29uZGl0aW9ucy5zbGljZSgpLHQsbixyKX1mdW5jdGlvbiBoYShlLHQpe3ZhciBuPSJ7IixyPWZ1bmN0aW9uKGUsdCl7dmFyIG49ZS5kaXJlY3RpdmVzO2lmKCFuKXJldHVybjt2YXIgcixpLG8sYSxzPSJkaXJlY3RpdmVzOlsiLGM9ITE7Zm9yKHI9MCxpPW4ubGVuZ3RoO3I8aTtyKyspe289bltyXSxhPSEwO3ZhciB1PXQuZGlyZWN0aXZlc1tvLm5hbWVdO3UmJihhPSEhdShlLG8sdC53YXJuKSksYSYmKGM9ITAscys9J3tuYW1lOiInK28ubmFtZSsnIixyYXdOYW1lOiInK28ucmF3TmFtZSsnIicrKG8udmFsdWU/Iix2YWx1ZTooIitvLnZhbHVlKyIpLGV4cHJlc3Npb246IitKU09OLnN0cmluZ2lmeShvLnZhbHVlKToiIikrKG8uYXJnPycsYXJnOiInK28uYXJnKyciJzoiIikrKG8ubW9kaWZpZXJzPyIsbW9kaWZpZXJzOiIrSlNPTi5zdHJpbmdpZnkoby5tb2RpZmllcnMpOiIiKSsifSwiKX1pZihjKXJldHVybiBzLnNsaWNlKDAsLTEpKyJdIn0oZSx0KTtyJiYobis9cisiLCIpLGUua2V5JiYobis9ImtleToiK2Uua2V5KyIsIiksZS5yZWYmJihuKz0icmVmOiIrZS5yZWYrIiwiKSxlLnJlZkluRm9yJiYobis9InJlZkluRm9yOnRydWUsIiksZS5wcmUmJihuKz0icHJlOnRydWUsIiksZS5jb21wb25lbnQmJihuKz0ndGFnOiInK2UudGFnKyciLCcpO2Zvcih2YXIgaT0wO2k8dC5kYXRhR2VuRm5zLmxlbmd0aDtpKyspbis9dC5kYXRhR2VuRm5zW2ldKGUpO2lmKGUuYXR0cnMmJihuKz0iYXR0cnM6eyIrYmEoZS5hdHRycykrIn0sIiksZS5wcm9wcyYmKG4rPSJkb21Qcm9wczp7IitiYShlLnByb3BzKSsifSwiKSxlLmV2ZW50cyYmKG4rPW9hKGUuZXZlbnRzLCExKSsiLCIpLGUubmF0aXZlRXZlbnRzJiYobis9b2EoZS5uYXRpdmVFdmVudHMsITApKyIsIiksZS5zbG90VGFyZ2V0JiYhZS5zbG90U2NvcGUmJihuKz0ic2xvdDoiK2Uuc2xvdFRhcmdldCsiLCIpLGUuc2NvcGVkU2xvdHMmJihuKz1mdW5jdGlvbihlLHQpe3JldHVybiJzY29wZWRTbG90czpfdShbIitPYmplY3Qua2V5cyhlKS5tYXAoZnVuY3Rpb24obil7cmV0dXJuIG1hKG4sZVtuXSx0KX0pLmpvaW4oIiwiKSsiXSkifShlLnNjb3BlZFNsb3RzLHQpKyIsIiksZS5tb2RlbCYmKG4rPSJtb2RlbDp7dmFsdWU6IitlLm1vZGVsLnZhbHVlKyIsY2FsbGJhY2s6IitlLm1vZGVsLmNhbGxiYWNrKyIsZXhwcmVzc2lvbjoiK2UubW9kZWwuZXhwcmVzc2lvbisifSwiKSxlLmlubGluZVRlbXBsYXRlKXt2YXIgbz1mdW5jdGlvbihlLHQpe3ZhciBuPWUuY2hpbGRyZW5bMF07aWYoMT09PW4udHlwZSl7dmFyIHI9bGEobix0Lm9wdGlvbnMpO3JldHVybiJpbmxpbmVUZW1wbGF0ZTp7cmVuZGVyOmZ1bmN0aW9uKCl7IityLnJlbmRlcisifSxzdGF0aWNSZW5kZXJGbnM6WyIrci5zdGF0aWNSZW5kZXJGbnMubWFwKGZ1bmN0aW9uKGUpe3JldHVybiJmdW5jdGlvbigpeyIrZSsifSJ9KS5qb2luKCIsIikrIl19In19KGUsdCk7byYmKG4rPW8rIiwiKX1yZXR1cm4gbj1uLnJlcGxhY2UoLywkLywiIikrIn0iLGUud3JhcERhdGEmJihuPWUud3JhcERhdGEobikpLGUud3JhcExpc3RlbmVycyYmKG49ZS53cmFwTGlzdGVuZXJzKG4pKSxufWZ1bmN0aW9uIG1hKGUsdCxuKXtyZXR1cm4gdC5mb3ImJiF0LmZvclByb2Nlc3NlZD9mdW5jdGlvbihlLHQsbil7dmFyIHI9dC5mb3IsaT10LmFsaWFzLG89dC5pdGVyYXRvcjE/IiwiK3QuaXRlcmF0b3IxOiIiLGE9dC5pdGVyYXRvcjI/IiwiK3QuaXRlcmF0b3IyOiIiO3JldHVybiB0LmZvclByb2Nlc3NlZD0hMCwiX2woKCIrcisiKSxmdW5jdGlvbigiK2krbythKyIpe3JldHVybiAiK21hKGUsdCxuKSsifSkifShlLHQsbik6IntrZXk6IitlKyIsZm46IisoImZ1bmN0aW9uKCIrU3RyaW5nKHQuc2xvdFNjb3BlKSsiKXtyZXR1cm4gIisoInRlbXBsYXRlIj09PXQudGFnP3QuaWY/IigiK3QuaWYrIik/IisoeWEodCxuKXx8InVuZGVmaW5lZCIpKyI6dW5kZWZpbmVkIjp5YSh0LG4pfHwidW5kZWZpbmVkIjpmYSh0LG4pKSsifSIpKyJ9In1mdW5jdGlvbiB5YShlLHQsbixyLGkpe3ZhciBvPWUuY2hpbGRyZW47aWYoby5sZW5ndGgpe3ZhciBhPW9bMF07aWYoMT09PW8ubGVuZ3RoJiZhLmZvciYmInRlbXBsYXRlIiE9PWEudGFnJiYic2xvdCIhPT1hLnRhZyl7dmFyIHM9bj90Lm1heWJlQ29tcG9uZW50KGEpPyIsMSI6IiwwIjoiIjtyZXR1cm4iIisocnx8ZmEpKGEsdCkrc312YXIgYz1uP2Z1bmN0aW9uKGUsdCl7Zm9yKHZhciBuPTAscj0wO3I8ZS5sZW5ndGg7cisrKXt2YXIgaT1lW3JdO2lmKDE9PT1pLnR5cGUpe2lmKGdhKGkpfHxpLmlmQ29uZGl0aW9ucyYmaS5pZkNvbmRpdGlvbnMuc29tZShmdW5jdGlvbihlKXtyZXR1cm4gZ2EoZS5ibG9jayl9KSl7bj0yO2JyZWFrfSh0KGkpfHxpLmlmQ29uZGl0aW9ucyYmaS5pZkNvbmRpdGlvbnMuc29tZShmdW5jdGlvbihlKXtyZXR1cm4gdChlLmJsb2NrKX0pKSYmKG49MSl9fXJldHVybiBufShvLHQubWF5YmVDb21wb25lbnQpOjAsdT1pfHxfYTtyZXR1cm4iWyIrby5tYXAoZnVuY3Rpb24oZSl7cmV0dXJuIHUoZSx0KX0pLmpvaW4oIiwiKSsiXSIrKGM/IiwiK2M6IiIpfX1mdW5jdGlvbiBnYShlKXtyZXR1cm4gdm9pZCAwIT09ZS5mb3J8fCJ0ZW1wbGF0ZSI9PT1lLnRhZ3x8InNsb3QiPT09ZS50YWd9ZnVuY3Rpb24gX2EoZSx0KXtyZXR1cm4gMT09PWUudHlwZT9mYShlLHQpOjM9PT1lLnR5cGUmJmUuaXNDb21tZW50PyhyPWUsIl9lKCIrSlNPTi5zdHJpbmdpZnkoci50ZXh0KSsiKSIpOiJfdigiKygyPT09KG49ZSkudHlwZT9uLmV4cHJlc3Npb246JGEoSlNPTi5zdHJpbmdpZnkobi50ZXh0KSkpKyIpIjt2YXIgbixyfWZ1bmN0aW9uIGJhKGUpe2Zvcih2YXIgdD0iIixuPTA7bjxlLmxlbmd0aDtuKyspe3ZhciByPWVbbl07dCs9JyInK3IubmFtZSsnIjonKyRhKHIudmFsdWUpKyIsIn1yZXR1cm4gdC5zbGljZSgwLC0xKX1mdW5jdGlvbiAkYShlKXtyZXR1cm4gZS5yZXBsYWNlKC9cdTIwMjgvZywiXFx1MjAyOCIpLnJlcGxhY2UoL1x1MjAyOS9nLCJcXHUyMDI5Iil9bmV3IFJlZ0V4cCgiXFxiIisiZG8saWYsZm9yLGxldCxuZXcsdHJ5LHZhcixjYXNlLGVsc2Usd2l0aCxhd2FpdCxicmVhayxjYXRjaCxjbGFzcyxjb25zdCxzdXBlcix0aHJvdyx3aGlsZSx5aWVsZCxkZWxldGUsZXhwb3J0LGltcG9ydCxyZXR1cm4sc3dpdGNoLGRlZmF1bHQsZXh0ZW5kcyxmaW5hbGx5LGNvbnRpbnVlLGRlYnVnZ2VyLGZ1bmN0aW9uLGFyZ3VtZW50cyIuc3BsaXQoIiwiKS5qb2luKCJcXGJ8XFxiIikrIlxcYiIpO2Z1bmN0aW9uIHdhKGUsdCl7dHJ5e3JldHVybiBuZXcgRnVuY3Rpb24oZSl9Y2F0Y2gobil7cmV0dXJuIHQucHVzaCh7ZXJyOm4sY29kZTplfSksT319dmFyIENhLHhhLGthPShDYT1mdW5jdGlvbihlLHQpe3ZhciBuPVJvKGUudHJpbSgpLHQpOyExIT09dC5vcHRpbWl6ZSYmWW8obix0KTt2YXIgcj1sYShuLHQpO3JldHVybnthc3Q6bixyZW5kZXI6ci5yZW5kZXIsc3RhdGljUmVuZGVyRm5zOnIuc3RhdGljUmVuZGVyRm5zfX0sZnVuY3Rpb24oZSl7ZnVuY3Rpb24gdCh0LG4pe3ZhciByPU9iamVjdC5jcmVhdGUoZSksaT1bXSxvPVtdO2lmKHIud2Fybj1mdW5jdGlvbihlLHQpeyh0P286aSkucHVzaChlKX0sbilmb3IodmFyIGEgaW4gbi5tb2R1bGVzJiYoci5tb2R1bGVzPShlLm1vZHVsZXN8fFtdKS5jb25jYXQobi5tb2R1bGVzKSksbi5kaXJlY3RpdmVzJiYoci5kaXJlY3RpdmVzPWsoT2JqZWN0LmNyZWF0ZShlLmRpcmVjdGl2ZXN8fG51bGwpLG4uZGlyZWN0aXZlcykpLG4pIm1vZHVsZXMiIT09YSYmImRpcmVjdGl2ZXMiIT09YSYmKHJbYV09blthXSk7dmFyIHM9Q2EodCxyKTtyZXR1cm4gcy5lcnJvcnM9aSxzLnRpcHM9byxzfXJldHVybntjb21waWxlOnQsY29tcGlsZVRvRnVuY3Rpb25zOmZ1bmN0aW9uKGUpe3ZhciB0PU9iamVjdC5jcmVhdGUobnVsbCk7cmV0dXJuIGZ1bmN0aW9uKG4scixpKXsocj1rKHt9LHIpKS53YXJuLGRlbGV0ZSByLndhcm47dmFyIG89ci5kZWxpbWl0ZXJzP1N0cmluZyhyLmRlbGltaXRlcnMpK246bjtpZih0W29dKXJldHVybiB0W29dO3ZhciBhPWUobixyKSxzPXt9LGM9W107cmV0dXJuIHMucmVuZGVyPXdhKGEucmVuZGVyLGMpLHMuc3RhdGljUmVuZGVyRm5zPWEuc3RhdGljUmVuZGVyRm5zLm1hcChmdW5jdGlvbihlKXtyZXR1cm4gd2EoZSxjKX0pLHRbb109c319KHQpfX0pKFpvKSxBYT0oa2EuY29tcGlsZSxrYS5jb21waWxlVG9GdW5jdGlvbnMpO2Z1bmN0aW9uIE9hKGUpe3JldHVybih4YT14YXx8ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikpLmlubmVySFRNTD1lPyc8YSBocmVmPSJcbiIvPic6JzxkaXYgYT0iXG4iLz4nLHhhLmlubmVySFRNTC5pbmRleE9mKCImIzEwOyIpPjB9dmFyIFNhPSEhQiYmT2EoITEpLFRhPSEhQiYmT2EoITApLE5hPXkoZnVuY3Rpb24oZSl7dmFyIHQ9Rm4oZSk7cmV0dXJuIHQmJnQuaW5uZXJIVE1MfSksamE9bG4ucHJvdG90eXBlLiRtb3VudDtyZXR1cm4gbG4ucHJvdG90eXBlLiRtb3VudD1mdW5jdGlvbihlLHQpe2lmKChlPWUmJkZuKGUpKT09PWRvY3VtZW50LmJvZHl8fGU9PT1kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpcmV0dXJuIHRoaXM7dmFyIG49dGhpcy4kb3B0aW9ucztpZighbi5yZW5kZXIpe3ZhciByPW4udGVtcGxhdGU7aWYocilpZigic3RyaW5nIj09dHlwZW9mIHIpIiMiPT09ci5jaGFyQXQoMCkmJihyPU5hKHIpKTtlbHNle2lmKCFyLm5vZGVUeXBlKXJldHVybiB0aGlzO3I9ci5pbm5lckhUTUx9ZWxzZSBlJiYocj1mdW5jdGlvbihlKXtpZihlLm91dGVySFRNTClyZXR1cm4gZS5vdXRlckhUTUw7dmFyIHQ9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7cmV0dXJuIHQuYXBwZW5kQ2hpbGQoZS5jbG9uZU5vZGUoITApKSx0LmlubmVySFRNTH0oZSkpO2lmKHIpe3ZhciBpPUFhKHIse3Nob3VsZERlY29kZU5ld2xpbmVzOlNhLHNob3VsZERlY29kZU5ld2xpbmVzRm9ySHJlZjpUYSxkZWxpbWl0ZXJzOm4uZGVsaW1pdGVycyxjb21tZW50czpuLmNvbW1lbnRzfSx0aGlzKSxvPWkucmVuZGVyLGE9aS5zdGF0aWNSZW5kZXJGbnM7bi5yZW5kZXI9byxuLnN0YXRpY1JlbmRlckZucz1hfX1yZXR1cm4gamEuY2FsbCh0aGlzLGUsdCl9LGxuLmNvbXBpbGU9QWEsbG59KTs="></script>
        -->
        <!--vuejsdebug--><script src="data:text/plain;base64,LyohCiAqIFZ1ZS5qcyB2Mi41LjIxCiAqIChjKSAyMDE0LTIwMTggRXZhbiBZb3UKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLgogKi8KKGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHsKICB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgPyBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSA6CiAgdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kID8gZGVmaW5lKGZhY3RvcnkpIDoKICAoZ2xvYmFsLlZ1ZSA9IGZhY3RvcnkoKSk7Cn0odGhpcywgKGZ1bmN0aW9uICgpIHsgJ3VzZSBzdHJpY3QnOwoKICAvKiAgKi8KCiAgdmFyIGVtcHR5T2JqZWN0ID0gT2JqZWN0LmZyZWV6ZSh7fSk7CgogIC8vIFRoZXNlIGhlbHBlcnMgcHJvZHVjZSBiZXR0ZXIgVk0gY29kZSBpbiBKUyBlbmdpbmVzIGR1ZSB0byB0aGVpcgogIC8vIGV4cGxpY2l0bmVzcyBhbmQgZnVuY3Rpb24gaW5saW5pbmcuCiAgZnVuY3Rpb24gaXNVbmRlZiAodikgewogICAgcmV0dXJuIHYgPT09IHVuZGVmaW5lZCB8fCB2ID09PSBudWxsCiAgfQoKICBmdW5jdGlvbiBpc0RlZiAodikgewogICAgcmV0dXJuIHYgIT09IHVuZGVmaW5lZCAmJiB2ICE9PSBudWxsCiAgfQoKICBmdW5jdGlvbiBpc1RydWUgKHYpIHsKICAgIHJldHVybiB2ID09PSB0cnVlCiAgfQoKICBmdW5jdGlvbiBpc0ZhbHNlICh2KSB7CiAgICByZXR1cm4gdiA9PT0gZmFsc2UKICB9CgogIC8qKgogICAqIENoZWNrIGlmIHZhbHVlIGlzIHByaW1pdGl2ZS4KICAgKi8KICBmdW5jdGlvbiBpc1ByaW1pdGl2ZSAodmFsdWUpIHsKICAgIHJldHVybiAoCiAgICAgIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgfHwKICAgICAgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyB8fAogICAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgICAgdHlwZW9mIHZhbHVlID09PSAnc3ltYm9sJyB8fAogICAgICB0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJwogICAgKQogIH0KCiAgLyoqCiAgICogUXVpY2sgb2JqZWN0IGNoZWNrIC0gdGhpcyBpcyBwcmltYXJpbHkgdXNlZCB0byB0ZWxsCiAgICogT2JqZWN0cyBmcm9tIHByaW1pdGl2ZSB2YWx1ZXMgd2hlbiB3ZSBrbm93IHRoZSB2YWx1ZQogICAqIGlzIGEgSlNPTi1jb21wbGlhbnQgdHlwZS4KICAgKi8KICBmdW5jdGlvbiBpc09iamVjdCAob2JqKSB7CiAgICByZXR1cm4gb2JqICE9PSBudWxsICYmIHR5cGVvZiBvYmogPT09ICdvYmplY3QnCiAgfQoKICAvKioKICAgKiBHZXQgdGhlIHJhdyB0eXBlIHN0cmluZyBvZiBhIHZhbHVlLCBlLmcuLCBbb2JqZWN0IE9iamVjdF0uCiAgICovCiAgdmFyIF90b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgogIGZ1bmN0aW9uIHRvUmF3VHlwZSAodmFsdWUpIHsKICAgIHJldHVybiBfdG9TdHJpbmcuY2FsbCh2YWx1ZSkuc2xpY2UoOCwgLTEpCiAgfQoKICAvKioKICAgKiBTdHJpY3Qgb2JqZWN0IHR5cGUgY2hlY2suIE9ubHkgcmV0dXJucyB0cnVlCiAgICogZm9yIHBsYWluIEphdmFTY3JpcHQgb2JqZWN0cy4KICAgKi8KICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0IChvYmopIHsKICAgIHJldHVybiBfdG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBPYmplY3RdJwogIH0KCiAgZnVuY3Rpb24gaXNSZWdFeHAgKHYpIHsKICAgIHJldHVybiBfdG9TdHJpbmcuY2FsbCh2KSA9PT0gJ1tvYmplY3QgUmVnRXhwXScKICB9CgogIC8qKgogICAqIENoZWNrIGlmIHZhbCBpcyBhIHZhbGlkIGFycmF5IGluZGV4LgogICAqLwogIGZ1bmN0aW9uIGlzVmFsaWRBcnJheUluZGV4ICh2YWwpIHsKICAgIHZhciBuID0gcGFyc2VGbG9hdChTdHJpbmcodmFsKSk7CiAgICByZXR1cm4gbiA+PSAwICYmIE1hdGguZmxvb3IobikgPT09IG4gJiYgaXNGaW5pdGUodmFsKQogIH0KCiAgLyoqCiAgICogQ29udmVydCBhIHZhbHVlIHRvIGEgc3RyaW5nIHRoYXQgaXMgYWN0dWFsbHkgcmVuZGVyZWQuCiAgICovCiAgZnVuY3Rpb24gdG9TdHJpbmcgKHZhbCkgewogICAgcmV0dXJuIHZhbCA9PSBudWxsCiAgICAgID8gJycKICAgICAgOiB0eXBlb2YgdmFsID09PSAnb2JqZWN0JwogICAgICAgID8gSlNPTi5zdHJpbmdpZnkodmFsLCBudWxsLCAyKQogICAgICAgIDogU3RyaW5nKHZhbCkKICB9CgogIC8qKgogICAqIENvbnZlcnQgYW4gaW5wdXQgdmFsdWUgdG8gYSBudW1iZXIgZm9yIHBlcnNpc3RlbmNlLgogICAqIElmIHRoZSBjb252ZXJzaW9uIGZhaWxzLCByZXR1cm4gb3JpZ2luYWwgc3RyaW5nLgogICAqLwogIGZ1bmN0aW9uIHRvTnVtYmVyICh2YWwpIHsKICAgIHZhciBuID0gcGFyc2VGbG9hdCh2YWwpOwogICAgcmV0dXJuIGlzTmFOKG4pID8gdmFsIDogbgogIH0KCiAgLyoqCiAgICogTWFrZSBhIG1hcCBhbmQgcmV0dXJuIGEgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGEga2V5CiAgICogaXMgaW4gdGhhdCBtYXAuCiAgICovCiAgZnVuY3Rpb24gbWFrZU1hcCAoCiAgICBzdHIsCiAgICBleHBlY3RzTG93ZXJDYXNlCiAgKSB7CiAgICB2YXIgbWFwID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHZhciBsaXN0ID0gc3RyLnNwbGl0KCcsJyk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgbWFwW2xpc3RbaV1dID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBleHBlY3RzTG93ZXJDYXNlCiAgICAgID8gZnVuY3Rpb24gKHZhbCkgeyByZXR1cm4gbWFwW3ZhbC50b0xvd2VyQ2FzZSgpXTsgfQogICAgICA6IGZ1bmN0aW9uICh2YWwpIHsgcmV0dXJuIG1hcFt2YWxdOyB9CiAgfQoKICAvKioKICAgKiBDaGVjayBpZiBhIHRhZyBpcyBhIGJ1aWx0LWluIHRhZy4KICAgKi8KICB2YXIgaXNCdWlsdEluVGFnID0gbWFrZU1hcCgnc2xvdCxjb21wb25lbnQnLCB0cnVlKTsKCiAgLyoqCiAgICogQ2hlY2sgaWYgYW4gYXR0cmlidXRlIGlzIGEgcmVzZXJ2ZWQgYXR0cmlidXRlLgogICAqLwogIHZhciBpc1Jlc2VydmVkQXR0cmlidXRlID0gbWFrZU1hcCgna2V5LHJlZixzbG90LHNsb3Qtc2NvcGUsaXMnKTsKCiAgLyoqCiAgICogUmVtb3ZlIGFuIGl0ZW0gZnJvbSBhbiBhcnJheS4KICAgKi8KICBmdW5jdGlvbiByZW1vdmUgKGFyciwgaXRlbSkgewogICAgaWYgKGFyci5sZW5ndGgpIHsKICAgICAgdmFyIGluZGV4ID0gYXJyLmluZGV4T2YoaXRlbSk7CiAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgcmV0dXJuIGFyci5zcGxpY2UoaW5kZXgsIDEpCiAgICAgIH0KICAgIH0KICB9CgogIC8qKgogICAqIENoZWNrIHdoZXRoZXIgYW4gb2JqZWN0IGhhcyB0aGUgcHJvcGVydHkuCiAgICovCiAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICBmdW5jdGlvbiBoYXNPd24gKG9iaiwga2V5KSB7CiAgICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkKICB9CgogIC8qKgogICAqIENyZWF0ZSBhIGNhY2hlZCB2ZXJzaW9uIG9mIGEgcHVyZSBmdW5jdGlvbi4KICAgKi8KICBmdW5jdGlvbiBjYWNoZWQgKGZuKSB7CiAgICB2YXIgY2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgcmV0dXJuIChmdW5jdGlvbiBjYWNoZWRGbiAoc3RyKSB7CiAgICAgIHZhciBoaXQgPSBjYWNoZVtzdHJdOwogICAgICByZXR1cm4gaGl0IHx8IChjYWNoZVtzdHJdID0gZm4oc3RyKSkKICAgIH0pCiAgfQoKICAvKioKICAgKiBDYW1lbGl6ZSBhIGh5cGhlbi1kZWxpbWl0ZWQgc3RyaW5nLgogICAqLwogIHZhciBjYW1lbGl6ZVJFID0gLy0oXHcpL2c7CiAgdmFyIGNhbWVsaXplID0gY2FjaGVkKGZ1bmN0aW9uIChzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZShjYW1lbGl6ZVJFLCBmdW5jdGlvbiAoXywgYykgeyByZXR1cm4gYyA/IGMudG9VcHBlckNhc2UoKSA6ICcnOyB9KQogIH0pOwoKICAvKioKICAgKiBDYXBpdGFsaXplIGEgc3RyaW5nLgogICAqLwogIHZhciBjYXBpdGFsaXplID0gY2FjaGVkKGZ1bmN0aW9uIChzdHIpIHsKICAgIHJldHVybiBzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSkKICB9KTsKCiAgLyoqCiAgICogSHlwaGVuYXRlIGEgY2FtZWxDYXNlIHN0cmluZy4KICAgKi8KICB2YXIgaHlwaGVuYXRlUkUgPSAvXEIoW0EtWl0pL2c7CiAgdmFyIGh5cGhlbmF0ZSA9IGNhY2hlZChmdW5jdGlvbiAoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoaHlwaGVuYXRlUkUsICctJDEnKS50b0xvd2VyQ2FzZSgpCiAgfSk7CgogIC8qKgogICAqIFNpbXBsZSBiaW5kIHBvbHlmaWxsIGZvciBlbnZpcm9ubWVudHMgdGhhdCBkbyBub3Qgc3VwcG9ydCBpdCwKICAgKiBlLmcuLCBQaGFudG9tSlMgMS54LiBUZWNobmljYWxseSwgd2UgZG9uJ3QgbmVlZCB0aGlzIGFueW1vcmUKICAgKiBzaW5jZSBuYXRpdmUgYmluZCBpcyBub3cgcGVyZm9ybWFudCBlbm91Z2ggaW4gbW9zdCBicm93c2Vycy4KICAgKiBCdXQgcmVtb3ZpbmcgaXQgd291bGQgbWVhbiBicmVha2luZyBjb2RlIHRoYXQgd2FzIGFibGUgdG8gcnVuIGluCiAgICogUGhhbnRvbUpTIDEueCwgc28gdGhpcyBtdXN0IGJlIGtlcHQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkuCiAgICovCgogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgZnVuY3Rpb24gcG9seWZpbGxCaW5kIChmbiwgY3R4KSB7CiAgICBmdW5jdGlvbiBib3VuZEZuIChhKSB7CiAgICAgIHZhciBsID0gYXJndW1lbnRzLmxlbmd0aDsKICAgICAgcmV0dXJuIGwKICAgICAgICA/IGwgPiAxCiAgICAgICAgICA/IGZuLmFwcGx5KGN0eCwgYXJndW1lbnRzKQogICAgICAgICAgOiBmbi5jYWxsKGN0eCwgYSkKICAgICAgICA6IGZuLmNhbGwoY3R4KQogICAgfQoKICAgIGJvdW5kRm4uX2xlbmd0aCA9IGZuLmxlbmd0aDsKICAgIHJldHVybiBib3VuZEZuCiAgfQoKICBmdW5jdGlvbiBuYXRpdmVCaW5kIChmbiwgY3R4KSB7CiAgICByZXR1cm4gZm4uYmluZChjdHgpCiAgfQoKICB2YXIgYmluZCA9IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kCiAgICA/IG5hdGl2ZUJpbmQKICAgIDogcG9seWZpbGxCaW5kOwoKICAvKioKICAgKiBDb252ZXJ0IGFuIEFycmF5LWxpa2Ugb2JqZWN0IHRvIGEgcmVhbCBBcnJheS4KICAgKi8KICBmdW5jdGlvbiB0b0FycmF5IChsaXN0LCBzdGFydCkgewogICAgc3RhcnQgPSBzdGFydCB8fCAwOwogICAgdmFyIGkgPSBsaXN0Lmxlbmd0aCAtIHN0YXJ0OwogICAgdmFyIHJldCA9IG5ldyBBcnJheShpKTsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgcmV0W2ldID0gbGlzdFtpICsgc3RhcnRdOwogICAgfQogICAgcmV0dXJuIHJldAogIH0KCiAgLyoqCiAgICogTWl4IHByb3BlcnRpZXMgaW50byB0YXJnZXQgb2JqZWN0LgogICAqLwogIGZ1bmN0aW9uIGV4dGVuZCAodG8sIF9mcm9tKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gX2Zyb20pIHsKICAgICAgdG9ba2V5XSA9IF9mcm9tW2tleV07CiAgICB9CiAgICByZXR1cm4gdG8KICB9CgogIC8qKgogICAqIE1lcmdlIGFuIEFycmF5IG9mIE9iamVjdHMgaW50byBhIHNpbmdsZSBPYmplY3QuCiAgICovCiAgZnVuY3Rpb24gdG9PYmplY3QgKGFycikgewogICAgdmFyIHJlcyA9IHt9OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGFycltpXSkgewogICAgICAgIGV4dGVuZChyZXMsIGFycltpXSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXMKICB9CgogIC8qIGVzbGludC1kaXNhYmxlIG5vLXVudXNlZC12YXJzICovCgogIC8qKgogICAqIFBlcmZvcm0gbm8gb3BlcmF0aW9uLgogICAqIFN0dWJiaW5nIGFyZ3MgdG8gbWFrZSBGbG93IGhhcHB5IHdpdGhvdXQgbGVhdmluZyB1c2VsZXNzIHRyYW5zcGlsZWQgY29kZQogICAqIHdpdGggLi4ucmVzdCAoaHR0cHM6Ly9mbG93Lm9yZy9ibG9nLzIwMTcvMDUvMDcvU3RyaWN0LUZ1bmN0aW9uLUNhbGwtQXJpdHkvKS4KICAgKi8KICBmdW5jdGlvbiBub29wIChhLCBiLCBjKSB7fQoKICAvKioKICAgKiBBbHdheXMgcmV0dXJuIGZhbHNlLgogICAqLwogIHZhciBubyA9IGZ1bmN0aW9uIChhLCBiLCBjKSB7IHJldHVybiBmYWxzZTsgfTsKCiAgLyogZXNsaW50LWVuYWJsZSBuby11bnVzZWQtdmFycyAqLwoKICAvKioKICAgKiBSZXR1cm4gdGhlIHNhbWUgdmFsdWUuCiAgICovCiAgdmFyIGlkZW50aXR5ID0gZnVuY3Rpb24gKF8pIHsgcmV0dXJuIF87IH07CgogIC8qKgogICAqIEdlbmVyYXRlIGEgc3RyaW5nIGNvbnRhaW5pbmcgc3RhdGljIGtleXMgZnJvbSBjb21waWxlciBtb2R1bGVzLgogICAqLwogIGZ1bmN0aW9uIGdlblN0YXRpY0tleXMgKG1vZHVsZXMpIHsKICAgIHJldHVybiBtb2R1bGVzLnJlZHVjZShmdW5jdGlvbiAoa2V5cywgbSkgewogICAgICByZXR1cm4ga2V5cy5jb25jYXQobS5zdGF0aWNLZXlzIHx8IFtdKQogICAgfSwgW10pLmpvaW4oJywnKQogIH0KCiAgLyoqCiAgICogQ2hlY2sgaWYgdHdvIHZhbHVlcyBhcmUgbG9vc2VseSBlcXVhbCAtIHRoYXQgaXMsCiAgICogaWYgdGhleSBhcmUgcGxhaW4gb2JqZWN0cywgZG8gdGhleSBoYXZlIHRoZSBzYW1lIHNoYXBlPwogICAqLwogIGZ1bmN0aW9uIGxvb3NlRXF1YWwgKGEsIGIpIHsKICAgIGlmIChhID09PSBiKSB7IHJldHVybiB0cnVlIH0KICAgIHZhciBpc09iamVjdEEgPSBpc09iamVjdChhKTsKICAgIHZhciBpc09iamVjdEIgPSBpc09iamVjdChiKTsKICAgIGlmIChpc09iamVjdEEgJiYgaXNPYmplY3RCKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIGlzQXJyYXlBID0gQXJyYXkuaXNBcnJheShhKTsKICAgICAgICB2YXIgaXNBcnJheUIgPSBBcnJheS5pc0FycmF5KGIpOwogICAgICAgIGlmIChpc0FycmF5QSAmJiBpc0FycmF5QikgewogICAgICAgICAgcmV0dXJuIGEubGVuZ3RoID09PSBiLmxlbmd0aCAmJiBhLmV2ZXJ5KGZ1bmN0aW9uIChlLCBpKSB7CiAgICAgICAgICAgIHJldHVybiBsb29zZUVxdWFsKGUsIGJbaV0pCiAgICAgICAgICB9KQogICAgICAgIH0gZWxzZSBpZiAoYSBpbnN0YW5jZW9mIERhdGUgJiYgYiBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICAgIHJldHVybiBhLmdldFRpbWUoKSA9PT0gYi5nZXRUaW1lKCkKICAgICAgICB9IGVsc2UgaWYgKCFpc0FycmF5QSAmJiAhaXNBcnJheUIpIHsKICAgICAgICAgIHZhciBrZXlzQSA9IE9iamVjdC5rZXlzKGEpOwogICAgICAgICAgdmFyIGtleXNCID0gT2JqZWN0LmtleXMoYik7CiAgICAgICAgICByZXR1cm4ga2V5c0EubGVuZ3RoID09PSBrZXlzQi5sZW5ndGggJiYga2V5c0EuZXZlcnkoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICByZXR1cm4gbG9vc2VFcXVhbChhW2tleV0sIGJba2V5XSkKICAgICAgICAgIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAgIHJldHVybiBmYWxzZQogICAgICB9CiAgICB9IGVsc2UgaWYgKCFpc09iamVjdEEgJiYgIWlzT2JqZWN0QikgewogICAgICByZXR1cm4gU3RyaW5nKGEpID09PSBTdHJpbmcoYikKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KCiAgLyoqCiAgICogUmV0dXJuIHRoZSBmaXJzdCBpbmRleCBhdCB3aGljaCBhIGxvb3NlbHkgZXF1YWwgdmFsdWUgY2FuIGJlCiAgICogZm91bmQgaW4gdGhlIGFycmF5IChpZiB2YWx1ZSBpcyBhIHBsYWluIG9iamVjdCwgdGhlIGFycmF5IG11c3QKICAgKiBjb250YWluIGFuIG9iamVjdCBvZiB0aGUgc2FtZSBzaGFwZSksIG9yIC0xIGlmIGl0IGlzIG5vdCBwcmVzZW50LgogICAqLwogIGZ1bmN0aW9uIGxvb3NlSW5kZXhPZiAoYXJyLCB2YWwpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChsb29zZUVxdWFsKGFycltpXSwgdmFsKSkgeyByZXR1cm4gaSB9CiAgICB9CiAgICByZXR1cm4gLTEKICB9CgogIC8qKgogICAqIEVuc3VyZSBhIGZ1bmN0aW9uIGlzIGNhbGxlZCBvbmx5IG9uY2UuCiAgICovCiAgZnVuY3Rpb24gb25jZSAoZm4pIHsKICAgIHZhciBjYWxsZWQgPSBmYWxzZTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghY2FsbGVkKSB7CiAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgU1NSX0FUVFIgPSAnZGF0YS1zZXJ2ZXItcmVuZGVyZWQnOwoKICB2YXIgQVNTRVRfVFlQRVMgPSBbCiAgICAnY29tcG9uZW50JywKICAgICdkaXJlY3RpdmUnLAogICAgJ2ZpbHRlcicKICBdOwoKICB2YXIgTElGRUNZQ0xFX0hPT0tTID0gWwogICAgJ2JlZm9yZUNyZWF0ZScsCiAgICAnY3JlYXRlZCcsCiAgICAnYmVmb3JlTW91bnQnLAogICAgJ21vdW50ZWQnLAogICAgJ2JlZm9yZVVwZGF0ZScsCiAgICAndXBkYXRlZCcsCiAgICAnYmVmb3JlRGVzdHJveScsCiAgICAnZGVzdHJveWVkJywKICAgICdhY3RpdmF0ZWQnLAogICAgJ2RlYWN0aXZhdGVkJywKICAgICdlcnJvckNhcHR1cmVkJwogIF07CgogIC8qICAqLwoKCgogIHZhciBjb25maWcgPSAoewogICAgLyoqCiAgICAgKiBPcHRpb24gbWVyZ2Ugc3RyYXRlZ2llcyAodXNlZCBpbiBjb3JlL3V0aWwvb3B0aW9ucykKICAgICAqLwogICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICBvcHRpb25NZXJnZVN0cmF0ZWdpZXM6IE9iamVjdC5jcmVhdGUobnVsbCksCgogICAgLyoqCiAgICAgKiBXaGV0aGVyIHRvIHN1cHByZXNzIHdhcm5pbmdzLgogICAgICovCiAgICBzaWxlbnQ6IGZhbHNlLAoKICAgIC8qKgogICAgICogU2hvdyBwcm9kdWN0aW9uIG1vZGUgdGlwIG1lc3NhZ2Ugb24gYm9vdD8KICAgICAqLwogICAgcHJvZHVjdGlvblRpcDogImRldmVsb3BtZW50IiAhPT0gJ3Byb2R1Y3Rpb24nLAoKICAgIC8qKgogICAgICogV2hldGhlciB0byBlbmFibGUgZGV2dG9vbHMKICAgICAqLwogICAgZGV2dG9vbHM6ICJkZXZlbG9wbWVudCIgIT09ICdwcm9kdWN0aW9uJywKCiAgICAvKioKICAgICAqIFdoZXRoZXIgdG8gcmVjb3JkIHBlcmYKICAgICAqLwogICAgcGVyZm9ybWFuY2U6IGZhbHNlLAoKICAgIC8qKgogICAgICogRXJyb3IgaGFuZGxlciBmb3Igd2F0Y2hlciBlcnJvcnMKICAgICAqLwogICAgZXJyb3JIYW5kbGVyOiBudWxsLAoKICAgIC8qKgogICAgICogV2FybiBoYW5kbGVyIGZvciB3YXRjaGVyIHdhcm5zCiAgICAgKi8KICAgIHdhcm5IYW5kbGVyOiBudWxsLAoKICAgIC8qKgogICAgICogSWdub3JlIGNlcnRhaW4gY3VzdG9tIGVsZW1lbnRzCiAgICAgKi8KICAgIGlnbm9yZWRFbGVtZW50czogW10sCgogICAgLyoqCiAgICAgKiBDdXN0b20gdXNlciBrZXkgYWxpYXNlcyBmb3Igdi1vbgogICAgICovCiAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgIGtleUNvZGVzOiBPYmplY3QuY3JlYXRlKG51bGwpLAoKICAgIC8qKgogICAgICogQ2hlY2sgaWYgYSB0YWcgaXMgcmVzZXJ2ZWQgc28gdGhhdCBpdCBjYW5ub3QgYmUgcmVnaXN0ZXJlZCBhcyBhCiAgICAgKiBjb21wb25lbnQuIFRoaXMgaXMgcGxhdGZvcm0tZGVwZW5kZW50IGFuZCBtYXkgYmUgb3ZlcndyaXR0ZW4uCiAgICAgKi8KICAgIGlzUmVzZXJ2ZWRUYWc6IG5vLAoKICAgIC8qKgogICAgICogQ2hlY2sgaWYgYW4gYXR0cmlidXRlIGlzIHJlc2VydmVkIHNvIHRoYXQgaXQgY2Fubm90IGJlIHVzZWQgYXMgYSBjb21wb25lbnQKICAgICAqIHByb3AuIFRoaXMgaXMgcGxhdGZvcm0tZGVwZW5kZW50IGFuZCBtYXkgYmUgb3ZlcndyaXR0ZW4uCiAgICAgKi8KICAgIGlzUmVzZXJ2ZWRBdHRyOiBubywKCiAgICAvKioKICAgICAqIENoZWNrIGlmIGEgdGFnIGlzIGFuIHVua25vd24gZWxlbWVudC4KICAgICAqIFBsYXRmb3JtLWRlcGVuZGVudC4KICAgICAqLwogICAgaXNVbmtub3duRWxlbWVudDogbm8sCgogICAgLyoqCiAgICAgKiBHZXQgdGhlIG5hbWVzcGFjZSBvZiBhbiBlbGVtZW50CiAgICAgKi8KICAgIGdldFRhZ05hbWVzcGFjZTogbm9vcCwKCiAgICAvKioKICAgICAqIFBhcnNlIHRoZSByZWFsIHRhZyBuYW1lIGZvciB0aGUgc3BlY2lmaWMgcGxhdGZvcm0uCiAgICAgKi8KICAgIHBhcnNlUGxhdGZvcm1UYWdOYW1lOiBpZGVudGl0eSwKCiAgICAvKioKICAgICAqIENoZWNrIGlmIGFuIGF0dHJpYnV0ZSBtdXN0IGJlIGJvdW5kIHVzaW5nIHByb3BlcnR5LCBlLmcuIHZhbHVlCiAgICAgKiBQbGF0Zm9ybS1kZXBlbmRlbnQuCiAgICAgKi8KICAgIG11c3RVc2VQcm9wOiBubywKCiAgICAvKioKICAgICAqIFBlcmZvcm0gdXBkYXRlcyBhc3luY2hyb25vdXNseS4gSW50ZW5kZWQgdG8gYmUgdXNlZCBieSBWdWUgVGVzdCBVdGlscwogICAgICogVGhpcyB3aWxsIHNpZ25pZmljYW50bHkgcmVkdWNlIHBlcmZvcm1hbmNlIGlmIHNldCB0byBmYWxzZS4KICAgICAqLwogICAgYXN5bmM6IHRydWUsCgogICAgLyoqCiAgICAgKiBFeHBvc2VkIGZvciBsZWdhY3kgcmVhc29ucwogICAgICovCiAgICBfbGlmZWN5Y2xlSG9va3M6IExJRkVDWUNMRV9IT09LUwogIH0pOwoKICAvKiAgKi8KCiAgLyoqCiAgICogQ2hlY2sgaWYgYSBzdHJpbmcgc3RhcnRzIHdpdGggJCBvciBfCiAgICovCiAgZnVuY3Rpb24gaXNSZXNlcnZlZCAoc3RyKSB7CiAgICB2YXIgYyA9IChzdHIgKyAnJykuY2hhckNvZGVBdCgwKTsKICAgIHJldHVybiBjID09PSAweDI0IHx8IGMgPT09IDB4NUYKICB9CgogIC8qKgogICAqIERlZmluZSBhIHByb3BlcnR5LgogICAqLwogIGZ1bmN0aW9uIGRlZiAob2JqLCBrZXksIHZhbCwgZW51bWVyYWJsZSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICAgIHZhbHVlOiB2YWwsCiAgICAgIGVudW1lcmFibGU6ICEhZW51bWVyYWJsZSwKICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgfSk7CiAgfQoKICAvKioKICAgKiBQYXJzZSBzaW1wbGUgcGF0aC4KICAgKi8KICB2YXIgYmFpbFJFID0gL1teXHcuJF0vOwogIGZ1bmN0aW9uIHBhcnNlUGF0aCAocGF0aCkgewogICAgaWYgKGJhaWxSRS50ZXN0KHBhdGgpKSB7CiAgICAgIHJldHVybgogICAgfQogICAgdmFyIHNlZ21lbnRzID0gcGF0aC5zcGxpdCgnLicpOwogICAgcmV0dXJuIGZ1bmN0aW9uIChvYmopIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWdtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICghb2JqKSB7IHJldHVybiB9CiAgICAgICAgb2JqID0gb2JqW3NlZ21lbnRzW2ldXTsKICAgICAgfQogICAgICByZXR1cm4gb2JqCiAgICB9CiAgfQoKICAvKiAgKi8KCiAgLy8gY2FuIHdlIHVzZSBfX3Byb3RvX18/CiAgdmFyIGhhc1Byb3RvID0gJ19fcHJvdG9fXycgaW4ge307CgogIC8vIEJyb3dzZXIgZW52aXJvbm1lbnQgc25pZmZpbmcKICB2YXIgaW5Ccm93c2VyID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCc7CiAgdmFyIGluV2VleCA9IHR5cGVvZiBXWEVudmlyb25tZW50ICE9PSAndW5kZWZpbmVkJyAmJiAhIVdYRW52aXJvbm1lbnQucGxhdGZvcm07CiAgdmFyIHdlZXhQbGF0Zm9ybSA9IGluV2VleCAmJiBXWEVudmlyb25tZW50LnBsYXRmb3JtLnRvTG93ZXJDYXNlKCk7CiAgdmFyIFVBID0gaW5Ccm93c2VyICYmIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7CiAgdmFyIGlzSUUgPSBVQSAmJiAvbXNpZXx0cmlkZW50Ly50ZXN0KFVBKTsKICB2YXIgaXNJRTkgPSBVQSAmJiBVQS5pbmRleE9mKCdtc2llIDkuMCcpID4gMDsKICB2YXIgaXNFZGdlID0gVUEgJiYgVUEuaW5kZXhPZignZWRnZS8nKSA+IDA7CiAgdmFyIGlzQW5kcm9pZCA9IChVQSAmJiBVQS5pbmRleE9mKCdhbmRyb2lkJykgPiAwKSB8fCAod2VleFBsYXRmb3JtID09PSAnYW5kcm9pZCcpOwogIHZhciBpc0lPUyA9IChVQSAmJiAvaXBob25lfGlwYWR8aXBvZHxpb3MvLnRlc3QoVUEpKSB8fCAod2VleFBsYXRmb3JtID09PSAnaW9zJyk7CiAgdmFyIGlzQ2hyb21lID0gVUEgJiYgL2Nocm9tZVwvXGQrLy50ZXN0KFVBKSAmJiAhaXNFZGdlOwoKICAvLyBGaXJlZm94IGhhcyBhICJ3YXRjaCIgZnVuY3Rpb24gb24gT2JqZWN0LnByb3RvdHlwZS4uLgogIHZhciBuYXRpdmVXYXRjaCA9ICh7fSkud2F0Y2g7CgogIHZhciBzdXBwb3J0c1Bhc3NpdmUgPSBmYWxzZTsKICBpZiAoaW5Ccm93c2VyKSB7CiAgICB0cnkgewogICAgICB2YXIgb3B0cyA9IHt9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob3B0cywgJ3Bhc3NpdmUnLCAoewogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0ICgpIHsKICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgICAgICBzdXBwb3J0c1Bhc3NpdmUgPSB0cnVlOwogICAgICAgIH0KICAgICAgfSkpOyAvLyBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svZmxvdy9pc3N1ZXMvMjg1CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0ZXN0LXBhc3NpdmUnLCBudWxsLCBvcHRzKTsKICAgIH0gY2F0Y2ggKGUpIHt9CiAgfQoKICAvLyB0aGlzIG5lZWRzIHRvIGJlIGxhenktZXZhbGVkIGJlY2F1c2UgdnVlIG1heSBiZSByZXF1aXJlZCBiZWZvcmUKICAvLyB2dWUtc2VydmVyLXJlbmRlcmVyIGNhbiBzZXQgVlVFX0VOVgogIHZhciBfaXNTZXJ2ZXI7CiAgdmFyIGlzU2VydmVyUmVuZGVyaW5nID0gZnVuY3Rpb24gKCkgewogICAgaWYgKF9pc1NlcnZlciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICBpZiAoIWluQnJvd3NlciAmJiAhaW5XZWV4ICYmIHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgLy8gZGV0ZWN0IHByZXNlbmNlIG9mIHZ1ZS1zZXJ2ZXItcmVuZGVyZXIgYW5kIGF2b2lkCiAgICAgICAgLy8gV2VicGFjayBzaGltbWluZyB0aGUgcHJvY2VzcwogICAgICAgIF9pc1NlcnZlciA9IGdsb2JhbFsncHJvY2VzcyddICYmIGdsb2JhbFsncHJvY2VzcyddLmVudi5WVUVfRU5WID09PSAnc2VydmVyJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBfaXNTZXJ2ZXIgPSBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIF9pc1NlcnZlcgogIH07CgogIC8vIGRldGVjdCBkZXZ0b29scwogIHZhciBkZXZ0b29scyA9IGluQnJvd3NlciAmJiB3aW5kb3cuX19WVUVfREVWVE9PTFNfR0xPQkFMX0hPT0tfXzsKCiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICBmdW5jdGlvbiBpc05hdGl2ZSAoQ3RvcikgewogICAgcmV0dXJuIHR5cGVvZiBDdG9yID09PSAnZnVuY3Rpb24nICYmIC9uYXRpdmUgY29kZS8udGVzdChDdG9yLnRvU3RyaW5nKCkpCiAgfQoKICB2YXIgaGFzU3ltYm9sID0KICAgIHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFN5bWJvbCkgJiYKICAgIHR5cGVvZiBSZWZsZWN0ICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShSZWZsZWN0Lm93bktleXMpOwoKICB2YXIgX1NldDsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8gLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgaWYgKHR5cGVvZiBTZXQgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFNldCkpIHsKICAgIC8vIHVzZSBuYXRpdmUgU2V0IHdoZW4gYXZhaWxhYmxlLgogICAgX1NldCA9IFNldDsKICB9IGVsc2UgewogICAgLy8gYSBub24tc3RhbmRhcmQgU2V0IHBvbHlmaWxsIHRoYXQgb25seSB3b3JrcyB3aXRoIHByaW1pdGl2ZSBrZXlzLgogICAgX1NldCA9IC8qQF9fUFVSRV9fKi8oZnVuY3Rpb24gKCkgewogICAgICBmdW5jdGlvbiBTZXQgKCkgewogICAgICAgIHRoaXMuc2V0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgfQogICAgICBTZXQucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uIGhhcyAoa2V5KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0W2tleV0gPT09IHRydWUKICAgICAgfTsKICAgICAgU2V0LnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbiBhZGQgKGtleSkgewogICAgICAgIHRoaXMuc2V0W2tleV0gPSB0cnVlOwogICAgICB9OwogICAgICBTZXQucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gY2xlYXIgKCkgewogICAgICAgIHRoaXMuc2V0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgfTsKCiAgICAgIHJldHVybiBTZXQ7CiAgICB9KCkpOwogIH0KCiAgLyogICovCgogIHZhciB3YXJuID0gbm9vcDsKICB2YXIgdGlwID0gbm9vcDsKICB2YXIgZ2VuZXJhdGVDb21wb25lbnRUcmFjZSA9IChub29wKTsgLy8gd29yayBhcm91bmQgZmxvdyBjaGVjawogIHZhciBmb3JtYXRDb21wb25lbnROYW1lID0gKG5vb3ApOwoKICB7CiAgICB2YXIgaGFzQ29uc29sZSA9IHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJzsKICAgIHZhciBjbGFzc2lmeVJFID0gLyg/Ol58Wy1fXSkoXHcpL2c7CiAgICB2YXIgY2xhc3NpZnkgPSBmdW5jdGlvbiAoc3RyKSB7IHJldHVybiBzdHIKICAgICAgLnJlcGxhY2UoY2xhc3NpZnlSRSwgZnVuY3Rpb24gKGMpIHsgcmV0dXJuIGMudG9VcHBlckNhc2UoKTsgfSkKICAgICAgLnJlcGxhY2UoL1stX10vZywgJycpOyB9OwoKICAgIHdhcm4gPSBmdW5jdGlvbiAobXNnLCB2bSkgewogICAgICB2YXIgdHJhY2UgPSB2bSA/IGdlbmVyYXRlQ29tcG9uZW50VHJhY2Uodm0pIDogJyc7CgogICAgICBpZiAoY29uZmlnLndhcm5IYW5kbGVyKSB7CiAgICAgICAgY29uZmlnLndhcm5IYW5kbGVyLmNhbGwobnVsbCwgbXNnLCB2bSwgdHJhY2UpOwogICAgICB9IGVsc2UgaWYgKGhhc0NvbnNvbGUgJiYgKCFjb25maWcuc2lsZW50KSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoKCJbVnVlIHdhcm5dOiAiICsgbXNnICsgdHJhY2UpKTsKICAgICAgfQogICAgfTsKCiAgICB0aXAgPSBmdW5jdGlvbiAobXNnLCB2bSkgewogICAgICBpZiAoaGFzQ29uc29sZSAmJiAoIWNvbmZpZy5zaWxlbnQpKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJbVnVlIHRpcF06ICIgKyBtc2cgKyAoCiAgICAgICAgICB2bSA/IGdlbmVyYXRlQ29tcG9uZW50VHJhY2Uodm0pIDogJycKICAgICAgICApKTsKICAgICAgfQogICAgfTsKCiAgICBmb3JtYXRDb21wb25lbnROYW1lID0gZnVuY3Rpb24gKHZtLCBpbmNsdWRlRmlsZSkgewogICAgICBpZiAodm0uJHJvb3QgPT09IHZtKSB7CiAgICAgICAgcmV0dXJuICc8Um9vdD4nCiAgICAgIH0KICAgICAgdmFyIG9wdGlvbnMgPSB0eXBlb2Ygdm0gPT09ICdmdW5jdGlvbicgJiYgdm0uY2lkICE9IG51bGwKICAgICAgICA/IHZtLm9wdGlvbnMKICAgICAgICA6IHZtLl9pc1Z1ZQogICAgICAgICAgPyB2bS4kb3B0aW9ucyB8fCB2bS5jb25zdHJ1Y3Rvci5vcHRpb25zCiAgICAgICAgICA6IHZtIHx8IHt9OwogICAgICB2YXIgbmFtZSA9IG9wdGlvbnMubmFtZSB8fCBvcHRpb25zLl9jb21wb25lbnRUYWc7CiAgICAgIHZhciBmaWxlID0gb3B0aW9ucy5fX2ZpbGU7CiAgICAgIGlmICghbmFtZSAmJiBmaWxlKSB7CiAgICAgICAgdmFyIG1hdGNoID0gZmlsZS5tYXRjaCgvKFteL1xcXSspXC52dWUkLyk7CiAgICAgICAgbmFtZSA9IG1hdGNoICYmIG1hdGNoWzFdOwogICAgICB9CgogICAgICByZXR1cm4gKAogICAgICAgIChuYW1lID8gKCI8IiArIChjbGFzc2lmeShuYW1lKSkgKyAiPiIpIDogIjxBbm9ueW1vdXM+IikgKwogICAgICAgIChmaWxlICYmIGluY2x1ZGVGaWxlICE9PSBmYWxzZSA/ICgiIGF0ICIgKyBmaWxlKSA6ICcnKQogICAgICApCiAgICB9OwoKICAgIHZhciByZXBlYXQgPSBmdW5jdGlvbiAoc3RyLCBuKSB7CiAgICAgIHZhciByZXMgPSAnJzsKICAgICAgd2hpbGUgKG4pIHsKICAgICAgICBpZiAobiAlIDIgPT09IDEpIHsgcmVzICs9IHN0cjsgfQogICAgICAgIGlmIChuID4gMSkgeyBzdHIgKz0gc3RyOyB9CiAgICAgICAgbiA+Pj0gMTsKICAgICAgfQogICAgICByZXR1cm4gcmVzCiAgICB9OwoKICAgIGdlbmVyYXRlQ29tcG9uZW50VHJhY2UgPSBmdW5jdGlvbiAodm0pIHsKICAgICAgaWYgKHZtLl9pc1Z1ZSAmJiB2bS4kcGFyZW50KSB7CiAgICAgICAgdmFyIHRyZWUgPSBbXTsKICAgICAgICB2YXIgY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlID0gMDsKICAgICAgICB3aGlsZSAodm0pIHsKICAgICAgICAgIGlmICh0cmVlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIGxhc3QgPSB0cmVlW3RyZWUubGVuZ3RoIC0gMV07CiAgICAgICAgICAgIGlmIChsYXN0LmNvbnN0cnVjdG9yID09PSB2bS5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSsrOwogICAgICAgICAgICAgIHZtID0gdm0uJHBhcmVudDsKICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSA+IDApIHsKICAgICAgICAgICAgICB0cmVlW3RyZWUubGVuZ3RoIC0gMV0gPSBbbGFzdCwgY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlXTsKICAgICAgICAgICAgICBjdXJyZW50UmVjdXJzaXZlU2VxdWVuY2UgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0cmVlLnB1c2godm0pOwogICAgICAgICAgdm0gPSB2bS4kcGFyZW50OwogICAgICAgIH0KICAgICAgICByZXR1cm4gJ1xuXG5mb3VuZCBpblxuXG4nICsgdHJlZQogICAgICAgICAgLm1hcChmdW5jdGlvbiAodm0sIGkpIHsgcmV0dXJuICgiIiArIChpID09PSAwID8gJy0tLT4gJyA6IHJlcGVhdCgnICcsIDUgKyBpICogMikpICsgKEFycmF5LmlzQXJyYXkodm0pCiAgICAgICAgICAgICAgPyAoKGZvcm1hdENvbXBvbmVudE5hbWUodm1bMF0pKSArICIuLi4gKCIgKyAodm1bMV0pICsgIiByZWN1cnNpdmUgY2FsbHMpIikKICAgICAgICAgICAgICA6IGZvcm1hdENvbXBvbmVudE5hbWUodm0pKSk7IH0pCiAgICAgICAgICAuam9pbignXG4nKQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAoIlxuXG4oZm91bmQgaW4gIiArIChmb3JtYXRDb21wb25lbnROYW1lKHZtKSkgKyAiKSIpCiAgICAgIH0KICAgIH07CiAgfQoKICAvKiAgKi8KCiAgdmFyIHVpZCA9IDA7CgogIC8qKgogICAqIEEgZGVwIGlzIGFuIG9ic2VydmFibGUgdGhhdCBjYW4gaGF2ZSBtdWx0aXBsZQogICAqIGRpcmVjdGl2ZXMgc3Vic2NyaWJpbmcgdG8gaXQuCiAgICovCiAgdmFyIERlcCA9IGZ1bmN0aW9uIERlcCAoKSB7CiAgICB0aGlzLmlkID0gdWlkKys7CiAgICB0aGlzLnN1YnMgPSBbXTsKICB9OwoKICBEZXAucHJvdG90eXBlLmFkZFN1YiA9IGZ1bmN0aW9uIGFkZFN1YiAoc3ViKSB7CiAgICB0aGlzLnN1YnMucHVzaChzdWIpOwogIH07CgogIERlcC5wcm90b3R5cGUucmVtb3ZlU3ViID0gZnVuY3Rpb24gcmVtb3ZlU3ViIChzdWIpIHsKICAgIHJlbW92ZSh0aGlzLnN1YnMsIHN1Yik7CiAgfTsKCiAgRGVwLnByb3RvdHlwZS5kZXBlbmQgPSBmdW5jdGlvbiBkZXBlbmQgKCkgewogICAgaWYgKERlcC50YXJnZXQpIHsKICAgICAgRGVwLnRhcmdldC5hZGREZXAodGhpcyk7CiAgICB9CiAgfTsKCiAgRGVwLnByb3RvdHlwZS5ub3RpZnkgPSBmdW5jdGlvbiBub3RpZnkgKCkgewogICAgLy8gc3RhYmlsaXplIHRoZSBzdWJzY3JpYmVyIGxpc3QgZmlyc3QKICAgIHZhciBzdWJzID0gdGhpcy5zdWJzLnNsaWNlKCk7CiAgICBpZiAoIWNvbmZpZy5hc3luYykgewogICAgICAvLyBzdWJzIGFyZW4ndCBzb3J0ZWQgaW4gc2NoZWR1bGVyIGlmIG5vdCBydW5uaW5nIGFzeW5jCiAgICAgIC8vIHdlIG5lZWQgdG8gc29ydCB0aGVtIG5vdyB0byBtYWtlIHN1cmUgdGhleSBmaXJlIGluIGNvcnJlY3QKICAgICAgLy8gb3JkZXIKICAgICAgc3Vicy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiBhLmlkIC0gYi5pZDsgfSk7CiAgICB9CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHN1YnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHN1YnNbaV0udXBkYXRlKCk7CiAgICB9CiAgfTsKCiAgLy8gdGhlIGN1cnJlbnQgdGFyZ2V0IHdhdGNoZXIgYmVpbmcgZXZhbHVhdGVkLgogIC8vIHRoaXMgaXMgZ2xvYmFsbHkgdW5pcXVlIGJlY2F1c2UgdGhlcmUgY291bGQgYmUgb25seSBvbmUKICAvLyB3YXRjaGVyIGJlaW5nIGV2YWx1YXRlZCBhdCBhbnkgdGltZS4KICBEZXAudGFyZ2V0ID0gbnVsbDsKICB2YXIgdGFyZ2V0U3RhY2sgPSBbXTsKCiAgZnVuY3Rpb24gcHVzaFRhcmdldCAodGFyZ2V0KSB7CiAgICB0YXJnZXRTdGFjay5wdXNoKHRhcmdldCk7CiAgICBEZXAudGFyZ2V0ID0gdGFyZ2V0OwogIH0KCiAgZnVuY3Rpb24gcG9wVGFyZ2V0ICgpIHsKICAgIHRhcmdldFN0YWNrLnBvcCgpOwogICAgRGVwLnRhcmdldCA9IHRhcmdldFN0YWNrW3RhcmdldFN0YWNrLmxlbmd0aCAtIDFdOwogIH0KCiAgLyogICovCgogIHZhciBWTm9kZSA9IGZ1bmN0aW9uIFZOb2RlICgKICAgIHRhZywKICAgIGRhdGEsCiAgICBjaGlsZHJlbiwKICAgIHRleHQsCiAgICBlbG0sCiAgICBjb250ZXh0LAogICAgY29tcG9uZW50T3B0aW9ucywKICAgIGFzeW5jRmFjdG9yeQogICkgewogICAgdGhpcy50YWcgPSB0YWc7CiAgICB0aGlzLmRhdGEgPSBkYXRhOwogICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgdGhpcy50ZXh0ID0gdGV4dDsKICAgIHRoaXMuZWxtID0gZWxtOwogICAgdGhpcy5ucyA9IHVuZGVmaW5lZDsKICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICB0aGlzLmZuQ29udGV4dCA9IHVuZGVmaW5lZDsKICAgIHRoaXMuZm5PcHRpb25zID0gdW5kZWZpbmVkOwogICAgdGhpcy5mblNjb3BlSWQgPSB1bmRlZmluZWQ7CiAgICB0aGlzLmtleSA9IGRhdGEgJiYgZGF0YS5rZXk7CiAgICB0aGlzLmNvbXBvbmVudE9wdGlvbnMgPSBjb21wb25lbnRPcHRpb25zOwogICAgdGhpcy5jb21wb25lbnRJbnN0YW5jZSA9IHVuZGVmaW5lZDsKICAgIHRoaXMucGFyZW50ID0gdW5kZWZpbmVkOwogICAgdGhpcy5yYXcgPSBmYWxzZTsKICAgIHRoaXMuaXNTdGF0aWMgPSBmYWxzZTsKICAgIHRoaXMuaXNSb290SW5zZXJ0ID0gdHJ1ZTsKICAgIHRoaXMuaXNDb21tZW50ID0gZmFsc2U7CiAgICB0aGlzLmlzQ2xvbmVkID0gZmFsc2U7CiAgICB0aGlzLmlzT25jZSA9IGZhbHNlOwogICAgdGhpcy5hc3luY0ZhY3RvcnkgPSBhc3luY0ZhY3Rvcnk7CiAgICB0aGlzLmFzeW5jTWV0YSA9IHVuZGVmaW5lZDsKICAgIHRoaXMuaXNBc3luY1BsYWNlaG9sZGVyID0gZmFsc2U7CiAgfTsKCiAgdmFyIHByb3RvdHlwZUFjY2Vzc29ycyA9IHsgY2hpbGQ6IHsgY29uZmlndXJhYmxlOiB0cnVlIH0gfTsKCiAgLy8gREVQUkVDQVRFRDogYWxpYXMgZm9yIGNvbXBvbmVudEluc3RhbmNlIGZvciBiYWNrd2FyZHMgY29tcGF0LgogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgcHJvdG90eXBlQWNjZXNzb3JzLmNoaWxkLmdldCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbXBvbmVudEluc3RhbmNlCiAgfTsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoIFZOb2RlLnByb3RvdHlwZSwgcHJvdG90eXBlQWNjZXNzb3JzICk7CgogIHZhciBjcmVhdGVFbXB0eVZOb2RlID0gZnVuY3Rpb24gKHRleHQpIHsKICAgIGlmICggdGV4dCA9PT0gdm9pZCAwICkgdGV4dCA9ICcnOwoKICAgIHZhciBub2RlID0gbmV3IFZOb2RlKCk7CiAgICBub2RlLnRleHQgPSB0ZXh0OwogICAgbm9kZS5pc0NvbW1lbnQgPSB0cnVlOwogICAgcmV0dXJuIG5vZGUKICB9OwoKICBmdW5jdGlvbiBjcmVhdGVUZXh0Vk5vZGUgKHZhbCkgewogICAgcmV0dXJuIG5ldyBWTm9kZSh1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBTdHJpbmcodmFsKSkKICB9CgogIC8vIG9wdGltaXplZCBzaGFsbG93IGNsb25lCiAgLy8gdXNlZCBmb3Igc3RhdGljIG5vZGVzIGFuZCBzbG90IG5vZGVzIGJlY2F1c2UgdGhleSBtYXkgYmUgcmV1c2VkIGFjcm9zcwogIC8vIG11bHRpcGxlIHJlbmRlcnMsIGNsb25pbmcgdGhlbSBhdm9pZHMgZXJyb3JzIHdoZW4gRE9NIG1hbmlwdWxhdGlvbnMgcmVseQogIC8vIG9uIHRoZWlyIGVsbSByZWZlcmVuY2UuCiAgZnVuY3Rpb24gY2xvbmVWTm9kZSAodm5vZGUpIHsKICAgIHZhciBjbG9uZWQgPSBuZXcgVk5vZGUoCiAgICAgIHZub2RlLnRhZywKICAgICAgdm5vZGUuZGF0YSwKICAgICAgLy8gIzc5NzUKICAgICAgLy8gY2xvbmUgY2hpbGRyZW4gYXJyYXkgdG8gYXZvaWQgbXV0YXRpbmcgb3JpZ2luYWwgaW4gY2FzZSBvZiBjbG9uaW5nCiAgICAgIC8vIGEgY2hpbGQuCiAgICAgIHZub2RlLmNoaWxkcmVuICYmIHZub2RlLmNoaWxkcmVuLnNsaWNlKCksCiAgICAgIHZub2RlLnRleHQsCiAgICAgIHZub2RlLmVsbSwKICAgICAgdm5vZGUuY29udGV4dCwKICAgICAgdm5vZGUuY29tcG9uZW50T3B0aW9ucywKICAgICAgdm5vZGUuYXN5bmNGYWN0b3J5CiAgICApOwogICAgY2xvbmVkLm5zID0gdm5vZGUubnM7CiAgICBjbG9uZWQuaXNTdGF0aWMgPSB2bm9kZS5pc1N0YXRpYzsKICAgIGNsb25lZC5rZXkgPSB2bm9kZS5rZXk7CiAgICBjbG9uZWQuaXNDb21tZW50ID0gdm5vZGUuaXNDb21tZW50OwogICAgY2xvbmVkLmZuQ29udGV4dCA9IHZub2RlLmZuQ29udGV4dDsKICAgIGNsb25lZC5mbk9wdGlvbnMgPSB2bm9kZS5mbk9wdGlvbnM7CiAgICBjbG9uZWQuZm5TY29wZUlkID0gdm5vZGUuZm5TY29wZUlkOwogICAgY2xvbmVkLmFzeW5jTWV0YSA9IHZub2RlLmFzeW5jTWV0YTsKICAgIGNsb25lZC5pc0Nsb25lZCA9IHRydWU7CiAgICByZXR1cm4gY2xvbmVkCiAgfQoKICAvKgogICAqIG5vdCB0eXBlIGNoZWNraW5nIHRoaXMgZmlsZSBiZWNhdXNlIGZsb3cgZG9lc24ndCBwbGF5IHdlbGwgd2l0aAogICAqIGR5bmFtaWNhbGx5IGFjY2Vzc2luZyBtZXRob2RzIG9uIEFycmF5IHByb3RvdHlwZQogICAqLwoKICB2YXIgYXJyYXlQcm90byA9IEFycmF5LnByb3RvdHlwZTsKICB2YXIgYXJyYXlNZXRob2RzID0gT2JqZWN0LmNyZWF0ZShhcnJheVByb3RvKTsKCiAgdmFyIG1ldGhvZHNUb1BhdGNoID0gWwogICAgJ3B1c2gnLAogICAgJ3BvcCcsCiAgICAnc2hpZnQnLAogICAgJ3Vuc2hpZnQnLAogICAgJ3NwbGljZScsCiAgICAnc29ydCcsCiAgICAncmV2ZXJzZScKICBdOwoKICAvKioKICAgKiBJbnRlcmNlcHQgbXV0YXRpbmcgbWV0aG9kcyBhbmQgZW1pdCBldmVudHMKICAgKi8KICBtZXRob2RzVG9QYXRjaC5mb3JFYWNoKGZ1bmN0aW9uIChtZXRob2QpIHsKICAgIC8vIGNhY2hlIG9yaWdpbmFsIG1ldGhvZAogICAgdmFyIG9yaWdpbmFsID0gYXJyYXlQcm90b1ttZXRob2RdOwogICAgZGVmKGFycmF5TWV0aG9kcywgbWV0aG9kLCBmdW5jdGlvbiBtdXRhdG9yICgpIHsKICAgICAgdmFyIGFyZ3MgPSBbXSwgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgICAgd2hpbGUgKCBsZW4tLSApIGFyZ3NbIGxlbiBdID0gYXJndW1lbnRzWyBsZW4gXTsKCiAgICAgIHZhciByZXN1bHQgPSBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgdmFyIG9iID0gdGhpcy5fX29iX187CiAgICAgIHZhciBpbnNlcnRlZDsKICAgICAgc3dpdGNoIChtZXRob2QpIHsKICAgICAgICBjYXNlICdwdXNoJzoKICAgICAgICBjYXNlICd1bnNoaWZ0JzoKICAgICAgICAgIGluc2VydGVkID0gYXJnczsKICAgICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAnc3BsaWNlJzoKICAgICAgICAgIGluc2VydGVkID0gYXJncy5zbGljZSgyKTsKICAgICAgICAgIGJyZWFrCiAgICAgIH0KICAgICAgaWYgKGluc2VydGVkKSB7IG9iLm9ic2VydmVBcnJheShpbnNlcnRlZCk7IH0KICAgICAgLy8gbm90aWZ5IGNoYW5nZQogICAgICBvYi5kZXAubm90aWZ5KCk7CiAgICAgIHJldHVybiByZXN1bHQKICAgIH0pOwogIH0pOwoKICAvKiAgKi8KCiAgdmFyIGFycmF5S2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGFycmF5TWV0aG9kcyk7CgogIC8qKgogICAqIEluIHNvbWUgY2FzZXMgd2UgbWF5IHdhbnQgdG8gZGlzYWJsZSBvYnNlcnZhdGlvbiBpbnNpZGUgYSBjb21wb25lbnQncwogICAqIHVwZGF0ZSBjb21wdXRhdGlvbi4KICAgKi8KICB2YXIgc2hvdWxkT2JzZXJ2ZSA9IHRydWU7CgogIGZ1bmN0aW9uIHRvZ2dsZU9ic2VydmluZyAodmFsdWUpIHsKICAgIHNob3VsZE9ic2VydmUgPSB2YWx1ZTsKICB9CgogIC8qKgogICAqIE9ic2VydmVyIGNsYXNzIHRoYXQgaXMgYXR0YWNoZWQgdG8gZWFjaCBvYnNlcnZlZAogICAqIG9iamVjdC4gT25jZSBhdHRhY2hlZCwgdGhlIG9ic2VydmVyIGNvbnZlcnRzIHRoZSB0YXJnZXQKICAgKiBvYmplY3QncyBwcm9wZXJ0eSBrZXlzIGludG8gZ2V0dGVyL3NldHRlcnMgdGhhdAogICAqIGNvbGxlY3QgZGVwZW5kZW5jaWVzIGFuZCBkaXNwYXRjaCB1cGRhdGVzLgogICAqLwogIHZhciBPYnNlcnZlciA9IGZ1bmN0aW9uIE9ic2VydmVyICh2YWx1ZSkgewogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgdGhpcy5kZXAgPSBuZXcgRGVwKCk7CiAgICB0aGlzLnZtQ291bnQgPSAwOwogICAgZGVmKHZhbHVlLCAnX19vYl9fJywgdGhpcyk7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgaWYgKGhhc1Byb3RvKSB7CiAgICAgICAgcHJvdG9BdWdtZW50KHZhbHVlLCBhcnJheU1ldGhvZHMpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvcHlBdWdtZW50KHZhbHVlLCBhcnJheU1ldGhvZHMsIGFycmF5S2V5cyk7CiAgICAgIH0KICAgICAgdGhpcy5vYnNlcnZlQXJyYXkodmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy53YWxrKHZhbHVlKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBXYWxrIHRocm91Z2ggYWxsIHByb3BlcnRpZXMgYW5kIGNvbnZlcnQgdGhlbSBpbnRvCiAgICogZ2V0dGVyL3NldHRlcnMuIFRoaXMgbWV0aG9kIHNob3VsZCBvbmx5IGJlIGNhbGxlZCB3aGVuCiAgICogdmFsdWUgdHlwZSBpcyBPYmplY3QuCiAgICovCiAgT2JzZXJ2ZXIucHJvdG90eXBlLndhbGsgPSBmdW5jdGlvbiB3YWxrIChvYmopIHsKICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBkZWZpbmVSZWFjdGl2ZSQkMShvYmosIGtleXNbaV0pOwogICAgfQogIH07CgogIC8qKgogICAqIE9ic2VydmUgYSBsaXN0IG9mIEFycmF5IGl0ZW1zLgogICAqLwogIE9ic2VydmVyLnByb3RvdHlwZS5vYnNlcnZlQXJyYXkgPSBmdW5jdGlvbiBvYnNlcnZlQXJyYXkgKGl0ZW1zKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGl0ZW1zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBvYnNlcnZlKGl0ZW1zW2ldKTsKICAgIH0KICB9OwoKICAvLyBoZWxwZXJzCgogIC8qKgogICAqIEF1Z21lbnQgYSB0YXJnZXQgT2JqZWN0IG9yIEFycmF5IGJ5IGludGVyY2VwdGluZwogICAqIHRoZSBwcm90b3R5cGUgY2hhaW4gdXNpbmcgX19wcm90b19fCiAgICovCiAgZnVuY3Rpb24gcHJvdG9BdWdtZW50ICh0YXJnZXQsIHNyYykgewogICAgLyogZXNsaW50LWRpc2FibGUgbm8tcHJvdG8gKi8KICAgIHRhcmdldC5fX3Byb3RvX18gPSBzcmM7CiAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLXByb3RvICovCiAgfQoKICAvKioKICAgKiBBdWdtZW50IGEgdGFyZ2V0IE9iamVjdCBvciBBcnJheSBieSBkZWZpbmluZwogICAqIGhpZGRlbiBwcm9wZXJ0aWVzLgogICAqLwogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgZnVuY3Rpb24gY29weUF1Z21lbnQgKHRhcmdldCwgc3JjLCBrZXlzKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICBkZWYodGFyZ2V0LCBrZXksIHNyY1trZXldKTsKICAgIH0KICB9CgogIC8qKgogICAqIEF0dGVtcHQgdG8gY3JlYXRlIGFuIG9ic2VydmVyIGluc3RhbmNlIGZvciBhIHZhbHVlLAogICAqIHJldHVybnMgdGhlIG5ldyBvYnNlcnZlciBpZiBzdWNjZXNzZnVsbHkgb2JzZXJ2ZWQsCiAgICogb3IgdGhlIGV4aXN0aW5nIG9ic2VydmVyIGlmIHRoZSB2YWx1ZSBhbHJlYWR5IGhhcyBvbmUuCiAgICovCiAgZnVuY3Rpb24gb2JzZXJ2ZSAodmFsdWUsIGFzUm9vdERhdGEpIHsKICAgIGlmICghaXNPYmplY3QodmFsdWUpIHx8IHZhbHVlIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICB2YXIgb2I7CiAgICBpZiAoaGFzT3duKHZhbHVlLCAnX19vYl9fJykgJiYgdmFsdWUuX19vYl9fIGluc3RhbmNlb2YgT2JzZXJ2ZXIpIHsKICAgICAgb2IgPSB2YWx1ZS5fX29iX187CiAgICB9IGVsc2UgaWYgKAogICAgICBzaG91bGRPYnNlcnZlICYmCiAgICAgICFpc1NlcnZlclJlbmRlcmluZygpICYmCiAgICAgIChBcnJheS5pc0FycmF5KHZhbHVlKSB8fCBpc1BsYWluT2JqZWN0KHZhbHVlKSkgJiYKICAgICAgT2JqZWN0LmlzRXh0ZW5zaWJsZSh2YWx1ZSkgJiYKICAgICAgIXZhbHVlLl9pc1Z1ZQogICAgKSB7CiAgICAgIG9iID0gbmV3IE9ic2VydmVyKHZhbHVlKTsKICAgIH0KICAgIGlmIChhc1Jvb3REYXRhICYmIG9iKSB7CiAgICAgIG9iLnZtQ291bnQrKzsKICAgIH0KICAgIHJldHVybiBvYgogIH0KCiAgLyoqCiAgICogRGVmaW5lIGEgcmVhY3RpdmUgcHJvcGVydHkgb24gYW4gT2JqZWN0LgogICAqLwogIGZ1bmN0aW9uIGRlZmluZVJlYWN0aXZlJCQxICgKICAgIG9iaiwKICAgIGtleSwKICAgIHZhbCwKICAgIGN1c3RvbVNldHRlciwKICAgIHNoYWxsb3cKICApIHsKICAgIHZhciBkZXAgPSBuZXcgRGVwKCk7CgogICAgdmFyIHByb3BlcnR5ID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmosIGtleSk7CiAgICBpZiAocHJvcGVydHkgJiYgcHJvcGVydHkuY29uZmlndXJhYmxlID09PSBmYWxzZSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICAvLyBjYXRlciBmb3IgcHJlLWRlZmluZWQgZ2V0dGVyL3NldHRlcnMKICAgIHZhciBnZXR0ZXIgPSBwcm9wZXJ0eSAmJiBwcm9wZXJ0eS5nZXQ7CiAgICB2YXIgc2V0dGVyID0gcHJvcGVydHkgJiYgcHJvcGVydHkuc2V0OwogICAgaWYgKCghZ2V0dGVyIHx8IHNldHRlcikgJiYgYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewogICAgICB2YWwgPSBvYmpba2V5XTsKICAgIH0KCiAgICB2YXIgY2hpbGRPYiA9ICFzaGFsbG93ICYmIG9ic2VydmUodmFsKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIGdldDogZnVuY3Rpb24gcmVhY3RpdmVHZXR0ZXIgKCkgewogICAgICAgIHZhciB2YWx1ZSA9IGdldHRlciA/IGdldHRlci5jYWxsKG9iaikgOiB2YWw7CiAgICAgICAgaWYgKERlcC50YXJnZXQpIHsKICAgICAgICAgIGRlcC5kZXBlbmQoKTsKICAgICAgICAgIGlmIChjaGlsZE9iKSB7CiAgICAgICAgICAgIGNoaWxkT2IuZGVwLmRlcGVuZCgpOwogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICBkZXBlbmRBcnJheSh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gcmVhY3RpdmVTZXR0ZXIgKG5ld1ZhbCkgewogICAgICAgIHZhciB2YWx1ZSA9IGdldHRlciA/IGdldHRlci5jYWxsKG9iaikgOiB2YWw7CiAgICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tc2VsZi1jb21wYXJlICovCiAgICAgICAgaWYgKG5ld1ZhbCA9PT0gdmFsdWUgfHwgKG5ld1ZhbCAhPT0gbmV3VmFsICYmIHZhbHVlICE9PSB2YWx1ZSkpIHsKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLXNlbGYtY29tcGFyZSAqLwogICAgICAgIGlmIChjdXN0b21TZXR0ZXIpIHsKICAgICAgICAgIGN1c3RvbVNldHRlcigpOwogICAgICAgIH0KICAgICAgICAvLyAjNzk4MTogZm9yIGFjY2Vzc29yIHByb3BlcnRpZXMgd2l0aG91dCBzZXR0ZXIKICAgICAgICBpZiAoZ2V0dGVyICYmICFzZXR0ZXIpIHsgcmV0dXJuIH0KICAgICAgICBpZiAoc2V0dGVyKSB7CiAgICAgICAgICBzZXR0ZXIuY2FsbChvYmosIG5ld1ZhbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhbCA9IG5ld1ZhbDsKICAgICAgICB9CiAgICAgICAgY2hpbGRPYiA9ICFzaGFsbG93ICYmIG9ic2VydmUobmV3VmFsKTsKICAgICAgICBkZXAubm90aWZ5KCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLyoqCiAgICogU2V0IGEgcHJvcGVydHkgb24gYW4gb2JqZWN0LiBBZGRzIHRoZSBuZXcgcHJvcGVydHkgYW5kCiAgICogdHJpZ2dlcnMgY2hhbmdlIG5vdGlmaWNhdGlvbiBpZiB0aGUgcHJvcGVydHkgZG9lc24ndAogICAqIGFscmVhZHkgZXhpc3QuCiAgICovCiAgZnVuY3Rpb24gc2V0ICh0YXJnZXQsIGtleSwgdmFsKSB7CiAgICBpZiAoaXNVbmRlZih0YXJnZXQpIHx8IGlzUHJpbWl0aXZlKHRhcmdldCkKICAgICkgewogICAgICB3YXJuKCgiQ2Fubm90IHNldCByZWFjdGl2ZSBwcm9wZXJ0eSBvbiB1bmRlZmluZWQsIG51bGwsIG9yIHByaW1pdGl2ZSB2YWx1ZTogIiArICgodGFyZ2V0KSkpKTsKICAgIH0KICAgIGlmIChBcnJheS5pc0FycmF5KHRhcmdldCkgJiYgaXNWYWxpZEFycmF5SW5kZXgoa2V5KSkgewogICAgICB0YXJnZXQubGVuZ3RoID0gTWF0aC5tYXgodGFyZ2V0Lmxlbmd0aCwga2V5KTsKICAgICAgdGFyZ2V0LnNwbGljZShrZXksIDEsIHZhbCk7CiAgICAgIHJldHVybiB2YWwKICAgIH0KICAgIGlmIChrZXkgaW4gdGFyZ2V0ICYmICEoa2V5IGluIE9iamVjdC5wcm90b3R5cGUpKSB7CiAgICAgIHRhcmdldFtrZXldID0gdmFsOwogICAgICByZXR1cm4gdmFsCiAgICB9CiAgICB2YXIgb2IgPSAodGFyZ2V0KS5fX29iX187CiAgICBpZiAodGFyZ2V0Ll9pc1Z1ZSB8fCAob2IgJiYgb2Iudm1Db3VudCkpIHsKICAgICAgd2FybigKICAgICAgICAnQXZvaWQgYWRkaW5nIHJlYWN0aXZlIHByb3BlcnRpZXMgdG8gYSBWdWUgaW5zdGFuY2Ugb3IgaXRzIHJvb3QgJGRhdGEgJyArCiAgICAgICAgJ2F0IHJ1bnRpbWUgLSBkZWNsYXJlIGl0IHVwZnJvbnQgaW4gdGhlIGRhdGEgb3B0aW9uLicKICAgICAgKTsKICAgICAgcmV0dXJuIHZhbAogICAgfQogICAgaWYgKCFvYikgewogICAgICB0YXJnZXRba2V5XSA9IHZhbDsKICAgICAgcmV0dXJuIHZhbAogICAgfQogICAgZGVmaW5lUmVhY3RpdmUkJDEob2IudmFsdWUsIGtleSwgdmFsKTsKICAgIG9iLmRlcC5ub3RpZnkoKTsKICAgIHJldHVybiB2YWwKICB9CgogIC8qKgogICAqIERlbGV0ZSBhIHByb3BlcnR5IGFuZCB0cmlnZ2VyIGNoYW5nZSBpZiBuZWNlc3NhcnkuCiAgICovCiAgZnVuY3Rpb24gZGVsICh0YXJnZXQsIGtleSkgewogICAgaWYgKGlzVW5kZWYodGFyZ2V0KSB8fCBpc1ByaW1pdGl2ZSh0YXJnZXQpCiAgICApIHsKICAgICAgd2FybigoIkNhbm5vdCBkZWxldGUgcmVhY3RpdmUgcHJvcGVydHkgb24gdW5kZWZpbmVkLCBudWxsLCBvciBwcmltaXRpdmUgdmFsdWU6ICIgKyAoKHRhcmdldCkpKSk7CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0YXJnZXQpICYmIGlzVmFsaWRBcnJheUluZGV4KGtleSkpIHsKICAgICAgdGFyZ2V0LnNwbGljZShrZXksIDEpOwogICAgICByZXR1cm4KICAgIH0KICAgIHZhciBvYiA9ICh0YXJnZXQpLl9fb2JfXzsKICAgIGlmICh0YXJnZXQuX2lzVnVlIHx8IChvYiAmJiBvYi52bUNvdW50KSkgewogICAgICB3YXJuKAogICAgICAgICdBdm9pZCBkZWxldGluZyBwcm9wZXJ0aWVzIG9uIGEgVnVlIGluc3RhbmNlIG9yIGl0cyByb290ICRkYXRhICcgKwogICAgICAgICctIGp1c3Qgc2V0IGl0IHRvIG51bGwuJwogICAgICApOwogICAgICByZXR1cm4KICAgIH0KICAgIGlmICghaGFzT3duKHRhcmdldCwga2V5KSkgewogICAgICByZXR1cm4KICAgIH0KICAgIGRlbGV0ZSB0YXJnZXRba2V5XTsKICAgIGlmICghb2IpIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICBvYi5kZXAubm90aWZ5KCk7CiAgfQoKICAvKioKICAgKiBDb2xsZWN0IGRlcGVuZGVuY2llcyBvbiBhcnJheSBlbGVtZW50cyB3aGVuIHRoZSBhcnJheSBpcyB0b3VjaGVkLCBzaW5jZQogICAqIHdlIGNhbm5vdCBpbnRlcmNlcHQgYXJyYXkgZWxlbWVudCBhY2Nlc3MgbGlrZSBwcm9wZXJ0eSBnZXR0ZXJzLgogICAqLwogIGZ1bmN0aW9uIGRlcGVuZEFycmF5ICh2YWx1ZSkgewogICAgZm9yICh2YXIgZSA9ICh2b2lkIDApLCBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBlID0gdmFsdWVbaV07CiAgICAgIGUgJiYgZS5fX29iX18gJiYgZS5fX29iX18uZGVwLmRlcGVuZCgpOwogICAgICBpZiAoQXJyYXkuaXNBcnJheShlKSkgewogICAgICAgIGRlcGVuZEFycmF5KGUpOwogICAgICB9CiAgICB9CiAgfQoKICAvKiAgKi8KCiAgLyoqCiAgICogT3B0aW9uIG92ZXJ3cml0aW5nIHN0cmF0ZWdpZXMgYXJlIGZ1bmN0aW9ucyB0aGF0IGhhbmRsZQogICAqIGhvdyB0byBtZXJnZSBhIHBhcmVudCBvcHRpb24gdmFsdWUgYW5kIGEgY2hpbGQgb3B0aW9uCiAgICogdmFsdWUgaW50byB0aGUgZmluYWwgdmFsdWUuCiAgICovCiAgdmFyIHN0cmF0cyA9IGNvbmZpZy5vcHRpb25NZXJnZVN0cmF0ZWdpZXM7CgogIC8qKgogICAqIE9wdGlvbnMgd2l0aCByZXN0cmljdGlvbnMKICAgKi8KICB7CiAgICBzdHJhdHMuZWwgPSBzdHJhdHMucHJvcHNEYXRhID0gZnVuY3Rpb24gKHBhcmVudCwgY2hpbGQsIHZtLCBrZXkpIHsKICAgICAgaWYgKCF2bSkgewogICAgICAgIHdhcm4oCiAgICAgICAgICAib3B0aW9uIFwiIiArIGtleSArICJcIiBjYW4gb25seSBiZSB1c2VkIGR1cmluZyBpbnN0YW5jZSAiICsKICAgICAgICAgICdjcmVhdGlvbiB3aXRoIHRoZSBgbmV3YCBrZXl3b3JkLicKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBkZWZhdWx0U3RyYXQocGFyZW50LCBjaGlsZCkKICAgIH07CiAgfQoKICAvKioKICAgKiBIZWxwZXIgdGhhdCByZWN1cnNpdmVseSBtZXJnZXMgdHdvIGRhdGEgb2JqZWN0cyB0b2dldGhlci4KICAgKi8KICBmdW5jdGlvbiBtZXJnZURhdGEgKHRvLCBmcm9tKSB7CiAgICBpZiAoIWZyb20pIHsgcmV0dXJuIHRvIH0KICAgIHZhciBrZXksIHRvVmFsLCBmcm9tVmFsOwogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhmcm9tKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBrZXkgPSBrZXlzW2ldOwogICAgICB0b1ZhbCA9IHRvW2tleV07CiAgICAgIGZyb21WYWwgPSBmcm9tW2tleV07CiAgICAgIGlmICghaGFzT3duKHRvLCBrZXkpKSB7CiAgICAgICAgc2V0KHRvLCBrZXksIGZyb21WYWwpOwogICAgICB9IGVsc2UgaWYgKAogICAgICAgIHRvVmFsICE9PSBmcm9tVmFsICYmCiAgICAgICAgaXNQbGFpbk9iamVjdCh0b1ZhbCkgJiYKICAgICAgICBpc1BsYWluT2JqZWN0KGZyb21WYWwpCiAgICAgICkgewogICAgICAgIG1lcmdlRGF0YSh0b1ZhbCwgZnJvbVZhbCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0bwogIH0KCiAgLyoqCiAgICogRGF0YQogICAqLwogIGZ1bmN0aW9uIG1lcmdlRGF0YU9yRm4gKAogICAgcGFyZW50VmFsLAogICAgY2hpbGRWYWwsCiAgICB2bQogICkgewogICAgaWYgKCF2bSkgewogICAgICAvLyBpbiBhIFZ1ZS5leHRlbmQgbWVyZ2UsIGJvdGggc2hvdWxkIGJlIGZ1bmN0aW9ucwogICAgICBpZiAoIWNoaWxkVmFsKSB7CiAgICAgICAgcmV0dXJuIHBhcmVudFZhbAogICAgICB9CiAgICAgIGlmICghcGFyZW50VmFsKSB7CiAgICAgICAgcmV0dXJuIGNoaWxkVmFsCiAgICAgIH0KICAgICAgLy8gd2hlbiBwYXJlbnRWYWwgJiBjaGlsZFZhbCBhcmUgYm90aCBwcmVzZW50LAogICAgICAvLyB3ZSBuZWVkIHRvIHJldHVybiBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUKICAgICAgLy8gbWVyZ2VkIHJlc3VsdCBvZiBib3RoIGZ1bmN0aW9ucy4uLiBubyBuZWVkIHRvCiAgICAgIC8vIGNoZWNrIGlmIHBhcmVudFZhbCBpcyBhIGZ1bmN0aW9uIGhlcmUgYmVjYXVzZQogICAgICAvLyBpdCBoYXMgdG8gYmUgYSBmdW5jdGlvbiB0byBwYXNzIHByZXZpb3VzIG1lcmdlcy4KICAgICAgcmV0dXJuIGZ1bmN0aW9uIG1lcmdlZERhdGFGbiAoKSB7CiAgICAgICAgcmV0dXJuIG1lcmdlRGF0YSgKICAgICAgICAgIHR5cGVvZiBjaGlsZFZhbCA9PT0gJ2Z1bmN0aW9uJyA/IGNoaWxkVmFsLmNhbGwodGhpcywgdGhpcykgOiBjaGlsZFZhbCwKICAgICAgICAgIHR5cGVvZiBwYXJlbnRWYWwgPT09ICdmdW5jdGlvbicgPyBwYXJlbnRWYWwuY2FsbCh0aGlzLCB0aGlzKSA6IHBhcmVudFZhbAogICAgICAgICkKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIG1lcmdlZEluc3RhbmNlRGF0YUZuICgpIHsKICAgICAgICAvLyBpbnN0YW5jZSBtZXJnZQogICAgICAgIHZhciBpbnN0YW5jZURhdGEgPSB0eXBlb2YgY2hpbGRWYWwgPT09ICdmdW5jdGlvbicKICAgICAgICAgID8gY2hpbGRWYWwuY2FsbCh2bSwgdm0pCiAgICAgICAgICA6IGNoaWxkVmFsOwogICAgICAgIHZhciBkZWZhdWx0RGF0YSA9IHR5cGVvZiBwYXJlbnRWYWwgPT09ICdmdW5jdGlvbicKICAgICAgICAgID8gcGFyZW50VmFsLmNhbGwodm0sIHZtKQogICAgICAgICAgOiBwYXJlbnRWYWw7CiAgICAgICAgaWYgKGluc3RhbmNlRGF0YSkgewogICAgICAgICAgcmV0dXJuIG1lcmdlRGF0YShpbnN0YW5jZURhdGEsIGRlZmF1bHREYXRhKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gZGVmYXVsdERhdGEKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIHN0cmF0cy5kYXRhID0gZnVuY3Rpb24gKAogICAgcGFyZW50VmFsLAogICAgY2hpbGRWYWwsCiAgICB2bQogICkgewogICAgaWYgKCF2bSkgewogICAgICBpZiAoY2hpbGRWYWwgJiYgdHlwZW9mIGNoaWxkVmFsICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgd2FybigKICAgICAgICAgICdUaGUgImRhdGEiIG9wdGlvbiBzaG91bGQgYmUgYSBmdW5jdGlvbiAnICsKICAgICAgICAgICd0aGF0IHJldHVybnMgYSBwZXItaW5zdGFuY2UgdmFsdWUgaW4gY29tcG9uZW50ICcgKwogICAgICAgICAgJ2RlZmluaXRpb25zLicsCiAgICAgICAgICB2bQogICAgICAgICk7CgogICAgICAgIHJldHVybiBwYXJlbnRWYWwKICAgICAgfQogICAgICByZXR1cm4gbWVyZ2VEYXRhT3JGbihwYXJlbnRWYWwsIGNoaWxkVmFsKQogICAgfQoKICAgIHJldHVybiBtZXJnZURhdGFPckZuKHBhcmVudFZhbCwgY2hpbGRWYWwsIHZtKQogIH07CgogIC8qKgogICAqIEhvb2tzIGFuZCBwcm9wcyBhcmUgbWVyZ2VkIGFzIGFycmF5cy4KICAgKi8KICBmdW5jdGlvbiBtZXJnZUhvb2sgKAogICAgcGFyZW50VmFsLAogICAgY2hpbGRWYWwKICApIHsKICAgIHJldHVybiBjaGlsZFZhbAogICAgICA/IHBhcmVudFZhbAogICAgICAgID8gcGFyZW50VmFsLmNvbmNhdChjaGlsZFZhbCkKICAgICAgICA6IEFycmF5LmlzQXJyYXkoY2hpbGRWYWwpCiAgICAgICAgICA/IGNoaWxkVmFsCiAgICAgICAgICA6IFtjaGlsZFZhbF0KICAgICAgOiBwYXJlbnRWYWwKICB9CgogIExJRkVDWUNMRV9IT09LUy5mb3JFYWNoKGZ1bmN0aW9uIChob29rKSB7CiAgICBzdHJhdHNbaG9va10gPSBtZXJnZUhvb2s7CiAgfSk7CgogIC8qKgogICAqIEFzc2V0cwogICAqCiAgICogV2hlbiBhIHZtIGlzIHByZXNlbnQgKGluc3RhbmNlIGNyZWF0aW9uKSwgd2UgbmVlZCB0byBkbwogICAqIGEgdGhyZWUtd2F5IG1lcmdlIGJldHdlZW4gY29uc3RydWN0b3Igb3B0aW9ucywgaW5zdGFuY2UKICAgKiBvcHRpb25zIGFuZCBwYXJlbnQgb3B0aW9ucy4KICAgKi8KICBmdW5jdGlvbiBtZXJnZUFzc2V0cyAoCiAgICBwYXJlbnRWYWwsCiAgICBjaGlsZFZhbCwKICAgIHZtLAogICAga2V5CiAgKSB7CiAgICB2YXIgcmVzID0gT2JqZWN0LmNyZWF0ZShwYXJlbnRWYWwgfHwgbnVsbCk7CiAgICBpZiAoY2hpbGRWYWwpIHsKICAgICAgYXNzZXJ0T2JqZWN0VHlwZShrZXksIGNoaWxkVmFsLCB2bSk7CiAgICAgIHJldHVybiBleHRlbmQocmVzLCBjaGlsZFZhbCkKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiByZXMKICAgIH0KICB9CgogIEFTU0VUX1RZUEVTLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHsKICAgIHN0cmF0c1t0eXBlICsgJ3MnXSA9IG1lcmdlQXNzZXRzOwogIH0pOwoKICAvKioKICAgKiBXYXRjaGVycy4KICAgKgogICAqIFdhdGNoZXJzIGhhc2hlcyBzaG91bGQgbm90IG92ZXJ3cml0ZSBvbmUKICAgKiBhbm90aGVyLCBzbyB3ZSBtZXJnZSB0aGVtIGFzIGFycmF5cy4KICAgKi8KICBzdHJhdHMud2F0Y2ggPSBmdW5jdGlvbiAoCiAgICBwYXJlbnRWYWwsCiAgICBjaGlsZFZhbCwKICAgIHZtLAogICAga2V5CiAgKSB7CiAgICAvLyB3b3JrIGFyb3VuZCBGaXJlZm94J3MgT2JqZWN0LnByb3RvdHlwZS53YXRjaC4uLgogICAgaWYgKHBhcmVudFZhbCA9PT0gbmF0aXZlV2F0Y2gpIHsgcGFyZW50VmFsID0gdW5kZWZpbmVkOyB9CiAgICBpZiAoY2hpbGRWYWwgPT09IG5hdGl2ZVdhdGNoKSB7IGNoaWxkVmFsID0gdW5kZWZpbmVkOyB9CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmICghY2hpbGRWYWwpIHsgcmV0dXJuIE9iamVjdC5jcmVhdGUocGFyZW50VmFsIHx8IG51bGwpIH0KICAgIHsKICAgICAgYXNzZXJ0T2JqZWN0VHlwZShrZXksIGNoaWxkVmFsLCB2bSk7CiAgICB9CiAgICBpZiAoIXBhcmVudFZhbCkgeyByZXR1cm4gY2hpbGRWYWwgfQogICAgdmFyIHJldCA9IHt9OwogICAgZXh0ZW5kKHJldCwgcGFyZW50VmFsKTsKICAgIGZvciAodmFyIGtleSQxIGluIGNoaWxkVmFsKSB7CiAgICAgIHZhciBwYXJlbnQgPSByZXRba2V5JDFdOwogICAgICB2YXIgY2hpbGQgPSBjaGlsZFZhbFtrZXkkMV07CiAgICAgIGlmIChwYXJlbnQgJiYgIUFycmF5LmlzQXJyYXkocGFyZW50KSkgewogICAgICAgIHBhcmVudCA9IFtwYXJlbnRdOwogICAgICB9CiAgICAgIHJldFtrZXkkMV0gPSBwYXJlbnQKICAgICAgICA/IHBhcmVudC5jb25jYXQoY2hpbGQpCiAgICAgICAgOiBBcnJheS5pc0FycmF5KGNoaWxkKSA/IGNoaWxkIDogW2NoaWxkXTsKICAgIH0KICAgIHJldHVybiByZXQKICB9OwoKICAvKioKICAgKiBPdGhlciBvYmplY3QgaGFzaGVzLgogICAqLwogIHN0cmF0cy5wcm9wcyA9CiAgc3RyYXRzLm1ldGhvZHMgPQogIHN0cmF0cy5pbmplY3QgPQogIHN0cmF0cy5jb21wdXRlZCA9IGZ1bmN0aW9uICgKICAgIHBhcmVudFZhbCwKICAgIGNoaWxkVmFsLAogICAgdm0sCiAgICBrZXkKICApIHsKICAgIGlmIChjaGlsZFZhbCAmJiAiZGV2ZWxvcG1lbnQiICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgYXNzZXJ0T2JqZWN0VHlwZShrZXksIGNoaWxkVmFsLCB2bSk7CiAgICB9CiAgICBpZiAoIXBhcmVudFZhbCkgeyByZXR1cm4gY2hpbGRWYWwgfQogICAgdmFyIHJldCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBleHRlbmQocmV0LCBwYXJlbnRWYWwpOwogICAgaWYgKGNoaWxkVmFsKSB7IGV4dGVuZChyZXQsIGNoaWxkVmFsKTsgfQogICAgcmV0dXJuIHJldAogIH07CiAgc3RyYXRzLnByb3ZpZGUgPSBtZXJnZURhdGFPckZuOwoKICAvKioKICAgKiBEZWZhdWx0IHN0cmF0ZWd5LgogICAqLwogIHZhciBkZWZhdWx0U3RyYXQgPSBmdW5jdGlvbiAocGFyZW50VmFsLCBjaGlsZFZhbCkgewogICAgcmV0dXJuIGNoaWxkVmFsID09PSB1bmRlZmluZWQKICAgICAgPyBwYXJlbnRWYWwKICAgICAgOiBjaGlsZFZhbAogIH07CgogIC8qKgogICAqIFZhbGlkYXRlIGNvbXBvbmVudCBuYW1lcwogICAqLwogIGZ1bmN0aW9uIGNoZWNrQ29tcG9uZW50cyAob3B0aW9ucykgewogICAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMuY29tcG9uZW50cykgewogICAgICB2YWxpZGF0ZUNvbXBvbmVudE5hbWUoa2V5KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHZhbGlkYXRlQ29tcG9uZW50TmFtZSAobmFtZSkgewogICAgaWYgKCEvXlthLXpBLVpdW1x3LV0qJC8udGVzdChuYW1lKSkgewogICAgICB3YXJuKAogICAgICAgICdJbnZhbGlkIGNvbXBvbmVudCBuYW1lOiAiJyArIG5hbWUgKyAnIi4gQ29tcG9uZW50IG5hbWVzICcgKwogICAgICAgICdjYW4gb25seSBjb250YWluIGFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzIGFuZCB0aGUgaHlwaGVuLCAnICsKICAgICAgICAnYW5kIG11c3Qgc3RhcnQgd2l0aCBhIGxldHRlci4nCiAgICAgICk7CiAgICB9CiAgICBpZiAoaXNCdWlsdEluVGFnKG5hbWUpIHx8IGNvbmZpZy5pc1Jlc2VydmVkVGFnKG5hbWUpKSB7CiAgICAgIHdhcm4oCiAgICAgICAgJ0RvIG5vdCB1c2UgYnVpbHQtaW4gb3IgcmVzZXJ2ZWQgSFRNTCBlbGVtZW50cyBhcyBjb21wb25lbnQgJyArCiAgICAgICAgJ2lkOiAnICsgbmFtZQogICAgICApOwogICAgfQogIH0KCiAgLyoqCiAgICogRW5zdXJlIGFsbCBwcm9wcyBvcHRpb24gc3ludGF4IGFyZSBub3JtYWxpemVkIGludG8gdGhlCiAgICogT2JqZWN0LWJhc2VkIGZvcm1hdC4KICAgKi8KICBmdW5jdGlvbiBub3JtYWxpemVQcm9wcyAob3B0aW9ucywgdm0pIHsKICAgIHZhciBwcm9wcyA9IG9wdGlvbnMucHJvcHM7CiAgICBpZiAoIXByb3BzKSB7IHJldHVybiB9CiAgICB2YXIgcmVzID0ge307CiAgICB2YXIgaSwgdmFsLCBuYW1lOwogICAgaWYgKEFycmF5LmlzQXJyYXkocHJvcHMpKSB7CiAgICAgIGkgPSBwcm9wcy5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICB2YWwgPSBwcm9wc1tpXTsKICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIG5hbWUgPSBjYW1lbGl6ZSh2YWwpOwogICAgICAgICAgcmVzW25hbWVdID0geyB0eXBlOiBudWxsIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdhcm4oJ3Byb3BzIG11c3QgYmUgc3RyaW5ncyB3aGVuIHVzaW5nIGFycmF5IHN5bnRheC4nKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNQbGFpbk9iamVjdChwcm9wcykpIHsKICAgICAgZm9yICh2YXIga2V5IGluIHByb3BzKSB7CiAgICAgICAgdmFsID0gcHJvcHNba2V5XTsKICAgICAgICBuYW1lID0gY2FtZWxpemUoa2V5KTsKICAgICAgICByZXNbbmFtZV0gPSBpc1BsYWluT2JqZWN0KHZhbCkKICAgICAgICAgID8gdmFsCiAgICAgICAgICA6IHsgdHlwZTogdmFsIH07CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHdhcm4oCiAgICAgICAgIkludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcInByb3BzXCI6IGV4cGVjdGVkIGFuIEFycmF5IG9yIGFuIE9iamVjdCwgIiArCiAgICAgICAgImJ1dCBnb3QgIiArICh0b1Jhd1R5cGUocHJvcHMpKSArICIuIiwKICAgICAgICB2bQogICAgICApOwogICAgfQogICAgb3B0aW9ucy5wcm9wcyA9IHJlczsKICB9CgogIC8qKgogICAqIE5vcm1hbGl6ZSBhbGwgaW5qZWN0aW9ucyBpbnRvIE9iamVjdC1iYXNlZCBmb3JtYXQKICAgKi8KICBmdW5jdGlvbiBub3JtYWxpemVJbmplY3QgKG9wdGlvbnMsIHZtKSB7CiAgICB2YXIgaW5qZWN0ID0gb3B0aW9ucy5pbmplY3Q7CiAgICBpZiAoIWluamVjdCkgeyByZXR1cm4gfQogICAgdmFyIG5vcm1hbGl6ZWQgPSBvcHRpb25zLmluamVjdCA9IHt9OwogICAgaWYgKEFycmF5LmlzQXJyYXkoaW5qZWN0KSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluamVjdC5sZW5ndGg7IGkrKykgewogICAgICAgIG5vcm1hbGl6ZWRbaW5qZWN0W2ldXSA9IHsgZnJvbTogaW5qZWN0W2ldIH07CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNQbGFpbk9iamVjdChpbmplY3QpKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBpbmplY3QpIHsKICAgICAgICB2YXIgdmFsID0gaW5qZWN0W2tleV07CiAgICAgICAgbm9ybWFsaXplZFtrZXldID0gaXNQbGFpbk9iamVjdCh2YWwpCiAgICAgICAgICA/IGV4dGVuZCh7IGZyb206IGtleSB9LCB2YWwpCiAgICAgICAgICA6IHsgZnJvbTogdmFsIH07CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHdhcm4oCiAgICAgICAgIkludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcImluamVjdFwiOiBleHBlY3RlZCBhbiBBcnJheSBvciBhbiBPYmplY3QsICIgKwogICAgICAgICJidXQgZ290ICIgKyAodG9SYXdUeXBlKGluamVjdCkpICsgIi4iLAogICAgICAgIHZtCiAgICAgICk7CiAgICB9CiAgfQoKICAvKioKICAgKiBOb3JtYWxpemUgcmF3IGZ1bmN0aW9uIGRpcmVjdGl2ZXMgaW50byBvYmplY3QgZm9ybWF0LgogICAqLwogIGZ1bmN0aW9uIG5vcm1hbGl6ZURpcmVjdGl2ZXMgKG9wdGlvbnMpIHsKICAgIHZhciBkaXJzID0gb3B0aW9ucy5kaXJlY3RpdmVzOwogICAgaWYgKGRpcnMpIHsKICAgICAgZm9yICh2YXIga2V5IGluIGRpcnMpIHsKICAgICAgICB2YXIgZGVmID0gZGlyc1trZXldOwogICAgICAgIGlmICh0eXBlb2YgZGVmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBkaXJzW2tleV0gPSB7IGJpbmQ6IGRlZiwgdXBkYXRlOiBkZWYgfTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGFzc2VydE9iamVjdFR5cGUgKG5hbWUsIHZhbHVlLCB2bSkgewogICAgaWYgKCFpc1BsYWluT2JqZWN0KHZhbHVlKSkgewogICAgICB3YXJuKAogICAgICAgICJJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCIiICsgbmFtZSArICJcIjogZXhwZWN0ZWQgYW4gT2JqZWN0LCAiICsKICAgICAgICAiYnV0IGdvdCAiICsgKHRvUmF3VHlwZSh2YWx1ZSkpICsgIi4iLAogICAgICAgIHZtCiAgICAgICk7CiAgICB9CiAgfQoKICAvKioKICAgKiBNZXJnZSB0d28gb3B0aW9uIG9iamVjdHMgaW50byBhIG5ldyBvbmUuCiAgICogQ29yZSB1dGlsaXR5IHVzZWQgaW4gYm90aCBpbnN0YW50aWF0aW9uIGFuZCBpbmhlcml0YW5jZS4KICAgKi8KICBmdW5jdGlvbiBtZXJnZU9wdGlvbnMgKAogICAgcGFyZW50LAogICAgY2hpbGQsCiAgICB2bQogICkgewogICAgewogICAgICBjaGVja0NvbXBvbmVudHMoY2hpbGQpOwogICAgfQoKICAgIGlmICh0eXBlb2YgY2hpbGQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2hpbGQgPSBjaGlsZC5vcHRpb25zOwogICAgfQoKICAgIG5vcm1hbGl6ZVByb3BzKGNoaWxkLCB2bSk7CiAgICBub3JtYWxpemVJbmplY3QoY2hpbGQsIHZtKTsKICAgIG5vcm1hbGl6ZURpcmVjdGl2ZXMoY2hpbGQpOwogICAgCiAgICAvLyBBcHBseSBleHRlbmRzIGFuZCBtaXhpbnMgb24gdGhlIGNoaWxkIG9wdGlvbnMsCiAgICAvLyBidXQgb25seSBpZiBpdCBpcyBhIHJhdyBvcHRpb25zIG9iamVjdCB0aGF0IGlzbid0CiAgICAvLyB0aGUgcmVzdWx0IG9mIGFub3RoZXIgbWVyZ2VPcHRpb25zIGNhbGwuCiAgICAvLyBPbmx5IG1lcmdlZCBvcHRpb25zIGhhcyB0aGUgX2Jhc2UgcHJvcGVydHkuCiAgICBpZiAoIWNoaWxkLl9iYXNlKSB7CiAgICAgIGlmIChjaGlsZC5leHRlbmRzKSB7CiAgICAgICAgcGFyZW50ID0gbWVyZ2VPcHRpb25zKHBhcmVudCwgY2hpbGQuZXh0ZW5kcywgdm0pOwogICAgICB9CiAgICAgIGlmIChjaGlsZC5taXhpbnMpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNoaWxkLm1peGlucy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHBhcmVudCA9IG1lcmdlT3B0aW9ucyhwYXJlbnQsIGNoaWxkLm1peGluc1tpXSwgdm0pOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHZhciBvcHRpb25zID0ge307CiAgICB2YXIga2V5OwogICAgZm9yIChrZXkgaW4gcGFyZW50KSB7CiAgICAgIG1lcmdlRmllbGQoa2V5KTsKICAgIH0KICAgIGZvciAoa2V5IGluIGNoaWxkKSB7CiAgICAgIGlmICghaGFzT3duKHBhcmVudCwga2V5KSkgewogICAgICAgIG1lcmdlRmllbGQoa2V5KTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gbWVyZ2VGaWVsZCAoa2V5KSB7CiAgICAgIHZhciBzdHJhdCA9IHN0cmF0c1trZXldIHx8IGRlZmF1bHRTdHJhdDsKICAgICAgb3B0aW9uc1trZXldID0gc3RyYXQocGFyZW50W2tleV0sIGNoaWxkW2tleV0sIHZtLCBrZXkpOwogICAgfQogICAgcmV0dXJuIG9wdGlvbnMKICB9CgogIC8qKgogICAqIFJlc29sdmUgYW4gYXNzZXQuCiAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGJlY2F1c2UgY2hpbGQgaW5zdGFuY2VzIG5lZWQgYWNjZXNzCiAgICogdG8gYXNzZXRzIGRlZmluZWQgaW4gaXRzIGFuY2VzdG9yIGNoYWluLgogICAqLwogIGZ1bmN0aW9uIHJlc29sdmVBc3NldCAoCiAgICBvcHRpb25zLAogICAgdHlwZSwKICAgIGlkLAogICAgd2Fybk1pc3NpbmcKICApIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKHR5cGVvZiBpZCAhPT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICB2YXIgYXNzZXRzID0gb3B0aW9uc1t0eXBlXTsKICAgIC8vIGNoZWNrIGxvY2FsIHJlZ2lzdHJhdGlvbiB2YXJpYXRpb25zIGZpcnN0CiAgICBpZiAoaGFzT3duKGFzc2V0cywgaWQpKSB7IHJldHVybiBhc3NldHNbaWRdIH0KICAgIHZhciBjYW1lbGl6ZWRJZCA9IGNhbWVsaXplKGlkKTsKICAgIGlmIChoYXNPd24oYXNzZXRzLCBjYW1lbGl6ZWRJZCkpIHsgcmV0dXJuIGFzc2V0c1tjYW1lbGl6ZWRJZF0gfQogICAgdmFyIFBhc2NhbENhc2VJZCA9IGNhcGl0YWxpemUoY2FtZWxpemVkSWQpOwogICAgaWYgKGhhc093bihhc3NldHMsIFBhc2NhbENhc2VJZCkpIHsgcmV0dXJuIGFzc2V0c1tQYXNjYWxDYXNlSWRdIH0KICAgIC8vIGZhbGxiYWNrIHRvIHByb3RvdHlwZSBjaGFpbgogICAgdmFyIHJlcyA9IGFzc2V0c1tpZF0gfHwgYXNzZXRzW2NhbWVsaXplZElkXSB8fCBhc3NldHNbUGFzY2FsQ2FzZUlkXTsKICAgIGlmICh3YXJuTWlzc2luZyAmJiAhcmVzKSB7CiAgICAgIHdhcm4oCiAgICAgICAgJ0ZhaWxlZCB0byByZXNvbHZlICcgKyB0eXBlLnNsaWNlKDAsIC0xKSArICc6ICcgKyBpZCwKICAgICAgICBvcHRpb25zCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gcmVzCiAgfQoKICAvKiAgKi8KCgoKICBmdW5jdGlvbiB2YWxpZGF0ZVByb3AgKAogICAga2V5LAogICAgcHJvcE9wdGlvbnMsCiAgICBwcm9wc0RhdGEsCiAgICB2bQogICkgewogICAgdmFyIHByb3AgPSBwcm9wT3B0aW9uc1trZXldOwogICAgdmFyIGFic2VudCA9ICFoYXNPd24ocHJvcHNEYXRhLCBrZXkpOwogICAgdmFyIHZhbHVlID0gcHJvcHNEYXRhW2tleV07CiAgICAvLyBib29sZWFuIGNhc3RpbmcKICAgIHZhciBib29sZWFuSW5kZXggPSBnZXRUeXBlSW5kZXgoQm9vbGVhbiwgcHJvcC50eXBlKTsKICAgIGlmIChib29sZWFuSW5kZXggPiAtMSkgewogICAgICBpZiAoYWJzZW50ICYmICFoYXNPd24ocHJvcCwgJ2RlZmF1bHQnKSkgewogICAgICAgIHZhbHVlID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09ICcnIHx8IHZhbHVlID09PSBoeXBoZW5hdGUoa2V5KSkgewogICAgICAgIC8vIG9ubHkgY2FzdCBlbXB0eSBzdHJpbmcgLyBzYW1lIG5hbWUgdG8gYm9vbGVhbiBpZgogICAgICAgIC8vIGJvb2xlYW4gaGFzIGhpZ2hlciBwcmlvcml0eQogICAgICAgIHZhciBzdHJpbmdJbmRleCA9IGdldFR5cGVJbmRleChTdHJpbmcsIHByb3AudHlwZSk7CiAgICAgICAgaWYgKHN0cmluZ0luZGV4IDwgMCB8fCBib29sZWFuSW5kZXggPCBzdHJpbmdJbmRleCkgewogICAgICAgICAgdmFsdWUgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLy8gY2hlY2sgZGVmYXVsdCB2YWx1ZQogICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgdmFsdWUgPSBnZXRQcm9wRGVmYXVsdFZhbHVlKHZtLCBwcm9wLCBrZXkpOwogICAgICAvLyBzaW5jZSB0aGUgZGVmYXVsdCB2YWx1ZSBpcyBhIGZyZXNoIGNvcHksCiAgICAgIC8vIG1ha2Ugc3VyZSB0byBvYnNlcnZlIGl0LgogICAgICB2YXIgcHJldlNob3VsZE9ic2VydmUgPSBzaG91bGRPYnNlcnZlOwogICAgICB0b2dnbGVPYnNlcnZpbmcodHJ1ZSk7CiAgICAgIG9ic2VydmUodmFsdWUpOwogICAgICB0b2dnbGVPYnNlcnZpbmcocHJldlNob3VsZE9ic2VydmUpOwogICAgfQogICAgewogICAgICBhc3NlcnRQcm9wKHByb3AsIGtleSwgdmFsdWUsIHZtLCBhYnNlbnQpOwogICAgfQogICAgcmV0dXJuIHZhbHVlCiAgfQoKICAvKioKICAgKiBHZXQgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYSBwcm9wLgogICAqLwogIGZ1bmN0aW9uIGdldFByb3BEZWZhdWx0VmFsdWUgKHZtLCBwcm9wLCBrZXkpIHsKICAgIC8vIG5vIGRlZmF1bHQsIHJldHVybiB1bmRlZmluZWQKICAgIGlmICghaGFzT3duKHByb3AsICdkZWZhdWx0JykpIHsKICAgICAgcmV0dXJuIHVuZGVmaW5lZAogICAgfQogICAgdmFyIGRlZiA9IHByb3AuZGVmYXVsdDsKICAgIC8vIHdhcm4gYWdhaW5zdCBub24tZmFjdG9yeSBkZWZhdWx0cyBmb3IgT2JqZWN0ICYgQXJyYXkKICAgIGlmIChpc09iamVjdChkZWYpKSB7CiAgICAgIHdhcm4oCiAgICAgICAgJ0ludmFsaWQgZGVmYXVsdCB2YWx1ZSBmb3IgcHJvcCAiJyArIGtleSArICciOiAnICsKICAgICAgICAnUHJvcHMgd2l0aCB0eXBlIE9iamVjdC9BcnJheSBtdXN0IHVzZSBhIGZhY3RvcnkgZnVuY3Rpb24gJyArCiAgICAgICAgJ3RvIHJldHVybiB0aGUgZGVmYXVsdCB2YWx1ZS4nLAogICAgICAgIHZtCiAgICAgICk7CiAgICB9CiAgICAvLyB0aGUgcmF3IHByb3AgdmFsdWUgd2FzIGFsc28gdW5kZWZpbmVkIGZyb20gcHJldmlvdXMgcmVuZGVyLAogICAgLy8gcmV0dXJuIHByZXZpb3VzIGRlZmF1bHQgdmFsdWUgdG8gYXZvaWQgdW5uZWNlc3Nhcnkgd2F0Y2hlciB0cmlnZ2VyCiAgICBpZiAodm0gJiYgdm0uJG9wdGlvbnMucHJvcHNEYXRhICYmCiAgICAgIHZtLiRvcHRpb25zLnByb3BzRGF0YVtrZXldID09PSB1bmRlZmluZWQgJiYKICAgICAgdm0uX3Byb3BzW2tleV0gIT09IHVuZGVmaW5lZAogICAgKSB7CiAgICAgIHJldHVybiB2bS5fcHJvcHNba2V5XQogICAgfQogICAgLy8gY2FsbCBmYWN0b3J5IGZ1bmN0aW9uIGZvciBub24tRnVuY3Rpb24gdHlwZXMKICAgIC8vIGEgdmFsdWUgaXMgRnVuY3Rpb24gaWYgaXRzIHByb3RvdHlwZSBpcyBmdW5jdGlvbiBldmVuIGFjcm9zcyBkaWZmZXJlbnQgZXhlY3V0aW9uIGNvbnRleHQKICAgIHJldHVybiB0eXBlb2YgZGVmID09PSAnZnVuY3Rpb24nICYmIGdldFR5cGUocHJvcC50eXBlKSAhPT0gJ0Z1bmN0aW9uJwogICAgICA/IGRlZi5jYWxsKHZtKQogICAgICA6IGRlZgogIH0KCiAgLyoqCiAgICogQXNzZXJ0IHdoZXRoZXIgYSBwcm9wIGlzIHZhbGlkLgogICAqLwogIGZ1bmN0aW9uIGFzc2VydFByb3AgKAogICAgcHJvcCwKICAgIG5hbWUsCiAgICB2YWx1ZSwKICAgIHZtLAogICAgYWJzZW50CiAgKSB7CiAgICBpZiAocHJvcC5yZXF1aXJlZCAmJiBhYnNlbnQpIHsKICAgICAgd2FybigKICAgICAgICAnTWlzc2luZyByZXF1aXJlZCBwcm9wOiAiJyArIG5hbWUgKyAnIicsCiAgICAgICAgdm0KICAgICAgKTsKICAgICAgcmV0dXJuCiAgICB9CiAgICBpZiAodmFsdWUgPT0gbnVsbCAmJiAhcHJvcC5yZXF1aXJlZCkgewogICAgICByZXR1cm4KICAgIH0KICAgIHZhciB0eXBlID0gcHJvcC50eXBlOwogICAgdmFyIHZhbGlkID0gIXR5cGUgfHwgdHlwZSA9PT0gdHJ1ZTsKICAgIHZhciBleHBlY3RlZFR5cGVzID0gW107CiAgICBpZiAodHlwZSkgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkodHlwZSkpIHsKICAgICAgICB0eXBlID0gW3R5cGVdOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHlwZS5sZW5ndGggJiYgIXZhbGlkOyBpKyspIHsKICAgICAgICB2YXIgYXNzZXJ0ZWRUeXBlID0gYXNzZXJ0VHlwZSh2YWx1ZSwgdHlwZVtpXSk7CiAgICAgICAgZXhwZWN0ZWRUeXBlcy5wdXNoKGFzc2VydGVkVHlwZS5leHBlY3RlZFR5cGUgfHwgJycpOwogICAgICAgIHZhbGlkID0gYXNzZXJ0ZWRUeXBlLnZhbGlkOwogICAgICB9CiAgICB9CgogICAgaWYgKCF2YWxpZCkgewogICAgICB3YXJuKAogICAgICAgIGdldEludmFsaWRUeXBlTWVzc2FnZShuYW1lLCB2YWx1ZSwgZXhwZWN0ZWRUeXBlcyksCiAgICAgICAgdm0KICAgICAgKTsKICAgICAgcmV0dXJuCiAgICB9CiAgICB2YXIgdmFsaWRhdG9yID0gcHJvcC52YWxpZGF0b3I7CiAgICBpZiAodmFsaWRhdG9yKSB7CiAgICAgIGlmICghdmFsaWRhdG9yKHZhbHVlKSkgewogICAgICAgIHdhcm4oCiAgICAgICAgICAnSW52YWxpZCBwcm9wOiBjdXN0b20gdmFsaWRhdG9yIGNoZWNrIGZhaWxlZCBmb3IgcHJvcCAiJyArIG5hbWUgKyAnIi4nLAogICAgICAgICAgdm0KICAgICAgICApOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgc2ltcGxlQ2hlY2tSRSA9IC9eKFN0cmluZ3xOdW1iZXJ8Qm9vbGVhbnxGdW5jdGlvbnxTeW1ib2wpJC87CgogIGZ1bmN0aW9uIGFzc2VydFR5cGUgKHZhbHVlLCB0eXBlKSB7CiAgICB2YXIgdmFsaWQ7CiAgICB2YXIgZXhwZWN0ZWRUeXBlID0gZ2V0VHlwZSh0eXBlKTsKICAgIGlmIChzaW1wbGVDaGVja1JFLnRlc3QoZXhwZWN0ZWRUeXBlKSkgewogICAgICB2YXIgdCA9IHR5cGVvZiB2YWx1ZTsKICAgICAgdmFsaWQgPSB0ID09PSBleHBlY3RlZFR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgLy8gZm9yIHByaW1pdGl2ZSB3cmFwcGVyIG9iamVjdHMKICAgICAgaWYgKCF2YWxpZCAmJiB0ID09PSAnb2JqZWN0JykgewogICAgICAgIHZhbGlkID0gdmFsdWUgaW5zdGFuY2VvZiB0eXBlOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGV4cGVjdGVkVHlwZSA9PT0gJ09iamVjdCcpIHsKICAgICAgdmFsaWQgPSBpc1BsYWluT2JqZWN0KHZhbHVlKTsKICAgIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSAnQXJyYXknKSB7CiAgICAgIHZhbGlkID0gQXJyYXkuaXNBcnJheSh2YWx1ZSk7CiAgICB9IGVsc2UgewogICAgICB2YWxpZCA9IHZhbHVlIGluc3RhbmNlb2YgdHlwZTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHZhbGlkOiB2YWxpZCwKICAgICAgZXhwZWN0ZWRUeXBlOiBleHBlY3RlZFR5cGUKICAgIH0KICB9CgogIC8qKgogICAqIFVzZSBmdW5jdGlvbiBzdHJpbmcgbmFtZSB0byBjaGVjayBidWlsdC1pbiB0eXBlcywKICAgKiBiZWNhdXNlIGEgc2ltcGxlIGVxdWFsaXR5IGNoZWNrIHdpbGwgZmFpbCB3aGVuIHJ1bm5pbmcKICAgKiBhY3Jvc3MgZGlmZmVyZW50IHZtcyAvIGlmcmFtZXMuCiAgICovCiAgZnVuY3Rpb24gZ2V0VHlwZSAoZm4pIHsKICAgIHZhciBtYXRjaCA9IGZuICYmIGZuLnRvU3RyaW5nKCkubWF0Y2goL15ccypmdW5jdGlvbiAoXHcrKS8pOwogICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJwogIH0KCiAgZnVuY3Rpb24gaXNTYW1lVHlwZSAoYSwgYikgewogICAgcmV0dXJuIGdldFR5cGUoYSkgPT09IGdldFR5cGUoYikKICB9CgogIGZ1bmN0aW9uIGdldFR5cGVJbmRleCAodHlwZSwgZXhwZWN0ZWRUeXBlcykgewogICAgaWYgKCFBcnJheS5pc0FycmF5KGV4cGVjdGVkVHlwZXMpKSB7CiAgICAgIHJldHVybiBpc1NhbWVUeXBlKGV4cGVjdGVkVHlwZXMsIHR5cGUpID8gMCA6IC0xCiAgICB9CiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gZXhwZWN0ZWRUeXBlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICBpZiAoaXNTYW1lVHlwZShleHBlY3RlZFR5cGVzW2ldLCB0eXBlKSkgewogICAgICAgIHJldHVybiBpCiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMQogIH0KCiAgZnVuY3Rpb24gZ2V0SW52YWxpZFR5cGVNZXNzYWdlIChuYW1lLCB2YWx1ZSwgZXhwZWN0ZWRUeXBlcykgewogICAgdmFyIG1lc3NhZ2UgPSAiSW52YWxpZCBwcm9wOiB0eXBlIGNoZWNrIGZhaWxlZCBmb3IgcHJvcCBcIiIgKyBuYW1lICsgIlwiLiIgKwogICAgICAiIEV4cGVjdGVkICIgKyAoZXhwZWN0ZWRUeXBlcy5tYXAoY2FwaXRhbGl6ZSkuam9pbignLCAnKSk7CiAgICB2YXIgZXhwZWN0ZWRUeXBlID0gZXhwZWN0ZWRUeXBlc1swXTsKICAgIHZhciByZWNlaXZlZFR5cGUgPSB0b1Jhd1R5cGUodmFsdWUpOwogICAgdmFyIGV4cGVjdGVkVmFsdWUgPSBzdHlsZVZhbHVlKHZhbHVlLCBleHBlY3RlZFR5cGUpOwogICAgdmFyIHJlY2VpdmVkVmFsdWUgPSBzdHlsZVZhbHVlKHZhbHVlLCByZWNlaXZlZFR5cGUpOwogICAgLy8gY2hlY2sgaWYgd2UgbmVlZCB0byBzcGVjaWZ5IGV4cGVjdGVkIHZhbHVlCiAgICBpZiAoZXhwZWN0ZWRUeXBlcy5sZW5ndGggPT09IDEgJiYKICAgICAgICBpc0V4cGxpY2FibGUoZXhwZWN0ZWRUeXBlKSAmJgogICAgICAgICFpc0Jvb2xlYW4oZXhwZWN0ZWRUeXBlLCByZWNlaXZlZFR5cGUpKSB7CiAgICAgIG1lc3NhZ2UgKz0gIiB3aXRoIHZhbHVlICIgKyBleHBlY3RlZFZhbHVlOwogICAgfQogICAgbWVzc2FnZSArPSAiLCBnb3QgIiArIHJlY2VpdmVkVHlwZSArICIgIjsKICAgIC8vIGNoZWNrIGlmIHdlIG5lZWQgdG8gc3BlY2lmeSByZWNlaXZlZCB2YWx1ZQogICAgaWYgKGlzRXhwbGljYWJsZShyZWNlaXZlZFR5cGUpKSB7CiAgICAgIG1lc3NhZ2UgKz0gIndpdGggdmFsdWUgIiArIHJlY2VpdmVkVmFsdWUgKyAiLiI7CiAgICB9CiAgICByZXR1cm4gbWVzc2FnZQogIH0KCiAgZnVuY3Rpb24gc3R5bGVWYWx1ZSAodmFsdWUsIHR5cGUpIHsKICAgIGlmICh0eXBlID09PSAnU3RyaW5nJykgewogICAgICByZXR1cm4gKCJcIiIgKyB2YWx1ZSArICJcIiIpCiAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdOdW1iZXInKSB7CiAgICAgIHJldHVybiAoIiIgKyAoTnVtYmVyKHZhbHVlKSkpCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gKCIiICsgdmFsdWUpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc0V4cGxpY2FibGUgKHZhbHVlKSB7CiAgICB2YXIgZXhwbGljaXRUeXBlcyA9IFsnc3RyaW5nJywgJ251bWJlcicsICdib29sZWFuJ107CiAgICByZXR1cm4gZXhwbGljaXRUeXBlcy5zb21lKGZ1bmN0aW9uIChlbGVtKSB7IHJldHVybiB2YWx1ZS50b0xvd2VyQ2FzZSgpID09PSBlbGVtOyB9KQogIH0KCiAgZnVuY3Rpb24gaXNCb29sZWFuICgpIHsKICAgIHZhciBhcmdzID0gW10sIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICB3aGlsZSAoIGxlbi0tICkgYXJnc1sgbGVuIF0gPSBhcmd1bWVudHNbIGxlbiBdOwoKICAgIHJldHVybiBhcmdzLnNvbWUoZnVuY3Rpb24gKGVsZW0pIHsgcmV0dXJuIGVsZW0udG9Mb3dlckNhc2UoKSA9PT0gJ2Jvb2xlYW4nOyB9KQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGhhbmRsZUVycm9yIChlcnIsIHZtLCBpbmZvKSB7CiAgICBpZiAodm0pIHsKICAgICAgdmFyIGN1ciA9IHZtOwogICAgICB3aGlsZSAoKGN1ciA9IGN1ci4kcGFyZW50KSkgewogICAgICAgIHZhciBob29rcyA9IGN1ci4kb3B0aW9ucy5lcnJvckNhcHR1cmVkOwogICAgICAgIGlmIChob29rcykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob29rcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBjYXB0dXJlID0gaG9va3NbaV0uY2FsbChjdXIsIGVyciwgdm0sIGluZm8pID09PSBmYWxzZTsKICAgICAgICAgICAgICBpZiAoY2FwdHVyZSkgeyByZXR1cm4gfQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgZ2xvYmFsSGFuZGxlRXJyb3IoZSwgY3VyLCAnZXJyb3JDYXB0dXJlZCBob29rJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGdsb2JhbEhhbmRsZUVycm9yKGVyciwgdm0sIGluZm8pOwogIH0KCiAgZnVuY3Rpb24gZ2xvYmFsSGFuZGxlRXJyb3IgKGVyciwgdm0sIGluZm8pIHsKICAgIGlmIChjb25maWcuZXJyb3JIYW5kbGVyKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGNvbmZpZy5lcnJvckhhbmRsZXIuY2FsbChudWxsLCBlcnIsIHZtLCBpbmZvKQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgbG9nRXJyb3IoZSwgbnVsbCwgJ2NvbmZpZy5lcnJvckhhbmRsZXInKTsKICAgICAgfQogICAgfQogICAgbG9nRXJyb3IoZXJyLCB2bSwgaW5mbyk7CiAgfQoKICBmdW5jdGlvbiBsb2dFcnJvciAoZXJyLCB2bSwgaW5mbykgewogICAgewogICAgICB3YXJuKCgiRXJyb3IgaW4gIiArIGluZm8gKyAiOiBcIiIgKyAoZXJyLnRvU3RyaW5nKCkpICsgIlwiIiksIHZtKTsKICAgIH0KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICBpZiAoKGluQnJvd3NlciB8fCBpbldlZXgpICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJykgewogICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBlcnIKICAgIH0KICB9CgogIC8qICAqLwoKICB2YXIgY2FsbGJhY2tzID0gW107CiAgdmFyIHBlbmRpbmcgPSBmYWxzZTsKCiAgZnVuY3Rpb24gZmx1c2hDYWxsYmFja3MgKCkgewogICAgcGVuZGluZyA9IGZhbHNlOwogICAgdmFyIGNvcGllcyA9IGNhbGxiYWNrcy5zbGljZSgwKTsKICAgIGNhbGxiYWNrcy5sZW5ndGggPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb3BpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29waWVzW2ldKCk7CiAgICB9CiAgfQoKICAvLyBIZXJlIHdlIGhhdmUgYXN5bmMgZGVmZXJyaW5nIHdyYXBwZXJzIHVzaW5nIGJvdGggbWljcm90YXNrcyBhbmQgKG1hY3JvKSB0YXNrcy4KICAvLyBJbiA8IDIuNCB3ZSB1c2VkIG1pY3JvdGFza3MgZXZlcnl3aGVyZSwgYnV0IHRoZXJlIGFyZSBzb21lIHNjZW5hcmlvcyB3aGVyZQogIC8vIG1pY3JvdGFza3MgaGF2ZSB0b28gaGlnaCBhIHByaW9yaXR5IGFuZCBmaXJlIGluIGJldHdlZW4gc3VwcG9zZWRseQogIC8vIHNlcXVlbnRpYWwgZXZlbnRzIChlLmcuICM0NTIxLCAjNjY5MCkgb3IgZXZlbiBiZXR3ZWVuIGJ1YmJsaW5nIG9mIHRoZSBzYW1lCiAgLy8gZXZlbnQgKCM2NTY2KS4gSG93ZXZlciwgdXNpbmcgKG1hY3JvKSB0YXNrcyBldmVyeXdoZXJlIGFsc28gaGFzIHN1YnRsZSBwcm9ibGVtcwogIC8vIHdoZW4gc3RhdGUgaXMgY2hhbmdlZCByaWdodCBiZWZvcmUgcmVwYWludCAoZS5nLiAjNjgxMywgb3V0LWluIHRyYW5zaXRpb25zKS4KICAvLyBIZXJlIHdlIHVzZSBtaWNyb3Rhc2sgYnkgZGVmYXVsdCwgYnV0IGV4cG9zZSBhIHdheSB0byBmb3JjZSAobWFjcm8pIHRhc2sgd2hlbgogIC8vIG5lZWRlZCAoZS5nLiBpbiBldmVudCBoYW5kbGVycyBhdHRhY2hlZCBieSB2LW9uKS4KICB2YXIgbWljcm9UaW1lckZ1bmM7CiAgdmFyIG1hY3JvVGltZXJGdW5jOwogIHZhciB1c2VNYWNyb1Rhc2sgPSBmYWxzZTsKCiAgLy8gRGV0ZXJtaW5lIChtYWNybykgdGFzayBkZWZlciBpbXBsZW1lbnRhdGlvbi4KICAvLyBUZWNobmljYWxseSBzZXRJbW1lZGlhdGUgc2hvdWxkIGJlIHRoZSBpZGVhbCBjaG9pY2UsIGJ1dCBpdCdzIG9ubHkgYXZhaWxhYmxlCiAgLy8gaW4gSUUuIFRoZSBvbmx5IHBvbHlmaWxsIHRoYXQgY29uc2lzdGVudGx5IHF1ZXVlcyB0aGUgY2FsbGJhY2sgYWZ0ZXIgYWxsIERPTQogIC8vIGV2ZW50cyB0cmlnZ2VyZWQgaW4gdGhlIHNhbWUgbG9vcCBpcyBieSB1c2luZyBNZXNzYWdlQ2hhbm5lbC4KICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAodHlwZW9mIHNldEltbWVkaWF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoc2V0SW1tZWRpYXRlKSkgewogICAgbWFjcm9UaW1lckZ1bmMgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHNldEltbWVkaWF0ZShmbHVzaENhbGxiYWNrcyk7CiAgICB9OwogIH0gZWxzZSBpZiAodHlwZW9mIE1lc3NhZ2VDaGFubmVsICE9PSAndW5kZWZpbmVkJyAmJiAoCiAgICBpc05hdGl2ZShNZXNzYWdlQ2hhbm5lbCkgfHwKICAgIC8vIFBoYW50b21KUwogICAgTWVzc2FnZUNoYW5uZWwudG9TdHJpbmcoKSA9PT0gJ1tvYmplY3QgTWVzc2FnZUNoYW5uZWxDb25zdHJ1Y3Rvcl0nCiAgKSkgewogICAgdmFyIGNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTsKICAgIHZhciBwb3J0ID0gY2hhbm5lbC5wb3J0MjsKICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gZmx1c2hDYWxsYmFja3M7CiAgICBtYWNyb1RpbWVyRnVuYyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcG9ydC5wb3N0TWVzc2FnZSgxKTsKICAgIH07CiAgfSBlbHNlIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICBtYWNyb1RpbWVyRnVuYyA9IGZ1bmN0aW9uICgpIHsKICAgICAgc2V0VGltZW91dChmbHVzaENhbGxiYWNrcywgMCk7CiAgICB9OwogIH0KCiAgLy8gRGV0ZXJtaW5lIG1pY3JvdGFzayBkZWZlciBpbXBsZW1lbnRhdGlvbi4KICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCwgJGZsb3ctZGlzYWJsZS1saW5lICovCiAgaWYgKHR5cGVvZiBQcm9taXNlICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShQcm9taXNlKSkgewogICAgdmFyIHAgPSBQcm9taXNlLnJlc29sdmUoKTsKICAgIG1pY3JvVGltZXJGdW5jID0gZnVuY3Rpb24gKCkgewogICAgICBwLnRoZW4oZmx1c2hDYWxsYmFja3MpOwogICAgICAvLyBpbiBwcm9ibGVtYXRpYyBVSVdlYlZpZXdzLCBQcm9taXNlLnRoZW4gZG9lc24ndCBjb21wbGV0ZWx5IGJyZWFrLCBidXQKICAgICAgLy8gaXQgY2FuIGdldCBzdHVjayBpbiBhIHdlaXJkIHN0YXRlIHdoZXJlIGNhbGxiYWNrcyBhcmUgcHVzaGVkIGludG8gdGhlCiAgICAgIC8vIG1pY3JvdGFzayBxdWV1ZSBidXQgdGhlIHF1ZXVlIGlzbid0IGJlaW5nIGZsdXNoZWQsIHVudGlsIHRoZSBicm93c2VyCiAgICAgIC8vIG5lZWRzIHRvIGRvIHNvbWUgb3RoZXIgd29yaywgZS5nLiBoYW5kbGUgYSB0aW1lci4gVGhlcmVmb3JlIHdlIGNhbgogICAgICAvLyAiZm9yY2UiIHRoZSBtaWNyb3Rhc2sgcXVldWUgdG8gYmUgZmx1c2hlZCBieSBhZGRpbmcgYW4gZW1wdHkgdGltZXIuCiAgICAgIGlmIChpc0lPUykgeyBzZXRUaW1lb3V0KG5vb3ApOyB9CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBmYWxsYmFjayB0byBtYWNybwogICAgbWljcm9UaW1lckZ1bmMgPSBtYWNyb1RpbWVyRnVuYzsKICB9CgogIC8qKgogICAqIFdyYXAgYSBmdW5jdGlvbiBzbyB0aGF0IGlmIGFueSBjb2RlIGluc2lkZSB0cmlnZ2VycyBzdGF0ZSBjaGFuZ2UsCiAgICogdGhlIGNoYW5nZXMgYXJlIHF1ZXVlZCB1c2luZyBhIChtYWNybykgdGFzayBpbnN0ZWFkIG9mIGEgbWljcm90YXNrLgogICAqLwogIGZ1bmN0aW9uIHdpdGhNYWNyb1Rhc2sgKGZuKSB7CiAgICByZXR1cm4gZm4uX3dpdGhUYXNrIHx8IChmbi5fd2l0aFRhc2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHVzZU1hY3JvVGFzayA9IHRydWU7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KG51bGwsIGFyZ3VtZW50cykKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB1c2VNYWNyb1Rhc2sgPSBmYWxzZTsgICAgCiAgICAgIH0KICAgIH0pCiAgfQoKICBmdW5jdGlvbiBuZXh0VGljayAoY2IsIGN0eCkgewogICAgdmFyIF9yZXNvbHZlOwogICAgY2FsbGJhY2tzLnB1c2goZnVuY3Rpb24gKCkgewogICAgICBpZiAoY2IpIHsKICAgICAgICB0cnkgewogICAgICAgICAgY2IuY2FsbChjdHgpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGhhbmRsZUVycm9yKGUsIGN0eCwgJ25leHRUaWNrJyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKF9yZXNvbHZlKSB7CiAgICAgICAgX3Jlc29sdmUoY3R4KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIXBlbmRpbmcpIHsKICAgICAgcGVuZGluZyA9IHRydWU7CiAgICAgIGlmICh1c2VNYWNyb1Rhc2spIHsKICAgICAgICBtYWNyb1RpbWVyRnVuYygpOwogICAgICB9IGVsc2UgewogICAgICAgIG1pY3JvVGltZXJGdW5jKCk7CiAgICAgIH0KICAgIH0KICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgaWYgKCFjYiAmJiB0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgICAgX3Jlc29sdmUgPSByZXNvbHZlOwogICAgICB9KQogICAgfQogIH0KCiAgLyogICovCgogIHZhciBtYXJrOwogIHZhciBtZWFzdXJlOwoKICB7CiAgICB2YXIgcGVyZiA9IGluQnJvd3NlciAmJiB3aW5kb3cucGVyZm9ybWFuY2U7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmICgKICAgICAgcGVyZiAmJgogICAgICBwZXJmLm1hcmsgJiYKICAgICAgcGVyZi5tZWFzdXJlICYmCiAgICAgIHBlcmYuY2xlYXJNYXJrcyAmJgogICAgICBwZXJmLmNsZWFyTWVhc3VyZXMKICAgICkgewogICAgICBtYXJrID0gZnVuY3Rpb24gKHRhZykgeyByZXR1cm4gcGVyZi5tYXJrKHRhZyk7IH07CiAgICAgIG1lYXN1cmUgPSBmdW5jdGlvbiAobmFtZSwgc3RhcnRUYWcsIGVuZFRhZykgewogICAgICAgIHBlcmYubWVhc3VyZShuYW1lLCBzdGFydFRhZywgZW5kVGFnKTsKICAgICAgICBwZXJmLmNsZWFyTWFya3Moc3RhcnRUYWcpOwogICAgICAgIHBlcmYuY2xlYXJNYXJrcyhlbmRUYWcpOwogICAgICAgIHBlcmYuY2xlYXJNZWFzdXJlcyhuYW1lKTsKICAgICAgfTsKICAgIH0KICB9CgogIC8qIG5vdCB0eXBlIGNoZWNraW5nIHRoaXMgZmlsZSBiZWNhdXNlIGZsb3cgZG9lc24ndCBwbGF5IHdlbGwgd2l0aCBQcm94eSAqLwoKICB2YXIgaW5pdFByb3h5OwoKICB7CiAgICB2YXIgYWxsb3dlZEdsb2JhbHMgPSBtYWtlTWFwKAogICAgICAnSW5maW5pdHksdW5kZWZpbmVkLE5hTixpc0Zpbml0ZSxpc05hTiwnICsKICAgICAgJ3BhcnNlRmxvYXQscGFyc2VJbnQsZGVjb2RlVVJJLGRlY29kZVVSSUNvbXBvbmVudCxlbmNvZGVVUkksZW5jb2RlVVJJQ29tcG9uZW50LCcgKwogICAgICAnTWF0aCxOdW1iZXIsRGF0ZSxBcnJheSxPYmplY3QsQm9vbGVhbixTdHJpbmcsUmVnRXhwLE1hcCxTZXQsSlNPTixJbnRsLCcgKwogICAgICAncmVxdWlyZScgLy8gZm9yIFdlYnBhY2svQnJvd3NlcmlmeQogICAgKTsKCiAgICB2YXIgd2Fybk5vblByZXNlbnQgPSBmdW5jdGlvbiAodGFyZ2V0LCBrZXkpIHsKICAgICAgd2FybigKICAgICAgICAiUHJvcGVydHkgb3IgbWV0aG9kIFwiIiArIGtleSArICJcIiBpcyBub3QgZGVmaW5lZCBvbiB0aGUgaW5zdGFuY2UgYnV0ICIgKwogICAgICAgICdyZWZlcmVuY2VkIGR1cmluZyByZW5kZXIuIE1ha2Ugc3VyZSB0aGF0IHRoaXMgcHJvcGVydHkgaXMgcmVhY3RpdmUsICcgKwogICAgICAgICdlaXRoZXIgaW4gdGhlIGRhdGEgb3B0aW9uLCBvciBmb3IgY2xhc3MtYmFzZWQgY29tcG9uZW50cywgYnkgJyArCiAgICAgICAgJ2luaXRpYWxpemluZyB0aGUgcHJvcGVydHkuICcgKwogICAgICAgICdTZWU6IGh0dHBzOi8vdnVlanMub3JnL3YyL2d1aWRlL3JlYWN0aXZpdHkuaHRtbCNEZWNsYXJpbmctUmVhY3RpdmUtUHJvcGVydGllcy4nLAogICAgICAgIHRhcmdldAogICAgICApOwogICAgfTsKCiAgICB2YXIgd2FyblJlc2VydmVkUHJlZml4ID0gZnVuY3Rpb24gKHRhcmdldCwga2V5KSB7CiAgICAgIHdhcm4oCiAgICAgICAgIlByb3BlcnR5IFwiIiArIGtleSArICJcIiBtdXN0IGJlIGFjY2Vzc2VkIHdpdGggXCIkZGF0YS4iICsga2V5ICsgIlwiIGJlY2F1c2UgIiArCiAgICAgICAgJ3Byb3BlcnRpZXMgc3RhcnRpbmcgd2l0aCAiJCIgb3IgIl8iIGFyZSBub3QgcHJveGllZCBpbiB0aGUgVnVlIGluc3RhbmNlIHRvICcgKwogICAgICAgICdwcmV2ZW50IGNvbmZsaWN0cyB3aXRoIFZ1ZSBpbnRlcm5hbHMnICsKICAgICAgICAnU2VlOiBodHRwczovL3Z1ZWpzLm9yZy92Mi9hcGkvI2RhdGEnLAogICAgICAgIHRhcmdldAogICAgICApOwogICAgfTsKCiAgICB2YXIgaGFzUHJveHkgPQogICAgICB0eXBlb2YgUHJveHkgIT09ICd1bmRlZmluZWQnICYmIGlzTmF0aXZlKFByb3h5KTsKCiAgICBpZiAoaGFzUHJveHkpIHsKICAgICAgdmFyIGlzQnVpbHRJbk1vZGlmaWVyID0gbWFrZU1hcCgnc3RvcCxwcmV2ZW50LHNlbGYsY3RybCxzaGlmdCxhbHQsbWV0YSxleGFjdCcpOwogICAgICBjb25maWcua2V5Q29kZXMgPSBuZXcgUHJveHkoY29uZmlnLmtleUNvZGVzLCB7CiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQgKHRhcmdldCwga2V5LCB2YWx1ZSkgewogICAgICAgICAgaWYgKGlzQnVpbHRJbk1vZGlmaWVyKGtleSkpIHsKICAgICAgICAgICAgd2FybigoIkF2b2lkIG92ZXJ3cml0aW5nIGJ1aWx0LWluIG1vZGlmaWVyIGluIGNvbmZpZy5rZXlDb2RlczogLiIgKyBrZXkpKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0YXJnZXRba2V5XSA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gdHJ1ZQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgdmFyIGhhc0hhbmRsZXIgPSB7CiAgICAgIGhhczogZnVuY3Rpb24gaGFzICh0YXJnZXQsIGtleSkgewogICAgICAgIHZhciBoYXMgPSBrZXkgaW4gdGFyZ2V0OwogICAgICAgIHZhciBpc0FsbG93ZWQgPSBhbGxvd2VkR2xvYmFscyhrZXkpIHx8CiAgICAgICAgICAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYga2V5LmNoYXJBdCgwKSA9PT0gJ18nICYmICEoa2V5IGluIHRhcmdldC4kZGF0YSkpOwogICAgICAgIGlmICghaGFzICYmICFpc0FsbG93ZWQpIHsKICAgICAgICAgIGlmIChrZXkgaW4gdGFyZ2V0LiRkYXRhKSB7IHdhcm5SZXNlcnZlZFByZWZpeCh0YXJnZXQsIGtleSk7IH0KICAgICAgICAgIGVsc2UgeyB3YXJuTm9uUHJlc2VudCh0YXJnZXQsIGtleSk7IH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGhhcyB8fCAhaXNBbGxvd2VkCiAgICAgIH0KICAgIH07CgogICAgdmFyIGdldEhhbmRsZXIgPSB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0ICh0YXJnZXQsIGtleSkgewogICAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiAhKGtleSBpbiB0YXJnZXQpKSB7CiAgICAgICAgICBpZiAoa2V5IGluIHRhcmdldC4kZGF0YSkgeyB3YXJuUmVzZXJ2ZWRQcmVmaXgodGFyZ2V0LCBrZXkpOyB9CiAgICAgICAgICBlbHNlIHsgd2Fybk5vblByZXNlbnQodGFyZ2V0LCBrZXkpOyB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0YXJnZXRba2V5XQogICAgICB9CiAgICB9OwoKICAgIGluaXRQcm94eSA9IGZ1bmN0aW9uIGluaXRQcm94eSAodm0pIHsKICAgICAgaWYgKGhhc1Byb3h5KSB7CiAgICAgICAgLy8gZGV0ZXJtaW5lIHdoaWNoIHByb3h5IGhhbmRsZXIgdG8gdXNlCiAgICAgICAgdmFyIG9wdGlvbnMgPSB2bS4kb3B0aW9uczsKICAgICAgICB2YXIgaGFuZGxlcnMgPSBvcHRpb25zLnJlbmRlciAmJiBvcHRpb25zLnJlbmRlci5fd2l0aFN0cmlwcGVkCiAgICAgICAgICA/IGdldEhhbmRsZXIKICAgICAgICAgIDogaGFzSGFuZGxlcjsKICAgICAgICB2bS5fcmVuZGVyUHJveHkgPSBuZXcgUHJveHkodm0sIGhhbmRsZXJzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2bS5fcmVuZGVyUHJveHkgPSB2bTsKICAgICAgfQogICAgfTsKICB9CgogIC8qICAqLwoKICB2YXIgc2Vlbk9iamVjdHMgPSBuZXcgX1NldCgpOwoKICAvKioKICAgKiBSZWN1cnNpdmVseSB0cmF2ZXJzZSBhbiBvYmplY3QgdG8gZXZva2UgYWxsIGNvbnZlcnRlZAogICAqIGdldHRlcnMsIHNvIHRoYXQgZXZlcnkgbmVzdGVkIHByb3BlcnR5IGluc2lkZSB0aGUgb2JqZWN0CiAgICogaXMgY29sbGVjdGVkIGFzIGEgImRlZXAiIGRlcGVuZGVuY3kuCiAgICovCiAgZnVuY3Rpb24gdHJhdmVyc2UgKHZhbCkgewogICAgX3RyYXZlcnNlKHZhbCwgc2Vlbk9iamVjdHMpOwogICAgc2Vlbk9iamVjdHMuY2xlYXIoKTsKICB9CgogIGZ1bmN0aW9uIF90cmF2ZXJzZSAodmFsLCBzZWVuKSB7CiAgICB2YXIgaSwga2V5czsKICAgIHZhciBpc0EgPSBBcnJheS5pc0FycmF5KHZhbCk7CiAgICBpZiAoKCFpc0EgJiYgIWlzT2JqZWN0KHZhbCkpIHx8IE9iamVjdC5pc0Zyb3plbih2YWwpIHx8IHZhbCBpbnN0YW5jZW9mIFZOb2RlKSB7CiAgICAgIHJldHVybgogICAgfQogICAgaWYgKHZhbC5fX29iX18pIHsKICAgICAgdmFyIGRlcElkID0gdmFsLl9fb2JfXy5kZXAuaWQ7CiAgICAgIGlmIChzZWVuLmhhcyhkZXBJZCkpIHsKICAgICAgICByZXR1cm4KICAgICAgfQogICAgICBzZWVuLmFkZChkZXBJZCk7CiAgICB9CiAgICBpZiAoaXNBKSB7CiAgICAgIGkgPSB2YWwubGVuZ3RoOwogICAgICB3aGlsZSAoaS0tKSB7IF90cmF2ZXJzZSh2YWxbaV0sIHNlZW4pOyB9CiAgICB9IGVsc2UgewogICAgICBrZXlzID0gT2JqZWN0LmtleXModmFsKTsKICAgICAgaSA9IGtleXMubGVuZ3RoOwogICAgICB3aGlsZSAoaS0tKSB7IF90cmF2ZXJzZSh2YWxba2V5c1tpXV0sIHNlZW4pOyB9CiAgICB9CiAgfQoKICAvKiAgKi8KCiAgdmFyIG5vcm1hbGl6ZUV2ZW50ID0gY2FjaGVkKGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIgcGFzc2l2ZSA9IG5hbWUuY2hhckF0KDApID09PSAnJic7CiAgICBuYW1lID0gcGFzc2l2ZSA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lOwogICAgdmFyIG9uY2UkJDEgPSBuYW1lLmNoYXJBdCgwKSA9PT0gJ34nOyAvLyBQcmVmaXhlZCBsYXN0LCBjaGVja2VkIGZpcnN0CiAgICBuYW1lID0gb25jZSQkMSA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lOwogICAgdmFyIGNhcHR1cmUgPSBuYW1lLmNoYXJBdCgwKSA9PT0gJyEnOwogICAgbmFtZSA9IGNhcHR1cmUgPyBuYW1lLnNsaWNlKDEpIDogbmFtZTsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IG5hbWUsCiAgICAgIG9uY2U6IG9uY2UkJDEsCiAgICAgIGNhcHR1cmU6IGNhcHR1cmUsCiAgICAgIHBhc3NpdmU6IHBhc3NpdmUKICAgIH0KICB9KTsKCiAgZnVuY3Rpb24gY3JlYXRlRm5JbnZva2VyIChmbnMpIHsKICAgIGZ1bmN0aW9uIGludm9rZXIgKCkgewogICAgICB2YXIgYXJndW1lbnRzJDEgPSBhcmd1bWVudHM7CgogICAgICB2YXIgZm5zID0gaW52b2tlci5mbnM7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGZucykpIHsKICAgICAgICB2YXIgY2xvbmVkID0gZm5zLnNsaWNlKCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbG9uZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNsb25lZFtpXS5hcHBseShudWxsLCBhcmd1bWVudHMkMSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIHJldHVybiBoYW5kbGVyIHJldHVybiB2YWx1ZSBmb3Igc2luZ2xlIGhhbmRsZXJzCiAgICAgICAgcmV0dXJuIGZucy5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgICAgIH0KICAgIH0KICAgIGludm9rZXIuZm5zID0gZm5zOwogICAgcmV0dXJuIGludm9rZXIKICB9CgogIGZ1bmN0aW9uIHVwZGF0ZUxpc3RlbmVycyAoCiAgICBvbiwKICAgIG9sZE9uLAogICAgYWRkLAogICAgcmVtb3ZlJCQxLAogICAgY3JlYXRlT25jZUhhbmRsZXIsCiAgICB2bQogICkgewogICAgdmFyIG5hbWUsIGRlZiQkMSwgY3VyLCBvbGQsIGV2ZW50OwogICAgZm9yIChuYW1lIGluIG9uKSB7CiAgICAgIGRlZiQkMSA9IGN1ciA9IG9uW25hbWVdOwogICAgICBvbGQgPSBvbGRPbltuYW1lXTsKICAgICAgZXZlbnQgPSBub3JtYWxpemVFdmVudChuYW1lKTsKICAgICAgaWYgKGlzVW5kZWYoY3VyKSkgewogICAgICAgIHdhcm4oCiAgICAgICAgICAiSW52YWxpZCBoYW5kbGVyIGZvciBldmVudCBcIiIgKyAoZXZlbnQubmFtZSkgKyAiXCI6IGdvdCAiICsgU3RyaW5nKGN1ciksCiAgICAgICAgICB2bQogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAoaXNVbmRlZihvbGQpKSB7CiAgICAgICAgaWYgKGlzVW5kZWYoY3VyLmZucykpIHsKICAgICAgICAgIGN1ciA9IG9uW25hbWVdID0gY3JlYXRlRm5JbnZva2VyKGN1cik7CiAgICAgICAgfQogICAgICAgIGlmIChpc1RydWUoZXZlbnQub25jZSkpIHsKICAgICAgICAgIGN1ciA9IG9uW25hbWVdID0gY3JlYXRlT25jZUhhbmRsZXIoZXZlbnQubmFtZSwgY3VyLCBldmVudC5jYXB0dXJlKTsKICAgICAgICB9CiAgICAgICAgYWRkKGV2ZW50Lm5hbWUsIGN1ciwgZXZlbnQuY2FwdHVyZSwgZXZlbnQucGFzc2l2ZSwgZXZlbnQucGFyYW1zKTsKICAgICAgfSBlbHNlIGlmIChjdXIgIT09IG9sZCkgewogICAgICAgIG9sZC5mbnMgPSBjdXI7CiAgICAgICAgb25bbmFtZV0gPSBvbGQ7CiAgICAgIH0KICAgIH0KICAgIGZvciAobmFtZSBpbiBvbGRPbikgewogICAgICBpZiAoaXNVbmRlZihvbltuYW1lXSkpIHsKICAgICAgICBldmVudCA9IG5vcm1hbGl6ZUV2ZW50KG5hbWUpOwogICAgICAgIHJlbW92ZSQkMShldmVudC5uYW1lLCBvbGRPbltuYW1lXSwgZXZlbnQuY2FwdHVyZSk7CiAgICAgIH0KICAgIH0KICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBtZXJnZVZOb2RlSG9vayAoZGVmLCBob29rS2V5LCBob29rKSB7CiAgICBpZiAoZGVmIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgICAgZGVmID0gZGVmLmRhdGEuaG9vayB8fCAoZGVmLmRhdGEuaG9vayA9IHt9KTsKICAgIH0KICAgIHZhciBpbnZva2VyOwogICAgdmFyIG9sZEhvb2sgPSBkZWZbaG9va0tleV07CgogICAgZnVuY3Rpb24gd3JhcHBlZEhvb2sgKCkgewogICAgICBob29rLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIC8vIGltcG9ydGFudDogcmVtb3ZlIG1lcmdlZCBob29rIHRvIGVuc3VyZSBpdCdzIGNhbGxlZCBvbmx5IG9uY2UKICAgICAgLy8gYW5kIHByZXZlbnQgbWVtb3J5IGxlYWsKICAgICAgcmVtb3ZlKGludm9rZXIuZm5zLCB3cmFwcGVkSG9vayk7CiAgICB9CgogICAgaWYgKGlzVW5kZWYob2xkSG9vaykpIHsKICAgICAgLy8gbm8gZXhpc3RpbmcgaG9vawogICAgICBpbnZva2VyID0gY3JlYXRlRm5JbnZva2VyKFt3cmFwcGVkSG9va10pOwogICAgfSBlbHNlIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmIChpc0RlZihvbGRIb29rLmZucykgJiYgaXNUcnVlKG9sZEhvb2subWVyZ2VkKSkgewogICAgICAgIC8vIGFscmVhZHkgYSBtZXJnZWQgaW52b2tlcgogICAgICAgIGludm9rZXIgPSBvbGRIb29rOwogICAgICAgIGludm9rZXIuZm5zLnB1c2god3JhcHBlZEhvb2spOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGV4aXN0aW5nIHBsYWluIGhvb2sKICAgICAgICBpbnZva2VyID0gY3JlYXRlRm5JbnZva2VyKFtvbGRIb29rLCB3cmFwcGVkSG9va10pOwogICAgICB9CiAgICB9CgogICAgaW52b2tlci5tZXJnZWQgPSB0cnVlOwogICAgZGVmW2hvb2tLZXldID0gaW52b2tlcjsKICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBleHRyYWN0UHJvcHNGcm9tVk5vZGVEYXRhICgKICAgIGRhdGEsCiAgICBDdG9yLAogICAgdGFnCiAgKSB7CiAgICAvLyB3ZSBhcmUgb25seSBleHRyYWN0aW5nIHJhdyB2YWx1ZXMgaGVyZS4KICAgIC8vIHZhbGlkYXRpb24gYW5kIGRlZmF1bHQgdmFsdWVzIGFyZSBoYW5kbGVkIGluIHRoZSBjaGlsZAogICAgLy8gY29tcG9uZW50IGl0c2VsZi4KICAgIHZhciBwcm9wT3B0aW9ucyA9IEN0b3Iub3B0aW9ucy5wcm9wczsKICAgIGlmIChpc1VuZGVmKHByb3BPcHRpb25zKSkgewogICAgICByZXR1cm4KICAgIH0KICAgIHZhciByZXMgPSB7fTsKICAgIHZhciBhdHRycyA9IGRhdGEuYXR0cnM7CiAgICB2YXIgcHJvcHMgPSBkYXRhLnByb3BzOwogICAgaWYgKGlzRGVmKGF0dHJzKSB8fCBpc0RlZihwcm9wcykpIHsKICAgICAgZm9yICh2YXIga2V5IGluIHByb3BPcHRpb25zKSB7CiAgICAgICAgdmFyIGFsdEtleSA9IGh5cGhlbmF0ZShrZXkpOwogICAgICAgIHsKICAgICAgICAgIHZhciBrZXlJbkxvd2VyQ2FzZSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgaWYgKAogICAgICAgICAgICBrZXkgIT09IGtleUluTG93ZXJDYXNlICYmCiAgICAgICAgICAgIGF0dHJzICYmIGhhc093bihhdHRycywga2V5SW5Mb3dlckNhc2UpCiAgICAgICAgICApIHsKICAgICAgICAgICAgdGlwKAogICAgICAgICAgICAgICJQcm9wIFwiIiArIGtleUluTG93ZXJDYXNlICsgIlwiIGlzIHBhc3NlZCB0byBjb21wb25lbnQgIiArCiAgICAgICAgICAgICAgKGZvcm1hdENvbXBvbmVudE5hbWUodGFnIHx8IEN0b3IpKSArICIsIGJ1dCB0aGUgZGVjbGFyZWQgcHJvcCBuYW1lIGlzIiArCiAgICAgICAgICAgICAgIiBcIiIgKyBrZXkgKyAiXCIuICIgKwogICAgICAgICAgICAgICJOb3RlIHRoYXQgSFRNTCBhdHRyaWJ1dGVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlIGFuZCBjYW1lbENhc2VkICIgKwogICAgICAgICAgICAgICJwcm9wcyBuZWVkIHRvIHVzZSB0aGVpciBrZWJhYi1jYXNlIGVxdWl2YWxlbnRzIHdoZW4gdXNpbmcgaW4tRE9NICIgKwogICAgICAgICAgICAgICJ0ZW1wbGF0ZXMuIFlvdSBzaG91bGQgcHJvYmFibHkgdXNlIFwiIiArIGFsdEtleSArICJcIiBpbnN0ZWFkIG9mIFwiIiArIGtleSArICJcIi4iCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNoZWNrUHJvcChyZXMsIHByb3BzLCBrZXksIGFsdEtleSwgdHJ1ZSkgfHwKICAgICAgICBjaGVja1Byb3AocmVzLCBhdHRycywga2V5LCBhbHRLZXksIGZhbHNlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgZnVuY3Rpb24gY2hlY2tQcm9wICgKICAgIHJlcywKICAgIGhhc2gsCiAgICBrZXksCiAgICBhbHRLZXksCiAgICBwcmVzZXJ2ZQogICkgewogICAgaWYgKGlzRGVmKGhhc2gpKSB7CiAgICAgIGlmIChoYXNPd24oaGFzaCwga2V5KSkgewogICAgICAgIHJlc1trZXldID0gaGFzaFtrZXldOwogICAgICAgIGlmICghcHJlc2VydmUpIHsKICAgICAgICAgIGRlbGV0ZSBoYXNoW2tleV07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlCiAgICAgIH0gZWxzZSBpZiAoaGFzT3duKGhhc2gsIGFsdEtleSkpIHsKICAgICAgICByZXNba2V5XSA9IGhhc2hbYWx0S2V5XTsKICAgICAgICBpZiAoIXByZXNlcnZlKSB7CiAgICAgICAgICBkZWxldGUgaGFzaFthbHRLZXldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9CgogIC8qICAqLwoKICAvLyBUaGUgdGVtcGxhdGUgY29tcGlsZXIgYXR0ZW1wdHMgdG8gbWluaW1pemUgdGhlIG5lZWQgZm9yIG5vcm1hbGl6YXRpb24gYnkKICAvLyBzdGF0aWNhbGx5IGFuYWx5emluZyB0aGUgdGVtcGxhdGUgYXQgY29tcGlsZSB0aW1lLgogIC8vCiAgLy8gRm9yIHBsYWluIEhUTUwgbWFya3VwLCBub3JtYWxpemF0aW9uIGNhbiBiZSBjb21wbGV0ZWx5IHNraXBwZWQgYmVjYXVzZSB0aGUKICAvLyBnZW5lcmF0ZWQgcmVuZGVyIGZ1bmN0aW9uIGlzIGd1YXJhbnRlZWQgdG8gcmV0dXJuIEFycmF5PFZOb2RlPi4gVGhlcmUgYXJlCiAgLy8gdHdvIGNhc2VzIHdoZXJlIGV4dHJhIG5vcm1hbGl6YXRpb24gaXMgbmVlZGVkOgoKICAvLyAxLiBXaGVuIHRoZSBjaGlsZHJlbiBjb250YWlucyBjb21wb25lbnRzIC0gYmVjYXVzZSBhIGZ1bmN0aW9uYWwgY29tcG9uZW50CiAgLy8gbWF5IHJldHVybiBhbiBBcnJheSBpbnN0ZWFkIG9mIGEgc2luZ2xlIHJvb3QuIEluIHRoaXMgY2FzZSwganVzdCBhIHNpbXBsZQogIC8vIG5vcm1hbGl6YXRpb24gaXMgbmVlZGVkIC0gaWYgYW55IGNoaWxkIGlzIGFuIEFycmF5LCB3ZSBmbGF0dGVuIHRoZSB3aG9sZQogIC8vIHRoaW5nIHdpdGggQXJyYXkucHJvdG90eXBlLmNvbmNhdC4gSXQgaXMgZ3VhcmFudGVlZCB0byBiZSBvbmx5IDEtbGV2ZWwgZGVlcAogIC8vIGJlY2F1c2UgZnVuY3Rpb25hbCBjb21wb25lbnRzIGFscmVhZHkgbm9ybWFsaXplIHRoZWlyIG93biBjaGlsZHJlbi4KICBmdW5jdGlvbiBzaW1wbGVOb3JtYWxpemVDaGlsZHJlbiAoY2hpbGRyZW4pIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY2hpbGRyZW5baV0pKSB7CiAgICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5jb25jYXQuYXBwbHkoW10sIGNoaWxkcmVuKQogICAgICB9CiAgICB9CiAgICByZXR1cm4gY2hpbGRyZW4KICB9CgogIC8vIDIuIFdoZW4gdGhlIGNoaWxkcmVuIGNvbnRhaW5zIGNvbnN0cnVjdHMgdGhhdCBhbHdheXMgZ2VuZXJhdGVkIG5lc3RlZCBBcnJheXMsCiAgLy8gZS5nLiA8dGVtcGxhdGU+LCA8c2xvdD4sIHYtZm9yLCBvciB3aGVuIHRoZSBjaGlsZHJlbiBpcyBwcm92aWRlZCBieSB1c2VyCiAgLy8gd2l0aCBoYW5kLXdyaXR0ZW4gcmVuZGVyIGZ1bmN0aW9ucyAvIEpTWC4gSW4gc3VjaCBjYXNlcyBhIGZ1bGwgbm9ybWFsaXphdGlvbgogIC8vIGlzIG5lZWRlZCB0byBjYXRlciB0byBhbGwgcG9zc2libGUgdHlwZXMgb2YgY2hpbGRyZW4gdmFsdWVzLgogIGZ1bmN0aW9uIG5vcm1hbGl6ZUNoaWxkcmVuIChjaGlsZHJlbikgewogICAgcmV0dXJuIGlzUHJpbWl0aXZlKGNoaWxkcmVuKQogICAgICA/IFtjcmVhdGVUZXh0Vk5vZGUoY2hpbGRyZW4pXQogICAgICA6IEFycmF5LmlzQXJyYXkoY2hpbGRyZW4pCiAgICAgICAgPyBub3JtYWxpemVBcnJheUNoaWxkcmVuKGNoaWxkcmVuKQogICAgICAgIDogdW5kZWZpbmVkCiAgfQoKICBmdW5jdGlvbiBpc1RleHROb2RlIChub2RlKSB7CiAgICByZXR1cm4gaXNEZWYobm9kZSkgJiYgaXNEZWYobm9kZS50ZXh0KSAmJiBpc0ZhbHNlKG5vZGUuaXNDb21tZW50KQogIH0KCiAgZnVuY3Rpb24gbm9ybWFsaXplQXJyYXlDaGlsZHJlbiAoY2hpbGRyZW4sIG5lc3RlZEluZGV4KSB7CiAgICB2YXIgcmVzID0gW107CiAgICB2YXIgaSwgYywgbGFzdEluZGV4LCBsYXN0OwogICAgZm9yIChpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGMgPSBjaGlsZHJlbltpXTsKICAgICAgaWYgKGlzVW5kZWYoYykgfHwgdHlwZW9mIGMgPT09ICdib29sZWFuJykgeyBjb250aW51ZSB9CiAgICAgIGxhc3RJbmRleCA9IHJlcy5sZW5ndGggLSAxOwogICAgICBsYXN0ID0gcmVzW2xhc3RJbmRleF07CiAgICAgIC8vICBuZXN0ZWQKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYykpIHsKICAgICAgICBpZiAoYy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBjID0gbm9ybWFsaXplQXJyYXlDaGlsZHJlbihjLCAoKG5lc3RlZEluZGV4IHx8ICcnKSArICJfIiArIGkpKTsKICAgICAgICAgIC8vIG1lcmdlIGFkamFjZW50IHRleHQgbm9kZXMKICAgICAgICAgIGlmIChpc1RleHROb2RlKGNbMF0pICYmIGlzVGV4dE5vZGUobGFzdCkpIHsKICAgICAgICAgICAgcmVzW2xhc3RJbmRleF0gPSBjcmVhdGVUZXh0Vk5vZGUobGFzdC50ZXh0ICsgKGNbMF0pLnRleHQpOwogICAgICAgICAgICBjLnNoaWZ0KCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXMucHVzaC5hcHBseShyZXMsIGMpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpc1ByaW1pdGl2ZShjKSkgewogICAgICAgIGlmIChpc1RleHROb2RlKGxhc3QpKSB7CiAgICAgICAgICAvLyBtZXJnZSBhZGphY2VudCB0ZXh0IG5vZGVzCiAgICAgICAgICAvLyB0aGlzIGlzIG5lY2Vzc2FyeSBmb3IgU1NSIGh5ZHJhdGlvbiBiZWNhdXNlIHRleHQgbm9kZXMgYXJlCiAgICAgICAgICAvLyBlc3NlbnRpYWxseSBtZXJnZWQgd2hlbiByZW5kZXJlZCB0byBIVE1MIHN0cmluZ3MKICAgICAgICAgIHJlc1tsYXN0SW5kZXhdID0gY3JlYXRlVGV4dFZOb2RlKGxhc3QudGV4dCArIGMpOwogICAgICAgIH0gZWxzZSBpZiAoYyAhPT0gJycpIHsKICAgICAgICAgIC8vIGNvbnZlcnQgcHJpbWl0aXZlIHRvIHZub2RlCiAgICAgICAgICByZXMucHVzaChjcmVhdGVUZXh0Vk5vZGUoYykpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoaXNUZXh0Tm9kZShjKSAmJiBpc1RleHROb2RlKGxhc3QpKSB7CiAgICAgICAgICAvLyBtZXJnZSBhZGphY2VudCB0ZXh0IG5vZGVzCiAgICAgICAgICByZXNbbGFzdEluZGV4XSA9IGNyZWF0ZVRleHRWTm9kZShsYXN0LnRleHQgKyBjLnRleHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBkZWZhdWx0IGtleSBmb3IgbmVzdGVkIGFycmF5IGNoaWxkcmVuIChsaWtlbHkgZ2VuZXJhdGVkIGJ5IHYtZm9yKQogICAgICAgICAgaWYgKGlzVHJ1ZShjaGlsZHJlbi5faXNWTGlzdCkgJiYKICAgICAgICAgICAgaXNEZWYoYy50YWcpICYmCiAgICAgICAgICAgIGlzVW5kZWYoYy5rZXkpICYmCiAgICAgICAgICAgIGlzRGVmKG5lc3RlZEluZGV4KSkgewogICAgICAgICAgICBjLmtleSA9ICJfX3ZsaXN0IiArIG5lc3RlZEluZGV4ICsgIl8iICsgaSArICJfXyI7CiAgICAgICAgICB9CiAgICAgICAgICByZXMucHVzaChjKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXMKICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBlbnN1cmVDdG9yIChjb21wLCBiYXNlKSB7CiAgICBpZiAoCiAgICAgIGNvbXAuX19lc01vZHVsZSB8fAogICAgICAoaGFzU3ltYm9sICYmIGNvbXBbU3ltYm9sLnRvU3RyaW5nVGFnXSA9PT0gJ01vZHVsZScpCiAgICApIHsKICAgICAgY29tcCA9IGNvbXAuZGVmYXVsdDsKICAgIH0KICAgIHJldHVybiBpc09iamVjdChjb21wKQogICAgICA/IGJhc2UuZXh0ZW5kKGNvbXApCiAgICAgIDogY29tcAogIH0KCiAgZnVuY3Rpb24gY3JlYXRlQXN5bmNQbGFjZWhvbGRlciAoCiAgICBmYWN0b3J5LAogICAgZGF0YSwKICAgIGNvbnRleHQsCiAgICBjaGlsZHJlbiwKICAgIHRhZwogICkgewogICAgdmFyIG5vZGUgPSBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgICBub2RlLmFzeW5jRmFjdG9yeSA9IGZhY3Rvcnk7CiAgICBub2RlLmFzeW5jTWV0YSA9IHsgZGF0YTogZGF0YSwgY29udGV4dDogY29udGV4dCwgY2hpbGRyZW46IGNoaWxkcmVuLCB0YWc6IHRhZyB9OwogICAgcmV0dXJuIG5vZGUKICB9CgogIGZ1bmN0aW9uIHJlc29sdmVBc3luY0NvbXBvbmVudCAoCiAgICBmYWN0b3J5LAogICAgYmFzZUN0b3IsCiAgICBjb250ZXh0CiAgKSB7CiAgICBpZiAoaXNUcnVlKGZhY3RvcnkuZXJyb3IpICYmIGlzRGVmKGZhY3RvcnkuZXJyb3JDb21wKSkgewogICAgICByZXR1cm4gZmFjdG9yeS5lcnJvckNvbXAKICAgIH0KCiAgICBpZiAoaXNEZWYoZmFjdG9yeS5yZXNvbHZlZCkpIHsKICAgICAgcmV0dXJuIGZhY3RvcnkucmVzb2x2ZWQKICAgIH0KCiAgICBpZiAoaXNUcnVlKGZhY3RvcnkubG9hZGluZykgJiYgaXNEZWYoZmFjdG9yeS5sb2FkaW5nQ29tcCkpIHsKICAgICAgcmV0dXJuIGZhY3RvcnkubG9hZGluZ0NvbXAKICAgIH0KCiAgICBpZiAoaXNEZWYoZmFjdG9yeS5jb250ZXh0cykpIHsKICAgICAgLy8gYWxyZWFkeSBwZW5kaW5nCiAgICAgIGZhY3RvcnkuY29udGV4dHMucHVzaChjb250ZXh0KTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBjb250ZXh0cyA9IGZhY3RvcnkuY29udGV4dHMgPSBbY29udGV4dF07CiAgICAgIHZhciBzeW5jID0gdHJ1ZTsKCiAgICAgIHZhciBmb3JjZVJlbmRlciA9IGZ1bmN0aW9uIChyZW5kZXJDb21wbGV0ZWQpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNvbnRleHRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgY29udGV4dHNbaV0uJGZvcmNlVXBkYXRlKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAocmVuZGVyQ29tcGxldGVkKSB7CiAgICAgICAgICBjb250ZXh0cy5sZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciByZXNvbHZlID0gb25jZShmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgLy8gY2FjaGUgcmVzb2x2ZWQKICAgICAgICBmYWN0b3J5LnJlc29sdmVkID0gZW5zdXJlQ3RvcihyZXMsIGJhc2VDdG9yKTsKICAgICAgICAvLyBpbnZva2UgY2FsbGJhY2tzIG9ubHkgaWYgdGhpcyBpcyBub3QgYSBzeW5jaHJvbm91cyByZXNvbHZlCiAgICAgICAgLy8gKGFzeW5jIHJlc29sdmVzIGFyZSBzaGltbWVkIGFzIHN5bmNocm9ub3VzIGR1cmluZyBTU1IpCiAgICAgICAgaWYgKCFzeW5jKSB7CiAgICAgICAgICBmb3JjZVJlbmRlcih0cnVlKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgdmFyIHJlamVjdCA9IG9uY2UoZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgIHdhcm4oCiAgICAgICAgICAiRmFpbGVkIHRvIHJlc29sdmUgYXN5bmMgY29tcG9uZW50OiAiICsgKFN0cmluZyhmYWN0b3J5KSkgKwogICAgICAgICAgKHJlYXNvbiA/ICgiXG5SZWFzb246ICIgKyByZWFzb24pIDogJycpCiAgICAgICAgKTsKICAgICAgICBpZiAoaXNEZWYoZmFjdG9yeS5lcnJvckNvbXApKSB7CiAgICAgICAgICBmYWN0b3J5LmVycm9yID0gdHJ1ZTsKICAgICAgICAgIGZvcmNlUmVuZGVyKHRydWUpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICB2YXIgcmVzID0gZmFjdG9yeShyZXNvbHZlLCByZWplY3QpOwoKICAgICAgaWYgKGlzT2JqZWN0KHJlcykpIHsKICAgICAgICBpZiAodHlwZW9mIHJlcy50aGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAvLyAoKSA9PiBQcm9taXNlCiAgICAgICAgICBpZiAoaXNVbmRlZihmYWN0b3J5LnJlc29sdmVkKSkgewogICAgICAgICAgICByZXMudGhlbihyZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoaXNEZWYocmVzLmNvbXBvbmVudCkgJiYgdHlwZW9mIHJlcy5jb21wb25lbnQudGhlbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgcmVzLmNvbXBvbmVudC50aGVuKHJlc29sdmUsIHJlamVjdCk7CgogICAgICAgICAgaWYgKGlzRGVmKHJlcy5lcnJvcikpIHsKICAgICAgICAgICAgZmFjdG9yeS5lcnJvckNvbXAgPSBlbnN1cmVDdG9yKHJlcy5lcnJvciwgYmFzZUN0b3IpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpc0RlZihyZXMubG9hZGluZykpIHsKICAgICAgICAgICAgZmFjdG9yeS5sb2FkaW5nQ29tcCA9IGVuc3VyZUN0b3IocmVzLmxvYWRpbmcsIGJhc2VDdG9yKTsKICAgICAgICAgICAgaWYgKHJlcy5kZWxheSA9PT0gMCkgewogICAgICAgICAgICAgIGZhY3RvcnkubG9hZGluZyA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNVbmRlZihmYWN0b3J5LnJlc29sdmVkKSAmJiBpc1VuZGVmKGZhY3RvcnkuZXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIGZhY3RvcnkubG9hZGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGZvcmNlUmVuZGVyKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LCByZXMuZGVsYXkgfHwgMjAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpc0RlZihyZXMudGltZW91dCkpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgaWYgKGlzVW5kZWYoZmFjdG9yeS5yZXNvbHZlZCkpIHsKICAgICAgICAgICAgICAgIHJlamVjdCgKICAgICAgICAgICAgICAgICAgInRpbWVvdXQgKCIgKyAocmVzLnRpbWVvdXQpICsgIm1zKSIKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCByZXMudGltZW91dCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBzeW5jID0gZmFsc2U7CiAgICAgIC8vIHJldHVybiBpbiBjYXNlIHJlc29sdmVkIHN5bmNocm9ub3VzbHkKICAgICAgcmV0dXJuIGZhY3RvcnkubG9hZGluZwogICAgICAgID8gZmFjdG9yeS5sb2FkaW5nQ29tcAogICAgICAgIDogZmFjdG9yeS5yZXNvbHZlZAogICAgfQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGlzQXN5bmNQbGFjZWhvbGRlciAobm9kZSkgewogICAgcmV0dXJuIG5vZGUuaXNDb21tZW50ICYmIG5vZGUuYXN5bmNGYWN0b3J5CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gZ2V0Rmlyc3RDb21wb25lbnRDaGlsZCAoY2hpbGRyZW4pIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGNoaWxkcmVuKSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGMgPSBjaGlsZHJlbltpXTsKICAgICAgICBpZiAoaXNEZWYoYykgJiYgKGlzRGVmKGMuY29tcG9uZW50T3B0aW9ucykgfHwgaXNBc3luY1BsYWNlaG9sZGVyKGMpKSkgewogICAgICAgICAgcmV0dXJuIGMKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIC8qICAqLwoKICAvKiAgKi8KCiAgZnVuY3Rpb24gaW5pdEV2ZW50cyAodm0pIHsKICAgIHZtLl9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdm0uX2hhc0hvb2tFdmVudCA9IGZhbHNlOwogICAgLy8gaW5pdCBwYXJlbnQgYXR0YWNoZWQgZXZlbnRzCiAgICB2YXIgbGlzdGVuZXJzID0gdm0uJG9wdGlvbnMuX3BhcmVudExpc3RlbmVyczsKICAgIGlmIChsaXN0ZW5lcnMpIHsKICAgICAgdXBkYXRlQ29tcG9uZW50TGlzdGVuZXJzKHZtLCBsaXN0ZW5lcnMpOwogICAgfQogIH0KCiAgdmFyIHRhcmdldDsKCiAgZnVuY3Rpb24gYWRkIChldmVudCwgZm4pIHsKICAgIHRhcmdldC4kb24oZXZlbnQsIGZuKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZSQxIChldmVudCwgZm4pIHsKICAgIHRhcmdldC4kb2ZmKGV2ZW50LCBmbik7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVPbmNlSGFuZGxlciAoZXZlbnQsIGZuKSB7CiAgICB2YXIgX3RhcmdldCA9IHRhcmdldDsKICAgIHJldHVybiBmdW5jdGlvbiBvbmNlSGFuZGxlciAoKSB7CiAgICAgIHZhciByZXMgPSBmbi5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICBpZiAocmVzICE9PSBudWxsKSB7CiAgICAgICAgX3RhcmdldC4kb2ZmKGV2ZW50LCBvbmNlSGFuZGxlcik7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHVwZGF0ZUNvbXBvbmVudExpc3RlbmVycyAoCiAgICB2bSwKICAgIGxpc3RlbmVycywKICAgIG9sZExpc3RlbmVycwogICkgewogICAgdGFyZ2V0ID0gdm07CiAgICB1cGRhdGVMaXN0ZW5lcnMobGlzdGVuZXJzLCBvbGRMaXN0ZW5lcnMgfHwge30sIGFkZCwgcmVtb3ZlJDEsIGNyZWF0ZU9uY2VIYW5kbGVyLCB2bSk7CiAgICB0YXJnZXQgPSB1bmRlZmluZWQ7CiAgfQoKICBmdW5jdGlvbiBldmVudHNNaXhpbiAoVnVlKSB7CiAgICB2YXIgaG9va1JFID0gL15ob29rOi87CiAgICBWdWUucHJvdG90eXBlLiRvbiA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXZlbnQpKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBldmVudC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHZtLiRvbihldmVudFtpXSwgZm4pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAodm0uX2V2ZW50c1tldmVudF0gfHwgKHZtLl9ldmVudHNbZXZlbnRdID0gW10pKS5wdXNoKGZuKTsKICAgICAgICAvLyBvcHRpbWl6ZSBob29rOmV2ZW50IGNvc3QgYnkgdXNpbmcgYSBib29sZWFuIGZsYWcgbWFya2VkIGF0IHJlZ2lzdHJhdGlvbgogICAgICAgIC8vIGluc3RlYWQgb2YgYSBoYXNoIGxvb2t1cAogICAgICAgIGlmIChob29rUkUudGVzdChldmVudCkpIHsKICAgICAgICAgIHZtLl9oYXNIb29rRXZlbnQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdm0KICAgIH07CgogICAgVnVlLnByb3RvdHlwZS4kb25jZSA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgZnVuY3Rpb24gb24gKCkgewogICAgICAgIHZtLiRvZmYoZXZlbnQsIG9uKTsKICAgICAgICBmbi5hcHBseSh2bSwgYXJndW1lbnRzKTsKICAgICAgfQogICAgICBvbi5mbiA9IGZuOwogICAgICB2bS4kb24oZXZlbnQsIG9uKTsKICAgICAgcmV0dXJuIHZtCiAgICB9OwoKICAgIFZ1ZS5wcm90b3R5cGUuJG9mZiA9IGZ1bmN0aW9uIChldmVudCwgZm4pIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgLy8gYWxsCiAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHZtLl9ldmVudHMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgIHJldHVybiB2bQogICAgICB9CiAgICAgIC8vIGFycmF5IG9mIGV2ZW50cwogICAgICBpZiAoQXJyYXkuaXNBcnJheShldmVudCkpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGV2ZW50Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdm0uJG9mZihldmVudFtpXSwgZm4pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdm0KICAgICAgfQogICAgICAvLyBzcGVjaWZpYyBldmVudAogICAgICB2YXIgY2JzID0gdm0uX2V2ZW50c1tldmVudF07CiAgICAgIGlmICghY2JzKSB7CiAgICAgICAgcmV0dXJuIHZtCiAgICAgIH0KICAgICAgaWYgKCFmbikgewogICAgICAgIHZtLl9ldmVudHNbZXZlbnRdID0gbnVsbDsKICAgICAgICByZXR1cm4gdm0KICAgICAgfQogICAgICBpZiAoZm4pIHsKICAgICAgICAvLyBzcGVjaWZpYyBoYW5kbGVyCiAgICAgICAgdmFyIGNiOwogICAgICAgIHZhciBpJDEgPSBjYnMubGVuZ3RoOwogICAgICAgIHdoaWxlIChpJDEtLSkgewogICAgICAgICAgY2IgPSBjYnNbaSQxXTsKICAgICAgICAgIGlmIChjYiA9PT0gZm4gfHwgY2IuZm4gPT09IGZuKSB7CiAgICAgICAgICAgIGNicy5zcGxpY2UoaSQxLCAxKTsKICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHZtCiAgICB9OwoKICAgIFZ1ZS5wcm90b3R5cGUuJGVtaXQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgewogICAgICAgIHZhciBsb3dlckNhc2VFdmVudCA9IGV2ZW50LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKGxvd2VyQ2FzZUV2ZW50ICE9PSBldmVudCAmJiB2bS5fZXZlbnRzW2xvd2VyQ2FzZUV2ZW50XSkgewogICAgICAgICAgdGlwKAogICAgICAgICAgICAiRXZlbnQgXCIiICsgbG93ZXJDYXNlRXZlbnQgKyAiXCIgaXMgZW1pdHRlZCBpbiBjb21wb25lbnQgIiArCiAgICAgICAgICAgIChmb3JtYXRDb21wb25lbnROYW1lKHZtKSkgKyAiIGJ1dCB0aGUgaGFuZGxlciBpcyByZWdpc3RlcmVkIGZvciBcIiIgKyBldmVudCArICJcIi4gIiArCiAgICAgICAgICAgICJOb3RlIHRoYXQgSFRNTCBhdHRyaWJ1dGVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlIGFuZCB5b3UgY2Fubm90IHVzZSAiICsKICAgICAgICAgICAgInYtb24gdG8gbGlzdGVuIHRvIGNhbWVsQ2FzZSBldmVudHMgd2hlbiB1c2luZyBpbi1ET00gdGVtcGxhdGVzLiAiICsKICAgICAgICAgICAgIllvdSBzaG91bGQgcHJvYmFibHkgdXNlIFwiIiArIChoeXBoZW5hdGUoZXZlbnQpKSArICJcIiBpbnN0ZWFkIG9mIFwiIiArIGV2ZW50ICsgIlwiLiIKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciBjYnMgPSB2bS5fZXZlbnRzW2V2ZW50XTsKICAgICAgaWYgKGNicykgewogICAgICAgIGNicyA9IGNicy5sZW5ndGggPiAxID8gdG9BcnJheShjYnMpIDogY2JzOwogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMsIDEpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2JzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY2JzW2ldLmFwcGx5KHZtLCBhcmdzKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sICgiZXZlbnQgaGFuZGxlciBmb3IgXCIiICsgZXZlbnQgKyAiXCIiKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB2bQogICAgfTsKICB9CgogIC8qICAqLwoKCgogIC8qKgogICAqIFJ1bnRpbWUgaGVscGVyIGZvciByZXNvbHZpbmcgcmF3IGNoaWxkcmVuIFZOb2RlcyBpbnRvIGEgc2xvdCBvYmplY3QuCiAgICovCiAgZnVuY3Rpb24gcmVzb2x2ZVNsb3RzICgKICAgIGNoaWxkcmVuLAogICAgY29udGV4dAogICkgewogICAgdmFyIHNsb3RzID0ge307CiAgICBpZiAoIWNoaWxkcmVuKSB7CiAgICAgIHJldHVybiBzbG90cwogICAgfQogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgIHZhciBkYXRhID0gY2hpbGQuZGF0YTsKICAgICAgLy8gcmVtb3ZlIHNsb3QgYXR0cmlidXRlIGlmIHRoZSBub2RlIGlzIHJlc29sdmVkIGFzIGEgVnVlIHNsb3Qgbm9kZQogICAgICBpZiAoZGF0YSAmJiBkYXRhLmF0dHJzICYmIGRhdGEuYXR0cnMuc2xvdCkgewogICAgICAgIGRlbGV0ZSBkYXRhLmF0dHJzLnNsb3Q7CiAgICAgIH0KICAgICAgLy8gbmFtZWQgc2xvdHMgc2hvdWxkIG9ubHkgYmUgcmVzcGVjdGVkIGlmIHRoZSB2bm9kZSB3YXMgcmVuZGVyZWQgaW4gdGhlCiAgICAgIC8vIHNhbWUgY29udGV4dC4KICAgICAgaWYgKChjaGlsZC5jb250ZXh0ID09PSBjb250ZXh0IHx8IGNoaWxkLmZuQ29udGV4dCA9PT0gY29udGV4dCkgJiYKICAgICAgICBkYXRhICYmIGRhdGEuc2xvdCAhPSBudWxsCiAgICAgICkgewogICAgICAgIHZhciBuYW1lID0gZGF0YS5zbG90OwogICAgICAgIHZhciBzbG90ID0gKHNsb3RzW25hbWVdIHx8IChzbG90c1tuYW1lXSA9IFtdKSk7CiAgICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gJ3RlbXBsYXRlJykgewogICAgICAgICAgc2xvdC5wdXNoLmFwcGx5KHNsb3QsIGNoaWxkLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2xvdC5wdXNoKGNoaWxkKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKHNsb3RzLmRlZmF1bHQgfHwgKHNsb3RzLmRlZmF1bHQgPSBbXSkpLnB1c2goY2hpbGQpOwogICAgICB9CiAgICB9CiAgICAvLyBpZ25vcmUgc2xvdHMgdGhhdCBjb250YWlucyBvbmx5IHdoaXRlc3BhY2UKICAgIGZvciAodmFyIG5hbWUkMSBpbiBzbG90cykgewogICAgICBpZiAoc2xvdHNbbmFtZSQxXS5ldmVyeShpc1doaXRlc3BhY2UpKSB7CiAgICAgICAgZGVsZXRlIHNsb3RzW25hbWUkMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzbG90cwogIH0KCiAgZnVuY3Rpb24gaXNXaGl0ZXNwYWNlIChub2RlKSB7CiAgICByZXR1cm4gKG5vZGUuaXNDb21tZW50ICYmICFub2RlLmFzeW5jRmFjdG9yeSkgfHwgbm9kZS50ZXh0ID09PSAnICcKICB9CgogIGZ1bmN0aW9uIHJlc29sdmVTY29wZWRTbG90cyAoCiAgICBmbnMsIC8vIHNlZSBmbG93L3Zub2RlCiAgICByZXMKICApIHsKICAgIHJlcyA9IHJlcyB8fCB7fTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGZuc1tpXSkpIHsKICAgICAgICByZXNvbHZlU2NvcGVkU2xvdHMoZm5zW2ldLCByZXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc1tmbnNbaV0ua2V5XSA9IGZuc1tpXS5mbjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgLyogICovCgogIHZhciBhY3RpdmVJbnN0YW5jZSA9IG51bGw7CiAgdmFyIGlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCA9IGZhbHNlOwoKICBmdW5jdGlvbiBzZXRBY3RpdmVJbnN0YW5jZSh2bSkgewogICAgdmFyIHByZXZBY3RpdmVJbnN0YW5jZSA9IGFjdGl2ZUluc3RhbmNlOwogICAgYWN0aXZlSW5zdGFuY2UgPSB2bTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGFjdGl2ZUluc3RhbmNlID0gcHJldkFjdGl2ZUluc3RhbmNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5pdExpZmVjeWNsZSAodm0pIHsKICAgIHZhciBvcHRpb25zID0gdm0uJG9wdGlvbnM7CgogICAgLy8gbG9jYXRlIGZpcnN0IG5vbi1hYnN0cmFjdCBwYXJlbnQKICAgIHZhciBwYXJlbnQgPSBvcHRpb25zLnBhcmVudDsKICAgIGlmIChwYXJlbnQgJiYgIW9wdGlvbnMuYWJzdHJhY3QpIHsKICAgICAgd2hpbGUgKHBhcmVudC4kb3B0aW9ucy5hYnN0cmFjdCAmJiBwYXJlbnQuJHBhcmVudCkgewogICAgICAgIHBhcmVudCA9IHBhcmVudC4kcGFyZW50OwogICAgICB9CiAgICAgIHBhcmVudC4kY2hpbGRyZW4ucHVzaCh2bSk7CiAgICB9CgogICAgdm0uJHBhcmVudCA9IHBhcmVudDsKICAgIHZtLiRyb290ID0gcGFyZW50ID8gcGFyZW50LiRyb290IDogdm07CgogICAgdm0uJGNoaWxkcmVuID0gW107CiAgICB2bS4kcmVmcyA9IHt9OwoKICAgIHZtLl93YXRjaGVyID0gbnVsbDsKICAgIHZtLl9pbmFjdGl2ZSA9IG51bGw7CiAgICB2bS5fZGlyZWN0SW5hY3RpdmUgPSBmYWxzZTsKICAgIHZtLl9pc01vdW50ZWQgPSBmYWxzZTsKICAgIHZtLl9pc0Rlc3Ryb3llZCA9IGZhbHNlOwogICAgdm0uX2lzQmVpbmdEZXN0cm95ZWQgPSBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGxpZmVjeWNsZU1peGluIChWdWUpIHsKICAgIFZ1ZS5wcm90b3R5cGUuX3VwZGF0ZSA9IGZ1bmN0aW9uICh2bm9kZSwgaHlkcmF0aW5nKSB7CiAgICAgIHZhciB2bSA9IHRoaXM7CiAgICAgIHZhciBwcmV2RWwgPSB2bS4kZWw7CiAgICAgIHZhciBwcmV2Vm5vZGUgPSB2bS5fdm5vZGU7CiAgICAgIHZhciByZXN0b3JlQWN0aXZlSW5zdGFuY2UgPSBzZXRBY3RpdmVJbnN0YW5jZSh2bSk7CiAgICAgIHZtLl92bm9kZSA9IHZub2RlOwogICAgICAvLyBWdWUucHJvdG90eXBlLl9fcGF0Y2hfXyBpcyBpbmplY3RlZCBpbiBlbnRyeSBwb2ludHMKICAgICAgLy8gYmFzZWQgb24gdGhlIHJlbmRlcmluZyBiYWNrZW5kIHVzZWQuCiAgICAgIGlmICghcHJldlZub2RlKSB7CiAgICAgICAgLy8gaW5pdGlhbCByZW5kZXIKICAgICAgICB2bS4kZWwgPSB2bS5fX3BhdGNoX18odm0uJGVsLCB2bm9kZSwgaHlkcmF0aW5nLCBmYWxzZSAvKiByZW1vdmVPbmx5ICovKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB1cGRhdGVzCiAgICAgICAgdm0uJGVsID0gdm0uX19wYXRjaF9fKHByZXZWbm9kZSwgdm5vZGUpOwogICAgICB9CiAgICAgIHJlc3RvcmVBY3RpdmVJbnN0YW5jZSgpOwogICAgICAvLyB1cGRhdGUgX192dWVfXyByZWZlcmVuY2UKICAgICAgaWYgKHByZXZFbCkgewogICAgICAgIHByZXZFbC5fX3Z1ZV9fID0gbnVsbDsKICAgICAgfQogICAgICBpZiAodm0uJGVsKSB7CiAgICAgICAgdm0uJGVsLl9fdnVlX18gPSB2bTsKICAgICAgfQogICAgICAvLyBpZiBwYXJlbnQgaXMgYW4gSE9DLCB1cGRhdGUgaXRzICRlbCBhcyB3ZWxsCiAgICAgIGlmICh2bS4kdm5vZGUgJiYgdm0uJHBhcmVudCAmJiB2bS4kdm5vZGUgPT09IHZtLiRwYXJlbnQuX3Zub2RlKSB7CiAgICAgICAgdm0uJHBhcmVudC4kZWwgPSB2bS4kZWw7CiAgICAgIH0KICAgICAgLy8gdXBkYXRlZCBob29rIGlzIGNhbGxlZCBieSB0aGUgc2NoZWR1bGVyIHRvIGVuc3VyZSB0aGF0IGNoaWxkcmVuIGFyZQogICAgICAvLyB1cGRhdGVkIGluIGEgcGFyZW50J3MgdXBkYXRlZCBob29rLgogICAgfTsKCiAgICBWdWUucHJvdG90eXBlLiRmb3JjZVVwZGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgaWYgKHZtLl93YXRjaGVyKSB7CiAgICAgICAgdm0uX3dhdGNoZXIudXBkYXRlKCk7CiAgICAgIH0KICAgIH07CgogICAgVnVlLnByb3RvdHlwZS4kZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgaWYgKHZtLl9pc0JlaW5nRGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgY2FsbEhvb2sodm0sICdiZWZvcmVEZXN0cm95Jyk7CiAgICAgIHZtLl9pc0JlaW5nRGVzdHJveWVkID0gdHJ1ZTsKICAgICAgLy8gcmVtb3ZlIHNlbGYgZnJvbSBwYXJlbnQKICAgICAgdmFyIHBhcmVudCA9IHZtLiRwYXJlbnQ7CiAgICAgIGlmIChwYXJlbnQgJiYgIXBhcmVudC5faXNCZWluZ0Rlc3Ryb3llZCAmJiAhdm0uJG9wdGlvbnMuYWJzdHJhY3QpIHsKICAgICAgICByZW1vdmUocGFyZW50LiRjaGlsZHJlbiwgdm0pOwogICAgICB9CiAgICAgIC8vIHRlYXJkb3duIHdhdGNoZXJzCiAgICAgIGlmICh2bS5fd2F0Y2hlcikgewogICAgICAgIHZtLl93YXRjaGVyLnRlYXJkb3duKCk7CiAgICAgIH0KICAgICAgdmFyIGkgPSB2bS5fd2F0Y2hlcnMubGVuZ3RoOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgdm0uX3dhdGNoZXJzW2ldLnRlYXJkb3duKCk7CiAgICAgIH0KICAgICAgLy8gcmVtb3ZlIHJlZmVyZW5jZSBmcm9tIGRhdGEgb2IKICAgICAgLy8gZnJvemVuIG9iamVjdCBtYXkgbm90IGhhdmUgb2JzZXJ2ZXIuCiAgICAgIGlmICh2bS5fZGF0YS5fX29iX18pIHsKICAgICAgICB2bS5fZGF0YS5fX29iX18udm1Db3VudC0tOwogICAgICB9CiAgICAgIC8vIGNhbGwgdGhlIGxhc3QgaG9vay4uLgogICAgICB2bS5faXNEZXN0cm95ZWQgPSB0cnVlOwogICAgICAvLyBpbnZva2UgZGVzdHJveSBob29rcyBvbiBjdXJyZW50IHJlbmRlcmVkIHRyZWUKICAgICAgdm0uX19wYXRjaF9fKHZtLl92bm9kZSwgbnVsbCk7CiAgICAgIC8vIGZpcmUgZGVzdHJveWVkIGhvb2sKICAgICAgY2FsbEhvb2sodm0sICdkZXN0cm95ZWQnKTsKICAgICAgLy8gdHVybiBvZmYgYWxsIGluc3RhbmNlIGxpc3RlbmVycy4KICAgICAgdm0uJG9mZigpOwogICAgICAvLyByZW1vdmUgX192dWVfXyByZWZlcmVuY2UKICAgICAgaWYgKHZtLiRlbCkgewogICAgICAgIHZtLiRlbC5fX3Z1ZV9fID0gbnVsbDsKICAgICAgfQogICAgICAvLyByZWxlYXNlIGNpcmN1bGFyIHJlZmVyZW5jZSAoIzY3NTkpCiAgICAgIGlmICh2bS4kdm5vZGUpIHsKICAgICAgICB2bS4kdm5vZGUucGFyZW50ID0gbnVsbDsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIG1vdW50Q29tcG9uZW50ICgKICAgIHZtLAogICAgZWwsCiAgICBoeWRyYXRpbmcKICApIHsKICAgIHZtLiRlbCA9IGVsOwogICAgaWYgKCF2bS4kb3B0aW9ucy5yZW5kZXIpIHsKICAgICAgdm0uJG9wdGlvbnMucmVuZGVyID0gY3JlYXRlRW1wdHlWTm9kZTsKICAgICAgewogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgIGlmICgodm0uJG9wdGlvbnMudGVtcGxhdGUgJiYgdm0uJG9wdGlvbnMudGVtcGxhdGUuY2hhckF0KDApICE9PSAnIycpIHx8CiAgICAgICAgICB2bS4kb3B0aW9ucy5lbCB8fCBlbCkgewogICAgICAgICAgd2FybigKICAgICAgICAgICAgJ1lvdSBhcmUgdXNpbmcgdGhlIHJ1bnRpbWUtb25seSBidWlsZCBvZiBWdWUgd2hlcmUgdGhlIHRlbXBsYXRlICcgKwogICAgICAgICAgICAnY29tcGlsZXIgaXMgbm90IGF2YWlsYWJsZS4gRWl0aGVyIHByZS1jb21waWxlIHRoZSB0ZW1wbGF0ZXMgaW50byAnICsKICAgICAgICAgICAgJ3JlbmRlciBmdW5jdGlvbnMsIG9yIHVzZSB0aGUgY29tcGlsZXItaW5jbHVkZWQgYnVpbGQuJywKICAgICAgICAgICAgdm0KICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgICdGYWlsZWQgdG8gbW91bnQgY29tcG9uZW50OiB0ZW1wbGF0ZSBvciByZW5kZXIgZnVuY3Rpb24gbm90IGRlZmluZWQuJywKICAgICAgICAgICAgdm0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBjYWxsSG9vayh2bSwgJ2JlZm9yZU1vdW50Jyk7CgogICAgdmFyIHVwZGF0ZUNvbXBvbmVudDsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGNvbmZpZy5wZXJmb3JtYW5jZSAmJiBtYXJrKSB7CiAgICAgIHVwZGF0ZUNvbXBvbmVudCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmFtZSA9IHZtLl9uYW1lOwogICAgICAgIHZhciBpZCA9IHZtLl91aWQ7CiAgICAgICAgdmFyIHN0YXJ0VGFnID0gInZ1ZS1wZXJmLXN0YXJ0OiIgKyBpZDsKICAgICAgICB2YXIgZW5kVGFnID0gInZ1ZS1wZXJmLWVuZDoiICsgaWQ7CgogICAgICAgIG1hcmsoc3RhcnRUYWcpOwogICAgICAgIHZhciB2bm9kZSA9IHZtLl9yZW5kZXIoKTsKICAgICAgICBtYXJrKGVuZFRhZyk7CiAgICAgICAgbWVhc3VyZSgoInZ1ZSAiICsgbmFtZSArICIgcmVuZGVyIiksIHN0YXJ0VGFnLCBlbmRUYWcpOwoKICAgICAgICBtYXJrKHN0YXJ0VGFnKTsKICAgICAgICB2bS5fdXBkYXRlKHZub2RlLCBoeWRyYXRpbmcpOwogICAgICAgIG1hcmsoZW5kVGFnKTsKICAgICAgICBtZWFzdXJlKCgidnVlICIgKyBuYW1lICsgIiBwYXRjaCIpLCBzdGFydFRhZywgZW5kVGFnKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHVwZGF0ZUNvbXBvbmVudCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2bS5fdXBkYXRlKHZtLl9yZW5kZXIoKSwgaHlkcmF0aW5nKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyB3ZSBzZXQgdGhpcyB0byB2bS5fd2F0Y2hlciBpbnNpZGUgdGhlIHdhdGNoZXIncyBjb25zdHJ1Y3RvcgogICAgLy8gc2luY2UgdGhlIHdhdGNoZXIncyBpbml0aWFsIHBhdGNoIG1heSBjYWxsICRmb3JjZVVwZGF0ZSAoZS5nLiBpbnNpZGUgY2hpbGQKICAgIC8vIGNvbXBvbmVudCdzIG1vdW50ZWQgaG9vayksIHdoaWNoIHJlbGllcyBvbiB2bS5fd2F0Y2hlciBiZWluZyBhbHJlYWR5IGRlZmluZWQKICAgIG5ldyBXYXRjaGVyKHZtLCB1cGRhdGVDb21wb25lbnQsIG5vb3AsIHsKICAgICAgYmVmb3JlOiBmdW5jdGlvbiBiZWZvcmUgKCkgewogICAgICAgIGlmICh2bS5faXNNb3VudGVkICYmICF2bS5faXNEZXN0cm95ZWQpIHsKICAgICAgICAgIGNhbGxIb29rKHZtLCAnYmVmb3JlVXBkYXRlJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB0cnVlIC8qIGlzUmVuZGVyV2F0Y2hlciAqLyk7CiAgICBoeWRyYXRpbmcgPSBmYWxzZTsKCiAgICAvLyBtYW51YWxseSBtb3VudGVkIGluc3RhbmNlLCBjYWxsIG1vdW50ZWQgb24gc2VsZgogICAgLy8gbW91bnRlZCBpcyBjYWxsZWQgZm9yIHJlbmRlci1jcmVhdGVkIGNoaWxkIGNvbXBvbmVudHMgaW4gaXRzIGluc2VydGVkIGhvb2sKICAgIGlmICh2bS4kdm5vZGUgPT0gbnVsbCkgewogICAgICB2bS5faXNNb3VudGVkID0gdHJ1ZTsKICAgICAgY2FsbEhvb2sodm0sICdtb3VudGVkJyk7CiAgICB9CiAgICByZXR1cm4gdm0KICB9CgogIGZ1bmN0aW9uIHVwZGF0ZUNoaWxkQ29tcG9uZW50ICgKICAgIHZtLAogICAgcHJvcHNEYXRhLAogICAgbGlzdGVuZXJzLAogICAgcGFyZW50Vm5vZGUsCiAgICByZW5kZXJDaGlsZHJlbgogICkgewogICAgewogICAgICBpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgPSB0cnVlOwogICAgfQoKICAgIC8vIGRldGVybWluZSB3aGV0aGVyIGNvbXBvbmVudCBoYXMgc2xvdCBjaGlsZHJlbgogICAgLy8gd2UgbmVlZCB0byBkbyB0aGlzIGJlZm9yZSBvdmVyd3JpdGluZyAkb3B0aW9ucy5fcmVuZGVyQ2hpbGRyZW4KICAgIHZhciBoYXNDaGlsZHJlbiA9ICEhKAogICAgICByZW5kZXJDaGlsZHJlbiB8fCAgICAgICAgICAgICAgIC8vIGhhcyBuZXcgc3RhdGljIHNsb3RzCiAgICAgIHZtLiRvcHRpb25zLl9yZW5kZXJDaGlsZHJlbiB8fCAgLy8gaGFzIG9sZCBzdGF0aWMgc2xvdHMKICAgICAgcGFyZW50Vm5vZGUuZGF0YS5zY29wZWRTbG90cyB8fCAvLyBoYXMgbmV3IHNjb3BlZCBzbG90cwogICAgICB2bS4kc2NvcGVkU2xvdHMgIT09IGVtcHR5T2JqZWN0IC8vIGhhcyBvbGQgc2NvcGVkIHNsb3RzCiAgICApOwoKICAgIHZtLiRvcHRpb25zLl9wYXJlbnRWbm9kZSA9IHBhcmVudFZub2RlOwogICAgdm0uJHZub2RlID0gcGFyZW50Vm5vZGU7IC8vIHVwZGF0ZSB2bSdzIHBsYWNlaG9sZGVyIG5vZGUgd2l0aG91dCByZS1yZW5kZXIKCiAgICBpZiAodm0uX3Zub2RlKSB7IC8vIHVwZGF0ZSBjaGlsZCB0cmVlJ3MgcGFyZW50CiAgICAgIHZtLl92bm9kZS5wYXJlbnQgPSBwYXJlbnRWbm9kZTsKICAgIH0KICAgIHZtLiRvcHRpb25zLl9yZW5kZXJDaGlsZHJlbiA9IHJlbmRlckNoaWxkcmVuOwoKICAgIC8vIHVwZGF0ZSAkYXR0cnMgYW5kICRsaXN0ZW5lcnMgaGFzaAogICAgLy8gdGhlc2UgYXJlIGFsc28gcmVhY3RpdmUgc28gdGhleSBtYXkgdHJpZ2dlciBjaGlsZCB1cGRhdGUgaWYgdGhlIGNoaWxkCiAgICAvLyB1c2VkIHRoZW0gZHVyaW5nIHJlbmRlcgogICAgdm0uJGF0dHJzID0gcGFyZW50Vm5vZGUuZGF0YS5hdHRycyB8fCBlbXB0eU9iamVjdDsKICAgIHZtLiRsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMgfHwgZW1wdHlPYmplY3Q7CgogICAgLy8gdXBkYXRlIHByb3BzCiAgICBpZiAocHJvcHNEYXRhICYmIHZtLiRvcHRpb25zLnByb3BzKSB7CiAgICAgIHRvZ2dsZU9ic2VydmluZyhmYWxzZSk7CiAgICAgIHZhciBwcm9wcyA9IHZtLl9wcm9wczsKICAgICAgdmFyIHByb3BLZXlzID0gdm0uJG9wdGlvbnMuX3Byb3BLZXlzIHx8IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGtleSA9IHByb3BLZXlzW2ldOwogICAgICAgIHZhciBwcm9wT3B0aW9ucyA9IHZtLiRvcHRpb25zLnByb3BzOyAvLyB3dGYgZmxvdz8KICAgICAgICBwcm9wc1trZXldID0gdmFsaWRhdGVQcm9wKGtleSwgcHJvcE9wdGlvbnMsIHByb3BzRGF0YSwgdm0pOwogICAgICB9CiAgICAgIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsKICAgICAgLy8ga2VlcCBhIGNvcHkgb2YgcmF3IHByb3BzRGF0YQogICAgICB2bS4kb3B0aW9ucy5wcm9wc0RhdGEgPSBwcm9wc0RhdGE7CiAgICB9CgogICAgLy8gdXBkYXRlIGxpc3RlbmVycwogICAgbGlzdGVuZXJzID0gbGlzdGVuZXJzIHx8IGVtcHR5T2JqZWN0OwogICAgdmFyIG9sZExpc3RlbmVycyA9IHZtLiRvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnM7CiAgICB2bS4kb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzID0gbGlzdGVuZXJzOwogICAgdXBkYXRlQ29tcG9uZW50TGlzdGVuZXJzKHZtLCBsaXN0ZW5lcnMsIG9sZExpc3RlbmVycyk7CgogICAgLy8gcmVzb2x2ZSBzbG90cyArIGZvcmNlIHVwZGF0ZSBpZiBoYXMgY2hpbGRyZW4KICAgIGlmIChoYXNDaGlsZHJlbikgewogICAgICB2bS4kc2xvdHMgPSByZXNvbHZlU2xvdHMocmVuZGVyQ2hpbGRyZW4sIHBhcmVudFZub2RlLmNvbnRleHQpOwogICAgICB2bS4kZm9yY2VVcGRhdGUoKTsKICAgIH0KCiAgICB7CiAgICAgIGlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCA9IGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaXNJbkluYWN0aXZlVHJlZSAodm0pIHsKICAgIHdoaWxlICh2bSAmJiAodm0gPSB2bS4kcGFyZW50KSkgewogICAgICBpZiAodm0uX2luYWN0aXZlKSB7IHJldHVybiB0cnVlIH0KICAgIH0KICAgIHJldHVybiBmYWxzZQogIH0KCiAgZnVuY3Rpb24gYWN0aXZhdGVDaGlsZENvbXBvbmVudCAodm0sIGRpcmVjdCkgewogICAgaWYgKGRpcmVjdCkgewogICAgICB2bS5fZGlyZWN0SW5hY3RpdmUgPSBmYWxzZTsKICAgICAgaWYgKGlzSW5JbmFjdGl2ZVRyZWUodm0pKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0gZWxzZSBpZiAodm0uX2RpcmVjdEluYWN0aXZlKSB7CiAgICAgIHJldHVybgogICAgfQogICAgaWYgKHZtLl9pbmFjdGl2ZSB8fCB2bS5faW5hY3RpdmUgPT09IG51bGwpIHsKICAgICAgdm0uX2luYWN0aXZlID0gZmFsc2U7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdm0uJGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYWN0aXZhdGVDaGlsZENvbXBvbmVudCh2bS4kY2hpbGRyZW5baV0pOwogICAgICB9CiAgICAgIGNhbGxIb29rKHZtLCAnYWN0aXZhdGVkJyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZWFjdGl2YXRlQ2hpbGRDb21wb25lbnQgKHZtLCBkaXJlY3QpIHsKICAgIGlmIChkaXJlY3QpIHsKICAgICAgdm0uX2RpcmVjdEluYWN0aXZlID0gdHJ1ZTsKICAgICAgaWYgKGlzSW5JbmFjdGl2ZVRyZWUodm0pKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgIH0KICAgIGlmICghdm0uX2luYWN0aXZlKSB7CiAgICAgIHZtLl9pbmFjdGl2ZSA9IHRydWU7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdm0uJGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZGVhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLiRjaGlsZHJlbltpXSk7CiAgICAgIH0KICAgICAgY2FsbEhvb2sodm0sICdkZWFjdGl2YXRlZCcpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2FsbEhvb2sgKHZtLCBob29rKSB7CiAgICAvLyAjNzU3MyBkaXNhYmxlIGRlcCBjb2xsZWN0aW9uIHdoZW4gaW52b2tpbmcgbGlmZWN5Y2xlIGhvb2tzCiAgICBwdXNoVGFyZ2V0KCk7CiAgICB2YXIgaGFuZGxlcnMgPSB2bS4kb3B0aW9uc1tob29rXTsKICAgIGlmIChoYW5kbGVycykgewogICAgICBmb3IgKHZhciBpID0gMCwgaiA9IGhhbmRsZXJzLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgIHRyeSB7CiAgICAgICAgICBoYW5kbGVyc1tpXS5jYWxsKHZtKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBoYW5kbGVFcnJvcihlLCB2bSwgKGhvb2sgKyAiIGhvb2siKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAodm0uX2hhc0hvb2tFdmVudCkgewogICAgICB2bS4kZW1pdCgnaG9vazonICsgaG9vayk7CiAgICB9CiAgICBwb3BUYXJnZXQoKTsKICB9CgogIC8qICAqLwoKICB2YXIgTUFYX1VQREFURV9DT1VOVCA9IDEwMDsKCiAgdmFyIHF1ZXVlID0gW107CiAgdmFyIGFjdGl2YXRlZENoaWxkcmVuID0gW107CiAgdmFyIGhhcyA9IHt9OwogIHZhciBjaXJjdWxhciA9IHt9OwogIHZhciB3YWl0aW5nID0gZmFsc2U7CiAgdmFyIGZsdXNoaW5nID0gZmFsc2U7CiAgdmFyIGluZGV4ID0gMDsKCiAgLyoqCiAgICogUmVzZXQgdGhlIHNjaGVkdWxlcidzIHN0YXRlLgogICAqLwogIGZ1bmN0aW9uIHJlc2V0U2NoZWR1bGVyU3RhdGUgKCkgewogICAgaW5kZXggPSBxdWV1ZS5sZW5ndGggPSBhY3RpdmF0ZWRDaGlsZHJlbi5sZW5ndGggPSAwOwogICAgaGFzID0ge307CiAgICB7CiAgICAgIGNpcmN1bGFyID0ge307CiAgICB9CiAgICB3YWl0aW5nID0gZmx1c2hpbmcgPSBmYWxzZTsKICB9CgogIC8qKgogICAqIEZsdXNoIGJvdGggcXVldWVzIGFuZCBydW4gdGhlIHdhdGNoZXJzLgogICAqLwogIGZ1bmN0aW9uIGZsdXNoU2NoZWR1bGVyUXVldWUgKCkgewogICAgZmx1c2hpbmcgPSB0cnVlOwogICAgdmFyIHdhdGNoZXIsIGlkOwoKICAgIC8vIFNvcnQgcXVldWUgYmVmb3JlIGZsdXNoLgogICAgLy8gVGhpcyBlbnN1cmVzIHRoYXQ6CiAgICAvLyAxLiBDb21wb25lbnRzIGFyZSB1cGRhdGVkIGZyb20gcGFyZW50IHRvIGNoaWxkLiAoYmVjYXVzZSBwYXJlbnQgaXMgYWx3YXlzCiAgICAvLyAgICBjcmVhdGVkIGJlZm9yZSB0aGUgY2hpbGQpCiAgICAvLyAyLiBBIGNvbXBvbmVudCdzIHVzZXIgd2F0Y2hlcnMgYXJlIHJ1biBiZWZvcmUgaXRzIHJlbmRlciB3YXRjaGVyIChiZWNhdXNlCiAgICAvLyAgICB1c2VyIHdhdGNoZXJzIGFyZSBjcmVhdGVkIGJlZm9yZSB0aGUgcmVuZGVyIHdhdGNoZXIpCiAgICAvLyAzLiBJZiBhIGNvbXBvbmVudCBpcyBkZXN0cm95ZWQgZHVyaW5nIGEgcGFyZW50IGNvbXBvbmVudCdzIHdhdGNoZXIgcnVuLAogICAgLy8gICAgaXRzIHdhdGNoZXJzIGNhbiBiZSBza2lwcGVkLgogICAgcXVldWUuc29ydChmdW5jdGlvbiAoYSwgYikgeyByZXR1cm4gYS5pZCAtIGIuaWQ7IH0pOwoKICAgIC8vIGRvIG5vdCBjYWNoZSBsZW5ndGggYmVjYXVzZSBtb3JlIHdhdGNoZXJzIG1pZ2h0IGJlIHB1c2hlZAogICAgLy8gYXMgd2UgcnVuIGV4aXN0aW5nIHdhdGNoZXJzCiAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBxdWV1ZS5sZW5ndGg7IGluZGV4KyspIHsKICAgICAgd2F0Y2hlciA9IHF1ZXVlW2luZGV4XTsKICAgICAgaWYgKHdhdGNoZXIuYmVmb3JlKSB7CiAgICAgICAgd2F0Y2hlci5iZWZvcmUoKTsKICAgICAgfQogICAgICBpZCA9IHdhdGNoZXIuaWQ7CiAgICAgIGhhc1tpZF0gPSBudWxsOwogICAgICB3YXRjaGVyLnJ1bigpOwogICAgICAvLyBpbiBkZXYgYnVpbGQsIGNoZWNrIGFuZCBzdG9wIGNpcmN1bGFyIHVwZGF0ZXMuCiAgICAgIGlmIChoYXNbaWRdICE9IG51bGwpIHsKICAgICAgICBjaXJjdWxhcltpZF0gPSAoY2lyY3VsYXJbaWRdIHx8IDApICsgMTsKICAgICAgICBpZiAoY2lyY3VsYXJbaWRdID4gTUFYX1VQREFURV9DT1VOVCkgewogICAgICAgICAgd2FybigKICAgICAgICAgICAgJ1lvdSBtYXkgaGF2ZSBhbiBpbmZpbml0ZSB1cGRhdGUgbG9vcCAnICsgKAogICAgICAgICAgICAgIHdhdGNoZXIudXNlcgogICAgICAgICAgICAgICAgPyAoImluIHdhdGNoZXIgd2l0aCBleHByZXNzaW9uIFwiIiArICh3YXRjaGVyLmV4cHJlc3Npb24pICsgIlwiIikKICAgICAgICAgICAgICAgIDogImluIGEgY29tcG9uZW50IHJlbmRlciBmdW5jdGlvbi4iCiAgICAgICAgICAgICksCiAgICAgICAgICAgIHdhdGNoZXIudm0KICAgICAgICAgICk7CiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIGtlZXAgY29waWVzIG9mIHBvc3QgcXVldWVzIGJlZm9yZSByZXNldHRpbmcgc3RhdGUKICAgIHZhciBhY3RpdmF0ZWRRdWV1ZSA9IGFjdGl2YXRlZENoaWxkcmVuLnNsaWNlKCk7CiAgICB2YXIgdXBkYXRlZFF1ZXVlID0gcXVldWUuc2xpY2UoKTsKCiAgICByZXNldFNjaGVkdWxlclN0YXRlKCk7CgogICAgLy8gY2FsbCBjb21wb25lbnQgdXBkYXRlZCBhbmQgYWN0aXZhdGVkIGhvb2tzCiAgICBjYWxsQWN0aXZhdGVkSG9va3MoYWN0aXZhdGVkUXVldWUpOwogICAgY2FsbFVwZGF0ZWRIb29rcyh1cGRhdGVkUXVldWUpOwoKICAgIC8vIGRldnRvb2wgaG9vawogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoZGV2dG9vbHMgJiYgY29uZmlnLmRldnRvb2xzKSB7CiAgICAgIGRldnRvb2xzLmVtaXQoJ2ZsdXNoJyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjYWxsVXBkYXRlZEhvb2tzIChxdWV1ZSkgewogICAgdmFyIGkgPSBxdWV1ZS5sZW5ndGg7CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHZhciB3YXRjaGVyID0gcXVldWVbaV07CiAgICAgIHZhciB2bSA9IHdhdGNoZXIudm07CiAgICAgIGlmICh2bS5fd2F0Y2hlciA9PT0gd2F0Y2hlciAmJiB2bS5faXNNb3VudGVkICYmICF2bS5faXNEZXN0cm95ZWQpIHsKICAgICAgICBjYWxsSG9vayh2bSwgJ3VwZGF0ZWQnKTsKICAgICAgfQogICAgfQogIH0KCiAgLyoqCiAgICogUXVldWUgYSBrZXB0LWFsaXZlIGNvbXBvbmVudCB0aGF0IHdhcyBhY3RpdmF0ZWQgZHVyaW5nIHBhdGNoLgogICAqIFRoZSBxdWV1ZSB3aWxsIGJlIHByb2Nlc3NlZCBhZnRlciB0aGUgZW50aXJlIHRyZWUgaGFzIGJlZW4gcGF0Y2hlZC4KICAgKi8KICBmdW5jdGlvbiBxdWV1ZUFjdGl2YXRlZENvbXBvbmVudCAodm0pIHsKICAgIC8vIHNldHRpbmcgX2luYWN0aXZlIHRvIGZhbHNlIGhlcmUgc28gdGhhdCBhIHJlbmRlciBmdW5jdGlvbiBjYW4KICAgIC8vIHJlbHkgb24gY2hlY2tpbmcgd2hldGhlciBpdCdzIGluIGFuIGluYWN0aXZlIHRyZWUgKGUuZy4gcm91dGVyLXZpZXcpCiAgICB2bS5faW5hY3RpdmUgPSBmYWxzZTsKICAgIGFjdGl2YXRlZENoaWxkcmVuLnB1c2godm0pOwogIH0KCiAgZnVuY3Rpb24gY2FsbEFjdGl2YXRlZEhvb2tzIChxdWV1ZSkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICBxdWV1ZVtpXS5faW5hY3RpdmUgPSB0cnVlOwogICAgICBhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHF1ZXVlW2ldLCB0cnVlIC8qIHRydWUgKi8pOwogICAgfQogIH0KCiAgLyoqCiAgICogUHVzaCBhIHdhdGNoZXIgaW50byB0aGUgd2F0Y2hlciBxdWV1ZS4KICAgKiBKb2JzIHdpdGggZHVwbGljYXRlIElEcyB3aWxsIGJlIHNraXBwZWQgdW5sZXNzIGl0J3MKICAgKiBwdXNoZWQgd2hlbiB0aGUgcXVldWUgaXMgYmVpbmcgZmx1c2hlZC4KICAgKi8KICBmdW5jdGlvbiBxdWV1ZVdhdGNoZXIgKHdhdGNoZXIpIHsKICAgIHZhciBpZCA9IHdhdGNoZXIuaWQ7CiAgICBpZiAoaGFzW2lkXSA9PSBudWxsKSB7CiAgICAgIGhhc1tpZF0gPSB0cnVlOwogICAgICBpZiAoIWZsdXNoaW5nKSB7CiAgICAgICAgcXVldWUucHVzaCh3YXRjaGVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBpZiBhbHJlYWR5IGZsdXNoaW5nLCBzcGxpY2UgdGhlIHdhdGNoZXIgYmFzZWQgb24gaXRzIGlkCiAgICAgICAgLy8gaWYgYWxyZWFkeSBwYXN0IGl0cyBpZCwgaXQgd2lsbCBiZSBydW4gbmV4dCBpbW1lZGlhdGVseS4KICAgICAgICB2YXIgaSA9IHF1ZXVlLmxlbmd0aCAtIDE7CiAgICAgICAgd2hpbGUgKGkgPiBpbmRleCAmJiBxdWV1ZVtpXS5pZCA+IHdhdGNoZXIuaWQpIHsKICAgICAgICAgIGktLTsKICAgICAgICB9CiAgICAgICAgcXVldWUuc3BsaWNlKGkgKyAxLCAwLCB3YXRjaGVyKTsKICAgICAgfQogICAgICAvLyBxdWV1ZSB0aGUgZmx1c2gKICAgICAgaWYgKCF3YWl0aW5nKSB7CiAgICAgICAgd2FpdGluZyA9IHRydWU7CgogICAgICAgIGlmICghY29uZmlnLmFzeW5jKSB7CiAgICAgICAgICBmbHVzaFNjaGVkdWxlclF1ZXVlKCk7CiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgbmV4dFRpY2soZmx1c2hTY2hlZHVsZXJRdWV1ZSk7CiAgICAgIH0KICAgIH0KICB9CgogIC8qICAqLwoKCgogIHZhciB1aWQkMSA9IDA7CgogIC8qKgogICAqIEEgd2F0Y2hlciBwYXJzZXMgYW4gZXhwcmVzc2lvbiwgY29sbGVjdHMgZGVwZW5kZW5jaWVzLAogICAqIGFuZCBmaXJlcyBjYWxsYmFjayB3aGVuIHRoZSBleHByZXNzaW9uIHZhbHVlIGNoYW5nZXMuCiAgICogVGhpcyBpcyB1c2VkIGZvciBib3RoIHRoZSAkd2F0Y2goKSBhcGkgYW5kIGRpcmVjdGl2ZXMuCiAgICovCiAgdmFyIFdhdGNoZXIgPSBmdW5jdGlvbiBXYXRjaGVyICgKICAgIHZtLAogICAgZXhwT3JGbiwKICAgIGNiLAogICAgb3B0aW9ucywKICAgIGlzUmVuZGVyV2F0Y2hlcgogICkgewogICAgdGhpcy52bSA9IHZtOwogICAgaWYgKGlzUmVuZGVyV2F0Y2hlcikgewogICAgICB2bS5fd2F0Y2hlciA9IHRoaXM7CiAgICB9CiAgICB2bS5fd2F0Y2hlcnMucHVzaCh0aGlzKTsKICAgIC8vIG9wdGlvbnMKICAgIGlmIChvcHRpb25zKSB7CiAgICAgIHRoaXMuZGVlcCA9ICEhb3B0aW9ucy5kZWVwOwogICAgICB0aGlzLnVzZXIgPSAhIW9wdGlvbnMudXNlcjsKICAgICAgdGhpcy5sYXp5ID0gISFvcHRpb25zLmxhenk7CiAgICAgIHRoaXMuc3luYyA9ICEhb3B0aW9ucy5zeW5jOwogICAgICB0aGlzLmJlZm9yZSA9IG9wdGlvbnMuYmVmb3JlOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5kZWVwID0gdGhpcy51c2VyID0gdGhpcy5sYXp5ID0gdGhpcy5zeW5jID0gZmFsc2U7CiAgICB9CiAgICB0aGlzLmNiID0gY2I7CiAgICB0aGlzLmlkID0gKyt1aWQkMTsgLy8gdWlkIGZvciBiYXRjaGluZwogICAgdGhpcy5hY3RpdmUgPSB0cnVlOwogICAgdGhpcy5kaXJ0eSA9IHRoaXMubGF6eTsgLy8gZm9yIGxhenkgd2F0Y2hlcnMKICAgIHRoaXMuZGVwcyA9IFtdOwogICAgdGhpcy5uZXdEZXBzID0gW107CiAgICB0aGlzLmRlcElkcyA9IG5ldyBfU2V0KCk7CiAgICB0aGlzLm5ld0RlcElkcyA9IG5ldyBfU2V0KCk7CiAgICB0aGlzLmV4cHJlc3Npb24gPSBleHBPckZuLnRvU3RyaW5nKCk7CiAgICAvLyBwYXJzZSBleHByZXNzaW9uIGZvciBnZXR0ZXIKICAgIGlmICh0eXBlb2YgZXhwT3JGbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB0aGlzLmdldHRlciA9IGV4cE9yRm47CiAgICB9IGVsc2UgewogICAgICB0aGlzLmdldHRlciA9IHBhcnNlUGF0aChleHBPckZuKTsKICAgICAgaWYgKCF0aGlzLmdldHRlcikgewogICAgICAgIHRoaXMuZ2V0dGVyID0gbm9vcDsKICAgICAgICB3YXJuKAogICAgICAgICAgIkZhaWxlZCB3YXRjaGluZyBwYXRoOiBcIiIgKyBleHBPckZuICsgIlwiICIgKwogICAgICAgICAgJ1dhdGNoZXIgb25seSBhY2NlcHRzIHNpbXBsZSBkb3QtZGVsaW1pdGVkIHBhdGhzLiAnICsKICAgICAgICAgICdGb3IgZnVsbCBjb250cm9sLCB1c2UgYSBmdW5jdGlvbiBpbnN0ZWFkLicsCiAgICAgICAgICB2bQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMudmFsdWUgPSB0aGlzLmxhenkKICAgICAgPyB1bmRlZmluZWQKICAgICAgOiB0aGlzLmdldCgpOwogIH07CgogIC8qKgogICAqIEV2YWx1YXRlIHRoZSBnZXR0ZXIsIGFuZCByZS1jb2xsZWN0IGRlcGVuZGVuY2llcy4KICAgKi8KICBXYXRjaGVyLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiBnZXQgKCkgewogICAgcHVzaFRhcmdldCh0aGlzKTsKICAgIHZhciB2YWx1ZTsKICAgIHZhciB2bSA9IHRoaXMudm07CiAgICB0cnkgewogICAgICB2YWx1ZSA9IHRoaXMuZ2V0dGVyLmNhbGwodm0sIHZtKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaWYgKHRoaXMudXNlcikgewogICAgICAgIGhhbmRsZUVycm9yKGUsIHZtLCAoImdldHRlciBmb3Igd2F0Y2hlciBcIiIgKyAodGhpcy5leHByZXNzaW9uKSArICJcIiIpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBlCiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIC8vICJ0b3VjaCIgZXZlcnkgcHJvcGVydHkgc28gdGhleSBhcmUgYWxsIHRyYWNrZWQgYXMKICAgICAgLy8gZGVwZW5kZW5jaWVzIGZvciBkZWVwIHdhdGNoaW5nCiAgICAgIGlmICh0aGlzLmRlZXApIHsKICAgICAgICB0cmF2ZXJzZSh2YWx1ZSk7CiAgICAgIH0KICAgICAgcG9wVGFyZ2V0KCk7CiAgICAgIHRoaXMuY2xlYW51cERlcHMoKTsKICAgIH0KICAgIHJldHVybiB2YWx1ZQogIH07CgogIC8qKgogICAqIEFkZCBhIGRlcGVuZGVuY3kgdG8gdGhpcyBkaXJlY3RpdmUuCiAgICovCiAgV2F0Y2hlci5wcm90b3R5cGUuYWRkRGVwID0gZnVuY3Rpb24gYWRkRGVwIChkZXApIHsKICAgIHZhciBpZCA9IGRlcC5pZDsKICAgIGlmICghdGhpcy5uZXdEZXBJZHMuaGFzKGlkKSkgewogICAgICB0aGlzLm5ld0RlcElkcy5hZGQoaWQpOwogICAgICB0aGlzLm5ld0RlcHMucHVzaChkZXApOwogICAgICBpZiAoIXRoaXMuZGVwSWRzLmhhcyhpZCkpIHsKICAgICAgICBkZXAuYWRkU3ViKHRoaXMpOwogICAgICB9CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQ2xlYW4gdXAgZm9yIGRlcGVuZGVuY3kgY29sbGVjdGlvbi4KICAgKi8KICBXYXRjaGVyLnByb3RvdHlwZS5jbGVhbnVwRGVwcyA9IGZ1bmN0aW9uIGNsZWFudXBEZXBzICgpIHsKICAgIHZhciBpID0gdGhpcy5kZXBzLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdmFyIGRlcCA9IHRoaXMuZGVwc1tpXTsKICAgICAgaWYgKCF0aGlzLm5ld0RlcElkcy5oYXMoZGVwLmlkKSkgewogICAgICAgIGRlcC5yZW1vdmVTdWIodGhpcyk7CiAgICAgIH0KICAgIH0KICAgIHZhciB0bXAgPSB0aGlzLmRlcElkczsKICAgIHRoaXMuZGVwSWRzID0gdGhpcy5uZXdEZXBJZHM7CiAgICB0aGlzLm5ld0RlcElkcyA9IHRtcDsKICAgIHRoaXMubmV3RGVwSWRzLmNsZWFyKCk7CiAgICB0bXAgPSB0aGlzLmRlcHM7CiAgICB0aGlzLmRlcHMgPSB0aGlzLm5ld0RlcHM7CiAgICB0aGlzLm5ld0RlcHMgPSB0bXA7CiAgICB0aGlzLm5ld0RlcHMubGVuZ3RoID0gMDsKICB9OwoKICAvKioKICAgKiBTdWJzY3JpYmVyIGludGVyZmFjZS4KICAgKiBXaWxsIGJlIGNhbGxlZCB3aGVuIGEgZGVwZW5kZW5jeSBjaGFuZ2VzLgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIHVwZGF0ZSAoKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgaWYgKHRoaXMubGF6eSkgewogICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAodGhpcy5zeW5jKSB7CiAgICAgIHRoaXMucnVuKCk7CiAgICB9IGVsc2UgewogICAgICBxdWV1ZVdhdGNoZXIodGhpcyk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU2NoZWR1bGVyIGpvYiBpbnRlcmZhY2UuCiAgICogV2lsbCBiZSBjYWxsZWQgYnkgdGhlIHNjaGVkdWxlci4KICAgKi8KICBXYXRjaGVyLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiBydW4gKCkgewogICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0KCk7CiAgICAgIGlmICgKICAgICAgICB2YWx1ZSAhPT0gdGhpcy52YWx1ZSB8fAogICAgICAgIC8vIERlZXAgd2F0Y2hlcnMgYW5kIHdhdGNoZXJzIG9uIE9iamVjdC9BcnJheXMgc2hvdWxkIGZpcmUgZXZlbgogICAgICAgIC8vIHdoZW4gdGhlIHZhbHVlIGlzIHRoZSBzYW1lLCBiZWNhdXNlIHRoZSB2YWx1ZSBtYXkKICAgICAgICAvLyBoYXZlIG11dGF0ZWQuCiAgICAgICAgaXNPYmplY3QodmFsdWUpIHx8CiAgICAgICAgdGhpcy5kZWVwCiAgICAgICkgewogICAgICAgIC8vIHNldCBuZXcgdmFsdWUKICAgICAgICB2YXIgb2xkVmFsdWUgPSB0aGlzLnZhbHVlOwogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICBpZiAodGhpcy51c2VyKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLmNiLmNhbGwodGhpcy52bSwgdmFsdWUsIG9sZFZhbHVlKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaGFuZGxlRXJyb3IoZSwgdGhpcy52bSwgKCJjYWxsYmFjayBmb3Igd2F0Y2hlciBcIiIgKyAodGhpcy5leHByZXNzaW9uKSArICJcIiIpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5jYi5jYWxsKHRoaXMudm0sIHZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgLyoqCiAgICogRXZhbHVhdGUgdGhlIHZhbHVlIG9mIHRoZSB3YXRjaGVyLgogICAqIFRoaXMgb25seSBnZXRzIGNhbGxlZCBmb3IgbGF6eSB3YXRjaGVycy4KICAgKi8KICBXYXRjaGVyLnByb3RvdHlwZS5ldmFsdWF0ZSA9IGZ1bmN0aW9uIGV2YWx1YXRlICgpIHsKICAgIHRoaXMudmFsdWUgPSB0aGlzLmdldCgpOwogICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogIH07CgogIC8qKgogICAqIERlcGVuZCBvbiBhbGwgZGVwcyBjb2xsZWN0ZWQgYnkgdGhpcyB3YXRjaGVyLgogICAqLwogIFdhdGNoZXIucHJvdG90eXBlLmRlcGVuZCA9IGZ1bmN0aW9uIGRlcGVuZCAoKSB7CiAgICB2YXIgaSA9IHRoaXMuZGVwcy5sZW5ndGg7CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHRoaXMuZGVwc1tpXS5kZXBlbmQoKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBSZW1vdmUgc2VsZiBmcm9tIGFsbCBkZXBlbmRlbmNpZXMnIHN1YnNjcmliZXIgbGlzdC4KICAgKi8KICBXYXRjaGVyLnByb3RvdHlwZS50ZWFyZG93biA9IGZ1bmN0aW9uIHRlYXJkb3duICgpIHsKICAgIGlmICh0aGlzLmFjdGl2ZSkgewogICAgICAvLyByZW1vdmUgc2VsZiBmcm9tIHZtJ3Mgd2F0Y2hlciBsaXN0CiAgICAgIC8vIHRoaXMgaXMgYSBzb21ld2hhdCBleHBlbnNpdmUgb3BlcmF0aW9uIHNvIHdlIHNraXAgaXQKICAgICAgLy8gaWYgdGhlIHZtIGlzIGJlaW5nIGRlc3Ryb3llZC4KICAgICAgaWYgKCF0aGlzLnZtLl9pc0JlaW5nRGVzdHJveWVkKSB7CiAgICAgICAgcmVtb3ZlKHRoaXMudm0uX3dhdGNoZXJzLCB0aGlzKTsKICAgICAgfQogICAgICB2YXIgaSA9IHRoaXMuZGVwcy5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICB0aGlzLmRlcHNbaV0ucmVtb3ZlU3ViKHRoaXMpOwogICAgICB9CiAgICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CiAgICB9CiAgfTsKCiAgLyogICovCgogIHZhciBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24gPSB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBub29wLAogICAgc2V0OiBub29wCiAgfTsKCiAgZnVuY3Rpb24gcHJveHkgKHRhcmdldCwgc291cmNlS2V5LCBrZXkpIHsKICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5nZXQgPSBmdW5jdGlvbiBwcm94eUdldHRlciAoKSB7CiAgICAgIHJldHVybiB0aGlzW3NvdXJjZUtleV1ba2V5XQogICAgfTsKICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPSBmdW5jdGlvbiBwcm94eVNldHRlciAodmFsKSB7CiAgICAgIHRoaXNbc291cmNlS2V5XVtrZXldID0gdmFsOwogICAgfTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uKTsKICB9CgogIGZ1bmN0aW9uIGluaXRTdGF0ZSAodm0pIHsKICAgIHZtLl93YXRjaGVycyA9IFtdOwogICAgdmFyIG9wdHMgPSB2bS4kb3B0aW9uczsKICAgIGlmIChvcHRzLnByb3BzKSB7IGluaXRQcm9wcyh2bSwgb3B0cy5wcm9wcyk7IH0KICAgIGlmIChvcHRzLm1ldGhvZHMpIHsgaW5pdE1ldGhvZHModm0sIG9wdHMubWV0aG9kcyk7IH0KICAgIGlmIChvcHRzLmRhdGEpIHsKICAgICAgaW5pdERhdGEodm0pOwogICAgfSBlbHNlIHsKICAgICAgb2JzZXJ2ZSh2bS5fZGF0YSA9IHt9LCB0cnVlIC8qIGFzUm9vdERhdGEgKi8pOwogICAgfQogICAgaWYgKG9wdHMuY29tcHV0ZWQpIHsgaW5pdENvbXB1dGVkKHZtLCBvcHRzLmNvbXB1dGVkKTsgfQogICAgaWYgKG9wdHMud2F0Y2ggJiYgb3B0cy53YXRjaCAhPT0gbmF0aXZlV2F0Y2gpIHsKICAgICAgaW5pdFdhdGNoKHZtLCBvcHRzLndhdGNoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGluaXRQcm9wcyAodm0sIHByb3BzT3B0aW9ucykgewogICAgdmFyIHByb3BzRGF0YSA9IHZtLiRvcHRpb25zLnByb3BzRGF0YSB8fCB7fTsKICAgIHZhciBwcm9wcyA9IHZtLl9wcm9wcyA9IHt9OwogICAgLy8gY2FjaGUgcHJvcCBrZXlzIHNvIHRoYXQgZnV0dXJlIHByb3BzIHVwZGF0ZXMgY2FuIGl0ZXJhdGUgdXNpbmcgQXJyYXkKICAgIC8vIGluc3RlYWQgb2YgZHluYW1pYyBvYmplY3Qga2V5IGVudW1lcmF0aW9uLgogICAgdmFyIGtleXMgPSB2bS4kb3B0aW9ucy5fcHJvcEtleXMgPSBbXTsKICAgIHZhciBpc1Jvb3QgPSAhdm0uJHBhcmVudDsKICAgIC8vIHJvb3QgaW5zdGFuY2UgcHJvcHMgc2hvdWxkIGJlIGNvbnZlcnRlZAogICAgaWYgKCFpc1Jvb3QpIHsKICAgICAgdG9nZ2xlT2JzZXJ2aW5nKGZhbHNlKTsKICAgIH0KICAgIHZhciBsb29wID0gZnVuY3Rpb24gKCBrZXkgKSB7CiAgICAgIGtleXMucHVzaChrZXkpOwogICAgICB2YXIgdmFsdWUgPSB2YWxpZGF0ZVByb3Aoa2V5LCBwcm9wc09wdGlvbnMsIHByb3BzRGF0YSwgdm0pOwogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgICB7CiAgICAgICAgdmFyIGh5cGhlbmF0ZWRLZXkgPSBoeXBoZW5hdGUoa2V5KTsKICAgICAgICBpZiAoaXNSZXNlcnZlZEF0dHJpYnV0ZShoeXBoZW5hdGVkS2V5KSB8fAogICAgICAgICAgICBjb25maWcuaXNSZXNlcnZlZEF0dHIoaHlwaGVuYXRlZEtleSkpIHsKICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgICgiXCIiICsgaHlwaGVuYXRlZEtleSArICJcIiBpcyBhIHJlc2VydmVkIGF0dHJpYnV0ZSBhbmQgY2Fubm90IGJlIHVzZWQgYXMgY29tcG9uZW50IHByb3AuIiksCiAgICAgICAgICAgIHZtCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBkZWZpbmVSZWFjdGl2ZSQkMShwcm9wcywga2V5LCB2YWx1ZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCFpc1Jvb3QgJiYgIWlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCkgewogICAgICAgICAgICB3YXJuKAogICAgICAgICAgICAgICJBdm9pZCBtdXRhdGluZyBhIHByb3AgZGlyZWN0bHkgc2luY2UgdGhlIHZhbHVlIHdpbGwgYmUgIiArCiAgICAgICAgICAgICAgIm92ZXJ3cml0dGVuIHdoZW5ldmVyIHRoZSBwYXJlbnQgY29tcG9uZW50IHJlLXJlbmRlcnMuICIgKwogICAgICAgICAgICAgICJJbnN0ZWFkLCB1c2UgYSBkYXRhIG9yIGNvbXB1dGVkIHByb3BlcnR5IGJhc2VkIG9uIHRoZSBwcm9wJ3MgIiArCiAgICAgICAgICAgICAgInZhbHVlLiBQcm9wIGJlaW5nIG11dGF0ZWQ6IFwiIiArIGtleSArICJcIiIsCiAgICAgICAgICAgICAgdm0KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICAvLyBzdGF0aWMgcHJvcHMgYXJlIGFscmVhZHkgcHJveGllZCBvbiB0aGUgY29tcG9uZW50J3MgcHJvdG90eXBlCiAgICAgIC8vIGR1cmluZyBWdWUuZXh0ZW5kKCkuIFdlIG9ubHkgbmVlZCB0byBwcm94eSBwcm9wcyBkZWZpbmVkIGF0CiAgICAgIC8vIGluc3RhbnRpYXRpb24gaGVyZS4KICAgICAgaWYgKCEoa2V5IGluIHZtKSkgewogICAgICAgIHByb3h5KHZtLCAiX3Byb3BzIiwga2V5KTsKICAgICAgfQogICAgfTsKCiAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHNPcHRpb25zKSBsb29wKCBrZXkgKTsKICAgIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsKICB9CgogIGZ1bmN0aW9uIGluaXREYXRhICh2bSkgewogICAgdmFyIGRhdGEgPSB2bS4kb3B0aW9ucy5kYXRhOwogICAgZGF0YSA9IHZtLl9kYXRhID0gdHlwZW9mIGRhdGEgPT09ICdmdW5jdGlvbicKICAgICAgPyBnZXREYXRhKGRhdGEsIHZtKQogICAgICA6IGRhdGEgfHwge307CiAgICBpZiAoIWlzUGxhaW5PYmplY3QoZGF0YSkpIHsKICAgICAgZGF0YSA9IHt9OwogICAgICB3YXJuKAogICAgICAgICdkYXRhIGZ1bmN0aW9ucyBzaG91bGQgcmV0dXJuIGFuIG9iamVjdDpcbicgKwogICAgICAgICdodHRwczovL3Z1ZWpzLm9yZy92Mi9ndWlkZS9jb21wb25lbnRzLmh0bWwjZGF0YS1NdXN0LUJlLWEtRnVuY3Rpb24nLAogICAgICAgIHZtCiAgICAgICk7CiAgICB9CiAgICAvLyBwcm94eSBkYXRhIG9uIGluc3RhbmNlCiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGRhdGEpOwogICAgdmFyIHByb3BzID0gdm0uJG9wdGlvbnMucHJvcHM7CiAgICB2YXIgbWV0aG9kcyA9IHZtLiRvcHRpb25zLm1ldGhvZHM7CiAgICB2YXIgaSA9IGtleXMubGVuZ3RoOwogICAgd2hpbGUgKGktLSkgewogICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgewogICAgICAgIGlmIChtZXRob2RzICYmIGhhc093bihtZXRob2RzLCBrZXkpKSB7CiAgICAgICAgICB3YXJuKAogICAgICAgICAgICAoIk1ldGhvZCBcIiIgKyBrZXkgKyAiXCIgaGFzIGFscmVhZHkgYmVlbiBkZWZpbmVkIGFzIGEgZGF0YSBwcm9wZXJ0eS4iKSwKICAgICAgICAgICAgdm0KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChwcm9wcyAmJiBoYXNPd24ocHJvcHMsIGtleSkpIHsKICAgICAgICB3YXJuKAogICAgICAgICAgIlRoZSBkYXRhIHByb3BlcnR5IFwiIiArIGtleSArICJcIiBpcyBhbHJlYWR5IGRlY2xhcmVkIGFzIGEgcHJvcC4gIiArCiAgICAgICAgICAiVXNlIHByb3AgZGVmYXVsdCB2YWx1ZSBpbnN0ZWFkLiIsCiAgICAgICAgICB2bQogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAoIWlzUmVzZXJ2ZWQoa2V5KSkgewogICAgICAgIHByb3h5KHZtLCAiX2RhdGEiLCBrZXkpOwogICAgICB9CiAgICB9CiAgICAvLyBvYnNlcnZlIGRhdGEKICAgIG9ic2VydmUoZGF0YSwgdHJ1ZSAvKiBhc1Jvb3REYXRhICovKTsKICB9CgogIGZ1bmN0aW9uIGdldERhdGEgKGRhdGEsIHZtKSB7CiAgICAvLyAjNzU3MyBkaXNhYmxlIGRlcCBjb2xsZWN0aW9uIHdoZW4gaW52b2tpbmcgZGF0YSBnZXR0ZXJzCiAgICBwdXNoVGFyZ2V0KCk7CiAgICB0cnkgewogICAgICByZXR1cm4gZGF0YS5jYWxsKHZtLCB2bSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaGFuZGxlRXJyb3IoZSwgdm0sICJkYXRhKCkiKTsKICAgICAgcmV0dXJuIHt9CiAgICB9IGZpbmFsbHkgewogICAgICBwb3BUYXJnZXQoKTsKICAgIH0KICB9CgogIHZhciBjb21wdXRlZFdhdGNoZXJPcHRpb25zID0geyBsYXp5OiB0cnVlIH07CgogIGZ1bmN0aW9uIGluaXRDb21wdXRlZCAodm0sIGNvbXB1dGVkKSB7CiAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgIHZhciB3YXRjaGVycyA9IHZtLl9jb21wdXRlZFdhdGNoZXJzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIC8vIGNvbXB1dGVkIHByb3BlcnRpZXMgYXJlIGp1c3QgZ2V0dGVycyBkdXJpbmcgU1NSCiAgICB2YXIgaXNTU1IgPSBpc1NlcnZlclJlbmRlcmluZygpOwoKICAgIGZvciAodmFyIGtleSBpbiBjb21wdXRlZCkgewogICAgICB2YXIgdXNlckRlZiA9IGNvbXB1dGVkW2tleV07CiAgICAgIHZhciBnZXR0ZXIgPSB0eXBlb2YgdXNlckRlZiA9PT0gJ2Z1bmN0aW9uJyA/IHVzZXJEZWYgOiB1c2VyRGVmLmdldDsKICAgICAgaWYgKGdldHRlciA9PSBudWxsKSB7CiAgICAgICAgd2FybigKICAgICAgICAgICgiR2V0dGVyIGlzIG1pc3NpbmcgZm9yIGNvbXB1dGVkIHByb3BlcnR5IFwiIiArIGtleSArICJcIi4iKSwKICAgICAgICAgIHZtCiAgICAgICAgKTsKICAgICAgfQoKICAgICAgaWYgKCFpc1NTUikgewogICAgICAgIC8vIGNyZWF0ZSBpbnRlcm5hbCB3YXRjaGVyIGZvciB0aGUgY29tcHV0ZWQgcHJvcGVydHkuCiAgICAgICAgd2F0Y2hlcnNba2V5XSA9IG5ldyBXYXRjaGVyKAogICAgICAgICAgdm0sCiAgICAgICAgICBnZXR0ZXIgfHwgbm9vcCwKICAgICAgICAgIG5vb3AsCiAgICAgICAgICBjb21wdXRlZFdhdGNoZXJPcHRpb25zCiAgICAgICAgKTsKICAgICAgfQoKICAgICAgLy8gY29tcG9uZW50LWRlZmluZWQgY29tcHV0ZWQgcHJvcGVydGllcyBhcmUgYWxyZWFkeSBkZWZpbmVkIG9uIHRoZQogICAgICAvLyBjb21wb25lbnQgcHJvdG90eXBlLiBXZSBvbmx5IG5lZWQgdG8gZGVmaW5lIGNvbXB1dGVkIHByb3BlcnRpZXMgZGVmaW5lZAogICAgICAvLyBhdCBpbnN0YW50aWF0aW9uIGhlcmUuCiAgICAgIGlmICghKGtleSBpbiB2bSkpIHsKICAgICAgICBkZWZpbmVDb21wdXRlZCh2bSwga2V5LCB1c2VyRGVmKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoa2V5IGluIHZtLiRkYXRhKSB7CiAgICAgICAgICB3YXJuKCgiVGhlIGNvbXB1dGVkIHByb3BlcnR5IFwiIiArIGtleSArICJcIiBpcyBhbHJlYWR5IGRlZmluZWQgaW4gZGF0YS4iKSwgdm0pOwogICAgICAgIH0gZWxzZSBpZiAodm0uJG9wdGlvbnMucHJvcHMgJiYga2V5IGluIHZtLiRvcHRpb25zLnByb3BzKSB7CiAgICAgICAgICB3YXJuKCgiVGhlIGNvbXB1dGVkIHByb3BlcnR5IFwiIiArIGtleSArICJcIiBpcyBhbHJlYWR5IGRlZmluZWQgYXMgYSBwcm9wLiIpLCB2bSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZWZpbmVDb21wdXRlZCAoCiAgICB0YXJnZXQsCiAgICBrZXksCiAgICB1c2VyRGVmCiAgKSB7CiAgICB2YXIgc2hvdWxkQ2FjaGUgPSAhaXNTZXJ2ZXJSZW5kZXJpbmcoKTsKICAgIGlmICh0eXBlb2YgdXNlckRlZiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uZ2V0ID0gc2hvdWxkQ2FjaGUKICAgICAgICA/IGNyZWF0ZUNvbXB1dGVkR2V0dGVyKGtleSkKICAgICAgICA6IGNyZWF0ZUdldHRlckludm9rZXIodXNlckRlZik7CiAgICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPSBub29wOwogICAgfSBlbHNlIHsKICAgICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLmdldCA9IHVzZXJEZWYuZ2V0CiAgICAgICAgPyBzaG91bGRDYWNoZSAmJiB1c2VyRGVmLmNhY2hlICE9PSBmYWxzZQogICAgICAgICAgPyBjcmVhdGVDb21wdXRlZEdldHRlcihrZXkpCiAgICAgICAgICA6IGNyZWF0ZUdldHRlckludm9rZXIodXNlckRlZi5nZXQpCiAgICAgICAgOiBub29wOwogICAgICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID0gdXNlckRlZi5zZXQgfHwgbm9vcDsKICAgIH0KICAgIGlmIChzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uc2V0ID09PSBub29wKSB7CiAgICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgd2FybigKICAgICAgICAgICgiQ29tcHV0ZWQgcHJvcGVydHkgXCIiICsga2V5ICsgIlwiIHdhcyBhc3NpZ25lZCB0byBidXQgaXQgaGFzIG5vIHNldHRlci4iKSwKICAgICAgICAgIHRoaXMKICAgICAgICApOwogICAgICB9OwogICAgfQogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24pOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlQ29tcHV0ZWRHZXR0ZXIgKGtleSkgewogICAgcmV0dXJuIGZ1bmN0aW9uIGNvbXB1dGVkR2V0dGVyICgpIHsKICAgICAgdmFyIHdhdGNoZXIgPSB0aGlzLl9jb21wdXRlZFdhdGNoZXJzICYmIHRoaXMuX2NvbXB1dGVkV2F0Y2hlcnNba2V5XTsKICAgICAgaWYgKHdhdGNoZXIpIHsKICAgICAgICBpZiAod2F0Y2hlci5kaXJ0eSkgewogICAgICAgICAgd2F0Y2hlci5ldmFsdWF0ZSgpOwogICAgICAgIH0KICAgICAgICBpZiAoRGVwLnRhcmdldCkgewogICAgICAgICAgd2F0Y2hlci5kZXBlbmQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHdhdGNoZXIudmFsdWUKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlR2V0dGVySW52b2tlcihmbikgewogICAgcmV0dXJuIGZ1bmN0aW9uIGNvbXB1dGVkR2V0dGVyICgpIHsKICAgICAgcmV0dXJuIGZuLmNhbGwodGhpcywgdGhpcykKICAgIH0KICB9CgogIGZ1bmN0aW9uIGluaXRNZXRob2RzICh2bSwgbWV0aG9kcykgewogICAgdmFyIHByb3BzID0gdm0uJG9wdGlvbnMucHJvcHM7CiAgICBmb3IgKHZhciBrZXkgaW4gbWV0aG9kcykgewogICAgICB7CiAgICAgICAgaWYgKHR5cGVvZiBtZXRob2RzW2tleV0gIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgICJNZXRob2QgXCIiICsga2V5ICsgIlwiIGhhcyB0eXBlIFwiIiArICh0eXBlb2YgbWV0aG9kc1trZXldKSArICJcIiBpbiB0aGUgY29tcG9uZW50IGRlZmluaXRpb24uICIgKwogICAgICAgICAgICAiRGlkIHlvdSByZWZlcmVuY2UgdGhlIGZ1bmN0aW9uIGNvcnJlY3RseT8iLAogICAgICAgICAgICB2bQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKHByb3BzICYmIGhhc093bihwcm9wcywga2V5KSkgewogICAgICAgICAgd2FybigKICAgICAgICAgICAgKCJNZXRob2QgXCIiICsga2V5ICsgIlwiIGhhcyBhbHJlYWR5IGJlZW4gZGVmaW5lZCBhcyBhIHByb3AuIiksCiAgICAgICAgICAgIHZtCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoKGtleSBpbiB2bSkgJiYgaXNSZXNlcnZlZChrZXkpKSB7CiAgICAgICAgICB3YXJuKAogICAgICAgICAgICAiTWV0aG9kIFwiIiArIGtleSArICJcIiBjb25mbGljdHMgd2l0aCBhbiBleGlzdGluZyBWdWUgaW5zdGFuY2UgbWV0aG9kLiAiICsKICAgICAgICAgICAgIkF2b2lkIGRlZmluaW5nIGNvbXBvbmVudCBtZXRob2RzIHRoYXQgc3RhcnQgd2l0aCBfIG9yICQuIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdm1ba2V5XSA9IHR5cGVvZiBtZXRob2RzW2tleV0gIT09ICdmdW5jdGlvbicgPyBub29wIDogYmluZChtZXRob2RzW2tleV0sIHZtKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGluaXRXYXRjaCAodm0sIHdhdGNoKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gd2F0Y2gpIHsKICAgICAgdmFyIGhhbmRsZXIgPSB3YXRjaFtrZXldOwogICAgICBpZiAoQXJyYXkuaXNBcnJheShoYW5kbGVyKSkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFuZGxlci5sZW5ndGg7IGkrKykgewogICAgICAgICAgY3JlYXRlV2F0Y2hlcih2bSwga2V5LCBoYW5kbGVyW2ldKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3JlYXRlV2F0Y2hlcih2bSwga2V5LCBoYW5kbGVyKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlV2F0Y2hlciAoCiAgICB2bSwKICAgIGV4cE9yRm4sCiAgICBoYW5kbGVyLAogICAgb3B0aW9ucwogICkgewogICAgaWYgKGlzUGxhaW5PYmplY3QoaGFuZGxlcikpIHsKICAgICAgb3B0aW9ucyA9IGhhbmRsZXI7CiAgICAgIGhhbmRsZXIgPSBoYW5kbGVyLmhhbmRsZXI7CiAgICB9CiAgICBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICdzdHJpbmcnKSB7CiAgICAgIGhhbmRsZXIgPSB2bVtoYW5kbGVyXTsKICAgIH0KICAgIHJldHVybiB2bS4kd2F0Y2goZXhwT3JGbiwgaGFuZGxlciwgb3B0aW9ucykKICB9CgogIGZ1bmN0aW9uIHN0YXRlTWl4aW4gKFZ1ZSkgewogICAgLy8gZmxvdyBzb21laG93IGhhcyBwcm9ibGVtcyB3aXRoIGRpcmVjdGx5IGRlY2xhcmVkIGRlZmluaXRpb24gb2JqZWN0CiAgICAvLyB3aGVuIHVzaW5nIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSwgc28gd2UgaGF2ZSB0byBwcm9jZWR1cmFsbHkgYnVpbGQgdXAKICAgIC8vIHRoZSBvYmplY3QgaGVyZS4KICAgIHZhciBkYXRhRGVmID0ge307CiAgICBkYXRhRGVmLmdldCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRoaXMuX2RhdGEgfTsKICAgIHZhciBwcm9wc0RlZiA9IHt9OwogICAgcHJvcHNEZWYuZ2V0ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gdGhpcy5fcHJvcHMgfTsKICAgIHsKICAgICAgZGF0YURlZi5zZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgd2FybigKICAgICAgICAgICdBdm9pZCByZXBsYWNpbmcgaW5zdGFuY2Ugcm9vdCAkZGF0YS4gJyArCiAgICAgICAgICAnVXNlIG5lc3RlZCBkYXRhIHByb3BlcnRpZXMgaW5zdGVhZC4nLAogICAgICAgICAgdGhpcwogICAgICAgICk7CiAgICAgIH07CiAgICAgIHByb3BzRGVmLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB3YXJuKCIkcHJvcHMgaXMgcmVhZG9ubHkuIiwgdGhpcyk7CiAgICAgIH07CiAgICB9CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLnByb3RvdHlwZSwgJyRkYXRhJywgZGF0YURlZik7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLnByb3RvdHlwZSwgJyRwcm9wcycsIHByb3BzRGVmKTsKCiAgICBWdWUucHJvdG90eXBlLiRzZXQgPSBzZXQ7CiAgICBWdWUucHJvdG90eXBlLiRkZWxldGUgPSBkZWw7CgogICAgVnVlLnByb3RvdHlwZS4kd2F0Y2ggPSBmdW5jdGlvbiAoCiAgICAgIGV4cE9yRm4sCiAgICAgIGNiLAogICAgICBvcHRpb25zCiAgICApIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgaWYgKGlzUGxhaW5PYmplY3QoY2IpKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZVdhdGNoZXIodm0sIGV4cE9yRm4sIGNiLCBvcHRpb25zKQogICAgICB9CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICBvcHRpb25zLnVzZXIgPSB0cnVlOwogICAgICB2YXIgd2F0Y2hlciA9IG5ldyBXYXRjaGVyKHZtLCBleHBPckZuLCBjYiwgb3B0aW9ucyk7CiAgICAgIGlmIChvcHRpb25zLmltbWVkaWF0ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBjYi5jYWxsKHZtLCB3YXRjaGVyLnZhbHVlKTsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgaGFuZGxlRXJyb3IoZXJyb3IsIHZtLCAoImNhbGxiYWNrIGZvciBpbW1lZGlhdGUgd2F0Y2hlciBcIiIgKyAod2F0Y2hlci5leHByZXNzaW9uKSArICJcIiIpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uIHVud2F0Y2hGbiAoKSB7CiAgICAgICAgd2F0Y2hlci50ZWFyZG93bigpOwogICAgICB9CiAgICB9OwogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGluaXRQcm92aWRlICh2bSkgewogICAgdmFyIHByb3ZpZGUgPSB2bS4kb3B0aW9ucy5wcm92aWRlOwogICAgaWYgKHByb3ZpZGUpIHsKICAgICAgdm0uX3Byb3ZpZGVkID0gdHlwZW9mIHByb3ZpZGUgPT09ICdmdW5jdGlvbicKICAgICAgICA/IHByb3ZpZGUuY2FsbCh2bSkKICAgICAgICA6IHByb3ZpZGU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbml0SW5qZWN0aW9ucyAodm0pIHsKICAgIHZhciByZXN1bHQgPSByZXNvbHZlSW5qZWN0KHZtLiRvcHRpb25zLmluamVjdCwgdm0pOwogICAgaWYgKHJlc3VsdCkgewogICAgICB0b2dnbGVPYnNlcnZpbmcoZmFsc2UpOwogICAgICBPYmplY3Qua2V5cyhyZXN1bHQpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICAgICAgewogICAgICAgICAgZGVmaW5lUmVhY3RpdmUkJDEodm0sIGtleSwgcmVzdWx0W2tleV0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgd2FybigKICAgICAgICAgICAgICAiQXZvaWQgbXV0YXRpbmcgYW4gaW5qZWN0ZWQgdmFsdWUgZGlyZWN0bHkgc2luY2UgdGhlIGNoYW5nZXMgd2lsbCBiZSAiICsKICAgICAgICAgICAgICAib3ZlcndyaXR0ZW4gd2hlbmV2ZXIgdGhlIHByb3ZpZGVkIGNvbXBvbmVudCByZS1yZW5kZXJzLiAiICsKICAgICAgICAgICAgICAiaW5qZWN0aW9uIGJlaW5nIG11dGF0ZWQ6IFwiIiArIGtleSArICJcIiIsCiAgICAgICAgICAgICAgdm0KICAgICAgICAgICAgKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlc29sdmVJbmplY3QgKGluamVjdCwgdm0pIHsKICAgIGlmIChpbmplY3QpIHsKICAgICAgLy8gaW5qZWN0IGlzIDphbnkgYmVjYXVzZSBmbG93IGlzIG5vdCBzbWFydCBlbm91Z2ggdG8gZmlndXJlIG91dCBjYWNoZWQKICAgICAgdmFyIHJlc3VsdCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHZhciBrZXlzID0gaGFzU3ltYm9sCiAgICAgICAgPyBSZWZsZWN0Lm93bktleXMoaW5qZWN0KS5maWx0ZXIoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGluamVjdCwga2V5KS5lbnVtZXJhYmxlCiAgICAgICAgfSkKICAgICAgICA6IE9iamVjdC5rZXlzKGluamVjdCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICB2YXIgcHJvdmlkZUtleSA9IGluamVjdFtrZXldLmZyb207CiAgICAgICAgdmFyIHNvdXJjZSA9IHZtOwogICAgICAgIHdoaWxlIChzb3VyY2UpIHsKICAgICAgICAgIGlmIChzb3VyY2UuX3Byb3ZpZGVkICYmIGhhc093bihzb3VyY2UuX3Byb3ZpZGVkLCBwcm92aWRlS2V5KSkgewogICAgICAgICAgICByZXN1bHRba2V5XSA9IHNvdXJjZS5fcHJvdmlkZWRbcHJvdmlkZUtleV07CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICB9CiAgICAgICAgICBzb3VyY2UgPSBzb3VyY2UuJHBhcmVudDsKICAgICAgICB9CiAgICAgICAgaWYgKCFzb3VyY2UpIHsKICAgICAgICAgIGlmICgnZGVmYXVsdCcgaW4gaW5qZWN0W2tleV0pIHsKICAgICAgICAgICAgdmFyIHByb3ZpZGVEZWZhdWx0ID0gaW5qZWN0W2tleV0uZGVmYXVsdDsKICAgICAgICAgICAgcmVzdWx0W2tleV0gPSB0eXBlb2YgcHJvdmlkZURlZmF1bHQgPT09ICdmdW5jdGlvbicKICAgICAgICAgICAgICA/IHByb3ZpZGVEZWZhdWx0LmNhbGwodm0pCiAgICAgICAgICAgICAgOiBwcm92aWRlRGVmYXVsdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdhcm4oKCJJbmplY3Rpb24gXCIiICsga2V5ICsgIlwiIG5vdCBmb3VuZCIpLCB2bSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQKICAgIH0KICB9CgogIC8qICAqLwoKICAvKioKICAgKiBSdW50aW1lIGhlbHBlciBmb3IgcmVuZGVyaW5nIHYtZm9yIGxpc3RzLgogICAqLwogIGZ1bmN0aW9uIHJlbmRlckxpc3QgKAogICAgdmFsLAogICAgcmVuZGVyCiAgKSB7CiAgICB2YXIgcmV0LCBpLCBsLCBrZXlzLCBrZXk7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpIHx8IHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldCA9IG5ldyBBcnJheSh2YWwubGVuZ3RoKTsKICAgICAgZm9yIChpID0gMCwgbCA9IHZhbC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICByZXRbaV0gPSByZW5kZXIodmFsW2ldLCBpKTsKICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICByZXQgPSBuZXcgQXJyYXkodmFsKTsKICAgICAgZm9yIChpID0gMDsgaSA8IHZhbDsgaSsrKSB7CiAgICAgICAgcmV0W2ldID0gcmVuZGVyKGkgKyAxLCBpKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc09iamVjdCh2YWwpKSB7CiAgICAgIGtleXMgPSBPYmplY3Qua2V5cyh2YWwpOwogICAgICByZXQgPSBuZXcgQXJyYXkoa2V5cy5sZW5ndGgpOwogICAgICBmb3IgKGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBrZXkgPSBrZXlzW2ldOwogICAgICAgIHJldFtpXSA9IHJlbmRlcih2YWxba2V5XSwga2V5LCBpKTsKICAgICAgfQogICAgfQogICAgaWYgKCFpc0RlZihyZXQpKSB7CiAgICAgIHJldCA9IFtdOwogICAgfQogICAgKHJldCkuX2lzVkxpc3QgPSB0cnVlOwogICAgcmV0dXJuIHJldAogIH0KCiAgLyogICovCgogIC8qKgogICAqIFJ1bnRpbWUgaGVscGVyIGZvciByZW5kZXJpbmcgPHNsb3Q+CiAgICovCiAgZnVuY3Rpb24gcmVuZGVyU2xvdCAoCiAgICBuYW1lLAogICAgZmFsbGJhY2ssCiAgICBwcm9wcywKICAgIGJpbmRPYmplY3QKICApIHsKICAgIHZhciBzY29wZWRTbG90Rm4gPSB0aGlzLiRzY29wZWRTbG90c1tuYW1lXTsKICAgIHZhciBub2RlczsKICAgIGlmIChzY29wZWRTbG90Rm4pIHsgLy8gc2NvcGVkIHNsb3QKICAgICAgcHJvcHMgPSBwcm9wcyB8fCB7fTsKICAgICAgaWYgKGJpbmRPYmplY3QpIHsKICAgICAgICBpZiAoIWlzT2JqZWN0KGJpbmRPYmplY3QpKSB7CiAgICAgICAgICB3YXJuKAogICAgICAgICAgICAnc2xvdCB2LWJpbmQgd2l0aG91dCBhcmd1bWVudCBleHBlY3RzIGFuIE9iamVjdCcsCiAgICAgICAgICAgIHRoaXMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHByb3BzID0gZXh0ZW5kKGV4dGVuZCh7fSwgYmluZE9iamVjdCksIHByb3BzKTsKICAgICAgfQogICAgICBub2RlcyA9IHNjb3BlZFNsb3RGbihwcm9wcykgfHwgZmFsbGJhY2s7CiAgICB9IGVsc2UgewogICAgICBub2RlcyA9IHRoaXMuJHNsb3RzW25hbWVdIHx8IGZhbGxiYWNrOwogICAgfQoKICAgIHZhciB0YXJnZXQgPSBwcm9wcyAmJiBwcm9wcy5zbG90OwogICAgaWYgKHRhcmdldCkgewogICAgICByZXR1cm4gdGhpcy4kY3JlYXRlRWxlbWVudCgndGVtcGxhdGUnLCB7IHNsb3Q6IHRhcmdldCB9LCBub2RlcykKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBub2RlcwogICAgfQogIH0KCiAgLyogICovCgogIC8qKgogICAqIFJ1bnRpbWUgaGVscGVyIGZvciByZXNvbHZpbmcgZmlsdGVycwogICAqLwogIGZ1bmN0aW9uIHJlc29sdmVGaWx0ZXIgKGlkKSB7CiAgICByZXR1cm4gcmVzb2x2ZUFzc2V0KHRoaXMuJG9wdGlvbnMsICdmaWx0ZXJzJywgaWQsIHRydWUpIHx8IGlkZW50aXR5CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gaXNLZXlOb3RNYXRjaCAoZXhwZWN0LCBhY3R1YWwpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGV4cGVjdCkpIHsKICAgICAgcmV0dXJuIGV4cGVjdC5pbmRleE9mKGFjdHVhbCkgPT09IC0xCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZXhwZWN0ICE9PSBhY3R1YWwKICAgIH0KICB9CgogIC8qKgogICAqIFJ1bnRpbWUgaGVscGVyIGZvciBjaGVja2luZyBrZXlDb2RlcyBmcm9tIGNvbmZpZy4KICAgKiBleHBvc2VkIGFzIFZ1ZS5wcm90b3R5cGUuX2sKICAgKiBwYXNzaW5nIGluIGV2ZW50S2V5TmFtZSBhcyBsYXN0IGFyZ3VtZW50IHNlcGFyYXRlbHkgZm9yIGJhY2t3YXJkcyBjb21wYXQKICAgKi8KICBmdW5jdGlvbiBjaGVja0tleUNvZGVzICgKICAgIGV2ZW50S2V5Q29kZSwKICAgIGtleSwKICAgIGJ1aWx0SW5LZXlDb2RlLAogICAgZXZlbnRLZXlOYW1lLAogICAgYnVpbHRJbktleU5hbWUKICApIHsKICAgIHZhciBtYXBwZWRLZXlDb2RlID0gY29uZmlnLmtleUNvZGVzW2tleV0gfHwgYnVpbHRJbktleUNvZGU7CiAgICBpZiAoYnVpbHRJbktleU5hbWUgJiYgZXZlbnRLZXlOYW1lICYmICFjb25maWcua2V5Q29kZXNba2V5XSkgewogICAgICByZXR1cm4gaXNLZXlOb3RNYXRjaChidWlsdEluS2V5TmFtZSwgZXZlbnRLZXlOYW1lKQogICAgfSBlbHNlIGlmIChtYXBwZWRLZXlDb2RlKSB7CiAgICAgIHJldHVybiBpc0tleU5vdE1hdGNoKG1hcHBlZEtleUNvZGUsIGV2ZW50S2V5Q29kZSkKICAgIH0gZWxzZSBpZiAoZXZlbnRLZXlOYW1lKSB7CiAgICAgIHJldHVybiBoeXBoZW5hdGUoZXZlbnRLZXlOYW1lKSAhPT0ga2V5CiAgICB9CiAgfQoKICAvKiAgKi8KCiAgLyoqCiAgICogUnVudGltZSBoZWxwZXIgZm9yIG1lcmdpbmcgdi1iaW5kPSJvYmplY3QiIGludG8gYSBWTm9kZSdzIGRhdGEuCiAgICovCiAgZnVuY3Rpb24gYmluZE9iamVjdFByb3BzICgKICAgIGRhdGEsCiAgICB0YWcsCiAgICB2YWx1ZSwKICAgIGFzUHJvcCwKICAgIGlzU3luYwogICkgewogICAgaWYgKHZhbHVlKSB7CiAgICAgIGlmICghaXNPYmplY3QodmFsdWUpKSB7CiAgICAgICAgd2FybigKICAgICAgICAgICd2LWJpbmQgd2l0aG91dCBhcmd1bWVudCBleHBlY3RzIGFuIE9iamVjdCBvciBBcnJheSB2YWx1ZScsCiAgICAgICAgICB0aGlzCiAgICAgICAgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIHZhbHVlID0gdG9PYmplY3QodmFsdWUpOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzaDsKICAgICAgICB2YXIgbG9vcCA9IGZ1bmN0aW9uICgga2V5ICkgewogICAgICAgICAgaWYgKAogICAgICAgICAgICBrZXkgPT09ICdjbGFzcycgfHwKICAgICAgICAgICAga2V5ID09PSAnc3R5bGUnIHx8CiAgICAgICAgICAgIGlzUmVzZXJ2ZWRBdHRyaWJ1dGUoa2V5KQogICAgICAgICAgKSB7CiAgICAgICAgICAgIGhhc2ggPSBkYXRhOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBkYXRhLmF0dHJzICYmIGRhdGEuYXR0cnMudHlwZTsKICAgICAgICAgICAgaGFzaCA9IGFzUHJvcCB8fCBjb25maWcubXVzdFVzZVByb3AodGFnLCB0eXBlLCBrZXkpCiAgICAgICAgICAgICAgPyBkYXRhLmRvbVByb3BzIHx8IChkYXRhLmRvbVByb3BzID0ge30pCiAgICAgICAgICAgICAgOiBkYXRhLmF0dHJzIHx8IChkYXRhLmF0dHJzID0ge30pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNhbWVsaXplZEtleSA9IGNhbWVsaXplKGtleSk7CiAgICAgICAgICBpZiAoIShrZXkgaW4gaGFzaCkgJiYgIShjYW1lbGl6ZWRLZXkgaW4gaGFzaCkpIHsKICAgICAgICAgICAgaGFzaFtrZXldID0gdmFsdWVba2V5XTsKCiAgICAgICAgICAgIGlmIChpc1N5bmMpIHsKICAgICAgICAgICAgICB2YXIgb24gPSBkYXRhLm9uIHx8IChkYXRhLm9uID0ge30pOwogICAgICAgICAgICAgIG9uWygidXBkYXRlOiIgKyBjYW1lbGl6ZWRLZXkpXSA9IGZ1bmN0aW9uICgkZXZlbnQpIHsKICAgICAgICAgICAgICAgIHZhbHVlW2tleV0gPSAkZXZlbnQ7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZvciAodmFyIGtleSBpbiB2YWx1ZSkgbG9vcCgga2V5ICk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBkYXRhCiAgfQoKICAvKiAgKi8KCiAgLyoqCiAgICogUnVudGltZSBoZWxwZXIgZm9yIHJlbmRlcmluZyBzdGF0aWMgdHJlZXMuCiAgICovCiAgZnVuY3Rpb24gcmVuZGVyU3RhdGljICgKICAgIGluZGV4LAogICAgaXNJbkZvcgogICkgewogICAgdmFyIGNhY2hlZCA9IHRoaXMuX3N0YXRpY1RyZWVzIHx8ICh0aGlzLl9zdGF0aWNUcmVlcyA9IFtdKTsKICAgIHZhciB0cmVlID0gY2FjaGVkW2luZGV4XTsKICAgIC8vIGlmIGhhcyBhbHJlYWR5LXJlbmRlcmVkIHN0YXRpYyB0cmVlIGFuZCBub3QgaW5zaWRlIHYtZm9yLAogICAgLy8gd2UgY2FuIHJldXNlIHRoZSBzYW1lIHRyZWUuCiAgICBpZiAodHJlZSAmJiAhaXNJbkZvcikgewogICAgICByZXR1cm4gdHJlZQogICAgfQogICAgLy8gb3RoZXJ3aXNlLCByZW5kZXIgYSBmcmVzaCB0cmVlLgogICAgdHJlZSA9IGNhY2hlZFtpbmRleF0gPSB0aGlzLiRvcHRpb25zLnN0YXRpY1JlbmRlckZuc1tpbmRleF0uY2FsbCgKICAgICAgdGhpcy5fcmVuZGVyUHJveHksCiAgICAgIG51bGwsCiAgICAgIHRoaXMgLy8gZm9yIHJlbmRlciBmbnMgZ2VuZXJhdGVkIGZvciBmdW5jdGlvbmFsIGNvbXBvbmVudCB0ZW1wbGF0ZXMKICAgICk7CiAgICBtYXJrU3RhdGljKHRyZWUsICgiX19zdGF0aWNfXyIgKyBpbmRleCksIGZhbHNlKTsKICAgIHJldHVybiB0cmVlCiAgfQoKICAvKioKICAgKiBSdW50aW1lIGhlbHBlciBmb3Igdi1vbmNlLgogICAqIEVmZmVjdGl2ZWx5IGl0IG1lYW5zIG1hcmtpbmcgdGhlIG5vZGUgYXMgc3RhdGljIHdpdGggYSB1bmlxdWUga2V5LgogICAqLwogIGZ1bmN0aW9uIG1hcmtPbmNlICgKICAgIHRyZWUsCiAgICBpbmRleCwKICAgIGtleQogICkgewogICAgbWFya1N0YXRpYyh0cmVlLCAoIl9fb25jZV9fIiArIGluZGV4ICsgKGtleSA/ICgiXyIgKyBrZXkpIDogIiIpKSwgdHJ1ZSk7CiAgICByZXR1cm4gdHJlZQogIH0KCiAgZnVuY3Rpb24gbWFya1N0YXRpYyAoCiAgICB0cmVlLAogICAga2V5LAogICAgaXNPbmNlCiAgKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0cmVlKSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRyZWUubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodHJlZVtpXSAmJiB0eXBlb2YgdHJlZVtpXSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIG1hcmtTdGF0aWNOb2RlKHRyZWVbaV0sIChrZXkgKyAiXyIgKyBpKSwgaXNPbmNlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG1hcmtTdGF0aWNOb2RlKHRyZWUsIGtleSwgaXNPbmNlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG1hcmtTdGF0aWNOb2RlIChub2RlLCBrZXksIGlzT25jZSkgewogICAgbm9kZS5pc1N0YXRpYyA9IHRydWU7CiAgICBub2RlLmtleSA9IGtleTsKICAgIG5vZGUuaXNPbmNlID0gaXNPbmNlOwogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGJpbmRPYmplY3RMaXN0ZW5lcnMgKGRhdGEsIHZhbHVlKSB7CiAgICBpZiAodmFsdWUpIHsKICAgICAgaWYgKCFpc1BsYWluT2JqZWN0KHZhbHVlKSkgewogICAgICAgIHdhcm4oCiAgICAgICAgICAndi1vbiB3aXRob3V0IGFyZ3VtZW50IGV4cGVjdHMgYW4gT2JqZWN0IHZhbHVlJywKICAgICAgICAgIHRoaXMKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBvbiA9IGRhdGEub24gPSBkYXRhLm9uID8gZXh0ZW5kKHt9LCBkYXRhLm9uKSA6IHt9OwogICAgICAgIGZvciAodmFyIGtleSBpbiB2YWx1ZSkgewogICAgICAgICAgdmFyIGV4aXN0aW5nID0gb25ba2V5XTsKICAgICAgICAgIHZhciBvdXJzID0gdmFsdWVba2V5XTsKICAgICAgICAgIG9uW2tleV0gPSBleGlzdGluZyA/IFtdLmNvbmNhdChleGlzdGluZywgb3VycykgOiBvdXJzOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGRhdGEKICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBpbnN0YWxsUmVuZGVySGVscGVycyAodGFyZ2V0KSB7CiAgICB0YXJnZXQuX28gPSBtYXJrT25jZTsKICAgIHRhcmdldC5fbiA9IHRvTnVtYmVyOwogICAgdGFyZ2V0Ll9zID0gdG9TdHJpbmc7CiAgICB0YXJnZXQuX2wgPSByZW5kZXJMaXN0OwogICAgdGFyZ2V0Ll90ID0gcmVuZGVyU2xvdDsKICAgIHRhcmdldC5fcSA9IGxvb3NlRXF1YWw7CiAgICB0YXJnZXQuX2kgPSBsb29zZUluZGV4T2Y7CiAgICB0YXJnZXQuX20gPSByZW5kZXJTdGF0aWM7CiAgICB0YXJnZXQuX2YgPSByZXNvbHZlRmlsdGVyOwogICAgdGFyZ2V0Ll9rID0gY2hlY2tLZXlDb2RlczsKICAgIHRhcmdldC5fYiA9IGJpbmRPYmplY3RQcm9wczsKICAgIHRhcmdldC5fdiA9IGNyZWF0ZVRleHRWTm9kZTsKICAgIHRhcmdldC5fZSA9IGNyZWF0ZUVtcHR5Vk5vZGU7CiAgICB0YXJnZXQuX3UgPSByZXNvbHZlU2NvcGVkU2xvdHM7CiAgICB0YXJnZXQuX2cgPSBiaW5kT2JqZWN0TGlzdGVuZXJzOwogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0ICgKICAgIGRhdGEsCiAgICBwcm9wcywKICAgIGNoaWxkcmVuLAogICAgcGFyZW50LAogICAgQ3RvcgogICkgewogICAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CiAgICAvLyBlbnN1cmUgdGhlIGNyZWF0ZUVsZW1lbnQgZnVuY3Rpb24gaW4gZnVuY3Rpb25hbCBjb21wb25lbnRzCiAgICAvLyBnZXRzIGEgdW5pcXVlIGNvbnRleHQgLSB0aGlzIGlzIG5lY2Vzc2FyeSBmb3IgY29ycmVjdCBuYW1lZCBzbG90IGNoZWNrCiAgICB2YXIgY29udGV4dFZtOwogICAgaWYgKGhhc093bihwYXJlbnQsICdfdWlkJykpIHsKICAgICAgY29udGV4dFZtID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQpOwogICAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgICAgY29udGV4dFZtLl9vcmlnaW5hbCA9IHBhcmVudDsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHRoZSBjb250ZXh0IHZtIHBhc3NlZCBpbiBpcyBhIGZ1bmN0aW9uYWwgY29udGV4dCBhcyB3ZWxsLgogICAgICAvLyBpbiB0aGlzIGNhc2Ugd2Ugd2FudCB0byBtYWtlIHN1cmUgd2UgYXJlIGFibGUgdG8gZ2V0IGEgaG9sZCB0byB0aGUKICAgICAgLy8gcmVhbCBjb250ZXh0IGluc3RhbmNlLgogICAgICBjb250ZXh0Vm0gPSBwYXJlbnQ7CiAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgICBwYXJlbnQgPSBwYXJlbnQuX29yaWdpbmFsOwogICAgfQogICAgdmFyIGlzQ29tcGlsZWQgPSBpc1RydWUob3B0aW9ucy5fY29tcGlsZWQpOwogICAgdmFyIG5lZWROb3JtYWxpemF0aW9uID0gIWlzQ29tcGlsZWQ7CgogICAgdGhpcy5kYXRhID0gZGF0YTsKICAgIHRoaXMucHJvcHMgPSBwcm9wczsKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgdGhpcy5saXN0ZW5lcnMgPSBkYXRhLm9uIHx8IGVtcHR5T2JqZWN0OwogICAgdGhpcy5pbmplY3Rpb25zID0gcmVzb2x2ZUluamVjdChvcHRpb25zLmluamVjdCwgcGFyZW50KTsKICAgIHRoaXMuc2xvdHMgPSBmdW5jdGlvbiAoKSB7IHJldHVybiByZXNvbHZlU2xvdHMoY2hpbGRyZW4sIHBhcmVudCk7IH07CgogICAgLy8gc3VwcG9ydCBmb3IgY29tcGlsZWQgZnVuY3Rpb25hbCB0ZW1wbGF0ZQogICAgaWYgKGlzQ29tcGlsZWQpIHsKICAgICAgLy8gZXhwb3NpbmcgJG9wdGlvbnMgZm9yIHJlbmRlclN0YXRpYygpCiAgICAgIHRoaXMuJG9wdGlvbnMgPSBvcHRpb25zOwogICAgICAvLyBwcmUtcmVzb2x2ZSBzbG90cyBmb3IgcmVuZGVyU2xvdCgpCiAgICAgIHRoaXMuJHNsb3RzID0gdGhpcy5zbG90cygpOwogICAgICB0aGlzLiRzY29wZWRTbG90cyA9IGRhdGEuc2NvcGVkU2xvdHMgfHwgZW1wdHlPYmplY3Q7CiAgICB9CgogICAgaWYgKG9wdGlvbnMuX3Njb3BlSWQpIHsKICAgICAgdGhpcy5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgICAgdmFyIHZub2RlID0gY3JlYXRlRWxlbWVudChjb250ZXh0Vm0sIGEsIGIsIGMsIGQsIG5lZWROb3JtYWxpemF0aW9uKTsKICAgICAgICBpZiAodm5vZGUgJiYgIUFycmF5LmlzQXJyYXkodm5vZGUpKSB7CiAgICAgICAgICB2bm9kZS5mblNjb3BlSWQgPSBvcHRpb25zLl9zY29wZUlkOwogICAgICAgICAgdm5vZGUuZm5Db250ZXh0ID0gcGFyZW50OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdm5vZGUKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2MgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgeyByZXR1cm4gY3JlYXRlRWxlbWVudChjb250ZXh0Vm0sIGEsIGIsIGMsIGQsIG5lZWROb3JtYWxpemF0aW9uKTsgfTsKICAgIH0KICB9CgogIGluc3RhbGxSZW5kZXJIZWxwZXJzKEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0LnByb3RvdHlwZSk7CgogIGZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uYWxDb21wb25lbnQgKAogICAgQ3RvciwKICAgIHByb3BzRGF0YSwKICAgIGRhdGEsCiAgICBjb250ZXh0Vm0sCiAgICBjaGlsZHJlbgogICkgewogICAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7CiAgICB2YXIgcHJvcHMgPSB7fTsKICAgIHZhciBwcm9wT3B0aW9ucyA9IG9wdGlvbnMucHJvcHM7CiAgICBpZiAoaXNEZWYocHJvcE9wdGlvbnMpKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wT3B0aW9ucykgewogICAgICAgIHByb3BzW2tleV0gPSB2YWxpZGF0ZVByb3Aoa2V5LCBwcm9wT3B0aW9ucywgcHJvcHNEYXRhIHx8IGVtcHR5T2JqZWN0KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGlzRGVmKGRhdGEuYXR0cnMpKSB7IG1lcmdlUHJvcHMocHJvcHMsIGRhdGEuYXR0cnMpOyB9CiAgICAgIGlmIChpc0RlZihkYXRhLnByb3BzKSkgeyBtZXJnZVByb3BzKHByb3BzLCBkYXRhLnByb3BzKTsgfQogICAgfQoKICAgIHZhciByZW5kZXJDb250ZXh0ID0gbmV3IEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0KAogICAgICBkYXRhLAogICAgICBwcm9wcywKICAgICAgY2hpbGRyZW4sCiAgICAgIGNvbnRleHRWbSwKICAgICAgQ3RvcgogICAgKTsKCiAgICB2YXIgdm5vZGUgPSBvcHRpb25zLnJlbmRlci5jYWxsKG51bGwsIHJlbmRlckNvbnRleHQuX2MsIHJlbmRlckNvbnRleHQpOwoKICAgIGlmICh2bm9kZSBpbnN0YW5jZW9mIFZOb2RlKSB7CiAgICAgIHJldHVybiBjbG9uZUFuZE1hcmtGdW5jdGlvbmFsUmVzdWx0KHZub2RlLCBkYXRhLCByZW5kZXJDb250ZXh0LnBhcmVudCwgb3B0aW9ucywgcmVuZGVyQ29udGV4dCkKICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2bm9kZSkpIHsKICAgICAgdmFyIHZub2RlcyA9IG5vcm1hbGl6ZUNoaWxkcmVuKHZub2RlKSB8fCBbXTsKICAgICAgdmFyIHJlcyA9IG5ldyBBcnJheSh2bm9kZXMubGVuZ3RoKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2bm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICByZXNbaV0gPSBjbG9uZUFuZE1hcmtGdW5jdGlvbmFsUmVzdWx0KHZub2Rlc1tpXSwgZGF0YSwgcmVuZGVyQ29udGV4dC5wYXJlbnQsIG9wdGlvbnMsIHJlbmRlckNvbnRleHQpOwogICAgICB9CiAgICAgIHJldHVybiByZXMKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNsb25lQW5kTWFya0Z1bmN0aW9uYWxSZXN1bHQgKHZub2RlLCBkYXRhLCBjb250ZXh0Vm0sIG9wdGlvbnMsIHJlbmRlckNvbnRleHQpIHsKICAgIC8vICM3ODE3IGNsb25lIG5vZGUgYmVmb3JlIHNldHRpbmcgZm5Db250ZXh0LCBvdGhlcndpc2UgaWYgdGhlIG5vZGUgaXMgcmV1c2VkCiAgICAvLyAoZS5nLiBpdCB3YXMgZnJvbSBhIGNhY2hlZCBub3JtYWwgc2xvdCkgdGhlIGZuQ29udGV4dCBjYXVzZXMgbmFtZWQgc2xvdHMKICAgIC8vIHRoYXQgc2hvdWxkIG5vdCBiZSBtYXRjaGVkIHRvIG1hdGNoLgogICAgdmFyIGNsb25lID0gY2xvbmVWTm9kZSh2bm9kZSk7CiAgICBjbG9uZS5mbkNvbnRleHQgPSBjb250ZXh0Vm07CiAgICBjbG9uZS5mbk9wdGlvbnMgPSBvcHRpb25zOwogICAgewogICAgICAoY2xvbmUuZGV2dG9vbHNNZXRhID0gY2xvbmUuZGV2dG9vbHNNZXRhIHx8IHt9KS5yZW5kZXJDb250ZXh0ID0gcmVuZGVyQ29udGV4dDsKICAgIH0KICAgIGlmIChkYXRhLnNsb3QpIHsKICAgICAgKGNsb25lLmRhdGEgfHwgKGNsb25lLmRhdGEgPSB7fSkpLnNsb3QgPSBkYXRhLnNsb3Q7CiAgICB9CiAgICByZXR1cm4gY2xvbmUKICB9CgogIGZ1bmN0aW9uIG1lcmdlUHJvcHMgKHRvLCBmcm9tKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gZnJvbSkgewogICAgICB0b1tjYW1lbGl6ZShrZXkpXSA9IGZyb21ba2V5XTsKICAgIH0KICB9CgogIC8qICAqLwoKICAvKiAgKi8KCiAgLyogICovCgogIC8qICAqLwoKICAvLyBpbmxpbmUgaG9va3MgdG8gYmUgaW52b2tlZCBvbiBjb21wb25lbnQgVk5vZGVzIGR1cmluZyBwYXRjaAogIHZhciBjb21wb25lbnRWTm9kZUhvb2tzID0gewogICAgaW5pdDogZnVuY3Rpb24gaW5pdCAodm5vZGUsIGh5ZHJhdGluZykgewogICAgICBpZiAoCiAgICAgICAgdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgJiYKICAgICAgICAhdm5vZGUuY29tcG9uZW50SW5zdGFuY2UuX2lzRGVzdHJveWVkICYmCiAgICAgICAgdm5vZGUuZGF0YS5rZWVwQWxpdmUKICAgICAgKSB7CiAgICAgICAgLy8ga2VwdC1hbGl2ZSBjb21wb25lbnRzLCB0cmVhdCBhcyBhIHBhdGNoCiAgICAgICAgdmFyIG1vdW50ZWROb2RlID0gdm5vZGU7IC8vIHdvcmsgYXJvdW5kIGZsb3cKICAgICAgICBjb21wb25lbnRWTm9kZUhvb2tzLnByZXBhdGNoKG1vdW50ZWROb2RlLCBtb3VudGVkTm9kZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNoaWxkID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgPSBjcmVhdGVDb21wb25lbnRJbnN0YW5jZUZvclZub2RlKAogICAgICAgICAgdm5vZGUsCiAgICAgICAgICBhY3RpdmVJbnN0YW5jZQogICAgICAgICk7CiAgICAgICAgY2hpbGQuJG1vdW50KGh5ZHJhdGluZyA/IHZub2RlLmVsbSA6IHVuZGVmaW5lZCwgaHlkcmF0aW5nKTsKICAgICAgfQogICAgfSwKCiAgICBwcmVwYXRjaDogZnVuY3Rpb24gcHJlcGF0Y2ggKG9sZFZub2RlLCB2bm9kZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHZub2RlLmNvbXBvbmVudE9wdGlvbnM7CiAgICAgIHZhciBjaGlsZCA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gb2xkVm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CiAgICAgIHVwZGF0ZUNoaWxkQ29tcG9uZW50KAogICAgICAgIGNoaWxkLAogICAgICAgIG9wdGlvbnMucHJvcHNEYXRhLCAvLyB1cGRhdGVkIHByb3BzCiAgICAgICAgb3B0aW9ucy5saXN0ZW5lcnMsIC8vIHVwZGF0ZWQgbGlzdGVuZXJzCiAgICAgICAgdm5vZGUsIC8vIG5ldyBwYXJlbnQgdm5vZGUKICAgICAgICBvcHRpb25zLmNoaWxkcmVuIC8vIG5ldyBjaGlsZHJlbgogICAgICApOwogICAgfSwKCiAgICBpbnNlcnQ6IGZ1bmN0aW9uIGluc2VydCAodm5vZGUpIHsKICAgICAgdmFyIGNvbnRleHQgPSB2bm9kZS5jb250ZXh0OwogICAgICB2YXIgY29tcG9uZW50SW5zdGFuY2UgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZTsKICAgICAgaWYgKCFjb21wb25lbnRJbnN0YW5jZS5faXNNb3VudGVkKSB7CiAgICAgICAgY29tcG9uZW50SW5zdGFuY2UuX2lzTW91bnRlZCA9IHRydWU7CiAgICAgICAgY2FsbEhvb2soY29tcG9uZW50SW5zdGFuY2UsICdtb3VudGVkJyk7CiAgICAgIH0KICAgICAgaWYgKHZub2RlLmRhdGEua2VlcEFsaXZlKSB7CiAgICAgICAgaWYgKGNvbnRleHQuX2lzTW91bnRlZCkgewogICAgICAgICAgLy8gdnVlLXJvdXRlciMxMjEyCiAgICAgICAgICAvLyBEdXJpbmcgdXBkYXRlcywgYSBrZXB0LWFsaXZlIGNvbXBvbmVudCdzIGNoaWxkIGNvbXBvbmVudHMgbWF5CiAgICAgICAgICAvLyBjaGFuZ2UsIHNvIGRpcmVjdGx5IHdhbGtpbmcgdGhlIHRyZWUgaGVyZSBtYXkgY2FsbCBhY3RpdmF0ZWQgaG9va3MKICAgICAgICAgIC8vIG9uIGluY29ycmVjdCBjaGlsZHJlbi4gSW5zdGVhZCB3ZSBwdXNoIHRoZW0gaW50byBhIHF1ZXVlIHdoaWNoIHdpbGwKICAgICAgICAgIC8vIGJlIHByb2Nlc3NlZCBhZnRlciB0aGUgd2hvbGUgcGF0Y2ggcHJvY2VzcyBlbmRlZC4KICAgICAgICAgIHF1ZXVlQWN0aXZhdGVkQ29tcG9uZW50KGNvbXBvbmVudEluc3RhbmNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWN0aXZhdGVDaGlsZENvbXBvbmVudChjb21wb25lbnRJbnN0YW5jZSwgdHJ1ZSAvKiBkaXJlY3QgKi8pOwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95ICh2bm9kZSkgewogICAgICB2YXIgY29tcG9uZW50SW5zdGFuY2UgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZTsKICAgICAgaWYgKCFjb21wb25lbnRJbnN0YW5jZS5faXNEZXN0cm95ZWQpIHsKICAgICAgICBpZiAoIXZub2RlLmRhdGEua2VlcEFsaXZlKSB7CiAgICAgICAgICBjb21wb25lbnRJbnN0YW5jZS4kZGVzdHJveSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWFjdGl2YXRlQ2hpbGRDb21wb25lbnQoY29tcG9uZW50SW5zdGFuY2UsIHRydWUgLyogZGlyZWN0ICovKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICB2YXIgaG9va3NUb01lcmdlID0gT2JqZWN0LmtleXMoY29tcG9uZW50Vk5vZGVIb29rcyk7CgogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudCAoCiAgICBDdG9yLAogICAgZGF0YSwKICAgIGNvbnRleHQsCiAgICBjaGlsZHJlbiwKICAgIHRhZwogICkgewogICAgaWYgKGlzVW5kZWYoQ3RvcikpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdmFyIGJhc2VDdG9yID0gY29udGV4dC4kb3B0aW9ucy5fYmFzZTsKCiAgICAvLyBwbGFpbiBvcHRpb25zIG9iamVjdDogdHVybiBpdCBpbnRvIGEgY29uc3RydWN0b3IKICAgIGlmIChpc09iamVjdChDdG9yKSkgewogICAgICBDdG9yID0gYmFzZUN0b3IuZXh0ZW5kKEN0b3IpOwogICAgfQoKICAgIC8vIGlmIGF0IHRoaXMgc3RhZ2UgaXQncyBub3QgYSBjb25zdHJ1Y3RvciBvciBhbiBhc3luYyBjb21wb25lbnQgZmFjdG9yeSwKICAgIC8vIHJlamVjdC4KICAgIGlmICh0eXBlb2YgQ3RvciAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB7CiAgICAgICAgd2FybigoIkludmFsaWQgQ29tcG9uZW50IGRlZmluaXRpb246ICIgKyAoU3RyaW5nKEN0b3IpKSksIGNvbnRleHQpOwogICAgICB9CiAgICAgIHJldHVybgogICAgfQoKICAgIC8vIGFzeW5jIGNvbXBvbmVudAogICAgdmFyIGFzeW5jRmFjdG9yeTsKICAgIGlmIChpc1VuZGVmKEN0b3IuY2lkKSkgewogICAgICBhc3luY0ZhY3RvcnkgPSBDdG9yOwogICAgICBDdG9yID0gcmVzb2x2ZUFzeW5jQ29tcG9uZW50KGFzeW5jRmFjdG9yeSwgYmFzZUN0b3IsIGNvbnRleHQpOwogICAgICBpZiAoQ3RvciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgLy8gcmV0dXJuIGEgcGxhY2Vob2xkZXIgbm9kZSBmb3IgYXN5bmMgY29tcG9uZW50LCB3aGljaCBpcyByZW5kZXJlZAogICAgICAgIC8vIGFzIGEgY29tbWVudCBub2RlIGJ1dCBwcmVzZXJ2ZXMgYWxsIHRoZSByYXcgaW5mb3JtYXRpb24gZm9yIHRoZSBub2RlLgogICAgICAgIC8vIHRoZSBpbmZvcm1hdGlvbiB3aWxsIGJlIHVzZWQgZm9yIGFzeW5jIHNlcnZlci1yZW5kZXJpbmcgYW5kIGh5ZHJhdGlvbi4KICAgICAgICByZXR1cm4gY3JlYXRlQXN5bmNQbGFjZWhvbGRlcigKICAgICAgICAgIGFzeW5jRmFjdG9yeSwKICAgICAgICAgIGRhdGEsCiAgICAgICAgICBjb250ZXh0LAogICAgICAgICAgY2hpbGRyZW4sCiAgICAgICAgICB0YWcKICAgICAgICApCiAgICAgIH0KICAgIH0KCiAgICBkYXRhID0gZGF0YSB8fCB7fTsKCiAgICAvLyByZXNvbHZlIGNvbnN0cnVjdG9yIG9wdGlvbnMgaW4gY2FzZSBnbG9iYWwgbWl4aW5zIGFyZSBhcHBsaWVkIGFmdGVyCiAgICAvLyBjb21wb25lbnQgY29uc3RydWN0b3IgY3JlYXRpb24KICAgIHJlc29sdmVDb25zdHJ1Y3Rvck9wdGlvbnMoQ3Rvcik7CgogICAgLy8gdHJhbnNmb3JtIGNvbXBvbmVudCB2LW1vZGVsIGRhdGEgaW50byBwcm9wcyAmIGV2ZW50cwogICAgaWYgKGlzRGVmKGRhdGEubW9kZWwpKSB7CiAgICAgIHRyYW5zZm9ybU1vZGVsKEN0b3Iub3B0aW9ucywgZGF0YSk7CiAgICB9CgogICAgLy8gZXh0cmFjdCBwcm9wcwogICAgdmFyIHByb3BzRGF0YSA9IGV4dHJhY3RQcm9wc0Zyb21WTm9kZURhdGEoZGF0YSwgQ3RvciwgdGFnKTsKCiAgICAvLyBmdW5jdGlvbmFsIGNvbXBvbmVudAogICAgaWYgKGlzVHJ1ZShDdG9yLm9wdGlvbnMuZnVuY3Rpb25hbCkpIHsKICAgICAgcmV0dXJuIGNyZWF0ZUZ1bmN0aW9uYWxDb21wb25lbnQoQ3RvciwgcHJvcHNEYXRhLCBkYXRhLCBjb250ZXh0LCBjaGlsZHJlbikKICAgIH0KCiAgICAvLyBleHRyYWN0IGxpc3RlbmVycywgc2luY2UgdGhlc2UgbmVlZHMgdG8gYmUgdHJlYXRlZCBhcwogICAgLy8gY2hpbGQgY29tcG9uZW50IGxpc3RlbmVycyBpbnN0ZWFkIG9mIERPTSBsaXN0ZW5lcnMKICAgIHZhciBsaXN0ZW5lcnMgPSBkYXRhLm9uOwogICAgLy8gcmVwbGFjZSB3aXRoIGxpc3RlbmVycyB3aXRoIC5uYXRpdmUgbW9kaWZpZXIKICAgIC8vIHNvIGl0IGdldHMgcHJvY2Vzc2VkIGR1cmluZyBwYXJlbnQgY29tcG9uZW50IHBhdGNoLgogICAgZGF0YS5vbiA9IGRhdGEubmF0aXZlT247CgogICAgaWYgKGlzVHJ1ZShDdG9yLm9wdGlvbnMuYWJzdHJhY3QpKSB7CiAgICAgIC8vIGFic3RyYWN0IGNvbXBvbmVudHMgZG8gbm90IGtlZXAgYW55dGhpbmcKICAgICAgLy8gb3RoZXIgdGhhbiBwcm9wcyAmIGxpc3RlbmVycyAmIHNsb3QKCiAgICAgIC8vIHdvcmsgYXJvdW5kIGZsb3cKICAgICAgdmFyIHNsb3QgPSBkYXRhLnNsb3Q7CiAgICAgIGRhdGEgPSB7fTsKICAgICAgaWYgKHNsb3QpIHsKICAgICAgICBkYXRhLnNsb3QgPSBzbG90OwogICAgICB9CiAgICB9CgogICAgLy8gaW5zdGFsbCBjb21wb25lbnQgbWFuYWdlbWVudCBob29rcyBvbnRvIHRoZSBwbGFjZWhvbGRlciBub2RlCiAgICBpbnN0YWxsQ29tcG9uZW50SG9va3MoZGF0YSk7CgogICAgLy8gcmV0dXJuIGEgcGxhY2Vob2xkZXIgdm5vZGUKICAgIHZhciBuYW1lID0gQ3Rvci5vcHRpb25zLm5hbWUgfHwgdGFnOwogICAgdmFyIHZub2RlID0gbmV3IFZOb2RlKAogICAgICAoInZ1ZS1jb21wb25lbnQtIiArIChDdG9yLmNpZCkgKyAobmFtZSA/ICgiLSIgKyBuYW1lKSA6ICcnKSksCiAgICAgIGRhdGEsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRleHQsCiAgICAgIHsgQ3RvcjogQ3RvciwgcHJvcHNEYXRhOiBwcm9wc0RhdGEsIGxpc3RlbmVyczogbGlzdGVuZXJzLCB0YWc6IHRhZywgY2hpbGRyZW46IGNoaWxkcmVuIH0sCiAgICAgIGFzeW5jRmFjdG9yeQogICAgKTsKCiAgICByZXR1cm4gdm5vZGUKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudEluc3RhbmNlRm9yVm5vZGUgKAogICAgdm5vZGUsIC8vIHdlIGtub3cgaXQncyBNb3VudGVkQ29tcG9uZW50Vk5vZGUgYnV0IGZsb3cgZG9lc24ndAogICAgcGFyZW50IC8vIGFjdGl2ZUluc3RhbmNlIGluIGxpZmVjeWNsZSBzdGF0ZQogICkgewogICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgIF9pc0NvbXBvbmVudDogdHJ1ZSwKICAgICAgX3BhcmVudFZub2RlOiB2bm9kZSwKICAgICAgcGFyZW50OiBwYXJlbnQKICAgIH07CiAgICAvLyBjaGVjayBpbmxpbmUtdGVtcGxhdGUgcmVuZGVyIGZ1bmN0aW9ucwogICAgdmFyIGlubGluZVRlbXBsYXRlID0gdm5vZGUuZGF0YS5pbmxpbmVUZW1wbGF0ZTsKICAgIGlmIChpc0RlZihpbmxpbmVUZW1wbGF0ZSkpIHsKICAgICAgb3B0aW9ucy5yZW5kZXIgPSBpbmxpbmVUZW1wbGF0ZS5yZW5kZXI7CiAgICAgIG9wdGlvbnMuc3RhdGljUmVuZGVyRm5zID0gaW5saW5lVGVtcGxhdGUuc3RhdGljUmVuZGVyRm5zOwogICAgfQogICAgcmV0dXJuIG5ldyB2bm9kZS5jb21wb25lbnRPcHRpb25zLkN0b3Iob3B0aW9ucykKICB9CgogIGZ1bmN0aW9uIGluc3RhbGxDb21wb25lbnRIb29rcyAoZGF0YSkgewogICAgdmFyIGhvb2tzID0gZGF0YS5ob29rIHx8IChkYXRhLmhvb2sgPSB7fSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzVG9NZXJnZS5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0gaG9va3NUb01lcmdlW2ldOwogICAgICB2YXIgZXhpc3RpbmcgPSBob29rc1trZXldOwogICAgICB2YXIgdG9NZXJnZSA9IGNvbXBvbmVudFZOb2RlSG9va3Nba2V5XTsKICAgICAgaWYgKGV4aXN0aW5nICE9PSB0b01lcmdlICYmICEoZXhpc3RpbmcgJiYgZXhpc3RpbmcuX21lcmdlZCkpIHsKICAgICAgICBob29rc1trZXldID0gZXhpc3RpbmcgPyBtZXJnZUhvb2skMSh0b01lcmdlLCBleGlzdGluZykgOiB0b01lcmdlOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBtZXJnZUhvb2skMSAoZjEsIGYyKSB7CiAgICB2YXIgbWVyZ2VkID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgLy8gZmxvdyBjb21wbGFpbnMgYWJvdXQgZXh0cmEgYXJncyB3aGljaCBpcyB3aHkgd2UgdXNlIGFueQogICAgICBmMShhLCBiKTsKICAgICAgZjIoYSwgYik7CiAgICB9OwogICAgbWVyZ2VkLl9tZXJnZWQgPSB0cnVlOwogICAgcmV0dXJuIG1lcmdlZAogIH0KCiAgLy8gdHJhbnNmb3JtIGNvbXBvbmVudCB2LW1vZGVsIGluZm8gKHZhbHVlIGFuZCBjYWxsYmFjaykgaW50bwogIC8vIHByb3AgYW5kIGV2ZW50IGhhbmRsZXIgcmVzcGVjdGl2ZWx5LgogIGZ1bmN0aW9uIHRyYW5zZm9ybU1vZGVsIChvcHRpb25zLCBkYXRhKSB7CiAgICB2YXIgcHJvcCA9IChvcHRpb25zLm1vZGVsICYmIG9wdGlvbnMubW9kZWwucHJvcCkgfHwgJ3ZhbHVlJzsKICAgIHZhciBldmVudCA9IChvcHRpb25zLm1vZGVsICYmIG9wdGlvbnMubW9kZWwuZXZlbnQpIHx8ICdpbnB1dCcKICAgIDsoZGF0YS5wcm9wcyB8fCAoZGF0YS5wcm9wcyA9IHt9KSlbcHJvcF0gPSBkYXRhLm1vZGVsLnZhbHVlOwogICAgdmFyIG9uID0gZGF0YS5vbiB8fCAoZGF0YS5vbiA9IHt9KTsKICAgIHZhciBleGlzdGluZyA9IG9uW2V2ZW50XTsKICAgIHZhciBjYWxsYmFjayA9IGRhdGEubW9kZWwuY2FsbGJhY2s7CiAgICBpZiAoaXNEZWYoZXhpc3RpbmcpKSB7CiAgICAgIGlmICgKICAgICAgICBBcnJheS5pc0FycmF5KGV4aXN0aW5nKQogICAgICAgICAgPyBleGlzdGluZy5pbmRleE9mKGNhbGxiYWNrKSA9PT0gLTEKICAgICAgICAgIDogZXhpc3RpbmcgIT09IGNhbGxiYWNrCiAgICAgICkgewogICAgICAgIG9uW2V2ZW50XSA9IFtjYWxsYmFja10uY29uY2F0KGV4aXN0aW5nKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgb25bZXZlbnRdID0gY2FsbGJhY2s7CiAgICB9CiAgfQoKICAvKiAgKi8KCiAgdmFyIFNJTVBMRV9OT1JNQUxJWkUgPSAxOwogIHZhciBBTFdBWVNfTk9STUFMSVpFID0gMjsKCiAgLy8gd3JhcHBlciBmdW5jdGlvbiBmb3IgcHJvdmlkaW5nIGEgbW9yZSBmbGV4aWJsZSBpbnRlcmZhY2UKICAvLyB3aXRob3V0IGdldHRpbmcgeWVsbGVkIGF0IGJ5IGZsb3cKICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50ICgKICAgIGNvbnRleHQsCiAgICB0YWcsCiAgICBkYXRhLAogICAgY2hpbGRyZW4sCiAgICBub3JtYWxpemF0aW9uVHlwZSwKICAgIGFsd2F5c05vcm1hbGl6ZQogICkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkgfHwgaXNQcmltaXRpdmUoZGF0YSkpIHsKICAgICAgbm9ybWFsaXphdGlvblR5cGUgPSBjaGlsZHJlbjsKICAgICAgY2hpbGRyZW4gPSBkYXRhOwogICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgfQogICAgaWYgKGlzVHJ1ZShhbHdheXNOb3JtYWxpemUpKSB7CiAgICAgIG5vcm1hbGl6YXRpb25UeXBlID0gQUxXQVlTX05PUk1BTElaRTsKICAgIH0KICAgIHJldHVybiBfY3JlYXRlRWxlbWVudChjb250ZXh0LCB0YWcsIGRhdGEsIGNoaWxkcmVuLCBub3JtYWxpemF0aW9uVHlwZSkKICB9CgogIGZ1bmN0aW9uIF9jcmVhdGVFbGVtZW50ICgKICAgIGNvbnRleHQsCiAgICB0YWcsCiAgICBkYXRhLAogICAgY2hpbGRyZW4sCiAgICBub3JtYWxpemF0aW9uVHlwZQogICkgewogICAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKChkYXRhKS5fX29iX18pKSB7CiAgICAgIHdhcm4oCiAgICAgICAgIkF2b2lkIHVzaW5nIG9ic2VydmVkIGRhdGEgb2JqZWN0IGFzIHZub2RlIGRhdGE6ICIgKyAoSlNPTi5zdHJpbmdpZnkoZGF0YSkpICsgIlxuIiArCiAgICAgICAgJ0Fsd2F5cyBjcmVhdGUgZnJlc2ggdm5vZGUgZGF0YSBvYmplY3RzIGluIGVhY2ggcmVuZGVyIScsCiAgICAgICAgY29udGV4dAogICAgICApOwogICAgICByZXR1cm4gY3JlYXRlRW1wdHlWTm9kZSgpCiAgICB9CiAgICAvLyBvYmplY3Qgc3ludGF4IGluIHYtYmluZAogICAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEuaXMpKSB7CiAgICAgIHRhZyA9IGRhdGEuaXM7CiAgICB9CiAgICBpZiAoIXRhZykgewogICAgICAvLyBpbiBjYXNlIG9mIGNvbXBvbmVudCA6aXMgc2V0IHRvIGZhbHN5IHZhbHVlCiAgICAgIHJldHVybiBjcmVhdGVFbXB0eVZOb2RlKCkKICAgIH0KICAgIC8vIHdhcm4gYWdhaW5zdCBub24tcHJpbWl0aXZlIGtleQogICAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEua2V5KSAmJiAhaXNQcmltaXRpdmUoZGF0YS5rZXkpCiAgICApIHsKICAgICAgewogICAgICAgIHdhcm4oCiAgICAgICAgICAnQXZvaWQgdXNpbmcgbm9uLXByaW1pdGl2ZSB2YWx1ZSBhcyBrZXksICcgKwogICAgICAgICAgJ3VzZSBzdHJpbmcvbnVtYmVyIHZhbHVlIGluc3RlYWQuJywKICAgICAgICAgIGNvbnRleHQKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICAvLyBzdXBwb3J0IHNpbmdsZSBmdW5jdGlvbiBjaGlsZHJlbiBhcyBkZWZhdWx0IHNjb3BlZCBzbG90CiAgICBpZiAoQXJyYXkuaXNBcnJheShjaGlsZHJlbikgJiYKICAgICAgdHlwZW9mIGNoaWxkcmVuWzBdID09PSAnZnVuY3Rpb24nCiAgICApIHsKICAgICAgZGF0YSA9IGRhdGEgfHwge307CiAgICAgIGRhdGEuc2NvcGVkU2xvdHMgPSB7IGRlZmF1bHQ6IGNoaWxkcmVuWzBdIH07CiAgICAgIGNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgICB9CiAgICBpZiAobm9ybWFsaXphdGlvblR5cGUgPT09IEFMV0FZU19OT1JNQUxJWkUpIHsKICAgICAgY2hpbGRyZW4gPSBub3JtYWxpemVDaGlsZHJlbihjaGlsZHJlbik7CiAgICB9IGVsc2UgaWYgKG5vcm1hbGl6YXRpb25UeXBlID09PSBTSU1QTEVfTk9STUFMSVpFKSB7CiAgICAgIGNoaWxkcmVuID0gc2ltcGxlTm9ybWFsaXplQ2hpbGRyZW4oY2hpbGRyZW4pOwogICAgfQogICAgdmFyIHZub2RlLCBuczsKICAgIGlmICh0eXBlb2YgdGFnID09PSAnc3RyaW5nJykgewogICAgICB2YXIgQ3RvcjsKICAgICAgbnMgPSAoY29udGV4dC4kdm5vZGUgJiYgY29udGV4dC4kdm5vZGUubnMpIHx8IGNvbmZpZy5nZXRUYWdOYW1lc3BhY2UodGFnKTsKICAgICAgaWYgKGNvbmZpZy5pc1Jlc2VydmVkVGFnKHRhZykpIHsKICAgICAgICAvLyBwbGF0Zm9ybSBidWlsdC1pbiBlbGVtZW50cwogICAgICAgIHZub2RlID0gbmV3IFZOb2RlKAogICAgICAgICAgY29uZmlnLnBhcnNlUGxhdGZvcm1UYWdOYW1lKHRhZyksIGRhdGEsIGNoaWxkcmVuLAogICAgICAgICAgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRleHQKICAgICAgICApOwogICAgICB9IGVsc2UgaWYgKCghZGF0YSB8fCAhZGF0YS5wcmUpICYmIGlzRGVmKEN0b3IgPSByZXNvbHZlQXNzZXQoY29udGV4dC4kb3B0aW9ucywgJ2NvbXBvbmVudHMnLCB0YWcpKSkgewogICAgICAgIC8vIGNvbXBvbmVudAogICAgICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KEN0b3IsIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuLCB0YWcpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIHVua25vd24gb3IgdW5saXN0ZWQgbmFtZXNwYWNlZCBlbGVtZW50cwogICAgICAgIC8vIGNoZWNrIGF0IHJ1bnRpbWUgYmVjYXVzZSBpdCBtYXkgZ2V0IGFzc2lnbmVkIGEgbmFtZXNwYWNlIHdoZW4gaXRzCiAgICAgICAgLy8gcGFyZW50IG5vcm1hbGl6ZXMgY2hpbGRyZW4KICAgICAgICB2bm9kZSA9IG5ldyBWTm9kZSgKICAgICAgICAgIHRhZywgZGF0YSwgY2hpbGRyZW4sCiAgICAgICAgICB1bmRlZmluZWQsIHVuZGVmaW5lZCwgY29udGV4dAogICAgICAgICk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIGRpcmVjdCBjb21wb25lbnQgb3B0aW9ucyAvIGNvbnN0cnVjdG9yCiAgICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KHRhZywgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4pOwogICAgfQogICAgaWYgKEFycmF5LmlzQXJyYXkodm5vZGUpKSB7CiAgICAgIHJldHVybiB2bm9kZQogICAgfSBlbHNlIGlmIChpc0RlZih2bm9kZSkpIHsKICAgICAgaWYgKGlzRGVmKG5zKSkgeyBhcHBseU5TKHZub2RlLCBucyk7IH0KICAgICAgaWYgKGlzRGVmKGRhdGEpKSB7IHJlZ2lzdGVyRGVlcEJpbmRpbmdzKGRhdGEpOyB9CiAgICAgIHJldHVybiB2bm9kZQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNyZWF0ZUVtcHR5Vk5vZGUoKQogICAgfQogIH0KCiAgZnVuY3Rpb24gYXBwbHlOUyAodm5vZGUsIG5zLCBmb3JjZSkgewogICAgdm5vZGUubnMgPSBuczsKICAgIGlmICh2bm9kZS50YWcgPT09ICdmb3JlaWduT2JqZWN0JykgewogICAgICAvLyB1c2UgZGVmYXVsdCBuYW1lc3BhY2UgaW5zaWRlIGZvcmVpZ25PYmplY3QKICAgICAgbnMgPSB1bmRlZmluZWQ7CiAgICAgIGZvcmNlID0gdHJ1ZTsKICAgIH0KICAgIGlmIChpc0RlZih2bm9kZS5jaGlsZHJlbikpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2bm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2YXIgY2hpbGQgPSB2bm9kZS5jaGlsZHJlbltpXTsKICAgICAgICBpZiAoaXNEZWYoY2hpbGQudGFnKSAmJiAoCiAgICAgICAgICBpc1VuZGVmKGNoaWxkLm5zKSB8fCAoaXNUcnVlKGZvcmNlKSAmJiBjaGlsZC50YWcgIT09ICdzdmcnKSkpIHsKICAgICAgICAgIGFwcGx5TlMoY2hpbGQsIG5zLCBmb3JjZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICAvLyByZWYgIzUzMTgKICAvLyBuZWNlc3NhcnkgdG8gZW5zdXJlIHBhcmVudCByZS1yZW5kZXIgd2hlbiBkZWVwIGJpbmRpbmdzIGxpa2UgOnN0eWxlIGFuZAogIC8vIDpjbGFzcyBhcmUgdXNlZCBvbiBzbG90IG5vZGVzCiAgZnVuY3Rpb24gcmVnaXN0ZXJEZWVwQmluZGluZ3MgKGRhdGEpIHsKICAgIGlmIChpc09iamVjdChkYXRhLnN0eWxlKSkgewogICAgICB0cmF2ZXJzZShkYXRhLnN0eWxlKTsKICAgIH0KICAgIGlmIChpc09iamVjdChkYXRhLmNsYXNzKSkgewogICAgICB0cmF2ZXJzZShkYXRhLmNsYXNzKTsKICAgIH0KICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBpbml0UmVuZGVyICh2bSkgewogICAgdm0uX3Zub2RlID0gbnVsbDsgLy8gdGhlIHJvb3Qgb2YgdGhlIGNoaWxkIHRyZWUKICAgIHZtLl9zdGF0aWNUcmVlcyA9IG51bGw7IC8vIHYtb25jZSBjYWNoZWQgdHJlZXMKICAgIHZhciBvcHRpb25zID0gdm0uJG9wdGlvbnM7CiAgICB2YXIgcGFyZW50Vm5vZGUgPSB2bS4kdm5vZGUgPSBvcHRpb25zLl9wYXJlbnRWbm9kZTsgLy8gdGhlIHBsYWNlaG9sZGVyIG5vZGUgaW4gcGFyZW50IHRyZWUKICAgIHZhciByZW5kZXJDb250ZXh0ID0gcGFyZW50Vm5vZGUgJiYgcGFyZW50Vm5vZGUuY29udGV4dDsKICAgIHZtLiRzbG90cyA9IHJlc29sdmVTbG90cyhvcHRpb25zLl9yZW5kZXJDaGlsZHJlbiwgcmVuZGVyQ29udGV4dCk7CiAgICB2bS4kc2NvcGVkU2xvdHMgPSBlbXB0eU9iamVjdDsKICAgIC8vIGJpbmQgdGhlIGNyZWF0ZUVsZW1lbnQgZm4gdG8gdGhpcyBpbnN0YW5jZQogICAgLy8gc28gdGhhdCB3ZSBnZXQgcHJvcGVyIHJlbmRlciBjb250ZXh0IGluc2lkZSBpdC4KICAgIC8vIGFyZ3Mgb3JkZXI6IHRhZywgZGF0YSwgY2hpbGRyZW4sIG5vcm1hbGl6YXRpb25UeXBlLCBhbHdheXNOb3JtYWxpemUKICAgIC8vIGludGVybmFsIHZlcnNpb24gaXMgdXNlZCBieSByZW5kZXIgZnVuY3Rpb25zIGNvbXBpbGVkIGZyb20gdGVtcGxhdGVzCiAgICB2bS5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7IHJldHVybiBjcmVhdGVFbGVtZW50KHZtLCBhLCBiLCBjLCBkLCBmYWxzZSk7IH07CiAgICAvLyBub3JtYWxpemF0aW9uIGlzIGFsd2F5cyBhcHBsaWVkIGZvciB0aGUgcHVibGljIHZlcnNpb24sIHVzZWQgaW4KICAgIC8vIHVzZXItd3JpdHRlbiByZW5kZXIgZnVuY3Rpb25zLgogICAgdm0uJGNyZWF0ZUVsZW1lbnQgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgeyByZXR1cm4gY3JlYXRlRWxlbWVudCh2bSwgYSwgYiwgYywgZCwgdHJ1ZSk7IH07CgogICAgLy8gJGF0dHJzICYgJGxpc3RlbmVycyBhcmUgZXhwb3NlZCBmb3IgZWFzaWVyIEhPQyBjcmVhdGlvbi4KICAgIC8vIHRoZXkgbmVlZCB0byBiZSByZWFjdGl2ZSBzbyB0aGF0IEhPQ3MgdXNpbmcgdGhlbSBhcmUgYWx3YXlzIHVwZGF0ZWQKICAgIHZhciBwYXJlbnREYXRhID0gcGFyZW50Vm5vZGUgJiYgcGFyZW50Vm5vZGUuZGF0YTsKCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgewogICAgICBkZWZpbmVSZWFjdGl2ZSQkMSh2bSwgJyRhdHRycycsIHBhcmVudERhdGEgJiYgcGFyZW50RGF0YS5hdHRycyB8fCBlbXB0eU9iamVjdCwgZnVuY3Rpb24gKCkgewogICAgICAgICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgJiYgd2FybigiJGF0dHJzIGlzIHJlYWRvbmx5LiIsIHZtKTsKICAgICAgfSwgdHJ1ZSk7CiAgICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCAnJGxpc3RlbmVycycsIG9wdGlvbnMuX3BhcmVudExpc3RlbmVycyB8fCBlbXB0eU9iamVjdCwgZnVuY3Rpb24gKCkgewogICAgICAgICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQgJiYgd2FybigiJGxpc3RlbmVycyBpcyByZWFkb25seS4iLCB2bSk7CiAgICAgIH0sIHRydWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVuZGVyTWl4aW4gKFZ1ZSkgewogICAgLy8gaW5zdGFsbCBydW50aW1lIGNvbnZlbmllbmNlIGhlbHBlcnMKICAgIGluc3RhbGxSZW5kZXJIZWxwZXJzKFZ1ZS5wcm90b3R5cGUpOwoKICAgIFZ1ZS5wcm90b3R5cGUuJG5leHRUaWNrID0gZnVuY3Rpb24gKGZuKSB7CiAgICAgIHJldHVybiBuZXh0VGljayhmbiwgdGhpcykKICAgIH07CgogICAgVnVlLnByb3RvdHlwZS5fcmVuZGVyID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgdm0gPSB0aGlzOwogICAgICB2YXIgcmVmID0gdm0uJG9wdGlvbnM7CiAgICAgIHZhciByZW5kZXIgPSByZWYucmVuZGVyOwogICAgICB2YXIgX3BhcmVudFZub2RlID0gcmVmLl9wYXJlbnRWbm9kZTsKCiAgICAgIGlmIChfcGFyZW50Vm5vZGUpIHsKICAgICAgICB2bS4kc2NvcGVkU2xvdHMgPSBfcGFyZW50Vm5vZGUuZGF0YS5zY29wZWRTbG90cyB8fCBlbXB0eU9iamVjdDsKICAgICAgfQoKICAgICAgLy8gc2V0IHBhcmVudCB2bm9kZS4gdGhpcyBhbGxvd3MgcmVuZGVyIGZ1bmN0aW9ucyB0byBoYXZlIGFjY2VzcwogICAgICAvLyB0byB0aGUgZGF0YSBvbiB0aGUgcGxhY2Vob2xkZXIgbm9kZS4KICAgICAgdm0uJHZub2RlID0gX3BhcmVudFZub2RlOwogICAgICAvLyByZW5kZXIgc2VsZgogICAgICB2YXIgdm5vZGU7CiAgICAgIHRyeSB7CiAgICAgICAgdm5vZGUgPSByZW5kZXIuY2FsbCh2bS5fcmVuZGVyUHJveHksIHZtLiRjcmVhdGVFbGVtZW50KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGhhbmRsZUVycm9yKGUsIHZtLCAicmVuZGVyIik7CiAgICAgICAgLy8gcmV0dXJuIGVycm9yIHJlbmRlciByZXN1bHQsCiAgICAgICAgLy8gb3IgcHJldmlvdXMgdm5vZGUgdG8gcHJldmVudCByZW5kZXIgZXJyb3IgY2F1c2luZyBibGFuayBjb21wb25lbnQKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgICAgIGlmICh2bS4kb3B0aW9ucy5yZW5kZXJFcnJvcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdm5vZGUgPSB2bS4kb3B0aW9ucy5yZW5kZXJFcnJvci5jYWxsKHZtLl9yZW5kZXJQcm94eSwgdm0uJGNyZWF0ZUVsZW1lbnQsIGUpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBoYW5kbGVFcnJvcihlLCB2bSwgInJlbmRlckVycm9yIik7CiAgICAgICAgICAgIHZub2RlID0gdm0uX3Zub2RlOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2bm9kZSA9IHZtLl92bm9kZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gcmV0dXJuIGVtcHR5IHZub2RlIGluIGNhc2UgdGhlIHJlbmRlciBmdW5jdGlvbiBlcnJvcmVkIG91dAogICAgICBpZiAoISh2bm9kZSBpbnN0YW5jZW9mIFZOb2RlKSkgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZub2RlKSkgewogICAgICAgICAgd2FybigKICAgICAgICAgICAgJ011bHRpcGxlIHJvb3Qgbm9kZXMgcmV0dXJuZWQgZnJvbSByZW5kZXIgZnVuY3Rpb24uIFJlbmRlciBmdW5jdGlvbiAnICsKICAgICAgICAgICAgJ3Nob3VsZCByZXR1cm4gYSBzaW5nbGUgcm9vdCBub2RlLicsCiAgICAgICAgICAgIHZtCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICB2bm9kZSA9IGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICAgICAgfQogICAgICAvLyBzZXQgcGFyZW50CiAgICAgIHZub2RlLnBhcmVudCA9IF9wYXJlbnRWbm9kZTsKICAgICAgcmV0dXJuIHZub2RlCiAgICB9OwogIH0KCiAgLyogICovCgogIHZhciB1aWQkMyA9IDA7CgogIGZ1bmN0aW9uIGluaXRNaXhpbiAoVnVlKSB7CiAgICBWdWUucHJvdG90eXBlLl9pbml0ID0gZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgdmFyIHZtID0gdGhpczsKICAgICAgLy8gYSB1aWQKICAgICAgdm0uX3VpZCA9IHVpZCQzKys7CgogICAgICB2YXIgc3RhcnRUYWcsIGVuZFRhZzsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmIChjb25maWcucGVyZm9ybWFuY2UgJiYgbWFyaykgewogICAgICAgIHN0YXJ0VGFnID0gInZ1ZS1wZXJmLXN0YXJ0OiIgKyAodm0uX3VpZCk7CiAgICAgICAgZW5kVGFnID0gInZ1ZS1wZXJmLWVuZDoiICsgKHZtLl91aWQpOwogICAgICAgIG1hcmsoc3RhcnRUYWcpOwogICAgICB9CgogICAgICAvLyBhIGZsYWcgdG8gYXZvaWQgdGhpcyBiZWluZyBvYnNlcnZlZAogICAgICB2bS5faXNWdWUgPSB0cnVlOwogICAgICAvLyBtZXJnZSBvcHRpb25zCiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuX2lzQ29tcG9uZW50KSB7CiAgICAgICAgLy8gb3B0aW1pemUgaW50ZXJuYWwgY29tcG9uZW50IGluc3RhbnRpYXRpb24KICAgICAgICAvLyBzaW5jZSBkeW5hbWljIG9wdGlvbnMgbWVyZ2luZyBpcyBwcmV0dHkgc2xvdywgYW5kIG5vbmUgb2YgdGhlCiAgICAgICAgLy8gaW50ZXJuYWwgY29tcG9uZW50IG9wdGlvbnMgbmVlZHMgc3BlY2lhbCB0cmVhdG1lbnQuCiAgICAgICAgaW5pdEludGVybmFsQ29tcG9uZW50KHZtLCBvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2bS4kb3B0aW9ucyA9IG1lcmdlT3B0aW9ucygKICAgICAgICAgIHJlc29sdmVDb25zdHJ1Y3Rvck9wdGlvbnModm0uY29uc3RydWN0b3IpLAogICAgICAgICAgb3B0aW9ucyB8fCB7fSwKICAgICAgICAgIHZtCiAgICAgICAgKTsKICAgICAgfQogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgICB7CiAgICAgICAgaW5pdFByb3h5KHZtKTsKICAgICAgfQogICAgICAvLyBleHBvc2UgcmVhbCBzZWxmCiAgICAgIHZtLl9zZWxmID0gdm07CiAgICAgIGluaXRMaWZlY3ljbGUodm0pOwogICAgICBpbml0RXZlbnRzKHZtKTsKICAgICAgaW5pdFJlbmRlcih2bSk7CiAgICAgIGNhbGxIb29rKHZtLCAnYmVmb3JlQ3JlYXRlJyk7CiAgICAgIGluaXRJbmplY3Rpb25zKHZtKTsgLy8gcmVzb2x2ZSBpbmplY3Rpb25zIGJlZm9yZSBkYXRhL3Byb3BzCiAgICAgIGluaXRTdGF0ZSh2bSk7CiAgICAgIGluaXRQcm92aWRlKHZtKTsgLy8gcmVzb2x2ZSBwcm92aWRlIGFmdGVyIGRhdGEvcHJvcHMKICAgICAgY2FsbEhvb2sodm0sICdjcmVhdGVkJyk7CgogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKGNvbmZpZy5wZXJmb3JtYW5jZSAmJiBtYXJrKSB7CiAgICAgICAgdm0uX25hbWUgPSBmb3JtYXRDb21wb25lbnROYW1lKHZtLCBmYWxzZSk7CiAgICAgICAgbWFyayhlbmRUYWcpOwogICAgICAgIG1lYXN1cmUoKCJ2dWUgIiArICh2bS5fbmFtZSkgKyAiIGluaXQiKSwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICAgIH0KCiAgICAgIGlmICh2bS4kb3B0aW9ucy5lbCkgewogICAgICAgIHZtLiRtb3VudCh2bS4kb3B0aW9ucy5lbCk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBpbml0SW50ZXJuYWxDb21wb25lbnQgKHZtLCBvcHRpb25zKSB7CiAgICB2YXIgb3B0cyA9IHZtLiRvcHRpb25zID0gT2JqZWN0LmNyZWF0ZSh2bS5jb25zdHJ1Y3Rvci5vcHRpb25zKTsKICAgIC8vIGRvaW5nIHRoaXMgYmVjYXVzZSBpdCdzIGZhc3RlciB0aGFuIGR5bmFtaWMgZW51bWVyYXRpb24uCiAgICB2YXIgcGFyZW50Vm5vZGUgPSBvcHRpb25zLl9wYXJlbnRWbm9kZTsKICAgIG9wdHMucGFyZW50ID0gb3B0aW9ucy5wYXJlbnQ7CiAgICBvcHRzLl9wYXJlbnRWbm9kZSA9IHBhcmVudFZub2RlOwoKICAgIHZhciB2bm9kZUNvbXBvbmVudE9wdGlvbnMgPSBwYXJlbnRWbm9kZS5jb21wb25lbnRPcHRpb25zOwogICAgb3B0cy5wcm9wc0RhdGEgPSB2bm9kZUNvbXBvbmVudE9wdGlvbnMucHJvcHNEYXRhOwogICAgb3B0cy5fcGFyZW50TGlzdGVuZXJzID0gdm5vZGVDb21wb25lbnRPcHRpb25zLmxpc3RlbmVyczsKICAgIG9wdHMuX3JlbmRlckNoaWxkcmVuID0gdm5vZGVDb21wb25lbnRPcHRpb25zLmNoaWxkcmVuOwogICAgb3B0cy5fY29tcG9uZW50VGFnID0gdm5vZGVDb21wb25lbnRPcHRpb25zLnRhZzsKCiAgICBpZiAob3B0aW9ucy5yZW5kZXIpIHsKICAgICAgb3B0cy5yZW5kZXIgPSBvcHRpb25zLnJlbmRlcjsKICAgICAgb3B0cy5zdGF0aWNSZW5kZXJGbnMgPSBvcHRpb25zLnN0YXRpY1JlbmRlckZuczsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlc29sdmVDb25zdHJ1Y3Rvck9wdGlvbnMgKEN0b3IpIHsKICAgIHZhciBvcHRpb25zID0gQ3Rvci5vcHRpb25zOwogICAgaWYgKEN0b3Iuc3VwZXIpIHsKICAgICAgdmFyIHN1cGVyT3B0aW9ucyA9IHJlc29sdmVDb25zdHJ1Y3Rvck9wdGlvbnMoQ3Rvci5zdXBlcik7CiAgICAgIHZhciBjYWNoZWRTdXBlck9wdGlvbnMgPSBDdG9yLnN1cGVyT3B0aW9uczsKICAgICAgaWYgKHN1cGVyT3B0aW9ucyAhPT0gY2FjaGVkU3VwZXJPcHRpb25zKSB7CiAgICAgICAgLy8gc3VwZXIgb3B0aW9uIGNoYW5nZWQsCiAgICAgICAgLy8gbmVlZCB0byByZXNvbHZlIG5ldyBvcHRpb25zLgogICAgICAgIEN0b3Iuc3VwZXJPcHRpb25zID0gc3VwZXJPcHRpb25zOwogICAgICAgIC8vIGNoZWNrIGlmIHRoZXJlIGFyZSBhbnkgbGF0ZS1tb2RpZmllZC9hdHRhY2hlZCBvcHRpb25zICgjNDk3NikKICAgICAgICB2YXIgbW9kaWZpZWRPcHRpb25zID0gcmVzb2x2ZU1vZGlmaWVkT3B0aW9ucyhDdG9yKTsKICAgICAgICAvLyB1cGRhdGUgYmFzZSBleHRlbmQgb3B0aW9ucwogICAgICAgIGlmIChtb2RpZmllZE9wdGlvbnMpIHsKICAgICAgICAgIGV4dGVuZChDdG9yLmV4dGVuZE9wdGlvbnMsIG1vZGlmaWVkT3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnMgPSBtZXJnZU9wdGlvbnMoc3VwZXJPcHRpb25zLCBDdG9yLmV4dGVuZE9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLm5hbWUpIHsKICAgICAgICAgIG9wdGlvbnMuY29tcG9uZW50c1tvcHRpb25zLm5hbWVdID0gQ3RvcjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvcHRpb25zCiAgfQoKICBmdW5jdGlvbiByZXNvbHZlTW9kaWZpZWRPcHRpb25zIChDdG9yKSB7CiAgICB2YXIgbW9kaWZpZWQ7CiAgICB2YXIgbGF0ZXN0ID0gQ3Rvci5vcHRpb25zOwogICAgdmFyIGV4dGVuZGVkID0gQ3Rvci5leHRlbmRPcHRpb25zOwogICAgdmFyIHNlYWxlZCA9IEN0b3Iuc2VhbGVkT3B0aW9uczsKICAgIGZvciAodmFyIGtleSBpbiBsYXRlc3QpIHsKICAgICAgaWYgKGxhdGVzdFtrZXldICE9PSBzZWFsZWRba2V5XSkgewogICAgICAgIGlmICghbW9kaWZpZWQpIHsgbW9kaWZpZWQgPSB7fTsgfQogICAgICAgIG1vZGlmaWVkW2tleV0gPSBkZWR1cGUobGF0ZXN0W2tleV0sIGV4dGVuZGVkW2tleV0sIHNlYWxlZFtrZXldKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG1vZGlmaWVkCiAgfQoKICBmdW5jdGlvbiBkZWR1cGUgKGxhdGVzdCwgZXh0ZW5kZWQsIHNlYWxlZCkgewogICAgLy8gY29tcGFyZSBsYXRlc3QgYW5kIHNlYWxlZCB0byBlbnN1cmUgbGlmZWN5Y2xlIGhvb2tzIHdvbid0IGJlIGR1cGxpY2F0ZWQKICAgIC8vIGJldHdlZW4gbWVyZ2VzCiAgICBpZiAoQXJyYXkuaXNBcnJheShsYXRlc3QpKSB7CiAgICAgIHZhciByZXMgPSBbXTsKICAgICAgc2VhbGVkID0gQXJyYXkuaXNBcnJheShzZWFsZWQpID8gc2VhbGVkIDogW3NlYWxlZF07CiAgICAgIGV4dGVuZGVkID0gQXJyYXkuaXNBcnJheShleHRlbmRlZCkgPyBleHRlbmRlZCA6IFtleHRlbmRlZF07CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGF0ZXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgLy8gcHVzaCBvcmlnaW5hbCBvcHRpb25zIGFuZCBub3Qgc2VhbGVkIG9wdGlvbnMgdG8gZXhjbHVkZSBkdXBsaWNhdGVkIG9wdGlvbnMKICAgICAgICBpZiAoZXh0ZW5kZWQuaW5kZXhPZihsYXRlc3RbaV0pID49IDAgfHwgc2VhbGVkLmluZGV4T2YobGF0ZXN0W2ldKSA8IDApIHsKICAgICAgICAgIHJlcy5wdXNoKGxhdGVzdFtpXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXMKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBsYXRlc3QKICAgIH0KICB9CgogIGZ1bmN0aW9uIFZ1ZSAob3B0aW9ucykgewogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFZ1ZSkKICAgICkgewogICAgICB3YXJuKCdWdWUgaXMgYSBjb25zdHJ1Y3RvciBhbmQgc2hvdWxkIGJlIGNhbGxlZCB3aXRoIHRoZSBgbmV3YCBrZXl3b3JkJyk7CiAgICB9CiAgICB0aGlzLl9pbml0KG9wdGlvbnMpOwogIH0KCiAgaW5pdE1peGluKFZ1ZSk7CiAgc3RhdGVNaXhpbihWdWUpOwogIGV2ZW50c01peGluKFZ1ZSk7CiAgbGlmZWN5Y2xlTWl4aW4oVnVlKTsKICByZW5kZXJNaXhpbihWdWUpOwoKICAvKiAgKi8KCiAgZnVuY3Rpb24gaW5pdFVzZSAoVnVlKSB7CiAgICBWdWUudXNlID0gZnVuY3Rpb24gKHBsdWdpbikgewogICAgICB2YXIgaW5zdGFsbGVkUGx1Z2lucyA9ICh0aGlzLl9pbnN0YWxsZWRQbHVnaW5zIHx8ICh0aGlzLl9pbnN0YWxsZWRQbHVnaW5zID0gW10pKTsKICAgICAgaWYgKGluc3RhbGxlZFBsdWdpbnMuaW5kZXhPZihwbHVnaW4pID4gLTEpIHsKICAgICAgICByZXR1cm4gdGhpcwogICAgICB9CgogICAgICAvLyBhZGRpdGlvbmFsIHBhcmFtZXRlcnMKICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cywgMSk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzKTsKICAgICAgaWYgKHR5cGVvZiBwbHVnaW4uaW5zdGFsbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHBsdWdpbi5pbnN0YWxsLmFwcGx5KHBsdWdpbiwgYXJncyk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHBsdWdpbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHBsdWdpbi5hcHBseShudWxsLCBhcmdzKTsKICAgICAgfQogICAgICBpbnN0YWxsZWRQbHVnaW5zLnB1c2gocGx1Z2luKTsKICAgICAgcmV0dXJuIHRoaXMKICAgIH07CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gaW5pdE1peGluJDEgKFZ1ZSkgewogICAgVnVlLm1peGluID0gZnVuY3Rpb24gKG1peGluKSB7CiAgICAgIHRoaXMub3B0aW9ucyA9IG1lcmdlT3B0aW9ucyh0aGlzLm9wdGlvbnMsIG1peGluKTsKICAgICAgcmV0dXJuIHRoaXMKICAgIH07CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gaW5pdEV4dGVuZCAoVnVlKSB7CiAgICAvKioKICAgICAqIEVhY2ggaW5zdGFuY2UgY29uc3RydWN0b3IsIGluY2x1ZGluZyBWdWUsIGhhcyBhIHVuaXF1ZQogICAgICogY2lkLiBUaGlzIGVuYWJsZXMgdXMgdG8gY3JlYXRlIHdyYXBwZWQgImNoaWxkCiAgICAgKiBjb25zdHJ1Y3RvcnMiIGZvciBwcm90b3R5cGFsIGluaGVyaXRhbmNlIGFuZCBjYWNoZSB0aGVtLgogICAgICovCiAgICBWdWUuY2lkID0gMDsKICAgIHZhciBjaWQgPSAxOwoKICAgIC8qKgogICAgICogQ2xhc3MgaW5oZXJpdGFuY2UKICAgICAqLwogICAgVnVlLmV4dGVuZCA9IGZ1bmN0aW9uIChleHRlbmRPcHRpb25zKSB7CiAgICAgIGV4dGVuZE9wdGlvbnMgPSBleHRlbmRPcHRpb25zIHx8IHt9OwogICAgICB2YXIgU3VwZXIgPSB0aGlzOwogICAgICB2YXIgU3VwZXJJZCA9IFN1cGVyLmNpZDsKICAgICAgdmFyIGNhY2hlZEN0b3JzID0gZXh0ZW5kT3B0aW9ucy5fQ3RvciB8fCAoZXh0ZW5kT3B0aW9ucy5fQ3RvciA9IHt9KTsKICAgICAgaWYgKGNhY2hlZEN0b3JzW1N1cGVySWRdKSB7CiAgICAgICAgcmV0dXJuIGNhY2hlZEN0b3JzW1N1cGVySWRdCiAgICAgIH0KCiAgICAgIHZhciBuYW1lID0gZXh0ZW5kT3B0aW9ucy5uYW1lIHx8IFN1cGVyLm9wdGlvbnMubmFtZTsKICAgICAgaWYgKG5hbWUpIHsKICAgICAgICB2YWxpZGF0ZUNvbXBvbmVudE5hbWUobmFtZSk7CiAgICAgIH0KCiAgICAgIHZhciBTdWIgPSBmdW5jdGlvbiBWdWVDb21wb25lbnQgKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLl9pbml0KG9wdGlvbnMpOwogICAgICB9OwogICAgICBTdWIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdXBlci5wcm90b3R5cGUpOwogICAgICBTdWIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gU3ViOwogICAgICBTdWIuY2lkID0gY2lkKys7CiAgICAgIFN1Yi5vcHRpb25zID0gbWVyZ2VPcHRpb25zKAogICAgICAgIFN1cGVyLm9wdGlvbnMsCiAgICAgICAgZXh0ZW5kT3B0aW9ucwogICAgICApOwogICAgICBTdWJbJ3N1cGVyJ10gPSBTdXBlcjsKCiAgICAgIC8vIEZvciBwcm9wcyBhbmQgY29tcHV0ZWQgcHJvcGVydGllcywgd2UgZGVmaW5lIHRoZSBwcm94eSBnZXR0ZXJzIG9uCiAgICAgIC8vIHRoZSBWdWUgaW5zdGFuY2VzIGF0IGV4dGVuc2lvbiB0aW1lLCBvbiB0aGUgZXh0ZW5kZWQgcHJvdG90eXBlLiBUaGlzCiAgICAgIC8vIGF2b2lkcyBPYmplY3QuZGVmaW5lUHJvcGVydHkgY2FsbHMgZm9yIGVhY2ggaW5zdGFuY2UgY3JlYXRlZC4KICAgICAgaWYgKFN1Yi5vcHRpb25zLnByb3BzKSB7CiAgICAgICAgaW5pdFByb3BzJDEoU3ViKTsKICAgICAgfQogICAgICBpZiAoU3ViLm9wdGlvbnMuY29tcHV0ZWQpIHsKICAgICAgICBpbml0Q29tcHV0ZWQkMShTdWIpOwogICAgICB9CgogICAgICAvLyBhbGxvdyBmdXJ0aGVyIGV4dGVuc2lvbi9taXhpbi9wbHVnaW4gdXNhZ2UKICAgICAgU3ViLmV4dGVuZCA9IFN1cGVyLmV4dGVuZDsKICAgICAgU3ViLm1peGluID0gU3VwZXIubWl4aW47CiAgICAgIFN1Yi51c2UgPSBTdXBlci51c2U7CgogICAgICAvLyBjcmVhdGUgYXNzZXQgcmVnaXN0ZXJzLCBzbyBleHRlbmRlZCBjbGFzc2VzCiAgICAgIC8vIGNhbiBoYXZlIHRoZWlyIHByaXZhdGUgYXNzZXRzIHRvby4KICAgICAgQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogICAgICAgIFN1Ylt0eXBlXSA9IFN1cGVyW3R5cGVdOwogICAgICB9KTsKICAgICAgLy8gZW5hYmxlIHJlY3Vyc2l2ZSBzZWxmLWxvb2t1cAogICAgICBpZiAobmFtZSkgewogICAgICAgIFN1Yi5vcHRpb25zLmNvbXBvbmVudHNbbmFtZV0gPSBTdWI7CiAgICAgIH0KCiAgICAgIC8vIGtlZXAgYSByZWZlcmVuY2UgdG8gdGhlIHN1cGVyIG9wdGlvbnMgYXQgZXh0ZW5zaW9uIHRpbWUuCiAgICAgIC8vIGxhdGVyIGF0IGluc3RhbnRpYXRpb24gd2UgY2FuIGNoZWNrIGlmIFN1cGVyJ3Mgb3B0aW9ucyBoYXZlCiAgICAgIC8vIGJlZW4gdXBkYXRlZC4KICAgICAgU3ViLnN1cGVyT3B0aW9ucyA9IFN1cGVyLm9wdGlvbnM7CiAgICAgIFN1Yi5leHRlbmRPcHRpb25zID0gZXh0ZW5kT3B0aW9uczsKICAgICAgU3ViLnNlYWxlZE9wdGlvbnMgPSBleHRlbmQoe30sIFN1Yi5vcHRpb25zKTsKCiAgICAgIC8vIGNhY2hlIGNvbnN0cnVjdG9yCiAgICAgIGNhY2hlZEN0b3JzW1N1cGVySWRdID0gU3ViOwogICAgICByZXR1cm4gU3ViCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gaW5pdFByb3BzJDEgKENvbXApIHsKICAgIHZhciBwcm9wcyA9IENvbXAub3B0aW9ucy5wcm9wczsKICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgICBwcm94eShDb21wLnByb3RvdHlwZSwgIl9wcm9wcyIsIGtleSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpbml0Q29tcHV0ZWQkMSAoQ29tcCkgewogICAgdmFyIGNvbXB1dGVkID0gQ29tcC5vcHRpb25zLmNvbXB1dGVkOwogICAgZm9yICh2YXIga2V5IGluIGNvbXB1dGVkKSB7CiAgICAgIGRlZmluZUNvbXB1dGVkKENvbXAucHJvdG90eXBlLCBrZXksIGNvbXB1dGVkW2tleV0pOwogICAgfQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGluaXRBc3NldFJlZ2lzdGVycyAoVnVlKSB7CiAgICAvKioKICAgICAqIENyZWF0ZSBhc3NldCByZWdpc3RyYXRpb24gbWV0aG9kcy4KICAgICAqLwogICAgQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogICAgICBWdWVbdHlwZV0gPSBmdW5jdGlvbiAoCiAgICAgICAgaWQsCiAgICAgICAgZGVmaW5pdGlvbgogICAgICApIHsKICAgICAgICBpZiAoIWRlZmluaXRpb24pIHsKICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnNbdHlwZSArICdzJ11baWRdCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgICAgaWYgKHR5cGUgPT09ICdjb21wb25lbnQnKSB7CiAgICAgICAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShpZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSA9PT0gJ2NvbXBvbmVudCcgJiYgaXNQbGFpbk9iamVjdChkZWZpbml0aW9uKSkgewogICAgICAgICAgICBkZWZpbml0aW9uLm5hbWUgPSBkZWZpbml0aW9uLm5hbWUgfHwgaWQ7CiAgICAgICAgICAgIGRlZmluaXRpb24gPSB0aGlzLm9wdGlvbnMuX2Jhc2UuZXh0ZW5kKGRlZmluaXRpb24pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09ICdkaXJlY3RpdmUnICYmIHR5cGVvZiBkZWZpbml0aW9uID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGRlZmluaXRpb24gPSB7IGJpbmQ6IGRlZmluaXRpb24sIHVwZGF0ZTogZGVmaW5pdGlvbiB9OwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5vcHRpb25zW3R5cGUgKyAncyddW2lkXSA9IGRlZmluaXRpb247CiAgICAgICAgICByZXR1cm4gZGVmaW5pdGlvbgogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH0KCiAgLyogICovCgoKCiAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZSAob3B0cykgewogICAgcmV0dXJuIG9wdHMgJiYgKG9wdHMuQ3Rvci5vcHRpb25zLm5hbWUgfHwgb3B0cy50YWcpCiAgfQoKICBmdW5jdGlvbiBtYXRjaGVzIChwYXR0ZXJuLCBuYW1lKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShwYXR0ZXJuKSkgewogICAgICByZXR1cm4gcGF0dGVybi5pbmRleE9mKG5hbWUpID4gLTEKICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhdHRlcm4gPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBwYXR0ZXJuLnNwbGl0KCcsJykuaW5kZXhPZihuYW1lKSA+IC0xCiAgICB9IGVsc2UgaWYgKGlzUmVnRXhwKHBhdHRlcm4pKSB7CiAgICAgIHJldHVybiBwYXR0ZXJuLnRlc3QobmFtZSkKICAgIH0KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICByZXR1cm4gZmFsc2UKICB9CgogIGZ1bmN0aW9uIHBydW5lQ2FjaGUgKGtlZXBBbGl2ZUluc3RhbmNlLCBmaWx0ZXIpIHsKICAgIHZhciBjYWNoZSA9IGtlZXBBbGl2ZUluc3RhbmNlLmNhY2hlOwogICAgdmFyIGtleXMgPSBrZWVwQWxpdmVJbnN0YW5jZS5rZXlzOwogICAgdmFyIF92bm9kZSA9IGtlZXBBbGl2ZUluc3RhbmNlLl92bm9kZTsKICAgIGZvciAodmFyIGtleSBpbiBjYWNoZSkgewogICAgICB2YXIgY2FjaGVkTm9kZSA9IGNhY2hlW2tleV07CiAgICAgIGlmIChjYWNoZWROb2RlKSB7CiAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lKGNhY2hlZE5vZGUuY29tcG9uZW50T3B0aW9ucyk7CiAgICAgICAgaWYgKG5hbWUgJiYgIWZpbHRlcihuYW1lKSkgewogICAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXksIGtleXMsIF92bm9kZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwcnVuZUNhY2hlRW50cnkgKAogICAgY2FjaGUsCiAgICBrZXksCiAgICBrZXlzLAogICAgY3VycmVudAogICkgewogICAgdmFyIGNhY2hlZCQkMSA9IGNhY2hlW2tleV07CiAgICBpZiAoY2FjaGVkJCQxICYmICghY3VycmVudCB8fCBjYWNoZWQkJDEudGFnICE9PSBjdXJyZW50LnRhZykpIHsKICAgICAgY2FjaGVkJCQxLmNvbXBvbmVudEluc3RhbmNlLiRkZXN0cm95KCk7CiAgICB9CiAgICBjYWNoZVtrZXldID0gbnVsbDsKICAgIHJlbW92ZShrZXlzLCBrZXkpOwogIH0KCiAgdmFyIHBhdHRlcm5UeXBlcyA9IFtTdHJpbmcsIFJlZ0V4cCwgQXJyYXldOwoKICB2YXIgS2VlcEFsaXZlID0gewogICAgbmFtZTogJ2tlZXAtYWxpdmUnLAogICAgYWJzdHJhY3Q6IHRydWUsCgogICAgcHJvcHM6IHsKICAgICAgaW5jbHVkZTogcGF0dGVyblR5cGVzLAogICAgICBleGNsdWRlOiBwYXR0ZXJuVHlwZXMsCiAgICAgIG1heDogW1N0cmluZywgTnVtYmVyXQogICAgfSwKCiAgICBjcmVhdGVkOiBmdW5jdGlvbiBjcmVhdGVkICgpIHsKICAgICAgdGhpcy5jYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMua2V5cyA9IFtdOwogICAgfSwKCiAgICBkZXN0cm95ZWQ6IGZ1bmN0aW9uIGRlc3Ryb3llZCAoKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmNhY2hlKSB7CiAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KHRoaXMuY2FjaGUsIGtleSwgdGhpcy5rZXlzKTsKICAgICAgfQogICAgfSwKCiAgICBtb3VudGVkOiBmdW5jdGlvbiBtb3VudGVkICgpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICB0aGlzLiR3YXRjaCgnaW5jbHVkZScsIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICBwcnVuZUNhY2hlKHRoaXMkMSwgZnVuY3Rpb24gKG5hbWUpIHsgcmV0dXJuIG1hdGNoZXModmFsLCBuYW1lKTsgfSk7CiAgICAgIH0pOwogICAgICB0aGlzLiR3YXRjaCgnZXhjbHVkZScsIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgICBwcnVuZUNhY2hlKHRoaXMkMSwgZnVuY3Rpb24gKG5hbWUpIHsgcmV0dXJuICFtYXRjaGVzKHZhbCwgbmFtZSk7IH0pOwogICAgICB9KTsKICAgIH0sCgogICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIgKCkgewogICAgICB2YXIgc2xvdCA9IHRoaXMuJHNsb3RzLmRlZmF1bHQ7CiAgICAgIHZhciB2bm9kZSA9IGdldEZpcnN0Q29tcG9uZW50Q2hpbGQoc2xvdCk7CiAgICAgIHZhciBjb21wb25lbnRPcHRpb25zID0gdm5vZGUgJiYgdm5vZGUuY29tcG9uZW50T3B0aW9uczsKICAgICAgaWYgKGNvbXBvbmVudE9wdGlvbnMpIHsKICAgICAgICAvLyBjaGVjayBwYXR0ZXJuCiAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lKGNvbXBvbmVudE9wdGlvbnMpOwogICAgICAgIHZhciByZWYgPSB0aGlzOwogICAgICAgIHZhciBpbmNsdWRlID0gcmVmLmluY2x1ZGU7CiAgICAgICAgdmFyIGV4Y2x1ZGUgPSByZWYuZXhjbHVkZTsKICAgICAgICBpZiAoCiAgICAgICAgICAvLyBub3QgaW5jbHVkZWQKICAgICAgICAgIChpbmNsdWRlICYmICghbmFtZSB8fCAhbWF0Y2hlcyhpbmNsdWRlLCBuYW1lKSkpIHx8CiAgICAgICAgICAvLyBleGNsdWRlZAogICAgICAgICAgKGV4Y2x1ZGUgJiYgbmFtZSAmJiBtYXRjaGVzKGV4Y2x1ZGUsIG5hbWUpKQogICAgICAgICkgewogICAgICAgICAgcmV0dXJuIHZub2RlCiAgICAgICAgfQoKICAgICAgICB2YXIgcmVmJDEgPSB0aGlzOwogICAgICAgIHZhciBjYWNoZSA9IHJlZiQxLmNhY2hlOwogICAgICAgIHZhciBrZXlzID0gcmVmJDEua2V5czsKICAgICAgICB2YXIga2V5ID0gdm5vZGUua2V5ID09IG51bGwKICAgICAgICAgIC8vIHNhbWUgY29uc3RydWN0b3IgbWF5IGdldCByZWdpc3RlcmVkIGFzIGRpZmZlcmVudCBsb2NhbCBjb21wb25lbnRzCiAgICAgICAgICAvLyBzbyBjaWQgYWxvbmUgaXMgbm90IGVub3VnaCAoIzMyNjkpCiAgICAgICAgICA/IGNvbXBvbmVudE9wdGlvbnMuQ3Rvci5jaWQgKyAoY29tcG9uZW50T3B0aW9ucy50YWcgPyAoIjo6IiArIChjb21wb25lbnRPcHRpb25zLnRhZykpIDogJycpCiAgICAgICAgICA6IHZub2RlLmtleTsKICAgICAgICBpZiAoY2FjaGVba2V5XSkgewogICAgICAgICAgdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgPSBjYWNoZVtrZXldLmNvbXBvbmVudEluc3RhbmNlOwogICAgICAgICAgLy8gbWFrZSBjdXJyZW50IGtleSBmcmVzaGVzdAogICAgICAgICAgcmVtb3ZlKGtleXMsIGtleSk7CiAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FjaGVba2V5XSA9IHZub2RlOwogICAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgICAgICAvLyBwcnVuZSBvbGRlc3QgZW50cnkKICAgICAgICAgIGlmICh0aGlzLm1heCAmJiBrZXlzLmxlbmd0aCA+IHBhcnNlSW50KHRoaXMubWF4KSkgewogICAgICAgICAgICBwcnVuZUNhY2hlRW50cnkoY2FjaGUsIGtleXNbMF0sIGtleXMsIHRoaXMuX3Zub2RlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZub2RlLmRhdGEua2VlcEFsaXZlID0gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gdm5vZGUgfHwgKHNsb3QgJiYgc2xvdFswXSkKICAgIH0KICB9OwoKICB2YXIgYnVpbHRJbkNvbXBvbmVudHMgPSB7CiAgICBLZWVwQWxpdmU6IEtlZXBBbGl2ZQogIH07CgogIC8qICAqLwoKICBmdW5jdGlvbiBpbml0R2xvYmFsQVBJIChWdWUpIHsKICAgIC8vIGNvbmZpZwogICAgdmFyIGNvbmZpZ0RlZiA9IHt9OwogICAgY29uZmlnRGVmLmdldCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGNvbmZpZzsgfTsKICAgIHsKICAgICAgY29uZmlnRGVmLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB3YXJuKAogICAgICAgICAgJ0RvIG5vdCByZXBsYWNlIHRoZSBWdWUuY29uZmlnIG9iamVjdCwgc2V0IGluZGl2aWR1YWwgZmllbGRzIGluc3RlYWQuJwogICAgICAgICk7CiAgICAgIH07CiAgICB9CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLCAnY29uZmlnJywgY29uZmlnRGVmKTsKCiAgICAvLyBleHBvc2VkIHV0aWwgbWV0aG9kcy4KICAgIC8vIE5PVEU6IHRoZXNlIGFyZSBub3QgY29uc2lkZXJlZCBwYXJ0IG9mIHRoZSBwdWJsaWMgQVBJIC0gYXZvaWQgcmVseWluZyBvbgogICAgLy8gdGhlbSB1bmxlc3MgeW91IGFyZSBhd2FyZSBvZiB0aGUgcmlzay4KICAgIFZ1ZS51dGlsID0gewogICAgICB3YXJuOiB3YXJuLAogICAgICBleHRlbmQ6IGV4dGVuZCwKICAgICAgbWVyZ2VPcHRpb25zOiBtZXJnZU9wdGlvbnMsCiAgICAgIGRlZmluZVJlYWN0aXZlOiBkZWZpbmVSZWFjdGl2ZSQkMQogICAgfTsKCiAgICBWdWUuc2V0ID0gc2V0OwogICAgVnVlLmRlbGV0ZSA9IGRlbDsKICAgIFZ1ZS5uZXh0VGljayA9IG5leHRUaWNrOwoKICAgIFZ1ZS5vcHRpb25zID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIEFTU0VUX1RZUEVTLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgVnVlLm9wdGlvbnNbdHlwZSArICdzJ10gPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgfSk7CgogICAgLy8gdGhpcyBpcyB1c2VkIHRvIGlkZW50aWZ5IHRoZSAiYmFzZSIgY29uc3RydWN0b3IgdG8gZXh0ZW5kIGFsbCBwbGFpbi1vYmplY3QKICAgIC8vIGNvbXBvbmVudHMgd2l0aCBpbiBXZWV4J3MgbXVsdGktaW5zdGFuY2Ugc2NlbmFyaW9zLgogICAgVnVlLm9wdGlvbnMuX2Jhc2UgPSBWdWU7CgogICAgZXh0ZW5kKFZ1ZS5vcHRpb25zLmNvbXBvbmVudHMsIGJ1aWx0SW5Db21wb25lbnRzKTsKCiAgICBpbml0VXNlKFZ1ZSk7CiAgICBpbml0TWl4aW4kMShWdWUpOwogICAgaW5pdEV4dGVuZChWdWUpOwogICAgaW5pdEFzc2V0UmVnaXN0ZXJzKFZ1ZSk7CiAgfQoKICBpbml0R2xvYmFsQVBJKFZ1ZSk7CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJGlzU2VydmVyJywgewogICAgZ2V0OiBpc1NlcnZlclJlbmRlcmluZwogIH0pOwoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLnByb3RvdHlwZSwgJyRzc3JDb250ZXh0JywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQgKCkgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICByZXR1cm4gdGhpcy4kdm5vZGUgJiYgdGhpcy4kdm5vZGUuc3NyQ29udGV4dAogICAgfQogIH0pOwoKICAvLyBleHBvc2UgRnVuY3Rpb25hbFJlbmRlckNvbnRleHQgZm9yIHNzciBydW50aW1lIGhlbHBlciBpbnN0YWxsYXRpb24KICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLCAnRnVuY3Rpb25hbFJlbmRlckNvbnRleHQnLCB7CiAgICB2YWx1ZTogRnVuY3Rpb25hbFJlbmRlckNvbnRleHQKICB9KTsKCiAgVnVlLnZlcnNpb24gPSAnMi41LjIxJzsKCiAgLyogICovCgogIC8vIHRoZXNlIGFyZSByZXNlcnZlZCBmb3Igd2ViIGJlY2F1c2UgdGhleSBhcmUgZGlyZWN0bHkgY29tcGlsZWQgYXdheQogIC8vIGR1cmluZyB0ZW1wbGF0ZSBjb21waWxhdGlvbgogIHZhciBpc1Jlc2VydmVkQXR0ciA9IG1ha2VNYXAoJ3N0eWxlLGNsYXNzJyk7CgogIC8vIGF0dHJpYnV0ZXMgdGhhdCBzaG91bGQgYmUgdXNpbmcgcHJvcHMgZm9yIGJpbmRpbmcKICB2YXIgYWNjZXB0VmFsdWUgPSBtYWtlTWFwKCdpbnB1dCx0ZXh0YXJlYSxvcHRpb24sc2VsZWN0LHByb2dyZXNzJyk7CiAgdmFyIG11c3RVc2VQcm9wID0gZnVuY3Rpb24gKHRhZywgdHlwZSwgYXR0cikgewogICAgcmV0dXJuICgKICAgICAgKGF0dHIgPT09ICd2YWx1ZScgJiYgYWNjZXB0VmFsdWUodGFnKSkgJiYgdHlwZSAhPT0gJ2J1dHRvbicgfHwKICAgICAgKGF0dHIgPT09ICdzZWxlY3RlZCcgJiYgdGFnID09PSAnb3B0aW9uJykgfHwKICAgICAgKGF0dHIgPT09ICdjaGVja2VkJyAmJiB0YWcgPT09ICdpbnB1dCcpIHx8CiAgICAgIChhdHRyID09PSAnbXV0ZWQnICYmIHRhZyA9PT0gJ3ZpZGVvJykKICAgICkKICB9OwoKICB2YXIgaXNFbnVtZXJhdGVkQXR0ciA9IG1ha2VNYXAoJ2NvbnRlbnRlZGl0YWJsZSxkcmFnZ2FibGUsc3BlbGxjaGVjaycpOwoKICB2YXIgaXNCb29sZWFuQXR0ciA9IG1ha2VNYXAoCiAgICAnYWxsb3dmdWxsc2NyZWVuLGFzeW5jLGF1dG9mb2N1cyxhdXRvcGxheSxjaGVja2VkLGNvbXBhY3QsY29udHJvbHMsZGVjbGFyZSwnICsKICAgICdkZWZhdWx0LGRlZmF1bHRjaGVja2VkLGRlZmF1bHRtdXRlZCxkZWZhdWx0c2VsZWN0ZWQsZGVmZXIsZGlzYWJsZWQsJyArCiAgICAnZW5hYmxlZCxmb3Jtbm92YWxpZGF0ZSxoaWRkZW4saW5kZXRlcm1pbmF0ZSxpbmVydCxpc21hcCxpdGVtc2NvcGUsbG9vcCxtdWx0aXBsZSwnICsKICAgICdtdXRlZCxub2hyZWYsbm9yZXNpemUsbm9zaGFkZSxub3ZhbGlkYXRlLG5vd3JhcCxvcGVuLHBhdXNlb25leGl0LHJlYWRvbmx5LCcgKwogICAgJ3JlcXVpcmVkLHJldmVyc2VkLHNjb3BlZCxzZWFtbGVzcyxzZWxlY3RlZCxzb3J0YWJsZSx0cmFuc2xhdGUsJyArCiAgICAndHJ1ZXNwZWVkLHR5cGVtdXN0bWF0Y2gsdmlzaWJsZScKICApOwoKICB2YXIgeGxpbmtOUyA9ICdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJzsKCiAgdmFyIGlzWGxpbmsgPSBmdW5jdGlvbiAobmFtZSkgewogICAgcmV0dXJuIG5hbWUuY2hhckF0KDUpID09PSAnOicgJiYgbmFtZS5zbGljZSgwLCA1KSA9PT0gJ3hsaW5rJwogIH07CgogIHZhciBnZXRYbGlua1Byb3AgPSBmdW5jdGlvbiAobmFtZSkgewogICAgcmV0dXJuIGlzWGxpbmsobmFtZSkgPyBuYW1lLnNsaWNlKDYsIG5hbWUubGVuZ3RoKSA6ICcnCiAgfTsKCiAgdmFyIGlzRmFsc3lBdHRyVmFsdWUgPSBmdW5jdGlvbiAodmFsKSB7CiAgICByZXR1cm4gdmFsID09IG51bGwgfHwgdmFsID09PSBmYWxzZQogIH07CgogIC8qICAqLwoKICBmdW5jdGlvbiBnZW5DbGFzc0ZvclZub2RlICh2bm9kZSkgewogICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgdmFyIHBhcmVudE5vZGUgPSB2bm9kZTsKICAgIHZhciBjaGlsZE5vZGUgPSB2bm9kZTsKICAgIHdoaWxlIChpc0RlZihjaGlsZE5vZGUuY29tcG9uZW50SW5zdGFuY2UpKSB7CiAgICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CiAgICAgIGlmIChjaGlsZE5vZGUgJiYgY2hpbGROb2RlLmRhdGEpIHsKICAgICAgICBkYXRhID0gbWVyZ2VDbGFzc0RhdGEoY2hpbGROb2RlLmRhdGEsIGRhdGEpOwogICAgICB9CiAgICB9CiAgICB3aGlsZSAoaXNEZWYocGFyZW50Tm9kZSA9IHBhcmVudE5vZGUucGFyZW50KSkgewogICAgICBpZiAocGFyZW50Tm9kZSAmJiBwYXJlbnROb2RlLmRhdGEpIHsKICAgICAgICBkYXRhID0gbWVyZ2VDbGFzc0RhdGEoZGF0YSwgcGFyZW50Tm9kZS5kYXRhKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlbmRlckNsYXNzKGRhdGEuc3RhdGljQ2xhc3MsIGRhdGEuY2xhc3MpCiAgfQoKICBmdW5jdGlvbiBtZXJnZUNsYXNzRGF0YSAoY2hpbGQsIHBhcmVudCkgewogICAgcmV0dXJuIHsKICAgICAgc3RhdGljQ2xhc3M6IGNvbmNhdChjaGlsZC5zdGF0aWNDbGFzcywgcGFyZW50LnN0YXRpY0NsYXNzKSwKICAgICAgY2xhc3M6IGlzRGVmKGNoaWxkLmNsYXNzKQogICAgICAgID8gW2NoaWxkLmNsYXNzLCBwYXJlbnQuY2xhc3NdCiAgICAgICAgOiBwYXJlbnQuY2xhc3MKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbmRlckNsYXNzICgKICAgIHN0YXRpY0NsYXNzLAogICAgZHluYW1pY0NsYXNzCiAgKSB7CiAgICBpZiAoaXNEZWYoc3RhdGljQ2xhc3MpIHx8IGlzRGVmKGR5bmFtaWNDbGFzcykpIHsKICAgICAgcmV0dXJuIGNvbmNhdChzdGF0aWNDbGFzcywgc3RyaW5naWZ5Q2xhc3MoZHluYW1pY0NsYXNzKSkKICAgIH0KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICByZXR1cm4gJycKICB9CgogIGZ1bmN0aW9uIGNvbmNhdCAoYSwgYikgewogICAgcmV0dXJuIGEgPyBiID8gKGEgKyAnICcgKyBiKSA6IGEgOiAoYiB8fCAnJykKICB9CgogIGZ1bmN0aW9uIHN0cmluZ2lmeUNsYXNzICh2YWx1ZSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIHJldHVybiBzdHJpbmdpZnlBcnJheSh2YWx1ZSkKICAgIH0KICAgIGlmIChpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHN0cmluZ2lmeU9iamVjdCh2YWx1ZSkKICAgIH0KICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiB2YWx1ZQogICAgfQogICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgIHJldHVybiAnJwogIH0KCiAgZnVuY3Rpb24gc3RyaW5naWZ5QXJyYXkgKHZhbHVlKSB7CiAgICB2YXIgcmVzID0gJyc7CiAgICB2YXIgc3RyaW5naWZpZWQ7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBpZiAoaXNEZWYoc3RyaW5naWZpZWQgPSBzdHJpbmdpZnlDbGFzcyh2YWx1ZVtpXSkpICYmIHN0cmluZ2lmaWVkICE9PSAnJykgewogICAgICAgIGlmIChyZXMpIHsgcmVzICs9ICcgJzsgfQogICAgICAgIHJlcyArPSBzdHJpbmdpZmllZDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgZnVuY3Rpb24gc3RyaW5naWZ5T2JqZWN0ICh2YWx1ZSkgewogICAgdmFyIHJlcyA9ICcnOwogICAgZm9yICh2YXIga2V5IGluIHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZVtrZXldKSB7CiAgICAgICAgaWYgKHJlcykgeyByZXMgKz0gJyAnOyB9CiAgICAgICAgcmVzICs9IGtleTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgLyogICovCgogIHZhciBuYW1lc3BhY2VNYXAgPSB7CiAgICBzdmc6ICdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycsCiAgICBtYXRoOiAnaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCcKICB9OwoKICB2YXIgaXNIVE1MVGFnID0gbWFrZU1hcCgKICAgICdodG1sLGJvZHksYmFzZSxoZWFkLGxpbmssbWV0YSxzdHlsZSx0aXRsZSwnICsKICAgICdhZGRyZXNzLGFydGljbGUsYXNpZGUsZm9vdGVyLGhlYWRlcixoMSxoMixoMyxoNCxoNSxoNixoZ3JvdXAsbmF2LHNlY3Rpb24sJyArCiAgICAnZGl2LGRkLGRsLGR0LGZpZ2NhcHRpb24sZmlndXJlLHBpY3R1cmUsaHIsaW1nLGxpLG1haW4sb2wscCxwcmUsdWwsJyArCiAgICAnYSxiLGFiYnIsYmRpLGJkbyxicixjaXRlLGNvZGUsZGF0YSxkZm4sZW0saSxrYmQsbWFyayxxLHJwLHJ0LHJ0YyxydWJ5LCcgKwogICAgJ3Msc2FtcCxzbWFsbCxzcGFuLHN0cm9uZyxzdWIsc3VwLHRpbWUsdSx2YXIsd2JyLGFyZWEsYXVkaW8sbWFwLHRyYWNrLHZpZGVvLCcgKwogICAgJ2VtYmVkLG9iamVjdCxwYXJhbSxzb3VyY2UsY2FudmFzLHNjcmlwdCxub3NjcmlwdCxkZWwsaW5zLCcgKwogICAgJ2NhcHRpb24sY29sLGNvbGdyb3VwLHRhYmxlLHRoZWFkLHRib2R5LHRkLHRoLHRyLCcgKwogICAgJ2J1dHRvbixkYXRhbGlzdCxmaWVsZHNldCxmb3JtLGlucHV0LGxhYmVsLGxlZ2VuZCxtZXRlcixvcHRncm91cCxvcHRpb24sJyArCiAgICAnb3V0cHV0LHByb2dyZXNzLHNlbGVjdCx0ZXh0YXJlYSwnICsKICAgICdkZXRhaWxzLGRpYWxvZyxtZW51LG1lbnVpdGVtLHN1bW1hcnksJyArCiAgICAnY29udGVudCxlbGVtZW50LHNoYWRvdyx0ZW1wbGF0ZSxibG9ja3F1b3RlLGlmcmFtZSx0Zm9vdCcKICApOwoKICAvLyB0aGlzIG1hcCBpcyBpbnRlbnRpb25hbGx5IHNlbGVjdGl2ZSwgb25seSBjb3ZlcmluZyBTVkcgZWxlbWVudHMgdGhhdCBtYXkKICAvLyBjb250YWluIGNoaWxkIGVsZW1lbnRzLgogIHZhciBpc1NWRyA9IG1ha2VNYXAoCiAgICAnc3ZnLGFuaW1hdGUsY2lyY2xlLGNsaXBwYXRoLGN1cnNvcixkZWZzLGRlc2MsZWxsaXBzZSxmaWx0ZXIsZm9udC1mYWNlLCcgKwogICAgJ2ZvcmVpZ25PYmplY3QsZyxnbHlwaCxpbWFnZSxsaW5lLG1hcmtlcixtYXNrLG1pc3NpbmctZ2x5cGgscGF0aCxwYXR0ZXJuLCcgKwogICAgJ3BvbHlnb24scG9seWxpbmUscmVjdCxzd2l0Y2gsc3ltYm9sLHRleHQsdGV4dHBhdGgsdHNwYW4sdXNlLHZpZXcnLAogICAgdHJ1ZQogICk7CgogIHZhciBpc1ByZVRhZyA9IGZ1bmN0aW9uICh0YWcpIHsgcmV0dXJuIHRhZyA9PT0gJ3ByZSc7IH07CgogIHZhciBpc1Jlc2VydmVkVGFnID0gZnVuY3Rpb24gKHRhZykgewogICAgcmV0dXJuIGlzSFRNTFRhZyh0YWcpIHx8IGlzU1ZHKHRhZykKICB9OwoKICBmdW5jdGlvbiBnZXRUYWdOYW1lc3BhY2UgKHRhZykgewogICAgaWYgKGlzU1ZHKHRhZykpIHsKICAgICAgcmV0dXJuICdzdmcnCiAgICB9CiAgICAvLyBiYXNpYyBzdXBwb3J0IGZvciBNYXRoTUwKICAgIC8vIG5vdGUgaXQgZG9lc24ndCBzdXBwb3J0IG90aGVyIE1hdGhNTCBlbGVtZW50cyBiZWluZyBjb21wb25lbnQgcm9vdHMKICAgIGlmICh0YWcgPT09ICdtYXRoJykgewogICAgICByZXR1cm4gJ21hdGgnCiAgICB9CiAgfQoKICB2YXIgdW5rbm93bkVsZW1lbnRDYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgZnVuY3Rpb24gaXNVbmtub3duRWxlbWVudCAodGFnKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmICghaW5Ccm93c2VyKSB7CiAgICAgIHJldHVybiB0cnVlCiAgICB9CiAgICBpZiAoaXNSZXNlcnZlZFRhZyh0YWcpKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogICAgdGFnID0gdGFnLnRvTG93ZXJDYXNlKCk7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmICh1bmtub3duRWxlbWVudENhY2hlW3RhZ10gIT0gbnVsbCkgewogICAgICByZXR1cm4gdW5rbm93bkVsZW1lbnRDYWNoZVt0YWddCiAgICB9CiAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZyk7CiAgICBpZiAodGFnLmluZGV4T2YoJy0nKSA+IC0xKSB7CiAgICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzI4MjEwMzY0LzEwNzAyNDQKICAgICAgcmV0dXJuICh1bmtub3duRWxlbWVudENhY2hlW3RhZ10gPSAoCiAgICAgICAgZWwuY29uc3RydWN0b3IgPT09IHdpbmRvdy5IVE1MVW5rbm93bkVsZW1lbnQgfHwKICAgICAgICBlbC5jb25zdHJ1Y3RvciA9PT0gd2luZG93LkhUTUxFbGVtZW50CiAgICAgICkpCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gKHVua25vd25FbGVtZW50Q2FjaGVbdGFnXSA9IC9IVE1MVW5rbm93bkVsZW1lbnQvLnRlc3QoZWwudG9TdHJpbmcoKSkpCiAgICB9CiAgfQoKICB2YXIgaXNUZXh0SW5wdXRUeXBlID0gbWFrZU1hcCgndGV4dCxudW1iZXIscGFzc3dvcmQsc2VhcmNoLGVtYWlsLHRlbCx1cmwnKTsKCiAgLyogICovCgogIC8qKgogICAqIFF1ZXJ5IGFuIGVsZW1lbnQgc2VsZWN0b3IgaWYgaXQncyBub3QgYW4gZWxlbWVudCBhbHJlYWR5LgogICAqLwogIGZ1bmN0aW9uIHF1ZXJ5IChlbCkgewogICAgaWYgKHR5cGVvZiBlbCA9PT0gJ3N0cmluZycpIHsKICAgICAgdmFyIHNlbGVjdGVkID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihlbCk7CiAgICAgIGlmICghc2VsZWN0ZWQpIHsKICAgICAgICB3YXJuKAogICAgICAgICAgJ0Nhbm5vdCBmaW5kIGVsZW1lbnQ6ICcgKyBlbAogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpCiAgICAgIH0KICAgICAgcmV0dXJuIHNlbGVjdGVkCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZWwKICAgIH0KICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50JDEgKHRhZ05hbWUsIHZub2RlKSB7CiAgICB2YXIgZWxtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTsKICAgIGlmICh0YWdOYW1lICE9PSAnc2VsZWN0JykgewogICAgICByZXR1cm4gZWxtCiAgICB9CiAgICAvLyBmYWxzZSBvciBudWxsIHdpbGwgcmVtb3ZlIHRoZSBhdHRyaWJ1dGUgYnV0IHVuZGVmaW5lZCB3aWxsIG5vdAogICAgaWYgKHZub2RlLmRhdGEgJiYgdm5vZGUuZGF0YS5hdHRycyAmJiB2bm9kZS5kYXRhLmF0dHJzLm11bHRpcGxlICE9PSB1bmRlZmluZWQpIHsKICAgICAgZWxtLnNldEF0dHJpYnV0ZSgnbXVsdGlwbGUnLCAnbXVsdGlwbGUnKTsKICAgIH0KICAgIHJldHVybiBlbG0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnROUyAobmFtZXNwYWNlLCB0YWdOYW1lKSB7CiAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZU1hcFtuYW1lc3BhY2VdLCB0YWdOYW1lKQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlVGV4dE5vZGUgKHRleHQpIHsKICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlQ29tbWVudCAodGV4dCkgewogICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQodGV4dCkKICB9CgogIGZ1bmN0aW9uIGluc2VydEJlZm9yZSAocGFyZW50Tm9kZSwgbmV3Tm9kZSwgcmVmZXJlbmNlTm9kZSkgewogICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobmV3Tm9kZSwgcmVmZXJlbmNlTm9kZSk7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVDaGlsZCAobm9kZSwgY2hpbGQpIHsKICAgIG5vZGUucmVtb3ZlQ2hpbGQoY2hpbGQpOwogIH0KCiAgZnVuY3Rpb24gYXBwZW5kQ2hpbGQgKG5vZGUsIGNoaWxkKSB7CiAgICBub2RlLmFwcGVuZENoaWxkKGNoaWxkKTsKICB9CgogIGZ1bmN0aW9uIHBhcmVudE5vZGUgKG5vZGUpIHsKICAgIHJldHVybiBub2RlLnBhcmVudE5vZGUKICB9CgogIGZ1bmN0aW9uIG5leHRTaWJsaW5nIChub2RlKSB7CiAgICByZXR1cm4gbm9kZS5uZXh0U2libGluZwogIH0KCiAgZnVuY3Rpb24gdGFnTmFtZSAobm9kZSkgewogICAgcmV0dXJuIG5vZGUudGFnTmFtZQogIH0KCiAgZnVuY3Rpb24gc2V0VGV4dENvbnRlbnQgKG5vZGUsIHRleHQpIHsKICAgIG5vZGUudGV4dENvbnRlbnQgPSB0ZXh0OwogIH0KCiAgZnVuY3Rpb24gc2V0U3R5bGVTY29wZSAobm9kZSwgc2NvcGVJZCkgewogICAgbm9kZS5zZXRBdHRyaWJ1dGUoc2NvcGVJZCwgJycpOwogIH0KCiAgdmFyIG5vZGVPcHMgPSAvKiNfX1BVUkVfXyovT2JqZWN0LmZyZWV6ZSh7CiAgICBjcmVhdGVFbGVtZW50OiBjcmVhdGVFbGVtZW50JDEsCiAgICBjcmVhdGVFbGVtZW50TlM6IGNyZWF0ZUVsZW1lbnROUywKICAgIGNyZWF0ZVRleHROb2RlOiBjcmVhdGVUZXh0Tm9kZSwKICAgIGNyZWF0ZUNvbW1lbnQ6IGNyZWF0ZUNvbW1lbnQsCiAgICBpbnNlcnRCZWZvcmU6IGluc2VydEJlZm9yZSwKICAgIHJlbW92ZUNoaWxkOiByZW1vdmVDaGlsZCwKICAgIGFwcGVuZENoaWxkOiBhcHBlbmRDaGlsZCwKICAgIHBhcmVudE5vZGU6IHBhcmVudE5vZGUsCiAgICBuZXh0U2libGluZzogbmV4dFNpYmxpbmcsCiAgICB0YWdOYW1lOiB0YWdOYW1lLAogICAgc2V0VGV4dENvbnRlbnQ6IHNldFRleHRDb250ZW50LAogICAgc2V0U3R5bGVTY29wZTogc2V0U3R5bGVTY29wZQogIH0pOwoKICAvKiAgKi8KCiAgdmFyIHJlZiA9IHsKICAgIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlIChfLCB2bm9kZSkgewogICAgICByZWdpc3RlclJlZih2bm9kZSk7CiAgICB9LAogICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUgKG9sZFZub2RlLCB2bm9kZSkgewogICAgICBpZiAob2xkVm5vZGUuZGF0YS5yZWYgIT09IHZub2RlLmRhdGEucmVmKSB7CiAgICAgICAgcmVnaXN0ZXJSZWYob2xkVm5vZGUsIHRydWUpOwogICAgICAgIHJlZ2lzdGVyUmVmKHZub2RlKTsKICAgICAgfQogICAgfSwKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3kgKHZub2RlKSB7CiAgICAgIHJlZ2lzdGVyUmVmKHZub2RlLCB0cnVlKTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiByZWdpc3RlclJlZiAodm5vZGUsIGlzUmVtb3ZhbCkgewogICAgdmFyIGtleSA9IHZub2RlLmRhdGEucmVmOwogICAgaWYgKCFpc0RlZihrZXkpKSB7IHJldHVybiB9CgogICAgdmFyIHZtID0gdm5vZGUuY29udGV4dDsKICAgIHZhciByZWYgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSB8fCB2bm9kZS5lbG07CiAgICB2YXIgcmVmcyA9IHZtLiRyZWZzOwogICAgaWYgKGlzUmVtb3ZhbCkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShyZWZzW2tleV0pKSB7CiAgICAgICAgcmVtb3ZlKHJlZnNba2V5XSwgcmVmKTsKICAgICAgfSBlbHNlIGlmIChyZWZzW2tleV0gPT09IHJlZikgewogICAgICAgIHJlZnNba2V5XSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHZub2RlLmRhdGEucmVmSW5Gb3IpIHsKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVmc1trZXldKSkgewogICAgICAgICAgcmVmc1trZXldID0gW3JlZl07CiAgICAgICAgfSBlbHNlIGlmIChyZWZzW2tleV0uaW5kZXhPZihyZWYpIDwgMCkgewogICAgICAgICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgICAgICAgICByZWZzW2tleV0ucHVzaChyZWYpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZWZzW2tleV0gPSByZWY7CiAgICAgIH0KICAgIH0KICB9CgogIC8qKgogICAqIFZpcnR1YWwgRE9NIHBhdGNoaW5nIGFsZ29yaXRobSBiYXNlZCBvbiBTbmFiYmRvbSBieQogICAqIFNpbW9uIEZyaWlzIFZpbmR1bSAoQHBhbGRlcGluZCkKICAgKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UKICAgKiBodHRwczovL2dpdGh1Yi5jb20vcGFsZGVwaW5kL3NuYWJiZG9tL2Jsb2IvbWFzdGVyL0xJQ0VOU0UKICAgKgogICAqIG1vZGlmaWVkIGJ5IEV2YW4gWW91IChAeXl4OTkwODAzKQogICAqCiAgICogTm90IHR5cGUtY2hlY2tpbmcgdGhpcyBiZWNhdXNlIHRoaXMgZmlsZSBpcyBwZXJmLWNyaXRpY2FsIGFuZCB0aGUgY29zdAogICAqIG9mIG1ha2luZyBmbG93IHVuZGVyc3RhbmQgaXQgaXMgbm90IHdvcnRoIGl0LgogICAqLwoKICB2YXIgZW1wdHlOb2RlID0gbmV3IFZOb2RlKCcnLCB7fSwgW10pOwoKICB2YXIgaG9va3MgPSBbJ2NyZWF0ZScsICdhY3RpdmF0ZScsICd1cGRhdGUnLCAncmVtb3ZlJywgJ2Rlc3Ryb3knXTsKCiAgZnVuY3Rpb24gc2FtZVZub2RlIChhLCBiKSB7CiAgICByZXR1cm4gKAogICAgICBhLmtleSA9PT0gYi5rZXkgJiYgKAogICAgICAgICgKICAgICAgICAgIGEudGFnID09PSBiLnRhZyAmJgogICAgICAgICAgYS5pc0NvbW1lbnQgPT09IGIuaXNDb21tZW50ICYmCiAgICAgICAgICBpc0RlZihhLmRhdGEpID09PSBpc0RlZihiLmRhdGEpICYmCiAgICAgICAgICBzYW1lSW5wdXRUeXBlKGEsIGIpCiAgICAgICAgKSB8fCAoCiAgICAgICAgICBpc1RydWUoYS5pc0FzeW5jUGxhY2Vob2xkZXIpICYmCiAgICAgICAgICBhLmFzeW5jRmFjdG9yeSA9PT0gYi5hc3luY0ZhY3RvcnkgJiYKICAgICAgICAgIGlzVW5kZWYoYi5hc3luY0ZhY3RvcnkuZXJyb3IpCiAgICAgICAgKQogICAgICApCiAgICApCiAgfQoKICBmdW5jdGlvbiBzYW1lSW5wdXRUeXBlIChhLCBiKSB7CiAgICBpZiAoYS50YWcgIT09ICdpbnB1dCcpIHsgcmV0dXJuIHRydWUgfQogICAgdmFyIGk7CiAgICB2YXIgdHlwZUEgPSBpc0RlZihpID0gYS5kYXRhKSAmJiBpc0RlZihpID0gaS5hdHRycykgJiYgaS50eXBlOwogICAgdmFyIHR5cGVCID0gaXNEZWYoaSA9IGIuZGF0YSkgJiYgaXNEZWYoaSA9IGkuYXR0cnMpICYmIGkudHlwZTsKICAgIHJldHVybiB0eXBlQSA9PT0gdHlwZUIgfHwgaXNUZXh0SW5wdXRUeXBlKHR5cGVBKSAmJiBpc1RleHRJbnB1dFR5cGUodHlwZUIpCiAgfQoKICBmdW5jdGlvbiBjcmVhdGVLZXlUb09sZElkeCAoY2hpbGRyZW4sIGJlZ2luSWR4LCBlbmRJZHgpIHsKICAgIHZhciBpLCBrZXk7CiAgICB2YXIgbWFwID0ge307CiAgICBmb3IgKGkgPSBiZWdpbklkeDsgaSA8PSBlbmRJZHg7ICsraSkgewogICAgICBrZXkgPSBjaGlsZHJlbltpXS5rZXk7CiAgICAgIGlmIChpc0RlZihrZXkpKSB7IG1hcFtrZXldID0gaTsgfQogICAgfQogICAgcmV0dXJuIG1hcAogIH0KCiAgZnVuY3Rpb24gY3JlYXRlUGF0Y2hGdW5jdGlvbiAoYmFja2VuZCkgewogICAgdmFyIGksIGo7CiAgICB2YXIgY2JzID0ge307CgogICAgdmFyIG1vZHVsZXMgPSBiYWNrZW5kLm1vZHVsZXM7CiAgICB2YXIgbm9kZU9wcyA9IGJhY2tlbmQubm9kZU9wczsKCiAgICBmb3IgKGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyArK2kpIHsKICAgICAgY2JzW2hvb2tzW2ldXSA9IFtdOwogICAgICBmb3IgKGogPSAwOyBqIDwgbW9kdWxlcy5sZW5ndGg7ICsraikgewogICAgICAgIGlmIChpc0RlZihtb2R1bGVzW2pdW2hvb2tzW2ldXSkpIHsKICAgICAgICAgIGNic1tob29rc1tpXV0ucHVzaChtb2R1bGVzW2pdW2hvb2tzW2ldXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZW1wdHlOb2RlQXQgKGVsbSkgewogICAgICByZXR1cm4gbmV3IFZOb2RlKG5vZGVPcHMudGFnTmFtZShlbG0pLnRvTG93ZXJDYXNlKCksIHt9LCBbXSwgdW5kZWZpbmVkLCBlbG0pCiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlUm1DYiAoY2hpbGRFbG0sIGxpc3RlbmVycykgewogICAgICBmdW5jdGlvbiByZW1vdmUkJDEgKCkgewogICAgICAgIGlmICgtLXJlbW92ZSQkMS5saXN0ZW5lcnMgPT09IDApIHsKICAgICAgICAgIHJlbW92ZU5vZGUoY2hpbGRFbG0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZW1vdmUkJDEubGlzdGVuZXJzID0gbGlzdGVuZXJzOwogICAgICByZXR1cm4gcmVtb3ZlJCQxCiAgICB9CgogICAgZnVuY3Rpb24gcmVtb3ZlTm9kZSAoZWwpIHsKICAgICAgdmFyIHBhcmVudCA9IG5vZGVPcHMucGFyZW50Tm9kZShlbCk7CiAgICAgIC8vIGVsZW1lbnQgbWF5IGhhdmUgYWxyZWFkeSBiZWVuIHJlbW92ZWQgZHVlIHRvIHYtaHRtbCAvIHYtdGV4dAogICAgICBpZiAoaXNEZWYocGFyZW50KSkgewogICAgICAgIG5vZGVPcHMucmVtb3ZlQ2hpbGQocGFyZW50LCBlbCk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpc1Vua25vd25FbGVtZW50JCQxICh2bm9kZSwgaW5WUHJlKSB7CiAgICAgIHJldHVybiAoCiAgICAgICAgIWluVlByZSAmJgogICAgICAgICF2bm9kZS5ucyAmJgogICAgICAgICEoCiAgICAgICAgICBjb25maWcuaWdub3JlZEVsZW1lbnRzLmxlbmd0aCAmJgogICAgICAgICAgY29uZmlnLmlnbm9yZWRFbGVtZW50cy5zb21lKGZ1bmN0aW9uIChpZ25vcmUpIHsKICAgICAgICAgICAgcmV0dXJuIGlzUmVnRXhwKGlnbm9yZSkKICAgICAgICAgICAgICA/IGlnbm9yZS50ZXN0KHZub2RlLnRhZykKICAgICAgICAgICAgICA6IGlnbm9yZSA9PT0gdm5vZGUudGFnCiAgICAgICAgICB9KQogICAgICAgICkgJiYKICAgICAgICBjb25maWcuaXNVbmtub3duRWxlbWVudCh2bm9kZS50YWcpCiAgICAgICkKICAgIH0KCiAgICB2YXIgY3JlYXRpbmdFbG1JblZQcmUgPSAwOwoKICAgIGZ1bmN0aW9uIGNyZWF0ZUVsbSAoCiAgICAgIHZub2RlLAogICAgICBpbnNlcnRlZFZub2RlUXVldWUsCiAgICAgIHBhcmVudEVsbSwKICAgICAgcmVmRWxtLAogICAgICBuZXN0ZWQsCiAgICAgIG93bmVyQXJyYXksCiAgICAgIGluZGV4CiAgICApIHsKICAgICAgaWYgKGlzRGVmKHZub2RlLmVsbSkgJiYgaXNEZWYob3duZXJBcnJheSkpIHsKICAgICAgICAvLyBUaGlzIHZub2RlIHdhcyB1c2VkIGluIGEgcHJldmlvdXMgcmVuZGVyIQogICAgICAgIC8vIG5vdyBpdCdzIHVzZWQgYXMgYSBuZXcgbm9kZSwgb3ZlcndyaXRpbmcgaXRzIGVsbSB3b3VsZCBjYXVzZQogICAgICAgIC8vIHBvdGVudGlhbCBwYXRjaCBlcnJvcnMgZG93biB0aGUgcm9hZCB3aGVuIGl0J3MgdXNlZCBhcyBhbiBpbnNlcnRpb24KICAgICAgICAvLyByZWZlcmVuY2Ugbm9kZS4gSW5zdGVhZCwgd2UgY2xvbmUgdGhlIG5vZGUgb24tZGVtYW5kIGJlZm9yZSBjcmVhdGluZwogICAgICAgIC8vIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnQgZm9yIGl0LgogICAgICAgIHZub2RlID0gb3duZXJBcnJheVtpbmRleF0gPSBjbG9uZVZOb2RlKHZub2RlKTsKICAgICAgfQoKICAgICAgdm5vZGUuaXNSb290SW5zZXJ0ID0gIW5lc3RlZDsgLy8gZm9yIHRyYW5zaXRpb24gZW50ZXIgY2hlY2sKICAgICAgaWYgKGNyZWF0ZUNvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSkpIHsKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgICB2YXIgY2hpbGRyZW4gPSB2bm9kZS5jaGlsZHJlbjsKICAgICAgdmFyIHRhZyA9IHZub2RlLnRhZzsKICAgICAgaWYgKGlzRGVmKHRhZykpIHsKICAgICAgICB7CiAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLnByZSkgewogICAgICAgICAgICBjcmVhdGluZ0VsbUluVlByZSsrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzVW5rbm93bkVsZW1lbnQkJDEodm5vZGUsIGNyZWF0aW5nRWxtSW5WUHJlKSkgewogICAgICAgICAgICB3YXJuKAogICAgICAgICAgICAgICdVbmtub3duIGN1c3RvbSBlbGVtZW50OiA8JyArIHRhZyArICc+IC0gZGlkIHlvdSAnICsKICAgICAgICAgICAgICAncmVnaXN0ZXIgdGhlIGNvbXBvbmVudCBjb3JyZWN0bHk/IEZvciByZWN1cnNpdmUgY29tcG9uZW50cywgJyArCiAgICAgICAgICAgICAgJ21ha2Ugc3VyZSB0byBwcm92aWRlIHRoZSAibmFtZSIgb3B0aW9uLicsCiAgICAgICAgICAgICAgdm5vZGUuY29udGV4dAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdm5vZGUuZWxtID0gdm5vZGUubnMKICAgICAgICAgID8gbm9kZU9wcy5jcmVhdGVFbGVtZW50TlModm5vZGUubnMsIHRhZykKICAgICAgICAgIDogbm9kZU9wcy5jcmVhdGVFbGVtZW50KHRhZywgdm5vZGUpOwogICAgICAgIHNldFNjb3BlKHZub2RlKTsKCiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgewogICAgICAgICAgY3JlYXRlQ2hpbGRyZW4odm5vZGUsIGNoaWxkcmVuLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgICAgICAgIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgICAgfQogICAgICAgICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5wcmUpIHsKICAgICAgICAgIGNyZWF0aW5nRWxtSW5WUHJlLS07CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGlzVHJ1ZSh2bm9kZS5pc0NvbW1lbnQpKSB7CiAgICAgICAgdm5vZGUuZWxtID0gbm9kZU9wcy5jcmVhdGVDb21tZW50KHZub2RlLnRleHQpOwogICAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2bm9kZS5lbG0gPSBub2RlT3BzLmNyZWF0ZVRleHROb2RlKHZub2RlLnRleHQpOwogICAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudCAodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0pIHsKICAgICAgdmFyIGkgPSB2bm9kZS5kYXRhOwogICAgICBpZiAoaXNEZWYoaSkpIHsKICAgICAgICB2YXIgaXNSZWFjdGl2YXRlZCA9IGlzRGVmKHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSAmJiBpLmtlZXBBbGl2ZTsKICAgICAgICBpZiAoaXNEZWYoaSA9IGkuaG9vaykgJiYgaXNEZWYoaSA9IGkuaW5pdCkpIHsKICAgICAgICAgIGkodm5vZGUsIGZhbHNlIC8qIGh5ZHJhdGluZyAqLyk7CiAgICAgICAgfQogICAgICAgIC8vIGFmdGVyIGNhbGxpbmcgdGhlIGluaXQgaG9vaywgaWYgdGhlIHZub2RlIGlzIGEgY2hpbGQgY29tcG9uZW50CiAgICAgICAgLy8gaXQgc2hvdWxkJ3ZlIGNyZWF0ZWQgYSBjaGlsZCBpbnN0YW5jZSBhbmQgbW91bnRlZCBpdC4gdGhlIGNoaWxkCiAgICAgICAgLy8gY29tcG9uZW50IGFsc28gaGFzIHNldCB0aGUgcGxhY2Vob2xkZXIgdm5vZGUncyBlbG0uCiAgICAgICAgLy8gaW4gdGhhdCBjYXNlIHdlIGNhbiBqdXN0IHJldHVybiB0aGUgZWxlbWVudCBhbmQgYmUgZG9uZS4KICAgICAgICBpZiAoaXNEZWYodm5vZGUuY29tcG9uZW50SW5zdGFuY2UpKSB7CiAgICAgICAgICBpbml0Q29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgICAgaW5zZXJ0KHBhcmVudEVsbSwgdm5vZGUuZWxtLCByZWZFbG0pOwogICAgICAgICAgaWYgKGlzVHJ1ZShpc1JlYWN0aXZhdGVkKSkgewogICAgICAgICAgICByZWFjdGl2YXRlQ29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaW5pdENvbXBvbmVudCAodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSkgewogICAgICBpZiAoaXNEZWYodm5vZGUuZGF0YS5wZW5kaW5nSW5zZXJ0KSkgewogICAgICAgIGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoLmFwcGx5KGluc2VydGVkVm5vZGVRdWV1ZSwgdm5vZGUuZGF0YS5wZW5kaW5nSW5zZXJ0KTsKICAgICAgICB2bm9kZS5kYXRhLnBlbmRpbmdJbnNlcnQgPSBudWxsOwogICAgICB9CiAgICAgIHZub2RlLmVsbSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlLiRlbDsKICAgICAgaWYgKGlzUGF0Y2hhYmxlKHZub2RlKSkgewogICAgICAgIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIHNldFNjb3BlKHZub2RlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBlbXB0eSBjb21wb25lbnQgcm9vdC4KICAgICAgICAvLyBza2lwIGFsbCBlbGVtZW50LXJlbGF0ZWQgbW9kdWxlcyBleGNlcHQgZm9yIHJlZiAoIzM0NTUpCiAgICAgICAgcmVnaXN0ZXJSZWYodm5vZGUpOwogICAgICAgIC8vIG1ha2Ugc3VyZSB0byBpbnZva2UgdGhlIGluc2VydCBob29rCiAgICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLnB1c2godm5vZGUpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcmVhY3RpdmF0ZUNvbXBvbmVudCAodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0pIHsKICAgICAgdmFyIGk7CiAgICAgIC8vIGhhY2sgZm9yICM0MzM5OiBhIHJlYWN0aXZhdGVkIGNvbXBvbmVudCB3aXRoIGlubmVyIHRyYW5zaXRpb24KICAgICAgLy8gZG9lcyBub3QgdHJpZ2dlciBiZWNhdXNlIHRoZSBpbm5lciBub2RlJ3MgY3JlYXRlZCBob29rcyBhcmUgbm90IGNhbGxlZAogICAgICAvLyBhZ2Fpbi4gSXQncyBub3QgaWRlYWwgdG8gaW52b2x2ZSBtb2R1bGUtc3BlY2lmaWMgbG9naWMgaW4gaGVyZSBidXQKICAgICAgLy8gdGhlcmUgZG9lc24ndCBzZWVtIHRvIGJlIGEgYmV0dGVyIHdheSB0byBkbyBpdC4KICAgICAgdmFyIGlubmVyTm9kZSA9IHZub2RlOwogICAgICB3aGlsZSAoaW5uZXJOb2RlLmNvbXBvbmVudEluc3RhbmNlKSB7CiAgICAgICAgaW5uZXJOb2RlID0gaW5uZXJOb2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZTsKICAgICAgICBpZiAoaXNEZWYoaSA9IGlubmVyTm9kZS5kYXRhKSAmJiBpc0RlZihpID0gaS50cmFuc2l0aW9uKSkgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNicy5hY3RpdmF0ZS5sZW5ndGg7ICsraSkgewogICAgICAgICAgICBjYnMuYWN0aXZhdGVbaV0oZW1wdHlOb2RlLCBpbm5lck5vZGUpOwogICAgICAgICAgfQogICAgICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLnB1c2goaW5uZXJOb2RlKTsKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIHVubGlrZSBhIG5ld2x5IGNyZWF0ZWQgY29tcG9uZW50LAogICAgICAvLyBhIHJlYWN0aXZhdGVkIGtlZXAtYWxpdmUgY29tcG9uZW50IGRvZXNuJ3QgaW5zZXJ0IGl0c2VsZgogICAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5zZXJ0IChwYXJlbnQsIGVsbSwgcmVmJCQxKSB7CiAgICAgIGlmIChpc0RlZihwYXJlbnQpKSB7CiAgICAgICAgaWYgKGlzRGVmKHJlZiQkMSkpIHsKICAgICAgICAgIGlmIChub2RlT3BzLnBhcmVudE5vZGUocmVmJCQxKSA9PT0gcGFyZW50KSB7CiAgICAgICAgICAgIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudCwgZWxtLCByZWYkJDEpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBub2RlT3BzLmFwcGVuZENoaWxkKHBhcmVudCwgZWxtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVDaGlsZHJlbiAodm5vZGUsIGNoaWxkcmVuLCBpbnNlcnRlZFZub2RlUXVldWUpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY2hpbGRyZW4pKSB7CiAgICAgICAgewogICAgICAgICAgY2hlY2tEdXBsaWNhdGVLZXlzKGNoaWxkcmVuKTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7ICsraSkgewogICAgICAgICAgY3JlYXRlRWxtKGNoaWxkcmVuW2ldLCBpbnNlcnRlZFZub2RlUXVldWUsIHZub2RlLmVsbSwgbnVsbCwgdHJ1ZSwgY2hpbGRyZW4sIGkpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpc1ByaW1pdGl2ZSh2bm9kZS50ZXh0KSkgewogICAgICAgIG5vZGVPcHMuYXBwZW5kQ2hpbGQodm5vZGUuZWxtLCBub2RlT3BzLmNyZWF0ZVRleHROb2RlKFN0cmluZyh2bm9kZS50ZXh0KSkpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaXNQYXRjaGFibGUgKHZub2RlKSB7CiAgICAgIHdoaWxlICh2bm9kZS5jb21wb25lbnRJbnN0YW5jZSkgewogICAgICAgIHZub2RlID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlOwogICAgICB9CiAgICAgIHJldHVybiBpc0RlZih2bm9kZS50YWcpCiAgICB9CgogICAgZnVuY3Rpb24gaW52b2tlQ3JlYXRlSG9va3MgKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpIHsKICAgICAgZm9yICh2YXIgaSQxID0gMDsgaSQxIDwgY2JzLmNyZWF0ZS5sZW5ndGg7ICsraSQxKSB7CiAgICAgICAgY2JzLmNyZWF0ZVtpJDFdKGVtcHR5Tm9kZSwgdm5vZGUpOwogICAgICB9CiAgICAgIGkgPSB2bm9kZS5kYXRhLmhvb2s7IC8vIFJldXNlIHZhcmlhYmxlCiAgICAgIGlmIChpc0RlZihpKSkgewogICAgICAgIGlmIChpc0RlZihpLmNyZWF0ZSkpIHsgaS5jcmVhdGUoZW1wdHlOb2RlLCB2bm9kZSk7IH0KICAgICAgICBpZiAoaXNEZWYoaS5pbnNlcnQpKSB7IGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoKHZub2RlKTsgfQogICAgICB9CiAgICB9CgogICAgLy8gc2V0IHNjb3BlIGlkIGF0dHJpYnV0ZSBmb3Igc2NvcGVkIENTUy4KICAgIC8vIHRoaXMgaXMgaW1wbGVtZW50ZWQgYXMgYSBzcGVjaWFsIGNhc2UgdG8gYXZvaWQgdGhlIG92ZXJoZWFkCiAgICAvLyBvZiBnb2luZyB0aHJvdWdoIHRoZSBub3JtYWwgYXR0cmlidXRlIHBhdGNoaW5nIHByb2Nlc3MuCiAgICBmdW5jdGlvbiBzZXRTY29wZSAodm5vZGUpIHsKICAgICAgdmFyIGk7CiAgICAgIGlmIChpc0RlZihpID0gdm5vZGUuZm5TY29wZUlkKSkgewogICAgICAgIG5vZGVPcHMuc2V0U3R5bGVTY29wZSh2bm9kZS5lbG0sIGkpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBhbmNlc3RvciA9IHZub2RlOwogICAgICAgIHdoaWxlIChhbmNlc3RvcikgewogICAgICAgICAgaWYgKGlzRGVmKGkgPSBhbmNlc3Rvci5jb250ZXh0KSAmJiBpc0RlZihpID0gaS4kb3B0aW9ucy5fc2NvcGVJZCkpIHsKICAgICAgICAgICAgbm9kZU9wcy5zZXRTdHlsZVNjb3BlKHZub2RlLmVsbSwgaSk7CiAgICAgICAgICB9CiAgICAgICAgICBhbmNlc3RvciA9IGFuY2VzdG9yLnBhcmVudDsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gZm9yIHNsb3QgY29udGVudCB0aGV5IHNob3VsZCBhbHNvIGdldCB0aGUgc2NvcGVJZCBmcm9tIHRoZSBob3N0IGluc3RhbmNlLgogICAgICBpZiAoaXNEZWYoaSA9IGFjdGl2ZUluc3RhbmNlKSAmJgogICAgICAgIGkgIT09IHZub2RlLmNvbnRleHQgJiYKICAgICAgICBpICE9PSB2bm9kZS5mbkNvbnRleHQgJiYKICAgICAgICBpc0RlZihpID0gaS4kb3B0aW9ucy5fc2NvcGVJZCkKICAgICAgKSB7CiAgICAgICAgbm9kZU9wcy5zZXRTdHlsZVNjb3BlKHZub2RlLmVsbSwgaSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhZGRWbm9kZXMgKHBhcmVudEVsbSwgcmVmRWxtLCB2bm9kZXMsIHN0YXJ0SWR4LCBlbmRJZHgsIGluc2VydGVkVm5vZGVRdWV1ZSkgewogICAgICBmb3IgKDsgc3RhcnRJZHggPD0gZW5kSWR4OyArK3N0YXJ0SWR4KSB7CiAgICAgICAgY3JlYXRlRWxtKHZub2Rlc1tzdGFydElkeF0sIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0sIGZhbHNlLCB2bm9kZXMsIHN0YXJ0SWR4KTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGludm9rZURlc3Ryb3lIb29rICh2bm9kZSkgewogICAgICB2YXIgaSwgajsKICAgICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkuZGVzdHJveSkpIHsgaSh2bm9kZSk7IH0KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY2JzLmRlc3Ryb3kubGVuZ3RoOyArK2kpIHsgY2JzLmRlc3Ryb3lbaV0odm5vZGUpOyB9CiAgICAgIH0KICAgICAgaWYgKGlzRGVmKGkgPSB2bm9kZS5jaGlsZHJlbikpIHsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgdm5vZGUuY2hpbGRyZW4ubGVuZ3RoOyArK2opIHsKICAgICAgICAgIGludm9rZURlc3Ryb3lIb29rKHZub2RlLmNoaWxkcmVuW2pdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiByZW1vdmVWbm9kZXMgKHBhcmVudEVsbSwgdm5vZGVzLCBzdGFydElkeCwgZW5kSWR4KSB7CiAgICAgIGZvciAoOyBzdGFydElkeCA8PSBlbmRJZHg7ICsrc3RhcnRJZHgpIHsKICAgICAgICB2YXIgY2ggPSB2bm9kZXNbc3RhcnRJZHhdOwogICAgICAgIGlmIChpc0RlZihjaCkpIHsKICAgICAgICAgIGlmIChpc0RlZihjaC50YWcpKSB7CiAgICAgICAgICAgIHJlbW92ZUFuZEludm9rZVJlbW92ZUhvb2soY2gpOwogICAgICAgICAgICBpbnZva2VEZXN0cm95SG9vayhjaCk7CiAgICAgICAgICB9IGVsc2UgeyAvLyBUZXh0IG5vZGUKICAgICAgICAgICAgcmVtb3ZlTm9kZShjaC5lbG0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHJlbW92ZUFuZEludm9rZVJlbW92ZUhvb2sgKHZub2RlLCBybSkgewogICAgICBpZiAoaXNEZWYocm0pIHx8IGlzRGVmKHZub2RlLmRhdGEpKSB7CiAgICAgICAgdmFyIGk7CiAgICAgICAgdmFyIGxpc3RlbmVycyA9IGNicy5yZW1vdmUubGVuZ3RoICsgMTsKICAgICAgICBpZiAoaXNEZWYocm0pKSB7CiAgICAgICAgICAvLyB3ZSBoYXZlIGEgcmVjdXJzaXZlbHkgcGFzc2VkIGRvd24gcm0gY2FsbGJhY2sKICAgICAgICAgIC8vIGluY3JlYXNlIHRoZSBsaXN0ZW5lcnMgY291bnQKICAgICAgICAgIHJtLmxpc3RlbmVycyArPSBsaXN0ZW5lcnM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIGRpcmVjdGx5IHJlbW92aW5nCiAgICAgICAgICBybSA9IGNyZWF0ZVJtQ2Iodm5vZGUuZWxtLCBsaXN0ZW5lcnMpOwogICAgICAgIH0KICAgICAgICAvLyByZWN1cnNpdmVseSBpbnZva2UgaG9va3Mgb24gY2hpbGQgY29tcG9uZW50IHJvb3Qgbm9kZQogICAgICAgIGlmIChpc0RlZihpID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UpICYmIGlzRGVmKGkgPSBpLl92bm9kZSkgJiYgaXNEZWYoaS5kYXRhKSkgewogICAgICAgICAgcmVtb3ZlQW5kSW52b2tlUmVtb3ZlSG9vayhpLCBybSk7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjYnMucmVtb3ZlLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBjYnMucmVtb3ZlW2ldKHZub2RlLCBybSk7CiAgICAgICAgfQogICAgICAgIGlmIChpc0RlZihpID0gdm5vZGUuZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5yZW1vdmUpKSB7CiAgICAgICAgICBpKHZub2RlLCBybSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJtKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJlbW92ZU5vZGUodm5vZGUuZWxtKTsKICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHVwZGF0ZUNoaWxkcmVuIChwYXJlbnRFbG0sIG9sZENoLCBuZXdDaCwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCByZW1vdmVPbmx5KSB7CiAgICAgIHZhciBvbGRTdGFydElkeCA9IDA7CiAgICAgIHZhciBuZXdTdGFydElkeCA9IDA7CiAgICAgIHZhciBvbGRFbmRJZHggPSBvbGRDaC5sZW5ndGggLSAxOwogICAgICB2YXIgb2xkU3RhcnRWbm9kZSA9IG9sZENoWzBdOwogICAgICB2YXIgb2xkRW5kVm5vZGUgPSBvbGRDaFtvbGRFbmRJZHhdOwogICAgICB2YXIgbmV3RW5kSWR4ID0gbmV3Q2gubGVuZ3RoIC0gMTsKICAgICAgdmFyIG5ld1N0YXJ0Vm5vZGUgPSBuZXdDaFswXTsKICAgICAgdmFyIG5ld0VuZFZub2RlID0gbmV3Q2hbbmV3RW5kSWR4XTsKICAgICAgdmFyIG9sZEtleVRvSWR4LCBpZHhJbk9sZCwgdm5vZGVUb01vdmUsIHJlZkVsbTsKCiAgICAgIC8vIHJlbW92ZU9ubHkgaXMgYSBzcGVjaWFsIGZsYWcgdXNlZCBvbmx5IGJ5IDx0cmFuc2l0aW9uLWdyb3VwPgogICAgICAvLyB0byBlbnN1cmUgcmVtb3ZlZCBlbGVtZW50cyBzdGF5IGluIGNvcnJlY3QgcmVsYXRpdmUgcG9zaXRpb25zCiAgICAgIC8vIGR1cmluZyBsZWF2aW5nIHRyYW5zaXRpb25zCiAgICAgIHZhciBjYW5Nb3ZlID0gIXJlbW92ZU9ubHk7CgogICAgICB7CiAgICAgICAgY2hlY2tEdXBsaWNhdGVLZXlzKG5ld0NoKTsKICAgICAgfQoKICAgICAgd2hpbGUgKG9sZFN0YXJ0SWR4IDw9IG9sZEVuZElkeCAmJiBuZXdTdGFydElkeCA8PSBuZXdFbmRJZHgpIHsKICAgICAgICBpZiAoaXNVbmRlZihvbGRTdGFydFZub2RlKSkgewogICAgICAgICAgb2xkU3RhcnRWbm9kZSA9IG9sZENoWysrb2xkU3RhcnRJZHhdOyAvLyBWbm9kZSBoYXMgYmVlbiBtb3ZlZCBsZWZ0CiAgICAgICAgfSBlbHNlIGlmIChpc1VuZGVmKG9sZEVuZFZub2RlKSkgewogICAgICAgICAgb2xkRW5kVm5vZGUgPSBvbGRDaFstLW9sZEVuZElkeF07CiAgICAgICAgfSBlbHNlIGlmIChzYW1lVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3U3RhcnRWbm9kZSkpIHsKICAgICAgICAgIHBhdGNoVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgb2xkU3RhcnRWbm9kZSA9IG9sZENoWysrb2xkU3RhcnRJZHhdOwogICAgICAgICAgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWysrbmV3U3RhcnRJZHhdOwogICAgICAgIH0gZWxzZSBpZiAoc2FtZVZub2RlKG9sZEVuZFZub2RlLCBuZXdFbmRWbm9kZSkpIHsKICAgICAgICAgIHBhdGNoVm5vZGUob2xkRW5kVm5vZGUsIG5ld0VuZFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG5ld0NoLCBuZXdFbmRJZHgpOwogICAgICAgICAgb2xkRW5kVm5vZGUgPSBvbGRDaFstLW9sZEVuZElkeF07CiAgICAgICAgICBuZXdFbmRWbm9kZSA9IG5ld0NoWy0tbmV3RW5kSWR4XTsKICAgICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRTdGFydFZub2RlLCBuZXdFbmRWbm9kZSkpIHsgLy8gVm5vZGUgbW92ZWQgcmlnaHQKICAgICAgICAgIHBhdGNoVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3RW5kVm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld0VuZElkeCk7CiAgICAgICAgICBjYW5Nb3ZlICYmIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIG5vZGVPcHMubmV4dFNpYmxpbmcob2xkRW5kVm5vZGUuZWxtKSk7CiAgICAgICAgICBvbGRTdGFydFZub2RlID0gb2xkQ2hbKytvbGRTdGFydElkeF07CiAgICAgICAgICBuZXdFbmRWbm9kZSA9IG5ld0NoWy0tbmV3RW5kSWR4XTsKICAgICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRFbmRWbm9kZSwgbmV3U3RhcnRWbm9kZSkpIHsgLy8gVm5vZGUgbW92ZWQgbGVmdAogICAgICAgICAgcGF0Y2hWbm9kZShvbGRFbmRWbm9kZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgY2FuTW92ZSAmJiBub2RlT3BzLmluc2VydEJlZm9yZShwYXJlbnRFbG0sIG9sZEVuZFZub2RlLmVsbSwgb2xkU3RhcnRWbm9kZS5lbG0pOwogICAgICAgICAgb2xkRW5kVm5vZGUgPSBvbGRDaFstLW9sZEVuZElkeF07CiAgICAgICAgICBuZXdTdGFydFZub2RlID0gbmV3Q2hbKytuZXdTdGFydElkeF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpc1VuZGVmKG9sZEtleVRvSWR4KSkgeyBvbGRLZXlUb0lkeCA9IGNyZWF0ZUtleVRvT2xkSWR4KG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsgfQogICAgICAgICAgaWR4SW5PbGQgPSBpc0RlZihuZXdTdGFydFZub2RlLmtleSkKICAgICAgICAgICAgPyBvbGRLZXlUb0lkeFtuZXdTdGFydFZub2RlLmtleV0KICAgICAgICAgICAgOiBmaW5kSWR4SW5PbGQobmV3U3RhcnRWbm9kZSwgb2xkQ2gsIG9sZFN0YXJ0SWR4LCBvbGRFbmRJZHgpOwogICAgICAgICAgaWYgKGlzVW5kZWYoaWR4SW5PbGQpKSB7IC8vIE5ldyBlbGVtZW50CiAgICAgICAgICAgIGNyZWF0ZUVsbShuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIGZhbHNlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdm5vZGVUb01vdmUgPSBvbGRDaFtpZHhJbk9sZF07CiAgICAgICAgICAgIGlmIChzYW1lVm5vZGUodm5vZGVUb01vdmUsIG5ld1N0YXJ0Vm5vZGUpKSB7CiAgICAgICAgICAgICAgcGF0Y2hWbm9kZSh2bm9kZVRvTW92ZSwgbmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgICAgIG9sZENoW2lkeEluT2xkXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICBjYW5Nb3ZlICYmIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudEVsbSwgdm5vZGVUb01vdmUuZWxtLCBvbGRTdGFydFZub2RlLmVsbSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gc2FtZSBrZXkgYnV0IGRpZmZlcmVudCBlbGVtZW50LiB0cmVhdCBhcyBuZXcgZWxlbWVudAogICAgICAgICAgICAgIGNyZWF0ZUVsbShuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIGZhbHNlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBuZXdTdGFydFZub2RlID0gbmV3Q2hbKytuZXdTdGFydElkeF07CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChvbGRTdGFydElkeCA+IG9sZEVuZElkeCkgewogICAgICAgIHJlZkVsbSA9IGlzVW5kZWYobmV3Q2hbbmV3RW5kSWR4ICsgMV0pID8gbnVsbCA6IG5ld0NoW25ld0VuZElkeCArIDFdLmVsbTsKICAgICAgICBhZGRWbm9kZXMocGFyZW50RWxtLCByZWZFbG0sIG5ld0NoLCBuZXdTdGFydElkeCwgbmV3RW5kSWR4LCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICB9IGVsc2UgaWYgKG5ld1N0YXJ0SWR4ID4gbmV3RW5kSWR4KSB7CiAgICAgICAgcmVtb3ZlVm5vZGVzKHBhcmVudEVsbSwgb2xkQ2gsIG9sZFN0YXJ0SWR4LCBvbGRFbmRJZHgpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tEdXBsaWNhdGVLZXlzIChjaGlsZHJlbikgewogICAgICB2YXIgc2VlbktleXMgPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciB2bm9kZSA9IGNoaWxkcmVuW2ldOwogICAgICAgIHZhciBrZXkgPSB2bm9kZS5rZXk7CiAgICAgICAgaWYgKGlzRGVmKGtleSkpIHsKICAgICAgICAgIGlmIChzZWVuS2V5c1trZXldKSB7CiAgICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgICAgKCJEdXBsaWNhdGUga2V5cyBkZXRlY3RlZDogJyIgKyBrZXkgKyAiJy4gVGhpcyBtYXkgY2F1c2UgYW4gdXBkYXRlIGVycm9yLiIpLAogICAgICAgICAgICAgIHZub2RlLmNvbnRleHQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlZW5LZXlzW2tleV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGZpbmRJZHhJbk9sZCAobm9kZSwgb2xkQ2gsIHN0YXJ0LCBlbmQpIHsKICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyBpKyspIHsKICAgICAgICB2YXIgYyA9IG9sZENoW2ldOwogICAgICAgIGlmIChpc0RlZihjKSAmJiBzYW1lVm5vZGUobm9kZSwgYykpIHsgcmV0dXJuIGkgfQogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcGF0Y2hWbm9kZSAoCiAgICAgIG9sZFZub2RlLAogICAgICB2bm9kZSwKICAgICAgaW5zZXJ0ZWRWbm9kZVF1ZXVlLAogICAgICBvd25lckFycmF5LAogICAgICBpbmRleCwKICAgICAgcmVtb3ZlT25seQogICAgKSB7CiAgICAgIGlmIChvbGRWbm9kZSA9PT0gdm5vZGUpIHsKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgaWYgKGlzRGVmKHZub2RlLmVsbSkgJiYgaXNEZWYob3duZXJBcnJheSkpIHsKICAgICAgICAvLyBjbG9uZSByZXVzZWQgdm5vZGUKICAgICAgICB2bm9kZSA9IG93bmVyQXJyYXlbaW5kZXhdID0gY2xvbmVWTm9kZSh2bm9kZSk7CiAgICAgIH0KCiAgICAgIHZhciBlbG0gPSB2bm9kZS5lbG0gPSBvbGRWbm9kZS5lbG07CgogICAgICBpZiAoaXNUcnVlKG9sZFZub2RlLmlzQXN5bmNQbGFjZWhvbGRlcikpIHsKICAgICAgICBpZiAoaXNEZWYodm5vZGUuYXN5bmNGYWN0b3J5LnJlc29sdmVkKSkgewogICAgICAgICAgaHlkcmF0ZShvbGRWbm9kZS5lbG0sIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2bm9kZS5pc0FzeW5jUGxhY2Vob2xkZXIgPSB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgLy8gcmV1c2UgZWxlbWVudCBmb3Igc3RhdGljIHRyZWVzLgogICAgICAvLyBub3RlIHdlIG9ubHkgZG8gdGhpcyBpZiB0aGUgdm5vZGUgaXMgY2xvbmVkIC0KICAgICAgLy8gaWYgdGhlIG5ldyBub2RlIGlzIG5vdCBjbG9uZWQgaXQgbWVhbnMgdGhlIHJlbmRlciBmdW5jdGlvbnMgaGF2ZSBiZWVuCiAgICAgIC8vIHJlc2V0IGJ5IHRoZSBob3QtcmVsb2FkLWFwaSBhbmQgd2UgbmVlZCB0byBkbyBhIHByb3BlciByZS1yZW5kZXIuCiAgICAgIGlmIChpc1RydWUodm5vZGUuaXNTdGF0aWMpICYmCiAgICAgICAgaXNUcnVlKG9sZFZub2RlLmlzU3RhdGljKSAmJgogICAgICAgIHZub2RlLmtleSA9PT0gb2xkVm5vZGUua2V5ICYmCiAgICAgICAgKGlzVHJ1ZSh2bm9kZS5pc0Nsb25lZCkgfHwgaXNUcnVlKHZub2RlLmlzT25jZSkpCiAgICAgICkgewogICAgICAgIHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gb2xkVm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIHZhciBpOwogICAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgICAgIGlmIChpc0RlZihkYXRhKSAmJiBpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5wcmVwYXRjaCkpIHsKICAgICAgICBpKG9sZFZub2RlLCB2bm9kZSk7CiAgICAgIH0KCiAgICAgIHZhciBvbGRDaCA9IG9sZFZub2RlLmNoaWxkcmVuOwogICAgICB2YXIgY2ggPSB2bm9kZS5jaGlsZHJlbjsKICAgICAgaWYgKGlzRGVmKGRhdGEpICYmIGlzUGF0Y2hhYmxlKHZub2RlKSkgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjYnMudXBkYXRlLmxlbmd0aDsgKytpKSB7IGNicy51cGRhdGVbaV0ob2xkVm5vZGUsIHZub2RlKTsgfQogICAgICAgIGlmIChpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS51cGRhdGUpKSB7IGkob2xkVm5vZGUsIHZub2RlKTsgfQogICAgICB9CiAgICAgIGlmIChpc1VuZGVmKHZub2RlLnRleHQpKSB7CiAgICAgICAgaWYgKGlzRGVmKG9sZENoKSAmJiBpc0RlZihjaCkpIHsKICAgICAgICAgIGlmIChvbGRDaCAhPT0gY2gpIHsgdXBkYXRlQ2hpbGRyZW4oZWxtLCBvbGRDaCwgY2gsIGluc2VydGVkVm5vZGVRdWV1ZSwgcmVtb3ZlT25seSk7IH0KICAgICAgICB9IGVsc2UgaWYgKGlzRGVmKGNoKSkgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0R1cGxpY2F0ZUtleXMoY2gpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGVmKG9sZFZub2RlLnRleHQpKSB7IG5vZGVPcHMuc2V0VGV4dENvbnRlbnQoZWxtLCAnJyk7IH0KICAgICAgICAgIGFkZFZub2RlcyhlbG0sIG51bGwsIGNoLCAwLCBjaC5sZW5ndGggLSAxLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNEZWYob2xkQ2gpKSB7CiAgICAgICAgICByZW1vdmVWbm9kZXMoZWxtLCBvbGRDaCwgMCwgb2xkQ2gubGVuZ3RoIC0gMSk7CiAgICAgICAgfSBlbHNlIGlmIChpc0RlZihvbGRWbm9kZS50ZXh0KSkgewogICAgICAgICAgbm9kZU9wcy5zZXRUZXh0Q29udGVudChlbG0sICcnKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAob2xkVm5vZGUudGV4dCAhPT0gdm5vZGUudGV4dCkgewogICAgICAgIG5vZGVPcHMuc2V0VGV4dENvbnRlbnQoZWxtLCB2bm9kZS50ZXh0KTsKICAgICAgfQogICAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkucG9zdHBhdGNoKSkgeyBpKG9sZFZub2RlLCB2bm9kZSk7IH0KICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGludm9rZUluc2VydEhvb2sgKHZub2RlLCBxdWV1ZSwgaW5pdGlhbCkgewogICAgICAvLyBkZWxheSBpbnNlcnQgaG9va3MgZm9yIGNvbXBvbmVudCByb290IG5vZGVzLCBpbnZva2UgdGhlbSBhZnRlciB0aGUKICAgICAgLy8gZWxlbWVudCBpcyByZWFsbHkgaW5zZXJ0ZWQKICAgICAgaWYgKGlzVHJ1ZShpbml0aWFsKSAmJiBpc0RlZih2bm9kZS5wYXJlbnQpKSB7CiAgICAgICAgdm5vZGUucGFyZW50LmRhdGEucGVuZGluZ0luc2VydCA9IHF1ZXVlOwogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWUubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHF1ZXVlW2ldLmRhdGEuaG9vay5pbnNlcnQocXVldWVbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHZhciBoeWRyYXRpb25CYWlsZWQgPSBmYWxzZTsKICAgIC8vIGxpc3Qgb2YgbW9kdWxlcyB0aGF0IGNhbiBza2lwIGNyZWF0ZSBob29rIGR1cmluZyBoeWRyYXRpb24gYmVjYXVzZSB0aGV5CiAgICAvLyBhcmUgYWxyZWFkeSByZW5kZXJlZCBvbiB0aGUgY2xpZW50IG9yIGhhcyBubyBuZWVkIGZvciBpbml0aWFsaXphdGlvbgogICAgLy8gTm90ZTogc3R5bGUgaXMgZXhjbHVkZWQgYmVjYXVzZSBpdCByZWxpZXMgb24gaW5pdGlhbCBjbG9uZSBmb3IgZnV0dXJlCiAgICAvLyBkZWVwIHVwZGF0ZXMgKCM3MDYzKS4KICAgIHZhciBpc1JlbmRlcmVkTW9kdWxlID0gbWFrZU1hcCgnYXR0cnMsY2xhc3Msc3RhdGljQ2xhc3Msc3RhdGljU3R5bGUsa2V5Jyk7CgogICAgLy8gTm90ZTogdGhpcyBpcyBhIGJyb3dzZXItb25seSBmdW5jdGlvbiBzbyB3ZSBjYW4gYXNzdW1lIGVsbXMgYXJlIERPTSBub2Rlcy4KICAgIGZ1bmN0aW9uIGh5ZHJhdGUgKGVsbSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgaW5WUHJlKSB7CiAgICAgIHZhciBpOwogICAgICB2YXIgdGFnID0gdm5vZGUudGFnOwogICAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgICAgIHZhciBjaGlsZHJlbiA9IHZub2RlLmNoaWxkcmVuOwogICAgICBpblZQcmUgPSBpblZQcmUgfHwgKGRhdGEgJiYgZGF0YS5wcmUpOwogICAgICB2bm9kZS5lbG0gPSBlbG07CgogICAgICBpZiAoaXNUcnVlKHZub2RlLmlzQ29tbWVudCkgJiYgaXNEZWYodm5vZGUuYXN5bmNGYWN0b3J5KSkgewogICAgICAgIHZub2RlLmlzQXN5bmNQbGFjZWhvbGRlciA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICAvLyBhc3NlcnQgbm9kZSBtYXRjaAogICAgICB7CiAgICAgICAgaWYgKCFhc3NlcnROb2RlTWF0Y2goZWxtLCB2bm9kZSwgaW5WUHJlKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICAgIGlmIChpc0RlZihpID0gZGF0YS5ob29rKSAmJiBpc0RlZihpID0gaS5pbml0KSkgeyBpKHZub2RlLCB0cnVlIC8qIGh5ZHJhdGluZyAqLyk7IH0KICAgICAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlKSkgewogICAgICAgICAgLy8gY2hpbGQgY29tcG9uZW50LiBpdCBzaG91bGQgaGF2ZSBoeWRyYXRlZCBpdHMgb3duIHRyZWUuCiAgICAgICAgICBpbml0Q29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgICAgcmV0dXJuIHRydWUKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGlzRGVmKHRhZykpIHsKICAgICAgICBpZiAoaXNEZWYoY2hpbGRyZW4pKSB7CiAgICAgICAgICAvLyBlbXB0eSBlbGVtZW50LCBhbGxvdyBjbGllbnQgdG8gcGljayB1cCBhbmQgcG9wdWxhdGUgY2hpbGRyZW4KICAgICAgICAgIGlmICghZWxtLmhhc0NoaWxkTm9kZXMoKSkgewogICAgICAgICAgICBjcmVhdGVDaGlsZHJlbih2bm9kZSwgY2hpbGRyZW4sIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyB2LWh0bWwgYW5kIGRvbVByb3BzOiBpbm5lckhUTUwKICAgICAgICAgICAgaWYgKGlzRGVmKGkgPSBkYXRhKSAmJiBpc0RlZihpID0gaS5kb21Qcm9wcykgJiYgaXNEZWYoaSA9IGkuaW5uZXJIVE1MKSkgewogICAgICAgICAgICAgIGlmIChpICE9PSBlbG0uaW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgICAgICAgICAgICAgICAgIWh5ZHJhdGlvbkJhaWxlZAogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgIGh5ZHJhdGlvbkJhaWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignUGFyZW50OiAnLCBlbG0pOwogICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ3NlcnZlciBpbm5lckhUTUw6ICcsIGkpOwogICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ2NsaWVudCBpbm5lckhUTUw6ICcsIGVsbS5pbm5lckhUTUwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIGl0ZXJhdGUgYW5kIGNvbXBhcmUgY2hpbGRyZW4gbGlzdHMKICAgICAgICAgICAgICB2YXIgY2hpbGRyZW5NYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIGNoaWxkTm9kZSA9IGVsbS5maXJzdENoaWxkOwogICAgICAgICAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IGNoaWxkcmVuLmxlbmd0aDsgaSQxKyspIHsKICAgICAgICAgICAgICAgIGlmICghY2hpbGROb2RlIHx8ICFoeWRyYXRlKGNoaWxkTm9kZSwgY2hpbGRyZW5baSQxXSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBpblZQcmUpKSB7CiAgICAgICAgICAgICAgICAgIGNoaWxkcmVuTWF0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gaWYgY2hpbGROb2RlIGlzIG5vdCBudWxsLCBpdCBtZWFucyB0aGUgYWN0dWFsIGNoaWxkTm9kZXMgbGlzdCBpcwogICAgICAgICAgICAgIC8vIGxvbmdlciB0aGFuIHRoZSB2aXJ0dWFsIGNoaWxkcmVuIGxpc3QuCiAgICAgICAgICAgICAgaWYgKCFjaGlsZHJlbk1hdGNoIHx8IGNoaWxkTm9kZSkgewogICAgICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmCiAgICAgICAgICAgICAgICAgICFoeWRyYXRpb25CYWlsZWQKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICBoeWRyYXRpb25CYWlsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BhcmVudDogJywgZWxtKTsKICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdNaXNtYXRjaGluZyBjaGlsZE5vZGVzIHZzLiBWTm9kZXM6ICcsIGVsbS5jaGlsZE5vZGVzLCBjaGlsZHJlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgICAgICB2YXIgZnVsbEludm9rZSA9IGZhbHNlOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgaWYgKCFpc1JlbmRlcmVkTW9kdWxlKGtleSkpIHsKICAgICAgICAgICAgICBmdWxsSW52b2tlID0gdHJ1ZTsKICAgICAgICAgICAgICBpbnZva2VDcmVhdGVIb29rcyh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWZ1bGxJbnZva2UgJiYgZGF0YVsnY2xhc3MnXSkgewogICAgICAgICAgICAvLyBlbnN1cmUgY29sbGVjdGluZyBkZXBzIGZvciBkZWVwIGNsYXNzIGJpbmRpbmdzIGZvciBmdXR1cmUgdXBkYXRlcwogICAgICAgICAgICB0cmF2ZXJzZShkYXRhWydjbGFzcyddKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZWxtLmRhdGEgIT09IHZub2RlLnRleHQpIHsKICAgICAgICBlbG0uZGF0YSA9IHZub2RlLnRleHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWUKICAgIH0KCiAgICBmdW5jdGlvbiBhc3NlcnROb2RlTWF0Y2ggKG5vZGUsIHZub2RlLCBpblZQcmUpIHsKICAgICAgaWYgKGlzRGVmKHZub2RlLnRhZykpIHsKICAgICAgICByZXR1cm4gdm5vZGUudGFnLmluZGV4T2YoJ3Z1ZS1jb21wb25lbnQnKSA9PT0gMCB8fCAoCiAgICAgICAgICAhaXNVbmtub3duRWxlbWVudCQkMSh2bm9kZSwgaW5WUHJlKSAmJgogICAgICAgICAgdm5vZGUudGFnLnRvTG93ZXJDYXNlKCkgPT09IChub2RlLnRhZ05hbWUgJiYgbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkpCiAgICAgICAgKQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09PSAodm5vZGUuaXNDb21tZW50ID8gOCA6IDMpCiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gcGF0Y2ggKG9sZFZub2RlLCB2bm9kZSwgaHlkcmF0aW5nLCByZW1vdmVPbmx5KSB7CiAgICAgIGlmIChpc1VuZGVmKHZub2RlKSkgewogICAgICAgIGlmIChpc0RlZihvbGRWbm9kZSkpIHsgaW52b2tlRGVzdHJveUhvb2sob2xkVm5vZGUpOyB9CiAgICAgICAgcmV0dXJuCiAgICAgIH0KCiAgICAgIHZhciBpc0luaXRpYWxQYXRjaCA9IGZhbHNlOwogICAgICB2YXIgaW5zZXJ0ZWRWbm9kZVF1ZXVlID0gW107CgogICAgICBpZiAoaXNVbmRlZihvbGRWbm9kZSkpIHsKICAgICAgICAvLyBlbXB0eSBtb3VudCAobGlrZWx5IGFzIGNvbXBvbmVudCksIGNyZWF0ZSBuZXcgcm9vdCBlbGVtZW50CiAgICAgICAgaXNJbml0aWFsUGF0Y2ggPSB0cnVlOwogICAgICAgIGNyZWF0ZUVsbSh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgaXNSZWFsRWxlbWVudCA9IGlzRGVmKG9sZFZub2RlLm5vZGVUeXBlKTsKICAgICAgICBpZiAoIWlzUmVhbEVsZW1lbnQgJiYgc2FtZVZub2RlKG9sZFZub2RlLCB2bm9kZSkpIHsKICAgICAgICAgIC8vIHBhdGNoIGV4aXN0aW5nIHJvb3Qgbm9kZQogICAgICAgICAgcGF0Y2hWbm9kZShvbGRWbm9kZSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbnVsbCwgbnVsbCwgcmVtb3ZlT25seSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpc1JlYWxFbGVtZW50KSB7CiAgICAgICAgICAgIC8vIG1vdW50aW5nIHRvIGEgcmVhbCBlbGVtZW50CiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHRoaXMgaXMgc2VydmVyLXJlbmRlcmVkIGNvbnRlbnQgYW5kIGlmIHdlIGNhbiBwZXJmb3JtCiAgICAgICAgICAgIC8vIGEgc3VjY2Vzc2Z1bCBoeWRyYXRpb24uCiAgICAgICAgICAgIGlmIChvbGRWbm9kZS5ub2RlVHlwZSA9PT0gMSAmJiBvbGRWbm9kZS5oYXNBdHRyaWJ1dGUoU1NSX0FUVFIpKSB7CiAgICAgICAgICAgICAgb2xkVm5vZGUucmVtb3ZlQXR0cmlidXRlKFNTUl9BVFRSKTsKICAgICAgICAgICAgICBoeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc1RydWUoaHlkcmF0aW5nKSkgewogICAgICAgICAgICAgIGlmIChoeWRyYXRlKG9sZFZub2RlLCB2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSkgewogICAgICAgICAgICAgICAgaW52b2tlSW5zZXJ0SG9vayh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybiBvbGRWbm9kZQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuKAogICAgICAgICAgICAgICAgICAnVGhlIGNsaWVudC1zaWRlIHJlbmRlcmVkIHZpcnR1YWwgRE9NIHRyZWUgaXMgbm90IG1hdGNoaW5nICcgKwogICAgICAgICAgICAgICAgICAnc2VydmVyLXJlbmRlcmVkIGNvbnRlbnQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSBpbmNvcnJlY3QgJyArCiAgICAgICAgICAgICAgICAgICdIVE1MIG1hcmt1cCwgZm9yIGV4YW1wbGUgbmVzdGluZyBibG9jay1sZXZlbCBlbGVtZW50cyBpbnNpZGUgJyArCiAgICAgICAgICAgICAgICAgICc8cD4sIG9yIG1pc3NpbmcgPHRib2R5Pi4gQmFpbGluZyBoeWRyYXRpb24gYW5kIHBlcmZvcm1pbmcgJyArCiAgICAgICAgICAgICAgICAgICdmdWxsIGNsaWVudC1zaWRlIHJlbmRlci4nCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBlaXRoZXIgbm90IHNlcnZlci1yZW5kZXJlZCwgb3IgaHlkcmF0aW9uIGZhaWxlZC4KICAgICAgICAgICAgLy8gY3JlYXRlIGFuIGVtcHR5IG5vZGUgYW5kIHJlcGxhY2UgaXQKICAgICAgICAgICAgb2xkVm5vZGUgPSBlbXB0eU5vZGVBdChvbGRWbm9kZSk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gcmVwbGFjaW5nIGV4aXN0aW5nIGVsZW1lbnQKICAgICAgICAgIHZhciBvbGRFbG0gPSBvbGRWbm9kZS5lbG07CiAgICAgICAgICB2YXIgcGFyZW50RWxtID0gbm9kZU9wcy5wYXJlbnROb2RlKG9sZEVsbSk7CgogICAgICAgICAgLy8gY3JlYXRlIG5ldyBub2RlCiAgICAgICAgICBjcmVhdGVFbG0oCiAgICAgICAgICAgIHZub2RlLAogICAgICAgICAgICBpbnNlcnRlZFZub2RlUXVldWUsCiAgICAgICAgICAgIC8vIGV4dHJlbWVseSByYXJlIGVkZ2UgY2FzZTogZG8gbm90IGluc2VydCBpZiBvbGQgZWxlbWVudCBpcyBpbiBhCiAgICAgICAgICAgIC8vIGxlYXZpbmcgdHJhbnNpdGlvbi4gT25seSBoYXBwZW5zIHdoZW4gY29tYmluaW5nIHRyYW5zaXRpb24gKwogICAgICAgICAgICAvLyBrZWVwLWFsaXZlICsgSE9Dcy4gKCM0NTkwKQogICAgICAgICAgICBvbGRFbG0uX2xlYXZlQ2IgPyBudWxsIDogcGFyZW50RWxtLAogICAgICAgICAgICBub2RlT3BzLm5leHRTaWJsaW5nKG9sZEVsbSkKICAgICAgICAgICk7CgogICAgICAgICAgLy8gdXBkYXRlIHBhcmVudCBwbGFjZWhvbGRlciBub2RlIGVsZW1lbnQsIHJlY3Vyc2l2ZWx5CiAgICAgICAgICBpZiAoaXNEZWYodm5vZGUucGFyZW50KSkgewogICAgICAgICAgICB2YXIgYW5jZXN0b3IgPSB2bm9kZS5wYXJlbnQ7CiAgICAgICAgICAgIHZhciBwYXRjaGFibGUgPSBpc1BhdGNoYWJsZSh2bm9kZSk7CiAgICAgICAgICAgIHdoaWxlIChhbmNlc3RvcikgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2JzLmRlc3Ryb3kubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIGNicy5kZXN0cm95W2ldKGFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYW5jZXN0b3IuZWxtID0gdm5vZGUuZWxtOwogICAgICAgICAgICAgIGlmIChwYXRjaGFibGUpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IGNicy5jcmVhdGUubGVuZ3RoOyArK2kkMSkgewogICAgICAgICAgICAgICAgICBjYnMuY3JlYXRlW2kkMV0oZW1wdHlOb2RlLCBhbmNlc3Rvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyAjNjUxMwogICAgICAgICAgICAgICAgLy8gaW52b2tlIGluc2VydCBob29rcyB0aGF0IG1heSBoYXZlIGJlZW4gbWVyZ2VkIGJ5IGNyZWF0ZSBob29rcy4KICAgICAgICAgICAgICAgIC8vIGUuZy4gZm9yIGRpcmVjdGl2ZXMgdGhhdCB1c2VzIHRoZSAiaW5zZXJ0ZWQiIGhvb2suCiAgICAgICAgICAgICAgICB2YXIgaW5zZXJ0ID0gYW5jZXN0b3IuZGF0YS5ob29rLmluc2VydDsKICAgICAgICAgICAgICAgIGlmIChpbnNlcnQubWVyZ2VkKSB7CiAgICAgICAgICAgICAgICAgIC8vIHN0YXJ0IGF0IGluZGV4IDEgdG8gYXZvaWQgcmUtaW52b2tpbmcgY29tcG9uZW50IG1vdW50ZWQgaG9vawogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpJDIgPSAxOyBpJDIgPCBpbnNlcnQuZm5zLmxlbmd0aDsgaSQyKyspIHsKICAgICAgICAgICAgICAgICAgICBpbnNlcnQuZm5zW2kkMl0oKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZWdpc3RlclJlZihhbmNlc3Rvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFuY2VzdG9yID0gYW5jZXN0b3IucGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZGVzdHJveSBvbGQgbm9kZQogICAgICAgICAgaWYgKGlzRGVmKHBhcmVudEVsbSkpIHsKICAgICAgICAgICAgcmVtb3ZlVm5vZGVzKHBhcmVudEVsbSwgW29sZFZub2RlXSwgMCwgMCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzRGVmKG9sZFZub2RlLnRhZykpIHsKICAgICAgICAgICAgaW52b2tlRGVzdHJveUhvb2sob2xkVm5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaW52b2tlSW5zZXJ0SG9vayh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBpc0luaXRpYWxQYXRjaCk7CiAgICAgIHJldHVybiB2bm9kZS5lbG0KICAgIH0KICB9CgogIC8qICAqLwoKICB2YXIgZGlyZWN0aXZlcyA9IHsKICAgIGNyZWF0ZTogdXBkYXRlRGlyZWN0aXZlcywKICAgIHVwZGF0ZTogdXBkYXRlRGlyZWN0aXZlcywKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uIHVuYmluZERpcmVjdGl2ZXMgKHZub2RlKSB7CiAgICAgIHVwZGF0ZURpcmVjdGl2ZXModm5vZGUsIGVtcHR5Tm9kZSk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gdXBkYXRlRGlyZWN0aXZlcyAob2xkVm5vZGUsIHZub2RlKSB7CiAgICBpZiAob2xkVm5vZGUuZGF0YS5kaXJlY3RpdmVzIHx8IHZub2RlLmRhdGEuZGlyZWN0aXZlcykgewogICAgICBfdXBkYXRlKG9sZFZub2RlLCB2bm9kZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBfdXBkYXRlIChvbGRWbm9kZSwgdm5vZGUpIHsKICAgIHZhciBpc0NyZWF0ZSA9IG9sZFZub2RlID09PSBlbXB0eU5vZGU7CiAgICB2YXIgaXNEZXN0cm95ID0gdm5vZGUgPT09IGVtcHR5Tm9kZTsKICAgIHZhciBvbGREaXJzID0gbm9ybWFsaXplRGlyZWN0aXZlcyQxKG9sZFZub2RlLmRhdGEuZGlyZWN0aXZlcywgb2xkVm5vZGUuY29udGV4dCk7CiAgICB2YXIgbmV3RGlycyA9IG5vcm1hbGl6ZURpcmVjdGl2ZXMkMSh2bm9kZS5kYXRhLmRpcmVjdGl2ZXMsIHZub2RlLmNvbnRleHQpOwoKICAgIHZhciBkaXJzV2l0aEluc2VydCA9IFtdOwogICAgdmFyIGRpcnNXaXRoUG9zdHBhdGNoID0gW107CgogICAgdmFyIGtleSwgb2xkRGlyLCBkaXI7CiAgICBmb3IgKGtleSBpbiBuZXdEaXJzKSB7CiAgICAgIG9sZERpciA9IG9sZERpcnNba2V5XTsKICAgICAgZGlyID0gbmV3RGlyc1trZXldOwogICAgICBpZiAoIW9sZERpcikgewogICAgICAgIC8vIG5ldyBkaXJlY3RpdmUsIGJpbmQKICAgICAgICBjYWxsSG9vayQxKGRpciwgJ2JpbmQnLCB2bm9kZSwgb2xkVm5vZGUpOwogICAgICAgIGlmIChkaXIuZGVmICYmIGRpci5kZWYuaW5zZXJ0ZWQpIHsKICAgICAgICAgIGRpcnNXaXRoSW5zZXJ0LnB1c2goZGlyKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZXhpc3RpbmcgZGlyZWN0aXZlLCB1cGRhdGUKICAgICAgICBkaXIub2xkVmFsdWUgPSBvbGREaXIudmFsdWU7CiAgICAgICAgY2FsbEhvb2skMShkaXIsICd1cGRhdGUnLCB2bm9kZSwgb2xkVm5vZGUpOwogICAgICAgIGlmIChkaXIuZGVmICYmIGRpci5kZWYuY29tcG9uZW50VXBkYXRlZCkgewogICAgICAgICAgZGlyc1dpdGhQb3N0cGF0Y2gucHVzaChkaXIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChkaXJzV2l0aEluc2VydC5sZW5ndGgpIHsKICAgICAgdmFyIGNhbGxJbnNlcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXJzV2l0aEluc2VydC5sZW5ndGg7IGkrKykgewogICAgICAgICAgY2FsbEhvb2skMShkaXJzV2l0aEluc2VydFtpXSwgJ2luc2VydGVkJywgdm5vZGUsIG9sZFZub2RlKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGlmIChpc0NyZWF0ZSkgewogICAgICAgIG1lcmdlVk5vZGVIb29rKHZub2RlLCAnaW5zZXJ0JywgY2FsbEluc2VydCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbEluc2VydCgpOwogICAgICB9CiAgICB9CgogICAgaWYgKGRpcnNXaXRoUG9zdHBhdGNoLmxlbmd0aCkgewogICAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ3Bvc3RwYXRjaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpcnNXaXRoUG9zdHBhdGNoLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjYWxsSG9vayQxKGRpcnNXaXRoUG9zdHBhdGNoW2ldLCAnY29tcG9uZW50VXBkYXRlZCcsIHZub2RlLCBvbGRWbm9kZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBpZiAoIWlzQ3JlYXRlKSB7CiAgICAgIGZvciAoa2V5IGluIG9sZERpcnMpIHsKICAgICAgICBpZiAoIW5ld0RpcnNba2V5XSkgewogICAgICAgICAgLy8gbm8gbG9uZ2VyIHByZXNlbnQsIHVuYmluZAogICAgICAgICAgY2FsbEhvb2skMShvbGREaXJzW2tleV0sICd1bmJpbmQnLCBvbGRWbm9kZSwgb2xkVm5vZGUsIGlzRGVzdHJveSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICB2YXIgZW1wdHlNb2RpZmllcnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKICBmdW5jdGlvbiBub3JtYWxpemVEaXJlY3RpdmVzJDEgKAogICAgZGlycywKICAgIHZtCiAgKSB7CiAgICB2YXIgcmVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIGlmICghZGlycykgewogICAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgICAgcmV0dXJuIHJlcwogICAgfQogICAgdmFyIGksIGRpcjsKICAgIGZvciAoaSA9IDA7IGkgPCBkaXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGRpciA9IGRpcnNbaV07CiAgICAgIGlmICghZGlyLm1vZGlmaWVycykgewogICAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgICAgIGRpci5tb2RpZmllcnMgPSBlbXB0eU1vZGlmaWVyczsKICAgICAgfQogICAgICByZXNbZ2V0UmF3RGlyTmFtZShkaXIpXSA9IGRpcjsKICAgICAgZGlyLmRlZiA9IHJlc29sdmVBc3NldCh2bS4kb3B0aW9ucywgJ2RpcmVjdGl2ZXMnLCBkaXIubmFtZSwgdHJ1ZSk7CiAgICB9CiAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgIHJldHVybiByZXMKICB9CgogIGZ1bmN0aW9uIGdldFJhd0Rpck5hbWUgKGRpcikgewogICAgcmV0dXJuIGRpci5yYXdOYW1lIHx8ICgoZGlyLm5hbWUpICsgIi4iICsgKE9iamVjdC5rZXlzKGRpci5tb2RpZmllcnMgfHwge30pLmpvaW4oJy4nKSkpCiAgfQoKICBmdW5jdGlvbiBjYWxsSG9vayQxIChkaXIsIGhvb2ssIHZub2RlLCBvbGRWbm9kZSwgaXNEZXN0cm95KSB7CiAgICB2YXIgZm4gPSBkaXIuZGVmICYmIGRpci5kZWZbaG9va107CiAgICBpZiAoZm4pIHsKICAgICAgdHJ5IHsKICAgICAgICBmbih2bm9kZS5lbG0sIGRpciwgdm5vZGUsIG9sZFZub2RlLCBpc0Rlc3Ryb3kpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaGFuZGxlRXJyb3IoZSwgdm5vZGUuY29udGV4dCwgKCJkaXJlY3RpdmUgIiArIChkaXIubmFtZSkgKyAiICIgKyBob29rICsgIiBob29rIikpOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgYmFzZU1vZHVsZXMgPSBbCiAgICByZWYsCiAgICBkaXJlY3RpdmVzCiAgXTsKCiAgLyogICovCgogIGZ1bmN0aW9uIHVwZGF0ZUF0dHJzIChvbGRWbm9kZSwgdm5vZGUpIHsKICAgIHZhciBvcHRzID0gdm5vZGUuY29tcG9uZW50T3B0aW9uczsKICAgIGlmIChpc0RlZihvcHRzKSAmJiBvcHRzLkN0b3Iub3B0aW9ucy5pbmhlcml0QXR0cnMgPT09IGZhbHNlKSB7CiAgICAgIHJldHVybgogICAgfQogICAgaWYgKGlzVW5kZWYob2xkVm5vZGUuZGF0YS5hdHRycykgJiYgaXNVbmRlZih2bm9kZS5kYXRhLmF0dHJzKSkgewogICAgICByZXR1cm4KICAgIH0KICAgIHZhciBrZXksIGN1ciwgb2xkOwogICAgdmFyIGVsbSA9IHZub2RlLmVsbTsKICAgIHZhciBvbGRBdHRycyA9IG9sZFZub2RlLmRhdGEuYXR0cnMgfHwge307CiAgICB2YXIgYXR0cnMgPSB2bm9kZS5kYXRhLmF0dHJzIHx8IHt9OwogICAgLy8gY2xvbmUgb2JzZXJ2ZWQgb2JqZWN0cywgYXMgdGhlIHVzZXIgcHJvYmFibHkgd2FudHMgdG8gbXV0YXRlIGl0CiAgICBpZiAoaXNEZWYoYXR0cnMuX19vYl9fKSkgewogICAgICBhdHRycyA9IHZub2RlLmRhdGEuYXR0cnMgPSBleHRlbmQoe30sIGF0dHJzKTsKICAgIH0KCiAgICBmb3IgKGtleSBpbiBhdHRycykgewogICAgICBjdXIgPSBhdHRyc1trZXldOwogICAgICBvbGQgPSBvbGRBdHRyc1trZXldOwogICAgICBpZiAob2xkICE9PSBjdXIpIHsKICAgICAgICBzZXRBdHRyKGVsbSwga2V5LCBjdXIpOwogICAgICB9CiAgICB9CiAgICAvLyAjNDM5MTogaW4gSUU5LCBzZXR0aW5nIHR5cGUgY2FuIHJlc2V0IHZhbHVlIGZvciBpbnB1dFt0eXBlPXJhZGlvXQogICAgLy8gIzY2NjY6IElFL0VkZ2UgZm9yY2VzIHByb2dyZXNzIHZhbHVlIGRvd24gdG8gMSBiZWZvcmUgc2V0dGluZyBhIG1heAogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoKGlzSUUgfHwgaXNFZGdlKSAmJiBhdHRycy52YWx1ZSAhPT0gb2xkQXR0cnMudmFsdWUpIHsKICAgICAgc2V0QXR0cihlbG0sICd2YWx1ZScsIGF0dHJzLnZhbHVlKTsKICAgIH0KICAgIGZvciAoa2V5IGluIG9sZEF0dHJzKSB7CiAgICAgIGlmIChpc1VuZGVmKGF0dHJzW2tleV0pKSB7CiAgICAgICAgaWYgKGlzWGxpbmsoa2V5KSkgewogICAgICAgICAgZWxtLnJlbW92ZUF0dHJpYnV0ZU5TKHhsaW5rTlMsIGdldFhsaW5rUHJvcChrZXkpKTsKICAgICAgICB9IGVsc2UgaWYgKCFpc0VudW1lcmF0ZWRBdHRyKGtleSkpIHsKICAgICAgICAgIGVsbS5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHNldEF0dHIgKGVsLCBrZXksIHZhbHVlKSB7CiAgICBpZiAoZWwudGFnTmFtZS5pbmRleE9mKCctJykgPiAtMSkgewogICAgICBiYXNlU2V0QXR0cihlbCwga2V5LCB2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKGlzQm9vbGVhbkF0dHIoa2V5KSkgewogICAgICAvLyBzZXQgYXR0cmlidXRlIGZvciBibGFuayB2YWx1ZQogICAgICAvLyBlLmcuIDxvcHRpb24gZGlzYWJsZWQ+U2VsZWN0IG9uZTwvb3B0aW9uPgogICAgICBpZiAoaXNGYWxzeUF0dHJWYWx1ZSh2YWx1ZSkpIHsKICAgICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB0ZWNobmljYWxseSBhbGxvd2Z1bGxzY3JlZW4gaXMgYSBib29sZWFuIGF0dHJpYnV0ZSBmb3IgPGlmcmFtZT4sCiAgICAgICAgLy8gYnV0IEZsYXNoIGV4cGVjdHMgYSB2YWx1ZSBvZiAidHJ1ZSIgd2hlbiB1c2VkIG9uIDxlbWJlZD4gdGFnCiAgICAgICAgdmFsdWUgPSBrZXkgPT09ICdhbGxvd2Z1bGxzY3JlZW4nICYmIGVsLnRhZ05hbWUgPT09ICdFTUJFRCcKICAgICAgICAgID8gJ3RydWUnCiAgICAgICAgICA6IGtleTsKICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNFbnVtZXJhdGVkQXR0cihrZXkpKSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpIHx8IHZhbHVlID09PSAnZmFsc2UnID8gJ2ZhbHNlJyA6ICd0cnVlJyk7CiAgICB9IGVsc2UgaWYgKGlzWGxpbmsoa2V5KSkgewogICAgICBpZiAoaXNGYWxzeUF0dHJWYWx1ZSh2YWx1ZSkpIHsKICAgICAgICBlbC5yZW1vdmVBdHRyaWJ1dGVOUyh4bGlua05TLCBnZXRYbGlua1Byb3Aoa2V5KSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWwuc2V0QXR0cmlidXRlTlMoeGxpbmtOUywga2V5LCB2YWx1ZSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGJhc2VTZXRBdHRyKGVsLCBrZXksIHZhbHVlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGJhc2VTZXRBdHRyIChlbCwga2V5LCB2YWx1ZSkgewogICAgaWYgKGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpKSB7CiAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogICAgfSBlbHNlIHsKICAgICAgLy8gIzcxMzg6IElFMTAgJiAxMSBmaXJlcyBpbnB1dCBldmVudCB3aGVuIHNldHRpbmcgcGxhY2Vob2xkZXIgb24KICAgICAgLy8gPHRleHRhcmVhPi4uLiBibG9jayB0aGUgZmlyc3QgaW5wdXQgZXZlbnQgYW5kIHJlbW92ZSB0aGUgYmxvY2tlcgogICAgICAvLyBpbW1lZGlhdGVseS4KICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmICgKICAgICAgICBpc0lFICYmICFpc0lFOSAmJgogICAgICAgIChlbC50YWdOYW1lID09PSAnVEVYVEFSRUEnIHx8IGVsLnRhZ05hbWUgPT09ICdJTlBVVCcpICYmCiAgICAgICAga2V5ID09PSAncGxhY2Vob2xkZXInICYmICFlbC5fX2llcGgKICAgICAgKSB7CiAgICAgICAgdmFyIGJsb2NrZXIgPSBmdW5jdGlvbiAoZSkgewogICAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2lucHV0JywgYmxvY2tlcik7CiAgICAgICAgfTsKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIGJsb2NrZXIpOwogICAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgICAgIGVsLl9faWVwaCA9IHRydWU7IC8qIElFIHBsYWNlaG9sZGVyIHBhdGNoZWQgKi8KICAgICAgfQogICAgICBlbC5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZSk7CiAgICB9CiAgfQoKICB2YXIgYXR0cnMgPSB7CiAgICBjcmVhdGU6IHVwZGF0ZUF0dHJzLAogICAgdXBkYXRlOiB1cGRhdGVBdHRycwogIH07CgogIC8qICAqLwoKICBmdW5jdGlvbiB1cGRhdGVDbGFzcyAob2xkVm5vZGUsIHZub2RlKSB7CiAgICB2YXIgZWwgPSB2bm9kZS5lbG07CiAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgICB2YXIgb2xkRGF0YSA9IG9sZFZub2RlLmRhdGE7CiAgICBpZiAoCiAgICAgIGlzVW5kZWYoZGF0YS5zdGF0aWNDbGFzcykgJiYKICAgICAgaXNVbmRlZihkYXRhLmNsYXNzKSAmJiAoCiAgICAgICAgaXNVbmRlZihvbGREYXRhKSB8fCAoCiAgICAgICAgICBpc1VuZGVmKG9sZERhdGEuc3RhdGljQ2xhc3MpICYmCiAgICAgICAgICBpc1VuZGVmKG9sZERhdGEuY2xhc3MpCiAgICAgICAgKQogICAgICApCiAgICApIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdmFyIGNscyA9IGdlbkNsYXNzRm9yVm5vZGUodm5vZGUpOwoKICAgIC8vIGhhbmRsZSB0cmFuc2l0aW9uIGNsYXNzZXMKICAgIHZhciB0cmFuc2l0aW9uQ2xhc3MgPSBlbC5fdHJhbnNpdGlvbkNsYXNzZXM7CiAgICBpZiAoaXNEZWYodHJhbnNpdGlvbkNsYXNzKSkgewogICAgICBjbHMgPSBjb25jYXQoY2xzLCBzdHJpbmdpZnlDbGFzcyh0cmFuc2l0aW9uQ2xhc3MpKTsKICAgIH0KCiAgICAvLyBzZXQgdGhlIGNsYXNzCiAgICBpZiAoY2xzICE9PSBlbC5fcHJldkNsYXNzKSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBjbHMpOwogICAgICBlbC5fcHJldkNsYXNzID0gY2xzOwogICAgfQogIH0KCiAgdmFyIGtsYXNzID0gewogICAgY3JlYXRlOiB1cGRhdGVDbGFzcywKICAgIHVwZGF0ZTogdXBkYXRlQ2xhc3MKICB9OwoKICAvKiAgKi8KCiAgdmFyIHZhbGlkRGl2aXNpb25DaGFyUkUgPSAvW1x3KS4rXC1fJFxdXS87CgogIGZ1bmN0aW9uIHBhcnNlRmlsdGVycyAoZXhwKSB7CiAgICB2YXIgaW5TaW5nbGUgPSBmYWxzZTsKICAgIHZhciBpbkRvdWJsZSA9IGZhbHNlOwogICAgdmFyIGluVGVtcGxhdGVTdHJpbmcgPSBmYWxzZTsKICAgIHZhciBpblJlZ2V4ID0gZmFsc2U7CiAgICB2YXIgY3VybHkgPSAwOwogICAgdmFyIHNxdWFyZSA9IDA7CiAgICB2YXIgcGFyZW4gPSAwOwogICAgdmFyIGxhc3RGaWx0ZXJJbmRleCA9IDA7CiAgICB2YXIgYywgcHJldiwgaSwgZXhwcmVzc2lvbiwgZmlsdGVyczsKCiAgICBmb3IgKGkgPSAwOyBpIDwgZXhwLmxlbmd0aDsgaSsrKSB7CiAgICAgIHByZXYgPSBjOwogICAgICBjID0gZXhwLmNoYXJDb2RlQXQoaSk7CiAgICAgIGlmIChpblNpbmdsZSkgewogICAgICAgIGlmIChjID09PSAweDI3ICYmIHByZXYgIT09IDB4NUMpIHsgaW5TaW5nbGUgPSBmYWxzZTsgfQogICAgICB9IGVsc2UgaWYgKGluRG91YmxlKSB7CiAgICAgICAgaWYgKGMgPT09IDB4MjIgJiYgcHJldiAhPT0gMHg1QykgeyBpbkRvdWJsZSA9IGZhbHNlOyB9CiAgICAgIH0gZWxzZSBpZiAoaW5UZW1wbGF0ZVN0cmluZykgewogICAgICAgIGlmIChjID09PSAweDYwICYmIHByZXYgIT09IDB4NUMpIHsgaW5UZW1wbGF0ZVN0cmluZyA9IGZhbHNlOyB9CiAgICAgIH0gZWxzZSBpZiAoaW5SZWdleCkgewogICAgICAgIGlmIChjID09PSAweDJmICYmIHByZXYgIT09IDB4NUMpIHsgaW5SZWdleCA9IGZhbHNlOyB9CiAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgYyA9PT0gMHg3QyAmJiAvLyBwaXBlCiAgICAgICAgZXhwLmNoYXJDb2RlQXQoaSArIDEpICE9PSAweDdDICYmCiAgICAgICAgZXhwLmNoYXJDb2RlQXQoaSAtIDEpICE9PSAweDdDICYmCiAgICAgICAgIWN1cmx5ICYmICFzcXVhcmUgJiYgIXBhcmVuCiAgICAgICkgewogICAgICAgIGlmIChleHByZXNzaW9uID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIC8vIGZpcnN0IGZpbHRlciwgZW5kIG9mIGV4cHJlc3Npb24KICAgICAgICAgIGxhc3RGaWx0ZXJJbmRleCA9IGkgKyAxOwogICAgICAgICAgZXhwcmVzc2lvbiA9IGV4cC5zbGljZSgwLCBpKS50cmltKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHB1c2hGaWx0ZXIoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3dpdGNoIChjKSB7CiAgICAgICAgICBjYXNlIDB4MjI6IGluRG91YmxlID0gdHJ1ZTsgYnJlYWsgICAgICAgICAvLyAiCiAgICAgICAgICBjYXNlIDB4Mjc6IGluU2luZ2xlID0gdHJ1ZTsgYnJlYWsgICAgICAgICAvLyAnCiAgICAgICAgICBjYXNlIDB4NjA6IGluVGVtcGxhdGVTdHJpbmcgPSB0cnVlOyBicmVhayAvLyBgCiAgICAgICAgICBjYXNlIDB4Mjg6IHBhcmVuKys7IGJyZWFrICAgICAgICAgICAgICAgICAvLyAoCiAgICAgICAgICBjYXNlIDB4Mjk6IHBhcmVuLS07IGJyZWFrICAgICAgICAgICAgICAgICAvLyApCiAgICAgICAgICBjYXNlIDB4NUI6IHNxdWFyZSsrOyBicmVhayAgICAgICAgICAgICAgICAvLyBbCiAgICAgICAgICBjYXNlIDB4NUQ6IHNxdWFyZS0tOyBicmVhayAgICAgICAgICAgICAgICAvLyBdCiAgICAgICAgICBjYXNlIDB4N0I6IGN1cmx5Kys7IGJyZWFrICAgICAgICAgICAgICAgICAvLyB7CiAgICAgICAgICBjYXNlIDB4N0Q6IGN1cmx5LS07IGJyZWFrICAgICAgICAgICAgICAgICAvLyB9CiAgICAgICAgfQogICAgICAgIGlmIChjID09PSAweDJmKSB7IC8vIC8KICAgICAgICAgIHZhciBqID0gaSAtIDE7CiAgICAgICAgICB2YXIgcCA9ICh2b2lkIDApOwogICAgICAgICAgLy8gZmluZCBmaXJzdCBub24td2hpdGVzcGFjZSBwcmV2IGNoYXIKICAgICAgICAgIGZvciAoOyBqID49IDA7IGotLSkgewogICAgICAgICAgICBwID0gZXhwLmNoYXJBdChqKTsKICAgICAgICAgICAgaWYgKHAgIT09ICcgJykgeyBicmVhayB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXAgfHwgIXZhbGlkRGl2aXNpb25DaGFyUkUudGVzdChwKSkgewogICAgICAgICAgICBpblJlZ2V4ID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAoZXhwcmVzc2lvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGV4cHJlc3Npb24gPSBleHAuc2xpY2UoMCwgaSkudHJpbSgpOwogICAgfSBlbHNlIGlmIChsYXN0RmlsdGVySW5kZXggIT09IDApIHsKICAgICAgcHVzaEZpbHRlcigpOwogICAgfQoKICAgIGZ1bmN0aW9uIHB1c2hGaWx0ZXIgKCkgewogICAgICAoZmlsdGVycyB8fCAoZmlsdGVycyA9IFtdKSkucHVzaChleHAuc2xpY2UobGFzdEZpbHRlckluZGV4LCBpKS50cmltKCkpOwogICAgICBsYXN0RmlsdGVySW5kZXggPSBpICsgMTsKICAgIH0KCiAgICBpZiAoZmlsdGVycykgewogICAgICBmb3IgKGkgPSAwOyBpIDwgZmlsdGVycy5sZW5ndGg7IGkrKykgewogICAgICAgIGV4cHJlc3Npb24gPSB3cmFwRmlsdGVyKGV4cHJlc3Npb24sIGZpbHRlcnNbaV0pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGV4cHJlc3Npb24KICB9CgogIGZ1bmN0aW9uIHdyYXBGaWx0ZXIgKGV4cCwgZmlsdGVyKSB7CiAgICB2YXIgaSA9IGZpbHRlci5pbmRleE9mKCcoJyk7CiAgICBpZiAoaSA8IDApIHsKICAgICAgLy8gX2Y6IHJlc29sdmVGaWx0ZXIKICAgICAgcmV0dXJuICgiX2YoXCIiICsgZmlsdGVyICsgIlwiKSgiICsgZXhwICsgIikiKQogICAgfSBlbHNlIHsKICAgICAgdmFyIG5hbWUgPSBmaWx0ZXIuc2xpY2UoMCwgaSk7CiAgICAgIHZhciBhcmdzID0gZmlsdGVyLnNsaWNlKGkgKyAxKTsKICAgICAgcmV0dXJuICgiX2YoXCIiICsgbmFtZSArICJcIikoIiArIGV4cCArIChhcmdzICE9PSAnKScgPyAnLCcgKyBhcmdzIDogYXJncykpCiAgICB9CiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gYmFzZVdhcm4gKG1zZykgewogICAgY29uc29sZS5lcnJvcigoIltWdWUgY29tcGlsZXJdOiAiICsgbXNnKSk7CiAgfQoKICBmdW5jdGlvbiBwbHVja01vZHVsZUZ1bmN0aW9uICgKICAgIG1vZHVsZXMsCiAgICBrZXkKICApIHsKICAgIHJldHVybiBtb2R1bGVzCiAgICAgID8gbW9kdWxlcy5tYXAoZnVuY3Rpb24gKG0pIHsgcmV0dXJuIG1ba2V5XTsgfSkuZmlsdGVyKGZ1bmN0aW9uIChfKSB7IHJldHVybiBfOyB9KQogICAgICA6IFtdCiAgfQoKICBmdW5jdGlvbiBhZGRQcm9wIChlbCwgbmFtZSwgdmFsdWUpIHsKICAgIChlbC5wcm9wcyB8fCAoZWwucHJvcHMgPSBbXSkpLnB1c2goeyBuYW1lOiBuYW1lLCB2YWx1ZTogdmFsdWUgfSk7CiAgICBlbC5wbGFpbiA9IGZhbHNlOwogIH0KCiAgZnVuY3Rpb24gYWRkQXR0ciAoZWwsIG5hbWUsIHZhbHVlKSB7CiAgICAoZWwuYXR0cnMgfHwgKGVsLmF0dHJzID0gW10pKS5wdXNoKHsgbmFtZTogbmFtZSwgdmFsdWU6IHZhbHVlIH0pOwogICAgZWwucGxhaW4gPSBmYWxzZTsKICB9CgogIC8vIGFkZCBhIHJhdyBhdHRyICh1c2UgdGhpcyBpbiBwcmVUcmFuc2Zvcm1zKQogIGZ1bmN0aW9uIGFkZFJhd0F0dHIgKGVsLCBuYW1lLCB2YWx1ZSkgewogICAgZWwuYXR0cnNNYXBbbmFtZV0gPSB2YWx1ZTsKICAgIGVsLmF0dHJzTGlzdC5wdXNoKHsgbmFtZTogbmFtZSwgdmFsdWU6IHZhbHVlIH0pOwogIH0KCiAgZnVuY3Rpb24gYWRkRGlyZWN0aXZlICgKICAgIGVsLAogICAgbmFtZSwKICAgIHJhd05hbWUsCiAgICB2YWx1ZSwKICAgIGFyZywKICAgIG1vZGlmaWVycwogICkgewogICAgKGVsLmRpcmVjdGl2ZXMgfHwgKGVsLmRpcmVjdGl2ZXMgPSBbXSkpLnB1c2goeyBuYW1lOiBuYW1lLCByYXdOYW1lOiByYXdOYW1lLCB2YWx1ZTogdmFsdWUsIGFyZzogYXJnLCBtb2RpZmllcnM6IG1vZGlmaWVycyB9KTsKICAgIGVsLnBsYWluID0gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBhZGRIYW5kbGVyICgKICAgIGVsLAogICAgbmFtZSwKICAgIHZhbHVlLAogICAgbW9kaWZpZXJzLAogICAgaW1wb3J0YW50LAogICAgd2FybgogICkgewogICAgbW9kaWZpZXJzID0gbW9kaWZpZXJzIHx8IGVtcHR5T2JqZWN0OwogICAgLy8gd2FybiBwcmV2ZW50IGFuZCBwYXNzaXZlIG1vZGlmaWVyCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmICgKICAgICAgd2FybiAmJgogICAgICBtb2RpZmllcnMucHJldmVudCAmJiBtb2RpZmllcnMucGFzc2l2ZQogICAgKSB7CiAgICAgIHdhcm4oCiAgICAgICAgJ3Bhc3NpdmUgYW5kIHByZXZlbnQgY2FuXCd0IGJlIHVzZWQgdG9nZXRoZXIuICcgKwogICAgICAgICdQYXNzaXZlIGhhbmRsZXIgY2FuXCd0IHByZXZlbnQgZGVmYXVsdCBldmVudC4nCiAgICAgICk7CiAgICB9CgogICAgLy8gbm9ybWFsaXplIGNsaWNrLnJpZ2h0IGFuZCBjbGljay5taWRkbGUgc2luY2UgdGhleSBkb24ndCBhY3R1YWxseSBmaXJlCiAgICAvLyB0aGlzIGlzIHRlY2huaWNhbGx5IGJyb3dzZXItc3BlY2lmaWMsIGJ1dCBhdCBsZWFzdCBmb3Igbm93IGJyb3dzZXJzIGFyZQogICAgLy8gdGhlIG9ubHkgdGFyZ2V0IGVudnMgdGhhdCBoYXZlIHJpZ2h0L21pZGRsZSBjbGlja3MuCiAgICBpZiAobmFtZSA9PT0gJ2NsaWNrJykgewogICAgICBpZiAobW9kaWZpZXJzLnJpZ2h0KSB7CiAgICAgICAgbmFtZSA9ICdjb250ZXh0bWVudSc7CiAgICAgICAgZGVsZXRlIG1vZGlmaWVycy5yaWdodDsKICAgICAgfSBlbHNlIGlmIChtb2RpZmllcnMubWlkZGxlKSB7CiAgICAgICAgbmFtZSA9ICdtb3VzZXVwJzsKICAgICAgfQogICAgfQoKICAgIC8vIGNoZWNrIGNhcHR1cmUgbW9kaWZpZXIKICAgIGlmIChtb2RpZmllcnMuY2FwdHVyZSkgewogICAgICBkZWxldGUgbW9kaWZpZXJzLmNhcHR1cmU7CiAgICAgIG5hbWUgPSAnIScgKyBuYW1lOyAvLyBtYXJrIHRoZSBldmVudCBhcyBjYXB0dXJlZAogICAgfQogICAgaWYgKG1vZGlmaWVycy5vbmNlKSB7CiAgICAgIGRlbGV0ZSBtb2RpZmllcnMub25jZTsKICAgICAgbmFtZSA9ICd+JyArIG5hbWU7IC8vIG1hcmsgdGhlIGV2ZW50IGFzIG9uY2UKICAgIH0KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKG1vZGlmaWVycy5wYXNzaXZlKSB7CiAgICAgIGRlbGV0ZSBtb2RpZmllcnMucGFzc2l2ZTsKICAgICAgbmFtZSA9ICcmJyArIG5hbWU7IC8vIG1hcmsgdGhlIGV2ZW50IGFzIHBhc3NpdmUKICAgIH0KCiAgICB2YXIgZXZlbnRzOwogICAgaWYgKG1vZGlmaWVycy5uYXRpdmUpIHsKICAgICAgZGVsZXRlIG1vZGlmaWVycy5uYXRpdmU7CiAgICAgIGV2ZW50cyA9IGVsLm5hdGl2ZUV2ZW50cyB8fCAoZWwubmF0aXZlRXZlbnRzID0ge30pOwogICAgfSBlbHNlIHsKICAgICAgZXZlbnRzID0gZWwuZXZlbnRzIHx8IChlbC5ldmVudHMgPSB7fSk7CiAgICB9CgogICAgdmFyIG5ld0hhbmRsZXIgPSB7CiAgICAgIHZhbHVlOiB2YWx1ZS50cmltKCkKICAgIH07CiAgICBpZiAobW9kaWZpZXJzICE9PSBlbXB0eU9iamVjdCkgewogICAgICBuZXdIYW5kbGVyLm1vZGlmaWVycyA9IG1vZGlmaWVyczsKICAgIH0KCiAgICB2YXIgaGFuZGxlcnMgPSBldmVudHNbbmFtZV07CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChBcnJheS5pc0FycmF5KGhhbmRsZXJzKSkgewogICAgICBpbXBvcnRhbnQgPyBoYW5kbGVycy51bnNoaWZ0KG5ld0hhbmRsZXIpIDogaGFuZGxlcnMucHVzaChuZXdIYW5kbGVyKTsKICAgIH0gZWxzZSBpZiAoaGFuZGxlcnMpIHsKICAgICAgZXZlbnRzW25hbWVdID0gaW1wb3J0YW50ID8gW25ld0hhbmRsZXIsIGhhbmRsZXJzXSA6IFtoYW5kbGVycywgbmV3SGFuZGxlcl07CiAgICB9IGVsc2UgewogICAgICBldmVudHNbbmFtZV0gPSBuZXdIYW5kbGVyOwogICAgfQoKICAgIGVsLnBsYWluID0gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBnZXRCaW5kaW5nQXR0ciAoCiAgICBlbCwKICAgIG5hbWUsCiAgICBnZXRTdGF0aWMKICApIHsKICAgIHZhciBkeW5hbWljVmFsdWUgPQogICAgICBnZXRBbmRSZW1vdmVBdHRyKGVsLCAnOicgKyBuYW1lKSB8fAogICAgICBnZXRBbmRSZW1vdmVBdHRyKGVsLCAndi1iaW5kOicgKyBuYW1lKTsKICAgIGlmIChkeW5hbWljVmFsdWUgIT0gbnVsbCkgewogICAgICByZXR1cm4gcGFyc2VGaWx0ZXJzKGR5bmFtaWNWYWx1ZSkKICAgIH0gZWxzZSBpZiAoZ2V0U3RhdGljICE9PSBmYWxzZSkgewogICAgICB2YXIgc3RhdGljVmFsdWUgPSBnZXRBbmRSZW1vdmVBdHRyKGVsLCBuYW1lKTsKICAgICAgaWYgKHN0YXRpY1ZhbHVlICE9IG51bGwpIHsKICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoc3RhdGljVmFsdWUpCiAgICAgIH0KICAgIH0KICB9CgogIC8vIG5vdGU6IHRoaXMgb25seSByZW1vdmVzIHRoZSBhdHRyIGZyb20gdGhlIEFycmF5IChhdHRyc0xpc3QpIHNvIHRoYXQgaXQKICAvLyBkb2Vzbid0IGdldCBwcm9jZXNzZWQgYnkgcHJvY2Vzc0F0dHJzLgogIC8vIEJ5IGRlZmF1bHQgaXQgZG9lcyBOT1QgcmVtb3ZlIGl0IGZyb20gdGhlIG1hcCAoYXR0cnNNYXApIGJlY2F1c2UgdGhlIG1hcCBpcwogIC8vIG5lZWRlZCBkdXJpbmcgY29kZWdlbi4KICBmdW5jdGlvbiBnZXRBbmRSZW1vdmVBdHRyICgKICAgIGVsLAogICAgbmFtZSwKICAgIHJlbW92ZUZyb21NYXAKICApIHsKICAgIHZhciB2YWw7CiAgICBpZiAoKHZhbCA9IGVsLmF0dHJzTWFwW25hbWVdKSAhPSBudWxsKSB7CiAgICAgIHZhciBsaXN0ID0gZWwuYXR0cnNMaXN0OwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGxpc3QubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaWYgKGxpc3RbaV0ubmFtZSA9PT0gbmFtZSkgewogICAgICAgICAgbGlzdC5zcGxpY2UoaSwgMSk7CiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHJlbW92ZUZyb21NYXApIHsKICAgICAgZGVsZXRlIGVsLmF0dHJzTWFwW25hbWVdOwogICAgfQogICAgcmV0dXJuIHZhbAogIH0KCiAgLyogICovCgogIC8qKgogICAqIENyb3NzLXBsYXRmb3JtIGNvZGUgZ2VuZXJhdGlvbiBmb3IgY29tcG9uZW50IHYtbW9kZWwKICAgKi8KICBmdW5jdGlvbiBnZW5Db21wb25lbnRNb2RlbCAoCiAgICBlbCwKICAgIHZhbHVlLAogICAgbW9kaWZpZXJzCiAgKSB7CiAgICB2YXIgcmVmID0gbW9kaWZpZXJzIHx8IHt9OwogICAgdmFyIG51bWJlciA9IHJlZi5udW1iZXI7CiAgICB2YXIgdHJpbSA9IHJlZi50cmltOwoKICAgIHZhciBiYXNlVmFsdWVFeHByZXNzaW9uID0gJyQkdic7CiAgICB2YXIgdmFsdWVFeHByZXNzaW9uID0gYmFzZVZhbHVlRXhwcmVzc2lvbjsKICAgIGlmICh0cmltKSB7CiAgICAgIHZhbHVlRXhwcmVzc2lvbiA9CiAgICAgICAgIih0eXBlb2YgIiArIGJhc2VWYWx1ZUV4cHJlc3Npb24gKyAiID09PSAnc3RyaW5nJyIgKwogICAgICAgICI/ICIgKyBiYXNlVmFsdWVFeHByZXNzaW9uICsgIi50cmltKCkiICsKICAgICAgICAiOiAiICsgYmFzZVZhbHVlRXhwcmVzc2lvbiArICIpIjsKICAgIH0KICAgIGlmIChudW1iZXIpIHsKICAgICAgdmFsdWVFeHByZXNzaW9uID0gIl9uKCIgKyB2YWx1ZUV4cHJlc3Npb24gKyAiKSI7CiAgICB9CiAgICB2YXIgYXNzaWdubWVudCA9IGdlbkFzc2lnbm1lbnRDb2RlKHZhbHVlLCB2YWx1ZUV4cHJlc3Npb24pOwoKICAgIGVsLm1vZGVsID0gewogICAgICB2YWx1ZTogKCIoIiArIHZhbHVlICsgIikiKSwKICAgICAgZXhwcmVzc2lvbjogSlNPTi5zdHJpbmdpZnkodmFsdWUpLAogICAgICBjYWxsYmFjazogKCJmdW5jdGlvbiAoIiArIGJhc2VWYWx1ZUV4cHJlc3Npb24gKyAiKSB7IiArIGFzc2lnbm1lbnQgKyAifSIpCiAgICB9OwogIH0KCiAgLyoqCiAgICogQ3Jvc3MtcGxhdGZvcm0gY29kZWdlbiBoZWxwZXIgZm9yIGdlbmVyYXRpbmcgdi1tb2RlbCB2YWx1ZSBhc3NpZ25tZW50IGNvZGUuCiAgICovCiAgZnVuY3Rpb24gZ2VuQXNzaWdubWVudENvZGUgKAogICAgdmFsdWUsCiAgICBhc3NpZ25tZW50CiAgKSB7CiAgICB2YXIgcmVzID0gcGFyc2VNb2RlbCh2YWx1ZSk7CiAgICBpZiAocmVzLmtleSA9PT0gbnVsbCkgewogICAgICByZXR1cm4gKHZhbHVlICsgIj0iICsgYXNzaWdubWVudCkKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAoIiRzZXQoIiArIChyZXMuZXhwKSArICIsICIgKyAocmVzLmtleSkgKyAiLCAiICsgYXNzaWdubWVudCArICIpIikKICAgIH0KICB9CgogIC8qKgogICAqIFBhcnNlIGEgdi1tb2RlbCBleHByZXNzaW9uIGludG8gYSBiYXNlIHBhdGggYW5kIGEgZmluYWwga2V5IHNlZ21lbnQuCiAgICogSGFuZGxlcyBib3RoIGRvdC1wYXRoIGFuZCBwb3NzaWJsZSBzcXVhcmUgYnJhY2tldHMuCiAgICoKICAgKiBQb3NzaWJsZSBjYXNlczoKICAgKgogICAqIC0gdGVzdAogICAqIC0gdGVzdFtrZXldCiAgICogLSB0ZXN0W3Rlc3QxW2tleV1dCiAgICogLSB0ZXN0WyJhIl1ba2V5XQogICAqIC0geHh4LnRlc3RbYVthXS50ZXN0MVtrZXldXQogICAqIC0gdGVzdC54eHguYVsiYXNhIl1bdGVzdDFba2V5XV0KICAgKgogICAqLwoKICB2YXIgbGVuLCBzdHIsIGNociwgaW5kZXgkMSwgZXhwcmVzc2lvblBvcywgZXhwcmVzc2lvbkVuZFBvczsKCgoKICBmdW5jdGlvbiBwYXJzZU1vZGVsICh2YWwpIHsKICAgIC8vIEZpeCBodHRwczovL2dpdGh1Yi5jb20vdnVlanMvdnVlL3B1bGwvNzczMAogICAgLy8gYWxsb3cgdi1tb2RlbD0ib2JqLnZhbCAiICh0cmFpbGluZyB3aGl0ZXNwYWNlKQogICAgdmFsID0gdmFsLnRyaW0oKTsKICAgIGxlbiA9IHZhbC5sZW5ndGg7CgogICAgaWYgKHZhbC5pbmRleE9mKCdbJykgPCAwIHx8IHZhbC5sYXN0SW5kZXhPZignXScpIDwgbGVuIC0gMSkgewogICAgICBpbmRleCQxID0gdmFsLmxhc3RJbmRleE9mKCcuJyk7CiAgICAgIGlmIChpbmRleCQxID4gLTEpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZXhwOiB2YWwuc2xpY2UoMCwgaW5kZXgkMSksCiAgICAgICAgICBrZXk6ICciJyArIHZhbC5zbGljZShpbmRleCQxICsgMSkgKyAnIicKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGV4cDogdmFsLAogICAgICAgICAga2V5OiBudWxsCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgc3RyID0gdmFsOwogICAgaW5kZXgkMSA9IGV4cHJlc3Npb25Qb3MgPSBleHByZXNzaW9uRW5kUG9zID0gMDsKCiAgICB3aGlsZSAoIWVvZigpKSB7CiAgICAgIGNociA9IG5leHQoKTsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmIChpc1N0cmluZ1N0YXJ0KGNocikpIHsKICAgICAgICBwYXJzZVN0cmluZyhjaHIpOwogICAgICB9IGVsc2UgaWYgKGNociA9PT0gMHg1QikgewogICAgICAgIHBhcnNlQnJhY2tldChjaHIpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZXhwOiB2YWwuc2xpY2UoMCwgZXhwcmVzc2lvblBvcyksCiAgICAgIGtleTogdmFsLnNsaWNlKGV4cHJlc3Npb25Qb3MgKyAxLCBleHByZXNzaW9uRW5kUG9zKQogICAgfQogIH0KCiAgZnVuY3Rpb24gbmV4dCAoKSB7CiAgICByZXR1cm4gc3RyLmNoYXJDb2RlQXQoKytpbmRleCQxKQogIH0KCiAgZnVuY3Rpb24gZW9mICgpIHsKICAgIHJldHVybiBpbmRleCQxID49IGxlbgogIH0KCiAgZnVuY3Rpb24gaXNTdHJpbmdTdGFydCAoY2hyKSB7CiAgICByZXR1cm4gY2hyID09PSAweDIyIHx8IGNociA9PT0gMHgyNwogIH0KCiAgZnVuY3Rpb24gcGFyc2VCcmFja2V0IChjaHIpIHsKICAgIHZhciBpbkJyYWNrZXQgPSAxOwogICAgZXhwcmVzc2lvblBvcyA9IGluZGV4JDE7CiAgICB3aGlsZSAoIWVvZigpKSB7CiAgICAgIGNociA9IG5leHQoKTsKICAgICAgaWYgKGlzU3RyaW5nU3RhcnQoY2hyKSkgewogICAgICAgIHBhcnNlU3RyaW5nKGNocik7CiAgICAgICAgY29udGludWUKICAgICAgfQogICAgICBpZiAoY2hyID09PSAweDVCKSB7IGluQnJhY2tldCsrOyB9CiAgICAgIGlmIChjaHIgPT09IDB4NUQpIHsgaW5CcmFja2V0LS07IH0KICAgICAgaWYgKGluQnJhY2tldCA9PT0gMCkgewogICAgICAgIGV4cHJlc3Npb25FbmRQb3MgPSBpbmRleCQxOwogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHBhcnNlU3RyaW5nIChjaHIpIHsKICAgIHZhciBzdHJpbmdRdW90ZSA9IGNocjsKICAgIHdoaWxlICghZW9mKCkpIHsKICAgICAgY2hyID0gbmV4dCgpOwogICAgICBpZiAoY2hyID09PSBzdHJpbmdRdW90ZSkgewogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KICB9CgogIC8qICAqLwoKICB2YXIgd2FybiQxOwoKICAvLyBpbiBzb21lIGNhc2VzLCB0aGUgZXZlbnQgdXNlZCBoYXMgdG8gYmUgZGV0ZXJtaW5lZCBhdCBydW50aW1lCiAgLy8gc28gd2UgdXNlZCBzb21lIHJlc2VydmVkIHRva2VucyBkdXJpbmcgY29tcGlsZS4KICB2YXIgUkFOR0VfVE9LRU4gPSAnX19yJzsKICB2YXIgQ0hFQ0tCT1hfUkFESU9fVE9LRU4gPSAnX19jJzsKCiAgZnVuY3Rpb24gbW9kZWwgKAogICAgZWwsCiAgICBkaXIsCiAgICBfd2FybgogICkgewogICAgd2FybiQxID0gX3dhcm47CiAgICB2YXIgdmFsdWUgPSBkaXIudmFsdWU7CiAgICB2YXIgbW9kaWZpZXJzID0gZGlyLm1vZGlmaWVyczsKICAgIHZhciB0YWcgPSBlbC50YWc7CiAgICB2YXIgdHlwZSA9IGVsLmF0dHJzTWFwLnR5cGU7CgogICAgewogICAgICAvLyBpbnB1dHMgd2l0aCB0eXBlPSJmaWxlIiBhcmUgcmVhZCBvbmx5IGFuZCBzZXR0aW5nIHRoZSBpbnB1dCdzCiAgICAgIC8vIHZhbHVlIHdpbGwgdGhyb3cgYW4gZXJyb3IuCiAgICAgIGlmICh0YWcgPT09ICdpbnB1dCcgJiYgdHlwZSA9PT0gJ2ZpbGUnKSB7CiAgICAgICAgd2FybiQxKAogICAgICAgICAgIjwiICsgKGVsLnRhZykgKyAiIHYtbW9kZWw9XCIiICsgdmFsdWUgKyAiXCIgdHlwZT1cImZpbGVcIj46XG4iICsKICAgICAgICAgICJGaWxlIGlucHV0cyBhcmUgcmVhZCBvbmx5LiBVc2UgYSB2LW9uOmNoYW5nZSBsaXN0ZW5lciBpbnN0ZWFkLiIKICAgICAgICApOwogICAgICB9CiAgICB9CgogICAgaWYgKGVsLmNvbXBvbmVudCkgewogICAgICBnZW5Db21wb25lbnRNb2RlbChlbCwgdmFsdWUsIG1vZGlmaWVycyk7CiAgICAgIC8vIGNvbXBvbmVudCB2LW1vZGVsIGRvZXNuJ3QgbmVlZCBleHRyYSBydW50aW1lCiAgICAgIHJldHVybiBmYWxzZQogICAgfSBlbHNlIGlmICh0YWcgPT09ICdzZWxlY3QnKSB7CiAgICAgIGdlblNlbGVjdChlbCwgdmFsdWUsIG1vZGlmaWVycyk7CiAgICB9IGVsc2UgaWYgKHRhZyA9PT0gJ2lucHV0JyAmJiB0eXBlID09PSAnY2hlY2tib3gnKSB7CiAgICAgIGdlbkNoZWNrYm94TW9kZWwoZWwsIHZhbHVlLCBtb2RpZmllcnMpOwogICAgfSBlbHNlIGlmICh0YWcgPT09ICdpbnB1dCcgJiYgdHlwZSA9PT0gJ3JhZGlvJykgewogICAgICBnZW5SYWRpb01vZGVsKGVsLCB2YWx1ZSwgbW9kaWZpZXJzKTsKICAgIH0gZWxzZSBpZiAodGFnID09PSAnaW5wdXQnIHx8IHRhZyA9PT0gJ3RleHRhcmVhJykgewogICAgICBnZW5EZWZhdWx0TW9kZWwoZWwsIHZhbHVlLCBtb2RpZmllcnMpOwogICAgfSBlbHNlIGlmICghY29uZmlnLmlzUmVzZXJ2ZWRUYWcodGFnKSkgewogICAgICBnZW5Db21wb25lbnRNb2RlbChlbCwgdmFsdWUsIG1vZGlmaWVycyk7CiAgICAgIC8vIGNvbXBvbmVudCB2LW1vZGVsIGRvZXNuJ3QgbmVlZCBleHRyYSBydW50aW1lCiAgICAgIHJldHVybiBmYWxzZQogICAgfSBlbHNlIHsKICAgICAgd2FybiQxKAogICAgICAgICI8IiArIChlbC50YWcpICsgIiB2LW1vZGVsPVwiIiArIHZhbHVlICsgIlwiPjogIiArCiAgICAgICAgInYtbW9kZWwgaXMgbm90IHN1cHBvcnRlZCBvbiB0aGlzIGVsZW1lbnQgdHlwZS4gIiArCiAgICAgICAgJ0lmIHlvdSBhcmUgd29ya2luZyB3aXRoIGNvbnRlbnRlZGl0YWJsZSwgaXRcJ3MgcmVjb21tZW5kZWQgdG8gJyArCiAgICAgICAgJ3dyYXAgYSBsaWJyYXJ5IGRlZGljYXRlZCBmb3IgdGhhdCBwdXJwb3NlIGluc2lkZSBhIGN1c3RvbSBjb21wb25lbnQuJwogICAgICApOwogICAgfQoKICAgIC8vIGVuc3VyZSBydW50aW1lIGRpcmVjdGl2ZSBtZXRhZGF0YQogICAgcmV0dXJuIHRydWUKICB9CgogIGZ1bmN0aW9uIGdlbkNoZWNrYm94TW9kZWwgKAogICAgZWwsCiAgICB2YWx1ZSwKICAgIG1vZGlmaWVycwogICkgewogICAgdmFyIG51bWJlciA9IG1vZGlmaWVycyAmJiBtb2RpZmllcnMubnVtYmVyOwogICAgdmFyIHZhbHVlQmluZGluZyA9IGdldEJpbmRpbmdBdHRyKGVsLCAndmFsdWUnKSB8fCAnbnVsbCc7CiAgICB2YXIgdHJ1ZVZhbHVlQmluZGluZyA9IGdldEJpbmRpbmdBdHRyKGVsLCAndHJ1ZS12YWx1ZScpIHx8ICd0cnVlJzsKICAgIHZhciBmYWxzZVZhbHVlQmluZGluZyA9IGdldEJpbmRpbmdBdHRyKGVsLCAnZmFsc2UtdmFsdWUnKSB8fCAnZmFsc2UnOwogICAgYWRkUHJvcChlbCwgJ2NoZWNrZWQnLAogICAgICAiQXJyYXkuaXNBcnJheSgiICsgdmFsdWUgKyAiKSIgKwogICAgICAiP19pKCIgKyB2YWx1ZSArICIsIiArIHZhbHVlQmluZGluZyArICIpPi0xIiArICgKICAgICAgICB0cnVlVmFsdWVCaW5kaW5nID09PSAndHJ1ZScKICAgICAgICAgID8gKCI6KCIgKyB2YWx1ZSArICIpIikKICAgICAgICAgIDogKCI6X3EoIiArIHZhbHVlICsgIiwiICsgdHJ1ZVZhbHVlQmluZGluZyArICIpIikKICAgICAgKQogICAgKTsKICAgIGFkZEhhbmRsZXIoZWwsICdjaGFuZ2UnLAogICAgICAidmFyICQkYT0iICsgdmFsdWUgKyAiLCIgKwogICAgICAgICAgJyQkZWw9JGV2ZW50LnRhcmdldCwnICsKICAgICAgICAgICIkJGM9JCRlbC5jaGVja2VkPygiICsgdHJ1ZVZhbHVlQmluZGluZyArICIpOigiICsgZmFsc2VWYWx1ZUJpbmRpbmcgKyAiKTsiICsKICAgICAgJ2lmKEFycmF5LmlzQXJyYXkoJCRhKSl7JyArCiAgICAgICAgInZhciAkJHY9IiArIChudW1iZXIgPyAnX24oJyArIHZhbHVlQmluZGluZyArICcpJyA6IHZhbHVlQmluZGluZykgKyAiLCIgKwogICAgICAgICAgICAnJCRpPV9pKCQkYSwkJHYpOycgKwogICAgICAgICJpZigkJGVsLmNoZWNrZWQpeyQkaTwwJiYoIiArIChnZW5Bc3NpZ25tZW50Q29kZSh2YWx1ZSwgJyQkYS5jb25jYXQoWyQkdl0pJykpICsgIil9IiArCiAgICAgICAgImVsc2V7JCRpPi0xJiYoIiArIChnZW5Bc3NpZ25tZW50Q29kZSh2YWx1ZSwgJyQkYS5zbGljZSgwLCQkaSkuY29uY2F0KCQkYS5zbGljZSgkJGkrMSkpJykpICsgIil9IiArCiAgICAgICJ9ZWxzZXsiICsgKGdlbkFzc2lnbm1lbnRDb2RlKHZhbHVlLCAnJCRjJykpICsgIn0iLAogICAgICBudWxsLCB0cnVlCiAgICApOwogIH0KCiAgZnVuY3Rpb24gZ2VuUmFkaW9Nb2RlbCAoCiAgICBlbCwKICAgIHZhbHVlLAogICAgbW9kaWZpZXJzCiAgKSB7CiAgICB2YXIgbnVtYmVyID0gbW9kaWZpZXJzICYmIG1vZGlmaWVycy5udW1iZXI7CiAgICB2YXIgdmFsdWVCaW5kaW5nID0gZ2V0QmluZGluZ0F0dHIoZWwsICd2YWx1ZScpIHx8ICdudWxsJzsKICAgIHZhbHVlQmluZGluZyA9IG51bWJlciA/ICgiX24oIiArIHZhbHVlQmluZGluZyArICIpIikgOiB2YWx1ZUJpbmRpbmc7CiAgICBhZGRQcm9wKGVsLCAnY2hlY2tlZCcsICgiX3EoIiArIHZhbHVlICsgIiwiICsgdmFsdWVCaW5kaW5nICsgIikiKSk7CiAgICBhZGRIYW5kbGVyKGVsLCAnY2hhbmdlJywgZ2VuQXNzaWdubWVudENvZGUodmFsdWUsIHZhbHVlQmluZGluZyksIG51bGwsIHRydWUpOwogIH0KCiAgZnVuY3Rpb24gZ2VuU2VsZWN0ICgKICAgIGVsLAogICAgdmFsdWUsCiAgICBtb2RpZmllcnMKICApIHsKICAgIHZhciBudW1iZXIgPSBtb2RpZmllcnMgJiYgbW9kaWZpZXJzLm51bWJlcjsKICAgIHZhciBzZWxlY3RlZFZhbCA9ICJBcnJheS5wcm90b3R5cGUuZmlsdGVyIiArCiAgICAgICIuY2FsbCgkZXZlbnQudGFyZ2V0Lm9wdGlvbnMsZnVuY3Rpb24obyl7cmV0dXJuIG8uc2VsZWN0ZWR9KSIgKwogICAgICAiLm1hcChmdW5jdGlvbihvKXt2YXIgdmFsID0gXCJfdmFsdWVcIiBpbiBvID8gby5fdmFsdWUgOiBvLnZhbHVlOyIgKwogICAgICAicmV0dXJuICIgKyAobnVtYmVyID8gJ19uKHZhbCknIDogJ3ZhbCcpICsgIn0pIjsKCiAgICB2YXIgYXNzaWdubWVudCA9ICckZXZlbnQudGFyZ2V0Lm11bHRpcGxlID8gJCRzZWxlY3RlZFZhbCA6ICQkc2VsZWN0ZWRWYWxbMF0nOwogICAgdmFyIGNvZGUgPSAidmFyICQkc2VsZWN0ZWRWYWwgPSAiICsgc2VsZWN0ZWRWYWwgKyAiOyI7CiAgICBjb2RlID0gY29kZSArICIgIiArIChnZW5Bc3NpZ25tZW50Q29kZSh2YWx1ZSwgYXNzaWdubWVudCkpOwogICAgYWRkSGFuZGxlcihlbCwgJ2NoYW5nZScsIGNvZGUsIG51bGwsIHRydWUpOwogIH0KCiAgZnVuY3Rpb24gZ2VuRGVmYXVsdE1vZGVsICgKICAgIGVsLAogICAgdmFsdWUsCiAgICBtb2RpZmllcnMKICApIHsKICAgIHZhciB0eXBlID0gZWwuYXR0cnNNYXAudHlwZTsKCiAgICAvLyB3YXJuIGlmIHYtYmluZDp2YWx1ZSBjb25mbGljdHMgd2l0aCB2LW1vZGVsCiAgICAvLyBleGNlcHQgZm9yIGlucHV0cyB3aXRoIHYtYmluZDp0eXBlCiAgICB7CiAgICAgIHZhciB2YWx1ZSQxID0gZWwuYXR0cnNNYXBbJ3YtYmluZDp2YWx1ZSddIHx8IGVsLmF0dHJzTWFwWyc6dmFsdWUnXTsKICAgICAgdmFyIHR5cGVCaW5kaW5nID0gZWwuYXR0cnNNYXBbJ3YtYmluZDp0eXBlJ10gfHwgZWwuYXR0cnNNYXBbJzp0eXBlJ107CiAgICAgIGlmICh2YWx1ZSQxICYmICF0eXBlQmluZGluZykgewogICAgICAgIHZhciBiaW5kaW5nID0gZWwuYXR0cnNNYXBbJ3YtYmluZDp2YWx1ZSddID8gJ3YtYmluZDp2YWx1ZScgOiAnOnZhbHVlJzsKICAgICAgICB3YXJuJDEoCiAgICAgICAgICBiaW5kaW5nICsgIj1cIiIgKyB2YWx1ZSQxICsgIlwiIGNvbmZsaWN0cyB3aXRoIHYtbW9kZWwgb24gdGhlIHNhbWUgZWxlbWVudCAiICsKICAgICAgICAgICdiZWNhdXNlIHRoZSBsYXR0ZXIgYWxyZWFkeSBleHBhbmRzIHRvIGEgdmFsdWUgYmluZGluZyBpbnRlcm5hbGx5JwogICAgICAgICk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgcmVmID0gbW9kaWZpZXJzIHx8IHt9OwogICAgdmFyIGxhenkgPSByZWYubGF6eTsKICAgIHZhciBudW1iZXIgPSByZWYubnVtYmVyOwogICAgdmFyIHRyaW0gPSByZWYudHJpbTsKICAgIHZhciBuZWVkQ29tcG9zaXRpb25HdWFyZCA9ICFsYXp5ICYmIHR5cGUgIT09ICdyYW5nZSc7CiAgICB2YXIgZXZlbnQgPSBsYXp5CiAgICAgID8gJ2NoYW5nZScKICAgICAgOiB0eXBlID09PSAncmFuZ2UnCiAgICAgICAgPyBSQU5HRV9UT0tFTgogICAgICAgIDogJ2lucHV0JzsKCiAgICB2YXIgdmFsdWVFeHByZXNzaW9uID0gJyRldmVudC50YXJnZXQudmFsdWUnOwogICAgaWYgKHRyaW0pIHsKICAgICAgdmFsdWVFeHByZXNzaW9uID0gIiRldmVudC50YXJnZXQudmFsdWUudHJpbSgpIjsKICAgIH0KICAgIGlmIChudW1iZXIpIHsKICAgICAgdmFsdWVFeHByZXNzaW9uID0gIl9uKCIgKyB2YWx1ZUV4cHJlc3Npb24gKyAiKSI7CiAgICB9CgogICAgdmFyIGNvZGUgPSBnZW5Bc3NpZ25tZW50Q29kZSh2YWx1ZSwgdmFsdWVFeHByZXNzaW9uKTsKICAgIGlmIChuZWVkQ29tcG9zaXRpb25HdWFyZCkgewogICAgICBjb2RlID0gImlmKCRldmVudC50YXJnZXQuY29tcG9zaW5nKXJldHVybjsiICsgY29kZTsKICAgIH0KCiAgICBhZGRQcm9wKGVsLCAndmFsdWUnLCAoIigiICsgdmFsdWUgKyAiKSIpKTsKICAgIGFkZEhhbmRsZXIoZWwsIGV2ZW50LCBjb2RlLCBudWxsLCB0cnVlKTsKICAgIGlmICh0cmltIHx8IG51bWJlcikgewogICAgICBhZGRIYW5kbGVyKGVsLCAnYmx1cicsICckZm9yY2VVcGRhdGUoKScpOwogICAgfQogIH0KCiAgLyogICovCgogIC8vIG5vcm1hbGl6ZSB2LW1vZGVsIGV2ZW50IHRva2VucyB0aGF0IGNhbiBvbmx5IGJlIGRldGVybWluZWQgYXQgcnVudGltZS4KICAvLyBpdCdzIGltcG9ydGFudCB0byBwbGFjZSB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGluIHRoZSBhcnJheSBiZWNhdXNlCiAgLy8gdGhlIHdob2xlIHBvaW50IGlzIGVuc3VyaW5nIHRoZSB2LW1vZGVsIGNhbGxiYWNrIGdldHMgY2FsbGVkIGJlZm9yZQogIC8vIHVzZXItYXR0YWNoZWQgaGFuZGxlcnMuCiAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnRzIChvbikgewogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoaXNEZWYob25bUkFOR0VfVE9LRU5dKSkgewogICAgICAvLyBJRSBpbnB1dFt0eXBlPXJhbmdlXSBvbmx5IHN1cHBvcnRzIGBjaGFuZ2VgIGV2ZW50CiAgICAgIHZhciBldmVudCA9IGlzSUUgPyAnY2hhbmdlJyA6ICdpbnB1dCc7CiAgICAgIG9uW2V2ZW50XSA9IFtdLmNvbmNhdChvbltSQU5HRV9UT0tFTl0sIG9uW2V2ZW50XSB8fCBbXSk7CiAgICAgIGRlbGV0ZSBvbltSQU5HRV9UT0tFTl07CiAgICB9CiAgICAvLyBUaGlzIHdhcyBvcmlnaW5hbGx5IGludGVuZGVkIHRvIGZpeCAjNDUyMSBidXQgbm8gbG9uZ2VyIG5lY2Vzc2FyeQogICAgLy8gYWZ0ZXIgMi41LiBLZWVwaW5nIGl0IGZvciBiYWNrd2FyZHMgY29tcGF0IHdpdGggZ2VuZXJhdGVkIGNvZGUgZnJvbSA8IDIuNAogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoaXNEZWYob25bQ0hFQ0tCT1hfUkFESU9fVE9LRU5dKSkgewogICAgICBvbi5jaGFuZ2UgPSBbXS5jb25jYXQob25bQ0hFQ0tCT1hfUkFESU9fVE9LRU5dLCBvbi5jaGFuZ2UgfHwgW10pOwogICAgICBkZWxldGUgb25bQ0hFQ0tCT1hfUkFESU9fVE9LRU5dOwogICAgfQogIH0KCiAgdmFyIHRhcmdldCQxOwoKICBmdW5jdGlvbiBjcmVhdGVPbmNlSGFuZGxlciQxIChldmVudCwgaGFuZGxlciwgY2FwdHVyZSkgewogICAgdmFyIF90YXJnZXQgPSB0YXJnZXQkMTsgLy8gc2F2ZSBjdXJyZW50IHRhcmdldCBlbGVtZW50IGluIGNsb3N1cmUKICAgIHJldHVybiBmdW5jdGlvbiBvbmNlSGFuZGxlciAoKSB7CiAgICAgIHZhciByZXMgPSBoYW5kbGVyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgIGlmIChyZXMgIT09IG51bGwpIHsKICAgICAgICByZW1vdmUkMihldmVudCwgb25jZUhhbmRsZXIsIGNhcHR1cmUsIF90YXJnZXQpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhZGQkMSAoCiAgICBldmVudCwKICAgIGhhbmRsZXIsCiAgICBjYXB0dXJlLAogICAgcGFzc2l2ZQogICkgewogICAgaGFuZGxlciA9IHdpdGhNYWNyb1Rhc2soaGFuZGxlcik7CiAgICB0YXJnZXQkMS5hZGRFdmVudExpc3RlbmVyKAogICAgICBldmVudCwKICAgICAgaGFuZGxlciwKICAgICAgc3VwcG9ydHNQYXNzaXZlCiAgICAgICAgPyB7IGNhcHR1cmU6IGNhcHR1cmUsIHBhc3NpdmU6IHBhc3NpdmUgfQogICAgICAgIDogY2FwdHVyZQogICAgKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZSQyICgKICAgIGV2ZW50LAogICAgaGFuZGxlciwKICAgIGNhcHR1cmUsCiAgICBfdGFyZ2V0CiAgKSB7CiAgICAoX3RhcmdldCB8fCB0YXJnZXQkMSkucmVtb3ZlRXZlbnRMaXN0ZW5lcigKICAgICAgZXZlbnQsCiAgICAgIGhhbmRsZXIuX3dpdGhUYXNrIHx8IGhhbmRsZXIsCiAgICAgIGNhcHR1cmUKICAgICk7CiAgfQoKICBmdW5jdGlvbiB1cGRhdGVET01MaXN0ZW5lcnMgKG9sZFZub2RlLCB2bm9kZSkgewogICAgaWYgKGlzVW5kZWYob2xkVm5vZGUuZGF0YS5vbikgJiYgaXNVbmRlZih2bm9kZS5kYXRhLm9uKSkgewogICAgICByZXR1cm4KICAgIH0KICAgIHZhciBvbiA9IHZub2RlLmRhdGEub24gfHwge307CiAgICB2YXIgb2xkT24gPSBvbGRWbm9kZS5kYXRhLm9uIHx8IHt9OwogICAgdGFyZ2V0JDEgPSB2bm9kZS5lbG07CiAgICBub3JtYWxpemVFdmVudHMob24pOwogICAgdXBkYXRlTGlzdGVuZXJzKG9uLCBvbGRPbiwgYWRkJDEsIHJlbW92ZSQyLCBjcmVhdGVPbmNlSGFuZGxlciQxLCB2bm9kZS5jb250ZXh0KTsKICAgIHRhcmdldCQxID0gdW5kZWZpbmVkOwogIH0KCiAgdmFyIGV2ZW50cyA9IHsKICAgIGNyZWF0ZTogdXBkYXRlRE9NTGlzdGVuZXJzLAogICAgdXBkYXRlOiB1cGRhdGVET01MaXN0ZW5lcnMKICB9OwoKICAvKiAgKi8KCiAgZnVuY3Rpb24gdXBkYXRlRE9NUHJvcHMgKG9sZFZub2RlLCB2bm9kZSkgewogICAgaWYgKGlzVW5kZWYob2xkVm5vZGUuZGF0YS5kb21Qcm9wcykgJiYgaXNVbmRlZih2bm9kZS5kYXRhLmRvbVByb3BzKSkgewogICAgICByZXR1cm4KICAgIH0KICAgIHZhciBrZXksIGN1cjsKICAgIHZhciBlbG0gPSB2bm9kZS5lbG07CiAgICB2YXIgb2xkUHJvcHMgPSBvbGRWbm9kZS5kYXRhLmRvbVByb3BzIHx8IHt9OwogICAgdmFyIHByb3BzID0gdm5vZGUuZGF0YS5kb21Qcm9wcyB8fCB7fTsKICAgIC8vIGNsb25lIG9ic2VydmVkIG9iamVjdHMsIGFzIHRoZSB1c2VyIHByb2JhYmx5IHdhbnRzIHRvIG11dGF0ZSBpdAogICAgaWYgKGlzRGVmKHByb3BzLl9fb2JfXykpIHsKICAgICAgcHJvcHMgPSB2bm9kZS5kYXRhLmRvbVByb3BzID0gZXh0ZW5kKHt9LCBwcm9wcyk7CiAgICB9CgogICAgZm9yIChrZXkgaW4gb2xkUHJvcHMpIHsKICAgICAgaWYgKGlzVW5kZWYocHJvcHNba2V5XSkpIHsKICAgICAgICBlbG1ba2V5XSA9ICcnOwogICAgICB9CiAgICB9CiAgICBmb3IgKGtleSBpbiBwcm9wcykgewogICAgICBjdXIgPSBwcm9wc1trZXldOwogICAgICAvLyBpZ25vcmUgY2hpbGRyZW4gaWYgdGhlIG5vZGUgaGFzIHRleHRDb250ZW50IG9yIGlubmVySFRNTCwKICAgICAgLy8gYXMgdGhlc2Ugd2lsbCB0aHJvdyBhd2F5IGV4aXN0aW5nIERPTSBub2RlcyBhbmQgY2F1c2UgcmVtb3ZhbCBlcnJvcnMKICAgICAgLy8gb24gc3Vic2VxdWVudCBwYXRjaGVzICgjMzM2MCkKICAgICAgaWYgKGtleSA9PT0gJ3RleHRDb250ZW50JyB8fCBrZXkgPT09ICdpbm5lckhUTUwnKSB7CiAgICAgICAgaWYgKHZub2RlLmNoaWxkcmVuKSB7IHZub2RlLmNoaWxkcmVuLmxlbmd0aCA9IDA7IH0KICAgICAgICBpZiAoY3VyID09PSBvbGRQcm9wc1trZXldKSB7IGNvbnRpbnVlIH0KICAgICAgICAvLyAjNjYwMSB3b3JrIGFyb3VuZCBDaHJvbWUgdmVyc2lvbiA8PSA1NSBidWcgd2hlcmUgc2luZ2xlIHRleHROb2RlCiAgICAgICAgLy8gcmVwbGFjZWQgYnkgaW5uZXJIVE1ML3RleHRDb250ZW50IHJldGFpbnMgaXRzIHBhcmVudE5vZGUgcHJvcGVydHkKICAgICAgICBpZiAoZWxtLmNoaWxkTm9kZXMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICBlbG0ucmVtb3ZlQ2hpbGQoZWxtLmNoaWxkTm9kZXNbMF0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGtleSA9PT0gJ3ZhbHVlJykgewogICAgICAgIC8vIHN0b3JlIHZhbHVlIGFzIF92YWx1ZSBhcyB3ZWxsIHNpbmNlCiAgICAgICAgLy8gbm9uLXN0cmluZyB2YWx1ZXMgd2lsbCBiZSBzdHJpbmdpZmllZAogICAgICAgIGVsbS5fdmFsdWUgPSBjdXI7CiAgICAgICAgLy8gYXZvaWQgcmVzZXR0aW5nIGN1cnNvciBwb3NpdGlvbiB3aGVuIHZhbHVlIGlzIHRoZSBzYW1lCiAgICAgICAgdmFyIHN0ckN1ciA9IGlzVW5kZWYoY3VyKSA/ICcnIDogU3RyaW5nKGN1cik7CiAgICAgICAgaWYgKHNob3VsZFVwZGF0ZVZhbHVlKGVsbSwgc3RyQ3VyKSkgewogICAgICAgICAgZWxtLnZhbHVlID0gc3RyQ3VyOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBlbG1ba2V5XSA9IGN1cjsKICAgICAgfQogICAgfQogIH0KCiAgLy8gY2hlY2sgcGxhdGZvcm1zL3dlYi91dGlsL2F0dHJzLmpzIGFjY2VwdFZhbHVlCgoKICBmdW5jdGlvbiBzaG91bGRVcGRhdGVWYWx1ZSAoZWxtLCBjaGVja1ZhbCkgewogICAgcmV0dXJuICghZWxtLmNvbXBvc2luZyAmJiAoCiAgICAgIGVsbS50YWdOYW1lID09PSAnT1BUSU9OJyB8fAogICAgICBpc05vdEluRm9jdXNBbmREaXJ0eShlbG0sIGNoZWNrVmFsKSB8fAogICAgICBpc0RpcnR5V2l0aE1vZGlmaWVycyhlbG0sIGNoZWNrVmFsKQogICAgKSkKICB9CgogIGZ1bmN0aW9uIGlzTm90SW5Gb2N1c0FuZERpcnR5IChlbG0sIGNoZWNrVmFsKSB7CiAgICAvLyByZXR1cm4gdHJ1ZSB3aGVuIHRleHRib3ggKC5udW1iZXIgYW5kIC50cmltKSBsb3NlcyBmb2N1cyBhbmQgaXRzIHZhbHVlIGlzCiAgICAvLyBub3QgZXF1YWwgdG8gdGhlIHVwZGF0ZWQgdmFsdWUKICAgIHZhciBub3RJbkZvY3VzID0gdHJ1ZTsKICAgIC8vICM2MTU3CiAgICAvLyB3b3JrIGFyb3VuZCBJRSBidWcgd2hlbiBhY2Nlc3NpbmcgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBpbiBhbiBpZnJhbWUKICAgIHRyeSB7IG5vdEluRm9jdXMgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICE9PSBlbG07IH0gY2F0Y2ggKGUpIHt9CiAgICByZXR1cm4gbm90SW5Gb2N1cyAmJiBlbG0udmFsdWUgIT09IGNoZWNrVmFsCiAgfQoKICBmdW5jdGlvbiBpc0RpcnR5V2l0aE1vZGlmaWVycyAoZWxtLCBuZXdWYWwpIHsKICAgIHZhciB2YWx1ZSA9IGVsbS52YWx1ZTsKICAgIHZhciBtb2RpZmllcnMgPSBlbG0uX3ZNb2RpZmllcnM7IC8vIGluamVjdGVkIGJ5IHYtbW9kZWwgcnVudGltZQogICAgaWYgKGlzRGVmKG1vZGlmaWVycykpIHsKICAgICAgaWYgKG1vZGlmaWVycy5sYXp5KSB7CiAgICAgICAgLy8gaW5wdXRzIHdpdGggbGF6eSBzaG91bGQgb25seSBiZSB1cGRhdGVkIHdoZW4gbm90IGluIGZvY3VzCiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgIH0KICAgICAgaWYgKG1vZGlmaWVycy5udW1iZXIpIHsKICAgICAgICByZXR1cm4gdG9OdW1iZXIodmFsdWUpICE9PSB0b051bWJlcihuZXdWYWwpCiAgICAgIH0KICAgICAgaWYgKG1vZGlmaWVycy50cmltKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLnRyaW0oKSAhPT0gbmV3VmFsLnRyaW0oKQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdmFsdWUgIT09IG5ld1ZhbAogIH0KCiAgdmFyIGRvbVByb3BzID0gewogICAgY3JlYXRlOiB1cGRhdGVET01Qcm9wcywKICAgIHVwZGF0ZTogdXBkYXRlRE9NUHJvcHMKICB9OwoKICAvKiAgKi8KCiAgdmFyIHBhcnNlU3R5bGVUZXh0ID0gY2FjaGVkKGZ1bmN0aW9uIChjc3NUZXh0KSB7CiAgICB2YXIgcmVzID0ge307CiAgICB2YXIgbGlzdERlbGltaXRlciA9IC87KD8hW14oXSpcKSkvZzsKICAgIHZhciBwcm9wZXJ0eURlbGltaXRlciA9IC86KC4rKS87CiAgICBjc3NUZXh0LnNwbGl0KGxpc3REZWxpbWl0ZXIpLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICB2YXIgdG1wID0gaXRlbS5zcGxpdChwcm9wZXJ0eURlbGltaXRlcik7CiAgICAgICAgdG1wLmxlbmd0aCA+IDEgJiYgKHJlc1t0bXBbMF0udHJpbSgpXSA9IHRtcFsxXS50cmltKCkpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXMKICB9KTsKCiAgLy8gbWVyZ2Ugc3RhdGljIGFuZCBkeW5hbWljIHN0eWxlIGRhdGEgb24gdGhlIHNhbWUgdm5vZGUKICBmdW5jdGlvbiBub3JtYWxpemVTdHlsZURhdGEgKGRhdGEpIHsKICAgIHZhciBzdHlsZSA9IG5vcm1hbGl6ZVN0eWxlQmluZGluZyhkYXRhLnN0eWxlKTsKICAgIC8vIHN0YXRpYyBzdHlsZSBpcyBwcmUtcHJvY2Vzc2VkIGludG8gYW4gb2JqZWN0IGR1cmluZyBjb21waWxhdGlvbgogICAgLy8gYW5kIGlzIGFsd2F5cyBhIGZyZXNoIG9iamVjdCwgc28gaXQncyBzYWZlIHRvIG1lcmdlIGludG8gaXQKICAgIHJldHVybiBkYXRhLnN0YXRpY1N0eWxlCiAgICAgID8gZXh0ZW5kKGRhdGEuc3RhdGljU3R5bGUsIHN0eWxlKQogICAgICA6IHN0eWxlCiAgfQoKICAvLyBub3JtYWxpemUgcG9zc2libGUgYXJyYXkgLyBzdHJpbmcgdmFsdWVzIGludG8gT2JqZWN0CiAgZnVuY3Rpb24gbm9ybWFsaXplU3R5bGVCaW5kaW5nIChiaW5kaW5nU3R5bGUpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGJpbmRpbmdTdHlsZSkpIHsKICAgICAgcmV0dXJuIHRvT2JqZWN0KGJpbmRpbmdTdHlsZSkKICAgIH0KICAgIGlmICh0eXBlb2YgYmluZGluZ1N0eWxlID09PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gcGFyc2VTdHlsZVRleHQoYmluZGluZ1N0eWxlKQogICAgfQogICAgcmV0dXJuIGJpbmRpbmdTdHlsZQogIH0KCiAgLyoqCiAgICogcGFyZW50IGNvbXBvbmVudCBzdHlsZSBzaG91bGQgYmUgYWZ0ZXIgY2hpbGQncwogICAqIHNvIHRoYXQgcGFyZW50IGNvbXBvbmVudCdzIHN0eWxlIGNvdWxkIG92ZXJyaWRlIGl0CiAgICovCiAgZnVuY3Rpb24gZ2V0U3R5bGUgKHZub2RlLCBjaGVja0NoaWxkKSB7CiAgICB2YXIgcmVzID0ge307CiAgICB2YXIgc3R5bGVEYXRhOwoKICAgIGlmIChjaGVja0NoaWxkKSB7CiAgICAgIHZhciBjaGlsZE5vZGUgPSB2bm9kZTsKICAgICAgd2hpbGUgKGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZSkgewogICAgICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CiAgICAgICAgaWYgKAogICAgICAgICAgY2hpbGROb2RlICYmIGNoaWxkTm9kZS5kYXRhICYmCiAgICAgICAgICAoc3R5bGVEYXRhID0gbm9ybWFsaXplU3R5bGVEYXRhKGNoaWxkTm9kZS5kYXRhKSkKICAgICAgICApIHsKICAgICAgICAgIGV4dGVuZChyZXMsIHN0eWxlRGF0YSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKChzdHlsZURhdGEgPSBub3JtYWxpemVTdHlsZURhdGEodm5vZGUuZGF0YSkpKSB7CiAgICAgIGV4dGVuZChyZXMsIHN0eWxlRGF0YSk7CiAgICB9CgogICAgdmFyIHBhcmVudE5vZGUgPSB2bm9kZTsKICAgIHdoaWxlICgocGFyZW50Tm9kZSA9IHBhcmVudE5vZGUucGFyZW50KSkgewogICAgICBpZiAocGFyZW50Tm9kZS5kYXRhICYmIChzdHlsZURhdGEgPSBub3JtYWxpemVTdHlsZURhdGEocGFyZW50Tm9kZS5kYXRhKSkpIHsKICAgICAgICBleHRlbmQocmVzLCBzdHlsZURhdGEpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzCiAgfQoKICAvKiAgKi8KCiAgdmFyIGNzc1ZhclJFID0gL14tLS87CiAgdmFyIGltcG9ydGFudFJFID0gL1xzKiFpbXBvcnRhbnQkLzsKICB2YXIgc2V0UHJvcCA9IGZ1bmN0aW9uIChlbCwgbmFtZSwgdmFsKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChjc3NWYXJSRS50ZXN0KG5hbWUpKSB7CiAgICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KG5hbWUsIHZhbCk7CiAgICB9IGVsc2UgaWYgKGltcG9ydGFudFJFLnRlc3QodmFsKSkgewogICAgICBlbC5zdHlsZS5zZXRQcm9wZXJ0eShuYW1lLCB2YWwucmVwbGFjZShpbXBvcnRhbnRSRSwgJycpLCAnaW1wb3J0YW50Jyk7CiAgICB9IGVsc2UgewogICAgICB2YXIgbm9ybWFsaXplZE5hbWUgPSBub3JtYWxpemUobmFtZSk7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHsKICAgICAgICAvLyBTdXBwb3J0IHZhbHVlcyBhcnJheSBjcmVhdGVkIGJ5IGF1dG9wcmVmaXhlciwgZS5nLgogICAgICAgIC8vIHtkaXNwbGF5OiBbIi13ZWJraXQtYm94IiwgIi1tcy1mbGV4Ym94IiwgImZsZXgiXX0KICAgICAgICAvLyBTZXQgdGhlbSBvbmUgYnkgb25lLCBhbmQgdGhlIGJyb3dzZXIgd2lsbCBvbmx5IHNldCB0aG9zZSBpdCBjYW4gcmVjb2duaXplCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHZhbC5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgZWwuc3R5bGVbbm9ybWFsaXplZE5hbWVdID0gdmFsW2ldOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBlbC5zdHlsZVtub3JtYWxpemVkTmFtZV0gPSB2YWw7CiAgICAgIH0KICAgIH0KICB9OwoKICB2YXIgdmVuZG9yTmFtZXMgPSBbJ1dlYmtpdCcsICdNb3onLCAnbXMnXTsKCiAgdmFyIGVtcHR5U3R5bGU7CiAgdmFyIG5vcm1hbGl6ZSA9IGNhY2hlZChmdW5jdGlvbiAocHJvcCkgewogICAgZW1wdHlTdHlsZSA9IGVtcHR5U3R5bGUgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jykuc3R5bGU7CiAgICBwcm9wID0gY2FtZWxpemUocHJvcCk7CiAgICBpZiAocHJvcCAhPT0gJ2ZpbHRlcicgJiYgKHByb3AgaW4gZW1wdHlTdHlsZSkpIHsKICAgICAgcmV0dXJuIHByb3AKICAgIH0KICAgIHZhciBjYXBOYW1lID0gcHJvcC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHByb3Auc2xpY2UoMSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZlbmRvck5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBuYW1lID0gdmVuZG9yTmFtZXNbaV0gKyBjYXBOYW1lOwogICAgICBpZiAobmFtZSBpbiBlbXB0eVN0eWxlKSB7CiAgICAgICAgcmV0dXJuIG5hbWUKICAgICAgfQogICAgfQogIH0pOwoKICBmdW5jdGlvbiB1cGRhdGVTdHlsZSAob2xkVm5vZGUsIHZub2RlKSB7CiAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgICB2YXIgb2xkRGF0YSA9IG9sZFZub2RlLmRhdGE7CgogICAgaWYgKGlzVW5kZWYoZGF0YS5zdGF0aWNTdHlsZSkgJiYgaXNVbmRlZihkYXRhLnN0eWxlKSAmJgogICAgICBpc1VuZGVmKG9sZERhdGEuc3RhdGljU3R5bGUpICYmIGlzVW5kZWYob2xkRGF0YS5zdHlsZSkKICAgICkgewogICAgICByZXR1cm4KICAgIH0KCiAgICB2YXIgY3VyLCBuYW1lOwogICAgdmFyIGVsID0gdm5vZGUuZWxtOwogICAgdmFyIG9sZFN0YXRpY1N0eWxlID0gb2xkRGF0YS5zdGF0aWNTdHlsZTsKICAgIHZhciBvbGRTdHlsZUJpbmRpbmcgPSBvbGREYXRhLm5vcm1hbGl6ZWRTdHlsZSB8fCBvbGREYXRhLnN0eWxlIHx8IHt9OwoKICAgIC8vIGlmIHN0YXRpYyBzdHlsZSBleGlzdHMsIHN0eWxlYmluZGluZyBhbHJlYWR5IG1lcmdlZCBpbnRvIGl0IHdoZW4gZG9pbmcgbm9ybWFsaXplU3R5bGVEYXRhCiAgICB2YXIgb2xkU3R5bGUgPSBvbGRTdGF0aWNTdHlsZSB8fCBvbGRTdHlsZUJpbmRpbmc7CgogICAgdmFyIHN0eWxlID0gbm9ybWFsaXplU3R5bGVCaW5kaW5nKHZub2RlLmRhdGEuc3R5bGUpIHx8IHt9OwoKICAgIC8vIHN0b3JlIG5vcm1hbGl6ZWQgc3R5bGUgdW5kZXIgYSBkaWZmZXJlbnQga2V5IGZvciBuZXh0IGRpZmYKICAgIC8vIG1ha2Ugc3VyZSB0byBjbG9uZSBpdCBpZiBpdCdzIHJlYWN0aXZlLCBzaW5jZSB0aGUgdXNlciBsaWtlbHkgd2FudHMKICAgIC8vIHRvIG11dGF0ZSBpdC4KICAgIHZub2RlLmRhdGEubm9ybWFsaXplZFN0eWxlID0gaXNEZWYoc3R5bGUuX19vYl9fKQogICAgICA/IGV4dGVuZCh7fSwgc3R5bGUpCiAgICAgIDogc3R5bGU7CgogICAgdmFyIG5ld1N0eWxlID0gZ2V0U3R5bGUodm5vZGUsIHRydWUpOwoKICAgIGZvciAobmFtZSBpbiBvbGRTdHlsZSkgewogICAgICBpZiAoaXNVbmRlZihuZXdTdHlsZVtuYW1lXSkpIHsKICAgICAgICBzZXRQcm9wKGVsLCBuYW1lLCAnJyk7CiAgICAgIH0KICAgIH0KICAgIGZvciAobmFtZSBpbiBuZXdTdHlsZSkgewogICAgICBjdXIgPSBuZXdTdHlsZVtuYW1lXTsKICAgICAgaWYgKGN1ciAhPT0gb2xkU3R5bGVbbmFtZV0pIHsKICAgICAgICAvLyBpZTkgc2V0dGluZyB0byBudWxsIGhhcyBubyBlZmZlY3QsIG11c3QgdXNlIGVtcHR5IHN0cmluZwogICAgICAgIHNldFByb3AoZWwsIG5hbWUsIGN1ciA9PSBudWxsID8gJycgOiBjdXIpOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgc3R5bGUgPSB7CiAgICBjcmVhdGU6IHVwZGF0ZVN0eWxlLAogICAgdXBkYXRlOiB1cGRhdGVTdHlsZQogIH07CgogIC8qICAqLwoKICB2YXIgd2hpdGVzcGFjZVJFID0gL1xzKy87CgogIC8qKgogICAqIEFkZCBjbGFzcyB3aXRoIGNvbXBhdGliaWxpdHkgZm9yIFNWRyBzaW5jZSBjbGFzc0xpc3QgaXMgbm90IHN1cHBvcnRlZCBvbgogICAqIFNWRyBlbGVtZW50cyBpbiBJRQogICAqLwogIGZ1bmN0aW9uIGFkZENsYXNzIChlbCwgY2xzKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmICghY2xzIHx8ICEoY2xzID0gY2xzLnRyaW0oKSkpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICAgIGlmIChlbC5jbGFzc0xpc3QpIHsKICAgICAgaWYgKGNscy5pbmRleE9mKCcgJykgPiAtMSkgewogICAgICAgIGNscy5zcGxpdCh3aGl0ZXNwYWNlUkUpLmZvckVhY2goZnVuY3Rpb24gKGMpIHsgcmV0dXJuIGVsLmNsYXNzTGlzdC5hZGQoYyk7IH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGVsLmNsYXNzTGlzdC5hZGQoY2xzKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGN1ciA9ICIgIiArIChlbC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycpICsgIiAiOwogICAgICBpZiAoY3VyLmluZGV4T2YoJyAnICsgY2xzICsgJyAnKSA8IDApIHsKICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgKGN1ciArIGNscykudHJpbSgpKTsKICAgICAgfQogICAgfQogIH0KCiAgLyoqCiAgICogUmVtb3ZlIGNsYXNzIHdpdGggY29tcGF0aWJpbGl0eSBmb3IgU1ZHIHNpbmNlIGNsYXNzTGlzdCBpcyBub3Qgc3VwcG9ydGVkIG9uCiAgICogU1ZHIGVsZW1lbnRzIGluIElFCiAgICovCiAgZnVuY3Rpb24gcmVtb3ZlQ2xhc3MgKGVsLCBjbHMpIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKCFjbHMgfHwgIShjbHMgPSBjbHMudHJpbSgpKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgaWYgKGVsLmNsYXNzTGlzdCkgewogICAgICBpZiAoY2xzLmluZGV4T2YoJyAnKSA+IC0xKSB7CiAgICAgICAgY2xzLnNwbGl0KHdoaXRlc3BhY2VSRSkuZm9yRWFjaChmdW5jdGlvbiAoYykgeyByZXR1cm4gZWwuY2xhc3NMaXN0LnJlbW92ZShjKTsgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjbHMpOwogICAgICB9CiAgICAgIGlmICghZWwuY2xhc3NMaXN0Lmxlbmd0aCkgewogICAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZSgnY2xhc3MnKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGN1ciA9ICIgIiArIChlbC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycpICsgIiAiOwogICAgICB2YXIgdGFyID0gJyAnICsgY2xzICsgJyAnOwogICAgICB3aGlsZSAoY3VyLmluZGV4T2YodGFyKSA+PSAwKSB7CiAgICAgICAgY3VyID0gY3VyLnJlcGxhY2UodGFyLCAnICcpOwogICAgICB9CiAgICAgIGN1ciA9IGN1ci50cmltKCk7CiAgICAgIGlmIChjdXIpIHsKICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgY3VyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoJ2NsYXNzJyk7CiAgICAgIH0KICAgIH0KICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiByZXNvbHZlVHJhbnNpdGlvbiAoZGVmJCQxKSB7CiAgICBpZiAoIWRlZiQkMSkgewogICAgICByZXR1cm4KICAgIH0KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgICBpZiAodHlwZW9mIGRlZiQkMSA9PT0gJ29iamVjdCcpIHsKICAgICAgdmFyIHJlcyA9IHt9OwogICAgICBpZiAoZGVmJCQxLmNzcyAhPT0gZmFsc2UpIHsKICAgICAgICBleHRlbmQocmVzLCBhdXRvQ3NzVHJhbnNpdGlvbihkZWYkJDEubmFtZSB8fCAndicpKTsKICAgICAgfQogICAgICBleHRlbmQocmVzLCBkZWYkJDEpOwogICAgICByZXR1cm4gcmVzCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWYkJDEgPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBhdXRvQ3NzVHJhbnNpdGlvbihkZWYkJDEpCiAgICB9CiAgfQoKICB2YXIgYXV0b0Nzc1RyYW5zaXRpb24gPSBjYWNoZWQoZnVuY3Rpb24gKG5hbWUpIHsKICAgIHJldHVybiB7CiAgICAgIGVudGVyQ2xhc3M6IChuYW1lICsgIi1lbnRlciIpLAogICAgICBlbnRlclRvQ2xhc3M6IChuYW1lICsgIi1lbnRlci10byIpLAogICAgICBlbnRlckFjdGl2ZUNsYXNzOiAobmFtZSArICItZW50ZXItYWN0aXZlIiksCiAgICAgIGxlYXZlQ2xhc3M6IChuYW1lICsgIi1sZWF2ZSIpLAogICAgICBsZWF2ZVRvQ2xhc3M6IChuYW1lICsgIi1sZWF2ZS10byIpLAogICAgICBsZWF2ZUFjdGl2ZUNsYXNzOiAobmFtZSArICItbGVhdmUtYWN0aXZlIikKICAgIH0KICB9KTsKCiAgdmFyIGhhc1RyYW5zaXRpb24gPSBpbkJyb3dzZXIgJiYgIWlzSUU5OwogIHZhciBUUkFOU0lUSU9OID0gJ3RyYW5zaXRpb24nOwogIHZhciBBTklNQVRJT04gPSAnYW5pbWF0aW9uJzsKCiAgLy8gVHJhbnNpdGlvbiBwcm9wZXJ0eS9ldmVudCBzbmlmZmluZwogIHZhciB0cmFuc2l0aW9uUHJvcCA9ICd0cmFuc2l0aW9uJzsKICB2YXIgdHJhbnNpdGlvbkVuZEV2ZW50ID0gJ3RyYW5zaXRpb25lbmQnOwogIHZhciBhbmltYXRpb25Qcm9wID0gJ2FuaW1hdGlvbic7CiAgdmFyIGFuaW1hdGlvbkVuZEV2ZW50ID0gJ2FuaW1hdGlvbmVuZCc7CiAgaWYgKGhhc1RyYW5zaXRpb24pIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKHdpbmRvdy5vbnRyYW5zaXRpb25lbmQgPT09IHVuZGVmaW5lZCAmJgogICAgICB3aW5kb3cub253ZWJraXR0cmFuc2l0aW9uZW5kICE9PSB1bmRlZmluZWQKICAgICkgewogICAgICB0cmFuc2l0aW9uUHJvcCA9ICdXZWJraXRUcmFuc2l0aW9uJzsKICAgICAgdHJhbnNpdGlvbkVuZEV2ZW50ID0gJ3dlYmtpdFRyYW5zaXRpb25FbmQnOwogICAgfQogICAgaWYgKHdpbmRvdy5vbmFuaW1hdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmCiAgICAgIHdpbmRvdy5vbndlYmtpdGFuaW1hdGlvbmVuZCAhPT0gdW5kZWZpbmVkCiAgICApIHsKICAgICAgYW5pbWF0aW9uUHJvcCA9ICdXZWJraXRBbmltYXRpb24nOwogICAgICBhbmltYXRpb25FbmRFdmVudCA9ICd3ZWJraXRBbmltYXRpb25FbmQnOwogICAgfQogIH0KCiAgLy8gYmluZGluZyB0byB3aW5kb3cgaXMgbmVjZXNzYXJ5IHRvIG1ha2UgaG90IHJlbG9hZCB3b3JrIGluIElFIGluIHN0cmljdCBtb2RlCiAgdmFyIHJhZiA9IGluQnJvd3NlcgogICAgPyB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lCiAgICAgID8gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZS5iaW5kKHdpbmRvdykKICAgICAgOiBzZXRUaW1lb3V0CiAgICA6IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovIGZ1bmN0aW9uIChmbikgeyByZXR1cm4gZm4oKTsgfTsKCiAgZnVuY3Rpb24gbmV4dEZyYW1lIChmbikgewogICAgcmFmKGZ1bmN0aW9uICgpIHsKICAgICAgcmFmKGZuKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gYWRkVHJhbnNpdGlvbkNsYXNzIChlbCwgY2xzKSB7CiAgICB2YXIgdHJhbnNpdGlvbkNsYXNzZXMgPSBlbC5fdHJhbnNpdGlvbkNsYXNzZXMgfHwgKGVsLl90cmFuc2l0aW9uQ2xhc3NlcyA9IFtdKTsKICAgIGlmICh0cmFuc2l0aW9uQ2xhc3Nlcy5pbmRleE9mKGNscykgPCAwKSB7CiAgICAgIHRyYW5zaXRpb25DbGFzc2VzLnB1c2goY2xzKTsKICAgICAgYWRkQ2xhc3MoZWwsIGNscyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW1vdmVUcmFuc2l0aW9uQ2xhc3MgKGVsLCBjbHMpIHsKICAgIGlmIChlbC5fdHJhbnNpdGlvbkNsYXNzZXMpIHsKICAgICAgcmVtb3ZlKGVsLl90cmFuc2l0aW9uQ2xhc3NlcywgY2xzKTsKICAgIH0KICAgIHJlbW92ZUNsYXNzKGVsLCBjbHMpOwogIH0KCiAgZnVuY3Rpb24gd2hlblRyYW5zaXRpb25FbmRzICgKICAgIGVsLAogICAgZXhwZWN0ZWRUeXBlLAogICAgY2IKICApIHsKICAgIHZhciByZWYgPSBnZXRUcmFuc2l0aW9uSW5mbyhlbCwgZXhwZWN0ZWRUeXBlKTsKICAgIHZhciB0eXBlID0gcmVmLnR5cGU7CiAgICB2YXIgdGltZW91dCA9IHJlZi50aW1lb3V0OwogICAgdmFyIHByb3BDb3VudCA9IHJlZi5wcm9wQ291bnQ7CiAgICBpZiAoIXR5cGUpIHsgcmV0dXJuIGNiKCkgfQogICAgdmFyIGV2ZW50ID0gdHlwZSA9PT0gVFJBTlNJVElPTiA/IHRyYW5zaXRpb25FbmRFdmVudCA6IGFuaW1hdGlvbkVuZEV2ZW50OwogICAgdmFyIGVuZGVkID0gMDsKICAgIHZhciBlbmQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQsIG9uRW5kKTsKICAgICAgY2IoKTsKICAgIH07CiAgICB2YXIgb25FbmQgPSBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoZS50YXJnZXQgPT09IGVsKSB7CiAgICAgICAgaWYgKCsrZW5kZWQgPj0gcHJvcENvdW50KSB7CiAgICAgICAgICBlbmQoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGVuZGVkIDwgcHJvcENvdW50KSB7CiAgICAgICAgZW5kKCk7CiAgICAgIH0KICAgIH0sIHRpbWVvdXQgKyAxKTsKICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIG9uRW5kKTsKICB9CgogIHZhciB0cmFuc2Zvcm1SRSA9IC9cYih0cmFuc2Zvcm18YWxsKSgsfCQpLzsKCiAgZnVuY3Rpb24gZ2V0VHJhbnNpdGlvbkluZm8gKGVsLCBleHBlY3RlZFR5cGUpIHsKICAgIHZhciBzdHlsZXMgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCk7CiAgICAvLyBKU0RPTSBtYXkgcmV0dXJuIHVuZGVmaW5lZCBmb3IgdHJhbnNpdGlvbiBwcm9wZXJ0aWVzCiAgICB2YXIgdHJhbnNpdGlvbkRlbGF5cyA9IChzdHlsZXNbdHJhbnNpdGlvblByb3AgKyAnRGVsYXknXSB8fCAnJykuc3BsaXQoJywgJyk7CiAgICB2YXIgdHJhbnNpdGlvbkR1cmF0aW9ucyA9IChzdHlsZXNbdHJhbnNpdGlvblByb3AgKyAnRHVyYXRpb24nXSB8fCAnJykuc3BsaXQoJywgJyk7CiAgICB2YXIgdHJhbnNpdGlvblRpbWVvdXQgPSBnZXRUaW1lb3V0KHRyYW5zaXRpb25EZWxheXMsIHRyYW5zaXRpb25EdXJhdGlvbnMpOwogICAgdmFyIGFuaW1hdGlvbkRlbGF5cyA9IChzdHlsZXNbYW5pbWF0aW9uUHJvcCArICdEZWxheSddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICAgIHZhciBhbmltYXRpb25EdXJhdGlvbnMgPSAoc3R5bGVzW2FuaW1hdGlvblByb3AgKyAnRHVyYXRpb24nXSB8fCAnJykuc3BsaXQoJywgJyk7CiAgICB2YXIgYW5pbWF0aW9uVGltZW91dCA9IGdldFRpbWVvdXQoYW5pbWF0aW9uRGVsYXlzLCBhbmltYXRpb25EdXJhdGlvbnMpOwoKICAgIHZhciB0eXBlOwogICAgdmFyIHRpbWVvdXQgPSAwOwogICAgdmFyIHByb3BDb3VudCA9IDA7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChleHBlY3RlZFR5cGUgPT09IFRSQU5TSVRJT04pIHsKICAgICAgaWYgKHRyYW5zaXRpb25UaW1lb3V0ID4gMCkgewogICAgICAgIHR5cGUgPSBUUkFOU0lUSU9OOwogICAgICAgIHRpbWVvdXQgPSB0cmFuc2l0aW9uVGltZW91dDsKICAgICAgICBwcm9wQ291bnQgPSB0cmFuc2l0aW9uRHVyYXRpb25zLmxlbmd0aDsKICAgICAgfQogICAgfSBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09IEFOSU1BVElPTikgewogICAgICBpZiAoYW5pbWF0aW9uVGltZW91dCA+IDApIHsKICAgICAgICB0eXBlID0gQU5JTUFUSU9OOwogICAgICAgIHRpbWVvdXQgPSBhbmltYXRpb25UaW1lb3V0OwogICAgICAgIHByb3BDb3VudCA9IGFuaW1hdGlvbkR1cmF0aW9ucy5sZW5ndGg7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRpbWVvdXQgPSBNYXRoLm1heCh0cmFuc2l0aW9uVGltZW91dCwgYW5pbWF0aW9uVGltZW91dCk7CiAgICAgIHR5cGUgPSB0aW1lb3V0ID4gMAogICAgICAgID8gdHJhbnNpdGlvblRpbWVvdXQgPiBhbmltYXRpb25UaW1lb3V0CiAgICAgICAgICA/IFRSQU5TSVRJT04KICAgICAgICAgIDogQU5JTUFUSU9OCiAgICAgICAgOiBudWxsOwogICAgICBwcm9wQ291bnQgPSB0eXBlCiAgICAgICAgPyB0eXBlID09PSBUUkFOU0lUSU9OCiAgICAgICAgICA/IHRyYW5zaXRpb25EdXJhdGlvbnMubGVuZ3RoCiAgICAgICAgICA6IGFuaW1hdGlvbkR1cmF0aW9ucy5sZW5ndGgKICAgICAgICA6IDA7CiAgICB9CiAgICB2YXIgaGFzVHJhbnNmb3JtID0KICAgICAgdHlwZSA9PT0gVFJBTlNJVElPTiAmJgogICAgICB0cmFuc2Zvcm1SRS50ZXN0KHN0eWxlc1t0cmFuc2l0aW9uUHJvcCArICdQcm9wZXJ0eSddKTsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6IHR5cGUsCiAgICAgIHRpbWVvdXQ6IHRpbWVvdXQsCiAgICAgIHByb3BDb3VudDogcHJvcENvdW50LAogICAgICBoYXNUcmFuc2Zvcm06IGhhc1RyYW5zZm9ybQogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0VGltZW91dCAoZGVsYXlzLCBkdXJhdGlvbnMpIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICB3aGlsZSAoZGVsYXlzLmxlbmd0aCA8IGR1cmF0aW9ucy5sZW5ndGgpIHsKICAgICAgZGVsYXlzID0gZGVsYXlzLmNvbmNhdChkZWxheXMpOwogICAgfQoKICAgIHJldHVybiBNYXRoLm1heC5hcHBseShudWxsLCBkdXJhdGlvbnMubWFwKGZ1bmN0aW9uIChkLCBpKSB7CiAgICAgIHJldHVybiB0b01zKGQpICsgdG9NcyhkZWxheXNbaV0pCiAgICB9KSkKICB9CgogIC8vIE9sZCB2ZXJzaW9ucyBvZiBDaHJvbWl1bSAoYmVsb3cgNjEuMC4zMTYzLjEwMCkgZm9ybWF0cyBmbG9hdGluZyBwb2ludGVyIG51bWJlcnMKICAvLyBpbiBhIGxvY2FsZS1kZXBlbmRlbnQgd2F5LCB1c2luZyBhIGNvbW1hIGluc3RlYWQgb2YgYSBkb3QuCiAgLy8gSWYgY29tbWEgaXMgbm90IHJlcGxhY2VkIHdpdGggYSBkb3QsIHRoZSBpbnB1dCB3aWxsIGJlIHJvdW5kZWQgZG93biAoaS5lLiBhY3RpbmcKICAvLyBhcyBhIGZsb29yIGZ1bmN0aW9uKSBjYXVzaW5nIHVuZXhwZWN0ZWQgYmVoYXZpb3JzCiAgZnVuY3Rpb24gdG9NcyAocykgewogICAgcmV0dXJuIE51bWJlcihzLnNsaWNlKDAsIC0xKS5yZXBsYWNlKCcsJywgJy4nKSkgKiAxMDAwCiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gZW50ZXIgKHZub2RlLCB0b2dnbGVEaXNwbGF5KSB7CiAgICB2YXIgZWwgPSB2bm9kZS5lbG07CgogICAgLy8gY2FsbCBsZWF2ZSBjYWxsYmFjayBub3cKICAgIGlmIChpc0RlZihlbC5fbGVhdmVDYikpIHsKICAgICAgZWwuX2xlYXZlQ2IuY2FuY2VsbGVkID0gdHJ1ZTsKICAgICAgZWwuX2xlYXZlQ2IoKTsKICAgIH0KCiAgICB2YXIgZGF0YSA9IHJlc29sdmVUcmFuc2l0aW9uKHZub2RlLmRhdGEudHJhbnNpdGlvbik7CiAgICBpZiAoaXNVbmRlZihkYXRhKSkgewogICAgICByZXR1cm4KICAgIH0KCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChpc0RlZihlbC5fZW50ZXJDYikgfHwgZWwubm9kZVR5cGUgIT09IDEpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdmFyIGNzcyA9IGRhdGEuY3NzOwogICAgdmFyIHR5cGUgPSBkYXRhLnR5cGU7CiAgICB2YXIgZW50ZXJDbGFzcyA9IGRhdGEuZW50ZXJDbGFzczsKICAgIHZhciBlbnRlclRvQ2xhc3MgPSBkYXRhLmVudGVyVG9DbGFzczsKICAgIHZhciBlbnRlckFjdGl2ZUNsYXNzID0gZGF0YS5lbnRlckFjdGl2ZUNsYXNzOwogICAgdmFyIGFwcGVhckNsYXNzID0gZGF0YS5hcHBlYXJDbGFzczsKICAgIHZhciBhcHBlYXJUb0NsYXNzID0gZGF0YS5hcHBlYXJUb0NsYXNzOwogICAgdmFyIGFwcGVhckFjdGl2ZUNsYXNzID0gZGF0YS5hcHBlYXJBY3RpdmVDbGFzczsKICAgIHZhciBiZWZvcmVFbnRlciA9IGRhdGEuYmVmb3JlRW50ZXI7CiAgICB2YXIgZW50ZXIgPSBkYXRhLmVudGVyOwogICAgdmFyIGFmdGVyRW50ZXIgPSBkYXRhLmFmdGVyRW50ZXI7CiAgICB2YXIgZW50ZXJDYW5jZWxsZWQgPSBkYXRhLmVudGVyQ2FuY2VsbGVkOwogICAgdmFyIGJlZm9yZUFwcGVhciA9IGRhdGEuYmVmb3JlQXBwZWFyOwogICAgdmFyIGFwcGVhciA9IGRhdGEuYXBwZWFyOwogICAgdmFyIGFmdGVyQXBwZWFyID0gZGF0YS5hZnRlckFwcGVhcjsKICAgIHZhciBhcHBlYXJDYW5jZWxsZWQgPSBkYXRhLmFwcGVhckNhbmNlbGxlZDsKICAgIHZhciBkdXJhdGlvbiA9IGRhdGEuZHVyYXRpb247CgogICAgLy8gYWN0aXZlSW5zdGFuY2Ugd2lsbCBhbHdheXMgYmUgdGhlIDx0cmFuc2l0aW9uPiBjb21wb25lbnQgbWFuYWdpbmcgdGhpcwogICAgLy8gdHJhbnNpdGlvbi4gT25lIGVkZ2UgY2FzZSB0byBjaGVjayBpcyB3aGVuIHRoZSA8dHJhbnNpdGlvbj4gaXMgcGxhY2VkCiAgICAvLyBhcyB0aGUgcm9vdCBub2RlIG9mIGEgY2hpbGQgY29tcG9uZW50LiBJbiB0aGF0IGNhc2Ugd2UgbmVlZCB0byBjaGVjawogICAgLy8gPHRyYW5zaXRpb24+J3MgcGFyZW50IGZvciBhcHBlYXIgY2hlY2suCiAgICB2YXIgY29udGV4dCA9IGFjdGl2ZUluc3RhbmNlOwogICAgdmFyIHRyYW5zaXRpb25Ob2RlID0gYWN0aXZlSW5zdGFuY2UuJHZub2RlOwogICAgd2hpbGUgKHRyYW5zaXRpb25Ob2RlICYmIHRyYW5zaXRpb25Ob2RlLnBhcmVudCkgewogICAgICB0cmFuc2l0aW9uTm9kZSA9IHRyYW5zaXRpb25Ob2RlLnBhcmVudDsKICAgICAgY29udGV4dCA9IHRyYW5zaXRpb25Ob2RlLmNvbnRleHQ7CiAgICB9CgogICAgdmFyIGlzQXBwZWFyID0gIWNvbnRleHQuX2lzTW91bnRlZCB8fCAhdm5vZGUuaXNSb290SW5zZXJ0OwoKICAgIGlmIChpc0FwcGVhciAmJiAhYXBwZWFyICYmIGFwcGVhciAhPT0gJycpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdmFyIHN0YXJ0Q2xhc3MgPSBpc0FwcGVhciAmJiBhcHBlYXJDbGFzcwogICAgICA/IGFwcGVhckNsYXNzCiAgICAgIDogZW50ZXJDbGFzczsKICAgIHZhciBhY3RpdmVDbGFzcyA9IGlzQXBwZWFyICYmIGFwcGVhckFjdGl2ZUNsYXNzCiAgICAgID8gYXBwZWFyQWN0aXZlQ2xhc3MKICAgICAgOiBlbnRlckFjdGl2ZUNsYXNzOwogICAgdmFyIHRvQ2xhc3MgPSBpc0FwcGVhciAmJiBhcHBlYXJUb0NsYXNzCiAgICAgID8gYXBwZWFyVG9DbGFzcwogICAgICA6IGVudGVyVG9DbGFzczsKCiAgICB2YXIgYmVmb3JlRW50ZXJIb29rID0gaXNBcHBlYXIKICAgICAgPyAoYmVmb3JlQXBwZWFyIHx8IGJlZm9yZUVudGVyKQogICAgICA6IGJlZm9yZUVudGVyOwogICAgdmFyIGVudGVySG9vayA9IGlzQXBwZWFyCiAgICAgID8gKHR5cGVvZiBhcHBlYXIgPT09ICdmdW5jdGlvbicgPyBhcHBlYXIgOiBlbnRlcikKICAgICAgOiBlbnRlcjsKICAgIHZhciBhZnRlckVudGVySG9vayA9IGlzQXBwZWFyCiAgICAgID8gKGFmdGVyQXBwZWFyIHx8IGFmdGVyRW50ZXIpCiAgICAgIDogYWZ0ZXJFbnRlcjsKICAgIHZhciBlbnRlckNhbmNlbGxlZEhvb2sgPSBpc0FwcGVhcgogICAgICA/IChhcHBlYXJDYW5jZWxsZWQgfHwgZW50ZXJDYW5jZWxsZWQpCiAgICAgIDogZW50ZXJDYW5jZWxsZWQ7CgogICAgdmFyIGV4cGxpY2l0RW50ZXJEdXJhdGlvbiA9IHRvTnVtYmVyKAogICAgICBpc09iamVjdChkdXJhdGlvbikKICAgICAgICA/IGR1cmF0aW9uLmVudGVyCiAgICAgICAgOiBkdXJhdGlvbgogICAgKTsKCiAgICBpZiAoZXhwbGljaXRFbnRlckR1cmF0aW9uICE9IG51bGwpIHsKICAgICAgY2hlY2tEdXJhdGlvbihleHBsaWNpdEVudGVyRHVyYXRpb24sICdlbnRlcicsIHZub2RlKTsKICAgIH0KCiAgICB2YXIgZXhwZWN0c0NTUyA9IGNzcyAhPT0gZmFsc2UgJiYgIWlzSUU5OwogICAgdmFyIHVzZXJXYW50c0NvbnRyb2wgPSBnZXRIb29rQXJndW1lbnRzTGVuZ3RoKGVudGVySG9vayk7CgogICAgdmFyIGNiID0gZWwuX2VudGVyQ2IgPSBvbmNlKGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIHRvQ2xhc3MpOwogICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgYWN0aXZlQ2xhc3MpOwogICAgICB9CiAgICAgIGlmIChjYi5jYW5jZWxsZWQpIHsKICAgICAgICBpZiAoZXhwZWN0c0NTUykgewogICAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBzdGFydENsYXNzKTsKICAgICAgICB9CiAgICAgICAgZW50ZXJDYW5jZWxsZWRIb29rICYmIGVudGVyQ2FuY2VsbGVkSG9vayhlbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYWZ0ZXJFbnRlckhvb2sgJiYgYWZ0ZXJFbnRlckhvb2soZWwpOwogICAgICB9CiAgICAgIGVsLl9lbnRlckNiID0gbnVsbDsKICAgIH0pOwoKICAgIGlmICghdm5vZGUuZGF0YS5zaG93KSB7CiAgICAgIC8vIHJlbW92ZSBwZW5kaW5nIGxlYXZlIGVsZW1lbnQgb24gZW50ZXIgYnkgaW5qZWN0aW5nIGFuIGluc2VydCBob29rCiAgICAgIG1lcmdlVk5vZGVIb29rKHZub2RlLCAnaW5zZXJ0JywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwYXJlbnQgPSBlbC5wYXJlbnROb2RlOwogICAgICAgIHZhciBwZW5kaW5nTm9kZSA9IHBhcmVudCAmJiBwYXJlbnQuX3BlbmRpbmcgJiYgcGFyZW50Ll9wZW5kaW5nW3Zub2RlLmtleV07CiAgICAgICAgaWYgKHBlbmRpbmdOb2RlICYmCiAgICAgICAgICBwZW5kaW5nTm9kZS50YWcgPT09IHZub2RlLnRhZyAmJgogICAgICAgICAgcGVuZGluZ05vZGUuZWxtLl9sZWF2ZUNiCiAgICAgICAgKSB7CiAgICAgICAgICBwZW5kaW5nTm9kZS5lbG0uX2xlYXZlQ2IoKTsKICAgICAgICB9CiAgICAgICAgZW50ZXJIb29rICYmIGVudGVySG9vayhlbCwgY2IpOwogICAgICB9KTsKICAgIH0KCiAgICAvLyBzdGFydCBlbnRlciB0cmFuc2l0aW9uCiAgICBiZWZvcmVFbnRlckhvb2sgJiYgYmVmb3JlRW50ZXJIb29rKGVsKTsKICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgc3RhcnRDbGFzcyk7CiAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgYWN0aXZlQ2xhc3MpOwogICAgICBuZXh0RnJhbWUoZnVuY3Rpb24gKCkgewogICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgc3RhcnRDbGFzcyk7CiAgICAgICAgaWYgKCFjYi5jYW5jZWxsZWQpIHsKICAgICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgdG9DbGFzcyk7CiAgICAgICAgICBpZiAoIXVzZXJXYW50c0NvbnRyb2wpIHsKICAgICAgICAgICAgaWYgKGlzVmFsaWREdXJhdGlvbihleHBsaWNpdEVudGVyRHVyYXRpb24pKSB7CiAgICAgICAgICAgICAgc2V0VGltZW91dChjYiwgZXhwbGljaXRFbnRlckR1cmF0aW9uKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIHR5cGUsIGNiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgaWYgKHZub2RlLmRhdGEuc2hvdykgewogICAgICB0b2dnbGVEaXNwbGF5ICYmIHRvZ2dsZURpc3BsYXkoKTsKICAgICAgZW50ZXJIb29rICYmIGVudGVySG9vayhlbCwgY2IpOwogICAgfQoKICAgIGlmICghZXhwZWN0c0NTUyAmJiAhdXNlcldhbnRzQ29udHJvbCkgewogICAgICBjYigpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gbGVhdmUgKHZub2RlLCBybSkgewogICAgdmFyIGVsID0gdm5vZGUuZWxtOwoKICAgIC8vIGNhbGwgZW50ZXIgY2FsbGJhY2sgbm93CiAgICBpZiAoaXNEZWYoZWwuX2VudGVyQ2IpKSB7CiAgICAgIGVsLl9lbnRlckNiLmNhbmNlbGxlZCA9IHRydWU7CiAgICAgIGVsLl9lbnRlckNiKCk7CiAgICB9CgogICAgdmFyIGRhdGEgPSByZXNvbHZlVHJhbnNpdGlvbih2bm9kZS5kYXRhLnRyYW5zaXRpb24pOwogICAgaWYgKGlzVW5kZWYoZGF0YSkgfHwgZWwubm9kZVR5cGUgIT09IDEpIHsKICAgICAgcmV0dXJuIHJtKCkKICAgIH0KCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChpc0RlZihlbC5fbGVhdmVDYikpIHsKICAgICAgcmV0dXJuCiAgICB9CgogICAgdmFyIGNzcyA9IGRhdGEuY3NzOwogICAgdmFyIHR5cGUgPSBkYXRhLnR5cGU7CiAgICB2YXIgbGVhdmVDbGFzcyA9IGRhdGEubGVhdmVDbGFzczsKICAgIHZhciBsZWF2ZVRvQ2xhc3MgPSBkYXRhLmxlYXZlVG9DbGFzczsKICAgIHZhciBsZWF2ZUFjdGl2ZUNsYXNzID0gZGF0YS5sZWF2ZUFjdGl2ZUNsYXNzOwogICAgdmFyIGJlZm9yZUxlYXZlID0gZGF0YS5iZWZvcmVMZWF2ZTsKICAgIHZhciBsZWF2ZSA9IGRhdGEubGVhdmU7CiAgICB2YXIgYWZ0ZXJMZWF2ZSA9IGRhdGEuYWZ0ZXJMZWF2ZTsKICAgIHZhciBsZWF2ZUNhbmNlbGxlZCA9IGRhdGEubGVhdmVDYW5jZWxsZWQ7CiAgICB2YXIgZGVsYXlMZWF2ZSA9IGRhdGEuZGVsYXlMZWF2ZTsKICAgIHZhciBkdXJhdGlvbiA9IGRhdGEuZHVyYXRpb247CgogICAgdmFyIGV4cGVjdHNDU1MgPSBjc3MgIT09IGZhbHNlICYmICFpc0lFOTsKICAgIHZhciB1c2VyV2FudHNDb250cm9sID0gZ2V0SG9va0FyZ3VtZW50c0xlbmd0aChsZWF2ZSk7CgogICAgdmFyIGV4cGxpY2l0TGVhdmVEdXJhdGlvbiA9IHRvTnVtYmVyKAogICAgICBpc09iamVjdChkdXJhdGlvbikKICAgICAgICA/IGR1cmF0aW9uLmxlYXZlCiAgICAgICAgOiBkdXJhdGlvbgogICAgKTsKCiAgICBpZiAoaXNEZWYoZXhwbGljaXRMZWF2ZUR1cmF0aW9uKSkgewogICAgICBjaGVja0R1cmF0aW9uKGV4cGxpY2l0TGVhdmVEdXJhdGlvbiwgJ2xlYXZlJywgdm5vZGUpOwogICAgfQoKICAgIHZhciBjYiA9IGVsLl9sZWF2ZUNiID0gb25jZShmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChlbC5wYXJlbnROb2RlICYmIGVsLnBhcmVudE5vZGUuX3BlbmRpbmcpIHsKICAgICAgICBlbC5wYXJlbnROb2RlLl9wZW5kaW5nW3Zub2RlLmtleV0gPSBudWxsOwogICAgICB9CiAgICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZVRvQ2xhc3MpOwogICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVBY3RpdmVDbGFzcyk7CiAgICAgIH0KICAgICAgaWYgKGNiLmNhbmNlbGxlZCkgewogICAgICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQ2xhc3MpOwogICAgICAgIH0KICAgICAgICBsZWF2ZUNhbmNlbGxlZCAmJiBsZWF2ZUNhbmNlbGxlZChlbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm0oKTsKICAgICAgICBhZnRlckxlYXZlICYmIGFmdGVyTGVhdmUoZWwpOwogICAgICB9CiAgICAgIGVsLl9sZWF2ZUNiID0gbnVsbDsKICAgIH0pOwoKICAgIGlmIChkZWxheUxlYXZlKSB7CiAgICAgIGRlbGF5TGVhdmUocGVyZm9ybUxlYXZlKTsKICAgIH0gZWxzZSB7CiAgICAgIHBlcmZvcm1MZWF2ZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHBlcmZvcm1MZWF2ZSAoKSB7CiAgICAgIC8vIHRoZSBkZWxheWVkIGxlYXZlIG1heSBoYXZlIGFscmVhZHkgYmVlbiBjYW5jZWxsZWQKICAgICAgaWYgKGNiLmNhbmNlbGxlZCkgewogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIC8vIHJlY29yZCBsZWF2aW5nIGVsZW1lbnQKICAgICAgaWYgKCF2bm9kZS5kYXRhLnNob3cgJiYgZWwucGFyZW50Tm9kZSkgewogICAgICAgIChlbC5wYXJlbnROb2RlLl9wZW5kaW5nIHx8IChlbC5wYXJlbnROb2RlLl9wZW5kaW5nID0ge30pKVsodm5vZGUua2V5KV0gPSB2bm9kZTsKICAgICAgfQogICAgICBiZWZvcmVMZWF2ZSAmJiBiZWZvcmVMZWF2ZShlbCk7CiAgICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUNsYXNzKTsKICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQWN0aXZlQ2xhc3MpOwogICAgICAgIG5leHRGcmFtZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQ2xhc3MpOwogICAgICAgICAgaWYgKCFjYi5jYW5jZWxsZWQpIHsKICAgICAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZVRvQ2xhc3MpOwogICAgICAgICAgICBpZiAoIXVzZXJXYW50c0NvbnRyb2wpIHsKICAgICAgICAgICAgICBpZiAoaXNWYWxpZER1cmF0aW9uKGV4cGxpY2l0TGVhdmVEdXJhdGlvbikpIHsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoY2IsIGV4cGxpY2l0TGVhdmVEdXJhdGlvbik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdoZW5UcmFuc2l0aW9uRW5kcyhlbCwgdHlwZSwgY2IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGxlYXZlICYmIGxlYXZlKGVsLCBjYik7CiAgICAgIGlmICghZXhwZWN0c0NTUyAmJiAhdXNlcldhbnRzQ29udHJvbCkgewogICAgICAgIGNiKCk7CiAgICAgIH0KICAgIH0KICB9CgogIC8vIG9ubHkgdXNlZCBpbiBkZXYgbW9kZQogIGZ1bmN0aW9uIGNoZWNrRHVyYXRpb24gKHZhbCwgbmFtZSwgdm5vZGUpIHsKICAgIGlmICh0eXBlb2YgdmFsICE9PSAnbnVtYmVyJykgewogICAgICB3YXJuKAogICAgICAgICI8dHJhbnNpdGlvbj4gZXhwbGljaXQgIiArIG5hbWUgKyAiIGR1cmF0aW9uIGlzIG5vdCBhIHZhbGlkIG51bWJlciAtICIgKwogICAgICAgICJnb3QgIiArIChKU09OLnN0cmluZ2lmeSh2YWwpKSArICIuIiwKICAgICAgICB2bm9kZS5jb250ZXh0CiAgICAgICk7CiAgICB9IGVsc2UgaWYgKGlzTmFOKHZhbCkpIHsKICAgICAgd2FybigKICAgICAgICAiPHRyYW5zaXRpb24+IGV4cGxpY2l0ICIgKyBuYW1lICsgIiBkdXJhdGlvbiBpcyBOYU4gLSAiICsKICAgICAgICAndGhlIGR1cmF0aW9uIGV4cHJlc3Npb24gbWlnaHQgYmUgaW5jb3JyZWN0LicsCiAgICAgICAgdm5vZGUuY29udGV4dAogICAgICApOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaXNWYWxpZER1cmF0aW9uICh2YWwpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsID09PSAnbnVtYmVyJyAmJiAhaXNOYU4odmFsKQogIH0KCiAgLyoqCiAgICogTm9ybWFsaXplIGEgdHJhbnNpdGlvbiBob29rJ3MgYXJndW1lbnQgbGVuZ3RoLiBUaGUgaG9vayBtYXkgYmU6CiAgICogLSBhIG1lcmdlZCBob29rIChpbnZva2VyKSB3aXRoIHRoZSBvcmlnaW5hbCBpbiAuZm5zCiAgICogLSBhIHdyYXBwZWQgY29tcG9uZW50IG1ldGhvZCAoY2hlY2sgLl9sZW5ndGgpCiAgICogLSBhIHBsYWluIGZ1bmN0aW9uICgubGVuZ3RoKQogICAqLwogIGZ1bmN0aW9uIGdldEhvb2tBcmd1bWVudHNMZW5ndGggKGZuKSB7CiAgICBpZiAoaXNVbmRlZihmbikpIHsKICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgICB2YXIgaW52b2tlckZucyA9IGZuLmZuczsKICAgIGlmIChpc0RlZihpbnZva2VyRm5zKSkgewogICAgICAvLyBpbnZva2VyCiAgICAgIHJldHVybiBnZXRIb29rQXJndW1lbnRzTGVuZ3RoKAogICAgICAgIEFycmF5LmlzQXJyYXkoaW52b2tlckZucykKICAgICAgICAgID8gaW52b2tlckZuc1swXQogICAgICAgICAgOiBpbnZva2VyRm5zCiAgICAgICkKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAoZm4uX2xlbmd0aCB8fCBmbi5sZW5ndGgpID4gMQogICAgfQogIH0KCiAgZnVuY3Rpb24gX2VudGVyIChfLCB2bm9kZSkgewogICAgaWYgKHZub2RlLmRhdGEuc2hvdyAhPT0gdHJ1ZSkgewogICAgICBlbnRlcih2bm9kZSk7CiAgICB9CiAgfQoKICB2YXIgdHJhbnNpdGlvbiA9IGluQnJvd3NlciA/IHsKICAgIGNyZWF0ZTogX2VudGVyLAogICAgYWN0aXZhdGU6IF9lbnRlciwKICAgIHJlbW92ZTogZnVuY3Rpb24gcmVtb3ZlJCQxICh2bm9kZSwgcm0pIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICAgICAgaWYgKHZub2RlLmRhdGEuc2hvdyAhPT0gdHJ1ZSkgewogICAgICAgIGxlYXZlKHZub2RlLCBybSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm0oKTsKICAgICAgfQogICAgfQogIH0gOiB7fTsKCiAgdmFyIHBsYXRmb3JtTW9kdWxlcyA9IFsKICAgIGF0dHJzLAogICAga2xhc3MsCiAgICBldmVudHMsCiAgICBkb21Qcm9wcywKICAgIHN0eWxlLAogICAgdHJhbnNpdGlvbgogIF07CgogIC8qICAqLwoKICAvLyB0aGUgZGlyZWN0aXZlIG1vZHVsZSBzaG91bGQgYmUgYXBwbGllZCBsYXN0LCBhZnRlciBhbGwKICAvLyBidWlsdC1pbiBtb2R1bGVzIGhhdmUgYmVlbiBhcHBsaWVkLgogIHZhciBtb2R1bGVzID0gcGxhdGZvcm1Nb2R1bGVzLmNvbmNhdChiYXNlTW9kdWxlcyk7CgogIHZhciBwYXRjaCA9IGNyZWF0ZVBhdGNoRnVuY3Rpb24oeyBub2RlT3BzOiBub2RlT3BzLCBtb2R1bGVzOiBtb2R1bGVzIH0pOwoKICAvKioKICAgKiBOb3QgdHlwZSBjaGVja2luZyB0aGlzIGZpbGUgYmVjYXVzZSBmbG93IGRvZXNuJ3QgbGlrZSBhdHRhY2hpbmcKICAgKiBwcm9wZXJ0aWVzIHRvIEVsZW1lbnRzLgogICAqLwoKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoaXNJRTkpIHsKICAgIC8vIGh0dHA6Ly93d3cubWF0dHM0MTEuY29tL3Bvc3QvaW50ZXJuZXQtZXhwbG9yZXItOS1vbmlucHV0LwogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignc2VsZWN0aW9uY2hhbmdlJywgZnVuY3Rpb24gKCkgewogICAgICB2YXIgZWwgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwogICAgICBpZiAoZWwgJiYgZWwudm1vZGVsKSB7CiAgICAgICAgdHJpZ2dlcihlbCwgJ2lucHV0Jyk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgdmFyIGRpcmVjdGl2ZSA9IHsKICAgIGluc2VydGVkOiBmdW5jdGlvbiBpbnNlcnRlZCAoZWwsIGJpbmRpbmcsIHZub2RlLCBvbGRWbm9kZSkgewogICAgICBpZiAodm5vZGUudGFnID09PSAnc2VsZWN0JykgewogICAgICAgIC8vICM2OTAzCiAgICAgICAgaWYgKG9sZFZub2RlLmVsbSAmJiAhb2xkVm5vZGUuZWxtLl92T3B0aW9ucykgewogICAgICAgICAgbWVyZ2VWTm9kZUhvb2sodm5vZGUsICdwb3N0cGF0Y2gnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGRpcmVjdGl2ZS5jb21wb25lbnRVcGRhdGVkKGVsLCBiaW5kaW5nLCB2bm9kZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZub2RlLmNvbnRleHQpOwogICAgICAgIH0KICAgICAgICBlbC5fdk9wdGlvbnMgPSBbXS5tYXAuY2FsbChlbC5vcHRpb25zLCBnZXRWYWx1ZSk7CiAgICAgIH0gZWxzZSBpZiAodm5vZGUudGFnID09PSAndGV4dGFyZWEnIHx8IGlzVGV4dElucHV0VHlwZShlbC50eXBlKSkgewogICAgICAgIGVsLl92TW9kaWZpZXJzID0gYmluZGluZy5tb2RpZmllcnM7CiAgICAgICAgaWYgKCFiaW5kaW5nLm1vZGlmaWVycy5sYXp5KSB7CiAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjb21wb3NpdGlvbnN0YXJ0Jywgb25Db21wb3NpdGlvblN0YXJ0KTsKICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbXBvc2l0aW9uZW5kJywgb25Db21wb3NpdGlvbkVuZCk7CiAgICAgICAgICAvLyBTYWZhcmkgPCAxMC4yICYgVUlXZWJWaWV3IGRvZXNuJ3QgZmlyZSBjb21wb3NpdGlvbmVuZCB3aGVuCiAgICAgICAgICAvLyBzd2l0Y2hpbmcgZm9jdXMgYmVmb3JlIGNvbmZpcm1pbmcgY29tcG9zaXRpb24gY2hvaWNlCiAgICAgICAgICAvLyB0aGlzIGFsc28gZml4ZXMgdGhlIGlzc3VlIHdoZXJlIHNvbWUgYnJvd3NlcnMgZS5nLiBpT1MgQ2hyb21lCiAgICAgICAgICAvLyBmaXJlcyAiY2hhbmdlIiBpbnN0ZWFkIG9mICJpbnB1dCIgb24gYXV0b2NvbXBsZXRlLgogICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgb25Db21wb3NpdGlvbkVuZCk7CiAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICAgIGlmIChpc0lFOSkgewogICAgICAgICAgICBlbC52bW9kZWwgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBjb21wb25lbnRVcGRhdGVkOiBmdW5jdGlvbiBjb21wb25lbnRVcGRhdGVkIChlbCwgYmluZGluZywgdm5vZGUpIHsKICAgICAgaWYgKHZub2RlLnRhZyA9PT0gJ3NlbGVjdCcpIHsKICAgICAgICBzZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm5vZGUuY29udGV4dCk7CiAgICAgICAgLy8gaW4gY2FzZSB0aGUgb3B0aW9ucyByZW5kZXJlZCBieSB2LWZvciBoYXZlIGNoYW5nZWQsCiAgICAgICAgLy8gaXQncyBwb3NzaWJsZSB0aGF0IHRoZSB2YWx1ZSBpcyBvdXQtb2Ytc3luYyB3aXRoIHRoZSByZW5kZXJlZCBvcHRpb25zLgogICAgICAgIC8vIGRldGVjdCBzdWNoIGNhc2VzIGFuZCBmaWx0ZXIgb3V0IHZhbHVlcyB0aGF0IG5vIGxvbmdlciBoYXMgYSBtYXRjaGluZwogICAgICAgIC8vIG9wdGlvbiBpbiB0aGUgRE9NLgogICAgICAgIHZhciBwcmV2T3B0aW9ucyA9IGVsLl92T3B0aW9uczsKICAgICAgICB2YXIgY3VyT3B0aW9ucyA9IGVsLl92T3B0aW9ucyA9IFtdLm1hcC5jYWxsKGVsLm9wdGlvbnMsIGdldFZhbHVlKTsKICAgICAgICBpZiAoY3VyT3B0aW9ucy5zb21lKGZ1bmN0aW9uIChvLCBpKSB7IHJldHVybiAhbG9vc2VFcXVhbChvLCBwcmV2T3B0aW9uc1tpXSk7IH0pKSB7CiAgICAgICAgICAvLyB0cmlnZ2VyIGNoYW5nZSBldmVudCBpZgogICAgICAgICAgLy8gbm8gbWF0Y2hpbmcgb3B0aW9uIGZvdW5kIGZvciBhdCBsZWFzdCBvbmUgdmFsdWUKICAgICAgICAgIHZhciBuZWVkUmVzZXQgPSBlbC5tdWx0aXBsZQogICAgICAgICAgICA/IGJpbmRpbmcudmFsdWUuc29tZShmdW5jdGlvbiAodikgeyByZXR1cm4gaGFzTm9NYXRjaGluZ09wdGlvbih2LCBjdXJPcHRpb25zKTsgfSkKICAgICAgICAgICAgOiBiaW5kaW5nLnZhbHVlICE9PSBiaW5kaW5nLm9sZFZhbHVlICYmIGhhc05vTWF0Y2hpbmdPcHRpb24oYmluZGluZy52YWx1ZSwgY3VyT3B0aW9ucyk7CiAgICAgICAgICBpZiAobmVlZFJlc2V0KSB7CiAgICAgICAgICAgIHRyaWdnZXIoZWwsICdjaGFuZ2UnKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICBmdW5jdGlvbiBzZXRTZWxlY3RlZCAoZWwsIGJpbmRpbmcsIHZtKSB7CiAgICBhY3R1YWxseVNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bSk7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChpc0lFIHx8IGlzRWRnZSkgewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBhY3R1YWxseVNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bSk7CiAgICAgIH0sIDApOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYWN0dWFsbHlTZXRTZWxlY3RlZCAoZWwsIGJpbmRpbmcsIHZtKSB7CiAgICB2YXIgdmFsdWUgPSBiaW5kaW5nLnZhbHVlOwogICAgdmFyIGlzTXVsdGlwbGUgPSBlbC5tdWx0aXBsZTsKICAgIGlmIChpc011bHRpcGxlICYmICFBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICB3YXJuKAogICAgICAgICI8c2VsZWN0IG11bHRpcGxlIHYtbW9kZWw9XCIiICsgKGJpbmRpbmcuZXhwcmVzc2lvbikgKyAiXCI+ICIgKwogICAgICAgICJleHBlY3RzIGFuIEFycmF5IHZhbHVlIGZvciBpdHMgYmluZGluZywgYnV0IGdvdCAiICsgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkuc2xpY2UoOCwgLTEpKSwKICAgICAgICB2bQogICAgICApOwogICAgICByZXR1cm4KICAgIH0KICAgIHZhciBzZWxlY3RlZCwgb3B0aW9uOwogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBlbC5vcHRpb25zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBvcHRpb24gPSBlbC5vcHRpb25zW2ldOwogICAgICBpZiAoaXNNdWx0aXBsZSkgewogICAgICAgIHNlbGVjdGVkID0gbG9vc2VJbmRleE9mKHZhbHVlLCBnZXRWYWx1ZShvcHRpb24pKSA+IC0xOwogICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQgIT09IHNlbGVjdGVkKSB7CiAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBzZWxlY3RlZDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGxvb3NlRXF1YWwoZ2V0VmFsdWUob3B0aW9uKSwgdmFsdWUpKSB7CiAgICAgICAgICBpZiAoZWwuc2VsZWN0ZWRJbmRleCAhPT0gaSkgewogICAgICAgICAgICBlbC5zZWxlY3RlZEluZGV4ID0gaTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKCFpc011bHRpcGxlKSB7CiAgICAgIGVsLnNlbGVjdGVkSW5kZXggPSAtMTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGhhc05vTWF0Y2hpbmdPcHRpb24gKHZhbHVlLCBvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9ucy5ldmVyeShmdW5jdGlvbiAobykgeyByZXR1cm4gIWxvb3NlRXF1YWwobywgdmFsdWUpOyB9KQogIH0KCiAgZnVuY3Rpb24gZ2V0VmFsdWUgKG9wdGlvbikgewogICAgcmV0dXJuICdfdmFsdWUnIGluIG9wdGlvbgogICAgICA/IG9wdGlvbi5fdmFsdWUKICAgICAgOiBvcHRpb24udmFsdWUKICB9CgogIGZ1bmN0aW9uIG9uQ29tcG9zaXRpb25TdGFydCAoZSkgewogICAgZS50YXJnZXQuY29tcG9zaW5nID0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIG9uQ29tcG9zaXRpb25FbmQgKGUpIHsKICAgIC8vIHByZXZlbnQgdHJpZ2dlcmluZyBhbiBpbnB1dCBldmVudCBmb3Igbm8gcmVhc29uCiAgICBpZiAoIWUudGFyZ2V0LmNvbXBvc2luZykgeyByZXR1cm4gfQogICAgZS50YXJnZXQuY29tcG9zaW5nID0gZmFsc2U7CiAgICB0cmlnZ2VyKGUudGFyZ2V0LCAnaW5wdXQnKTsKICB9CgogIGZ1bmN0aW9uIHRyaWdnZXIgKGVsLCB0eXBlKSB7CiAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICBlLmluaXRFdmVudCh0eXBlLCB0cnVlLCB0cnVlKTsKICAgIGVsLmRpc3BhdGNoRXZlbnQoZSk7CiAgfQoKICAvKiAgKi8KCiAgLy8gcmVjdXJzaXZlbHkgc2VhcmNoIGZvciBwb3NzaWJsZSB0cmFuc2l0aW9uIGRlZmluZWQgaW5zaWRlIHRoZSBjb21wb25lbnQgcm9vdAogIGZ1bmN0aW9uIGxvY2F0ZU5vZGUgKHZub2RlKSB7CiAgICByZXR1cm4gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgJiYgKCF2bm9kZS5kYXRhIHx8ICF2bm9kZS5kYXRhLnRyYW5zaXRpb24pCiAgICAgID8gbG9jYXRlTm9kZSh2bm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGUpCiAgICAgIDogdm5vZGUKICB9CgogIHZhciBzaG93ID0gewogICAgYmluZDogZnVuY3Rpb24gYmluZCAoZWwsIHJlZiwgdm5vZGUpIHsKICAgICAgdmFyIHZhbHVlID0gcmVmLnZhbHVlOwoKICAgICAgdm5vZGUgPSBsb2NhdGVOb2RlKHZub2RlKTsKICAgICAgdmFyIHRyYW5zaXRpb24kJDEgPSB2bm9kZS5kYXRhICYmIHZub2RlLmRhdGEudHJhbnNpdGlvbjsKICAgICAgdmFyIG9yaWdpbmFsRGlzcGxheSA9IGVsLl9fdk9yaWdpbmFsRGlzcGxheSA9CiAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9PT0gJ25vbmUnID8gJycgOiBlbC5zdHlsZS5kaXNwbGF5OwogICAgICBpZiAodmFsdWUgJiYgdHJhbnNpdGlvbiQkMSkgewogICAgICAgIHZub2RlLmRhdGEuc2hvdyA9IHRydWU7CiAgICAgICAgZW50ZXIodm5vZGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBvcmlnaW5hbERpc3BsYXk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IHZhbHVlID8gb3JpZ2luYWxEaXNwbGF5IDogJ25vbmUnOwogICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlIChlbCwgcmVmLCB2bm9kZSkgewogICAgICB2YXIgdmFsdWUgPSByZWYudmFsdWU7CiAgICAgIHZhciBvbGRWYWx1ZSA9IHJlZi5vbGRWYWx1ZTsKCiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICBpZiAoIXZhbHVlID09PSAhb2xkVmFsdWUpIHsgcmV0dXJuIH0KICAgICAgdm5vZGUgPSBsb2NhdGVOb2RlKHZub2RlKTsKICAgICAgdmFyIHRyYW5zaXRpb24kJDEgPSB2bm9kZS5kYXRhICYmIHZub2RlLmRhdGEudHJhbnNpdGlvbjsKICAgICAgaWYgKHRyYW5zaXRpb24kJDEpIHsKICAgICAgICB2bm9kZS5kYXRhLnNob3cgPSB0cnVlOwogICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgZW50ZXIodm5vZGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IGVsLl9fdk9yaWdpbmFsRGlzcGxheTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsZWF2ZSh2bm9kZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSB2YWx1ZSA/IGVsLl9fdk9yaWdpbmFsRGlzcGxheSA6ICdub25lJzsKICAgICAgfQogICAgfSwKCiAgICB1bmJpbmQ6IGZ1bmN0aW9uIHVuYmluZCAoCiAgICAgIGVsLAogICAgICBiaW5kaW5nLAogICAgICB2bm9kZSwKICAgICAgb2xkVm5vZGUsCiAgICAgIGlzRGVzdHJveQogICAgKSB7CiAgICAgIGlmICghaXNEZXN0cm95KSB7CiAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IGVsLl9fdk9yaWdpbmFsRGlzcGxheTsKICAgICAgfQogICAgfQogIH07CgogIHZhciBwbGF0Zm9ybURpcmVjdGl2ZXMgPSB7CiAgICBtb2RlbDogZGlyZWN0aXZlLAogICAgc2hvdzogc2hvdwogIH07CgogIC8qICAqLwoKICB2YXIgdHJhbnNpdGlvblByb3BzID0gewogICAgbmFtZTogU3RyaW5nLAogICAgYXBwZWFyOiBCb29sZWFuLAogICAgY3NzOiBCb29sZWFuLAogICAgbW9kZTogU3RyaW5nLAogICAgdHlwZTogU3RyaW5nLAogICAgZW50ZXJDbGFzczogU3RyaW5nLAogICAgbGVhdmVDbGFzczogU3RyaW5nLAogICAgZW50ZXJUb0NsYXNzOiBTdHJpbmcsCiAgICBsZWF2ZVRvQ2xhc3M6IFN0cmluZywKICAgIGVudGVyQWN0aXZlQ2xhc3M6IFN0cmluZywKICAgIGxlYXZlQWN0aXZlQ2xhc3M6IFN0cmluZywKICAgIGFwcGVhckNsYXNzOiBTdHJpbmcsCiAgICBhcHBlYXJBY3RpdmVDbGFzczogU3RyaW5nLAogICAgYXBwZWFyVG9DbGFzczogU3RyaW5nLAogICAgZHVyYXRpb246IFtOdW1iZXIsIFN0cmluZywgT2JqZWN0XQogIH07CgogIC8vIGluIGNhc2UgdGhlIGNoaWxkIGlzIGFsc28gYW4gYWJzdHJhY3QgY29tcG9uZW50LCBlLmcuIDxrZWVwLWFsaXZlPgogIC8vIHdlIHdhbnQgdG8gcmVjdXJzaXZlbHkgcmV0cmlldmUgdGhlIHJlYWwgY29tcG9uZW50IHRvIGJlIHJlbmRlcmVkCiAgZnVuY3Rpb24gZ2V0UmVhbENoaWxkICh2bm9kZSkgewogICAgdmFyIGNvbXBPcHRpb25zID0gdm5vZGUgJiYgdm5vZGUuY29tcG9uZW50T3B0aW9uczsKICAgIGlmIChjb21wT3B0aW9ucyAmJiBjb21wT3B0aW9ucy5DdG9yLm9wdGlvbnMuYWJzdHJhY3QpIHsKICAgICAgcmV0dXJuIGdldFJlYWxDaGlsZChnZXRGaXJzdENvbXBvbmVudENoaWxkKGNvbXBPcHRpb25zLmNoaWxkcmVuKSkKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB2bm9kZQogICAgfQogIH0KCiAgZnVuY3Rpb24gZXh0cmFjdFRyYW5zaXRpb25EYXRhIChjb21wKSB7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgdmFyIG9wdGlvbnMgPSBjb21wLiRvcHRpb25zOwogICAgLy8gcHJvcHMKICAgIGZvciAodmFyIGtleSBpbiBvcHRpb25zLnByb3BzRGF0YSkgewogICAgICBkYXRhW2tleV0gPSBjb21wW2tleV07CiAgICB9CiAgICAvLyBldmVudHMuCiAgICAvLyBleHRyYWN0IGxpc3RlbmVycyBhbmQgcGFzcyB0aGVtIGRpcmVjdGx5IHRvIHRoZSB0cmFuc2l0aW9uIG1ldGhvZHMKICAgIHZhciBsaXN0ZW5lcnMgPSBvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnM7CiAgICBmb3IgKHZhciBrZXkkMSBpbiBsaXN0ZW5lcnMpIHsKICAgICAgZGF0YVtjYW1lbGl6ZShrZXkkMSldID0gbGlzdGVuZXJzW2tleSQxXTsKICAgIH0KICAgIHJldHVybiBkYXRhCiAgfQoKICBmdW5jdGlvbiBwbGFjZWhvbGRlciAoaCwgcmF3Q2hpbGQpIHsKICAgIGlmICgvXGQta2VlcC1hbGl2ZSQvLnRlc3QocmF3Q2hpbGQudGFnKSkgewogICAgICByZXR1cm4gaCgna2VlcC1hbGl2ZScsIHsKICAgICAgICBwcm9wczogcmF3Q2hpbGQuY29tcG9uZW50T3B0aW9ucy5wcm9wc0RhdGEKICAgICAgfSkKICAgIH0KICB9CgogIGZ1bmN0aW9uIGhhc1BhcmVudFRyYW5zaXRpb24gKHZub2RlKSB7CiAgICB3aGlsZSAoKHZub2RlID0gdm5vZGUucGFyZW50KSkgewogICAgICBpZiAodm5vZGUuZGF0YS50cmFuc2l0aW9uKSB7CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gaXNTYW1lQ2hpbGQgKGNoaWxkLCBvbGRDaGlsZCkgewogICAgcmV0dXJuIG9sZENoaWxkLmtleSA9PT0gY2hpbGQua2V5ICYmIG9sZENoaWxkLnRhZyA9PT0gY2hpbGQudGFnCiAgfQoKICB2YXIgaXNOb3RUZXh0Tm9kZSA9IGZ1bmN0aW9uIChjKSB7IHJldHVybiBjLnRhZyB8fCBpc0FzeW5jUGxhY2Vob2xkZXIoYyk7IH07CgogIHZhciBpc1ZTaG93RGlyZWN0aXZlID0gZnVuY3Rpb24gKGQpIHsgcmV0dXJuIGQubmFtZSA9PT0gJ3Nob3cnOyB9OwoKICB2YXIgVHJhbnNpdGlvbiA9IHsKICAgIG5hbWU6ICd0cmFuc2l0aW9uJywKICAgIHByb3BzOiB0cmFuc2l0aW9uUHJvcHMsCiAgICBhYnN0cmFjdDogdHJ1ZSwKCiAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlciAoaCkgewogICAgICB2YXIgdGhpcyQxID0gdGhpczsKCiAgICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuJHNsb3RzLmRlZmF1bHQ7CiAgICAgIGlmICghY2hpbGRyZW4pIHsKICAgICAgICByZXR1cm4KICAgICAgfQoKICAgICAgLy8gZmlsdGVyIG91dCB0ZXh0IG5vZGVzIChwb3NzaWJsZSB3aGl0ZXNwYWNlcykKICAgICAgY2hpbGRyZW4gPSBjaGlsZHJlbi5maWx0ZXIoaXNOb3RUZXh0Tm9kZSk7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICBpZiAoIWNoaWxkcmVuLmxlbmd0aCkgewogICAgICAgIHJldHVybgogICAgICB9CgogICAgICAvLyB3YXJuIG11bHRpcGxlIGVsZW1lbnRzCiAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPiAxKSB7CiAgICAgICAgd2FybigKICAgICAgICAgICc8dHJhbnNpdGlvbj4gY2FuIG9ubHkgYmUgdXNlZCBvbiBhIHNpbmdsZSBlbGVtZW50LiBVc2UgJyArCiAgICAgICAgICAnPHRyYW5zaXRpb24tZ3JvdXA+IGZvciBsaXN0cy4nLAogICAgICAgICAgdGhpcy4kcGFyZW50CiAgICAgICAgKTsKICAgICAgfQoKICAgICAgdmFyIG1vZGUgPSB0aGlzLm1vZGU7CgogICAgICAvLyB3YXJuIGludmFsaWQgbW9kZQogICAgICBpZiAobW9kZSAmJiBtb2RlICE9PSAnaW4tb3V0JyAmJiBtb2RlICE9PSAnb3V0LWluJwogICAgICApIHsKICAgICAgICB3YXJuKAogICAgICAgICAgJ2ludmFsaWQgPHRyYW5zaXRpb24+IG1vZGU6ICcgKyBtb2RlLAogICAgICAgICAgdGhpcy4kcGFyZW50CiAgICAgICAgKTsKICAgICAgfQoKICAgICAgdmFyIHJhd0NoaWxkID0gY2hpbGRyZW5bMF07CgogICAgICAvLyBpZiB0aGlzIGlzIGEgY29tcG9uZW50IHJvb3Qgbm9kZSBhbmQgdGhlIGNvbXBvbmVudCdzCiAgICAgIC8vIHBhcmVudCBjb250YWluZXIgbm9kZSBhbHNvIGhhcyB0cmFuc2l0aW9uLCBza2lwLgogICAgICBpZiAoaGFzUGFyZW50VHJhbnNpdGlvbih0aGlzLiR2bm9kZSkpIHsKICAgICAgICByZXR1cm4gcmF3Q2hpbGQKICAgICAgfQoKICAgICAgLy8gYXBwbHkgdHJhbnNpdGlvbiBkYXRhIHRvIGNoaWxkCiAgICAgIC8vIHVzZSBnZXRSZWFsQ2hpbGQoKSB0byBpZ25vcmUgYWJzdHJhY3QgY29tcG9uZW50cyBlLmcuIGtlZXAtYWxpdmUKICAgICAgdmFyIGNoaWxkID0gZ2V0UmVhbENoaWxkKHJhd0NoaWxkKTsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmICghY2hpbGQpIHsKICAgICAgICByZXR1cm4gcmF3Q2hpbGQKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX2xlYXZpbmcpIHsKICAgICAgICByZXR1cm4gcGxhY2Vob2xkZXIoaCwgcmF3Q2hpbGQpCiAgICAgIH0KCiAgICAgIC8vIGVuc3VyZSBhIGtleSB0aGF0IGlzIHVuaXF1ZSB0byB0aGUgdm5vZGUgdHlwZSBhbmQgdG8gdGhpcyB0cmFuc2l0aW9uCiAgICAgIC8vIGNvbXBvbmVudCBpbnN0YW5jZS4gVGhpcyBrZXkgd2lsbCBiZSB1c2VkIHRvIHJlbW92ZSBwZW5kaW5nIGxlYXZpbmcgbm9kZXMKICAgICAgLy8gZHVyaW5nIGVudGVyaW5nLgogICAgICB2YXIgaWQgPSAiX190cmFuc2l0aW9uLSIgKyAodGhpcy5fdWlkKSArICItIjsKICAgICAgY2hpbGQua2V5ID0gY2hpbGQua2V5ID09IG51bGwKICAgICAgICA/IGNoaWxkLmlzQ29tbWVudAogICAgICAgICAgPyBpZCArICdjb21tZW50JwogICAgICAgICAgOiBpZCArIGNoaWxkLnRhZwogICAgICAgIDogaXNQcmltaXRpdmUoY2hpbGQua2V5KQogICAgICAgICAgPyAoU3RyaW5nKGNoaWxkLmtleSkuaW5kZXhPZihpZCkgPT09IDAgPyBjaGlsZC5rZXkgOiBpZCArIGNoaWxkLmtleSkKICAgICAgICAgIDogY2hpbGQua2V5OwoKICAgICAgdmFyIGRhdGEgPSAoY2hpbGQuZGF0YSB8fCAoY2hpbGQuZGF0YSA9IHt9KSkudHJhbnNpdGlvbiA9IGV4dHJhY3RUcmFuc2l0aW9uRGF0YSh0aGlzKTsKICAgICAgdmFyIG9sZFJhd0NoaWxkID0gdGhpcy5fdm5vZGU7CiAgICAgIHZhciBvbGRDaGlsZCA9IGdldFJlYWxDaGlsZChvbGRSYXdDaGlsZCk7CgogICAgICAvLyBtYXJrIHYtc2hvdwogICAgICAvLyBzbyB0aGF0IHRoZSB0cmFuc2l0aW9uIG1vZHVsZSBjYW4gaGFuZCBvdmVyIHRoZSBjb250cm9sIHRvIHRoZSBkaXJlY3RpdmUKICAgICAgaWYgKGNoaWxkLmRhdGEuZGlyZWN0aXZlcyAmJiBjaGlsZC5kYXRhLmRpcmVjdGl2ZXMuc29tZShpc1ZTaG93RGlyZWN0aXZlKSkgewogICAgICAgIGNoaWxkLmRhdGEuc2hvdyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmICgKICAgICAgICBvbGRDaGlsZCAmJgogICAgICAgIG9sZENoaWxkLmRhdGEgJiYKICAgICAgICAhaXNTYW1lQ2hpbGQoY2hpbGQsIG9sZENoaWxkKSAmJgogICAgICAgICFpc0FzeW5jUGxhY2Vob2xkZXIob2xkQ2hpbGQpICYmCiAgICAgICAgLy8gIzY2ODcgY29tcG9uZW50IHJvb3QgaXMgYSBjb21tZW50IG5vZGUKICAgICAgICAhKG9sZENoaWxkLmNvbXBvbmVudEluc3RhbmNlICYmIG9sZENoaWxkLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZS5pc0NvbW1lbnQpCiAgICAgICkgewogICAgICAgIC8vIHJlcGxhY2Ugb2xkIGNoaWxkIHRyYW5zaXRpb24gZGF0YSB3aXRoIGZyZXNoIG9uZQogICAgICAgIC8vIGltcG9ydGFudCBmb3IgZHluYW1pYyB0cmFuc2l0aW9ucyEKICAgICAgICB2YXIgb2xkRGF0YSA9IG9sZENoaWxkLmRhdGEudHJhbnNpdGlvbiA9IGV4dGVuZCh7fSwgZGF0YSk7CiAgICAgICAgLy8gaGFuZGxlIHRyYW5zaXRpb24gbW9kZQogICAgICAgIGlmIChtb2RlID09PSAnb3V0LWluJykgewogICAgICAgICAgLy8gcmV0dXJuIHBsYWNlaG9sZGVyIG5vZGUgYW5kIHF1ZXVlIHVwZGF0ZSB3aGVuIGxlYXZlIGZpbmlzaGVzCiAgICAgICAgICB0aGlzLl9sZWF2aW5nID0gdHJ1ZTsKICAgICAgICAgIG1lcmdlVk5vZGVIb29rKG9sZERhdGEsICdhZnRlckxlYXZlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzJDEuX2xlYXZpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcyQxLiRmb3JjZVVwZGF0ZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gcGxhY2Vob2xkZXIoaCwgcmF3Q2hpbGQpCiAgICAgICAgfSBlbHNlIGlmIChtb2RlID09PSAnaW4tb3V0JykgewogICAgICAgICAgaWYgKGlzQXN5bmNQbGFjZWhvbGRlcihjaGlsZCkpIHsKICAgICAgICAgICAgcmV0dXJuIG9sZFJhd0NoaWxkCiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGVsYXllZExlYXZlOwogICAgICAgICAgdmFyIHBlcmZvcm1MZWF2ZSA9IGZ1bmN0aW9uICgpIHsgZGVsYXllZExlYXZlKCk7IH07CiAgICAgICAgICBtZXJnZVZOb2RlSG9vayhkYXRhLCAnYWZ0ZXJFbnRlcicsIHBlcmZvcm1MZWF2ZSk7CiAgICAgICAgICBtZXJnZVZOb2RlSG9vayhkYXRhLCAnZW50ZXJDYW5jZWxsZWQnLCBwZXJmb3JtTGVhdmUpOwogICAgICAgICAgbWVyZ2VWTm9kZUhvb2sob2xkRGF0YSwgJ2RlbGF5TGVhdmUnLCBmdW5jdGlvbiAobGVhdmUpIHsgZGVsYXllZExlYXZlID0gbGVhdmU7IH0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJhd0NoaWxkCiAgICB9CiAgfTsKCiAgLyogICovCgogIHZhciBwcm9wcyA9IGV4dGVuZCh7CiAgICB0YWc6IFN0cmluZywKICAgIG1vdmVDbGFzczogU3RyaW5nCiAgfSwgdHJhbnNpdGlvblByb3BzKTsKCiAgZGVsZXRlIHByb3BzLm1vZGU7CgogIHZhciBUcmFuc2l0aW9uR3JvdXAgPSB7CiAgICBwcm9wczogcHJvcHMsCgogICAgYmVmb3JlTW91bnQ6IGZ1bmN0aW9uIGJlZm9yZU1vdW50ICgpIHsKICAgICAgdmFyIHRoaXMkMSA9IHRoaXM7CgogICAgICB2YXIgdXBkYXRlID0gdGhpcy5fdXBkYXRlOwogICAgICB0aGlzLl91cGRhdGUgPSBmdW5jdGlvbiAodm5vZGUsIGh5ZHJhdGluZykgewogICAgICAgIHZhciByZXN0b3JlQWN0aXZlSW5zdGFuY2UgPSBzZXRBY3RpdmVJbnN0YW5jZSh0aGlzJDEpOwogICAgICAgIC8vIGZvcmNlIHJlbW92aW5nIHBhc3MKICAgICAgICB0aGlzJDEuX19wYXRjaF9fKAogICAgICAgICAgdGhpcyQxLl92bm9kZSwKICAgICAgICAgIHRoaXMkMS5rZXB0LAogICAgICAgICAgZmFsc2UsIC8vIGh5ZHJhdGluZwogICAgICAgICAgdHJ1ZSAvLyByZW1vdmVPbmx5ICghaW1wb3J0YW50LCBhdm9pZHMgdW5uZWNlc3NhcnkgbW92ZXMpCiAgICAgICAgKTsKICAgICAgICB0aGlzJDEuX3Zub2RlID0gdGhpcyQxLmtlcHQ7CiAgICAgICAgcmVzdG9yZUFjdGl2ZUluc3RhbmNlKCk7CiAgICAgICAgdXBkYXRlLmNhbGwodGhpcyQxLCB2bm9kZSwgaHlkcmF0aW5nKTsKICAgICAgfTsKICAgIH0sCgogICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIgKGgpIHsKICAgICAgdmFyIHRhZyA9IHRoaXMudGFnIHx8IHRoaXMuJHZub2RlLmRhdGEudGFnIHx8ICdzcGFuJzsKICAgICAgdmFyIG1hcCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHZhciBwcmV2Q2hpbGRyZW4gPSB0aGlzLnByZXZDaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW47CiAgICAgIHZhciByYXdDaGlsZHJlbiA9IHRoaXMuJHNsb3RzLmRlZmF1bHQgfHwgW107CiAgICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW4gPSBbXTsKICAgICAgdmFyIHRyYW5zaXRpb25EYXRhID0gZXh0cmFjdFRyYW5zaXRpb25EYXRhKHRoaXMpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByYXdDaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBjID0gcmF3Q2hpbGRyZW5baV07CiAgICAgICAgaWYgKGMudGFnKSB7CiAgICAgICAgICBpZiAoYy5rZXkgIT0gbnVsbCAmJiBTdHJpbmcoYy5rZXkpLmluZGV4T2YoJ19fdmxpc3QnKSAhPT0gMCkgewogICAgICAgICAgICBjaGlsZHJlbi5wdXNoKGMpOwogICAgICAgICAgICBtYXBbYy5rZXldID0gYwogICAgICAgICAgICA7KGMuZGF0YSB8fCAoYy5kYXRhID0ge30pKS50cmFuc2l0aW9uID0gdHJhbnNpdGlvbkRhdGE7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgb3B0cyA9IGMuY29tcG9uZW50T3B0aW9uczsKICAgICAgICAgICAgdmFyIG5hbWUgPSBvcHRzID8gKG9wdHMuQ3Rvci5vcHRpb25zLm5hbWUgfHwgb3B0cy50YWcgfHwgJycpIDogYy50YWc7CiAgICAgICAgICAgIHdhcm4oKCI8dHJhbnNpdGlvbi1ncm91cD4gY2hpbGRyZW4gbXVzdCBiZSBrZXllZDogPCIgKyBuYW1lICsgIj4iKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocHJldkNoaWxkcmVuKSB7CiAgICAgICAgdmFyIGtlcHQgPSBbXTsKICAgICAgICB2YXIgcmVtb3ZlZCA9IFtdOwogICAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IHByZXZDaGlsZHJlbi5sZW5ndGg7IGkkMSsrKSB7CiAgICAgICAgICB2YXIgYyQxID0gcHJldkNoaWxkcmVuW2kkMV07CiAgICAgICAgICBjJDEuZGF0YS50cmFuc2l0aW9uID0gdHJhbnNpdGlvbkRhdGE7CiAgICAgICAgICBjJDEuZGF0YS5wb3MgPSBjJDEuZWxtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgaWYgKG1hcFtjJDEua2V5XSkgewogICAgICAgICAgICBrZXB0LnB1c2goYyQxKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlbW92ZWQucHVzaChjJDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmtlcHQgPSBoKHRhZywgbnVsbCwga2VwdCk7CiAgICAgICAgdGhpcy5yZW1vdmVkID0gcmVtb3ZlZDsKICAgICAgfQoKICAgICAgcmV0dXJuIGgodGFnLCBudWxsLCBjaGlsZHJlbikKICAgIH0sCgogICAgdXBkYXRlZDogZnVuY3Rpb24gdXBkYXRlZCAoKSB7CiAgICAgIHZhciBjaGlsZHJlbiA9IHRoaXMucHJldkNoaWxkcmVuOwogICAgICB2YXIgbW92ZUNsYXNzID0gdGhpcy5tb3ZlQ2xhc3MgfHwgKCh0aGlzLm5hbWUgfHwgJ3YnKSArICctbW92ZScpOwogICAgICBpZiAoIWNoaWxkcmVuLmxlbmd0aCB8fCAhdGhpcy5oYXNNb3ZlKGNoaWxkcmVuWzBdLmVsbSwgbW92ZUNsYXNzKSkgewogICAgICAgIHJldHVybgogICAgICB9CgogICAgICAvLyB3ZSBkaXZpZGUgdGhlIHdvcmsgaW50byB0aHJlZSBsb29wcyB0byBhdm9pZCBtaXhpbmcgRE9NIHJlYWRzIGFuZCB3cml0ZXMKICAgICAgLy8gaW4gZWFjaCBpdGVyYXRpb24gLSB3aGljaCBoZWxwcyBwcmV2ZW50IGxheW91dCB0aHJhc2hpbmcuCiAgICAgIGNoaWxkcmVuLmZvckVhY2goY2FsbFBlbmRpbmdDYnMpOwogICAgICBjaGlsZHJlbi5mb3JFYWNoKHJlY29yZFBvc2l0aW9uKTsKICAgICAgY2hpbGRyZW4uZm9yRWFjaChhcHBseVRyYW5zbGF0aW9uKTsKCiAgICAgIC8vIGZvcmNlIHJlZmxvdyB0byBwdXQgZXZlcnl0aGluZyBpbiBwb3NpdGlvbgogICAgICAvLyBhc3NpZ24gdG8gdGhpcyB0byBhdm9pZCBiZWluZyByZW1vdmVkIGluIHRyZWUtc2hha2luZwogICAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgICAgdGhpcy5fcmVmbG93ID0gZG9jdW1lbnQuYm9keS5vZmZzZXRIZWlnaHQ7CgogICAgICBjaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uIChjKSB7CiAgICAgICAgaWYgKGMuZGF0YS5tb3ZlZCkgewogICAgICAgICAgdmFyIGVsID0gYy5lbG07CiAgICAgICAgICB2YXIgcyA9IGVsLnN0eWxlOwogICAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBtb3ZlQ2xhc3MpOwogICAgICAgICAgcy50cmFuc2Zvcm0gPSBzLldlYmtpdFRyYW5zZm9ybSA9IHMudHJhbnNpdGlvbkR1cmF0aW9uID0gJyc7CiAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKHRyYW5zaXRpb25FbmRFdmVudCwgZWwuX21vdmVDYiA9IGZ1bmN0aW9uIGNiIChlKSB7CiAgICAgICAgICAgIGlmIChlICYmIGUudGFyZ2V0ICE9PSBlbCkgewogICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghZSB8fCAvdHJhbnNmb3JtJC8udGVzdChlLnByb3BlcnR5TmFtZSkpIHsKICAgICAgICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKHRyYW5zaXRpb25FbmRFdmVudCwgY2IpOwogICAgICAgICAgICAgIGVsLl9tb3ZlQ2IgPSBudWxsOwogICAgICAgICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbW92ZUNsYXNzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgbWV0aG9kczogewogICAgICBoYXNNb3ZlOiBmdW5jdGlvbiBoYXNNb3ZlIChlbCwgbW92ZUNsYXNzKSB7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgaWYgKCFoYXNUcmFuc2l0aW9uKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgaWYgKHRoaXMuX2hhc01vdmUpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9oYXNNb3ZlCiAgICAgICAgfQogICAgICAgIC8vIERldGVjdCB3aGV0aGVyIGFuIGVsZW1lbnQgd2l0aCB0aGUgbW92ZSBjbGFzcyBhcHBsaWVkIGhhcwogICAgICAgIC8vIENTUyB0cmFuc2l0aW9ucy4gU2luY2UgdGhlIGVsZW1lbnQgbWF5IGJlIGluc2lkZSBhbiBlbnRlcmluZwogICAgICAgIC8vIHRyYW5zaXRpb24gYXQgdGhpcyB2ZXJ5IG1vbWVudCwgd2UgbWFrZSBhIGNsb25lIG9mIGl0IGFuZCByZW1vdmUKICAgICAgICAvLyBhbGwgb3RoZXIgdHJhbnNpdGlvbiBjbGFzc2VzIGFwcGxpZWQgdG8gZW5zdXJlIG9ubHkgdGhlIG1vdmUgY2xhc3MKICAgICAgICAvLyBpcyBhcHBsaWVkLgogICAgICAgIHZhciBjbG9uZSA9IGVsLmNsb25lTm9kZSgpOwogICAgICAgIGlmIChlbC5fdHJhbnNpdGlvbkNsYXNzZXMpIHsKICAgICAgICAgIGVsLl90cmFuc2l0aW9uQ2xhc3Nlcy5mb3JFYWNoKGZ1bmN0aW9uIChjbHMpIHsgcmVtb3ZlQ2xhc3MoY2xvbmUsIGNscyk7IH0pOwogICAgICAgIH0KICAgICAgICBhZGRDbGFzcyhjbG9uZSwgbW92ZUNsYXNzKTsKICAgICAgICBjbG9uZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIHRoaXMuJGVsLmFwcGVuZENoaWxkKGNsb25lKTsKICAgICAgICB2YXIgaW5mbyA9IGdldFRyYW5zaXRpb25JbmZvKGNsb25lKTsKICAgICAgICB0aGlzLiRlbC5yZW1vdmVDaGlsZChjbG9uZSk7CiAgICAgICAgcmV0dXJuICh0aGlzLl9oYXNNb3ZlID0gaW5mby5oYXNUcmFuc2Zvcm0pCiAgICAgIH0KICAgIH0KICB9OwoKICBmdW5jdGlvbiBjYWxsUGVuZGluZ0NicyAoYykgewogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoYy5lbG0uX21vdmVDYikgewogICAgICBjLmVsbS5fbW92ZUNiKCk7CiAgICB9CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChjLmVsbS5fZW50ZXJDYikgewogICAgICBjLmVsbS5fZW50ZXJDYigpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVjb3JkUG9zaXRpb24gKGMpIHsKICAgIGMuZGF0YS5uZXdQb3MgPSBjLmVsbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICB9CgogIGZ1bmN0aW9uIGFwcGx5VHJhbnNsYXRpb24gKGMpIHsKICAgIHZhciBvbGRQb3MgPSBjLmRhdGEucG9zOwogICAgdmFyIG5ld1BvcyA9IGMuZGF0YS5uZXdQb3M7CiAgICB2YXIgZHggPSBvbGRQb3MubGVmdCAtIG5ld1Bvcy5sZWZ0OwogICAgdmFyIGR5ID0gb2xkUG9zLnRvcCAtIG5ld1Bvcy50b3A7CiAgICBpZiAoZHggfHwgZHkpIHsKICAgICAgYy5kYXRhLm1vdmVkID0gdHJ1ZTsKICAgICAgdmFyIHMgPSBjLmVsbS5zdHlsZTsKICAgICAgcy50cmFuc2Zvcm0gPSBzLldlYmtpdFRyYW5zZm9ybSA9ICJ0cmFuc2xhdGUoIiArIGR4ICsgInB4LCIgKyBkeSArICJweCkiOwogICAgICBzLnRyYW5zaXRpb25EdXJhdGlvbiA9ICcwcyc7CiAgICB9CiAgfQoKICB2YXIgcGxhdGZvcm1Db21wb25lbnRzID0gewogICAgVHJhbnNpdGlvbjogVHJhbnNpdGlvbiwKICAgIFRyYW5zaXRpb25Hcm91cDogVHJhbnNpdGlvbkdyb3VwCiAgfTsKCiAgLyogICovCgogIC8vIGluc3RhbGwgcGxhdGZvcm0gc3BlY2lmaWMgdXRpbHMKICBWdWUuY29uZmlnLm11c3RVc2VQcm9wID0gbXVzdFVzZVByb3A7CiAgVnVlLmNvbmZpZy5pc1Jlc2VydmVkVGFnID0gaXNSZXNlcnZlZFRhZzsKICBWdWUuY29uZmlnLmlzUmVzZXJ2ZWRBdHRyID0gaXNSZXNlcnZlZEF0dHI7CiAgVnVlLmNvbmZpZy5nZXRUYWdOYW1lc3BhY2UgPSBnZXRUYWdOYW1lc3BhY2U7CiAgVnVlLmNvbmZpZy5pc1Vua25vd25FbGVtZW50ID0gaXNVbmtub3duRWxlbWVudDsKCiAgLy8gaW5zdGFsbCBwbGF0Zm9ybSBydW50aW1lIGRpcmVjdGl2ZXMgJiBjb21wb25lbnRzCiAgZXh0ZW5kKFZ1ZS5vcHRpb25zLmRpcmVjdGl2ZXMsIHBsYXRmb3JtRGlyZWN0aXZlcyk7CiAgZXh0ZW5kKFZ1ZS5vcHRpb25zLmNvbXBvbmVudHMsIHBsYXRmb3JtQ29tcG9uZW50cyk7CgogIC8vIGluc3RhbGwgcGxhdGZvcm0gcGF0Y2ggZnVuY3Rpb24KICBWdWUucHJvdG90eXBlLl9fcGF0Y2hfXyA9IGluQnJvd3NlciA/IHBhdGNoIDogbm9vcDsKCiAgLy8gcHVibGljIG1vdW50IG1ldGhvZAogIFZ1ZS5wcm90b3R5cGUuJG1vdW50ID0gZnVuY3Rpb24gKAogICAgZWwsCiAgICBoeWRyYXRpbmcKICApIHsKICAgIGVsID0gZWwgJiYgaW5Ccm93c2VyID8gcXVlcnkoZWwpIDogdW5kZWZpbmVkOwogICAgcmV0dXJuIG1vdW50Q29tcG9uZW50KHRoaXMsIGVsLCBoeWRyYXRpbmcpCiAgfTsKCiAgLy8gZGV2dG9vbHMgZ2xvYmFsIGhvb2sKICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogIGlmIChpbkJyb3dzZXIpIHsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBpZiAoY29uZmlnLmRldnRvb2xzKSB7CiAgICAgICAgaWYgKGRldnRvb2xzKSB7CiAgICAgICAgICBkZXZ0b29scy5lbWl0KCdpbml0JywgVnVlKTsKICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgaXNDaHJvbWUKICAgICAgICApIHsKICAgICAgICAgIGNvbnNvbGVbY29uc29sZS5pbmZvID8gJ2luZm8nIDogJ2xvZyddKAogICAgICAgICAgICAnRG93bmxvYWQgdGhlIFZ1ZSBEZXZ0b29scyBleHRlbnNpb24gZm9yIGEgYmV0dGVyIGRldmVsb3BtZW50IGV4cGVyaWVuY2U6XG4nICsKICAgICAgICAgICAgJ2h0dHBzOi8vZ2l0aHViLmNvbS92dWVqcy92dWUtZGV2dG9vbHMnCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY29uZmlnLnByb2R1Y3Rpb25UaXAgIT09IGZhbHNlICYmCiAgICAgICAgdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnCiAgICAgICkgewogICAgICAgIGNvbnNvbGVbY29uc29sZS5pbmZvID8gJ2luZm8nIDogJ2xvZyddKAogICAgICAgICAgIllvdSBhcmUgcnVubmluZyBWdWUgaW4gZGV2ZWxvcG1lbnQgbW9kZS5cbiIgKwogICAgICAgICAgIk1ha2Ugc3VyZSB0byB0dXJuIG9uIHByb2R1Y3Rpb24gbW9kZSB3aGVuIGRlcGxveWluZyBmb3IgcHJvZHVjdGlvbi5cbiIgKwogICAgICAgICAgIlNlZSBtb3JlIHRpcHMgYXQgaHR0cHM6Ly92dWVqcy5vcmcvZ3VpZGUvZGVwbG95bWVudC5odG1sIgogICAgICAgICk7CiAgICAgIH0KICAgIH0sIDApOwogIH0KCiAgLyogICovCgogIHZhciBkZWZhdWx0VGFnUkUgPSAvXHtceygoPzoufFxyP1xuKSs/KVx9XH0vZzsKICB2YXIgcmVnZXhFc2NhcGVSRSA9IC9bLS4qKz9eJHt9KCl8W1xdXC9cXF0vZzsKCiAgdmFyIGJ1aWxkUmVnZXggPSBjYWNoZWQoZnVuY3Rpb24gKGRlbGltaXRlcnMpIHsKICAgIHZhciBvcGVuID0gZGVsaW1pdGVyc1swXS5yZXBsYWNlKHJlZ2V4RXNjYXBlUkUsICdcXCQmJyk7CiAgICB2YXIgY2xvc2UgPSBkZWxpbWl0ZXJzWzFdLnJlcGxhY2UocmVnZXhFc2NhcGVSRSwgJ1xcJCYnKTsKICAgIHJldHVybiBuZXcgUmVnRXhwKG9wZW4gKyAnKCg/Oi58XFxuKSs/KScgKyBjbG9zZSwgJ2cnKQogIH0pOwoKCgogIGZ1bmN0aW9uIHBhcnNlVGV4dCAoCiAgICB0ZXh0LAogICAgZGVsaW1pdGVycwogICkgewogICAgdmFyIHRhZ1JFID0gZGVsaW1pdGVycyA/IGJ1aWxkUmVnZXgoZGVsaW1pdGVycykgOiBkZWZhdWx0VGFnUkU7CiAgICBpZiAoIXRhZ1JFLnRlc3QodGV4dCkpIHsKICAgICAgcmV0dXJuCiAgICB9CiAgICB2YXIgdG9rZW5zID0gW107CiAgICB2YXIgcmF3VG9rZW5zID0gW107CiAgICB2YXIgbGFzdEluZGV4ID0gdGFnUkUubGFzdEluZGV4ID0gMDsKICAgIHZhciBtYXRjaCwgaW5kZXgsIHRva2VuVmFsdWU7CiAgICB3aGlsZSAoKG1hdGNoID0gdGFnUkUuZXhlYyh0ZXh0KSkpIHsKICAgICAgaW5kZXggPSBtYXRjaC5pbmRleDsKICAgICAgLy8gcHVzaCB0ZXh0IHRva2VuCiAgICAgIGlmIChpbmRleCA+IGxhc3RJbmRleCkgewogICAgICAgIHJhd1Rva2Vucy5wdXNoKHRva2VuVmFsdWUgPSB0ZXh0LnNsaWNlKGxhc3RJbmRleCwgaW5kZXgpKTsKICAgICAgICB0b2tlbnMucHVzaChKU09OLnN0cmluZ2lmeSh0b2tlblZhbHVlKSk7CiAgICAgIH0KICAgICAgLy8gdGFnIHRva2VuCiAgICAgIHZhciBleHAgPSBwYXJzZUZpbHRlcnMobWF0Y2hbMV0udHJpbSgpKTsKICAgICAgdG9rZW5zLnB1c2goKCJfcygiICsgZXhwICsgIikiKSk7CiAgICAgIHJhd1Rva2Vucy5wdXNoKHsgJ0BiaW5kaW5nJzogZXhwIH0pOwogICAgICBsYXN0SW5kZXggPSBpbmRleCArIG1hdGNoWzBdLmxlbmd0aDsKICAgIH0KICAgIGlmIChsYXN0SW5kZXggPCB0ZXh0Lmxlbmd0aCkgewogICAgICByYXdUb2tlbnMucHVzaCh0b2tlblZhbHVlID0gdGV4dC5zbGljZShsYXN0SW5kZXgpKTsKICAgICAgdG9rZW5zLnB1c2goSlNPTi5zdHJpbmdpZnkodG9rZW5WYWx1ZSkpOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgZXhwcmVzc2lvbjogdG9rZW5zLmpvaW4oJysnKSwKICAgICAgdG9rZW5zOiByYXdUb2tlbnMKICAgIH0KICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiB0cmFuc2Zvcm1Ob2RlIChlbCwgb3B0aW9ucykgewogICAgdmFyIHdhcm4gPSBvcHRpb25zLndhcm4gfHwgYmFzZVdhcm47CiAgICB2YXIgc3RhdGljQ2xhc3MgPSBnZXRBbmRSZW1vdmVBdHRyKGVsLCAnY2xhc3MnKTsKICAgIGlmIChzdGF0aWNDbGFzcykgewogICAgICB2YXIgcmVzID0gcGFyc2VUZXh0KHN0YXRpY0NsYXNzLCBvcHRpb25zLmRlbGltaXRlcnMpOwogICAgICBpZiAocmVzKSB7CiAgICAgICAgd2FybigKICAgICAgICAgICJjbGFzcz1cIiIgKyBzdGF0aWNDbGFzcyArICJcIjogIiArCiAgICAgICAgICAnSW50ZXJwb2xhdGlvbiBpbnNpZGUgYXR0cmlidXRlcyBoYXMgYmVlbiByZW1vdmVkLiAnICsKICAgICAgICAgICdVc2Ugdi1iaW5kIG9yIHRoZSBjb2xvbiBzaG9ydGhhbmQgaW5zdGVhZC4gRm9yIGV4YW1wbGUsICcgKwogICAgICAgICAgJ2luc3RlYWQgb2YgPGRpdiBjbGFzcz0ie3sgdmFsIH19Ij4sIHVzZSA8ZGl2IDpjbGFzcz0idmFsIj4uJwogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGlmIChzdGF0aWNDbGFzcykgewogICAgICBlbC5zdGF0aWNDbGFzcyA9IEpTT04uc3RyaW5naWZ5KHN0YXRpY0NsYXNzKTsKICAgIH0KICAgIHZhciBjbGFzc0JpbmRpbmcgPSBnZXRCaW5kaW5nQXR0cihlbCwgJ2NsYXNzJywgZmFsc2UgLyogZ2V0U3RhdGljICovKTsKICAgIGlmIChjbGFzc0JpbmRpbmcpIHsKICAgICAgZWwuY2xhc3NCaW5kaW5nID0gY2xhc3NCaW5kaW5nOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2VuRGF0YSAoZWwpIHsKICAgIHZhciBkYXRhID0gJyc7CiAgICBpZiAoZWwuc3RhdGljQ2xhc3MpIHsKICAgICAgZGF0YSArPSAic3RhdGljQ2xhc3M6IiArIChlbC5zdGF0aWNDbGFzcykgKyAiLCI7CiAgICB9CiAgICBpZiAoZWwuY2xhc3NCaW5kaW5nKSB7CiAgICAgIGRhdGEgKz0gImNsYXNzOiIgKyAoZWwuY2xhc3NCaW5kaW5nKSArICIsIjsKICAgIH0KICAgIHJldHVybiBkYXRhCiAgfQoKICB2YXIga2xhc3MkMSA9IHsKICAgIHN0YXRpY0tleXM6IFsnc3RhdGljQ2xhc3MnXSwKICAgIHRyYW5zZm9ybU5vZGU6IHRyYW5zZm9ybU5vZGUsCiAgICBnZW5EYXRhOiBnZW5EYXRhCiAgfTsKCiAgLyogICovCgogIGZ1bmN0aW9uIHRyYW5zZm9ybU5vZGUkMSAoZWwsIG9wdGlvbnMpIHsKICAgIHZhciB3YXJuID0gb3B0aW9ucy53YXJuIHx8IGJhc2VXYXJuOwogICAgdmFyIHN0YXRpY1N0eWxlID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3N0eWxlJyk7CiAgICBpZiAoc3RhdGljU3R5bGUpIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIHsKICAgICAgICB2YXIgcmVzID0gcGFyc2VUZXh0KHN0YXRpY1N0eWxlLCBvcHRpb25zLmRlbGltaXRlcnMpOwogICAgICAgIGlmIChyZXMpIHsKICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgICJzdHlsZT1cIiIgKyBzdGF0aWNTdHlsZSArICJcIjogIiArCiAgICAgICAgICAgICdJbnRlcnBvbGF0aW9uIGluc2lkZSBhdHRyaWJ1dGVzIGhhcyBiZWVuIHJlbW92ZWQuICcgKwogICAgICAgICAgICAnVXNlIHYtYmluZCBvciB0aGUgY29sb24gc2hvcnRoYW5kIGluc3RlYWQuIEZvciBleGFtcGxlLCAnICsKICAgICAgICAgICAgJ2luc3RlYWQgb2YgPGRpdiBzdHlsZT0ie3sgdmFsIH19Ij4sIHVzZSA8ZGl2IDpzdHlsZT0idmFsIj4uJwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZWwuc3RhdGljU3R5bGUgPSBKU09OLnN0cmluZ2lmeShwYXJzZVN0eWxlVGV4dChzdGF0aWNTdHlsZSkpOwogICAgfQoKICAgIHZhciBzdHlsZUJpbmRpbmcgPSBnZXRCaW5kaW5nQXR0cihlbCwgJ3N0eWxlJywgZmFsc2UgLyogZ2V0U3RhdGljICovKTsKICAgIGlmIChzdHlsZUJpbmRpbmcpIHsKICAgICAgZWwuc3R5bGVCaW5kaW5nID0gc3R5bGVCaW5kaW5nOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2VuRGF0YSQxIChlbCkgewogICAgdmFyIGRhdGEgPSAnJzsKICAgIGlmIChlbC5zdGF0aWNTdHlsZSkgewogICAgICBkYXRhICs9ICJzdGF0aWNTdHlsZToiICsgKGVsLnN0YXRpY1N0eWxlKSArICIsIjsKICAgIH0KICAgIGlmIChlbC5zdHlsZUJpbmRpbmcpIHsKICAgICAgZGF0YSArPSAic3R5bGU6KCIgKyAoZWwuc3R5bGVCaW5kaW5nKSArICIpLCI7CiAgICB9CiAgICByZXR1cm4gZGF0YQogIH0KCiAgdmFyIHN0eWxlJDEgPSB7CiAgICBzdGF0aWNLZXlzOiBbJ3N0YXRpY1N0eWxlJ10sCiAgICB0cmFuc2Zvcm1Ob2RlOiB0cmFuc2Zvcm1Ob2RlJDEsCiAgICBnZW5EYXRhOiBnZW5EYXRhJDEKICB9OwoKICAvKiAgKi8KCiAgdmFyIGRlY29kZXI7CgogIHZhciBoZSA9IHsKICAgIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlIChodG1sKSB7CiAgICAgIGRlY29kZXIgPSBkZWNvZGVyIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBkZWNvZGVyLmlubmVySFRNTCA9IGh0bWw7CiAgICAgIHJldHVybiBkZWNvZGVyLnRleHRDb250ZW50CiAgICB9CiAgfTsKCiAgLyogICovCgogIHZhciBpc1VuYXJ5VGFnID0gbWFrZU1hcCgKICAgICdhcmVhLGJhc2UsYnIsY29sLGVtYmVkLGZyYW1lLGhyLGltZyxpbnB1dCxpc2luZGV4LGtleWdlbiwnICsKICAgICdsaW5rLG1ldGEscGFyYW0sc291cmNlLHRyYWNrLHdicicKICApOwoKICAvLyBFbGVtZW50cyB0aGF0IHlvdSBjYW4sIGludGVudGlvbmFsbHksIGxlYXZlIG9wZW4KICAvLyAoYW5kIHdoaWNoIGNsb3NlIHRoZW1zZWx2ZXMpCiAgdmFyIGNhbkJlTGVmdE9wZW5UYWcgPSBtYWtlTWFwKAogICAgJ2NvbGdyb3VwLGRkLGR0LGxpLG9wdGlvbnMscCx0ZCx0Zm9vdCx0aCx0aGVhZCx0cixzb3VyY2UnCiAgKTsKCiAgLy8gSFRNTDUgdGFncyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9pbmRpY2VzLmh0bWwjZWxlbWVudHMtMwogIC8vIFBocmFzaW5nIENvbnRlbnQgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvZG9tLmh0bWwjcGhyYXNpbmctY29udGVudAogIHZhciBpc05vblBocmFzaW5nVGFnID0gbWFrZU1hcCgKICAgICdhZGRyZXNzLGFydGljbGUsYXNpZGUsYmFzZSxibG9ja3F1b3RlLGJvZHksY2FwdGlvbixjb2wsY29sZ3JvdXAsZGQsJyArCiAgICAnZGV0YWlscyxkaWFsb2csZGl2LGRsLGR0LGZpZWxkc2V0LGZpZ2NhcHRpb24sZmlndXJlLGZvb3Rlcixmb3JtLCcgKwogICAgJ2gxLGgyLGgzLGg0LGg1LGg2LGhlYWQsaGVhZGVyLGhncm91cCxocixodG1sLGxlZ2VuZCxsaSxtZW51aXRlbSxtZXRhLCcgKwogICAgJ29wdGdyb3VwLG9wdGlvbixwYXJhbSxycCxydCxzb3VyY2Usc3R5bGUsc3VtbWFyeSx0Ym9keSx0ZCx0Zm9vdCx0aCx0aGVhZCwnICsKICAgICd0aXRsZSx0cix0cmFjaycKICApOwoKICAvKioKICAgKiBOb3QgdHlwZS1jaGVja2luZyB0aGlzIGZpbGUgYmVjYXVzZSBpdCdzIG1vc3RseSB2ZW5kb3IgY29kZS4KICAgKi8KCiAgLy8gUmVndWxhciBFeHByZXNzaW9ucyBmb3IgcGFyc2luZyB0YWdzIGFuZCBhdHRyaWJ1dGVzCiAgdmFyIGF0dHJpYnV0ZSA9IC9eXHMqKFteXHMiJzw+XC89XSspKD86XHMqKD0pXHMqKD86IihbXiJdKikiK3wnKFteJ10qKScrfChbXlxzIic9PD5gXSspKSk/LzsKICAvLyBjb3VsZCB1c2UgaHR0cHM6Ly93d3cudzMub3JnL1RSLzE5OTkvUkVDLXhtbC1uYW1lcy0xOTk5MDExNC8jTlQtUU5hbWUKICAvLyBidXQgZm9yIFZ1ZSB0ZW1wbGF0ZXMgd2UgY2FuIGVuZm9yY2UgYSBzaW1wbGUgY2hhcnNldAogIHZhciBuY25hbWUgPSAnW2EtekEtWl9dW1xcd1xcLVxcLl0qJzsKICB2YXIgcW5hbWVDYXB0dXJlID0gIigoPzoiICsgbmNuYW1lICsgIlxcOik/IiArIG5jbmFtZSArICIpIjsKICB2YXIgc3RhcnRUYWdPcGVuID0gbmV3IFJlZ0V4cCgoIl48IiArIHFuYW1lQ2FwdHVyZSkpOwogIHZhciBzdGFydFRhZ0Nsb3NlID0gL15ccyooXC8/KT4vOwogIHZhciBlbmRUYWcgPSBuZXcgUmVnRXhwKCgiXjxcXC8iICsgcW5hbWVDYXB0dXJlICsgIltePl0qPiIpKTsKICB2YXIgZG9jdHlwZSA9IC9ePCFET0NUWVBFIFtePl0rPi9pOwogIC8vICM3Mjk4OiBlc2NhcGUgLSB0byBhdm9pZCBiZWluZyBwYXNlZCBhcyBIVE1MIGNvbW1lbnQgd2hlbiBpbmxpbmVkIGluIHBhZ2UKICB2YXIgY29tbWVudCA9IC9ePCFcLS0vOwogIHZhciBjb25kaXRpb25hbENvbW1lbnQgPSAvXjwhXFsvOwoKICAvLyBTcGVjaWFsIEVsZW1lbnRzIChjYW4gY29udGFpbiBhbnl0aGluZykKICB2YXIgaXNQbGFpblRleHRFbGVtZW50ID0gbWFrZU1hcCgnc2NyaXB0LHN0eWxlLHRleHRhcmVhJywgdHJ1ZSk7CiAgdmFyIHJlQ2FjaGUgPSB7fTsKCiAgdmFyIGRlY29kaW5nTWFwID0gewogICAgJyZsdDsnOiAnPCcsCiAgICAnJmd0Oyc6ICc+JywKICAgICcmcXVvdDsnOiAnIicsCiAgICAnJmFtcDsnOiAnJicsCiAgICAnJiMxMDsnOiAnXG4nLAogICAgJyYjOTsnOiAnXHQnCiAgfTsKICB2YXIgZW5jb2RlZEF0dHIgPSAvJig/Omx0fGd0fHF1b3R8YW1wKTsvZzsKICB2YXIgZW5jb2RlZEF0dHJXaXRoTmV3TGluZXMgPSAvJig/Omx0fGd0fHF1b3R8YW1wfCMxMHwjOSk7L2c7CgogIC8vICM1OTkyCiAgdmFyIGlzSWdub3JlTmV3bGluZVRhZyA9IG1ha2VNYXAoJ3ByZSx0ZXh0YXJlYScsIHRydWUpOwogIHZhciBzaG91bGRJZ25vcmVGaXJzdE5ld2xpbmUgPSBmdW5jdGlvbiAodGFnLCBodG1sKSB7IHJldHVybiB0YWcgJiYgaXNJZ25vcmVOZXdsaW5lVGFnKHRhZykgJiYgaHRtbFswXSA9PT0gJ1xuJzsgfTsKCiAgZnVuY3Rpb24gZGVjb2RlQXR0ciAodmFsdWUsIHNob3VsZERlY29kZU5ld2xpbmVzKSB7CiAgICB2YXIgcmUgPSBzaG91bGREZWNvZGVOZXdsaW5lcyA/IGVuY29kZWRBdHRyV2l0aE5ld0xpbmVzIDogZW5jb2RlZEF0dHI7CiAgICByZXR1cm4gdmFsdWUucmVwbGFjZShyZSwgZnVuY3Rpb24gKG1hdGNoKSB7IHJldHVybiBkZWNvZGluZ01hcFttYXRjaF07IH0pCiAgfQoKICBmdW5jdGlvbiBwYXJzZUhUTUwgKGh0bWwsIG9wdGlvbnMpIHsKICAgIHZhciBzdGFjayA9IFtdOwogICAgdmFyIGV4cGVjdEhUTUwgPSBvcHRpb25zLmV4cGVjdEhUTUw7CiAgICB2YXIgaXNVbmFyeVRhZyQkMSA9IG9wdGlvbnMuaXNVbmFyeVRhZyB8fCBubzsKICAgIHZhciBjYW5CZUxlZnRPcGVuVGFnJCQxID0gb3B0aW9ucy5jYW5CZUxlZnRPcGVuVGFnIHx8IG5vOwogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBsYXN0LCBsYXN0VGFnOwogICAgd2hpbGUgKGh0bWwpIHsKICAgICAgbGFzdCA9IGh0bWw7CiAgICAgIC8vIE1ha2Ugc3VyZSB3ZSdyZSBub3QgaW4gYSBwbGFpbnRleHQgY29udGVudCBlbGVtZW50IGxpa2Ugc2NyaXB0L3N0eWxlCiAgICAgIGlmICghbGFzdFRhZyB8fCAhaXNQbGFpblRleHRFbGVtZW50KGxhc3RUYWcpKSB7CiAgICAgICAgdmFyIHRleHRFbmQgPSBodG1sLmluZGV4T2YoJzwnKTsKICAgICAgICBpZiAodGV4dEVuZCA9PT0gMCkgewogICAgICAgICAgLy8gQ29tbWVudDoKICAgICAgICAgIGlmIChjb21tZW50LnRlc3QoaHRtbCkpIHsKICAgICAgICAgICAgdmFyIGNvbW1lbnRFbmQgPSBodG1sLmluZGV4T2YoJy0tPicpOwoKICAgICAgICAgICAgaWYgKGNvbW1lbnRFbmQgPj0gMCkgewogICAgICAgICAgICAgIGlmIChvcHRpb25zLnNob3VsZEtlZXBDb21tZW50KSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLmNvbW1lbnQoaHRtbC5zdWJzdHJpbmcoNCwgY29tbWVudEVuZCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhZHZhbmNlKGNvbW1lbnRFbmQgKyAzKTsKICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Db25kaXRpb25hbF9jb21tZW50I0Rvd25sZXZlbC1yZXZlYWxlZF9jb25kaXRpb25hbF9jb21tZW50CiAgICAgICAgICBpZiAoY29uZGl0aW9uYWxDb21tZW50LnRlc3QoaHRtbCkpIHsKICAgICAgICAgICAgdmFyIGNvbmRpdGlvbmFsRW5kID0gaHRtbC5pbmRleE9mKCddPicpOwoKICAgICAgICAgICAgaWYgKGNvbmRpdGlvbmFsRW5kID49IDApIHsKICAgICAgICAgICAgICBhZHZhbmNlKGNvbmRpdGlvbmFsRW5kICsgMik7CiAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIERvY3R5cGU6CiAgICAgICAgICB2YXIgZG9jdHlwZU1hdGNoID0gaHRtbC5tYXRjaChkb2N0eXBlKTsKICAgICAgICAgIGlmIChkb2N0eXBlTWF0Y2gpIHsKICAgICAgICAgICAgYWR2YW5jZShkb2N0eXBlTWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBFbmQgdGFnOgogICAgICAgICAgdmFyIGVuZFRhZ01hdGNoID0gaHRtbC5tYXRjaChlbmRUYWcpOwogICAgICAgICAgaWYgKGVuZFRhZ01hdGNoKSB7CiAgICAgICAgICAgIHZhciBjdXJJbmRleCA9IGluZGV4OwogICAgICAgICAgICBhZHZhbmNlKGVuZFRhZ01hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgIHBhcnNlRW5kVGFnKGVuZFRhZ01hdGNoWzFdLCBjdXJJbmRleCwgaW5kZXgpOwogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgfQoKICAgICAgICAgIC8vIFN0YXJ0IHRhZzoKICAgICAgICAgIHZhciBzdGFydFRhZ01hdGNoID0gcGFyc2VTdGFydFRhZygpOwogICAgICAgICAgaWYgKHN0YXJ0VGFnTWF0Y2gpIHsKICAgICAgICAgICAgaGFuZGxlU3RhcnRUYWcoc3RhcnRUYWdNYXRjaCk7CiAgICAgICAgICAgIGlmIChzaG91bGRJZ25vcmVGaXJzdE5ld2xpbmUoc3RhcnRUYWdNYXRjaC50YWdOYW1lLCBodG1sKSkgewogICAgICAgICAgICAgIGFkdmFuY2UoMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciB0ZXh0ID0gKHZvaWQgMCksIHJlc3QgPSAodm9pZCAwKSwgbmV4dCA9ICh2b2lkIDApOwogICAgICAgIGlmICh0ZXh0RW5kID49IDApIHsKICAgICAgICAgIHJlc3QgPSBodG1sLnNsaWNlKHRleHRFbmQpOwogICAgICAgICAgd2hpbGUgKAogICAgICAgICAgICAhZW5kVGFnLnRlc3QocmVzdCkgJiYKICAgICAgICAgICAgIXN0YXJ0VGFnT3Blbi50ZXN0KHJlc3QpICYmCiAgICAgICAgICAgICFjb21tZW50LnRlc3QocmVzdCkgJiYKICAgICAgICAgICAgIWNvbmRpdGlvbmFsQ29tbWVudC50ZXN0KHJlc3QpCiAgICAgICAgICApIHsKICAgICAgICAgICAgLy8gPCBpbiBwbGFpbiB0ZXh0LCBiZSBmb3JnaXZpbmcgYW5kIHRyZWF0IGl0IGFzIHRleHQKICAgICAgICAgICAgbmV4dCA9IHJlc3QuaW5kZXhPZignPCcsIDEpOwogICAgICAgICAgICBpZiAobmV4dCA8IDApIHsgYnJlYWsgfQogICAgICAgICAgICB0ZXh0RW5kICs9IG5leHQ7CiAgICAgICAgICAgIHJlc3QgPSBodG1sLnNsaWNlKHRleHRFbmQpOwogICAgICAgICAgfQogICAgICAgICAgdGV4dCA9IGh0bWwuc3Vic3RyaW5nKDAsIHRleHRFbmQpOwogICAgICAgICAgYWR2YW5jZSh0ZXh0RW5kKTsKICAgICAgICB9CgogICAgICAgIGlmICh0ZXh0RW5kIDwgMCkgewogICAgICAgICAgdGV4dCA9IGh0bWw7CiAgICAgICAgICBodG1sID0gJyc7CiAgICAgICAgfQoKICAgICAgICBpZiAob3B0aW9ucy5jaGFycyAmJiB0ZXh0KSB7CiAgICAgICAgICBvcHRpb25zLmNoYXJzKHRleHQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZW5kVGFnTGVuZ3RoID0gMDsKICAgICAgICB2YXIgc3RhY2tlZFRhZyA9IGxhc3RUYWcudG9Mb3dlckNhc2UoKTsKICAgICAgICB2YXIgcmVTdGFja2VkVGFnID0gcmVDYWNoZVtzdGFja2VkVGFnXSB8fCAocmVDYWNoZVtzdGFja2VkVGFnXSA9IG5ldyBSZWdFeHAoJyhbXFxzXFxTXSo/KSg8LycgKyBzdGFja2VkVGFnICsgJ1tePl0qPiknLCAnaScpKTsKICAgICAgICB2YXIgcmVzdCQxID0gaHRtbC5yZXBsYWNlKHJlU3RhY2tlZFRhZywgZnVuY3Rpb24gKGFsbCwgdGV4dCwgZW5kVGFnKSB7CiAgICAgICAgICBlbmRUYWdMZW5ndGggPSBlbmRUYWcubGVuZ3RoOwogICAgICAgICAgaWYgKCFpc1BsYWluVGV4dEVsZW1lbnQoc3RhY2tlZFRhZykgJiYgc3RhY2tlZFRhZyAhPT0gJ25vc2NyaXB0JykgewogICAgICAgICAgICB0ZXh0ID0gdGV4dAogICAgICAgICAgICAgIC5yZXBsYWNlKC88IVwtLShbXHNcU10qPyktLT4vZywgJyQxJykgLy8gIzcyOTgKICAgICAgICAgICAgICAucmVwbGFjZSgvPCFcW0NEQVRBXFsoW1xzXFNdKj8pXV0+L2csICckMScpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNob3VsZElnbm9yZUZpcnN0TmV3bGluZShzdGFja2VkVGFnLCB0ZXh0KSkgewogICAgICAgICAgICB0ZXh0ID0gdGV4dC5zbGljZSgxKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvcHRpb25zLmNoYXJzKSB7CiAgICAgICAgICAgIG9wdGlvbnMuY2hhcnModGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gJycKICAgICAgICB9KTsKICAgICAgICBpbmRleCArPSBodG1sLmxlbmd0aCAtIHJlc3QkMS5sZW5ndGg7CiAgICAgICAgaHRtbCA9IHJlc3QkMTsKICAgICAgICBwYXJzZUVuZFRhZyhzdGFja2VkVGFnLCBpbmRleCAtIGVuZFRhZ0xlbmd0aCwgaW5kZXgpOwogICAgICB9CgogICAgICBpZiAoaHRtbCA9PT0gbGFzdCkgewogICAgICAgIG9wdGlvbnMuY2hhcnMgJiYgb3B0aW9ucy5jaGFycyhodG1sKTsKICAgICAgICBpZiAoIXN0YWNrLmxlbmd0aCAmJiBvcHRpb25zLndhcm4pIHsKICAgICAgICAgIG9wdGlvbnMud2FybigoIk1hbC1mb3JtYXR0ZWQgdGFnIGF0IGVuZCBvZiB0ZW1wbGF0ZTogXCIiICsgaHRtbCArICJcIiIpKTsKICAgICAgICB9CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQoKICAgIC8vIENsZWFuIHVwIGFueSByZW1haW5pbmcgdGFncwogICAgcGFyc2VFbmRUYWcoKTsKCiAgICBmdW5jdGlvbiBhZHZhbmNlIChuKSB7CiAgICAgIGluZGV4ICs9IG47CiAgICAgIGh0bWwgPSBodG1sLnN1YnN0cmluZyhuKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZVN0YXJ0VGFnICgpIHsKICAgICAgdmFyIHN0YXJ0ID0gaHRtbC5tYXRjaChzdGFydFRhZ09wZW4pOwogICAgICBpZiAoc3RhcnQpIHsKICAgICAgICB2YXIgbWF0Y2ggPSB7CiAgICAgICAgICB0YWdOYW1lOiBzdGFydFsxXSwKICAgICAgICAgIGF0dHJzOiBbXSwKICAgICAgICAgIHN0YXJ0OiBpbmRleAogICAgICAgIH07CiAgICAgICAgYWR2YW5jZShzdGFydFswXS5sZW5ndGgpOwogICAgICAgIHZhciBlbmQsIGF0dHI7CiAgICAgICAgd2hpbGUgKCEoZW5kID0gaHRtbC5tYXRjaChzdGFydFRhZ0Nsb3NlKSkgJiYgKGF0dHIgPSBodG1sLm1hdGNoKGF0dHJpYnV0ZSkpKSB7CiAgICAgICAgICBhZHZhbmNlKGF0dHJbMF0ubGVuZ3RoKTsKICAgICAgICAgIG1hdGNoLmF0dHJzLnB1c2goYXR0cik7CiAgICAgICAgfQogICAgICAgIGlmIChlbmQpIHsKICAgICAgICAgIG1hdGNoLnVuYXJ5U2xhc2ggPSBlbmRbMV07CiAgICAgICAgICBhZHZhbmNlKGVuZFswXS5sZW5ndGgpOwogICAgICAgICAgbWF0Y2guZW5kID0gaW5kZXg7CiAgICAgICAgICByZXR1cm4gbWF0Y2gKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVTdGFydFRhZyAobWF0Y2gpIHsKICAgICAgdmFyIHRhZ05hbWUgPSBtYXRjaC50YWdOYW1lOwogICAgICB2YXIgdW5hcnlTbGFzaCA9IG1hdGNoLnVuYXJ5U2xhc2g7CgogICAgICBpZiAoZXhwZWN0SFRNTCkgewogICAgICAgIGlmIChsYXN0VGFnID09PSAncCcgJiYgaXNOb25QaHJhc2luZ1RhZyh0YWdOYW1lKSkgewogICAgICAgICAgcGFyc2VFbmRUYWcobGFzdFRhZyk7CiAgICAgICAgfQogICAgICAgIGlmIChjYW5CZUxlZnRPcGVuVGFnJCQxKHRhZ05hbWUpICYmIGxhc3RUYWcgPT09IHRhZ05hbWUpIHsKICAgICAgICAgIHBhcnNlRW5kVGFnKHRhZ05hbWUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHVuYXJ5ID0gaXNVbmFyeVRhZyQkMSh0YWdOYW1lKSB8fCAhIXVuYXJ5U2xhc2g7CgogICAgICB2YXIgbCA9IG1hdGNoLmF0dHJzLmxlbmd0aDsKICAgICAgdmFyIGF0dHJzID0gbmV3IEFycmF5KGwpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGw7IGkrKykgewogICAgICAgIHZhciBhcmdzID0gbWF0Y2guYXR0cnNbaV07CiAgICAgICAgdmFyIHZhbHVlID0gYXJnc1szXSB8fCBhcmdzWzRdIHx8IGFyZ3NbNV0gfHwgJyc7CiAgICAgICAgdmFyIHNob3VsZERlY29kZU5ld2xpbmVzID0gdGFnTmFtZSA9PT0gJ2EnICYmIGFyZ3NbMV0gPT09ICdocmVmJwogICAgICAgICAgPyBvcHRpb25zLnNob3VsZERlY29kZU5ld2xpbmVzRm9ySHJlZgogICAgICAgICAgOiBvcHRpb25zLnNob3VsZERlY29kZU5ld2xpbmVzOwogICAgICAgIGF0dHJzW2ldID0gewogICAgICAgICAgbmFtZTogYXJnc1sxXSwKICAgICAgICAgIHZhbHVlOiBkZWNvZGVBdHRyKHZhbHVlLCBzaG91bGREZWNvZGVOZXdsaW5lcykKICAgICAgICB9OwogICAgICB9CgogICAgICBpZiAoIXVuYXJ5KSB7CiAgICAgICAgc3RhY2sucHVzaCh7IHRhZzogdGFnTmFtZSwgbG93ZXJDYXNlZFRhZzogdGFnTmFtZS50b0xvd2VyQ2FzZSgpLCBhdHRyczogYXR0cnMgfSk7CiAgICAgICAgbGFzdFRhZyA9IHRhZ05hbWU7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnN0YXJ0KSB7CiAgICAgICAgb3B0aW9ucy5zdGFydCh0YWdOYW1lLCBhdHRycywgdW5hcnksIG1hdGNoLnN0YXJ0LCBtYXRjaC5lbmQpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VFbmRUYWcgKHRhZ05hbWUsIHN0YXJ0LCBlbmQpIHsKICAgICAgdmFyIHBvcywgbG93ZXJDYXNlZFRhZ05hbWU7CiAgICAgIGlmIChzdGFydCA9PSBudWxsKSB7IHN0YXJ0ID0gaW5kZXg7IH0KICAgICAgaWYgKGVuZCA9PSBudWxsKSB7IGVuZCA9IGluZGV4OyB9CgogICAgICAvLyBGaW5kIHRoZSBjbG9zZXN0IG9wZW5lZCB0YWcgb2YgdGhlIHNhbWUgdHlwZQogICAgICBpZiAodGFnTmFtZSkgewogICAgICAgIGxvd2VyQ2FzZWRUYWdOYW1lID0gdGFnTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGZvciAocG9zID0gc3RhY2subGVuZ3RoIC0gMTsgcG9zID49IDA7IHBvcy0tKSB7CiAgICAgICAgICBpZiAoc3RhY2tbcG9zXS5sb3dlckNhc2VkVGFnID09PSBsb3dlckNhc2VkVGFnTmFtZSkgewogICAgICAgICAgICBicmVhawogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJZiBubyB0YWcgbmFtZSBpcyBwcm92aWRlZCwgY2xlYW4gc2hvcAogICAgICAgIHBvcyA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChwb3MgPj0gMCkgewogICAgICAgIC8vIENsb3NlIGFsbCB0aGUgb3BlbiBlbGVtZW50cywgdXAgdGhlIHN0YWNrCiAgICAgICAgZm9yICh2YXIgaSA9IHN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gcG9zOyBpLS0pIHsKICAgICAgICAgIGlmIChpID4gcG9zIHx8ICF0YWdOYW1lICYmCiAgICAgICAgICAgIG9wdGlvbnMud2FybgogICAgICAgICAgKSB7CiAgICAgICAgICAgIG9wdGlvbnMud2FybigKICAgICAgICAgICAgICAoInRhZyA8IiArIChzdGFja1tpXS50YWcpICsgIj4gaGFzIG5vIG1hdGNoaW5nIGVuZCB0YWcuIikKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvcHRpb25zLmVuZCkgewogICAgICAgICAgICBvcHRpb25zLmVuZChzdGFja1tpXS50YWcsIHN0YXJ0LCBlbmQpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gUmVtb3ZlIHRoZSBvcGVuIGVsZW1lbnRzIGZyb20gdGhlIHN0YWNrCiAgICAgICAgc3RhY2subGVuZ3RoID0gcG9zOwogICAgICAgIGxhc3RUYWcgPSBwb3MgJiYgc3RhY2tbcG9zIC0gMV0udGFnOwogICAgICB9IGVsc2UgaWYgKGxvd2VyQ2FzZWRUYWdOYW1lID09PSAnYnInKSB7CiAgICAgICAgaWYgKG9wdGlvbnMuc3RhcnQpIHsKICAgICAgICAgIG9wdGlvbnMuc3RhcnQodGFnTmFtZSwgW10sIHRydWUsIHN0YXJ0LCBlbmQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChsb3dlckNhc2VkVGFnTmFtZSA9PT0gJ3AnKSB7CiAgICAgICAgaWYgKG9wdGlvbnMuc3RhcnQpIHsKICAgICAgICAgIG9wdGlvbnMuc3RhcnQodGFnTmFtZSwgW10sIGZhbHNlLCBzdGFydCwgZW5kKTsKICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMuZW5kKSB7CiAgICAgICAgICBvcHRpb25zLmVuZCh0YWdOYW1lLCBzdGFydCwgZW5kKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIC8qICAqLwoKICB2YXIgb25SRSA9IC9eQHxedi1vbjovOwogIHZhciBkaXJSRSA9IC9edi18XkB8XjovOwogIHZhciBmb3JBbGlhc1JFID0gLyhbXHNcU10qPylccysoPzppbnxvZilccysoW1xzXFNdKikvOwogIHZhciBmb3JJdGVyYXRvclJFID0gLywoW14sXH1cXV0qKSg/OiwoW14sXH1cXV0qKSk/JC87CiAgdmFyIHN0cmlwUGFyZW5zUkUgPSAvXlwofFwpJC9nOwoKICB2YXIgYXJnUkUgPSAvOiguKikkLzsKICB2YXIgYmluZFJFID0gL146fF52LWJpbmQ6LzsKICB2YXIgbW9kaWZpZXJSRSA9IC9cLlteLl0rL2c7CgogIHZhciBkZWNvZGVIVE1MQ2FjaGVkID0gY2FjaGVkKGhlLmRlY29kZSk7CgogIC8vIGNvbmZpZ3VyYWJsZSBzdGF0ZQogIHZhciB3YXJuJDI7CiAgdmFyIGRlbGltaXRlcnM7CiAgdmFyIHRyYW5zZm9ybXM7CiAgdmFyIHByZVRyYW5zZm9ybXM7CiAgdmFyIHBvc3RUcmFuc2Zvcm1zOwogIHZhciBwbGF0Zm9ybUlzUHJlVGFnOwogIHZhciBwbGF0Zm9ybU11c3RVc2VQcm9wOwogIHZhciBwbGF0Zm9ybUdldFRhZ05hbWVzcGFjZTsKCgoKICBmdW5jdGlvbiBjcmVhdGVBU1RFbGVtZW50ICgKICAgIHRhZywKICAgIGF0dHJzLAogICAgcGFyZW50CiAgKSB7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAxLAogICAgICB0YWc6IHRhZywKICAgICAgYXR0cnNMaXN0OiBhdHRycywKICAgICAgYXR0cnNNYXA6IG1ha2VBdHRyc01hcChhdHRycyksCiAgICAgIHBhcmVudDogcGFyZW50LAogICAgICBjaGlsZHJlbjogW10KICAgIH0KICB9CgogIC8qKgogICAqIENvbnZlcnQgSFRNTCBzdHJpbmcgdG8gQVNULgogICAqLwogIGZ1bmN0aW9uIHBhcnNlICgKICAgIHRlbXBsYXRlLAogICAgb3B0aW9ucwogICkgewogICAgd2FybiQyID0gb3B0aW9ucy53YXJuIHx8IGJhc2VXYXJuOwoKICAgIHBsYXRmb3JtSXNQcmVUYWcgPSBvcHRpb25zLmlzUHJlVGFnIHx8IG5vOwogICAgcGxhdGZvcm1NdXN0VXNlUHJvcCA9IG9wdGlvbnMubXVzdFVzZVByb3AgfHwgbm87CiAgICBwbGF0Zm9ybUdldFRhZ05hbWVzcGFjZSA9IG9wdGlvbnMuZ2V0VGFnTmFtZXNwYWNlIHx8IG5vOwoKICAgIHRyYW5zZm9ybXMgPSBwbHVja01vZHVsZUZ1bmN0aW9uKG9wdGlvbnMubW9kdWxlcywgJ3RyYW5zZm9ybU5vZGUnKTsKICAgIHByZVRyYW5zZm9ybXMgPSBwbHVja01vZHVsZUZ1bmN0aW9uKG9wdGlvbnMubW9kdWxlcywgJ3ByZVRyYW5zZm9ybU5vZGUnKTsKICAgIHBvc3RUcmFuc2Zvcm1zID0gcGx1Y2tNb2R1bGVGdW5jdGlvbihvcHRpb25zLm1vZHVsZXMsICdwb3N0VHJhbnNmb3JtTm9kZScpOwoKICAgIGRlbGltaXRlcnMgPSBvcHRpb25zLmRlbGltaXRlcnM7CgogICAgdmFyIHN0YWNrID0gW107CiAgICB2YXIgcHJlc2VydmVXaGl0ZXNwYWNlID0gb3B0aW9ucy5wcmVzZXJ2ZVdoaXRlc3BhY2UgIT09IGZhbHNlOwogICAgdmFyIHJvb3Q7CiAgICB2YXIgY3VycmVudFBhcmVudDsKICAgIHZhciBpblZQcmUgPSBmYWxzZTsKICAgIHZhciBpblByZSA9IGZhbHNlOwogICAgdmFyIHdhcm5lZCA9IGZhbHNlOwoKICAgIGZ1bmN0aW9uIHdhcm5PbmNlIChtc2cpIHsKICAgICAgaWYgKCF3YXJuZWQpIHsKICAgICAgICB3YXJuZWQgPSB0cnVlOwogICAgICAgIHdhcm4kMihtc2cpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY2xvc2VFbGVtZW50IChlbGVtZW50KSB7CiAgICAgIC8vIGNoZWNrIHByZSBzdGF0ZQogICAgICBpZiAoZWxlbWVudC5wcmUpIHsKICAgICAgICBpblZQcmUgPSBmYWxzZTsKICAgICAgfQogICAgICBpZiAocGxhdGZvcm1Jc1ByZVRhZyhlbGVtZW50LnRhZykpIHsKICAgICAgICBpblByZSA9IGZhbHNlOwogICAgICB9CiAgICAgIC8vIGFwcGx5IHBvc3QtdHJhbnNmb3JtcwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBvc3RUcmFuc2Zvcm1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcG9zdFRyYW5zZm9ybXNbaV0oZWxlbWVudCwgb3B0aW9ucyk7CiAgICAgIH0KICAgIH0KCiAgICBwYXJzZUhUTUwodGVtcGxhdGUsIHsKICAgICAgd2Fybjogd2FybiQyLAogICAgICBleHBlY3RIVE1MOiBvcHRpb25zLmV4cGVjdEhUTUwsCiAgICAgIGlzVW5hcnlUYWc6IG9wdGlvbnMuaXNVbmFyeVRhZywKICAgICAgY2FuQmVMZWZ0T3BlblRhZzogb3B0aW9ucy5jYW5CZUxlZnRPcGVuVGFnLAogICAgICBzaG91bGREZWNvZGVOZXdsaW5lczogb3B0aW9ucy5zaG91bGREZWNvZGVOZXdsaW5lcywKICAgICAgc2hvdWxkRGVjb2RlTmV3bGluZXNGb3JIcmVmOiBvcHRpb25zLnNob3VsZERlY29kZU5ld2xpbmVzRm9ySHJlZiwKICAgICAgc2hvdWxkS2VlcENvbW1lbnQ6IG9wdGlvbnMuY29tbWVudHMsCiAgICAgIHN0YXJ0OiBmdW5jdGlvbiBzdGFydCAodGFnLCBhdHRycywgdW5hcnkpIHsKICAgICAgICAvLyBjaGVjayBuYW1lc3BhY2UuCiAgICAgICAgLy8gaW5oZXJpdCBwYXJlbnQgbnMgaWYgdGhlcmUgaXMgb25lCiAgICAgICAgdmFyIG5zID0gKGN1cnJlbnRQYXJlbnQgJiYgY3VycmVudFBhcmVudC5ucykgfHwgcGxhdGZvcm1HZXRUYWdOYW1lc3BhY2UodGFnKTsKCiAgICAgICAgLy8gaGFuZGxlIElFIHN2ZyBidWcKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICBpZiAoaXNJRSAmJiBucyA9PT0gJ3N2ZycpIHsKICAgICAgICAgIGF0dHJzID0gZ3VhcmRJRVNWR0J1ZyhhdHRycyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgZWxlbWVudCA9IGNyZWF0ZUFTVEVsZW1lbnQodGFnLCBhdHRycywgY3VycmVudFBhcmVudCk7CiAgICAgICAgaWYgKG5zKSB7CiAgICAgICAgICBlbGVtZW50Lm5zID0gbnM7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNGb3JiaWRkZW5UYWcoZWxlbWVudCkgJiYgIWlzU2VydmVyUmVuZGVyaW5nKCkpIHsKICAgICAgICAgIGVsZW1lbnQuZm9yYmlkZGVuID0gdHJ1ZTsKICAgICAgICAgIHdhcm4kMigKICAgICAgICAgICAgJ1RlbXBsYXRlcyBzaG91bGQgb25seSBiZSByZXNwb25zaWJsZSBmb3IgbWFwcGluZyB0aGUgc3RhdGUgdG8gdGhlICcgKwogICAgICAgICAgICAnVUkuIEF2b2lkIHBsYWNpbmcgdGFncyB3aXRoIHNpZGUtZWZmZWN0cyBpbiB5b3VyIHRlbXBsYXRlcywgc3VjaCBhcyAnICsKICAgICAgICAgICAgIjwiICsgdGFnICsgIj4iICsgJywgYXMgdGhleSB3aWxsIG5vdCBiZSBwYXJzZWQuJwogICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIC8vIGFwcGx5IHByZS10cmFuc2Zvcm1zCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmVUcmFuc2Zvcm1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBlbGVtZW50ID0gcHJlVHJhbnNmb3Jtc1tpXShlbGVtZW50LCBvcHRpb25zKSB8fCBlbGVtZW50OwogICAgICAgIH0KCiAgICAgICAgaWYgKCFpblZQcmUpIHsKICAgICAgICAgIHByb2Nlc3NQcmUoZWxlbWVudCk7CiAgICAgICAgICBpZiAoZWxlbWVudC5wcmUpIHsKICAgICAgICAgICAgaW5WUHJlID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHBsYXRmb3JtSXNQcmVUYWcoZWxlbWVudC50YWcpKSB7CiAgICAgICAgICBpblByZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChpblZQcmUpIHsKICAgICAgICAgIHByb2Nlc3NSYXdBdHRycyhlbGVtZW50KTsKICAgICAgICB9IGVsc2UgaWYgKCFlbGVtZW50LnByb2Nlc3NlZCkgewogICAgICAgICAgLy8gc3RydWN0dXJhbCBkaXJlY3RpdmVzCiAgICAgICAgICBwcm9jZXNzRm9yKGVsZW1lbnQpOwogICAgICAgICAgcHJvY2Vzc0lmKGVsZW1lbnQpOwogICAgICAgICAgcHJvY2Vzc09uY2UoZWxlbWVudCk7CiAgICAgICAgICAvLyBlbGVtZW50LXNjb3BlIHN0dWZmCiAgICAgICAgICBwcm9jZXNzRWxlbWVudChlbGVtZW50LCBvcHRpb25zKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNoZWNrUm9vdENvbnN0cmFpbnRzIChlbCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWwudGFnID09PSAnc2xvdCcgfHwgZWwudGFnID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgICAgICAgd2Fybk9uY2UoCiAgICAgICAgICAgICAgICAiQ2Fubm90IHVzZSA8IiArIChlbC50YWcpICsgIj4gYXMgY29tcG9uZW50IHJvb3QgZWxlbWVudCBiZWNhdXNlIGl0IG1heSAiICsKICAgICAgICAgICAgICAgICdjb250YWluIG11bHRpcGxlIG5vZGVzLicKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbC5hdHRyc01hcC5oYXNPd25Qcm9wZXJ0eSgndi1mb3InKSkgewogICAgICAgICAgICAgIHdhcm5PbmNlKAogICAgICAgICAgICAgICAgJ0Nhbm5vdCB1c2Ugdi1mb3Igb24gc3RhdGVmdWwgY29tcG9uZW50IHJvb3QgZWxlbWVudCBiZWNhdXNlICcgKwogICAgICAgICAgICAgICAgJ2l0IHJlbmRlcnMgbXVsdGlwbGUgZWxlbWVudHMuJwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIHRyZWUgbWFuYWdlbWVudAogICAgICAgIGlmICghcm9vdCkgewogICAgICAgICAgcm9vdCA9IGVsZW1lbnQ7CiAgICAgICAgICBjaGVja1Jvb3RDb25zdHJhaW50cyhyb290KTsKICAgICAgICB9IGVsc2UgaWYgKCFzdGFjay5sZW5ndGgpIHsKICAgICAgICAgIC8vIGFsbG93IHJvb3QgZWxlbWVudHMgd2l0aCB2LWlmLCB2LWVsc2UtaWYgYW5kIHYtZWxzZQogICAgICAgICAgaWYgKHJvb3QuaWYgJiYgKGVsZW1lbnQuZWxzZWlmIHx8IGVsZW1lbnQuZWxzZSkpIHsKICAgICAgICAgICAgY2hlY2tSb290Q29uc3RyYWludHMoZWxlbWVudCk7CiAgICAgICAgICAgIGFkZElmQ29uZGl0aW9uKHJvb3QsIHsKICAgICAgICAgICAgICBleHA6IGVsZW1lbnQuZWxzZWlmLAogICAgICAgICAgICAgIGJsb2NrOiBlbGVtZW50CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2Fybk9uY2UoCiAgICAgICAgICAgICAgIkNvbXBvbmVudCB0ZW1wbGF0ZSBzaG91bGQgY29udGFpbiBleGFjdGx5IG9uZSByb290IGVsZW1lbnQuICIgKwogICAgICAgICAgICAgICJJZiB5b3UgYXJlIHVzaW5nIHYtaWYgb24gbXVsdGlwbGUgZWxlbWVudHMsICIgKwogICAgICAgICAgICAgICJ1c2Ugdi1lbHNlLWlmIHRvIGNoYWluIHRoZW0gaW5zdGVhZC4iCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChjdXJyZW50UGFyZW50ICYmICFlbGVtZW50LmZvcmJpZGRlbikgewogICAgICAgICAgaWYgKGVsZW1lbnQuZWxzZWlmIHx8IGVsZW1lbnQuZWxzZSkgewogICAgICAgICAgICBwcm9jZXNzSWZDb25kaXRpb25zKGVsZW1lbnQsIGN1cnJlbnRQYXJlbnQpOwogICAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LnNsb3RTY29wZSkgeyAvLyBzY29wZWQgc2xvdAogICAgICAgICAgICBjdXJyZW50UGFyZW50LnBsYWluID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBuYW1lID0gZWxlbWVudC5zbG90VGFyZ2V0IHx8ICciZGVmYXVsdCInCiAgICAgICAgICAgIDsoY3VycmVudFBhcmVudC5zY29wZWRTbG90cyB8fCAoY3VycmVudFBhcmVudC5zY29wZWRTbG90cyA9IHt9KSlbbmFtZV0gPSBlbGVtZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY3VycmVudFBhcmVudC5jaGlsZHJlbi5wdXNoKGVsZW1lbnQpOwogICAgICAgICAgICBlbGVtZW50LnBhcmVudCA9IGN1cnJlbnRQYXJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghdW5hcnkpIHsKICAgICAgICAgIGN1cnJlbnRQYXJlbnQgPSBlbGVtZW50OwogICAgICAgICAgc3RhY2sucHVzaChlbGVtZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2xvc2VFbGVtZW50KGVsZW1lbnQpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIGVuZDogZnVuY3Rpb24gZW5kICgpIHsKICAgICAgICAvLyByZW1vdmUgdHJhaWxpbmcgd2hpdGVzcGFjZQogICAgICAgIHZhciBlbGVtZW50ID0gc3RhY2tbc3RhY2subGVuZ3RoIC0gMV07CiAgICAgICAgdmFyIGxhc3ROb2RlID0gZWxlbWVudC5jaGlsZHJlbltlbGVtZW50LmNoaWxkcmVuLmxlbmd0aCAtIDFdOwogICAgICAgIGlmIChsYXN0Tm9kZSAmJiBsYXN0Tm9kZS50eXBlID09PSAzICYmIGxhc3ROb2RlLnRleHQgPT09ICcgJyAmJiAhaW5QcmUpIHsKICAgICAgICAgIGVsZW1lbnQuY2hpbGRyZW4ucG9wKCk7CiAgICAgICAgfQogICAgICAgIC8vIHBvcCBzdGFjawogICAgICAgIHN0YWNrLmxlbmd0aCAtPSAxOwogICAgICAgIGN1cnJlbnRQYXJlbnQgPSBzdGFja1tzdGFjay5sZW5ndGggLSAxXTsKICAgICAgICBjbG9zZUVsZW1lbnQoZWxlbWVudCk7CiAgICAgIH0sCgogICAgICBjaGFyczogZnVuY3Rpb24gY2hhcnMgKHRleHQpIHsKICAgICAgICBpZiAoIWN1cnJlbnRQYXJlbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHRleHQgPT09IHRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgd2Fybk9uY2UoCiAgICAgICAgICAgICAgICAnQ29tcG9uZW50IHRlbXBsYXRlIHJlcXVpcmVzIGEgcm9vdCBlbGVtZW50LCByYXRoZXIgdGhhbiBqdXN0IHRleHQuJwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRleHQgPSB0ZXh0LnRyaW0oKSkpIHsKICAgICAgICAgICAgICB3YXJuT25jZSgKICAgICAgICAgICAgICAgICgidGV4dCBcIiIgKyB0ZXh0ICsgIlwiIG91dHNpZGUgcm9vdCBlbGVtZW50IHdpbGwgYmUgaWdub3JlZC4iKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICAvLyBJRSB0ZXh0YXJlYSBwbGFjZWhvbGRlciBidWcKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICBpZiAoaXNJRSAmJgogICAgICAgICAgY3VycmVudFBhcmVudC50YWcgPT09ICd0ZXh0YXJlYScgJiYKICAgICAgICAgIGN1cnJlbnRQYXJlbnQuYXR0cnNNYXAucGxhY2Vob2xkZXIgPT09IHRleHQKICAgICAgICApIHsKICAgICAgICAgIHJldHVybgogICAgICAgIH0KICAgICAgICB2YXIgY2hpbGRyZW4gPSBjdXJyZW50UGFyZW50LmNoaWxkcmVuOwogICAgICAgIHRleHQgPSBpblByZSB8fCB0ZXh0LnRyaW0oKQogICAgICAgICAgPyBpc1RleHRUYWcoY3VycmVudFBhcmVudCkgPyB0ZXh0IDogZGVjb2RlSFRNTENhY2hlZCh0ZXh0KQogICAgICAgICAgLy8gb25seSBwcmVzZXJ2ZSB3aGl0ZXNwYWNlIGlmIGl0cyBub3QgcmlnaHQgYWZ0ZXIgYSBzdGFydGluZyB0YWcKICAgICAgICAgIDogcHJlc2VydmVXaGl0ZXNwYWNlICYmIGNoaWxkcmVuLmxlbmd0aCA/ICcgJyA6ICcnOwogICAgICAgIGlmICh0ZXh0KSB7CiAgICAgICAgICB2YXIgcmVzOwogICAgICAgICAgaWYgKCFpblZQcmUgJiYgdGV4dCAhPT0gJyAnICYmIChyZXMgPSBwYXJzZVRleHQodGV4dCwgZGVsaW1pdGVycykpKSB7CiAgICAgICAgICAgIGNoaWxkcmVuLnB1c2goewogICAgICAgICAgICAgIHR5cGU6IDIsCiAgICAgICAgICAgICAgZXhwcmVzc2lvbjogcmVzLmV4cHJlc3Npb24sCiAgICAgICAgICAgICAgdG9rZW5zOiByZXMudG9rZW5zLAogICAgICAgICAgICAgIHRleHQ6IHRleHQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRleHQgIT09ICcgJyB8fCAhY2hpbGRyZW4ubGVuZ3RoIHx8IGNoaWxkcmVuW2NoaWxkcmVuLmxlbmd0aCAtIDFdLnRleHQgIT09ICcgJykgewogICAgICAgICAgICBjaGlsZHJlbi5wdXNoKHsKICAgICAgICAgICAgICB0eXBlOiAzLAogICAgICAgICAgICAgIHRleHQ6IHRleHQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBjb21tZW50OiBmdW5jdGlvbiBjb21tZW50ICh0ZXh0KSB7CiAgICAgICAgY3VycmVudFBhcmVudC5jaGlsZHJlbi5wdXNoKHsKICAgICAgICAgIHR5cGU6IDMsCiAgICAgICAgICB0ZXh0OiB0ZXh0LAogICAgICAgICAgaXNDb21tZW50OiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJvb3QKICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NQcmUgKGVsKSB7CiAgICBpZiAoZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3YtcHJlJykgIT0gbnVsbCkgewogICAgICBlbC5wcmUgPSB0cnVlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc1Jhd0F0dHJzIChlbCkgewogICAgdmFyIGwgPSBlbC5hdHRyc0xpc3QubGVuZ3RoOwogICAgaWYgKGwpIHsKICAgICAgdmFyIGF0dHJzID0gZWwuYXR0cnMgPSBuZXcgQXJyYXkobCk7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgYXR0cnNbaV0gPSB7CiAgICAgICAgICBuYW1lOiBlbC5hdHRyc0xpc3RbaV0ubmFtZSwKICAgICAgICAgIHZhbHVlOiBKU09OLnN0cmluZ2lmeShlbC5hdHRyc0xpc3RbaV0udmFsdWUpCiAgICAgICAgfTsKICAgICAgfQogICAgfSBlbHNlIGlmICghZWwucHJlKSB7CiAgICAgIC8vIG5vbiByb290IG5vZGUgaW4gcHJlIGJsb2NrcyB3aXRoIG5vIGF0dHJpYnV0ZXMKICAgICAgZWwucGxhaW4gPSB0cnVlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc0VsZW1lbnQgKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgIHByb2Nlc3NLZXkoZWxlbWVudCk7CgogICAgLy8gZGV0ZXJtaW5lIHdoZXRoZXIgdGhpcyBpcyBhIHBsYWluIGVsZW1lbnQgYWZ0ZXIKICAgIC8vIHJlbW92aW5nIHN0cnVjdHVyYWwgYXR0cmlidXRlcwogICAgZWxlbWVudC5wbGFpbiA9ICFlbGVtZW50LmtleSAmJiAhZWxlbWVudC5hdHRyc0xpc3QubGVuZ3RoOwoKICAgIHByb2Nlc3NSZWYoZWxlbWVudCk7CiAgICBwcm9jZXNzU2xvdChlbGVtZW50KTsKICAgIHByb2Nlc3NDb21wb25lbnQoZWxlbWVudCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRyYW5zZm9ybXMubGVuZ3RoOyBpKyspIHsKICAgICAgZWxlbWVudCA9IHRyYW5zZm9ybXNbaV0oZWxlbWVudCwgb3B0aW9ucykgfHwgZWxlbWVudDsKICAgIH0KICAgIHByb2Nlc3NBdHRycyhlbGVtZW50KTsKICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NLZXkgKGVsKSB7CiAgICB2YXIgZXhwID0gZ2V0QmluZGluZ0F0dHIoZWwsICdrZXknKTsKICAgIGlmIChleHApIHsKICAgICAgewogICAgICAgIGlmIChlbC50YWcgPT09ICd0ZW1wbGF0ZScpIHsKICAgICAgICAgIHdhcm4kMigiPHRlbXBsYXRlPiBjYW5ub3QgYmUga2V5ZWQuIFBsYWNlIHRoZSBrZXkgb24gcmVhbCBlbGVtZW50cyBpbnN0ZWFkLiIpOwogICAgICAgIH0KICAgICAgICBpZiAoZWwuZm9yKSB7CiAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBlbC5pdGVyYXRvcjIgfHwgZWwuaXRlcmF0b3IxOwogICAgICAgICAgdmFyIHBhcmVudCA9IGVsLnBhcmVudDsKICAgICAgICAgIGlmIChpdGVyYXRvciAmJiBpdGVyYXRvciA9PT0gZXhwICYmIHBhcmVudCAmJiBwYXJlbnQudGFnID09PSAndHJhbnNpdGlvbi1ncm91cCcpIHsKICAgICAgICAgICAgd2FybiQyKAogICAgICAgICAgICAgICJEbyBub3QgdXNlIHYtZm9yIGluZGV4IGFzIGtleSBvbiA8dHJhbnNpdGlvbi1ncm91cD4gY2hpbGRyZW4sICIgKwogICAgICAgICAgICAgICJ0aGlzIGlzIHRoZSBzYW1lIGFzIG5vdCB1c2luZyBrZXlzLiIKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZWwua2V5ID0gZXhwOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc1JlZiAoZWwpIHsKICAgIHZhciByZWYgPSBnZXRCaW5kaW5nQXR0cihlbCwgJ3JlZicpOwogICAgaWYgKHJlZikgewogICAgICBlbC5yZWYgPSByZWY7CiAgICAgIGVsLnJlZkluRm9yID0gY2hlY2tJbkZvcihlbCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwcm9jZXNzRm9yIChlbCkgewogICAgdmFyIGV4cDsKICAgIGlmICgoZXhwID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3YtZm9yJykpKSB7CiAgICAgIHZhciByZXMgPSBwYXJzZUZvcihleHApOwogICAgICBpZiAocmVzKSB7CiAgICAgICAgZXh0ZW5kKGVsLCByZXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHdhcm4kMigKICAgICAgICAgICgiSW52YWxpZCB2LWZvciBleHByZXNzaW9uOiAiICsgZXhwKQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICB9CgoKCiAgZnVuY3Rpb24gcGFyc2VGb3IgKGV4cCkgewogICAgdmFyIGluTWF0Y2ggPSBleHAubWF0Y2goZm9yQWxpYXNSRSk7CiAgICBpZiAoIWluTWF0Y2gpIHsgcmV0dXJuIH0KICAgIHZhciByZXMgPSB7fTsKICAgIHJlcy5mb3IgPSBpbk1hdGNoWzJdLnRyaW0oKTsKICAgIHZhciBhbGlhcyA9IGluTWF0Y2hbMV0udHJpbSgpLnJlcGxhY2Uoc3RyaXBQYXJlbnNSRSwgJycpOwogICAgdmFyIGl0ZXJhdG9yTWF0Y2ggPSBhbGlhcy5tYXRjaChmb3JJdGVyYXRvclJFKTsKICAgIGlmIChpdGVyYXRvck1hdGNoKSB7CiAgICAgIHJlcy5hbGlhcyA9IGFsaWFzLnJlcGxhY2UoZm9ySXRlcmF0b3JSRSwgJycpLnRyaW0oKTsKICAgICAgcmVzLml0ZXJhdG9yMSA9IGl0ZXJhdG9yTWF0Y2hbMV0udHJpbSgpOwogICAgICBpZiAoaXRlcmF0b3JNYXRjaFsyXSkgewogICAgICAgIHJlcy5pdGVyYXRvcjIgPSBpdGVyYXRvck1hdGNoWzJdLnRyaW0oKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmVzLmFsaWFzID0gYWxpYXM7CiAgICB9CiAgICByZXR1cm4gcmVzCiAgfQoKICBmdW5jdGlvbiBwcm9jZXNzSWYgKGVsKSB7CiAgICB2YXIgZXhwID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3YtaWYnKTsKICAgIGlmIChleHApIHsKICAgICAgZWwuaWYgPSBleHA7CiAgICAgIGFkZElmQ29uZGl0aW9uKGVsLCB7CiAgICAgICAgZXhwOiBleHAsCiAgICAgICAgYmxvY2s6IGVsCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgaWYgKGdldEFuZFJlbW92ZUF0dHIoZWwsICd2LWVsc2UnKSAhPSBudWxsKSB7CiAgICAgICAgZWwuZWxzZSA9IHRydWU7CiAgICAgIH0KICAgICAgdmFyIGVsc2VpZiA9IGdldEFuZFJlbW92ZUF0dHIoZWwsICd2LWVsc2UtaWYnKTsKICAgICAgaWYgKGVsc2VpZikgewogICAgICAgIGVsLmVsc2VpZiA9IGVsc2VpZjsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc0lmQ29uZGl0aW9ucyAoZWwsIHBhcmVudCkgewogICAgdmFyIHByZXYgPSBmaW5kUHJldkVsZW1lbnQocGFyZW50LmNoaWxkcmVuKTsKICAgIGlmIChwcmV2ICYmIHByZXYuaWYpIHsKICAgICAgYWRkSWZDb25kaXRpb24ocHJldiwgewogICAgICAgIGV4cDogZWwuZWxzZWlmLAogICAgICAgIGJsb2NrOiBlbAogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHdhcm4kMigKICAgICAgICAidi0iICsgKGVsLmVsc2VpZiA/ICgnZWxzZS1pZj0iJyArIGVsLmVsc2VpZiArICciJykgOiAnZWxzZScpICsgIiAiICsKICAgICAgICAidXNlZCBvbiBlbGVtZW50IDwiICsgKGVsLnRhZykgKyAiPiB3aXRob3V0IGNvcnJlc3BvbmRpbmcgdi1pZi4iCiAgICAgICk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBmaW5kUHJldkVsZW1lbnQgKGNoaWxkcmVuKSB7CiAgICB2YXIgaSA9IGNoaWxkcmVuLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgaWYgKGNoaWxkcmVuW2ldLnR5cGUgPT09IDEpIHsKICAgICAgICByZXR1cm4gY2hpbGRyZW5baV0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoY2hpbGRyZW5baV0udGV4dCAhPT0gJyAnKSB7CiAgICAgICAgICB3YXJuJDIoCiAgICAgICAgICAgICJ0ZXh0IFwiIiArIChjaGlsZHJlbltpXS50ZXh0LnRyaW0oKSkgKyAiXCIgYmV0d2VlbiB2LWlmIGFuZCB2LWVsc2UoLWlmKSAiICsKICAgICAgICAgICAgIndpbGwgYmUgaWdub3JlZC4iCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjaGlsZHJlbi5wb3AoKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gYWRkSWZDb25kaXRpb24gKGVsLCBjb25kaXRpb24pIHsKICAgIGlmICghZWwuaWZDb25kaXRpb25zKSB7CiAgICAgIGVsLmlmQ29uZGl0aW9ucyA9IFtdOwogICAgfQogICAgZWwuaWZDb25kaXRpb25zLnB1c2goY29uZGl0aW9uKTsKICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NPbmNlIChlbCkgewogICAgdmFyIG9uY2UkJDEgPSBnZXRBbmRSZW1vdmVBdHRyKGVsLCAndi1vbmNlJyk7CiAgICBpZiAob25jZSQkMSAhPSBudWxsKSB7CiAgICAgIGVsLm9uY2UgPSB0cnVlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc1Nsb3QgKGVsKSB7CiAgICBpZiAoZWwudGFnID09PSAnc2xvdCcpIHsKICAgICAgZWwuc2xvdE5hbWUgPSBnZXRCaW5kaW5nQXR0cihlbCwgJ25hbWUnKTsKICAgICAgaWYgKGVsLmtleSkgewogICAgICAgIHdhcm4kMigKICAgICAgICAgICJga2V5YCBkb2VzIG5vdCB3b3JrIG9uIDxzbG90PiBiZWNhdXNlIHNsb3RzIGFyZSBhYnN0cmFjdCBvdXRsZXRzICIgKwogICAgICAgICAgImFuZCBjYW4gcG9zc2libHkgZXhwYW5kIGludG8gbXVsdGlwbGUgZWxlbWVudHMuICIgKwogICAgICAgICAgIlVzZSB0aGUga2V5IG9uIGEgd3JhcHBpbmcgZWxlbWVudCBpbnN0ZWFkLiIKICAgICAgICApOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgc2xvdFNjb3BlOwogICAgICBpZiAoZWwudGFnID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgc2xvdFNjb3BlID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3Njb3BlJyk7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgaWYgKHNsb3RTY29wZSkgewogICAgICAgICAgd2FybiQyKAogICAgICAgICAgICAidGhlIFwic2NvcGVcIiBhdHRyaWJ1dGUgZm9yIHNjb3BlZCBzbG90cyBoYXZlIGJlZW4gZGVwcmVjYXRlZCBhbmQgIiArCiAgICAgICAgICAgICJyZXBsYWNlZCBieSBcInNsb3Qtc2NvcGVcIiBzaW5jZSAyLjUuIFRoZSBuZXcgXCJzbG90LXNjb3BlXCIgYXR0cmlidXRlICIgKwogICAgICAgICAgICAiY2FuIGFsc28gYmUgdXNlZCBvbiBwbGFpbiBlbGVtZW50cyBpbiBhZGRpdGlvbiB0byA8dGVtcGxhdGU+IHRvICIgKwogICAgICAgICAgICAiZGVub3RlIHNjb3BlZCBzbG90cy4iLAogICAgICAgICAgICB0cnVlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBlbC5zbG90U2NvcGUgPSBzbG90U2NvcGUgfHwgZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3Nsb3Qtc2NvcGUnKTsKICAgICAgfSBlbHNlIGlmICgoc2xvdFNjb3BlID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3Nsb3Qtc2NvcGUnKSkpIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICBpZiAoZWwuYXR0cnNNYXBbJ3YtZm9yJ10pIHsKICAgICAgICAgIHdhcm4kMigKICAgICAgICAgICAgIkFtYmlndW91cyBjb21iaW5lZCB1c2FnZSBvZiBzbG90LXNjb3BlIGFuZCB2LWZvciBvbiA8IiArIChlbC50YWcpICsgIj4gIiArCiAgICAgICAgICAgICIodi1mb3IgdGFrZXMgaGlnaGVyIHByaW9yaXR5KS4gVXNlIGEgd3JhcHBlciA8dGVtcGxhdGU+IGZvciB0aGUgIiArCiAgICAgICAgICAgICJzY29wZWQgc2xvdCB0byBtYWtlIGl0IGNsZWFyZXIuIiwKICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgZWwuc2xvdFNjb3BlID0gc2xvdFNjb3BlOwogICAgICB9CiAgICAgIHZhciBzbG90VGFyZ2V0ID0gZ2V0QmluZGluZ0F0dHIoZWwsICdzbG90Jyk7CiAgICAgIGlmIChzbG90VGFyZ2V0KSB7CiAgICAgICAgZWwuc2xvdFRhcmdldCA9IHNsb3RUYXJnZXQgPT09ICciIicgPyAnImRlZmF1bHQiJyA6IHNsb3RUYXJnZXQ7CiAgICAgICAgLy8gcHJlc2VydmUgc2xvdCBhcyBhbiBhdHRyaWJ1dGUgZm9yIG5hdGl2ZSBzaGFkb3cgRE9NIGNvbXBhdAogICAgICAgIC8vIG9ubHkgZm9yIG5vbi1zY29wZWQgc2xvdHMuCiAgICAgICAgaWYgKGVsLnRhZyAhPT0gJ3RlbXBsYXRlJyAmJiAhZWwuc2xvdFNjb3BlKSB7CiAgICAgICAgICBhZGRBdHRyKGVsLCAnc2xvdCcsIHNsb3RUYXJnZXQpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcHJvY2Vzc0NvbXBvbmVudCAoZWwpIHsKICAgIHZhciBiaW5kaW5nOwogICAgaWYgKChiaW5kaW5nID0gZ2V0QmluZGluZ0F0dHIoZWwsICdpcycpKSkgewogICAgICBlbC5jb21wb25lbnQgPSBiaW5kaW5nOwogICAgfQogICAgaWYgKGdldEFuZFJlbW92ZUF0dHIoZWwsICdpbmxpbmUtdGVtcGxhdGUnKSAhPSBudWxsKSB7CiAgICAgIGVsLmlubGluZVRlbXBsYXRlID0gdHJ1ZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHByb2Nlc3NBdHRycyAoZWwpIHsKICAgIHZhciBsaXN0ID0gZWwuYXR0cnNMaXN0OwogICAgdmFyIGksIGwsIG5hbWUsIHJhd05hbWUsIHZhbHVlLCBtb2RpZmllcnMsIGlzUHJvcDsKICAgIGZvciAoaSA9IDAsIGwgPSBsaXN0Lmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBuYW1lID0gcmF3TmFtZSA9IGxpc3RbaV0ubmFtZTsKICAgICAgdmFsdWUgPSBsaXN0W2ldLnZhbHVlOwogICAgICBpZiAoZGlyUkUudGVzdChuYW1lKSkgewogICAgICAgIC8vIG1hcmsgZWxlbWVudCBhcyBkeW5hbWljCiAgICAgICAgZWwuaGFzQmluZGluZ3MgPSB0cnVlOwogICAgICAgIC8vIG1vZGlmaWVycwogICAgICAgIG1vZGlmaWVycyA9IHBhcnNlTW9kaWZpZXJzKG5hbWUpOwogICAgICAgIGlmIChtb2RpZmllcnMpIHsKICAgICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UobW9kaWZpZXJSRSwgJycpOwogICAgICAgIH0KICAgICAgICBpZiAoYmluZFJFLnRlc3QobmFtZSkpIHsgLy8gdi1iaW5kCiAgICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKGJpbmRSRSwgJycpOwogICAgICAgICAgdmFsdWUgPSBwYXJzZUZpbHRlcnModmFsdWUpOwogICAgICAgICAgaXNQcm9wID0gZmFsc2U7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIHZhbHVlLnRyaW0oKS5sZW5ndGggPT09IDAKICAgICAgICAgICkgewogICAgICAgICAgICB3YXJuJDIoCiAgICAgICAgICAgICAgKCJUaGUgdmFsdWUgZm9yIGEgdi1iaW5kIGV4cHJlc3Npb24gY2Fubm90IGJlIGVtcHR5LiBGb3VuZCBpbiBcInYtYmluZDoiICsgbmFtZSArICJcIiIpCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobW9kaWZpZXJzKSB7CiAgICAgICAgICAgIGlmIChtb2RpZmllcnMucHJvcCkgewogICAgICAgICAgICAgIGlzUHJvcCA9IHRydWU7CiAgICAgICAgICAgICAgbmFtZSA9IGNhbWVsaXplKG5hbWUpOwogICAgICAgICAgICAgIGlmIChuYW1lID09PSAnaW5uZXJIdG1sJykgeyBuYW1lID0gJ2lubmVySFRNTCc7IH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobW9kaWZpZXJzLmNhbWVsKSB7CiAgICAgICAgICAgICAgbmFtZSA9IGNhbWVsaXplKG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtb2RpZmllcnMuc3luYykgewogICAgICAgICAgICAgIGFkZEhhbmRsZXIoCiAgICAgICAgICAgICAgICBlbCwKICAgICAgICAgICAgICAgICgidXBkYXRlOiIgKyAoY2FtZWxpemUobmFtZSkpKSwKICAgICAgICAgICAgICAgIGdlbkFzc2lnbm1lbnRDb2RlKHZhbHVlLCAiJGV2ZW50IikKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNQcm9wIHx8ICgKICAgICAgICAgICAgIWVsLmNvbXBvbmVudCAmJiBwbGF0Zm9ybU11c3RVc2VQcm9wKGVsLnRhZywgZWwuYXR0cnNNYXAudHlwZSwgbmFtZSkKICAgICAgICAgICkpIHsKICAgICAgICAgICAgYWRkUHJvcChlbCwgbmFtZSwgdmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYWRkQXR0cihlbCwgbmFtZSwgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAob25SRS50ZXN0KG5hbWUpKSB7IC8vIHYtb24KICAgICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2Uob25SRSwgJycpOwogICAgICAgICAgYWRkSGFuZGxlcihlbCwgbmFtZSwgdmFsdWUsIG1vZGlmaWVycywgZmFsc2UsIHdhcm4kMik7CiAgICAgICAgfSBlbHNlIHsgLy8gbm9ybWFsIGRpcmVjdGl2ZXMKICAgICAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoZGlyUkUsICcnKTsKICAgICAgICAgIC8vIHBhcnNlIGFyZwogICAgICAgICAgdmFyIGFyZ01hdGNoID0gbmFtZS5tYXRjaChhcmdSRSk7CiAgICAgICAgICB2YXIgYXJnID0gYXJnTWF0Y2ggJiYgYXJnTWF0Y2hbMV07CiAgICAgICAgICBpZiAoYXJnKSB7CiAgICAgICAgICAgIG5hbWUgPSBuYW1lLnNsaWNlKDAsIC0oYXJnLmxlbmd0aCArIDEpKTsKICAgICAgICAgIH0KICAgICAgICAgIGFkZERpcmVjdGl2ZShlbCwgbmFtZSwgcmF3TmFtZSwgdmFsdWUsIGFyZywgbW9kaWZpZXJzKTsKICAgICAgICAgIGlmIChuYW1lID09PSAnbW9kZWwnKSB7CiAgICAgICAgICAgIGNoZWNrRm9yQWxpYXNNb2RlbChlbCwgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBsaXRlcmFsIGF0dHJpYnV0ZQogICAgICAgIHsKICAgICAgICAgIHZhciByZXMgPSBwYXJzZVRleHQodmFsdWUsIGRlbGltaXRlcnMpOwogICAgICAgICAgaWYgKHJlcykgewogICAgICAgICAgICB3YXJuJDIoCiAgICAgICAgICAgICAgbmFtZSArICI9XCIiICsgdmFsdWUgKyAiXCI6ICIgKwogICAgICAgICAgICAgICdJbnRlcnBvbGF0aW9uIGluc2lkZSBhdHRyaWJ1dGVzIGhhcyBiZWVuIHJlbW92ZWQuICcgKwogICAgICAgICAgICAgICdVc2Ugdi1iaW5kIG9yIHRoZSBjb2xvbiBzaG9ydGhhbmQgaW5zdGVhZC4gRm9yIGV4YW1wbGUsICcgKwogICAgICAgICAgICAgICdpbnN0ZWFkIG9mIDxkaXYgaWQ9Int7IHZhbCB9fSI+LCB1c2UgPGRpdiA6aWQ9InZhbCI+LicKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYWRkQXR0cihlbCwgbmFtZSwgSlNPTi5zdHJpbmdpZnkodmFsdWUpKTsKICAgICAgICAvLyAjNjg4NyBmaXJlZm94IGRvZXNuJ3QgdXBkYXRlIG11dGVkIHN0YXRlIGlmIHNldCB2aWEgYXR0cmlidXRlCiAgICAgICAgLy8gZXZlbiBpbW1lZGlhdGVseSBhZnRlciBlbGVtZW50IGNyZWF0aW9uCiAgICAgICAgaWYgKCFlbC5jb21wb25lbnQgJiYKICAgICAgICAgICAgbmFtZSA9PT0gJ211dGVkJyAmJgogICAgICAgICAgICBwbGF0Zm9ybU11c3RVc2VQcm9wKGVsLnRhZywgZWwuYXR0cnNNYXAudHlwZSwgbmFtZSkpIHsKICAgICAgICAgIGFkZFByb3AoZWwsIG5hbWUsICd0cnVlJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjaGVja0luRm9yIChlbCkgewogICAgdmFyIHBhcmVudCA9IGVsOwogICAgd2hpbGUgKHBhcmVudCkgewogICAgICBpZiAocGFyZW50LmZvciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHRydWUKICAgICAgfQogICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50OwogICAgfQogICAgcmV0dXJuIGZhbHNlCiAgfQoKICBmdW5jdGlvbiBwYXJzZU1vZGlmaWVycyAobmFtZSkgewogICAgdmFyIG1hdGNoID0gbmFtZS5tYXRjaChtb2RpZmllclJFKTsKICAgIGlmIChtYXRjaCkgewogICAgICB2YXIgcmV0ID0ge307CiAgICAgIG1hdGNoLmZvckVhY2goZnVuY3Rpb24gKG0pIHsgcmV0W20uc2xpY2UoMSldID0gdHJ1ZTsgfSk7CiAgICAgIHJldHVybiByZXQKICAgIH0KICB9CgogIGZ1bmN0aW9uIG1ha2VBdHRyc01hcCAoYXR0cnMpIHsKICAgIHZhciBtYXAgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gYXR0cnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGlmICgKICAgICAgICBtYXBbYXR0cnNbaV0ubmFtZV0gJiYgIWlzSUUgJiYgIWlzRWRnZQogICAgICApIHsKICAgICAgICB3YXJuJDIoJ2R1cGxpY2F0ZSBhdHRyaWJ1dGU6ICcgKyBhdHRyc1tpXS5uYW1lKTsKICAgICAgfQogICAgICBtYXBbYXR0cnNbaV0ubmFtZV0gPSBhdHRyc1tpXS52YWx1ZTsKICAgIH0KICAgIHJldHVybiBtYXAKICB9CgogIC8vIGZvciBzY3JpcHQgKGUuZy4gdHlwZT0ieC90ZW1wbGF0ZSIpIG9yIHN0eWxlLCBkbyBub3QgZGVjb2RlIGNvbnRlbnQKICBmdW5jdGlvbiBpc1RleHRUYWcgKGVsKSB7CiAgICByZXR1cm4gZWwudGFnID09PSAnc2NyaXB0JyB8fCBlbC50YWcgPT09ICdzdHlsZScKICB9CgogIGZ1bmN0aW9uIGlzRm9yYmlkZGVuVGFnIChlbCkgewogICAgcmV0dXJuICgKICAgICAgZWwudGFnID09PSAnc3R5bGUnIHx8CiAgICAgIChlbC50YWcgPT09ICdzY3JpcHQnICYmICgKICAgICAgICAhZWwuYXR0cnNNYXAudHlwZSB8fAogICAgICAgIGVsLmF0dHJzTWFwLnR5cGUgPT09ICd0ZXh0L2phdmFzY3JpcHQnCiAgICAgICkpCiAgICApCiAgfQoKICB2YXIgaWVOU0J1ZyA9IC9eeG1sbnM6TlNcZCsvOwogIHZhciBpZU5TUHJlZml4ID0gL15OU1xkKzovOwoKICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogIGZ1bmN0aW9uIGd1YXJkSUVTVkdCdWcgKGF0dHJzKSB7CiAgICB2YXIgcmVzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGF0dHJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBhdHRyID0gYXR0cnNbaV07CiAgICAgIGlmICghaWVOU0J1Zy50ZXN0KGF0dHIubmFtZSkpIHsKICAgICAgICBhdHRyLm5hbWUgPSBhdHRyLm5hbWUucmVwbGFjZShpZU5TUHJlZml4LCAnJyk7CiAgICAgICAgcmVzLnB1c2goYXR0cik7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXMKICB9CgogIGZ1bmN0aW9uIGNoZWNrRm9yQWxpYXNNb2RlbCAoZWwsIHZhbHVlKSB7CiAgICB2YXIgX2VsID0gZWw7CiAgICB3aGlsZSAoX2VsKSB7CiAgICAgIGlmIChfZWwuZm9yICYmIF9lbC5hbGlhcyA9PT0gdmFsdWUpIHsKICAgICAgICB3YXJuJDIoCiAgICAgICAgICAiPCIgKyAoZWwudGFnKSArICIgdi1tb2RlbD1cIiIgKyB2YWx1ZSArICJcIj46ICIgKwogICAgICAgICAgIllvdSBhcmUgYmluZGluZyB2LW1vZGVsIGRpcmVjdGx5IHRvIGEgdi1mb3IgaXRlcmF0aW9uIGFsaWFzLiAiICsKICAgICAgICAgICJUaGlzIHdpbGwgbm90IGJlIGFibGUgdG8gbW9kaWZ5IHRoZSB2LWZvciBzb3VyY2UgYXJyYXkgYmVjYXVzZSAiICsKICAgICAgICAgICJ3cml0aW5nIHRvIHRoZSBhbGlhcyBpcyBsaWtlIG1vZGlmeWluZyBhIGZ1bmN0aW9uIGxvY2FsIHZhcmlhYmxlLiAiICsKICAgICAgICAgICJDb25zaWRlciB1c2luZyBhbiBhcnJheSBvZiBvYmplY3RzIGFuZCB1c2Ugdi1tb2RlbCBvbiBhbiBvYmplY3QgcHJvcGVydHkgaW5zdGVhZC4iCiAgICAgICAgKTsKICAgICAgfQogICAgICBfZWwgPSBfZWwucGFyZW50OwogICAgfQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIHByZVRyYW5zZm9ybU5vZGUgKGVsLCBvcHRpb25zKSB7CiAgICBpZiAoZWwudGFnID09PSAnaW5wdXQnKSB7CiAgICAgIHZhciBtYXAgPSBlbC5hdHRyc01hcDsKICAgICAgaWYgKCFtYXBbJ3YtbW9kZWwnXSkgewogICAgICAgIHJldHVybgogICAgICB9CgogICAgICB2YXIgdHlwZUJpbmRpbmc7CiAgICAgIGlmIChtYXBbJzp0eXBlJ10gfHwgbWFwWyd2LWJpbmQ6dHlwZSddKSB7CiAgICAgICAgdHlwZUJpbmRpbmcgPSBnZXRCaW5kaW5nQXR0cihlbCwgJ3R5cGUnKTsKICAgICAgfQogICAgICBpZiAoIW1hcC50eXBlICYmICF0eXBlQmluZGluZyAmJiBtYXBbJ3YtYmluZCddKSB7CiAgICAgICAgdHlwZUJpbmRpbmcgPSAiKCIgKyAobWFwWyd2LWJpbmQnXSkgKyAiKS50eXBlIjsKICAgICAgfQoKICAgICAgaWYgKHR5cGVCaW5kaW5nKSB7CiAgICAgICAgdmFyIGlmQ29uZGl0aW9uID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3YtaWYnLCB0cnVlKTsKICAgICAgICB2YXIgaWZDb25kaXRpb25FeHRyYSA9IGlmQ29uZGl0aW9uID8gKCImJigiICsgaWZDb25kaXRpb24gKyAiKSIpIDogIiI7CiAgICAgICAgdmFyIGhhc0Vsc2UgPSBnZXRBbmRSZW1vdmVBdHRyKGVsLCAndi1lbHNlJywgdHJ1ZSkgIT0gbnVsbDsKICAgICAgICB2YXIgZWxzZUlmQ29uZGl0aW9uID0gZ2V0QW5kUmVtb3ZlQXR0cihlbCwgJ3YtZWxzZS1pZicsIHRydWUpOwogICAgICAgIC8vIDEuIGNoZWNrYm94CiAgICAgICAgdmFyIGJyYW5jaDAgPSBjbG9uZUFTVEVsZW1lbnQoZWwpOwogICAgICAgIC8vIHByb2Nlc3MgZm9yIG9uIHRoZSBtYWluIG5vZGUKICAgICAgICBwcm9jZXNzRm9yKGJyYW5jaDApOwogICAgICAgIGFkZFJhd0F0dHIoYnJhbmNoMCwgJ3R5cGUnLCAnY2hlY2tib3gnKTsKICAgICAgICBwcm9jZXNzRWxlbWVudChicmFuY2gwLCBvcHRpb25zKTsKICAgICAgICBicmFuY2gwLnByb2Nlc3NlZCA9IHRydWU7IC8vIHByZXZlbnQgaXQgZnJvbSBkb3VibGUtcHJvY2Vzc2VkCiAgICAgICAgYnJhbmNoMC5pZiA9ICIoIiArIHR5cGVCaW5kaW5nICsgIik9PT0nY2hlY2tib3gnIiArIGlmQ29uZGl0aW9uRXh0cmE7CiAgICAgICAgYWRkSWZDb25kaXRpb24oYnJhbmNoMCwgewogICAgICAgICAgZXhwOiBicmFuY2gwLmlmLAogICAgICAgICAgYmxvY2s6IGJyYW5jaDAKICAgICAgICB9KTsKICAgICAgICAvLyAyLiBhZGQgcmFkaW8gZWxzZS1pZiBjb25kaXRpb24KICAgICAgICB2YXIgYnJhbmNoMSA9IGNsb25lQVNURWxlbWVudChlbCk7CiAgICAgICAgZ2V0QW5kUmVtb3ZlQXR0cihicmFuY2gxLCAndi1mb3InLCB0cnVlKTsKICAgICAgICBhZGRSYXdBdHRyKGJyYW5jaDEsICd0eXBlJywgJ3JhZGlvJyk7CiAgICAgICAgcHJvY2Vzc0VsZW1lbnQoYnJhbmNoMSwgb3B0aW9ucyk7CiAgICAgICAgYWRkSWZDb25kaXRpb24oYnJhbmNoMCwgewogICAgICAgICAgZXhwOiAiKCIgKyB0eXBlQmluZGluZyArICIpPT09J3JhZGlvJyIgKyBpZkNvbmRpdGlvbkV4dHJhLAogICAgICAgICAgYmxvY2s6IGJyYW5jaDEKICAgICAgICB9KTsKICAgICAgICAvLyAzLiBvdGhlcgogICAgICAgIHZhciBicmFuY2gyID0gY2xvbmVBU1RFbGVtZW50KGVsKTsKICAgICAgICBnZXRBbmRSZW1vdmVBdHRyKGJyYW5jaDIsICd2LWZvcicsIHRydWUpOwogICAgICAgIGFkZFJhd0F0dHIoYnJhbmNoMiwgJzp0eXBlJywgdHlwZUJpbmRpbmcpOwogICAgICAgIHByb2Nlc3NFbGVtZW50KGJyYW5jaDIsIG9wdGlvbnMpOwogICAgICAgIGFkZElmQ29uZGl0aW9uKGJyYW5jaDAsIHsKICAgICAgICAgIGV4cDogaWZDb25kaXRpb24sCiAgICAgICAgICBibG9jazogYnJhbmNoMgogICAgICAgIH0pOwoKICAgICAgICBpZiAoaGFzRWxzZSkgewogICAgICAgICAgYnJhbmNoMC5lbHNlID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKGVsc2VJZkNvbmRpdGlvbikgewogICAgICAgICAgYnJhbmNoMC5lbHNlaWYgPSBlbHNlSWZDb25kaXRpb247CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYnJhbmNoMAogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjbG9uZUFTVEVsZW1lbnQgKGVsKSB7CiAgICByZXR1cm4gY3JlYXRlQVNURWxlbWVudChlbC50YWcsIGVsLmF0dHJzTGlzdC5zbGljZSgpLCBlbC5wYXJlbnQpCiAgfQoKICB2YXIgbW9kZWwkMSA9IHsKICAgIHByZVRyYW5zZm9ybU5vZGU6IHByZVRyYW5zZm9ybU5vZGUKICB9OwoKICB2YXIgbW9kdWxlcyQxID0gWwogICAga2xhc3MkMSwKICAgIHN0eWxlJDEsCiAgICBtb2RlbCQxCiAgXTsKCiAgLyogICovCgogIGZ1bmN0aW9uIHRleHQgKGVsLCBkaXIpIHsKICAgIGlmIChkaXIudmFsdWUpIHsKICAgICAgYWRkUHJvcChlbCwgJ3RleHRDb250ZW50JywgKCJfcygiICsgKGRpci52YWx1ZSkgKyAiKSIpKTsKICAgIH0KICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBodG1sIChlbCwgZGlyKSB7CiAgICBpZiAoZGlyLnZhbHVlKSB7CiAgICAgIGFkZFByb3AoZWwsICdpbm5lckhUTUwnLCAoIl9zKCIgKyAoZGlyLnZhbHVlKSArICIpIikpOwogICAgfQogIH0KCiAgdmFyIGRpcmVjdGl2ZXMkMSA9IHsKICAgIG1vZGVsOiBtb2RlbCwKICAgIHRleHQ6IHRleHQsCiAgICBodG1sOiBodG1sCiAgfTsKCiAgLyogICovCgogIHZhciBiYXNlT3B0aW9ucyA9IHsKICAgIGV4cGVjdEhUTUw6IHRydWUsCiAgICBtb2R1bGVzOiBtb2R1bGVzJDEsCiAgICBkaXJlY3RpdmVzOiBkaXJlY3RpdmVzJDEsCiAgICBpc1ByZVRhZzogaXNQcmVUYWcsCiAgICBpc1VuYXJ5VGFnOiBpc1VuYXJ5VGFnLAogICAgbXVzdFVzZVByb3A6IG11c3RVc2VQcm9wLAogICAgY2FuQmVMZWZ0T3BlblRhZzogY2FuQmVMZWZ0T3BlblRhZywKICAgIGlzUmVzZXJ2ZWRUYWc6IGlzUmVzZXJ2ZWRUYWcsCiAgICBnZXRUYWdOYW1lc3BhY2U6IGdldFRhZ05hbWVzcGFjZSwKICAgIHN0YXRpY0tleXM6IGdlblN0YXRpY0tleXMobW9kdWxlcyQxKQogIH07CgogIC8qICAqLwoKICB2YXIgaXNTdGF0aWNLZXk7CiAgdmFyIGlzUGxhdGZvcm1SZXNlcnZlZFRhZzsKCiAgdmFyIGdlblN0YXRpY0tleXNDYWNoZWQgPSBjYWNoZWQoZ2VuU3RhdGljS2V5cyQxKTsKCiAgLyoqCiAgICogR29hbCBvZiB0aGUgb3B0aW1pemVyOiB3YWxrIHRoZSBnZW5lcmF0ZWQgdGVtcGxhdGUgQVNUIHRyZWUKICAgKiBhbmQgZGV0ZWN0IHN1Yi10cmVlcyB0aGF0IGFyZSBwdXJlbHkgc3RhdGljLCBpLmUuIHBhcnRzIG9mCiAgICogdGhlIERPTSB0aGF0IG5ldmVyIG5lZWRzIHRvIGNoYW5nZS4KICAgKgogICAqIE9uY2Ugd2UgZGV0ZWN0IHRoZXNlIHN1Yi10cmVlcywgd2UgY2FuOgogICAqCiAgICogMS4gSG9pc3QgdGhlbSBpbnRvIGNvbnN0YW50cywgc28gdGhhdCB3ZSBubyBsb25nZXIgbmVlZCB0bwogICAqICAgIGNyZWF0ZSBmcmVzaCBub2RlcyBmb3IgdGhlbSBvbiBlYWNoIHJlLXJlbmRlcjsKICAgKiAyLiBDb21wbGV0ZWx5IHNraXAgdGhlbSBpbiB0aGUgcGF0Y2hpbmcgcHJvY2Vzcy4KICAgKi8KICBmdW5jdGlvbiBvcHRpbWl6ZSAocm9vdCwgb3B0aW9ucykgewogICAgaWYgKCFyb290KSB7IHJldHVybiB9CiAgICBpc1N0YXRpY0tleSA9IGdlblN0YXRpY0tleXNDYWNoZWQob3B0aW9ucy5zdGF0aWNLZXlzIHx8ICcnKTsKICAgIGlzUGxhdGZvcm1SZXNlcnZlZFRhZyA9IG9wdGlvbnMuaXNSZXNlcnZlZFRhZyB8fCBubzsKICAgIC8vIGZpcnN0IHBhc3M6IG1hcmsgYWxsIG5vbi1zdGF0aWMgbm9kZXMuCiAgICBtYXJrU3RhdGljJDEocm9vdCk7CiAgICAvLyBzZWNvbmQgcGFzczogbWFyayBzdGF0aWMgcm9vdHMuCiAgICBtYXJrU3RhdGljUm9vdHMocm9vdCwgZmFsc2UpOwogIH0KCiAgZnVuY3Rpb24gZ2VuU3RhdGljS2V5cyQxIChrZXlzKSB7CiAgICByZXR1cm4gbWFrZU1hcCgKICAgICAgJ3R5cGUsdGFnLGF0dHJzTGlzdCxhdHRyc01hcCxwbGFpbixwYXJlbnQsY2hpbGRyZW4sYXR0cnMnICsKICAgICAgKGtleXMgPyAnLCcgKyBrZXlzIDogJycpCiAgICApCiAgfQoKICBmdW5jdGlvbiBtYXJrU3RhdGljJDEgKG5vZGUpIHsKICAgIG5vZGUuc3RhdGljID0gaXNTdGF0aWMobm9kZSk7CiAgICBpZiAobm9kZS50eXBlID09PSAxKSB7CiAgICAgIC8vIGRvIG5vdCBtYWtlIGNvbXBvbmVudCBzbG90IGNvbnRlbnQgc3RhdGljLiB0aGlzIGF2b2lkcwogICAgICAvLyAxLiBjb21wb25lbnRzIG5vdCBhYmxlIHRvIG11dGF0ZSBzbG90IG5vZGVzCiAgICAgIC8vIDIuIHN0YXRpYyBzbG90IGNvbnRlbnQgZmFpbHMgZm9yIGhvdC1yZWxvYWRpbmcKICAgICAgaWYgKAogICAgICAgICFpc1BsYXRmb3JtUmVzZXJ2ZWRUYWcobm9kZS50YWcpICYmCiAgICAgICAgbm9kZS50YWcgIT09ICdzbG90JyAmJgogICAgICAgIG5vZGUuYXR0cnNNYXBbJ2lubGluZS10ZW1wbGF0ZSddID09IG51bGwKICAgICAgKSB7CiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGRyZW5baV07CiAgICAgICAgbWFya1N0YXRpYyQxKGNoaWxkKTsKICAgICAgICBpZiAoIWNoaWxkLnN0YXRpYykgewogICAgICAgICAgbm9kZS5zdGF0aWMgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKG5vZGUuaWZDb25kaXRpb25zKSB7CiAgICAgICAgZm9yICh2YXIgaSQxID0gMSwgbCQxID0gbm9kZS5pZkNvbmRpdGlvbnMubGVuZ3RoOyBpJDEgPCBsJDE7IGkkMSsrKSB7CiAgICAgICAgICB2YXIgYmxvY2sgPSBub2RlLmlmQ29uZGl0aW9uc1tpJDFdLmJsb2NrOwogICAgICAgICAgbWFya1N0YXRpYyQxKGJsb2NrKTsKICAgICAgICAgIGlmICghYmxvY2suc3RhdGljKSB7CiAgICAgICAgICAgIG5vZGUuc3RhdGljID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBtYXJrU3RhdGljUm9vdHMgKG5vZGUsIGlzSW5Gb3IpIHsKICAgIGlmIChub2RlLnR5cGUgPT09IDEpIHsKICAgICAgaWYgKG5vZGUuc3RhdGljIHx8IG5vZGUub25jZSkgewogICAgICAgIG5vZGUuc3RhdGljSW5Gb3IgPSBpc0luRm9yOwogICAgICB9CiAgICAgIC8vIEZvciBhIG5vZGUgdG8gcXVhbGlmeSBhcyBhIHN0YXRpYyByb290LCBpdCBzaG91bGQgaGF2ZSBjaGlsZHJlbiB0aGF0CiAgICAgIC8vIGFyZSBub3QganVzdCBzdGF0aWMgdGV4dC4gT3RoZXJ3aXNlIHRoZSBjb3N0IG9mIGhvaXN0aW5nIG91dCB3aWxsCiAgICAgIC8vIG91dHdlaWdoIHRoZSBiZW5lZml0cyBhbmQgaXQncyBiZXR0ZXIgb2ZmIHRvIGp1c3QgYWx3YXlzIHJlbmRlciBpdCBmcmVzaC4KICAgICAgaWYgKG5vZGUuc3RhdGljICYmIG5vZGUuY2hpbGRyZW4ubGVuZ3RoICYmICEoCiAgICAgICAgbm9kZS5jaGlsZHJlbi5sZW5ndGggPT09IDEgJiYKICAgICAgICBub2RlLmNoaWxkcmVuWzBdLnR5cGUgPT09IDMKICAgICAgKSkgewogICAgICAgIG5vZGUuc3RhdGljUm9vdCA9IHRydWU7CiAgICAgICAgcmV0dXJuCiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9kZS5zdGF0aWNSb290ID0gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKG5vZGUuY2hpbGRyZW4pIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBtYXJrU3RhdGljUm9vdHMobm9kZS5jaGlsZHJlbltpXSwgaXNJbkZvciB8fCAhIW5vZGUuZm9yKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKG5vZGUuaWZDb25kaXRpb25zKSB7CiAgICAgICAgZm9yICh2YXIgaSQxID0gMSwgbCQxID0gbm9kZS5pZkNvbmRpdGlvbnMubGVuZ3RoOyBpJDEgPCBsJDE7IGkkMSsrKSB7CiAgICAgICAgICBtYXJrU3RhdGljUm9vdHMobm9kZS5pZkNvbmRpdGlvbnNbaSQxXS5ibG9jaywgaXNJbkZvcik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc1N0YXRpYyAobm9kZSkgewogICAgaWYgKG5vZGUudHlwZSA9PT0gMikgeyAvLyBleHByZXNzaW9uCiAgICAgIHJldHVybiBmYWxzZQogICAgfQogICAgaWYgKG5vZGUudHlwZSA9PT0gMykgeyAvLyB0ZXh0CiAgICAgIHJldHVybiB0cnVlCiAgICB9CiAgICByZXR1cm4gISEobm9kZS5wcmUgfHwgKAogICAgICAhbm9kZS5oYXNCaW5kaW5ncyAmJiAvLyBubyBkeW5hbWljIGJpbmRpbmdzCiAgICAgICFub2RlLmlmICYmICFub2RlLmZvciAmJiAvLyBub3Qgdi1pZiBvciB2LWZvciBvciB2LWVsc2UKICAgICAgIWlzQnVpbHRJblRhZyhub2RlLnRhZykgJiYgLy8gbm90IGEgYnVpbHQtaW4KICAgICAgaXNQbGF0Zm9ybVJlc2VydmVkVGFnKG5vZGUudGFnKSAmJiAvLyBub3QgYSBjb21wb25lbnQKICAgICAgIWlzRGlyZWN0Q2hpbGRPZlRlbXBsYXRlRm9yKG5vZGUpICYmCiAgICAgIE9iamVjdC5rZXlzKG5vZGUpLmV2ZXJ5KGlzU3RhdGljS2V5KQogICAgKSkKICB9CgogIGZ1bmN0aW9uIGlzRGlyZWN0Q2hpbGRPZlRlbXBsYXRlRm9yIChub2RlKSB7CiAgICB3aGlsZSAobm9kZS5wYXJlbnQpIHsKICAgICAgbm9kZSA9IG5vZGUucGFyZW50OwogICAgICBpZiAobm9kZS50YWcgIT09ICd0ZW1wbGF0ZScpIHsKICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgfQogICAgICBpZiAobm9kZS5mb3IpIHsKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2UKICB9CgogIC8qICAqLwoKICB2YXIgZm5FeHBSRSA9IC9eKFtcdyRfXSt8XChbXildKj9cKSlccyo9PnxeZnVuY3Rpb25ccypcKC87CiAgdmFyIHNpbXBsZVBhdGhSRSA9IC9eW0EtWmEtel8kXVtcdyRdKig/OlwuW0EtWmEtel8kXVtcdyRdKnxcWydbXiddKj8nXXxcWyJbXiJdKj8iXXxcW1xkK118XFtbQS1aYS16XyRdW1x3JF0qXSkqJC87CgogIC8vIEtleWJvYXJkRXZlbnQua2V5Q29kZSBhbGlhc2VzCiAgdmFyIGtleUNvZGVzID0gewogICAgZXNjOiAyNywKICAgIHRhYjogOSwKICAgIGVudGVyOiAxMywKICAgIHNwYWNlOiAzMiwKICAgIHVwOiAzOCwKICAgIGxlZnQ6IDM3LAogICAgcmlnaHQ6IDM5LAogICAgZG93bjogNDAsCiAgICAnZGVsZXRlJzogWzgsIDQ2XQogIH07CgogIC8vIEtleWJvYXJkRXZlbnQua2V5IGFsaWFzZXMKICB2YXIga2V5TmFtZXMgPSB7CiAgICAvLyAjNzg4MDogSUUxMSBhbmQgRWRnZSB1c2UgYEVzY2AgZm9yIEVzY2FwZSBrZXkgbmFtZS4KICAgIGVzYzogWydFc2MnLCAnRXNjYXBlJ10sCiAgICB0YWI6ICdUYWInLAogICAgZW50ZXI6ICdFbnRlcicsCiAgICAvLyAjOTExMjogSUUxMSB1c2VzIGBTcGFjZWJhcmAgZm9yIFNwYWNlIGtleSBuYW1lLgogICAgc3BhY2U6IFsnICcsICdTcGFjZWJhciddLAogICAgLy8gIzc4MDY6IElFMTEgdXNlcyBrZXkgbmFtZXMgd2l0aG91dCBgQXJyb3dgIHByZWZpeCBmb3IgYXJyb3cga2V5cy4KICAgIHVwOiBbJ1VwJywgJ0Fycm93VXAnXSwKICAgIGxlZnQ6IFsnTGVmdCcsICdBcnJvd0xlZnQnXSwKICAgIHJpZ2h0OiBbJ1JpZ2h0JywgJ0Fycm93UmlnaHQnXSwKICAgIGRvd246IFsnRG93bicsICdBcnJvd0Rvd24nXSwKICAgIC8vICM5MTEyOiBJRTExIHVzZXMgYERlbGAgZm9yIERlbGV0ZSBrZXkgbmFtZS4KICAgICdkZWxldGUnOiBbJ0JhY2tzcGFjZScsICdEZWxldGUnLCAnRGVsJ10KICB9OwoKICAvLyAjNDg2ODogbW9kaWZpZXJzIHRoYXQgcHJldmVudCB0aGUgZXhlY3V0aW9uIG9mIHRoZSBsaXN0ZW5lcgogIC8vIG5lZWQgdG8gZXhwbGljaXRseSByZXR1cm4gbnVsbCBzbyB0aGF0IHdlIGNhbiBkZXRlcm1pbmUgd2hldGhlciB0byByZW1vdmUKICAvLyB0aGUgbGlzdGVuZXIgZm9yIC5vbmNlCiAgdmFyIGdlbkd1YXJkID0gZnVuY3Rpb24gKGNvbmRpdGlvbikgeyByZXR1cm4gKCJpZigiICsgY29uZGl0aW9uICsgIilyZXR1cm4gbnVsbDsiKTsgfTsKCiAgdmFyIG1vZGlmaWVyQ29kZSA9IHsKICAgIHN0b3A6ICckZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7JywKICAgIHByZXZlbnQ6ICckZXZlbnQucHJldmVudERlZmF1bHQoKTsnLAogICAgc2VsZjogZ2VuR3VhcmQoIiRldmVudC50YXJnZXQgIT09ICRldmVudC5jdXJyZW50VGFyZ2V0IiksCiAgICBjdHJsOiBnZW5HdWFyZCgiISRldmVudC5jdHJsS2V5IiksCiAgICBzaGlmdDogZ2VuR3VhcmQoIiEkZXZlbnQuc2hpZnRLZXkiKSwKICAgIGFsdDogZ2VuR3VhcmQoIiEkZXZlbnQuYWx0S2V5IiksCiAgICBtZXRhOiBnZW5HdWFyZCgiISRldmVudC5tZXRhS2V5IiksCiAgICBsZWZ0OiBnZW5HdWFyZCgiJ2J1dHRvbicgaW4gJGV2ZW50ICYmICRldmVudC5idXR0b24gIT09IDAiKSwKICAgIG1pZGRsZTogZ2VuR3VhcmQoIididXR0b24nIGluICRldmVudCAmJiAkZXZlbnQuYnV0dG9uICE9PSAxIiksCiAgICByaWdodDogZ2VuR3VhcmQoIididXR0b24nIGluICRldmVudCAmJiAkZXZlbnQuYnV0dG9uICE9PSAyIikKICB9OwoKICBmdW5jdGlvbiBnZW5IYW5kbGVycyAoCiAgICBldmVudHMsCiAgICBpc05hdGl2ZQogICkgewogICAgdmFyIHJlcyA9IGlzTmF0aXZlID8gJ25hdGl2ZU9uOnsnIDogJ29uOnsnOwogICAgZm9yICh2YXIgbmFtZSBpbiBldmVudHMpIHsKICAgICAgcmVzICs9ICJcIiIgKyBuYW1lICsgIlwiOiIgKyAoZ2VuSGFuZGxlcihuYW1lLCBldmVudHNbbmFtZV0pKSArICIsIjsKICAgIH0KICAgIHJldHVybiByZXMuc2xpY2UoMCwgLTEpICsgJ30nCiAgfQoKICBmdW5jdGlvbiBnZW5IYW5kbGVyICgKICAgIG5hbWUsCiAgICBoYW5kbGVyCiAgKSB7CiAgICBpZiAoIWhhbmRsZXIpIHsKICAgICAgcmV0dXJuICdmdW5jdGlvbigpe30nCiAgICB9CgogICAgaWYgKEFycmF5LmlzQXJyYXkoaGFuZGxlcikpIHsKICAgICAgcmV0dXJuICgiWyIgKyAoaGFuZGxlci5tYXAoZnVuY3Rpb24gKGhhbmRsZXIpIHsgcmV0dXJuIGdlbkhhbmRsZXIobmFtZSwgaGFuZGxlcik7IH0pLmpvaW4oJywnKSkgKyAiXSIpCiAgICB9CgogICAgdmFyIGlzTWV0aG9kUGF0aCA9IHNpbXBsZVBhdGhSRS50ZXN0KGhhbmRsZXIudmFsdWUpOwogICAgdmFyIGlzRnVuY3Rpb25FeHByZXNzaW9uID0gZm5FeHBSRS50ZXN0KGhhbmRsZXIudmFsdWUpOwoKICAgIGlmICghaGFuZGxlci5tb2RpZmllcnMpIHsKICAgICAgaWYgKGlzTWV0aG9kUGF0aCB8fCBpc0Z1bmN0aW9uRXhwcmVzc2lvbikgewogICAgICAgIHJldHVybiBoYW5kbGVyLnZhbHVlCiAgICAgIH0KICAgICAgcmV0dXJuICgiZnVuY3Rpb24oJGV2ZW50KXsiICsgKGhhbmRsZXIudmFsdWUpICsgIn0iKSAvLyBpbmxpbmUgc3RhdGVtZW50CiAgICB9IGVsc2UgewogICAgICB2YXIgY29kZSA9ICcnOwogICAgICB2YXIgZ2VuTW9kaWZpZXJDb2RlID0gJyc7CiAgICAgIHZhciBrZXlzID0gW107CiAgICAgIGZvciAodmFyIGtleSBpbiBoYW5kbGVyLm1vZGlmaWVycykgewogICAgICAgIGlmIChtb2RpZmllckNvZGVba2V5XSkgewogICAgICAgICAgZ2VuTW9kaWZpZXJDb2RlICs9IG1vZGlmaWVyQ29kZVtrZXldOwogICAgICAgICAgLy8gbGVmdC9yaWdodAogICAgICAgICAgaWYgKGtleUNvZGVzW2tleV0pIHsKICAgICAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdleGFjdCcpIHsKICAgICAgICAgIHZhciBtb2RpZmllcnMgPSAoaGFuZGxlci5tb2RpZmllcnMpOwogICAgICAgICAgZ2VuTW9kaWZpZXJDb2RlICs9IGdlbkd1YXJkKAogICAgICAgICAgICBbJ2N0cmwnLCAnc2hpZnQnLCAnYWx0JywgJ21ldGEnXQogICAgICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGtleU1vZGlmaWVyKSB7IHJldHVybiAhbW9kaWZpZXJzW2tleU1vZGlmaWVyXTsgfSkKICAgICAgICAgICAgICAubWFwKGZ1bmN0aW9uIChrZXlNb2RpZmllcikgeyByZXR1cm4gKCIkZXZlbnQuIiArIGtleU1vZGlmaWVyICsgIktleSIpOyB9KQogICAgICAgICAgICAgIC5qb2luKCd8fCcpCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGtleXMubGVuZ3RoKSB7CiAgICAgICAgY29kZSArPSBnZW5LZXlGaWx0ZXIoa2V5cyk7CiAgICAgIH0KICAgICAgLy8gTWFrZSBzdXJlIG1vZGlmaWVycyBsaWtlIHByZXZlbnQgYW5kIHN0b3AgZ2V0IGV4ZWN1dGVkIGFmdGVyIGtleSBmaWx0ZXJpbmcKICAgICAgaWYgKGdlbk1vZGlmaWVyQ29kZSkgewogICAgICAgIGNvZGUgKz0gZ2VuTW9kaWZpZXJDb2RlOwogICAgICB9CiAgICAgIHZhciBoYW5kbGVyQ29kZSA9IGlzTWV0aG9kUGF0aAogICAgICAgID8gKCJyZXR1cm4gIiArIChoYW5kbGVyLnZhbHVlKSArICIoJGV2ZW50KSIpCiAgICAgICAgOiBpc0Z1bmN0aW9uRXhwcmVzc2lvbgogICAgICAgICAgPyAoInJldHVybiAoIiArIChoYW5kbGVyLnZhbHVlKSArICIpKCRldmVudCkiKQogICAgICAgICAgOiBoYW5kbGVyLnZhbHVlOwogICAgICByZXR1cm4gKCJmdW5jdGlvbigkZXZlbnQpeyIgKyBjb2RlICsgaGFuZGxlckNvZGUgKyAifSIpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZW5LZXlGaWx0ZXIgKGtleXMpIHsKICAgIHJldHVybiAoImlmKCEoJ2J1dHRvbicgaW4gJGV2ZW50KSYmIiArIChrZXlzLm1hcChnZW5GaWx0ZXJDb2RlKS5qb2luKCcmJicpKSArICIpcmV0dXJuIG51bGw7IikKICB9CgogIGZ1bmN0aW9uIGdlbkZpbHRlckNvZGUgKGtleSkgewogICAgdmFyIGtleVZhbCA9IHBhcnNlSW50KGtleSwgMTApOwogICAgaWYgKGtleVZhbCkgewogICAgICByZXR1cm4gKCIkZXZlbnQua2V5Q29kZSE9PSIgKyBrZXlWYWwpCiAgICB9CiAgICB2YXIga2V5Q29kZSA9IGtleUNvZGVzW2tleV07CiAgICB2YXIga2V5TmFtZSA9IGtleU5hbWVzW2tleV07CiAgICByZXR1cm4gKAogICAgICAiX2soJGV2ZW50LmtleUNvZGUsIiArCiAgICAgIChKU09OLnN0cmluZ2lmeShrZXkpKSArICIsIiArCiAgICAgIChKU09OLnN0cmluZ2lmeShrZXlDb2RlKSkgKyAiLCIgKwogICAgICAiJGV2ZW50LmtleSwiICsKICAgICAgIiIgKyAoSlNPTi5zdHJpbmdpZnkoa2V5TmFtZSkpICsKICAgICAgIikiCiAgICApCiAgfQoKICAvKiAgKi8KCiAgZnVuY3Rpb24gb24gKGVsLCBkaXIpIHsKICAgIGlmIChkaXIubW9kaWZpZXJzKSB7CiAgICAgIHdhcm4oInYtb24gd2l0aG91dCBhcmd1bWVudCBkb2VzIG5vdCBzdXBwb3J0IG1vZGlmaWVycy4iKTsKICAgIH0KICAgIGVsLndyYXBMaXN0ZW5lcnMgPSBmdW5jdGlvbiAoY29kZSkgeyByZXR1cm4gKCJfZygiICsgY29kZSArICIsIiArIChkaXIudmFsdWUpICsgIikiKTsgfTsKICB9CgogIC8qICAqLwoKICBmdW5jdGlvbiBiaW5kJDEgKGVsLCBkaXIpIHsKICAgIGVsLndyYXBEYXRhID0gZnVuY3Rpb24gKGNvZGUpIHsKICAgICAgcmV0dXJuICgiX2IoIiArIGNvZGUgKyAiLCciICsgKGVsLnRhZykgKyAiJywiICsgKGRpci52YWx1ZSkgKyAiLCIgKyAoZGlyLm1vZGlmaWVycyAmJiBkaXIubW9kaWZpZXJzLnByb3AgPyAndHJ1ZScgOiAnZmFsc2UnKSArIChkaXIubW9kaWZpZXJzICYmIGRpci5tb2RpZmllcnMuc3luYyA/ICcsdHJ1ZScgOiAnJykgKyAiKSIpCiAgICB9OwogIH0KCiAgLyogICovCgogIHZhciBiYXNlRGlyZWN0aXZlcyA9IHsKICAgIG9uOiBvbiwKICAgIGJpbmQ6IGJpbmQkMSwKICAgIGNsb2FrOiBub29wCiAgfTsKCiAgLyogICovCgoKCgoKICB2YXIgQ29kZWdlblN0YXRlID0gZnVuY3Rpb24gQ29kZWdlblN0YXRlIChvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgdGhpcy53YXJuID0gb3B0aW9ucy53YXJuIHx8IGJhc2VXYXJuOwogICAgdGhpcy50cmFuc2Zvcm1zID0gcGx1Y2tNb2R1bGVGdW5jdGlvbihvcHRpb25zLm1vZHVsZXMsICd0cmFuc2Zvcm1Db2RlJyk7CiAgICB0aGlzLmRhdGFHZW5GbnMgPSBwbHVja01vZHVsZUZ1bmN0aW9uKG9wdGlvbnMubW9kdWxlcywgJ2dlbkRhdGEnKTsKICAgIHRoaXMuZGlyZWN0aXZlcyA9IGV4dGVuZChleHRlbmQoe30sIGJhc2VEaXJlY3RpdmVzKSwgb3B0aW9ucy5kaXJlY3RpdmVzKTsKICAgIHZhciBpc1Jlc2VydmVkVGFnID0gb3B0aW9ucy5pc1Jlc2VydmVkVGFnIHx8IG5vOwogICAgdGhpcy5tYXliZUNvbXBvbmVudCA9IGZ1bmN0aW9uIChlbCkgeyByZXR1cm4gIShpc1Jlc2VydmVkVGFnKGVsLnRhZykgJiYgIWVsLmNvbXBvbmVudCk7IH07CiAgICB0aGlzLm9uY2VJZCA9IDA7CiAgICB0aGlzLnN0YXRpY1JlbmRlckZucyA9IFtdOwogICAgdGhpcy5wcmUgPSBmYWxzZTsKICB9OwoKCgogIGZ1bmN0aW9uIGdlbmVyYXRlICgKICAgIGFzdCwKICAgIG9wdGlvbnMKICApIHsKICAgIHZhciBzdGF0ZSA9IG5ldyBDb2RlZ2VuU3RhdGUob3B0aW9ucyk7CiAgICB2YXIgY29kZSA9IGFzdCA/IGdlbkVsZW1lbnQoYXN0LCBzdGF0ZSkgOiAnX2MoImRpdiIpJzsKICAgIHJldHVybiB7CiAgICAgIHJlbmRlcjogKCJ3aXRoKHRoaXMpe3JldHVybiAiICsgY29kZSArICJ9IiksCiAgICAgIHN0YXRpY1JlbmRlckZuczogc3RhdGUuc3RhdGljUmVuZGVyRm5zCiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZW5FbGVtZW50IChlbCwgc3RhdGUpIHsKICAgIGlmIChlbC5wYXJlbnQpIHsKICAgICAgZWwucHJlID0gZWwucHJlIHx8IGVsLnBhcmVudC5wcmU7CiAgICB9CgogICAgaWYgKGVsLnN0YXRpY1Jvb3QgJiYgIWVsLnN0YXRpY1Byb2Nlc3NlZCkgewogICAgICByZXR1cm4gZ2VuU3RhdGljKGVsLCBzdGF0ZSkKICAgIH0gZWxzZSBpZiAoZWwub25jZSAmJiAhZWwub25jZVByb2Nlc3NlZCkgewogICAgICByZXR1cm4gZ2VuT25jZShlbCwgc3RhdGUpCiAgICB9IGVsc2UgaWYgKGVsLmZvciAmJiAhZWwuZm9yUHJvY2Vzc2VkKSB7CiAgICAgIHJldHVybiBnZW5Gb3IoZWwsIHN0YXRlKQogICAgfSBlbHNlIGlmIChlbC5pZiAmJiAhZWwuaWZQcm9jZXNzZWQpIHsKICAgICAgcmV0dXJuIGdlbklmKGVsLCBzdGF0ZSkKICAgIH0gZWxzZSBpZiAoZWwudGFnID09PSAndGVtcGxhdGUnICYmICFlbC5zbG90VGFyZ2V0ICYmICFzdGF0ZS5wcmUpIHsKICAgICAgcmV0dXJuIGdlbkNoaWxkcmVuKGVsLCBzdGF0ZSkgfHwgJ3ZvaWQgMCcKICAgIH0gZWxzZSBpZiAoZWwudGFnID09PSAnc2xvdCcpIHsKICAgICAgcmV0dXJuIGdlblNsb3QoZWwsIHN0YXRlKQogICAgfSBlbHNlIHsKICAgICAgLy8gY29tcG9uZW50IG9yIGVsZW1lbnQKICAgICAgdmFyIGNvZGU7CiAgICAgIGlmIChlbC5jb21wb25lbnQpIHsKICAgICAgICBjb2RlID0gZ2VuQ29tcG9uZW50KGVsLmNvbXBvbmVudCwgZWwsIHN0YXRlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZGF0YTsKICAgICAgICBpZiAoIWVsLnBsYWluIHx8IChlbC5wcmUgJiYgc3RhdGUubWF5YmVDb21wb25lbnQoZWwpKSkgewogICAgICAgICAgZGF0YSA9IGdlbkRhdGEkMihlbCwgc3RhdGUpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNoaWxkcmVuID0gZWwuaW5saW5lVGVtcGxhdGUgPyBudWxsIDogZ2VuQ2hpbGRyZW4oZWwsIHN0YXRlLCB0cnVlKTsKICAgICAgICBjb2RlID0gIl9jKCciICsgKGVsLnRhZykgKyAiJyIgKyAoZGF0YSA/ICgiLCIgKyBkYXRhKSA6ICcnKSArIChjaGlsZHJlbiA/ICgiLCIgKyBjaGlsZHJlbikgOiAnJykgKyAiKSI7CiAgICAgIH0KICAgICAgLy8gbW9kdWxlIHRyYW5zZm9ybXMKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGF0ZS50cmFuc2Zvcm1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29kZSA9IHN0YXRlLnRyYW5zZm9ybXNbaV0oZWwsIGNvZGUpOwogICAgICB9CiAgICAgIHJldHVybiBjb2RlCiAgICB9CiAgfQoKICAvLyBob2lzdCBzdGF0aWMgc3ViLXRyZWVzIG91dAogIGZ1bmN0aW9uIGdlblN0YXRpYyAoZWwsIHN0YXRlKSB7CiAgICBlbC5zdGF0aWNQcm9jZXNzZWQgPSB0cnVlOwogICAgLy8gU29tZSBlbGVtZW50cyAodGVtcGxhdGVzKSBuZWVkIHRvIGJlaGF2ZSBkaWZmZXJlbnRseSBpbnNpZGUgb2YgYSB2LXByZQogICAgLy8gbm9kZS4gIEFsbCBwcmUgbm9kZXMgYXJlIHN0YXRpYyByb290cywgc28gd2UgY2FuIHVzZSB0aGlzIGFzIGEgbG9jYXRpb24gdG8KICAgIC8vIHdyYXAgYSBzdGF0ZSBjaGFuZ2UgYW5kIHJlc2V0IGl0IHVwb24gZXhpdGluZyB0aGUgcHJlIG5vZGUuCiAgICB2YXIgb3JpZ2luYWxQcmVTdGF0ZSA9IHN0YXRlLnByZTsKICAgIGlmIChlbC5wcmUpIHsKICAgICAgc3RhdGUucHJlID0gZWwucHJlOwogICAgfQogICAgc3RhdGUuc3RhdGljUmVuZGVyRm5zLnB1c2goKCJ3aXRoKHRoaXMpe3JldHVybiAiICsgKGdlbkVsZW1lbnQoZWwsIHN0YXRlKSkgKyAifSIpKTsKICAgIHN0YXRlLnByZSA9IG9yaWdpbmFsUHJlU3RhdGU7CiAgICByZXR1cm4gKCJfbSgiICsgKHN0YXRlLnN0YXRpY1JlbmRlckZucy5sZW5ndGggLSAxKSArIChlbC5zdGF0aWNJbkZvciA/ICcsdHJ1ZScgOiAnJykgKyAiKSIpCiAgfQoKICAvLyB2LW9uY2UKICBmdW5jdGlvbiBnZW5PbmNlIChlbCwgc3RhdGUpIHsKICAgIGVsLm9uY2VQcm9jZXNzZWQgPSB0cnVlOwogICAgaWYgKGVsLmlmICYmICFlbC5pZlByb2Nlc3NlZCkgewogICAgICByZXR1cm4gZ2VuSWYoZWwsIHN0YXRlKQogICAgfSBlbHNlIGlmIChlbC5zdGF0aWNJbkZvcikgewogICAgICB2YXIga2V5ID0gJyc7CiAgICAgIHZhciBwYXJlbnQgPSBlbC5wYXJlbnQ7CiAgICAgIHdoaWxlIChwYXJlbnQpIHsKICAgICAgICBpZiAocGFyZW50LmZvcikgewogICAgICAgICAga2V5ID0gcGFyZW50LmtleTsKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgICAgIH0KICAgICAgaWYgKCFrZXkpIHsKICAgICAgICBzdGF0ZS53YXJuKAogICAgICAgICAgInYtb25jZSBjYW4gb25seSBiZSB1c2VkIGluc2lkZSB2LWZvciB0aGF0IGlzIGtleWVkLiAiCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gZ2VuRWxlbWVudChlbCwgc3RhdGUpCiAgICAgIH0KICAgICAgcmV0dXJuICgiX28oIiArIChnZW5FbGVtZW50KGVsLCBzdGF0ZSkpICsgIiwiICsgKHN0YXRlLm9uY2VJZCsrKSArICIsIiArIGtleSArICIpIikKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBnZW5TdGF0aWMoZWwsIHN0YXRlKQogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2VuSWYgKAogICAgZWwsCiAgICBzdGF0ZSwKICAgIGFsdEdlbiwKICAgIGFsdEVtcHR5CiAgKSB7CiAgICBlbC5pZlByb2Nlc3NlZCA9IHRydWU7IC8vIGF2b2lkIHJlY3Vyc2lvbgogICAgcmV0dXJuIGdlbklmQ29uZGl0aW9ucyhlbC5pZkNvbmRpdGlvbnMuc2xpY2UoKSwgc3RhdGUsIGFsdEdlbiwgYWx0RW1wdHkpCiAgfQoKICBmdW5jdGlvbiBnZW5JZkNvbmRpdGlvbnMgKAogICAgY29uZGl0aW9ucywKICAgIHN0YXRlLAogICAgYWx0R2VuLAogICAgYWx0RW1wdHkKICApIHsKICAgIGlmICghY29uZGl0aW9ucy5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGFsdEVtcHR5IHx8ICdfZSgpJwogICAgfQoKICAgIHZhciBjb25kaXRpb24gPSBjb25kaXRpb25zLnNoaWZ0KCk7CiAgICBpZiAoY29uZGl0aW9uLmV4cCkgewogICAgICByZXR1cm4gKCIoIiArIChjb25kaXRpb24uZXhwKSArICIpPyIgKyAoZ2VuVGVybmFyeUV4cChjb25kaXRpb24uYmxvY2spKSArICI6IiArIChnZW5JZkNvbmRpdGlvbnMoY29uZGl0aW9ucywgc3RhdGUsIGFsdEdlbiwgYWx0RW1wdHkpKSkKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAoIiIgKyAoZ2VuVGVybmFyeUV4cChjb25kaXRpb24uYmxvY2spKSkKICAgIH0KCiAgICAvLyB2LWlmIHdpdGggdi1vbmNlIHNob3VsZCBnZW5lcmF0ZSBjb2RlIGxpa2UgKGEpP19tKDApOl9tKDEpCiAgICBmdW5jdGlvbiBnZW5UZXJuYXJ5RXhwIChlbCkgewogICAgICByZXR1cm4gYWx0R2VuCiAgICAgICAgPyBhbHRHZW4oZWwsIHN0YXRlKQogICAgICAgIDogZWwub25jZQogICAgICAgICAgPyBnZW5PbmNlKGVsLCBzdGF0ZSkKICAgICAgICAgIDogZ2VuRWxlbWVudChlbCwgc3RhdGUpCiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZW5Gb3IgKAogICAgZWwsCiAgICBzdGF0ZSwKICAgIGFsdEdlbiwKICAgIGFsdEhlbHBlcgogICkgewogICAgdmFyIGV4cCA9IGVsLmZvcjsKICAgIHZhciBhbGlhcyA9IGVsLmFsaWFzOwogICAgdmFyIGl0ZXJhdG9yMSA9IGVsLml0ZXJhdG9yMSA/ICgiLCIgKyAoZWwuaXRlcmF0b3IxKSkgOiAnJzsKICAgIHZhciBpdGVyYXRvcjIgPSBlbC5pdGVyYXRvcjIgPyAoIiwiICsgKGVsLml0ZXJhdG9yMikpIDogJyc7CgogICAgaWYgKHN0YXRlLm1heWJlQ29tcG9uZW50KGVsKSAmJgogICAgICBlbC50YWcgIT09ICdzbG90JyAmJgogICAgICBlbC50YWcgIT09ICd0ZW1wbGF0ZScgJiYKICAgICAgIWVsLmtleQogICAgKSB7CiAgICAgIHN0YXRlLndhcm4oCiAgICAgICAgIjwiICsgKGVsLnRhZykgKyAiIHYtZm9yPVwiIiArIGFsaWFzICsgIiBpbiAiICsgZXhwICsgIlwiPjogY29tcG9uZW50IGxpc3RzIHJlbmRlcmVkIHdpdGggIiArCiAgICAgICAgInYtZm9yIHNob3VsZCBoYXZlIGV4cGxpY2l0IGtleXMuICIgKwogICAgICAgICJTZWUgaHR0cHM6Ly92dWVqcy5vcmcvZ3VpZGUvbGlzdC5odG1sI2tleSBmb3IgbW9yZSBpbmZvLiIsCiAgICAgICAgdHJ1ZSAvKiB0aXAgKi8KICAgICAgKTsKICAgIH0KCiAgICBlbC5mb3JQcm9jZXNzZWQgPSB0cnVlOyAvLyBhdm9pZCByZWN1cnNpb24KICAgIHJldHVybiAoYWx0SGVscGVyIHx8ICdfbCcpICsgIigoIiArIGV4cCArICIpLCIgKwogICAgICAiZnVuY3Rpb24oIiArIGFsaWFzICsgaXRlcmF0b3IxICsgaXRlcmF0b3IyICsgIil7IiArCiAgICAgICAgInJldHVybiAiICsgKChhbHRHZW4gfHwgZ2VuRWxlbWVudCkoZWwsIHN0YXRlKSkgKwogICAgICAnfSknCiAgfQoKICBmdW5jdGlvbiBnZW5EYXRhJDIgKGVsLCBzdGF0ZSkgewogICAgdmFyIGRhdGEgPSAneyc7CgogICAgLy8gZGlyZWN0aXZlcyBmaXJzdC4KICAgIC8vIGRpcmVjdGl2ZXMgbWF5IG11dGF0ZSB0aGUgZWwncyBvdGhlciBwcm9wZXJ0aWVzIGJlZm9yZSB0aGV5IGFyZSBnZW5lcmF0ZWQuCiAgICB2YXIgZGlycyA9IGdlbkRpcmVjdGl2ZXMoZWwsIHN0YXRlKTsKICAgIGlmIChkaXJzKSB7IGRhdGEgKz0gZGlycyArICcsJzsgfQoKICAgIC8vIGtleQogICAgaWYgKGVsLmtleSkgewogICAgICBkYXRhICs9ICJrZXk6IiArIChlbC5rZXkpICsgIiwiOwogICAgfQogICAgLy8gcmVmCiAgICBpZiAoZWwucmVmKSB7CiAgICAgIGRhdGEgKz0gInJlZjoiICsgKGVsLnJlZikgKyAiLCI7CiAgICB9CiAgICBpZiAoZWwucmVmSW5Gb3IpIHsKICAgICAgZGF0YSArPSAicmVmSW5Gb3I6dHJ1ZSwiOwogICAgfQogICAgLy8gcHJlCiAgICBpZiAoZWwucHJlKSB7CiAgICAgIGRhdGEgKz0gInByZTp0cnVlLCI7CiAgICB9CiAgICAvLyByZWNvcmQgb3JpZ2luYWwgdGFnIG5hbWUgZm9yIGNvbXBvbmVudHMgdXNpbmcgImlzIiBhdHRyaWJ1dGUKICAgIGlmIChlbC5jb21wb25lbnQpIHsKICAgICAgZGF0YSArPSAidGFnOlwiIiArIChlbC50YWcpICsgIlwiLCI7CiAgICB9CiAgICAvLyBtb2R1bGUgZGF0YSBnZW5lcmF0aW9uIGZ1bmN0aW9ucwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGF0ZS5kYXRhR2VuRm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgIGRhdGEgKz0gc3RhdGUuZGF0YUdlbkZuc1tpXShlbCk7CiAgICB9CiAgICAvLyBhdHRyaWJ1dGVzCiAgICBpZiAoZWwuYXR0cnMpIHsKICAgICAgZGF0YSArPSAiYXR0cnM6eyIgKyAoZ2VuUHJvcHMoZWwuYXR0cnMpKSArICJ9LCI7CiAgICB9CiAgICAvLyBET00gcHJvcHMKICAgIGlmIChlbC5wcm9wcykgewogICAgICBkYXRhICs9ICJkb21Qcm9wczp7IiArIChnZW5Qcm9wcyhlbC5wcm9wcykpICsgIn0sIjsKICAgIH0KICAgIC8vIGV2ZW50IGhhbmRsZXJzCiAgICBpZiAoZWwuZXZlbnRzKSB7CiAgICAgIGRhdGEgKz0gKGdlbkhhbmRsZXJzKGVsLmV2ZW50cywgZmFsc2UpKSArICIsIjsKICAgIH0KICAgIGlmIChlbC5uYXRpdmVFdmVudHMpIHsKICAgICAgZGF0YSArPSAoZ2VuSGFuZGxlcnMoZWwubmF0aXZlRXZlbnRzLCB0cnVlKSkgKyAiLCI7CiAgICB9CiAgICAvLyBzbG90IHRhcmdldAogICAgLy8gb25seSBmb3Igbm9uLXNjb3BlZCBzbG90cwogICAgaWYgKGVsLnNsb3RUYXJnZXQgJiYgIWVsLnNsb3RTY29wZSkgewogICAgICBkYXRhICs9ICJzbG90OiIgKyAoZWwuc2xvdFRhcmdldCkgKyAiLCI7CiAgICB9CiAgICAvLyBzY29wZWQgc2xvdHMKICAgIGlmIChlbC5zY29wZWRTbG90cykgewogICAgICBkYXRhICs9IChnZW5TY29wZWRTbG90cyhlbC5zY29wZWRTbG90cywgc3RhdGUpKSArICIsIjsKICAgIH0KICAgIC8vIGNvbXBvbmVudCB2LW1vZGVsCiAgICBpZiAoZWwubW9kZWwpIHsKICAgICAgZGF0YSArPSAibW9kZWw6e3ZhbHVlOiIgKyAoZWwubW9kZWwudmFsdWUpICsgIixjYWxsYmFjazoiICsgKGVsLm1vZGVsLmNhbGxiYWNrKSArICIsZXhwcmVzc2lvbjoiICsgKGVsLm1vZGVsLmV4cHJlc3Npb24pICsgIn0sIjsKICAgIH0KICAgIC8vIGlubGluZS10ZW1wbGF0ZQogICAgaWYgKGVsLmlubGluZVRlbXBsYXRlKSB7CiAgICAgIHZhciBpbmxpbmVUZW1wbGF0ZSA9IGdlbklubGluZVRlbXBsYXRlKGVsLCBzdGF0ZSk7CiAgICAgIGlmIChpbmxpbmVUZW1wbGF0ZSkgewogICAgICAgIGRhdGEgKz0gaW5saW5lVGVtcGxhdGUgKyAiLCI7CiAgICAgIH0KICAgIH0KICAgIGRhdGEgPSBkYXRhLnJlcGxhY2UoLywkLywgJycpICsgJ30nOwogICAgLy8gdi1iaW5kIGRhdGEgd3JhcAogICAgaWYgKGVsLndyYXBEYXRhKSB7CiAgICAgIGRhdGEgPSBlbC53cmFwRGF0YShkYXRhKTsKICAgIH0KICAgIC8vIHYtb24gZGF0YSB3cmFwCiAgICBpZiAoZWwud3JhcExpc3RlbmVycykgewogICAgICBkYXRhID0gZWwud3JhcExpc3RlbmVycyhkYXRhKTsKICAgIH0KICAgIHJldHVybiBkYXRhCiAgfQoKICBmdW5jdGlvbiBnZW5EaXJlY3RpdmVzIChlbCwgc3RhdGUpIHsKICAgIHZhciBkaXJzID0gZWwuZGlyZWN0aXZlczsKICAgIGlmICghZGlycykgeyByZXR1cm4gfQogICAgdmFyIHJlcyA9ICdkaXJlY3RpdmVzOlsnOwogICAgdmFyIGhhc1J1bnRpbWUgPSBmYWxzZTsKICAgIHZhciBpLCBsLCBkaXIsIG5lZWRSdW50aW1lOwogICAgZm9yIChpID0gMCwgbCA9IGRpcnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGRpciA9IGRpcnNbaV07CiAgICAgIG5lZWRSdW50aW1lID0gdHJ1ZTsKICAgICAgdmFyIGdlbiA9IHN0YXRlLmRpcmVjdGl2ZXNbZGlyLm5hbWVdOwogICAgICBpZiAoZ2VuKSB7CiAgICAgICAgLy8gY29tcGlsZS10aW1lIGRpcmVjdGl2ZSB0aGF0IG1hbmlwdWxhdGVzIEFTVC4KICAgICAgICAvLyByZXR1cm5zIHRydWUgaWYgaXQgYWxzbyBuZWVkcyBhIHJ1bnRpbWUgY291bnRlcnBhcnQuCiAgICAgICAgbmVlZFJ1bnRpbWUgPSAhIWdlbihlbCwgZGlyLCBzdGF0ZS53YXJuKTsKICAgICAgfQogICAgICBpZiAobmVlZFJ1bnRpbWUpIHsKICAgICAgICBoYXNSdW50aW1lID0gdHJ1ZTsKICAgICAgICByZXMgKz0gIntuYW1lOlwiIiArIChkaXIubmFtZSkgKyAiXCIscmF3TmFtZTpcIiIgKyAoZGlyLnJhd05hbWUpICsgIlwiIiArIChkaXIudmFsdWUgPyAoIix2YWx1ZTooIiArIChkaXIudmFsdWUpICsgIiksZXhwcmVzc2lvbjoiICsgKEpTT04uc3RyaW5naWZ5KGRpci52YWx1ZSkpKSA6ICcnKSArIChkaXIuYXJnID8gKCIsYXJnOlwiIiArIChkaXIuYXJnKSArICJcIiIpIDogJycpICsgKGRpci5tb2RpZmllcnMgPyAoIixtb2RpZmllcnM6IiArIChKU09OLnN0cmluZ2lmeShkaXIubW9kaWZpZXJzKSkpIDogJycpICsgIn0sIjsKICAgICAgfQogICAgfQogICAgaWYgKGhhc1J1bnRpbWUpIHsKICAgICAgcmV0dXJuIHJlcy5zbGljZSgwLCAtMSkgKyAnXScKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdlbklubGluZVRlbXBsYXRlIChlbCwgc3RhdGUpIHsKICAgIHZhciBhc3QgPSBlbC5jaGlsZHJlblswXTsKICAgIGlmIChlbC5jaGlsZHJlbi5sZW5ndGggIT09IDEgfHwgYXN0LnR5cGUgIT09IDEpIHsKICAgICAgc3RhdGUud2FybignSW5saW5lLXRlbXBsYXRlIGNvbXBvbmVudHMgbXVzdCBoYXZlIGV4YWN0bHkgb25lIGNoaWxkIGVsZW1lbnQuJyk7CiAgICB9CiAgICBpZiAoYXN0LnR5cGUgPT09IDEpIHsKICAgICAgdmFyIGlubGluZVJlbmRlckZucyA9IGdlbmVyYXRlKGFzdCwgc3RhdGUub3B0aW9ucyk7CiAgICAgIHJldHVybiAoImlubGluZVRlbXBsYXRlOntyZW5kZXI6ZnVuY3Rpb24oKXsiICsgKGlubGluZVJlbmRlckZucy5yZW5kZXIpICsgIn0sc3RhdGljUmVuZGVyRm5zOlsiICsgKGlubGluZVJlbmRlckZucy5zdGF0aWNSZW5kZXJGbnMubWFwKGZ1bmN0aW9uIChjb2RlKSB7IHJldHVybiAoImZ1bmN0aW9uKCl7IiArIGNvZGUgKyAifSIpOyB9KS5qb2luKCcsJykpICsgIl19IikKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdlblNjb3BlZFNsb3RzICgKICAgIHNsb3RzLAogICAgc3RhdGUKICApIHsKICAgIHJldHVybiAoInNjb3BlZFNsb3RzOl91KFsiICsgKE9iamVjdC5rZXlzKHNsb3RzKS5tYXAoZnVuY3Rpb24gKGtleSkgewogICAgICAgIHJldHVybiBnZW5TY29wZWRTbG90KGtleSwgc2xvdHNba2V5XSwgc3RhdGUpCiAgICAgIH0pLmpvaW4oJywnKSkgKyAiXSkiKQogIH0KCiAgZnVuY3Rpb24gZ2VuU2NvcGVkU2xvdCAoCiAgICBrZXksCiAgICBlbCwKICAgIHN0YXRlCiAgKSB7CiAgICBpZiAoZWwuZm9yICYmICFlbC5mb3JQcm9jZXNzZWQpIHsKICAgICAgcmV0dXJuIGdlbkZvclNjb3BlZFNsb3Qoa2V5LCBlbCwgc3RhdGUpCiAgICB9CiAgICB2YXIgZm4gPSAiZnVuY3Rpb24oIiArIChTdHJpbmcoZWwuc2xvdFNjb3BlKSkgKyAiKXsiICsKICAgICAgInJldHVybiAiICsgKGVsLnRhZyA9PT0gJ3RlbXBsYXRlJwogICAgICAgID8gZWwuaWYKICAgICAgICAgID8gKCIoIiArIChlbC5pZikgKyAiKT8iICsgKGdlbkNoaWxkcmVuKGVsLCBzdGF0ZSkgfHwgJ3VuZGVmaW5lZCcpICsgIjp1bmRlZmluZWQiKQogICAgICAgICAgOiBnZW5DaGlsZHJlbihlbCwgc3RhdGUpIHx8ICd1bmRlZmluZWQnCiAgICAgICAgOiBnZW5FbGVtZW50KGVsLCBzdGF0ZSkpICsgIn0iOwogICAgcmV0dXJuICgie2tleToiICsga2V5ICsgIixmbjoiICsgZm4gKyAifSIpCiAgfQoKICBmdW5jdGlvbiBnZW5Gb3JTY29wZWRTbG90ICgKICAgIGtleSwKICAgIGVsLAogICAgc3RhdGUKICApIHsKICAgIHZhciBleHAgPSBlbC5mb3I7CiAgICB2YXIgYWxpYXMgPSBlbC5hbGlhczsKICAgIHZhciBpdGVyYXRvcjEgPSBlbC5pdGVyYXRvcjEgPyAoIiwiICsgKGVsLml0ZXJhdG9yMSkpIDogJyc7CiAgICB2YXIgaXRlcmF0b3IyID0gZWwuaXRlcmF0b3IyID8gKCIsIiArIChlbC5pdGVyYXRvcjIpKSA6ICcnOwogICAgZWwuZm9yUHJvY2Vzc2VkID0gdHJ1ZTsgLy8gYXZvaWQgcmVjdXJzaW9uCiAgICByZXR1cm4gIl9sKCgiICsgZXhwICsgIiksIiArCiAgICAgICJmdW5jdGlvbigiICsgYWxpYXMgKyBpdGVyYXRvcjEgKyBpdGVyYXRvcjIgKyAiKXsiICsKICAgICAgICAicmV0dXJuICIgKyAoZ2VuU2NvcGVkU2xvdChrZXksIGVsLCBzdGF0ZSkpICsKICAgICAgJ30pJwogIH0KCiAgZnVuY3Rpb24gZ2VuQ2hpbGRyZW4gKAogICAgZWwsCiAgICBzdGF0ZSwKICAgIGNoZWNrU2tpcCwKICAgIGFsdEdlbkVsZW1lbnQsCiAgICBhbHRHZW5Ob2RlCiAgKSB7CiAgICB2YXIgY2hpbGRyZW4gPSBlbC5jaGlsZHJlbjsKICAgIGlmIChjaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgdmFyIGVsJDEgPSBjaGlsZHJlblswXTsKICAgICAgLy8gb3B0aW1pemUgc2luZ2xlIHYtZm9yCiAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPT09IDEgJiYKICAgICAgICBlbCQxLmZvciAmJgogICAgICAgIGVsJDEudGFnICE9PSAndGVtcGxhdGUnICYmCiAgICAgICAgZWwkMS50YWcgIT09ICdzbG90JwogICAgICApIHsKICAgICAgICB2YXIgbm9ybWFsaXphdGlvblR5cGUgPSBjaGVja1NraXAKICAgICAgICAgID8gc3RhdGUubWF5YmVDb21wb25lbnQoZWwkMSkgPyAiLDEiIDogIiwwIgogICAgICAgICAgOiAiIjsKICAgICAgICByZXR1cm4gKCIiICsgKChhbHRHZW5FbGVtZW50IHx8IGdlbkVsZW1lbnQpKGVsJDEsIHN0YXRlKSkgKyBub3JtYWxpemF0aW9uVHlwZSkKICAgICAgfQogICAgICB2YXIgbm9ybWFsaXphdGlvblR5cGUkMSA9IGNoZWNrU2tpcAogICAgICAgID8gZ2V0Tm9ybWFsaXphdGlvblR5cGUoY2hpbGRyZW4sIHN0YXRlLm1heWJlQ29tcG9uZW50KQogICAgICAgIDogMDsKICAgICAgdmFyIGdlbiA9IGFsdEdlbk5vZGUgfHwgZ2VuTm9kZTsKICAgICAgcmV0dXJuICgiWyIgKyAoY2hpbGRyZW4ubWFwKGZ1bmN0aW9uIChjKSB7IHJldHVybiBnZW4oYywgc3RhdGUpOyB9KS5qb2luKCcsJykpICsgIl0iICsgKG5vcm1hbGl6YXRpb25UeXBlJDEgPyAoIiwiICsgbm9ybWFsaXphdGlvblR5cGUkMSkgOiAnJykpCiAgICB9CiAgfQoKICAvLyBkZXRlcm1pbmUgdGhlIG5vcm1hbGl6YXRpb24gbmVlZGVkIGZvciB0aGUgY2hpbGRyZW4gYXJyYXkuCiAgLy8gMDogbm8gbm9ybWFsaXphdGlvbiBuZWVkZWQKICAvLyAxOiBzaW1wbGUgbm9ybWFsaXphdGlvbiBuZWVkZWQgKHBvc3NpYmxlIDEtbGV2ZWwgZGVlcCBuZXN0ZWQgYXJyYXkpCiAgLy8gMjogZnVsbCBub3JtYWxpemF0aW9uIG5lZWRlZAogIGZ1bmN0aW9uIGdldE5vcm1hbGl6YXRpb25UeXBlICgKICAgIGNoaWxkcmVuLAogICAgbWF5YmVDb21wb25lbnQKICApIHsKICAgIHZhciByZXMgPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICB2YXIgZWwgPSBjaGlsZHJlbltpXTsKICAgICAgaWYgKGVsLnR5cGUgIT09IDEpIHsKICAgICAgICBjb250aW51ZQogICAgICB9CiAgICAgIGlmIChuZWVkc05vcm1hbGl6YXRpb24oZWwpIHx8CiAgICAgICAgICAoZWwuaWZDb25kaXRpb25zICYmIGVsLmlmQ29uZGl0aW9ucy5zb21lKGZ1bmN0aW9uIChjKSB7IHJldHVybiBuZWVkc05vcm1hbGl6YXRpb24oYy5ibG9jayk7IH0pKSkgewogICAgICAgIHJlcyA9IDI7CiAgICAgICAgYnJlYWsKICAgICAgfQogICAgICBpZiAobWF5YmVDb21wb25lbnQoZWwpIHx8CiAgICAgICAgICAoZWwuaWZDb25kaXRpb25zICYmIGVsLmlmQ29uZGl0aW9ucy5zb21lKGZ1bmN0aW9uIChjKSB7IHJldHVybiBtYXliZUNvbXBvbmVudChjLmJsb2NrKTsgfSkpKSB7CiAgICAgICAgcmVzID0gMTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KCiAgZnVuY3Rpb24gbmVlZHNOb3JtYWxpemF0aW9uIChlbCkgewogICAgcmV0dXJuIGVsLmZvciAhPT0gdW5kZWZpbmVkIHx8IGVsLnRhZyA9PT0gJ3RlbXBsYXRlJyB8fCBlbC50YWcgPT09ICdzbG90JwogIH0KCiAgZnVuY3Rpb24gZ2VuTm9kZSAobm9kZSwgc3RhdGUpIHsKICAgIGlmIChub2RlLnR5cGUgPT09IDEpIHsKICAgICAgcmV0dXJuIGdlbkVsZW1lbnQobm9kZSwgc3RhdGUpCiAgICB9IGVsc2UgaWYgKG5vZGUudHlwZSA9PT0gMyAmJiBub2RlLmlzQ29tbWVudCkgewogICAgICByZXR1cm4gZ2VuQ29tbWVudChub2RlKQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGdlblRleHQobm9kZSkKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdlblRleHQgKHRleHQpIHsKICAgIHJldHVybiAoIl92KCIgKyAodGV4dC50eXBlID09PSAyCiAgICAgID8gdGV4dC5leHByZXNzaW9uIC8vIG5vIG5lZWQgZm9yICgpIGJlY2F1c2UgYWxyZWFkeSB3cmFwcGVkIGluIF9zKCkKICAgICAgOiB0cmFuc2Zvcm1TcGVjaWFsTmV3bGluZXMoSlNPTi5zdHJpbmdpZnkodGV4dC50ZXh0KSkpICsgIikiKQogIH0KCiAgZnVuY3Rpb24gZ2VuQ29tbWVudCAoY29tbWVudCkgewogICAgcmV0dXJuICgiX2UoIiArIChKU09OLnN0cmluZ2lmeShjb21tZW50LnRleHQpKSArICIpIikKICB9CgogIGZ1bmN0aW9uIGdlblNsb3QgKGVsLCBzdGF0ZSkgewogICAgdmFyIHNsb3ROYW1lID0gZWwuc2xvdE5hbWUgfHwgJyJkZWZhdWx0Iic7CiAgICB2YXIgY2hpbGRyZW4gPSBnZW5DaGlsZHJlbihlbCwgc3RhdGUpOwogICAgdmFyIHJlcyA9ICJfdCgiICsgc2xvdE5hbWUgKyAoY2hpbGRyZW4gPyAoIiwiICsgY2hpbGRyZW4pIDogJycpOwogICAgdmFyIGF0dHJzID0gZWwuYXR0cnMgJiYgKCJ7IiArIChlbC5hdHRycy5tYXAoZnVuY3Rpb24gKGEpIHsgcmV0dXJuICgoY2FtZWxpemUoYS5uYW1lKSkgKyAiOiIgKyAoYS52YWx1ZSkpOyB9KS5qb2luKCcsJykpICsgIn0iKTsKICAgIHZhciBiaW5kJCQxID0gZWwuYXR0cnNNYXBbJ3YtYmluZCddOwogICAgaWYgKChhdHRycyB8fCBiaW5kJCQxKSAmJiAhY2hpbGRyZW4pIHsKICAgICAgcmVzICs9ICIsbnVsbCI7CiAgICB9CiAgICBpZiAoYXR0cnMpIHsKICAgICAgcmVzICs9ICIsIiArIGF0dHJzOwogICAgfQogICAgaWYgKGJpbmQkJDEpIHsKICAgICAgcmVzICs9IChhdHRycyA/ICcnIDogJyxudWxsJykgKyAiLCIgKyBiaW5kJCQxOwogICAgfQogICAgcmV0dXJuIHJlcyArICcpJwogIH0KCiAgLy8gY29tcG9uZW50TmFtZSBpcyBlbC5jb21wb25lbnQsIHRha2UgaXQgYXMgYXJndW1lbnQgdG8gc2h1biBmbG93J3MgcGVzc2ltaXN0aWMgcmVmaW5lbWVudAogIGZ1bmN0aW9uIGdlbkNvbXBvbmVudCAoCiAgICBjb21wb25lbnROYW1lLAogICAgZWwsCiAgICBzdGF0ZQogICkgewogICAgdmFyIGNoaWxkcmVuID0gZWwuaW5saW5lVGVtcGxhdGUgPyBudWxsIDogZ2VuQ2hpbGRyZW4oZWwsIHN0YXRlLCB0cnVlKTsKICAgIHJldHVybiAoIl9jKCIgKyBjb21wb25lbnROYW1lICsgIiwiICsgKGdlbkRhdGEkMihlbCwgc3RhdGUpKSArIChjaGlsZHJlbiA/ICgiLCIgKyBjaGlsZHJlbikgOiAnJykgKyAiKSIpCiAgfQoKICBmdW5jdGlvbiBnZW5Qcm9wcyAocHJvcHMpIHsKICAgIHZhciByZXMgPSAnJzsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHByb3AgPSBwcm9wc1tpXTsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIHsKICAgICAgICByZXMgKz0gIlwiIiArIChwcm9wLm5hbWUpICsgIlwiOiIgKyAodHJhbnNmb3JtU3BlY2lhbE5ld2xpbmVzKHByb3AudmFsdWUpKSArICIsIjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlcy5zbGljZSgwLCAtMSkKICB9CgogIC8vICMzODk1LCAjNDI2OAogIGZ1bmN0aW9uIHRyYW5zZm9ybVNwZWNpYWxOZXdsaW5lcyAodGV4dCkgewogICAgcmV0dXJuIHRleHQKICAgICAgLnJlcGxhY2UoL1x1MjAyOC9nLCAnXFx1MjAyOCcpCiAgICAgIC5yZXBsYWNlKC9cdTIwMjkvZywgJ1xcdTIwMjknKQogIH0KCiAgLyogICovCgogIC8vIHRoZXNlIGtleXdvcmRzIHNob3VsZCBub3QgYXBwZWFyIGluc2lkZSBleHByZXNzaW9ucywgYnV0IG9wZXJhdG9ycyBsaWtlCiAgLy8gdHlwZW9mLCBpbnN0YW5jZW9mIGFuZCBpbiBhcmUgYWxsb3dlZAogIHZhciBwcm9oaWJpdGVkS2V5d29yZFJFID0gbmV3IFJlZ0V4cCgnXFxiJyArICgKICAgICdkbyxpZixmb3IsbGV0LG5ldyx0cnksdmFyLGNhc2UsZWxzZSx3aXRoLGF3YWl0LGJyZWFrLGNhdGNoLGNsYXNzLGNvbnN0LCcgKwogICAgJ3N1cGVyLHRocm93LHdoaWxlLHlpZWxkLGRlbGV0ZSxleHBvcnQsaW1wb3J0LHJldHVybixzd2l0Y2gsZGVmYXVsdCwnICsKICAgICdleHRlbmRzLGZpbmFsbHksY29udGludWUsZGVidWdnZXIsZnVuY3Rpb24sYXJndW1lbnRzJwogICkuc3BsaXQoJywnKS5qb2luKCdcXGJ8XFxiJykgKyAnXFxiJyk7CgogIC8vIHRoZXNlIHVuYXJ5IG9wZXJhdG9ycyBzaG91bGQgbm90IGJlIHVzZWQgYXMgcHJvcGVydHkvbWV0aG9kIG5hbWVzCiAgdmFyIHVuYXJ5T3BlcmF0b3JzUkUgPSBuZXcgUmVnRXhwKCdcXGInICsgKAogICAgJ2RlbGV0ZSx0eXBlb2Ysdm9pZCcKICApLnNwbGl0KCcsJykuam9pbignXFxzKlxcKFteXFwpXSpcXCl8XFxiJykgKyAnXFxzKlxcKFteXFwpXSpcXCknKTsKCiAgLy8gc3RyaXAgc3RyaW5ncyBpbiBleHByZXNzaW9ucwogIHZhciBzdHJpcFN0cmluZ1JFID0gLycoPzpbXidcXF18XFwuKSonfCIoPzpbXiJcXF18XFwuKSoifGAoPzpbXmBcXF18XFwuKSpcJFx7fFx9KD86W15gXFxdfFxcLikqYHxgKD86W15gXFxdfFxcLikqYC9nOwoKICAvLyBkZXRlY3QgcHJvYmxlbWF0aWMgZXhwcmVzc2lvbnMgaW4gYSB0ZW1wbGF0ZQogIGZ1bmN0aW9uIGRldGVjdEVycm9ycyAoYXN0KSB7CiAgICB2YXIgZXJyb3JzID0gW107CiAgICBpZiAoYXN0KSB7CiAgICAgIGNoZWNrTm9kZShhc3QsIGVycm9ycyk7CiAgICB9CiAgICByZXR1cm4gZXJyb3JzCiAgfQoKICBmdW5jdGlvbiBjaGVja05vZGUgKG5vZGUsIGVycm9ycykgewogICAgaWYgKG5vZGUudHlwZSA9PT0gMSkgewogICAgICBmb3IgKHZhciBuYW1lIGluIG5vZGUuYXR0cnNNYXApIHsKICAgICAgICBpZiAoZGlyUkUudGVzdChuYW1lKSkgewogICAgICAgICAgdmFyIHZhbHVlID0gbm9kZS5hdHRyc01hcFtuYW1lXTsKICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICBpZiAobmFtZSA9PT0gJ3YtZm9yJykgewogICAgICAgICAgICAgIGNoZWNrRm9yKG5vZGUsICgidi1mb3I9XCIiICsgdmFsdWUgKyAiXCIiKSwgZXJyb3JzKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChvblJFLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICBjaGVja0V2ZW50KHZhbHVlLCAobmFtZSArICI9XCIiICsgdmFsdWUgKyAiXCIiKSwgZXJyb3JzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjaGVja0V4cHJlc3Npb24odmFsdWUsIChuYW1lICsgIj1cIiIgKyB2YWx1ZSArICJcIiIpLCBlcnJvcnMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChub2RlLmNoaWxkcmVuKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjaGVja05vZGUobm9kZS5jaGlsZHJlbltpXSwgZXJyb3JzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSBpZiAobm9kZS50eXBlID09PSAyKSB7CiAgICAgIGNoZWNrRXhwcmVzc2lvbihub2RlLmV4cHJlc3Npb24sIG5vZGUudGV4dCwgZXJyb3JzKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNoZWNrRXZlbnQgKGV4cCwgdGV4dCwgZXJyb3JzKSB7CiAgICB2YXIgc3RpcHBlZCA9IGV4cC5yZXBsYWNlKHN0cmlwU3RyaW5nUkUsICcnKTsKICAgIHZhciBrZXl3b3JkTWF0Y2ggPSBzdGlwcGVkLm1hdGNoKHVuYXJ5T3BlcmF0b3JzUkUpOwogICAgaWYgKGtleXdvcmRNYXRjaCAmJiBzdGlwcGVkLmNoYXJBdChrZXl3b3JkTWF0Y2guaW5kZXggLSAxKSAhPT0gJyQnKSB7CiAgICAgIGVycm9ycy5wdXNoKAogICAgICAgICJhdm9pZCB1c2luZyBKYXZhU2NyaXB0IHVuYXJ5IG9wZXJhdG9yIGFzIHByb3BlcnR5IG5hbWU6ICIgKwogICAgICAgICJcIiIgKyAoa2V5d29yZE1hdGNoWzBdKSArICJcIiBpbiBleHByZXNzaW9uICIgKyAodGV4dC50cmltKCkpCiAgICAgICk7CiAgICB9CiAgICBjaGVja0V4cHJlc3Npb24oZXhwLCB0ZXh0LCBlcnJvcnMpOwogIH0KCiAgZnVuY3Rpb24gY2hlY2tGb3IgKG5vZGUsIHRleHQsIGVycm9ycykgewogICAgY2hlY2tFeHByZXNzaW9uKG5vZGUuZm9yIHx8ICcnLCB0ZXh0LCBlcnJvcnMpOwogICAgY2hlY2tJZGVudGlmaWVyKG5vZGUuYWxpYXMsICd2LWZvciBhbGlhcycsIHRleHQsIGVycm9ycyk7CiAgICBjaGVja0lkZW50aWZpZXIobm9kZS5pdGVyYXRvcjEsICd2LWZvciBpdGVyYXRvcicsIHRleHQsIGVycm9ycyk7CiAgICBjaGVja0lkZW50aWZpZXIobm9kZS5pdGVyYXRvcjIsICd2LWZvciBpdGVyYXRvcicsIHRleHQsIGVycm9ycyk7CiAgfQoKICBmdW5jdGlvbiBjaGVja0lkZW50aWZpZXIgKAogICAgaWRlbnQsCiAgICB0eXBlLAogICAgdGV4dCwKICAgIGVycm9ycwogICkgewogICAgaWYgKHR5cGVvZiBpZGVudCA9PT0gJ3N0cmluZycpIHsKICAgICAgdHJ5IHsKICAgICAgICBuZXcgRnVuY3Rpb24oKCJ2YXIgIiArIGlkZW50ICsgIj1fIikpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3JzLnB1c2goKCJpbnZhbGlkICIgKyB0eXBlICsgIiBcIiIgKyBpZGVudCArICJcIiBpbiBleHByZXNzaW9uOiAiICsgKHRleHQudHJpbSgpKSkpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjaGVja0V4cHJlc3Npb24gKGV4cCwgdGV4dCwgZXJyb3JzKSB7CiAgICB0cnkgewogICAgICBuZXcgRnVuY3Rpb24oKCJyZXR1cm4gIiArIGV4cCkpOwogICAgfSBjYXRjaCAoZSkgewogICAgICB2YXIga2V5d29yZE1hdGNoID0gZXhwLnJlcGxhY2Uoc3RyaXBTdHJpbmdSRSwgJycpLm1hdGNoKHByb2hpYml0ZWRLZXl3b3JkUkUpOwogICAgICBpZiAoa2V5d29yZE1hdGNoKSB7CiAgICAgICAgZXJyb3JzLnB1c2goCiAgICAgICAgICAiYXZvaWQgdXNpbmcgSmF2YVNjcmlwdCBrZXl3b3JkIGFzIHByb3BlcnR5IG5hbWU6ICIgKwogICAgICAgICAgIlwiIiArIChrZXl3b3JkTWF0Y2hbMF0pICsgIlwiXG4gIFJhdyBleHByZXNzaW9uOiAiICsgKHRleHQudHJpbSgpKQogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZXJyb3JzLnB1c2goCiAgICAgICAgICAiaW52YWxpZCBleHByZXNzaW9uOiAiICsgKGUubWVzc2FnZSkgKyAiIGluXG5cbiIgKwogICAgICAgICAgIiAgICAiICsgZXhwICsgIlxuXG4iICsKICAgICAgICAgICIgIFJhdyBleHByZXNzaW9uOiAiICsgKHRleHQudHJpbSgpKSArICJcbiIKICAgICAgICApOwogICAgICB9CiAgICB9CiAgfQoKICAvKiAgKi8KCgoKICBmdW5jdGlvbiBjcmVhdGVGdW5jdGlvbiAoY29kZSwgZXJyb3JzKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKGNvZGUpCiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgZXJyb3JzLnB1c2goeyBlcnI6IGVyciwgY29kZTogY29kZSB9KTsKICAgICAgcmV0dXJuIG5vb3AKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBpbGVUb0Z1bmN0aW9uRm4gKGNvbXBpbGUpIHsKICAgIHZhciBjYWNoZSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CgogICAgcmV0dXJuIGZ1bmN0aW9uIGNvbXBpbGVUb0Z1bmN0aW9ucyAoCiAgICAgIHRlbXBsYXRlLAogICAgICBvcHRpb25zLAogICAgICB2bQogICAgKSB7CiAgICAgIG9wdGlvbnMgPSBleHRlbmQoe30sIG9wdGlvbnMpOwogICAgICB2YXIgd2FybiQkMSA9IG9wdGlvbnMud2FybiB8fCB3YXJuOwogICAgICBkZWxldGUgb3B0aW9ucy53YXJuOwoKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIHsKICAgICAgICAvLyBkZXRlY3QgcG9zc2libGUgQ1NQIHJlc3RyaWN0aW9uCiAgICAgICAgdHJ5IHsKICAgICAgICAgIG5ldyBGdW5jdGlvbigncmV0dXJuIDEnKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBpZiAoZS50b1N0cmluZygpLm1hdGNoKC91bnNhZmUtZXZhbHxDU1AvKSkgewogICAgICAgICAgICB3YXJuJCQxKAogICAgICAgICAgICAgICdJdCBzZWVtcyB5b3UgYXJlIHVzaW5nIHRoZSBzdGFuZGFsb25lIGJ1aWxkIG9mIFZ1ZS5qcyBpbiBhbiAnICsKICAgICAgICAgICAgICAnZW52aXJvbm1lbnQgd2l0aCBDb250ZW50IFNlY3VyaXR5IFBvbGljeSB0aGF0IHByb2hpYml0cyB1bnNhZmUtZXZhbC4gJyArCiAgICAgICAgICAgICAgJ1RoZSB0ZW1wbGF0ZSBjb21waWxlciBjYW5ub3Qgd29yayBpbiB0aGlzIGVudmlyb25tZW50LiBDb25zaWRlciAnICsKICAgICAgICAgICAgICAncmVsYXhpbmcgdGhlIHBvbGljeSB0byBhbGxvdyB1bnNhZmUtZXZhbCBvciBwcmUtY29tcGlsaW5nIHlvdXIgJyArCiAgICAgICAgICAgICAgJ3RlbXBsYXRlcyBpbnRvIHJlbmRlciBmdW5jdGlvbnMuJwogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gY2hlY2sgY2FjaGUKICAgICAgdmFyIGtleSA9IG9wdGlvbnMuZGVsaW1pdGVycwogICAgICAgID8gU3RyaW5nKG9wdGlvbnMuZGVsaW1pdGVycykgKyB0ZW1wbGF0ZQogICAgICAgIDogdGVtcGxhdGU7CiAgICAgIGlmIChjYWNoZVtrZXldKSB7CiAgICAgICAgcmV0dXJuIGNhY2hlW2tleV0KICAgICAgfQoKICAgICAgLy8gY29tcGlsZQogICAgICB2YXIgY29tcGlsZWQgPSBjb21waWxlKHRlbXBsYXRlLCBvcHRpb25zKTsKCiAgICAgIC8vIGNoZWNrIGNvbXBpbGF0aW9uIGVycm9ycy90aXBzCiAgICAgIHsKICAgICAgICBpZiAoY29tcGlsZWQuZXJyb3JzICYmIGNvbXBpbGVkLmVycm9ycy5sZW5ndGgpIHsKICAgICAgICAgIHdhcm4kJDEoCiAgICAgICAgICAgICJFcnJvciBjb21waWxpbmcgdGVtcGxhdGU6XG5cbiIgKyB0ZW1wbGF0ZSArICJcblxuIiArCiAgICAgICAgICAgIGNvbXBpbGVkLmVycm9ycy5tYXAoZnVuY3Rpb24gKGUpIHsgcmV0dXJuICgiLSAiICsgZSk7IH0pLmpvaW4oJ1xuJykgKyAnXG4nLAogICAgICAgICAgICB2bQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvbXBpbGVkLnRpcHMgJiYgY29tcGlsZWQudGlwcy5sZW5ndGgpIHsKICAgICAgICAgIGNvbXBpbGVkLnRpcHMuZm9yRWFjaChmdW5jdGlvbiAobXNnKSB7IHJldHVybiB0aXAobXNnLCB2bSk7IH0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gdHVybiBjb2RlIGludG8gZnVuY3Rpb25zCiAgICAgIHZhciByZXMgPSB7fTsKICAgICAgdmFyIGZuR2VuRXJyb3JzID0gW107CiAgICAgIHJlcy5yZW5kZXIgPSBjcmVhdGVGdW5jdGlvbihjb21waWxlZC5yZW5kZXIsIGZuR2VuRXJyb3JzKTsKICAgICAgcmVzLnN0YXRpY1JlbmRlckZucyA9IGNvbXBpbGVkLnN0YXRpY1JlbmRlckZucy5tYXAoZnVuY3Rpb24gKGNvZGUpIHsKICAgICAgICByZXR1cm4gY3JlYXRlRnVuY3Rpb24oY29kZSwgZm5HZW5FcnJvcnMpCiAgICAgIH0pOwoKICAgICAgLy8gY2hlY2sgZnVuY3Rpb24gZ2VuZXJhdGlvbiBlcnJvcnMuCiAgICAgIC8vIHRoaXMgc2hvdWxkIG9ubHkgaGFwcGVuIGlmIHRoZXJlIGlzIGEgYnVnIGluIHRoZSBjb21waWxlciBpdHNlbGYuCiAgICAgIC8vIG1vc3RseSBmb3IgY29kZWdlbiBkZXZlbG9wbWVudCB1c2UKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIHsKICAgICAgICBpZiAoKCFjb21waWxlZC5lcnJvcnMgfHwgIWNvbXBpbGVkLmVycm9ycy5sZW5ndGgpICYmIGZuR2VuRXJyb3JzLmxlbmd0aCkgewogICAgICAgICAgd2FybiQkMSgKICAgICAgICAgICAgIkZhaWxlZCB0byBnZW5lcmF0ZSByZW5kZXIgZnVuY3Rpb246XG5cbiIgKwogICAgICAgICAgICBmbkdlbkVycm9ycy5tYXAoZnVuY3Rpb24gKHJlZikgewogICAgICAgICAgICAgIHZhciBlcnIgPSByZWYuZXJyOwogICAgICAgICAgICAgIHZhciBjb2RlID0gcmVmLmNvZGU7CgogICAgICAgICAgICAgIHJldHVybiAoKGVyci50b1N0cmluZygpKSArICIgaW5cblxuIiArIGNvZGUgKyAiXG4iKTsKICAgICAgICAgIH0pLmpvaW4oJ1xuJyksCiAgICAgICAgICAgIHZtCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIChjYWNoZVtrZXldID0gcmVzKQogICAgfQogIH0KCiAgLyogICovCgogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBpbGVyQ3JlYXRvciAoYmFzZUNvbXBpbGUpIHsKICAgIHJldHVybiBmdW5jdGlvbiBjcmVhdGVDb21waWxlciAoYmFzZU9wdGlvbnMpIHsKICAgICAgZnVuY3Rpb24gY29tcGlsZSAoCiAgICAgICAgdGVtcGxhdGUsCiAgICAgICAgb3B0aW9ucwogICAgICApIHsKICAgICAgICB2YXIgZmluYWxPcHRpb25zID0gT2JqZWN0LmNyZWF0ZShiYXNlT3B0aW9ucyk7CiAgICAgICAgdmFyIGVycm9ycyA9IFtdOwogICAgICAgIHZhciB0aXBzID0gW107CiAgICAgICAgZmluYWxPcHRpb25zLndhcm4gPSBmdW5jdGlvbiAobXNnLCB0aXApIHsKICAgICAgICAgICh0aXAgPyB0aXBzIDogZXJyb3JzKS5wdXNoKG1zZyk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKG9wdGlvbnMpIHsKICAgICAgICAgIC8vIG1lcmdlIGN1c3RvbSBtb2R1bGVzCiAgICAgICAgICBpZiAob3B0aW9ucy5tb2R1bGVzKSB7CiAgICAgICAgICAgIGZpbmFsT3B0aW9ucy5tb2R1bGVzID0KICAgICAgICAgICAgICAoYmFzZU9wdGlvbnMubW9kdWxlcyB8fCBbXSkuY29uY2F0KG9wdGlvbnMubW9kdWxlcyk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBtZXJnZSBjdXN0b20gZGlyZWN0aXZlcwogICAgICAgICAgaWYgKG9wdGlvbnMuZGlyZWN0aXZlcykgewogICAgICAgICAgICBmaW5hbE9wdGlvbnMuZGlyZWN0aXZlcyA9IGV4dGVuZCgKICAgICAgICAgICAgICBPYmplY3QuY3JlYXRlKGJhc2VPcHRpb25zLmRpcmVjdGl2ZXMgfHwgbnVsbCksCiAgICAgICAgICAgICAgb3B0aW9ucy5kaXJlY3RpdmVzCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBjb3B5IG90aGVyIG9wdGlvbnMKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgIGlmIChrZXkgIT09ICdtb2R1bGVzJyAmJiBrZXkgIT09ICdkaXJlY3RpdmVzJykgewogICAgICAgICAgICAgIGZpbmFsT3B0aW9uc1trZXldID0gb3B0aW9uc1trZXldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgY29tcGlsZWQgPSBiYXNlQ29tcGlsZSh0ZW1wbGF0ZSwgZmluYWxPcHRpb25zKTsKICAgICAgICB7CiAgICAgICAgICBlcnJvcnMucHVzaC5hcHBseShlcnJvcnMsIGRldGVjdEVycm9ycyhjb21waWxlZC5hc3QpKTsKICAgICAgICB9CiAgICAgICAgY29tcGlsZWQuZXJyb3JzID0gZXJyb3JzOwogICAgICAgIGNvbXBpbGVkLnRpcHMgPSB0aXBzOwogICAgICAgIHJldHVybiBjb21waWxlZAogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGNvbXBpbGU6IGNvbXBpbGUsCiAgICAgICAgY29tcGlsZVRvRnVuY3Rpb25zOiBjcmVhdGVDb21waWxlVG9GdW5jdGlvbkZuKGNvbXBpbGUpCiAgICAgIH0KICAgIH0KICB9CgogIC8qICAqLwoKICAvLyBgY3JlYXRlQ29tcGlsZXJDcmVhdG9yYCBhbGxvd3MgY3JlYXRpbmcgY29tcGlsZXJzIHRoYXQgdXNlIGFsdGVybmF0aXZlCiAgLy8gcGFyc2VyL29wdGltaXplci9jb2RlZ2VuLCBlLmcgdGhlIFNTUiBvcHRpbWl6aW5nIGNvbXBpbGVyLgogIC8vIEhlcmUgd2UganVzdCBleHBvcnQgYSBkZWZhdWx0IGNvbXBpbGVyIHVzaW5nIHRoZSBkZWZhdWx0IHBhcnRzLgogIHZhciBjcmVhdGVDb21waWxlciA9IGNyZWF0ZUNvbXBpbGVyQ3JlYXRvcihmdW5jdGlvbiBiYXNlQ29tcGlsZSAoCiAgICB0ZW1wbGF0ZSwKICAgIG9wdGlvbnMKICApIHsKICAgIHZhciBhc3QgPSBwYXJzZSh0ZW1wbGF0ZS50cmltKCksIG9wdGlvbnMpOwogICAgaWYgKG9wdGlvbnMub3B0aW1pemUgIT09IGZhbHNlKSB7CiAgICAgIG9wdGltaXplKGFzdCwgb3B0aW9ucyk7CiAgICB9CiAgICB2YXIgY29kZSA9IGdlbmVyYXRlKGFzdCwgb3B0aW9ucyk7CiAgICByZXR1cm4gewogICAgICBhc3Q6IGFzdCwKICAgICAgcmVuZGVyOiBjb2RlLnJlbmRlciwKICAgICAgc3RhdGljUmVuZGVyRm5zOiBjb2RlLnN0YXRpY1JlbmRlckZucwogICAgfQogIH0pOwoKICAvKiAgKi8KCiAgdmFyIHJlZiQxID0gY3JlYXRlQ29tcGlsZXIoYmFzZU9wdGlvbnMpOwogIHZhciBjb21waWxlID0gcmVmJDEuY29tcGlsZTsKICB2YXIgY29tcGlsZVRvRnVuY3Rpb25zID0gcmVmJDEuY29tcGlsZVRvRnVuY3Rpb25zOwoKICAvKiAgKi8KCiAgLy8gY2hlY2sgd2hldGhlciBjdXJyZW50IGJyb3dzZXIgZW5jb2RlcyBhIGNoYXIgaW5zaWRlIGF0dHJpYnV0ZSB2YWx1ZXMKICB2YXIgZGl2OwogIGZ1bmN0aW9uIGdldFNob3VsZERlY29kZSAoaHJlZikgewogICAgZGl2ID0gZGl2IHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgZGl2LmlubmVySFRNTCA9IGhyZWYgPyAiPGEgaHJlZj1cIlxuXCIvPiIgOiAiPGRpdiBhPVwiXG5cIi8+IjsKICAgIHJldHVybiBkaXYuaW5uZXJIVE1MLmluZGV4T2YoJyYjMTA7JykgPiAwCiAgfQoKICAvLyAjMzY2MzogSUUgZW5jb2RlcyBuZXdsaW5lcyBpbnNpZGUgYXR0cmlidXRlIHZhbHVlcyB3aGlsZSBvdGhlciBicm93c2VycyBkb24ndAogIHZhciBzaG91bGREZWNvZGVOZXdsaW5lcyA9IGluQnJvd3NlciA/IGdldFNob3VsZERlY29kZShmYWxzZSkgOiBmYWxzZTsKICAvLyAjNjgyODogY2hyb21lIGVuY29kZXMgY29udGVudCBpbiBhW2hyZWZdCiAgdmFyIHNob3VsZERlY29kZU5ld2xpbmVzRm9ySHJlZiA9IGluQnJvd3NlciA/IGdldFNob3VsZERlY29kZSh0cnVlKSA6IGZhbHNlOwoKICAvKiAgKi8KCiAgdmFyIGlkVG9UZW1wbGF0ZSA9IGNhY2hlZChmdW5jdGlvbiAoaWQpIHsKICAgIHZhciBlbCA9IHF1ZXJ5KGlkKTsKICAgIHJldHVybiBlbCAmJiBlbC5pbm5lckhUTUwKICB9KTsKCiAgdmFyIG1vdW50ID0gVnVlLnByb3RvdHlwZS4kbW91bnQ7CiAgVnVlLnByb3RvdHlwZS4kbW91bnQgPSBmdW5jdGlvbiAoCiAgICBlbCwKICAgIGh5ZHJhdGluZwogICkgewogICAgZWwgPSBlbCAmJiBxdWVyeShlbCk7CgogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICBpZiAoZWwgPT09IGRvY3VtZW50LmJvZHkgfHwgZWwgPT09IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgewogICAgICB3YXJuKAogICAgICAgICJEbyBub3QgbW91bnQgVnVlIHRvIDxodG1sPiBvciA8Ym9keT4gLSBtb3VudCB0byBub3JtYWwgZWxlbWVudHMgaW5zdGVhZC4iCiAgICAgICk7CiAgICAgIHJldHVybiB0aGlzCiAgICB9CgogICAgdmFyIG9wdGlvbnMgPSB0aGlzLiRvcHRpb25zOwogICAgLy8gcmVzb2x2ZSB0ZW1wbGF0ZS9lbCBhbmQgY29udmVydCB0byByZW5kZXIgZnVuY3Rpb24KICAgIGlmICghb3B0aW9ucy5yZW5kZXIpIHsKICAgICAgdmFyIHRlbXBsYXRlID0gb3B0aW9ucy50ZW1wbGF0ZTsKICAgICAgaWYgKHRlbXBsYXRlKSB7CiAgICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGlmICh0ZW1wbGF0ZS5jaGFyQXQoMCkgPT09ICcjJykgewogICAgICAgICAgICB0ZW1wbGF0ZSA9IGlkVG9UZW1wbGF0ZSh0ZW1wbGF0ZSk7CiAgICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgICAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgd2FybigKICAgICAgICAgICAgICAgICgiVGVtcGxhdGUgZWxlbWVudCBub3QgZm91bmQgb3IgaXMgZW1wdHk6ICIgKyAob3B0aW9ucy50ZW1wbGF0ZSkpLAogICAgICAgICAgICAgICAgdGhpcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHRlbXBsYXRlLm5vZGVUeXBlKSB7CiAgICAgICAgICB0ZW1wbGF0ZSA9IHRlbXBsYXRlLmlubmVySFRNTDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuKCdpbnZhbGlkIHRlbXBsYXRlIG9wdGlvbjonICsgdGVtcGxhdGUsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXMKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZWwpIHsKICAgICAgICB0ZW1wbGF0ZSA9IGdldE91dGVySFRNTChlbCk7CiAgICAgIH0KICAgICAgaWYgKHRlbXBsYXRlKSB7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgaWYgKGNvbmZpZy5wZXJmb3JtYW5jZSAmJiBtYXJrKSB7CiAgICAgICAgICBtYXJrKCdjb21waWxlJyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVmID0gY29tcGlsZVRvRnVuY3Rpb25zKHRlbXBsYXRlLCB7CiAgICAgICAgICBzaG91bGREZWNvZGVOZXdsaW5lczogc2hvdWxkRGVjb2RlTmV3bGluZXMsCiAgICAgICAgICBzaG91bGREZWNvZGVOZXdsaW5lc0ZvckhyZWY6IHNob3VsZERlY29kZU5ld2xpbmVzRm9ySHJlZiwKICAgICAgICAgIGRlbGltaXRlcnM6IG9wdGlvbnMuZGVsaW1pdGVycywKICAgICAgICAgIGNvbW1lbnRzOiBvcHRpb25zLmNvbW1lbnRzCiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgdmFyIHJlbmRlciA9IHJlZi5yZW5kZXI7CiAgICAgICAgdmFyIHN0YXRpY1JlbmRlckZucyA9IHJlZi5zdGF0aWNSZW5kZXJGbnM7CiAgICAgICAgb3B0aW9ucy5yZW5kZXIgPSByZW5kZXI7CiAgICAgICAgb3B0aW9ucy5zdGF0aWNSZW5kZXJGbnMgPSBzdGF0aWNSZW5kZXJGbnM7CgogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgIGlmIChjb25maWcucGVyZm9ybWFuY2UgJiYgbWFyaykgewogICAgICAgICAgbWFyaygnY29tcGlsZSBlbmQnKTsKICAgICAgICAgIG1lYXN1cmUoKCJ2dWUgIiArICh0aGlzLl9uYW1lKSArICIgY29tcGlsZSIpLCAnY29tcGlsZScsICdjb21waWxlIGVuZCcpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG1vdW50LmNhbGwodGhpcywgZWwsIGh5ZHJhdGluZykKICB9OwoKICAvKioKICAgKiBHZXQgb3V0ZXJIVE1MIG9mIGVsZW1lbnRzLCB0YWtpbmcgY2FyZQogICAqIG9mIFNWRyBlbGVtZW50cyBpbiBJRSBhcyB3ZWxsLgogICAqLwogIGZ1bmN0aW9uIGdldE91dGVySFRNTCAoZWwpIHsKICAgIGlmIChlbC5vdXRlckhUTUwpIHsKICAgICAgcmV0dXJuIGVsLm91dGVySFRNTAogICAgfSBlbHNlIHsKICAgICAgdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoZWwuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgcmV0dXJuIGNvbnRhaW5lci5pbm5lckhUTUwKICAgIH0KICB9CgogIFZ1ZS5jb21waWxlID0gY29tcGlsZVRvRnVuY3Rpb25zOwoKICByZXR1cm4gVnVlOwoKfSkpKTsK"></script>
        <style>
            body{
                background-color: #ddd;
                background: linear-gradient(45deg, #dddddd, #f0f0f0); 
                font-family: "Roboto", sans-serif;
            }
            #pads{
                min-height: 90vh;
                min-width: 90vw;
            }
            .jingle-container{
                position: relative;
                display: inline-block;
                width: 14em;
                height: 14em;
                border: 0.1em solid #555;
                border-radius: 3px;
                margin: 0.7em;
                /*background-color: rgb(170,210,217);*/
                padding: 0;
            }
            .jingle-picture{
                position: absolute;
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
                border-radius: 3px;
                opacity: 0.25;
            }
            .jingle-progressbar{
                width: 50%;
                height: 100%;
                margin: 0;
                transition: width 0.5s;
                background-color:rgba(0, 0, 0, 0.17);
            }
            .jingle-meta{
                position: absolute;
                top: 0;
                left: 0;
                padding: 0.5em;
                line-height: 2.7ex;
            }
            .jingle-title{
                font-size: 120%;
                line-height: 120%;
                font-weight: bold;
            }
            .jingle-artist{
                color: #333;
            }
            .jingle-album{
                color: #333;
            }
            .jingle-time{
                position: absolute;
                bottom: 0;
                right: 0;
                padding: 0.5em;
                font-size: 80%;
            }
            .jingle-menu{
                position: absolute;
                top: 0;
                right: 0;
                padding: 0.5em;
            }
            .jingle-button{
                display: inline-block;
                border-radius: 3px;
                width: 1em;
                height: 1em;
                padding: 0.1em;
                margin: 0;
                line-height: 1em;
                text-align: center;
                font-weight: bold;
            }
            .jingle-button>svg{
                width: 100%;
                height: 100%;
            }
            .jingle-button:hover{
                background-color: rgba(0,0,0,0.17);
            }
        </style>
    </head>
    <body>
        <div id="pads" v-on:drop.stop.prevent="filedrop" v-on:dragover.stop.prevent="dragover">
                <jingle v-for="p in jingles" :jid="p"></jingle>
        </div>
        <script type="text/x-template" id="jingle-template">
            <div class="jingle-container" v-on:click="playpause"  v-bind:style="{backgroundColor: jid.color}" v-on:drop.stop.prevent="filedrop" v-on:dragover.stop.prevent="dragover">
                <div class="jingle-picture" v-bind:style="{backgroundImage: jid.picture}"></div>
                <div class="jingle-progressbar" v-bind:style="{width: progress}"></div>
                <div class="jingle-meta">
                    <div class="jingle-title">{{jid.title}}</div>
                    <div class="jingle-artist">{{jid.artist}}</div>
                    <div class="jingle-album">{{jid.album}}</div>
                </div>
                <div class="jingle-time">{{position}} / {{duration}}</div>
                <div class="jingle-menu">
                    <!--<div class="jingle-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M444.788 291.1l42.616 24.599c4.867 2.809 7.126 8.618 5.459 13.985-11.07 35.642-29.97 67.842-54.689 94.586a12.016 12.016 0 0 1-14.832 2.254l-42.584-24.595a191.577 191.577 0 0 1-60.759 35.13v49.182a12.01 12.01 0 0 1-9.377 11.718c-34.956 7.85-72.499 8.256-109.219.007-5.49-1.233-9.403-6.096-9.403-11.723v-49.184a191.555 191.555 0 0 1-60.759-35.13l-42.584 24.595a12.016 12.016 0 0 1-14.832-2.254c-24.718-26.744-43.619-58.944-54.689-94.586-1.667-5.366.592-11.175 5.459-13.985L67.212 291.1a193.48 193.48 0 0 1 0-70.199l-42.616-24.599c-4.867-2.809-7.126-8.618-5.459-13.985 11.07-35.642 29.97-67.842 54.689-94.586a12.016 12.016 0 0 1 14.832-2.254l42.584 24.595a191.577 191.577 0 0 1 60.759-35.13V25.759a12.01 12.01 0 0 1 9.377-11.718c34.956-7.85 72.499-8.256 109.219-.007 5.49 1.233 9.403 6.096 9.403 11.723v49.184a191.555 191.555 0 0 1 60.759 35.13l42.584-24.595a12.016 12.016 0 0 1 14.832 2.254c24.718 26.744 43.619 58.944 54.689 94.586 1.667 5.366-.592 11.175-5.459 13.985L444.788 220.9a193.485 193.485 0 0 1 0 70.2zM336 256c0-44.112-35.888-80-80-80s-80 35.888-80 80 35.888 80 80 80 80-35.888 80-80z"/></svg></div>
                    --><div class="jingle-button" v-on:click.stop="remove"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z"/></svg></div>
                </div>
            </div>
        </script>
        <script>
            window.global_id = 0;
            window.next_id = () => {let id = window.global_id; window.global_id ++; return id;};
            var data = {
                jingles: []
            };

            let formatTwo = (input) => ('00' + input).slice(-2);
            let formatTime = t => {
                let seconds = Math.ceil(t);
                let minutes = Math.floor(seconds / 60);
                seconds = Math.ceil(seconds - (minutes * 60));
                return formatTwo(minutes) + ":" + formatTwo(seconds);
            }

            Vue.component('jingle', {
                template: '#jingle-template',
                props: ['jid'],
                data: function(){
                    return {
                        currentTime: 0,
                        playing: false,
                        color: "white",
                        title: "",
                    };
                },
                mounted: function (){
                    console.log("created");
                    this.jid.audio.addEventListener('timeupdate', () => this.currentTime = this.jid.audio.currentTime);
                    this.jid.audio.addEventListener('ended', () => {this.jid.audio.currentTime = 0; this.playing = false;});
                    if(!this.jid.picture){
                        this.jid.color = `hsl(${110 + (Math.random()* 100)}deg,40%,50%)`;
                    }
                    this.title = this.jid.title;
                },
                beforeUpdate: function(){
                    if(this.title != this.jid.title){
                        this.jid.audio.addEventListener('timeupdate', () => this.currentTime = this.jid.audio.currentTime);
                        this.jid.audio.addEventListener('ended', () => {this.jid.audio.currentTime = 0; this.playing = false;});
                        if(!this.jid.picture){
                            this.jid.color = `hsl(${110 + (Math.random()* 100)}deg,40%,50%)`;
                        }
                        this.title = this.jid.title;
                    }
                },
                computed: {
                    duration: function(){
                       return formatTime(this.jid.audio.duration);
                    },
                    position: function(){
                        return formatTime(this.currentTime);
                    },
                    progress: function(){
                        return ((this.currentTime / this.jid.audio.duration) * 100) + "%";
                    }
                },
                methods:{
                    playpause: function(){
                        if(!this.playing){
                            this.jid.audio.play();
                            this.playing = true;
                        }else{
                            this.jid.audio.pause();
                            this.jid.audio.currentTime = 0;
                            this.playing = false;
                        }
                    },
                    remove: function(){
                        this.jid.audio.pause();
                        data.jingles = data.jingles.filter(j => j.id != this.jid.id);
                    },
                    dragover: function(event){
                        event.dataTransfer.dropEffect = 'copy';
                    },
                    filedrop: function(event){
                        console.log("filedrop");
                        let buildjingle = (audio, artist, album, title, duration, picture) => {
                            let id = window.next_id();
                            let jingleindex = data.jingles.findIndex(j => j.id == this.jid.id);
                            this.jid.audio.pause();
                            data.jingles[jingleindex] = {
                                id: id,
                                artist: artist,
                                album: album,
                                title: title,
                                duration: duration,
                                audio: audio,
                                picture: picture
                            };
                            vm.$forceUpdate();
                            return id;
                        }
                        loadJingle(event, buildjingle);
                    }
                }

            });

            

            var vm = new Vue({
                data: data,
                el: '#pads',
                methods: {
                    dragover: function(event){
                        event.dataTransfer.dropEffect = 'copy';
                    },
                    filedrop: function(event){
                        let buildjingle = (audio, artist, album, title, duration, picture) => {
                            let id = window.next_id();
                            data.jingles.push({
                                id: id,
                                artist: artist,
                                album: album,
                                title: title,
                                duration: duration,
                                audio: audio,
                                picture: picture
                            });
                            return id;
                        }
                        loadJingle(event, buildjingle);
                    }
                }
            });

            function loadJingle(event, buildjingle){
                if(event.dataTransfer && event.dataTransfer.files && event.dataTransfer.files.length > 0){
                    for(f of event.dataTransfer.files){
                        if(f.name.endsWith('wav')){
                            console.log('wav');
                            var reader = new FileReader();
                            reader.onload = e => {
                                console.log("reader done");
                                var audio = new Audio(e.target.result);
                                audio.preload = "auto";
                                audio.addEventListener('loadedmetadata', () => {
                                    console.log("audio done");
                                    buildjingle(audio, "","",f.name, audio.duration);
                                });
                            }
                            reader.readAsDataURL(f);
                            continue;
                        }
                        if(!(f.name.endsWith('mp3') || f.name.endsWith('mp4'))) continue;

                        console.log(f.name);

                        jsmediatags.read(f, {
                            onSuccess: function(tag) {
                                var reader = new FileReader();
                                reader.onload = e => {
                                    console.log("reader done");
                                    var audio = new Audio(e.target.result);
                                    audio.preload = "auto";
                                    console.log(audio);
                                    audio.addEventListener('loadedmetadata', () => {
                                        console.log("audio done");
                                        console.log(tag.tags.picture);
                                        var imgtag = null;
                                        if(tag.tags.picture){
                                            var base64String = "";
                                            for (var i = 0; i < tag.tags.picture.data.length; i++) {
                                                base64String += String.fromCharCode(tag.tags.picture.data[i]);
                                            }
                                            imgtag = "url(" + "data:" + tag.tags.picture.format + ";base64," + btoa(base64String) + ")";
                                            console.log(imgtag);
                                        }
                                        buildjingle(audio, tag.tags.artist || "",tag.tags.album || "",tag.tags.title || f.name, audio.duration, imgtag);
                                    });
                                    audio.load();
                                }
                                reader.readAsDataURL(f);
                            },
                            onError: function(error) {
                                console.log(error);
                            }
                        });
                    }
                }
            }
        </script>
    </body>
</html>